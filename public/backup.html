<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ICN Suite — Backup Center</title>
  <style>
    @font-face { font-family: "CameraPlainVariable"; src: url("https://cdn.gpteng.co/mcp-widgets/v1/fonts/CameraPlainVariable.woff2") format("woff2"); font-weight: 100 900; font-style: normal; font-display: swap; }
    :root{--font:"CameraPlainVariable",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;--bg:#f5f6f8;--card:#fff;--border:#e1e4e8;--muted:#6e7681;--shadow:0 10px 30px rgba(0,0,0,.06);}
    body{margin:0;background:var(--bg);font-family:var(--font);color:#121212;}
    .wrap{max-width:980px;margin:0 auto;padding:14px;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:14px;}
    h1{font-size:18px;margin:0 0 6px;}
    .sub{color:var(--muted);font-size:13px;margin:0 0 12px;line-height:1.35;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    button{border:1px solid var(--border);background:#fff;border-radius:9999px;padding:10px 14px;font:inherit;cursor:pointer;box-shadow:0 2px 10px rgba(0,0,0,.03);}
    button.primary{background:#121212;color:#fff;border-color:#121212;}
    button.danger{background:#b00020;color:#fff;border-color:#b00020;}
    textarea{width:100%;min-height:180px;border:1px solid var(--border);border-radius:12px;padding:10px;background:#fff;box-sizing:border-box;font:inherit;}
    .pill{display:inline-flex;align-items:center;gap:6px;border-radius:9999px;border:1px solid var(--border);padding:6px 10px;font-size:12px;color:var(--muted);background:#fff;}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}
  </style>
</head>
<body>

<div id="backupBanner" style="display:none;position:sticky;top:0;z-index:9999;">
  <div style="background:#fff3cd;border:1px solid #ffeeba;color:#856404;border-radius:12px;padding:10px;margin:10px 0;box-shadow:0 6px 20px rgba(0,0,0,.06);">
    <div style="display:flex;gap:10px;align-items:flex-start;flex-wrap:wrap;justify-content:space-between;">
      <div style="min-width:240px;flex:1 1 auto;">
        <div style="font-weight:700;margin-bottom:4px;">Backup reminder</div>
        <div id="backupBannerMsg" style="font-size:13px;line-height:1.35;">
          Your data is stored locally per browser. Export a backup JSON regularly.
        </div>
        <div id="backupBannerMeta" style="font-size:12px;opacity:.85;margin-top:4px;"></div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
        <a href="/backup" style="text-decoration:none;"><button type="button" style="border:1px solid #e1e4e8;background:#fff;border-radius:9999px;padding:10px 14px;cursor:pointer;">Open Backup Center</button></a>
        <button type="button" id="backupBannerDismiss" style="border:1px solid #e1e4e8;background:#fff;border-radius:9999px;padding:10px 14px;cursor:pointer;">Dismiss</button>
      </div>
    </div>
  </div>
</div>

  <div class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div>
          <h1>Backup Center</h1>
          <p class="sub">LocalStorage is isolated per browser/profile/device. Use this to export/restore and sync between Edge/Chrome.</p>
        </div>
        <div class="row">
          <a href="/working" style="text-decoration:none;"><button>Working</button></a>
          <a href="/reports" style="text-decoration:none;"><button>Reports</button></a>
        </div>
      </div>

      <div class="row">
        <span class="pill">Last backup: <span id="last" class="mono">—</span></span>
        <span class="pill">Detected store key: <span id="key" class="mono">—</span></span>
      </div>

      <div class="row" style="margin-top:12px;">
        <button id="export" class="primary">Export backup JSON</button>
        <button id="importBtn">Import backup JSON</button>
        <input id="importFile" type="file" accept="application/json,.json,.txt" style="display:none;" />
        <button id="copy" title="Copies JSON to clipboard">Copy JSON</button>
        <button id="clear" class="danger" title="Clears detected store key in this browser only">Clear local data</button>
      </div>

      <p class="sub" style="margin-top:10px;">
        Recommended workflow to sync browsers: Export on Browser A → Import on Browser B.
      </p>

      <label>Backup JSON preview</label>
      <textarea id="preview" class="mono" readonly></textarea>
    </div>
  </div>

<script>
(function(){
  const LAST_BACKUP_AT_KEY = "icn_last_backup_at_v1";

  const els = {
    last: document.getElementById("last"),
    key: document.getElementById("key"),
    export: document.getElementById("export"),
    importBtn: document.getElementById("importBtn"),
    importFile: document.getElementById("importFile"),
    copy: document.getElementById("copy"),
    clear: document.getElementById("clear"),
    preview: document.getElementById("preview"),
  };

  function detectKey(){
    const keys = Object.keys(localStorage);
    for(const k of keys){
      const raw = localStorage.getItem(k);
      if(!raw || raw.length < 20) continue;
      if(raw[0] !== "{") continue;
      try{
        const obj = JSON.parse(raw);
        const state = obj && obj.state ? obj.state : obj;
        if(state && typeof state === "object"){
          const has = (state.modules && typeof state.modules === "object") ||
                      (state.residentsById && typeof state.residentsById === "object") ||
                      Array.isArray(state.abt) || Array.isArray(state.vaccinations) || Array.isArray(state.ipCases) ||
                      (state.modules && state.modules.abt && Array.isArray(state.modules.abt.courses)) ||
                      (state.modules && state.modules.vaccinations && Array.isArray(state.modules.vaccinations.records)) ||
                      (state.modules && state.modules.ip && Array.isArray(state.modules.ip.cases));
          if(has) return k;
        }
      }catch(e){}
    }
    return null;
  }

  function downloadText(filename, text, mime){
    const blob = new Blob([text], {type: mime || "text/plain"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 600);
  }

  function parseMaybeJsonText(text){
    const t = (text||"").trim();
    if(!t) return null;
    try{ return JSON.parse(t); }catch(e){}
    const i1 = t.indexOf("{");
    const i2 = t.lastIndexOf("}");
    if(i1 !== -1 && i2 !== -1 && i2 > i1){
      try{ return JSON.parse(t.slice(i1, i2+1)); }catch(e){}
    }
    return null;
  }

  function refresh(){
    const last = localStorage.getItem(LAST_BACKUP_AT_KEY) || "";
    els.last.textContent = last ? last.replace("T"," ").replace("Z","") : "NEVER";
    const k = detectKey();
    els.key.textContent = k || "NOT FOUND";
    if(k){
      const raw = localStorage.getItem(k) || "";
      els.preview.value = raw;
    }else{
      els.preview.value = "Open your tracker once so its localStorage key exists, then come back here.";
    }
  }

  els.export.addEventListener("click", () => {
    const k = detectKey();
    if(!k){ alert("Store key not detected. Open your tracker once, then retry."); return; }
    const raw = localStorage.getItem(k) || "";
    const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,"-");
    downloadText(`icn-local-backup-${stamp}.json`, raw, "application/json");
    localStorage.setItem(LAST_BACKUP_AT_KEY, new Date().toISOString());
    refresh();
  });

  els.importBtn.addEventListener("click", () => els.importFile.click());
  els.importFile.addEventListener("change", (e) => {
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = () => {
      const obj = parseMaybeJsonText(String(reader.result || ""));
      if(!obj){ alert("Could not parse JSON from file."); return; }
      const k = detectKey() || "icn_suite_state_v1";
      localStorage.setItem(k, JSON.stringify(obj));
      localStorage.setItem(LAST_BACKUP_AT_KEY, new Date().toISOString());
      refresh();
      alert("Imported into this browser. Refresh/open the tracker.");
    };
    reader.readAsText(f);
  });

  els.copy.addEventListener("click", async () => {
    const text = els.preview.value || "";
    if(!text.trim()){ alert("Nothing to copy."); return; }
    try{
      await navigator.clipboard.writeText(text);
      alert("Copied.");
    }catch(e){
      els.preview.focus(); els.preview.select();
      alert("Select + copy (clipboard blocked).");
    }
  });

  els.clear.addEventListener("click", () => {
    const k = detectKey();
    if(!k){ alert("No store key detected."); return; }
    if(!confirm("This will clear local data in THIS browser only. Continue?")) return;
    localStorage.removeItem(k);
    refresh();
    alert("Cleared. Open tracker to reinitialize.");
  });

  refresh();
})();
</script>

<script>
(function(){
  const LAST_BACKUP_AT_KEY = "icn_last_backup_at_v1";
  const DISMISS_KEY = "icn_backup_banner_dismissed_v1";
  const DISMISS_DAYS = 1;          // show again after 1 day if dismissed
  const REMIND_DAYS = 7;           // show reminder if last backup older than 7 days
  const banner = document.getElementById("backupBanner");
  const msg = document.getElementById("backupBannerMsg");
  const meta = document.getElementById("backupBannerMeta");
  const dismissBtn = document.getElementById("backupBannerDismiss");

  function daysBetween(aIso, bIso){
    try{
      const a = new Date(aIso).getTime();
      const b = new Date(bIso).getTime();
      if(!isFinite(a) || !isFinite(b)) return null;
      return Math.floor(Math.abs(b - a) / (1000*60*60*24));
    }catch(e){ return null; }
  }

  function shouldShow(){
    const now = new Date().toISOString();
    const last = localStorage.getItem(LAST_BACKUP_AT_KEY) || "";
    const dismissedAt = localStorage.getItem(DISMISS_KEY) || "";

    if(dismissedAt){
      const d = daysBetween(dismissedAt, now);
      if(d !== null && d < DISMISS_DAYS) return false;
    }

    if(!last) return true;
    const age = daysBetween(last, now);
    if(age === null) return true;
    return age >= REMIND_DAYS;
  }

  function render(){
    if(!banner) return;
    if(!shouldShow()){
      banner.style.display = "none";
      return;
    }
    const last = localStorage.getItem(LAST_BACKUP_AT_KEY) || "";
    if(!last){
      msg.textContent = "No recent backup found. Data is local per browser, so export a JSON backup now.";
      meta.textContent = "Last backup: NEVER";
    }else{
      const now = new Date().toISOString();
      const age = daysBetween(last, now);
      msg.textContent = "Your data is local per browser/profile. Export a JSON backup so you can restore/sync across browsers/devices.";
      meta.textContent = "Last backup: " + last.replace("T"," ").replace("Z","") + (age !== null ? (" ("+age+"d ago)") : "");
    }
    banner.style.display = "";
  }

  if(dismissBtn){
    dismissBtn.addEventListener("click", () => {
      localStorage.setItem(DISMISS_KEY, new Date().toISOString());
      if(banner) banner.style.display = "none";
    });
  }

  render();
})();
</script>

</body>
</html>
