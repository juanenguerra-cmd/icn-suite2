<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ICN Suite — Quick Collector (Bulk Import Pack)</title>
  <style>
    @font-face {
      font-family: "CameraPlainVariable";
      src: url("https://cdn.gpteng.co/mcp-widgets/v1/fonts/CameraPlainVariable.woff2") format("woff2");
      font-weight: 100 900;
      font-style: normal;
      font-display: swap;
    }
    :root{
      --font:"CameraPlainVariable",ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      --bg:245 246 248;
      --card:255 255 255;
      --text:18 18 18;
      --muted:110 118 129;
      --border:225 228 232;
      --shadow:0 10px 30px rgba(0,0,0,.06);
      --radius:16px;
      --radiusPill:9999px;
    }
    html,body{height:100%;}
    body{
      margin:0;
      font-family:var(--font);
      background:rgb(var(--bg));
      color:rgb(var(--text));
    }
    .wrap{max-width:980px;margin:0 auto;padding:14px;}
    .card{
      background:rgb(var(--card));
      border:1px solid rgb(var(--border));
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;}
    .row > *{flex:1 1 auto;}
    h1{font-size:18px;margin:0 0 6px;}
    .sub{color:rgb(var(--muted));font-size:13px;margin:0 0 12px;line-height:1.35;}
    label{display:block;font-size:12px;color:rgb(var(--muted));margin:8px 0 6px;}
    select,textarea,input{
      width:100%;
      border:1px solid rgb(var(--border));
      border-radius:12px;
      padding:10px;
      font:inherit;
      background:#fff;
      box-sizing:border-box;
    }
    textarea{min-height:210px;resize:vertical;}
    .btns{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:10px;}
    button{
      border:1px solid rgb(var(--border));
      background:#fff;
      border-radius:var(--radiusPill);
      padding:10px 14px;
      font:inherit;
      cursor:pointer;
      box-shadow:0 2px 10px rgba(0,0,0,.03);
    }
    button.primary{
      background:rgba(0,0,0,.92);
      color:#fff;
      border-color:rgba(0,0,0,.92);
    }
    button:disabled{opacity:.6;cursor:not-allowed;}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;}
    @media(min-width:920px){.grid{grid-template-columns:1.25fr .75fr;}}
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      border-radius:var(--radiusPill);
      border:1px solid rgb(var(--border));
      padding:6px 10px;
      font-size:12px;
      color:rgb(var(--muted));
      background:#fff;
    }
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}
    .ok{color:#0b7a28;}
    .warn{color:#8a4b00;}
    .err{color:#a11;}
    .small{font-size:12px;color:rgb(var(--muted));}
    .hr{height:1px;background:rgb(var(--border));margin:12px 0;}
  </style>
</head>
<body>

<div id="backupBanner" style="display:none;position:sticky;top:0;z-index:9999;">
  <div style="background:#fff3cd;border:1px solid #ffeeba;color:#856404;border-radius:12px;padding:10px;margin:10px 0;box-shadow:0 6px 20px rgba(0,0,0,.06);">
    <div style="display:flex;gap:10px;align-items:flex-start;flex-wrap:wrap;justify-content:space-between;">
      <div style="min-width:240px;flex:1 1 auto;">
        <div style="font-weight:700;margin-bottom:4px;">End-of-day backup reminder</div>
        <div id="backupBannerMsg" style="font-size:13px;line-height:1.35;">
          Your data is local per browser. Export a backup JSON at the end of the day.
        </div>
        <div id="backupBannerMeta" style="font-size:12px;opacity:.85;margin-top:4px;"></div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
        <button type="button" id="backupBannerNow" style="border:1px solid #e1e4e8;background:#121212;color:#fff;border-radius:9999px;padding:10px 14px;cursor:pointer;">Backup Now</button>
        <a href="/backup" style="text-decoration:none;"><button type="button" style="border:1px solid #e1e4e8;background:#fff;border-radius:9999px;padding:10px 14px;cursor:pointer;">Backup Center</button></a>
        <button type="button" id="backupBannerDismiss" style="border:1px solid #e1e4e8;background:#fff;border-radius:9999px;padding:10px 14px;cursor:pointer;">Dismiss</button>
      </div>
    </div>
    <div style="font-size:12px;opacity:.8;margin-top:8px;">
      Note: most browsers won’t silently overwrite existing files. Use the same daily filename and replace if prompted, or keep timestamped backups.
    </div>
  </div>
</div>


<div id="backupBanner" style="display:none;position:sticky;top:0;z-index:9999;">
  <div style="background:#fff3cd;border:1px solid #ffeeba;color:#856404;border-radius:12px;padding:10px;margin:10px 0;box-shadow:0 6px 20px rgba(0,0,0,.06);">
    <div style="display:flex;gap:10px;align-items:flex-start;flex-wrap:wrap;justify-content:space-between;">
      <div style="min-width:240px;flex:1 1 auto;">
        <div style="font-weight:700;margin-bottom:4px;">Backup reminder</div>
        <div id="backupBannerMsg" style="font-size:13px;line-height:1.35;">
          Your data is stored locally per browser. Export a backup JSON regularly.
        </div>
        <div id="backupBannerMeta" style="font-size:12px;opacity:.85;margin-top:4px;"></div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
        <a href="/backup" style="text-decoration:none;"><button type="button" style="border:1px solid #e1e4e8;background:#fff;border-radius:9999px;padding:10px 14px;cursor:pointer;">Open Backup Center</button></a>
        <button type="button" id="backupBannerDismiss" style="border:1px solid #e1e4e8;background:#fff;border-radius:9999px;padding:10px 14px;cursor:pointer;">Dismiss</button>
      </div>
    </div>
  </div>
</div>

  <div class="wrap">
    <div class="card">
      <h1>ICN Suite — Quick Collector</h1>
      <p class="sub">
        Paste CSV / JSON array / raw lines, generate an <span class="mono">icn-bulk-import-v1</span> pack, then copy/download/save it in the Pack Vault (working mode).
        This page is static (<span class="mono">/import.html</span>) so you can collect data immediately without waiting for the React UI wiring.
      </p>

      <div class="grid">
        <div>
          <label for="dataset">Dataset</label>
          <select id="dataset">
            <option value="census">Census</option>
            <option value="vaccinations">Vaccinations</option>
            <option value="abt">ABT (Antibiotics)</option>
            <option value="generic">Generic / Notes</option>
          </select>

          <div class="row">
            <div>
              <label for="format">Input format</label>
              <select id="format">
                <option value="auto">Auto-detect</option>
                <option value="csv">CSV (header row)</option>
                <option value="json">JSON array</option>
                <option value="lines">Raw lines</option>
              </select>
            </div>
            <div>
              <label for="delimiter">CSV delimiter</label>
              <select id="delimiter">
                <option value="auto">Auto</option>
                <option value=",">Comma (,)</option>
                <option value="\t">Tab</option>
                <option value=";">Semicolon (;)</option>
                <option value="|">Pipe (|)</option>
              </select>
            </div>
          </div>

          <label for="raw">Paste input</label>
          <textarea id="raw" placeholder="Paste CSV / JSON array / lines here..."></textarea>

          <div class="row" style="margin-top:8px;">
            <span class="pill"><input id="appendMode" type="checkbox" style="width:auto;margin:0 6px 0 0;"/>Append mode</span>
            <span class="pill"><input id="autoVault" type="checkbox" style="width:auto;margin:0 6px 0 0;" checked/>Auto-save to Vault</span>
          </div>

          <div class="btns">
            <button id="clear">Clear</button>
            <button id="save">Save draft</button>
            <button id="generate" class="primary">Generate pack</button>
            <button id="saveVault">Save to Vault</button>
            <button id="queue" class="primary" style="background:rgba(0,0,0,.78);border-color:rgba(0,0,0,.78);">Queue for ICN Suite</button>
          </div>

          <div class="hr"></div>

          <div class="row">
            <span class="pill" id="status">Status: <span class="mono">idle</span></span>
            <span class="pill">Detected: <span class="mono" id="detected">—</span></span>
            <span class="pill">Records: <span class="mono" id="count">0</span></span>
          </div>

          <label for="preview" style="margin-top:10px;">Preview (first 5)</label>
          <textarea id="preview" class="mono" readonly placeholder="Parsed records preview will appear here..."></textarea>

          <p class="small">
            iPhone tip: if “Copy” fails, long-press inside the JSON box and copy manually (Safari clipboard can be picky).
          </p>
        </div>

        <div>
          <label for="out">Generated Import Pack JSON</label>
          <textarea id="out" class="mono" readonly placeholder='{"version":"icn-bulk-import-v1", ...}'></textarea>
          <div class="btns">
            <button id="copy">Copy JSON</button>
            <button id="download">Download .json</button>
          </div>

          <div class="hr"></div>

          <label>Quick examples</label>
          <div class="small">
            <div class="pill mono" style="margin-bottom:8px;display:inline-flex;white-space:normal;">
              CSV: name,room,unit<br/>Jane Doe,2-101A,Unit 2
            </div>
            <div class="pill mono" style="margin-bottom:8px;display:inline-flex;white-space:normal;">
              JSON: [{"name":"Jane Doe","room":"2-101A"}]
            </div>
            <div class="pill mono" style="display:inline-flex;white-space:normal;">
              Lines: Jane Doe — 2-101A — Unit 2
            </div>

          <div class="hr"></div>

          <h2 style="font-size:14px;margin:0 0 8px;">Pack Vault</h2>
          <p class="small" style="margin-top:0;">
            Saved packs live in this device’s localStorage. Use Vault to merge/export packs while the full in-app importer is still in progress.
          </p>

          <div class="row">
            <button id="vaultRefresh">Refresh</button>
            <button id="vaultClear">Clear Vault</button>
            <button id="vaultExport" class="primary">Export Vault</button>
            <button id="vaultImportBtn">Import Vault</button>
            <input id="vaultImport" type="file" accept="application/json" multiple style="display:none;" />
          </div>

          <label>Saved packs</label>
          <div id="vaultList" class="sip-card" style="border-radius:12px;padding:10px;max-height:220px;overflow:auto;"></div>

          <div class="btns">
            <button id="vaultMerge">Merge selected</button>
            <button id="vaultDownload" class="primary">Download merged</button>
          </div>

          <div class="row" style="margin-top:10px;">
            <span class="pill">Export:</span>
            <select id="csvDataset" style="max-width:220px;">
              <option value="auto">Auto</option>
              <option value="census">Census</option>
              <option value="vaccinations">Vaccinations</option>
              <option value="abt">ABT</option>
              <option value="generic">Generic</option>
            </select>
            <button id="exportCsv">Export CSV</button>
            <button id="makeSummary" class="primary">Summary</button>
          </div>

          <label for="merged">Merged output (preview)</label>
          <textarea id="merged" class="mono" readonly placeholder="Merged pack JSON will appear here..."></textarea>

          <label for="summary">Summary (executive)</label>
          <textarea id="summary" class="mono" readonly placeholder="Summary will appear here..."></textarea>

          </div>
        </div>
      </div>
    </div>
  </div>




<script>
(function(){
  const LAST_BACKUP_AT_KEY = "icn_last_backup_at_v1";
  const DISMISS_KEY = "icn_backup_banner_dismissed_at_v1";
  const TIME_KEY = "icn_backup_time_hhmm_v1";            // default 19:00
  const MODE_KEY = "icn_backup_filename_mode_v1";        // "daily" | "timestamp"

  const banner = document.getElementById("backupBanner");
  const msg = document.getElementById("backupBannerMsg");
  const meta = document.getElementById("backupBannerMeta");
  const dismissBtn = document.getElementById("backupBannerDismiss");
  const backupNowBtn = document.getElementById("backupBannerNow");

  function todayISO(){ return new Date().toISOString().slice(0,10); }
  function nowHHMM(){
    const d = new Date();
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    return `${hh}:${mm}`;
  }
  function isSameDay(isoA, isoB){
    if(!isoA || !isoB) return false;
    return isoA.slice(0,10) === isoB.slice(0,10);
  }
  function compareHHMM(a,b){
    return a.replace(":","") >= b.replace(":","");
  }

  function detectKey(){
    const keys = Object.keys(localStorage);
    for(const k of keys){
      const raw = localStorage.getItem(k);
      if(!raw || raw.length < 20) continue;
      if(raw[0] !== "{") continue;
      try{
        const obj = JSON.parse(raw);
        const state = obj && obj.state ? obj.state : obj;
        if(state && typeof state === "object"){
          const has = (state.modules && typeof state.modules === "object") ||
                      (state.residentsById && typeof state.residentsById === "object") ||
                      Array.isArray(state.abt) || Array.isArray(state.vaccinations) || Array.isArray(state.ipCases) ||
                      (state.modules && state.modules.abt && Array.isArray(state.modules.abt.courses)) ||
                      (state.modules && state.modules.vaccinations && Array.isArray(state.modules.vaccinations.records)) ||
                      (state.modules && state.modules.ip && Array.isArray(state.modules.ip.cases));
          if(has) return k;
        }
      }catch(e){}
    }
    return null;
  }

  function downloadText(filename, text, mime){
    const blob = new Blob([text], {type: mime || "text/plain"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 600);
  }

  function filenameFor(mode){
    const d = new Date();
    const ymd = d.toISOString().slice(0,10);
    if(mode === "timestamp"){
      const stamp = d.toISOString().slice(0,19).replace(/[:T]/g,"-");
      return `icn-backup-${stamp}.json`;
    }
    return `icn-backup-${ymd}.json`;
  }

  function doBackupNow(){
    const key = detectKey();
    if(!key){
      alert("Store key not detected. Open your tracker once, then retry.");
      return;
    }
    const raw = localStorage.getItem(key) || "";
    const mode = localStorage.getItem(MODE_KEY) || "daily";
    downloadText(filenameFor(mode), raw, "application/json");
    localStorage.setItem(LAST_BACKUP_AT_KEY, new Date().toISOString());
    render();
  }

  function shouldShow(){
    const last = localStorage.getItem(LAST_BACKUP_AT_KEY) || "";
    const dismissedAt = localStorage.getItem(DISMISS_KEY) || "";
    const backupTime = localStorage.getItem(TIME_KEY) || "19:00";

    if(dismissedAt && isSameDay(dismissedAt, new Date().toISOString())) return false;
    if(!last) return true;
    if(isSameDay(last, new Date().toISOString())) return false;
    return compareHHMM(nowHHMM(), backupTime);
  }

  function render(){
    if(!banner) return;
    if(!shouldShow()){
      banner.style.display = "none";
      return;
    }
    const last = localStorage.getItem(LAST_BACKUP_AT_KEY) || "";
    const backupTime = localStorage.getItem(TIME_KEY) || "19:00";
    const mode = localStorage.getItem(MODE_KEY) || "daily";

    if(!last){
      msg.textContent = "No backup found. Please export a backup now.";
      meta.textContent = `Last backup: NEVER • Reminder time: ${backupTime} • Filename: ${mode}`;
    }else{
      msg.textContent = "No backup recorded today. Please export now to protect/sync your local data.";
      meta.textContent = `Last backup: ${last.replace("T"," ").replace("Z","")} • Reminder time: ${backupTime} • Filename: ${mode}`;
    }
    banner.style.display = "";
  }

  if(dismissBtn){
    dismissBtn.addEventListener("click", () => {
      localStorage.setItem(DISMISS_KEY, new Date().toISOString());
      if(banner) banner.style.display = "none";
    });
  }
  if(backupNowBtn){
    backupNowBtn.addEventListener("click", doBackupNow);
  }

  render();
})();
</script>

</body>
</html>
