<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ICN Suite — Apply to Tracker (Ops)</title>
<style>
@font-face{font-family:"CameraPlainVariable";src:url("https://cdn.gpteng.co/mcp-widgets/v1/fonts/CameraPlainVariable.woff2") format("woff2");font-weight:100 900;font-style:normal;font-display:swap;}
:root{--font:"CameraPlainVariable",ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;--bg:245 246 248;--card:255 255 255;--text:18 18 18;--muted:110 118 129;--border:225 228 232;--shadow:0 10px 30px rgba(0,0,0,.06);--radius:16px;--pill:9999px;}
body{margin:0;font-family:var(--font);background:rgb(var(--bg));color:rgb(var(--text));}
.wrap{max-width:1040px;margin:0 auto;padding:14px;}
.card{background:rgb(var(--card));border:1px solid rgb(var(--border));border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;}
h1{font-size:18px;margin:0 0 6px;}
.sub{color:rgb(var(--muted));font-size:13px;margin:0 0 12px;line-height:1.35;}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
.pill{display:inline-flex;align-items:center;gap:6px;border-radius:var(--pill);border:1px solid rgb(var(--border));padding:6px 10px;font-size:12px;color:rgb(var(--muted));background:#fff;}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}
button{border:1px solid rgb(var(--border));background:#fff;border-radius:var(--pill);padding:10px 14px;font:inherit;cursor:pointer;box-shadow:0 2px 10px rgba(0,0,0,.03);}
button.primary{background:rgba(0,0,0,.92);color:#fff;border-color:rgba(0,0,0,.92);}
button.danger{background:#b00020;color:#fff;border-color:#b00020;}
textarea,input{width:100%;border:1px solid rgb(var(--border));border-radius:12px;padding:10px;font:inherit;background:#fff;box-sizing:border-box;}
textarea{min-height:160px;resize:vertical;}
.grid{display:grid;grid-template-columns:1fr;gap:12px;}
@media(min-width:980px){.grid{grid-template-columns:1.05fr .95fr;}}
.list{border:1px solid rgb(var(--border));border-radius:12px;padding:10px;background:#fff;max-height:340px;overflow:auto;}
.item{display:flex;gap:10px;align-items:flex-start;padding:8px;border:1px solid rgb(var(--border));border-radius:12px;margin-bottom:8px;background:#fff;}
.meta{flex:1 1 auto;}
.title{font-size:12px;margin:0 0 2px;}
.sub2{font-size:11px;color:rgb(var(--muted));margin:0;}
.actions{display:flex;flex-direction:column;gap:6px;}
.actions button{padding:7px 10px;font-size:12px;}
.small{font-size:12px;color:rgb(var(--muted));}
.hr{height:1px;background:rgb(var(--border));margin:12px 0;}
</style>
</head>
<body>

<div id="backupBanner" style="display:none;position:sticky;top:0;z-index:9999;">
  <div style="background:#fff3cd;border:1px solid #ffeeba;color:#856404;border-radius:12px;padding:10px;margin:10px 0;box-shadow:0 6px 20px rgba(0,0,0,.06);">
    <div style="display:flex;gap:10px;align-items:flex-start;flex-wrap:wrap;justify-content:space-between;">
      <div style="min-width:240px;flex:1 1 auto;">
        <div style="font-weight:700;margin-bottom:4px;">End-of-day backup reminder</div>
        <div id="backupBannerMsg" style="font-size:13px;line-height:1.35;">
          Your data is local per browser. Export a backup JSON at the end of the day.
        </div>
        <div id="backupBannerMeta" style="font-size:12px;opacity:.85;margin-top:4px;"></div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
        <button type="button" id="backupBannerNow" style="border:1px solid #e1e4e8;background:#121212;color:#fff;border-radius:9999px;padding:10px 14px;cursor:pointer;">Backup Now</button>
        <a href="/backup" style="text-decoration:none;"><button type="button" style="border:1px solid #e1e4e8;background:#fff;border-radius:9999px;padding:10px 14px;cursor:pointer;">Backup Center</button></a>
        <button type="button" id="backupBannerDismiss" style="border:1px solid #e1e4e8;background:#fff;border-radius:9999px;padding:10px 14px;cursor:pointer;">Dismiss</button>
      </div>
    </div>
    <div style="font-size:12px;opacity:.8;margin-top:8px;">
      Note: most browsers won’t silently overwrite existing files. Use the same daily filename and replace if prompted, or keep timestamped backups.
    </div>
  </div>
</div>


<div id="backupBanner" style="display:none;position:sticky;top:0;z-index:9999;">
  <div style="background:#fff3cd;border:1px solid #ffeeba;color:#856404;border-radius:12px;padding:10px;margin:10px 0;box-shadow:0 6px 20px rgba(0,0,0,.06);">
    <div style="display:flex;gap:10px;align-items:flex-start;flex-wrap:wrap;justify-content:space-between;">
      <div style="min-width:240px;flex:1 1 auto;">
        <div style="font-weight:700;margin-bottom:4px;">Backup reminder</div>
        <div id="backupBannerMsg" style="font-size:13px;line-height:1.35;">
          Your data is stored locally per browser. Export a backup JSON regularly.
        </div>
        <div id="backupBannerMeta" style="font-size:12px;opacity:.85;margin-top:4px;"></div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
        <a href="/backup" style="text-decoration:none;"><button type="button" style="border:1px solid #e1e4e8;background:#fff;border-radius:9999px;padding:10px 14px;cursor:pointer;">Open Backup Center</button></a>
        <button type="button" id="backupBannerDismiss" style="border:1px solid #e1e4e8;background:#fff;border-radius:9999px;padding:10px 14px;cursor:pointer;">Dismiss</button>
      </div>
    </div>
  </div>
</div>

<div class="wrap">
<div class="card">
<div class="row" style="justify-content:space-between;">
  <div>
    <h1>Apply to Tracker (Ops)</h1>
    <p class="sub">Applies queued packs into your tracker localStorage with schema mapping + dedup. Backup is created before write.</p>
  </div>
  <div class="row">
    <a href="/working" style="text-decoration:none;"><button>Working</button></a>
    <a href="/reports" style="text-decoration:none;"><button class="primary">Reports</button></a>
  </div>
</div>

<div class="row">
  <span class="pill">Queue key: <span class="mono">icn_import_queue_v1</span></span>
  <span class="pill">Backup: <span class="mono">icn_state_backup_*</span></span>
</div>

<div class="hr"></div>

<div class="grid">
  <div>
    <div class="row">
      <button id="refresh">Refresh</button>
      <button id="selectAll">Select all</button>
      <button id="selectNone">Select none</button>
      <button id="apply" class="primary">Apply selected → Tracker</button>
      <button id="clearQueue" class="danger">Clear queue</button>
    </div>

    <label style="margin-top:10px;">Queued packs</label>
    <div id="queueList" class="list"></div>

    <div class="hr"></div>

    <div class="row">
      <button id="pickFiles">Apply JSON file(s)</button>
      <input id="files" type="file" accept="application/json,.json,.txt" multiple style="display:none;" />
      <button id="downloadBackup">Download latest backup</button>
    </div>

    <div class="hr"></div>
    <label>Logs</label>
    <textarea id="log" class="mono" readonly></textarea>
  </div>

  <div>
    <label>Detected tracker storage</label>
    <textarea id="detected" class="mono" readonly></textarea>

    <label style="margin-top:10px;">Preview (first 5)</label>
    <textarea id="preview" class="mono" readonly></textarea>

    <div class="hr"></div>

    <label>Paste pack JSON</label>
    <textarea id="paste" class="mono" placeholder='{"version":"icn-bulk-import-v1", ...}'></textarea>
    <div class="row" style="margin-top:10px;">
      <button id="applyPaste" class="primary">Apply pasted pack</button>
    </div>
  </div>
</div>
</div>
</div>




<script>
(function(){
  const LAST_BACKUP_AT_KEY = "icn_last_backup_at_v1";
  const DISMISS_KEY = "icn_backup_banner_dismissed_at_v1";
  const TIME_KEY = "icn_backup_time_hhmm_v1";            // default 19:00
  const MODE_KEY = "icn_backup_filename_mode_v1";        // "daily" | "timestamp"

  const banner = document.getElementById("backupBanner");
  const msg = document.getElementById("backupBannerMsg");
  const meta = document.getElementById("backupBannerMeta");
  const dismissBtn = document.getElementById("backupBannerDismiss");
  const backupNowBtn = document.getElementById("backupBannerNow");

  function todayISO(){ return new Date().toISOString().slice(0,10); }
  function nowHHMM(){
    const d = new Date();
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    return `${hh}:${mm}`;
  }
  function isSameDay(isoA, isoB){
    if(!isoA || !isoB) return false;
    return isoA.slice(0,10) === isoB.slice(0,10);
  }
  function compareHHMM(a,b){
    return a.replace(":","") >= b.replace(":","");
  }

  function detectKey(){
    const keys = Object.keys(localStorage);
    for(const k of keys){
      const raw = localStorage.getItem(k);
      if(!raw || raw.length < 20) continue;
      if(raw[0] !== "{") continue;
      try{
        const obj = JSON.parse(raw);
        const state = obj && obj.state ? obj.state : obj;
        if(state && typeof state === "object"){
          const has = (state.modules && typeof state.modules === "object") ||
                      (state.residentsById && typeof state.residentsById === "object") ||
                      Array.isArray(state.abt) || Array.isArray(state.vaccinations) || Array.isArray(state.ipCases) ||
                      (state.modules && state.modules.abt && Array.isArray(state.modules.abt.courses)) ||
                      (state.modules && state.modules.vaccinations && Array.isArray(state.modules.vaccinations.records)) ||
                      (state.modules && state.modules.ip && Array.isArray(state.modules.ip.cases));
          if(has) return k;
        }
      }catch(e){}
    }
    return null;
  }

  function downloadText(filename, text, mime){
    const blob = new Blob([text], {type: mime || "text/plain"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 600);
  }

  function filenameFor(mode){
    const d = new Date();
    const ymd = d.toISOString().slice(0,10);
    if(mode === "timestamp"){
      const stamp = d.toISOString().slice(0,19).replace(/[:T]/g,"-");
      return `icn-backup-${stamp}.json`;
    }
    return `icn-backup-${ymd}.json`;
  }

  function doBackupNow(){
    const key = detectKey();
    if(!key){
      alert("Store key not detected. Open your tracker once, then retry.");
      return;
    }
    const raw = localStorage.getItem(key) || "";
    const mode = localStorage.getItem(MODE_KEY) || "daily";
    downloadText(filenameFor(mode), raw, "application/json");
    localStorage.setItem(LAST_BACKUP_AT_KEY, new Date().toISOString());
    render();
  }

  function shouldShow(){
    const last = localStorage.getItem(LAST_BACKUP_AT_KEY) || "";
    const dismissedAt = localStorage.getItem(DISMISS_KEY) || "";
    const backupTime = localStorage.getItem(TIME_KEY) || "19:00";

    if(dismissedAt && isSameDay(dismissedAt, new Date().toISOString())) return false;
    if(!last) return true;
    if(isSameDay(last, new Date().toISOString())) return false;
    return compareHHMM(nowHHMM(), backupTime);
  }

  function render(){
    if(!banner) return;
    if(!shouldShow()){
      banner.style.display = "none";
      return;
    }
    const last = localStorage.getItem(LAST_BACKUP_AT_KEY) || "";
    const backupTime = localStorage.getItem(TIME_KEY) || "19:00";
    const mode = localStorage.getItem(MODE_KEY) || "daily";

    if(!last){
      msg.textContent = "No backup found. Please export a backup now.";
      meta.textContent = `Last backup: NEVER • Reminder time: ${backupTime} • Filename: ${mode}`;
    }else{
      msg.textContent = "No backup recorded today. Please export now to protect/sync your local data.";
      meta.textContent = `Last backup: ${last.replace("T"," ").replace("Z","")} • Reminder time: ${backupTime} • Filename: ${mode}`;
    }
    banner.style.display = "";
  }

  if(dismissBtn){
    dismissBtn.addEventListener("click", () => {
      localStorage.setItem(DISMISS_KEY, new Date().toISOString());
      if(banner) banner.style.display = "none";
    });
  }
  if(backupNowBtn){
    backupNowBtn.addEventListener("click", doBackupNow);
  }

  render();
})();
</script>

</body>
</html>