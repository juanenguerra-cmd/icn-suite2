<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Infection Control Nurse Compliance Suite — V1.1 (Legacy Import + Vax Nav) — LOCKED</title>
<style>:root{--bg:#f6f8fb;--card:#fff;--text:#111;--muted:#667085;--line:#d0d5dd;--brand:#1f5ea8;--brand2:#0b3b77;--good:#0f7a3a;--warn:#b54708;--bad:#b42318;--soft:#eef2f7;--zebra:#f3f6fb;--shadow:0 6px 18px rgba(16,24,40,.08);--radius:14px;--mono:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;--sans:Arial, Helvetica, sans-serif;} *{box-sizing:border-box} body{margin:0;font-family:var(--sans);color:var(--text);background:var(--bg)} header{position:sticky;top:0;z-index:50;background:#fff;border-bottom:1px solid var(--line)} .wrap{max-width:none;width:min(1600px,calc(100vw - 24px));margin:0 auto;padding:14px} .topbar{display:flex;gap:12px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap} .titlebox{min-width:280px} .app-title{font-weight:900;font-size:18px;margin:0} .app-sub{margin:2px 0 0;color:var(--muted);font-size:13px} .nav{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end} .topActions{display:flex;align-items:center;gap:8px;justify-content:flex-end} .aboutTabs{display:flex;gap:8px;flex-wrap:wrap;align-items:center} .aboutTab{border:1px solid var(--line);background:#fff;padding:6px 10px;border-radius:999px;font-weight:900;font-size:12px;cursor:pointer} .aboutTab.active{background:var(--brand);border-color:var(--brand2);color:#fff} .aboutPanel{display:none} .aboutPanel.active{display:block} .aboutK{display:grid;grid-template-columns:160px 1fr;gap:8px;align-items:start} @media(max-width:720px){.aboutK{grid-template-columns:1fr}} .tabbtn{border:1px solid var(--line);background:#fff;padding:8px 10px;border-radius:999px;font-size:13px;font-weight:800;cursor:pointer;white-space:nowrap} .tabbtn.active{background:var(--brand);border-color:var(--brand2);color:#fff} .pillrow{display:flex;gap:8px;flex-wrap:wrap;align-items:center} .pill{border:1px solid var(--line);background:var(--soft);color:var(--text);padding:8px 10px;border-radius:999px;font-size:13px;font-weight:800;cursor:pointer;user-select:none;white-space:nowrap} .pill[aria-pressed="true"]{background:var(--brand);border-color:var(--brand2);color:#fff} .ribbon{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between} .chipbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center} .chip{display:flex;gap:8px;align-items:center;padding:8px 10px;border:1px solid var(--line);background:#fff;border-radius:999px;font-size:13px;font-weight:800;white-space:nowrap} .chip .n{font-family:var(--mono);font-weight:900} .chip.good{border-color:rgba(15,122,58,.25);background:rgba(15,122,58,.06)} .chip.warn{border-color:rgba(181,71,8,.25);background:rgba(181,71,8,.06)} .chip.bad{border-color:rgba(180,35,24,.25);background:rgba(180,35,24,.06)} .righttools{display:flex;gap:8px;flex-wrap:wrap;align-items:center} .btn{border:1px solid var(--line);background:#fff;padding:9px 12px;border-radius:10px;font-weight:900;font-size:13px;cursor:pointer} .btn.primary{background:var(--brand);border-color:var(--brand2);color:#fff} .btn.danger{background:var(--bad);border-color:#7a1e1e;color:#fff} .btn:disabled{opacity:.55;cursor:not-allowed} .content{max-width:none;width:min(1600px,calc(100vw - 24px));margin:0 auto;padding:14px;overflow-x:auto}#tab-dashboard{min-width:980px} .grid{display:grid;gap:12px} .grid.cols2{grid-template-columns:1.2fr .8fr} .grid.cols3{grid-template-columns:repeat(3,1fr)} @media (max-width:600px){.grid.cols2,.grid.cols3{grid-template-columns:1fr}} .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px} .card h2{margin:0 0 8px;font-size:15px;font-weight:900} .card h3{margin:0 0 8px;font-size:14px;font-weight:900} .muted{color:var(--muted)} .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center} .row.end{justify-content:flex-end} label{font-size:12px;font-weight:900;color:var(--muted);display:block;margin-bottom:4px} input[type="text"],input[type="number"],input[type="date"],select,textarea{width:100%;border:1px solid var(--line);border-radius:10px;padding:10px 10px;font-size:14px;outline:none;background:#fff} textarea{min-height:130px;font-family:var(--mono);font-size:12px} .mini{font-size:12px} .sep{height:1px;background:var(--line);margin:10px 0} table{border-collapse:collapse;width:100%} th,td{border:1px solid var(--line);padding:8px;font-size:12px;vertical-align:top} th{background:var(--soft);font-weight:900} tr:nth-child(even) td{background:var(--zebra)} .nowrap{white-space:nowrap} .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#fff;font-size:12px;font-weight:900} button.badge{cursor:pointer;border:1px solid var(--line)} .badge.blue{background:rgba(31,94,168,.10);border-color:rgba(31,94,168,.25)} .badge.red{background:rgba(180,35,24,.10);border-color:rgba(180,35,24,.25)} .badge.green{background:rgba(15,122,58,.10);border-color:rgba(15,122,58,.25)} .badge.amber{background:rgba(181,71,8,.10);border-color:rgba(181,71,8,.25)} .smallbtn{border:1px solid var(--line);background:#fff;padding:6px 8px;border-radius:10px;font-weight:900;font-size:12px;cursor:pointer} .smallbtn.primary{background:var(--brand);border-color:var(--brand2);color:#fff} .smallbtn.danger{background:var(--bad);border-color:#7a1e1e;color:#fff} .kpi{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px;border:1px solid var(--line);border-radius:12px;background:linear-gradient(180deg,#fff,#fbfcff)} .kpi .big{font-weight:900;font-size:20px;font-family:var(--mono)} .kpi .lbl{font-size:12px;font-weight:900;color:var(--muted)} .progress{height:10px;background:var(--soft);border-radius:999px;overflow:hidden;border:1px solid rgba(0,0,0,.06)} .progress>div{height:100%;width:0%;background:var(--brand);border-radius:999px} .modalback{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:16px;z-index:1000} .modal{width:min(1100px,100%);max-height:88vh;overflow:auto;background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 20px 50px rgba(0,0,0,.22);padding:12px} .modal .top{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap} .closex{border:1px solid var(--line);background:#fff;border-radius:10px;padding:6px 10px;font-weight:900;cursor:pointer} @media print{header,.nav,.righttools,.btn,.pillrow,.tabbtn,.noprint{display:none !important} body{background:#fff} .content{padding:0;max-width:none} .card{box-shadow:none} .printpage{page-break-after:always} } .smallsel{padding:6px 10px;border-radius:10px;border:1px solid var(--line);background:#fff;font-weight:800} body[data-role="Surveyor"] .edit-only{display:none !important} body[data-role="Surveyor"] .admin-only{display:none !important} body[data-role="Staff"] .admin-only{display:none !important} #topNav{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;} #topNav .nav-left{display:flex;align-items:center;gap:8px;flex-wrap:wrap;} .morewrap{position:relative;} .moremenu{position:absolute;right:0;top:calc(100% + 6px);background:#ffffff;color:var(--text);opacity:1;border:1px solid var(--line);border-radius:14px;padding:8px;min-width:260px;box-shadow:0 10px 30px rgba(0,0,0,.14);display:none;z-index:9999;isolation:isolate;transform:translateZ(0);-webkit-transform:translateZ(0);-webkit-backface-visibility:hidden;} .moremenu.open{display:block;} .menubtn{width:100%;text-align:left;padding:10px 10px;border-radius:10px;border:0;background:transparent;font-weight:800;cursor:pointer;} .menubtn:hover{background:var(--surface-hover-soft);} .menubtn.active{background:var(--surface-hover-soft);} .menudiv{height:1px;background:var(--line);margin:8px 0;} @media (max-width:560px){.moremenu{left:0;right:auto;min-width:220px;} } .moremenu{max-height:72vh;overflow:auto;} .moresearch{padding:6px 6px 2px 6px;position:sticky;top:0;background:#fff;z-index:2;} .moresearch input{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;font-weight:800;outline:none;} .moresearch input:focus{border-color:rgba(13, 110, 253, .45);box-shadow:0 0 0 3px rgba(13,110,253,.12);} .fmgrid{display:grid;grid-template-columns:repeat(auto-fill, minmax(140px, 1fr));gap:10px;} .fmcell{border:1px solid var(--line);border-radius:16px;background:var(--surface);padding:10px;cursor:pointer;user-select:none;} .fmcell:hover{background:var(--surface-hover-soft);} .fmTop{display:flex;justify-content:space-between;align-items:center;gap:8px;} .fmRoom{font-weight:900;font-size:14px;} .fmStatus{font-weight:900;} .fmName{margin-top:6px;font-weight:800;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;} .fmBadges{margin-top:8px;display:flex;gap:6px;flex-wrap:wrap;} .fmMini{margin-top:6px;font-size:12px;} @media print{.noprint{display:none !important;} #tab-floormap .card{box-shadow:none !important;border:0 !important;} .fmgrid{grid-template-columns:repeat(5, 1fr);} } .dashGrid{display:grid;grid-template-columns:minmax(360px, 520px) 1fr;gap:14px;align-items:start;} @media (max-width:420px){.dashGrid{grid-template-columns:1fr;} } .trDup td{background:rgba(220, 38, 38, .06) !important;} .badgeDup{background:rgba(220, 38, 38, .14);color:#7f1d1d;border:1px solid rgba(220,38,38,.25);} .backupRibbon{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:10px 12px;border:1px solid var(--line);border-radius:16px;background:#fff;margin-top:10px;} .brLeft{display:flex;align-items:center;gap:10px;min-width:0;} .brText{font-weight:900;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;} .brRight{display:flex;gap:8px;align-items:center;flex-wrap:wrap;} .brDot{width:10px;height:10px;border-radius:50%;background:#94a3b8;box-shadow:0 0 0 3px rgba(148,163,184,.18);flex:0 0 auto;} .brDot.green{background:#16a34a;box-shadow:0 0 0 3px rgba(22,163,74,.16);} .brDot.yellow{background:#f59e0b;box-shadow:0 0 0 3px rgba(245,158,11,.16);} .brDot.red{background:#dc2626;box-shadow:0 0 0 3px rgba(220,38,38,.16);} @media (max-width:560px){.backupRibbon{padding:10px;} .brText{font-size:12px;} } table.thin{width:100%;border-collapse:collapse;} table.thin th, table.thin td{border:1px solid var(--line);padding:6px 8px;vertical-align:top;} .dashGrid{display:grid;grid-template-columns:minmax(360px, 520px) minmax(360px, 1fr);gap:14px;align-items:start;} @media (max-width:420px){.dashGrid{grid-template-columns:1fr;} }
/* Phase 3: Dashboard Settings + Favorites */
.dashControlsTop{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
.favbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.favHint{font-size:12px;color:var(--muted)}


/* === PHASE3 LAYOUT LOCK: SINGLE COLUMN FULL WIDTH === */
#tab-dashboard{min-width:0 !important;}
.content{overflow-x:hidden !important;}
.dashGrid{grid-template-columns:1fr !important;}
.dashLeft,.dashRight{max-width:none !important;width:100% !important;}


/* ABT Parse Table Fix */
#abtParsedTable { table-layout: fixed; width: 100%; }
#abtParsedTable th, #abtParsedTable td { vertical-align: middle; }
#abtParsedTable thead th { position: sticky; top: 0; z-index: 3; background: #f3f6fb; }
#abtParsedTable th:nth-child(1), #abtParsedTable td:nth-child(1){ width: 44px; text-align:center; }
#abtParsedTable th:nth-child(2), #abtParsedTable td:nth-child(2){ width: 180px; }
#abtParsedTable th:nth-child(3), #abtParsedTable td:nth-child(3){ width: 120px; }
#abtParsedTable th:nth-child(4), #abtParsedTable td:nth-child(4){ width: 140px; }
#abtParsedTable th:nth-child(5), #abtParsedTable td:nth-child(5){ width: 110px; }
#abtParsedTable th:nth-child(6), #abtParsedTable td:nth-child(6){ width: 90px; }
#abtParsedTable th:nth-child(7), #abtParsedTable td:nth-child(7){ width: 90px; }
#abtParsedTable th:nth-child(8), #abtParsedTable td:nth-child(8){ width: 120px; }
#abtParsedTable th:nth-child(9), #abtParsedTable td:nth-child(9){ width: 120px; }
#abtParsedTable th:nth-child(10), #abtParsedTable td:nth-child(10){ width: 140px; }
#abtParsedTable th:nth-child(11), #abtParsedTable td:nth-child(11){ width: 90px; }
#abtParsedTable th:nth-child(12), #abtParsedTable td:nth-child(12){ width: 120px; }
#abtParsedTable input, #abtParsedTable select { width: 100%; box-sizing: border-box; }

</style>

<style id="icn-style-rules">
/* ICN Compliance Suite — Style Rules (Locked)
   Surfaces: rounded-xl. Controls: rounded-full. Tables: standardized.
   Dialogs/Sheets: consistent modal styling.
*/

@font-face {
  font-family: 'CameraPlainVariable';
  src: url('https://cdn.gpteng.co/mcp-widgets/v1/fonts/CameraPlainVariable.woff2') format('woff2');
  font-weight: 100 900;
  font-style: normal;
  font-display: swap;
}

:root{
  --icn-radius-xl: 16px;
  --icn-radius-full: 999px;
  --icn-shadow-soft: 0 10px 30px rgba(16,24,40,.10);
  --icn-shadow-tighter: 0 6px 18px rgba(16,24,40,.08);
  --surface: #ffffff;
  --surface-2: #fbfcff;
  --surface-soft: rgba(31,94,168,.06);
  --surface-hover-soft: rgba(2, 6, 23, .04);
}

body{
  font-family: CameraPlainVariable, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, Helvetica, sans-serif;
}

/* Surfaces */
.card,
.backupRibbon,
.kpi,
.moremenu,
.fmcell{
  border-radius: var(--icn-radius-xl) !important;
  box-shadow: var(--icn-shadow-tighter) !important;
}

/* Controls (rounded-full) */
.btn,
.smallbtn,
.tabbtn,
.pill,
.chip,
.badge,
.aboutTab,
.closex,
.smallsel,
.moresearch input,
.menubtn{
  border-radius: var(--icn-radius-full) !important;
}

/* Button polish */
.btn,.smallbtn,.tabbtn,.pill,.aboutTab,.menubtn{
  transition: transform .08s ease, background-color .18s ease, border-color .18s ease, color .18s ease, box-shadow .18s ease;
}
.btn:active,.smallbtn:active,.tabbtn:active,.pill:active,.aboutTab:active{ transform: scale(.98); }
.btn:focus-visible,.smallbtn:focus-visible,.tabbtn:focus-visible,.pill:focus-visible,.aboutTab:focus-visible,.menubtn:focus-visible{
  outline: 2px solid rgba(87, 94, 207, .55);
  outline-offset: 2px;
}

/* Inputs */
input[type="text"],input[type="number"],input[type="date"],select,textarea{
  border-radius: 14px !important;
}
input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus, select:focus, textarea:focus{
  border-color: rgba(87, 94, 207, .35) !important;
  box-shadow: 0 0 0 3px rgba(87, 94, 207, .12) !important;
}

/* Standardized table styling */
table{
  border-radius: var(--icn-radius-xl);
  overflow: hidden;
}
Table, .tableWrap{ width:100%; }
.tableWrap{ overflow:auto; border-radius: var(--icn-radius-xl); border:1px solid var(--line); }
.tableWrap table{ border:0; }
thead th{
  position: sticky;
  top: 0;
  z-index: 2;
}
tr:nth-child(even) td{ background: var(--zebra); }
tr[data-state="selected"] td{ background: rgba(87, 94, 207, .08) !important; }

/* Dialog / Sheet (modal) */
.modal{
  border-radius: 22px !important;
  box-shadow: var(--icn-shadow-soft) !important;
}
.modal .top{
  padding-bottom: 6px;
}

/* Filter chips (template compatibility) */
.filter-chip{
  display:flex;
  align-items:center;
  gap:8px;
  padding:8px 10px;
  border:1px solid var(--line);
  background: var(--surface);
  border-radius: var(--icn-radius-full);
  font-size: 13px;
  font-weight: 800;
}

@media print{
  .card,.backupRibbon,.kpi,.moremenu,.modal{ box-shadow:none !important; }
}
</style>

</head>
<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="titlebox">
        <p class="app-title" id="appTitle">Infection Control Nurse Compliance Suite</p>
        <p class="app-sub" id="appSub">V1.1 — Legacy Import + Facility Occupancy + ABT/IP + Vax nav (basic)</p>
      </div>
      <div class="nav" id="topNav">
  <div class="nav-left">
    <button class="tabbtn" data-tab="dashboard">Dashboard</button>
    <button class="tabbtn" data-tab="ip">Cases</button>
    <button class="tabbtn" data-tab="audits">Audits</button>
    <button class="tabbtn" data-tab="reports">Reports</button>
    <button class="tabbtn" data-tab="packet">Survey Packet</button>
    <button class="tabbtn" data-tab="actions">QAPI Actions</button>

    <div class="morewrap">
      <button class="tabbtn" id="btnMore" type="button" aria-haspopup="true" aria-expanded="false">More ▾</button>
      <div class="moremenu" id="moreMenu" role="menu" aria-label="More">
        <div class="moresearch">
          <input id="moreSearch" type="search" placeholder="Search modules…" autocomplete="off"/>
        </div>
        <div class="menudiv"></div>
<button class="menubtn" role="menuitem" data-tab="census">Census</button>
        <button class="menubtn" role="menuitem" data-tab="abt">Antibiotics (ABT)</button>
        <button class="menubtn" role="menuitem" data-tab="vax">Vaccinations</button>
        <button class="menubtn" role="menuitem" data-tab="surveillance">Surveillance</button>
        <button class="menubtn" role="menuitem" data-tab="floormap">Floor Map</button>
        <button class="menubtn" role="menuitem" data-tab="comms">Communications</button>
        <button class="menubtn" role="menuitem" data-tab="decisions">Decision Log</button>
        <button class="menubtn" role="menuitem" data-tab="staff">Staffing</button>
        <button class="menubtn" role="menuitem" data-tab="env">Environment</button>
        <div class="menudiv"></div>
        <button class="menubtn admin-only" role="menuitem" data-tab="warehouse">Data</button>
        <button class="menubtn" role="menuitem" data-tab="config">Config</button>
      </div>
    </div>
  </div>
</div>
          <div class="topActions">
  <span class="badge" id="roleBadge">Role: —</span>
  <select id="viewAsRole" class="smallsel" style="display:none">
    <option value="">View as…</option>
    <option value="Admin">Admin</option>
    <option value="Staff">Staff</option>
    <option value="Surveyor">Surveyor</option>
  </select>
  <button class="smallbtn" id="btnAbout">About</button>
</div>
</div>

    <div class="ribbon">

    <div class="backupRibbon noprint" id="backupRibbon" style="display:none">
      <div class="brLeft">
        <span class="brDot" id="brDot"></span>
        <span class="brText" id="brText">Backup reminder</span>
      </div>
      <div class="brRight">
        <button class="smallbtn" id="btnBackupNow">Backup Now</button>
        <button class="smallbtn" id="btnBackupCfg" title="Backup reminder settings" aria-label="Backup reminder settings">⚙️</button>
      </div>
    </div>
      <div class="chipbar">
        <div class="chip"><span>Building Census</span> <span class="n" id="censusTotal">0</span></div>
        <div class="chip"><span>Capacity</span> <span class="n" id="capTotal">—</span></div>
        <div class="chip" id="occChip"><span>Occupancy</span> <span class="n" id="occPct">—</span></div>
        <div class="chip"><span>Unit</span>
          <div class="pillrow" id="unitPills" style="margin-left:6px"></div>
        </div>
        <label class="chip" style="gap:8px; cursor:pointer">
          <input id="toggleIncludeDischarged" type="checkbox" style="transform:scale(1.1)"/>
          <span>Include Discharged</span>
        </label>
      </div>

      <div class="righttools">
        <button class="btn" id="btnBackup">Export Backup</button>
        <button class="btn" id="btnRestore">Import Backup</button>
        <button class="btn" id="btnLegacy">Import Legacy JSON (Map)</button>
        <button class="btn danger" id="btnReset">Reset Local Data</button>
      </div>
    </div>
  </div>
</header>

<div class="content">

  <section id="tab-dashboard" class="tab">
    <div class="card noprint" id="dashControls" data-dashblock="controls">
      <div class="dashControlsTop">
        <div>
          <h2 style="margin:0">Dashboard</h2>
          <div class="favHint">Pinned favorites + view controls (desktop stays 2-column).</div>
        </div>
        <div class="row" style="gap:8px">
          <button class="btn" id="btnDashSettings" type="button">Dashboard Settings</button>
          <button class="btn" id="btnDashFavs" type="button">Manage Favorites</button>
        </div>
      </div>
      <div class="sep"></div>
      <div class="favbar" id="dashFavBar"></div>
    </div>
    <div class="dashGrid force-2col">

  <div class="dashLeft">
<div class="card" id="dashFacilityCard" data-dashblock="facility">
        <h2>Facility Snapshot</h2>
        <div class="kpi">
          <div>
            <div class="lbl">Current Census / Capacity</div>
            <div class="big" id="kpiCensus">0 / —</div>
          </div>
          <div style="min-width:220px">
            <div class="lbl">Occupancy</div>
            <div class="progress"><div id="occBar"></div></div>
            <div class="mini muted" id="occText" style="margin-top:6px">—</div>
          </div>
        </div>

        <div class="sep"></div>
        <h3>Per-Unit Occupancy</h3>
        <div class="grid cols3" id="unitCards"></div>

        <div class="sep"></div>
        <h3>Quick Drilldowns</h3>
<div class="muted mini">One-click navigation to key operational lists. (Counts update with Unit filter.)</div>
<div class="sep"></div>

<div class="grid cols3" id="quickDrillCards">
  <div class="card" style="box-shadow:none">
    <div class="row" style="justify-content:space-between; align-items:flex-start">
      <div>
        <div class="mini muted">ABT</div>
        <div style="font-weight:900; font-size:16px; margin-top:2px">Active antibiotics</div>
      </div>
      <span class="badge blue" id="pillAbtActive">Active: —</span>
    </div>
    <div class="sep"></div>
    <div class="row"><button class="btn primary" id="goAbt">Open ABT</button></div>
  </div>

  <div class="card" style="box-shadow:none">
    <div class="row" style="justify-content:space-between; align-items:flex-start">
      <div>
        <div class="mini muted">IP</div>
        <div style="font-weight:900; font-size:16px; margin-top:2px">Active precautions</div>
      </div>
      <span class="badge red" id="pillIpActive">Active: —</span>
    </div>
    <div class="sep"></div>
    <div class="row"><button class="btn primary" id="goIp">Open IP</button></div>
  </div>

  <div class="card" style="box-shadow:none">
    <div class="row" style="justify-content:space-between; align-items:flex-start">
      <div>
        <div class="mini muted">Vaccinations</div>
        <div style="font-weight:900; font-size:16px; margin-top:2px">This week overview</div>
      </div>
      <span class="badge green" id="pillVaxWeek">Week: —</span>
    </div>
    <div class="sep"></div>
    <div class="row" style="gap:8px; flex-wrap:wrap">
      <button class="btn primary" id="goVaxWeek">Open Vax (This Week)</button>
      <span class="badge">Vacc: <span id="pillVaxVacc">—</span></span>
      <span class="badge">Decl: <span id="pillVaxDecl">—</span></span>
      <span class="badge">Pend: <span id="pillVaxPend">—</span></span>
    </div>
  </div>

  <div class="card" style="box-shadow:none">
    <div class="row" style="justify-content:space-between; align-items:flex-start">
      <div>
        <div class="mini muted">Empty Rooms/Beds</div>
        <div style="font-weight:900; font-size:16px; margin-top:2px">Availability</div>
      </div>
      <span class="badge" id="pillEmptyRooms">—</span>
    </div>
    <div class="sep"></div>
    <div class="muted mini">Based on Room Inventory (recommended) or known rooms.</div>
    <div class="row" style="margin-top:10px">
      <button class="btn primary" id="goEmptyRooms">View Empty Rooms</button>
    </div>
  </div>
</div>

<div class="sep"></div>

  </div>
  <div class="dashRight">
<div class="card" id="dashResidentCard" data-dashblock="resident">
        <h2>Resident Snapshot</h2>
        <div class="row">
          <div style="flex:1">
            <label>Resident Selector</label>
            <select id="residentSelect"></select>
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="btn" id="btnOpenProfile" disabled>Open Profile</button>
          </div>
        </div>
        <div class="sep"></div>
        <div id="profilePanel" class="muted">Select a resident to view snapshot.</div>
      

      <div class="card" id="dashComplianceCard" data-dashblock="compliance">
        <h2>Compliance Dashboard</h2>
<div class="row" style="gap:10px; align-items:flex-end; margin:8px 0 12px; display:none;">
  <div class="field" style="min-width:220px;">
    <label for="qapiUnitFilter">Unit (for Patient Days + rates)</label>
    <select id="qapiUnitFilter"></select>
  </div>
  <div class="hint" style="font-size:.9em; color:#566;">Patient-days are pulled from Admin/Config per-unit values when available. If missing, facility default is used.</div>
</div>
        <div class="muted mini">QAPI-ready metrics (uses your configured thresholds). Set patient-days targets in Config.</div>
        <div class="sep"></div>

        <div class="grid cols3">
          <div class="card" style="box-shadow:none">
            <div class="mini muted">Infection rate</div>
            <div style="font-weight:900; font-size:18px; margin-top:4px"><span id="kpiInfRate">—</span></div>
            <div class="muted mini">per 1,000 resident days (last <span id="kpiWindowDays">7</span>d)</div>
          </div>

          <div class="card" style="box-shadow:none">
            <div class="mini muted">ABT utilization</div>
            <div style="font-weight:900; font-size:18px; margin-top:4px"><span id="kpiAbtRate">—</span></div>
            <div class="muted mini">starts per 1,000 resident days (last <span id="kpiWindowDays2">7</span>d)</div>
          </div>

          <div class="card" style="box-shadow:none">
            <div class="mini muted">Overall compliance</div>
            <div style="font-weight:900; font-size:18px; margin-top:4px"><span id="kpiCompliancePct">—</span></div>
            <div class="progress" style="margin-top:10px"><div id="compBar"></div></div>
            <div class="muted mini" id="compHint" style="margin-top:6px">—</div>
          </div>
        </div>

        <div class="sep"></div>
        <div id="compDetails" class="row" style="gap:8px; flex-wrap:wrap"></div>
      </div>

</div>
    </div>

  <div class="sep"></div>

  <div class="card" id="situationBoardCard" data-dashblock="situation">
    <div class="row" style="justify-content:space-between; align-items:flex-start">
      <div>
        <h2>Situation Board</h2>
        <div class="muted mini">Current status, syndrome surveillance, isolation counts, and early-warning alerts.</div>
      </div>
      <div class="row edit-only" style="gap:10px; flex-wrap:wrap; align-items:flex-end">
        <div>
          <label style="margin-bottom:6px">Outbreak Status</label>
          <select id="outbreakStatusSel" class="smallsel">
            <option value="None">None</option>
            <option value="Watch">Watch</option>
            <option value="Suspected">Suspected</option>
            <option value="Confirmed">Confirmed</option>
            <option value="Controlled">Controlled</option>
          </select>
        </div>
        <div style="min-width:240px">
          <label style="margin-bottom:6px">Status Notes</label>
          <input id="outbreakStatusNotes" type="text" placeholder="Short note for today's status..."/>
        </div>
        <button class="btn primary" id="btnSaveStatus">Save</button>
      </div>
    </div>

    <div class="sep"></div>

    <div class="grid cols3">
      <div class="card" style="box-shadow:none">
        <div class="row" style="justify-content:space-between; align-items:flex-start">
          <div>
            <div class="mini muted">Today</div>
            <div style="font-weight:900; font-size:16px; margin-top:2px">New Cases</div>
          </div>
          <span class="badge blue" id="sbNewCases">—</span>
        </div>
        <div class="sep"></div>
        <div class="muted mini" id="sbNewCasesByUnit">—</div>
      </div>

      <div class="card" style="box-shadow:none">
        <div class="row" style="justify-content:space-between; align-items:flex-start">
          <div>
            <div class="mini muted">Active</div>
            <div style="font-weight:900; font-size:16px; margin-top:2px">Active Cases</div>
          </div>
          <span class="badge red" id="sbActiveCases">—</span>
        </div>
        <div class="sep"></div>
        <div class="muted mini" id="sbActiveCasesByUnit">—</div>
      </div>

      <div class="card" style="box-shadow:none">
        <div class="row" style="justify-content:space-between; align-items:flex-start">
          <div>
            <div class="mini muted">Status</div>
            <div style="font-weight:900; font-size:16px; margin-top:2px">Outbreak</div>
          </div>
          <span class="badge" id="sbOutbreakStatus">—</span>
        </div>
        <div class="sep"></div>
        <div class="muted mini" id="sbOutbreakStatusNotes">—</div>
      </div>
    </div>

    <div class="sep"></div>

    <div class="grid cols3">
      <div class="card" style="box-shadow:none">
        <div class="row" style="justify-content:space-between; align-items:flex-start">
          <div>
            <div class="mini muted">Syndromes</div>
            <div style="font-weight:900; font-size:16px; margin-top:2px">Active by type</div>
          </div>
          <span class="badge" id="sbSyndromeTotal">—</span>
        </div>
        <div class="sep"></div>
        <div id="sbSyndromeBreakdown" class="row" style="gap:6px; flex-wrap:wrap"></div>
      </div>

      <div class="card" style="box-shadow:none">
        <div class="row" style="justify-content:space-between; align-items:flex-start">
          <div>
            <div class="mini muted">Isolation / Precautions</div>
            <div style="font-weight:900; font-size:16px; margin-top:2px">Active counts</div>
          </div>
          <span class="badge" id="sbIsoTotal">—</span>
        </div>
        <div class="sep"></div>
        <div id="sbIsoBreakdown" class="row" style="gap:6px; flex-wrap:wrap"></div>
      </div>

      <div class="card" style="box-shadow:none">
        <div class="row" style="justify-content:space-between; align-items:flex-start">
          <div>
            <div class="mini muted">ABT Signal</div>
            <div style="font-weight:900; font-size:16px; margin-top:2px">New ABT starts</div>
          </div>
          <span class="badge green" id="sbAbtStarts">—</span>
        </div>
        <div class="sep"></div>
        <div class="muted mini" id="sbAbtStartsByUnit">—</div>
      </div>
    </div>

    <div class="sep"></div>

    <div class="sep"></div>

    <div class="grid cols3">
      <div class="card" style="box-shadow:none">
        <div class="row" style="justify-content:space-between; align-items:flex-start">
          <div>
            <div class="mini muted">Testing / Labs</div>
            <div style="font-weight:900; font-size:16px; margin-top:2px">Pending + Due</div>
          </div>
          <span class="badge blue" id="sbTestsPending">—</span>
        </div>
        <div class="sep"></div>
        <div id="sbTestsBreakdown" class="row" style="gap:6px; flex-wrap:wrap"></div>
        <div class="sep"></div>
        <div class="row noprint" style="justify-content:flex-end">
          <button class="smallbtn" id="btnOpenTests">Open Tests</button>
        </div>
      </div>

      <div class="card" style="box-shadow:none">
        <div class="row" style="justify-content:space-between; align-items:flex-start">
          <div>
            <div class="mini muted">Communications</div>
            <div style="font-weight:900; font-size:16px; margin-top:2px">Positives not logged</div>
          </div>
          <span class="badge red" id="sbUncommPos">—</span>
        </div>
        <div class="sep"></div>
        <div class="muted mini">If a result is positive but “Communicated” is still No.</div>
        <div class="sep"></div>
        <div class="row noprint" style="justify-content:flex-end">
          <button class="smallbtn" id="btnReviewUncomm">Review</button>
        </div>
      </div>

      <div class="card" style="box-shadow:none">
        <div class="row" style="justify-content:space-between; align-items:flex-start">
          <div>
            <div class="mini muted">Turnaround</div>
            <div style="font-weight:900; font-size:16px; margin-top:2px">Avg lab TAT</div>
          </div>
          <span class="badge" id="sbAvgTat">—</span>
        </div>
        <div class="sep"></div>
        <div class="muted mini" id="sbTatNote">Collected → Resulted</div>
      </div>
    </div>
    <div class="sep"></div>

    <div class="grid cols3">
      <div class="card" style="box-shadow:none">
        <div class="row" style="justify-content:space-between; align-items:flex-start">
          <div>
            <div class="mini muted">ABT</div>
            <div style="font-weight:900; font-size:16px; margin-top:2px">Active + SOC Gaps</div>
          </div>
          <span class="badge" id="sbAbtActive">—</span>
        </div>
        <div class="sep"></div>
        <div id="sbAbtSocChip" class="row" style="gap:6px; flex-wrap:wrap"></div>
        <div class="sep"></div>
        <div class="row noprint" style="justify-content:flex-end; gap:8px">
          <button class="smallbtn" id="btnOpenAbtActive">Active ABT</button>
          <button class="smallbtn" id="btnOpenAbtSoc">SOC Gaps</button>
        </div>
      </div>

      <div class="card" style="box-shadow:none">
        <div class="row" style="justify-content:space-between; align-items:flex-start">
          <div>
            <div class="mini muted">Vaccines</div>
            <div style="font-weight:900; font-size:16px; margin-top:2px">Pending Due</div>
          </div>
          <span class="badge blue" id="sbVaxPendingToday">—</span>
        </div>
        <div class="sep"></div>
        <div id="sbVaxPendingChips" class="row" style="gap:6px; flex-wrap:wrap"></div>
        <div class="sep"></div>
        <div class="row noprint" style="justify-content:flex-end; gap:8px">
          <button class="smallbtn" id="btnOpenVaxToday">Due Today</button>
          <button class="smallbtn" id="btnOpenVaxWeek">Due Week</button>
        </div>
      </div>

      <div class="card" style="box-shadow:none">
        <div class="row" style="justify-content:space-between; align-items:flex-start">
          <div>
            <div class="mini muted">Vaccines</div>
            <div style="font-weight:900; font-size:16px; margin-top:2px">This Week</div>
          </div>
          <span class="badge green" id="sbVaxGivenWeek">—</span>
        </div>
        <div class="sep"></div>
        <div id="sbVaxWeekChips" class="row" style="gap:6px; flex-wrap:wrap"></div>
        <div class="sep"></div>
        <div class="row noprint" style="justify-content:flex-end; gap:8px">
          <button class="smallbtn" id="btnOpenVaxWeeklyPrint">Weekly Print</button>
          <button class="smallbtn" id="btnOpenVaxAdd">Add Vax</button>
        </div>
      </div>
    </div>

<div class="row" style="justify-content:space-between; align-items:flex-end">
      <div>
        <h3>Key Alerts</h3>
        <div id="sbAuditChips" class="row" style="gap:6px; flex-wrap:wrap; margin-top:6px"></div>
        <div class="muted mini">Auto-detected signals based on simple thresholds (editable later).</div>
      </div>
      <div class="row edit-only" style="gap:8px">
        <button class="smallbtn" id="btnRefreshAlerts">Refresh</button>
      </div>
    </div>
    <div class="sep"></div>
    <div id="sbAlerts" style="display:grid; gap:10px">
</section>
  </div>
</div>

<section id="tab-surveillance" class="tabpane" style="display:none">
  <div class="card">
    <div class="row" style="justify-content:space-between; align-items:flex-start">
      <div>
        <h2>Surveillance Dashboard</h2>
        <div class="muted mini">Trend + early warning (7/14/28 days) by syndrome and unit. Click triggers to drill down.</div>
      </div>
      <div class="row noprint" style="gap:10px; flex-wrap:wrap; align-items:flex-end">
        <div>
          <label style="margin-bottom:6px">Unit</label>
          <select id="svUnit" class="smallsel"></select>
        </div>
        <div>
          <label style="margin-bottom:6px">Window</label>
          <select id="svWindow" class="smallsel">
            <option value="7">7 days</option>
            <option value="14">14 days</option>
            <option value="28">28 days</option>
          </select>
        </div>
        <button class="smallbtn" id="btnSvRefresh">Refresh</button>
      </div>
    </div>

    <div class="sep"></div>

    <div class="grid cols3">
      <div class="card" style="box-shadow:none">
        <div class="row" style="justify-content:space-between; align-items:flex-start">
          <div>
            <div class="mini muted">Trends</div>
            <div style="font-weight:900; font-size:16px; margin-top:2px">New cases (daily)</div>
          </div>
          <span class="badge" id="svCasesTotal">—</span>
        </div>
        <div class="sep"></div>
        <div id="svTrendTableWrap" style="overflow:auto; border:1px solid var(--line); border-radius:14px"></div>
      </div>

      <div class="card" style="box-shadow:none">
        <div class="row" style="justify-content:space-between; align-items:flex-start">
          <div>
            <div class="mini muted">Signals</div>
            <div style="font-weight:900; font-size:16px; margin-top:2px">Threshold triggers</div>
          </div>
          <span class="badge red" id="svTriggersCount">—</span>
        </div>
        <div class="sep"></div>
        <div id="svTriggers" style="display:grid; gap:10px"></div>
      </div>

      <div class="card" style="box-shadow:none">
        <div class="row" style="justify-content:space-between; align-items:flex-start">
          <div>
            <div class="mini muted">ABT</div>
            <div style="font-weight:900; font-size:16px; margin-top:2px">Antibiotic starts (daily)</div>
          </div>
          <span class="badge green" id="svAbtTotal">—</span>
        </div>
        <div class="sep"></div>
        <div id="svAbtTableWrap" style="overflow:auto; border:1px solid var(--line); border-radius:14px"></div>
      </div>
    </div>
  </div>
</section>

<section id="tab-floormap" class="tabpane tab" style="display:none">
  <div class="card">
    <div class="row" style="justify-content:space-between; align-items:flex-start; gap:10px">
      <div>
        <h2>Floor Map</h2>
        <div class="muted mini">Per-unit room grid (occupied/empty) with quick risk markers: precautions, active line-list cases, active antibiotics.</div>
      </div>
      <div class="row noprint edit-only" style="gap:8px; flex-wrap:wrap">
        <button class="btn" id="btnFmConfig">Configure Rooms</button>
        <button class="smallbtn" id="btnFmPrint">Print Floor Map</button>
      </div>
    </div>

    <div class="sep"></div>

    <div class="row noprint" style="gap:10px; flex-wrap:wrap; align-items:flex-end">
      <div>
        <label style="margin-bottom:6px">Unit</label>
        <select id="fmUnit" class="smallsel"></select>
      </div>
      <div class="row" style="gap:8px; align-items:center">
        <label class="chip" style="cursor:pointer"><input type="checkbox" id="fmShowEmpty" checked/> <span>Show empty rooms</span></label>
        <label class="chip" style="cursor:pointer"><input type="checkbox" id="fmShowDischarged"/> <span>Show discharged (locked rooms)</span></label>
      </div>
      <div class="muted mini" id="fmLegend"></div>
    </div>

    <div class="sep"></div>

    <div id="fmGrid" class="fmgrid"></div>
  </div>
</section>

<section id="tab-comms" class="tabpane" style="display:none">
  <div class="card">
    <div class="row" style="justify-content:space-between; align-items:flex-start">
      <div>
        <h2>Communications Center</h2>
        <div class="muted mini">Document what was said, to whom, and when (provider, family, staff huddles, reporting).</div>
      </div>
      <div class="row noprint edit-only" style="gap:8px; flex-wrap:wrap">
        <button class="btn primary" id="btnNewComm">New Communication</button>
        <button class="smallbtn" id="btnCommPrint">Print</button>
        <button class="smallbtn" id="btnCommCSV">Export CSV</button>
      </div>
    </div>

    <div class="sep"></div>

    <div class="row noprint" style="gap:10px; flex-wrap:wrap; align-items:flex-end">
      <div>
        <label style="margin-bottom:6px">Unit</label>
        <select id="commUnit" class="smallsel"></select>
      </div>
      <div>
        <label style="margin-bottom:6px">Category</label>
        <select id="commCat" class="smallsel">
          <option value="ALL">All</option>
          <option value="Provider">Provider</option>
          <option value="Family">Family/Responsible Party</option>
          <option value="Resident">Resident Education</option>
          <option value="Staff">Staff Huddle/Update</option>
          <option value="External">External Reporting</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div>
        <label style="margin-bottom:6px">From</label>
        <input id="commFrom" type="date"/>
      </div>
      <div>
        <label style="margin-bottom:6px">To</label>
        <input id="commTo" type="date"/>
      </div>
      <button class="smallbtn" id="btnCommFilter">Apply</button>
      <button class="smallbtn" id="btnCommClear">Clear</button>
    </div>

    <div class="sep"></div>
    <div id="commSummary" class="row" style="gap:8px; flex-wrap:wrap"></div>
    <div class="sep"></div>

    <div style="overflow:auto; border:1px solid var(--line); border-radius:14px">
      <table id="commTable">
        <thead>
          <tr>
            <th style="width:120px">Date</th>
            <th style="width:90px">Time</th>
            <th style="width:140px">Category</th>
            <th style="width:120px">Unit</th>
            <th style="width:230px">To/Who</th>
            <th style="width:140px">Method</th>
            <th>Summary</th>
            <th style="width:160px" class="noprint edit-only">Actions</th>
          </tr>
        </thead>
        <tbody id="commTbody"></tbody>
      </table>
    </div>
  </div>
</section>

<section id="tab-decisions" class="tabpane" style="display:none">
  <div class="card">
    <div class="row" style="justify-content:space-between; align-items:flex-start">
      <div>
        <h2>Action Plan + Decision Log</h2>
        <div class="muted mini">Track priorities, action items, decisions + rationale, and stop rules.</div>
      </div>
      <div class="row noprint edit-only" style="gap:8px; flex-wrap:wrap">
        <button class="btn primary" id="btnNewAction">New Action Item</button>
        <button class="btn" id="btnNewDecision">New Decision</button>
        <button class="smallbtn" id="btnDecPrint">Print</button>
        <button class="smallbtn" id="btnDecCSV">Export CSV</button>
      </div>
    </div>

    <div class="sep"></div>

    <div class="grid cols3">
      <div class="card" style="box-shadow:none">
        <div class="row" style="justify-content:space-between; align-items:flex-start">
          <div>
            <div class="mini muted">Today</div>
            <div style="font-weight:900; font-size:16px; margin-top:2px">Open Actions</div>
          </div>
          <span class="badge red" id="actOpenCount">—</span>
        </div>
        <div class="sep"></div>
        <div id="actQuick" class="muted mini">—</div>
      </div>

      <div class="card" style="box-shadow:none">
        <div class="row" style="justify-content:space-between; align-items:flex-start">
          <div>
            <div class="mini muted">Stop Rules</div>
            <div style="font-weight:900; font-size:16px; margin-top:2px">Criteria</div>
          </div>
          <span class="badge" id="stopCount">—</span>
        </div>
        <div class="sep"></div>
        <div id="stopQuick" class="muted mini">—</div>
      </div>

      <div class="card" style="box-shadow:none">
        <div class="row" style="justify-content:space-between; align-items:flex-start">
          <div>
            <div class="mini muted">Decisions</div>
            <div style="font-weight:900; font-size:16px; margin-top:2px">Logged</div>
          </div>
          <span class="badge" id="decCount">—</span>
        </div>
        <div class="sep"></div>
        <div id="decQuick" class="muted mini">—</div>
      </div>
    </div>

    <div class="sep"></div>

    <h3>Action Items</h3>
    <div class="muted mini">Owner + due date + status. Keep it survey-ready.</div>
    <div class="sep"></div>
    <div style="overflow:auto; border:1px solid var(--line); border-radius:14px">
      <table>
        <thead>
          <tr>
            <th style="width:120px">Date</th>
            <th style="width:110px">Due</th>
            <th style="width:100px">Status</th>
            <th style="width:140px">Owner</th>
            <th style="width:120px">Unit</th>
            <th>Action Item</th>
            <th style="width:160px" class="noprint edit-only">Actions</th>
          </tr>
        </thead>
        <tbody id="actTbody"></tbody>
      </table>
    </div>

    <div class="sep"></div>

    <h3>Decision Log</h3>
    <div class="muted mini">Decision + rationale (the “why”).</div>
    <div class="sep"></div>
    <div style="overflow:auto; border:1px solid var(--line); border-radius:14px">
      <table>
        <thead>
          <tr>
            <th style="width:120px">Date</th>
            <th style="width:120px">Unit</th>
            <th style="width:220px">Decision</th>
            <th>Rationale</th>
            <th style="width:160px" class="noprint edit-only">Actions</th>
          </tr>
        </thead>
        <tbody id="decTbody"></tbody>
      </table>
    </div>

    <div class="sep"></div>

    <h3>Stop Rules</h3>
    <div class="muted mini">What must be true to declare the outbreak controlled/over.</div>
    <div class="sep"></div>
    <div class="row noprint edit-only" style="justify-content:flex-end">
      <button class="smallbtn" id="btnAddStop">Add Stop Rule</button>
    </div>
    <div class="sep"></div>
    <div id="stopList" style="display:grid; gap:10px"></div>
  </div>
</section>

<section id="tab-audits" class="tabpane" style="display:none">
  <div class="card">
    <div class="row" style="justify-content:space-between; align-items:flex-start">
      <div>
        <h2>Audit Hub</h2>
        <div class="muted mini">Proof you’re doing the work: hand hygiene, PPE, isolation/EBP, and cleaning observations.</div>
      </div>
      <div class="row noprint edit-only" style="gap:8px; flex-wrap:wrap">
        <button class="btn primary" id="btnNewAudit">New Audit</button>
        <button class="btn" id="btnAuditRound">Start Round</button>
        <button class="smallbtn" id="btnAuditBlank">Print Blank Round Sheet</button>
        <button class="smallbtn" id="btnAuditPrint">Print</button>
        <button class="smallbtn" id="btnAuditCSV">Export CSV</button>
      </div>
    </div>

    <div class="sep"></div>

    <div class="row noprint" style="gap:10px; flex-wrap:wrap; align-items:flex-end">
      <div>
        <label style="margin-bottom:6px">Unit</label>
        <select id="auUnit" class="smallsel"></select>
      </div>
      <div>
        <label style="margin-bottom:6px">Type</label>
        <select id="auType" class="smallsel">
          <option value="ALL">All</option>
          <option value="Hand Hygiene">Hand Hygiene</option>
          <option value="PPE">PPE</option>
          <option value="Isolation/Precautions">Isolation/Precautions</option>
          <option value="EBP">EBP</option>
          <option value="Cleaning">Cleaning</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div>
        <label style="margin-bottom:6px">From</label>
        <input id="auFrom" type="date"/>
      </div>
      <div>
        <label style="margin-bottom:6px">To</label>
        <input id="auTo" type="date"/>
      </div>
      <div>
        <label style="margin-bottom:6px">Follow-up</label>
        <select id="auFollow" class="smallsel">
          <option value="ALL">All</option>
          <option value="OPEN">Open follow-up</option>
          <option value="DONE">Follow-up done</option>
          <option value="NA">No follow-up</option>
        </select>
      </div>
      <button class="smallbtn" id="btnAuApply">Apply</button>
      <button class="smallbtn" id="btnAuClear">Clear</button>
    </div>

    <div class="sep"></div>
    <div id="auSummary" class="row" style="gap:8px; flex-wrap:wrap"></div>
    <div class="sep"></div>

    <div class="row noprint edit-only" style="gap:8px; flex-wrap:wrap; justify-content:flex-end">
      <button class="smallbtn" id="btnAuSelectAll">Select All (Filtered)</button>
      <button class="smallbtn" id="btnAuClearSel">Clear Selection</button>
      <button class="btn" id="btnAuCreateAction">Create Action from Selected</button>
      <button class="btn" id="btnAuMarkDone">Mark Follow-up Done</button>
    </div>
    <div class="sep"></div>

    <div style="overflow:auto; border:1px solid var(--line); border-radius:14px">
      <table>
        <thead>
          <tr>
            <th style="width:40px" class="noprint edit-only"></th>
            <th style="width:120px">Date</th>
            <th style="width:90px">Time</th>
            <th style="width:140px">Type</th>
            <th style="width:120px">Unit</th>
            <th style="width:200px">Area/Location</th>
            <th style="width:140px">Observed By</th>
            <th style="width:110px">Compliant?</th>
            <th style="width:120px">Follow-up</th>
            <th>Notes</th>
            <th style="width:160px" class="noprint edit-only">Actions</th>
          </tr>
        </thead>
        <tbody id="auTbody"></tbody>
      </table>
    </div>
  </div>
</section>

<section id="tab-staff" class="tabpane" style="display:none">
  <div class="card">
    <div class="row" style="justify-content:space-between; align-items:flex-start">
      <div>
        <h2>Staffing & Exposure Tracker</h2>
        <div class="muted mini">Track staff illness/exposures, testing status, and return-to-work documentation (survey-ready evidence trail).</div>
      </div>
      <div class="row noprint edit-only" style="gap:8px; flex-wrap:wrap">
        <button class="btn primary" id="btnNewStaffIll">New Staff Entry</button>
        <button class="smallbtn" id="btnStaffPrint">Print</button>
        <button class="smallbtn" id="btnStaffCSV">Export CSV</button>
      </div>
    </div>

    <div class="sep"></div>

    <div class="row noprint" style="gap:10px; flex-wrap:wrap; align-items:flex-end">
      <div>
        <label style="margin-bottom:6px">Unit</label>
        <select id="stUnit" class="smallsel"></select>
      </div>
      <div>
        <label style="margin-bottom:6px">Status</label>
        <select id="stStatus" class="smallsel">
          <option value="ALL">All</option>
          <option value="Symptomatic">Symptomatic</option>
          <option value="Test Pending">Test Pending</option>
          <option value="Positive">Positive</option>
          <option value="Recovered">Recovered</option>
          <option value="Cleared/RTW">Cleared/RTW</option>
        </select>
      </div>
      <div>
        <label style="margin-bottom:6px">From</label>
        <input id="stFrom" type="date"/>
      </div>
      <div>
        <label style="margin-bottom:6px">To</label>
        <input id="stTo" type="date"/>
      </div>
      <button class="smallbtn" id="btnStApply">Apply</button>
      <button class="smallbtn" id="btnStClear">Clear</button>
    </div>

    <div class="sep"></div>
    <div id="stSummary" class="row" style="gap:8px; flex-wrap:wrap"></div>
    <div class="sep"></div>

    <div style="overflow:auto; border:1px solid var(--line); border-radius:14px">
      <table>
        <thead>
          <tr>
            <th style="width:120px">Onset</th>
            <th style="width:160px">Staff Name</th>
            <th style="width:140px">Role</th>
            <th style="width:120px">Unit</th>
            <th style="width:120px">Last Worked</th>
            <th style="width:120px">Test Date</th>
            <th style="width:140px">Result</th>
            <th style="width:120px">RTW Date</th>
            <th>Notes</th>
            <th style="width:160px" class="noprint edit-only">Actions</th>
          </tr>
        </thead>
        <tbody id="stTbody"></tbody>
      </table>
    </div>
  </div>
</section>

<section id="tab-env" class="tabpane" style="display:none">
  <div class="card">
    <div class="row" style="justify-content:space-between; align-items:flex-start">
      <div>
        <h2>Environmental & Equipment Controls</h2>
        <div class="muted mini">Enhanced cleaning periods, shared equipment cleaning, and PPE supply par levels (survey-ready evidence).</div>
      </div>
      <div class="row noprint edit-only" style="gap:8px; flex-wrap:wrap">
        <button class="btn primary" id="btnNewCleanEvent">New Cleaning Event</button>
        <button class="btn" id="btnNewEquipLog">Log Equipment Cleaning</button>
        <button class="smallbtn" id="btnEnvPrint">Print</button>
        <button class="smallbtn" id="btnEnvCSV">Export CSV</button>
      </div>
    </div>

    <div class="sep"></div>

    <div class="grid cols3">
      <div class="card" style="box-shadow:none">
        <div class="mini muted">PPE Supply (Par Levels)</div>
        <div class="muted mini" style="margin-top:6px">Track supply status for quick survey response; use “Update” to set on-hand and par levels.</div>
        <div class="sep"></div>
        <div id="ppeChips" class="row" style="gap:6px; flex-wrap:wrap"></div>
        <div class="sep"></div>
        <div class="row end noprint edit-only" style="gap:8px">
          <button class="smallbtn" id="btnPpeUpdate">Update Supplies</button>
        </div>
      </div>

      <div class="card" style="box-shadow:none">
        <div class="mini muted">Enhanced Cleaning</div>
        <div class="muted mini" style="margin-top:6px">Active and recent enhanced cleaning periods (by unit/area).</div>
        <div class="sep"></div>
        <div id="cleanSummary" class="row" style="gap:6px; flex-wrap:wrap"></div>
        <div class="sep"></div>
        <div class="row end noprint edit-only" style="gap:8px">
          <button class="smallbtn" id="btnCleanActive">View Active</button>
        </div>
      </div>

      <div class="card" style="box-shadow:none">
        <div class="mini muted">Shared Equipment</div>
        <div class="muted mini" style="margin-top:6px">High-use shared items (vitals machines, glucometers, lifts). Track last clean and next due.</div>
        <div class="sep"></div>
        <div id="equipSummary" class="row" style="gap:6px; flex-wrap:wrap"></div>
        <div class="sep"></div>
        <div class="row end noprint edit-only" style="gap:8px">
          <button class="smallbtn" id="btnEquipOverdue">View Overdue</button>
        </div>
      </div>
    </div>

    <div class="sep"></div>

    <div class="row noprint" style="gap:10px; flex-wrap:wrap; align-items:flex-end">
      <div>
        <label style="margin-bottom:6px">Unit</label>
        <select id="envUnit" class="smallsel"></select>
      </div>
      <div>
        <label style="margin-bottom:6px">From</label>
        <input id="envFrom" type="date"/>
      </div>
      <div>
        <label style="margin-bottom:6px">To</label>
        <input id="envTo" type="date"/>
      </div>
      <button class="smallbtn" id="btnEnvApply">Apply</button>
      <button class="smallbtn" id="btnEnvClear">Clear</button>
    </div>

    <div class="sep"></div>

    <h3>Enhanced Cleaning Events</h3>
    <div style="overflow:auto; border:1px solid var(--line); border-radius:14px">
      <table>
        <thead><tr>
          <th style="width:110px">Start</th>
          <th style="width:110px">End</th>
          <th style="width:120px">Unit</th>
          <th style="width:200px">Area</th>
          <th style="width:160px">Reason</th>
          <th style="width:120px">Status</th>
          <th>Notes</th>
          <th style="width:160px" class="noprint edit-only">Actions</th>
        </tr></thead>
        <tbody id="cleanTbody"></tbody>
      </table>
    </div>

    <div class="sep"></div>

    <h3>Equipment Cleaning Log</h3>
    <div style="overflow:auto; border:1px solid var(--line); border-radius:14px">
      <table>
        <thead><tr>
          <th style="width:140px">Equipment</th>
          <th style="width:120px">Unit</th>
          <th style="width:200px">Location</th>
          <th style="width:110px">Last Clean</th>
          <th style="width:110px">Next Due</th>
          <th style="width:140px">Cleaned By</th>
          <th style="width:120px">Status</th>
          <th>Notes</th>
          <th style="width:160px" class="noprint edit-only">Actions</th>
        </tr></thead>
        <tbody id="equipTbody"></tbody>
      </table>
    </div>

  </div>
</section>

<section id="tab-reports" class="tabpane" style="display:none">
  <div class="card">
    <div class="row" style="justify-content:space-between; align-items:flex-start">
      <div>
        <h2>Report Center</h2>
        <div class="muted mini">One-click outputs for unit distribution, leadership updates, survey packets, and QAPI summaries.</div>
      </div>
      <div class="row noprint" style="gap:10px; flex-wrap:wrap; align-items:flex-end">
        <div>
          <label style="margin-bottom:6px">Unit</label>
          <select id="rpUnit" class="smallsel"></select>
        </div>
        <div>
          <label style="margin-bottom:6px">From</label>
          <input id="rpFrom" type="date"/>
        </div>
        <div>
          <label style="margin-bottom:6px">To</label>
          <input id="rpTo" type="date"/>
        </div>
        <div>
          <label style="margin-bottom:6px">Syndrome</label>
          <select id="rpSyndrome" class="smallsel">
            <option value="resp">Respiratory</option>
            <option value="gi">GI</option>
          </select>
        </div>
        <button class="smallbtn" id="btnRpApply">Apply</button>
        <button class="smallbtn" id="btnRpClear">Clear</button>
        <button class="smallbtn" id="btnRpHelp">Report Walkthrough</button>
      </div>
    </div>

    <div class="sep"></div>

    <div class="grid cols3">
      <div class="card" style="box-shadow:none">
        <div class="mini muted">Unit Distribution</div>
        <div style="font-weight:900; font-size:16px; margin-top:4px">Daily Precaution List</div>
        <div class="muted mini" style="margin-top:6px">Print your exact unit sheet for active precautions/isolation.</div>
        <div class="sep"></div>
        <button class="btn primary" id="btnRpPrecList">Print Unit Precaution Listing</button>
      </div>

      <div class="card" style="box-shadow:none">
        <div class="mini muted">Line Listing</div>
        <div style="font-weight:900; font-size:16px; margin-top:4px">Respiratory + GI Templates</div>
        <div class="muted mini" style="margin-top:6px">Print ILI and Acute Gastroenteritis line lists.</div>
        <div class="sep"></div>
        <div class="row" style="gap:8px; flex-wrap:wrap">
          <button class="btn" id="btnRpILI">Print ILI Template</button>
          <button class="btn" id="btnRpGI">Print GI Template</button>
        </div>
      </div>

      <div class="card" style="box-shadow:none">
        <div class="mini muted">Leadership</div>
        <div style="font-weight:900; font-size:16px; margin-top:4px">Outbreak Status Update</div>
        <div class="muted mini" style="margin-top:6px">A clean, survey-ready snapshot: status, counts, key signals, actions, and comms.</div>
        <div class="sep"></div>
        <button class="btn" id="btnRpLeadership">Print Leadership Update</button>
      </div>

      <div class="card" style="box-shadow:none">
        <div class="mini muted">Outbreak</div>
        <div style="font-weight:900; font-size:16px; margin-top:4px">Outbreak Packet</div>
        <div class="muted mini" style="margin-top:6px">Print case roster + exposure events + linked roster (uses filters above).</div>
        <div class="sep"></div>
        <button class="btn" id="btnRpOutbreakPacket">Print Outbreak Packet</button>
        <button class="btn" id="btnRpCaseCSV">Export Case Roster CSV</button>
      </div>
    </div>

    <div class="sep"></div>

    <div class="grid cols3">
      <div class="card" style="box-shadow:none">
        <div class="mini muted">Survey Readiness</div>
        <div style="font-weight:900; font-size:16px; margin-top:4px">Surveyor Packet Bundle</div>
        <div class="muted mini" style="margin-top:6px">Print a bundled packet: precautions, line lists, testing tracker, comms, decisions.</div>
        <div class="sep"></div>
        <button class="btn" id="btnRpSurveyor">Build & Print Packet</button>
      </div>

      <div class="card" style="box-shadow:none">
        <div class="mini muted">QAPI</div>
        <div style="font-weight:900; font-size:16px; margin-top:4px">Weekly Summary</div>
        <div class="muted mini" style="margin-top:6px">Trends + triggers + gaps + corrective actions (ready for QAPI minutes).</div>
        <div class="sep"></div>
        <button class="btn" id="btnRpQapi">Print QAPI Summary</button>
      </div>

      <div class="card" style="box-shadow:none">
        <div class="mini muted">Exports</div>
        <div style="font-weight:900; font-size:16px; margin-top:4px">CSV Bundle</div>
        <div class="muted mini" style="margin-top:6px">Export filtered logs: communications + actions/decisions + testing list.</div>
        <div class="sep"></div>
        <button class="btn" id="btnRpCSVBundle">Export CSV Bundle</button>
        <button class="btn" id="btnRpAudits">Print Audit Hub</button>
        <button class="btn" id="btnRpStaff">Print Staff Illness Log</button>
        <button class="btn" id="btnRpEnv">Print Environment Controls</button>
      </div>

    <div class="grid cols3">
      <div class="card" style="box-shadow:none">
        <div class="mini muted">ABT Reports</div>
        <div style="font-weight:900; font-size:16px; margin-top:4px">Active Antibiotics + SOC Gaps</div>
        <div class="muted mini" style="margin-top:6px">Print the active antibiotic list, or the stewardship “SOC gaps” list (missing indication/source/stop date, etc.).</div>
        <div class="sep"></div>
        <div class="row" style="gap:8px; flex-wrap:wrap">
          <button class="btn" id="btnRpAbtActive">Print Active ABT</button>
          <button class="btn" id="btnRpAbtSoc">Print ABT SOC Gaps</button>
          <button class="btn" id="btnRpAbtCsv">Export ABT CSV</button>
        </div>
      </div>

      <div class="card" style="box-shadow:none">
        <div class="mini muted">Vaccination Outputs</div>
        <div style="font-weight:900; font-size:16px; margin-top:4px">Weekly + Due Lists</div>
        <div class="muted mini" style="margin-top:6px">Use the same report-center behaviors (weekly vaccinated/declined/pending; due today/this week; snapshot/matrix).</div>
        <div class="sep"></div>
        <div class="row" style="gap:8px; flex-wrap:wrap">
          <button class="btn" id="btnRpVaxWeekly">Print Weekly List</button>
          <button class="btn" id="btnRpVaxDueToday">Print Due Today</button>
          <button class="btn" id="btnRpVaxDueWeek">Print Due This Week</button>
          <button class="btn" id="btnRpVaxMatrix">Print Monthly Matrix</button>
          <button class="btn" id="btnRpVaxCsv">Export Vax CSV</button>
        </div>
      </div>

      <div class="card" style="box-shadow:none">
        <div class="mini muted">Standard of Care (SOC)</div>
        <div style="font-weight:900; font-size:16px; margin-top:4px">Value-only SOC (No Duplicates)</div>
        <div class="muted mini" style="margin-top:6px">This tool only adds SOC reports that create new value (gaps / risk lists), not duplicates of existing outputs.</div>
        <div class="sep"></div>
        <div class="row" style="gap:8px; flex-wrap:wrap">
          <button class="btn" id="btnRpSocSummary">Print SOC Summary</button>
        </div>
        <div class="muted mini" style="margin-top:8px">Currently focuses on Antibiotic Stewardship documentation gaps; more SOC packs can be added only if needed.</div>
      </div>
    </div>

</div>

    <div class="sep"></div>
    <div class="muted mini" id="rpHint">Tip: set Unit + date range above; reports respect those filters where relevant.</div>
  </div>

  <div class="card" style="margin-top:14px">
    <div class="row" style="justify-content:space-between; align-items:center">
      <div>
        <div style="font-weight:900">QAPI Effectiveness Summary</div>
        <div class="muted" style="margin-top:2px">Snapshot of follow-up verification and outcomes.</div>
      </div>
      <div class="row" style="gap:8px; flex-wrap:wrap">
        <button class="btn" onclick="renderQapiEffectivenessReport()">Refresh</button>
        <button class="btn primary" onclick="exportQapiEffectivenessCsv()">Export CSV</button>
      </div>
    </div>
    <div class="grid" style="grid-template-columns: repeat(3, minmax(0,1fr)); gap:10px; margin-top:10px">
      <div class="field"><label class="mini muted">From</label><input id="qapiEffFrom" type="date"></div>
      <div class="field"><label class="mini muted">To</label><input id="qapiEffTo" type="date"></div>
      <div class="field"><label class="mini muted">Include</label>
        <select id="qapiEffInclude">
          <option value="all">All actions</option>
          <option value="closed">Closed only</option>
          <option value="open">Open only</option>
        </select>
      </div>
    </div>
    <div id="qapiEffSummary" style="margin-top:10px"></div>
    <div class="tableWrap" style="margin-top:10px">
      <table class="table" id="qapiEffTable">
        <thead>
          <tr>
            <th>Date</th><th>Title</th><th>Unit</th><th>Resident</th><th>Status</th>
            <th>Follow-up Due</th><th>Verified Date</th><th>Outcome</th><th>Method</th>
          </tr>
        </thead>
        <tbody id="qapiEffTbody"></tbody>
      </table>
    </div>
  </div>

</section>


<section id="tab-packet" class="tabpane" style="display:none">
  <div class="card">
    <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap">
      <div>
        <h2 style="margin:0">Survey Packet Exports</h2>
        <div class="muted">One-click packet pages for surveyors (Line Listing, Contact Tracing, Precautions, Signage).</div>
      </div>
      <div class="row" style="gap:8px; flex-wrap:wrap">
        <select id="pktPreset" class="input" style="min-width:220px" onchange="packetApplyPreset()">
          <option value="">Packet Presets (NY/CMS)</option>
          <option value="survey_day">Survey Day Core (Line List + CT + Precautions)</option>
          <option value="outbreak_only">Outbreak Only (Line List + CT)</option>
          <option value="precautions_only">Precautions Only (Active List + Signage)</option>
          <option value="full">Full Packet (All)</option>
        </select>
        <button class="btn" onclick="packetSaveRun()">Save Run</button>
        <button class="btn" onclick="packetShowSavedRuns()">Saved Runs</button>
        <button class="btn" onclick="packetShowAuditLog()">Audit Log</button>
        <button class="btn" onclick="packetBackupExport()">Packet Backup</button>
        <button class="btn" onclick="packetBackupImport()">Restore Backup</button>
        <button class="btn" onclick="packetChecklist()">Checklist Page</button>
        <button class="btn" onclick="packetExport('outbreak')">Outbreak Packet Page</button>
        <button class="btn" onclick="packetExport('precautions')">Daily Active Precautions</button>
        <button class="btn" onclick="packetExport('signage')">Isolation Signage Set</button>
        <button class="btn primary" onclick="packetExport('full')">Full Packet (All)</button>
        <button class="btn" onclick="qapiSnapshot()">QAPI Snapshot</button>
      </div>
    </div>

    <div class="sep"></div>

    <div class="grid cols2" style="gap:12px">
      <div class="card" style="box-shadow:none; border:1px solid rgba(0,0,0,.08)">
        <h3 style="margin:0 0 8px">Packet Settings</h3>
        <div class="grid cols2" style="gap:10px">
          <div>
            <label>Date Range Start</label>
            <input id="pktFrom" type="date"/>
          </div>
          <div>
            <label>Date Range End</label>
            <input id="pktTo" type="date"/>
          </div>
          <div>
            <label>Unit Filter</label>
            <select id="pktUnit">
              <option value="ALL">Facility-wide (All Units)</option>
            </select>
            <div class="muted mini">Uses the same unit filter logic surveyors request (unit rollups vs facility rollups).</div>
          </div>
          <div>
            <label>Include Identifiers</label>
            <select id="pktIds">
              <option value="yes">Yes (for internal use)</option>
              <option value="no">No (de-identified)</option>
            </select>
          </div>
        </div>
        <div class="sep"></div>
        <div class="muted">
          // Tip: “Full Packet” generates a single printable document. Use browser print → “Save to PDF”.
        </div>
      </div>

      <div class="card" style="box-shadow:none; border:1px solid rgba(0,0,0,.08)">
        <h3 style="margin:0 0 8px">Preview</h3>
        <div class="muted">This page exports directly to a print window (no data is sent anywhere).</div>
        <div class="sep"></div>
        <div id="pktPreview" class="muted">Select an export type above.</div>
      </div>
    </div>
  </div>
</section>

<section id="tab-actions" class="tabpane" style="display:none">
  <div class="card">
    <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap">
      <div>
        <h2 style="margin:0">QAPI Action Center</h2>
        <div class="row" style="gap:8px; flex-wrap:wrap; margin-top:8px">
          <button class="btn" onclick="printActionsFollowUpReport()">Follow-up Due (30d)</button>
        </div>
        <div class="muted">Closed-loop improvement tracking: findings → action → education → follow-up.</div>
      </div>
      <div class="row" style="gap:8px; flex-wrap:wrap">
        <button class="btn" onclick="qapiRunAutoFlags(true)">Run Auto-Flag</button>
        <button class="btn" onclick="qapiNewActionModal()">New Action</button>
        <button class="btn" onclick="qapiExportActionsCSV()">Export CSV</button>
        <button class="btn primary" onclick="qapiPrintActions()">Print</button>
      </div>
    </div>

    <div class="sep"></div>

    <div class="grid cols2" style="gap:12px">
      <div class="card" style="box-shadow:none; border:1px solid rgba(0,0,0,.08)">
        <h3 style="margin:0 0 8px">Open Actions</h3>
        <div class="muted mini">Sorted by priority and due date.</div>
        <div class="sep"></div>
        <div id="qapiActionsOpen"></div>
      </div>
      <div class="card" style="box-shadow:none; border:1px solid rgba(0,0,0,.08)">
        <h3 style="margin:0 0 8px">Completed / Closed</h3>
        <div class="muted mini">Latest 30 items (local).</div>
        <div class="sep"></div>
        <div id="qapiActionsClosed"></div>
      </div>
    </div>

  </div>
</section>

  <section id="tab-census" class="tab" style="display:none">
    <div class="grid">
      <div class="card">
        <h2>Census Paste → Parse → Apply</h2>
        <div class="muted mini">Upserts residents. Updates room/unit ONLY for those present. Missing actives become discharged and lock last-known room/unit for history. DOB + Payor are captured (stored on resident) but not shown in the 4-column grid.</div>
        <div class="sep"></div>
        <label>Raw Census Text</label>
        <textarea id="censusRaw" placeholder="Paste census here..."></textarea>
        <div class="row end">
          <button class="btn" id="btnParseCensus">Parse</button>
          <button class="btn primary" id="btnApplyCensus" disabled>Apply Census</button>
        </div>
      </div>
      <div class="card">
        <h2>Parsed Preview</h2>
        <div class="muted mini">(Placed below the parser for better visibility.)</div>
        <div class="muted mini">MRN in parentheses becomes stable residentId (recommended).</div>
        <div class="sep"></div>
        <div id="censusPreview"></div>
      </div>
    </div>
  </section>

  <section id="tab-abt" class="tab" style="display:none">
    <div class="card">
      <h2>ABT (Imported + New Imports)</h2>
    <div class="row" style="gap:10px; flex-wrap:wrap; margin-top:10px">
      <div class="field" style="min-width:260px">
        <label class="mini muted">Search (Name/MRN/Room)</label>
        <input placeholder="Type to filter…" oninput="setFilter('abt', this.value)" />
      </div>
    </div>

      <div class="row end noprint" style="margin-top:-4px">
        <button class="btn primary" id="btnAbtImport">Import ABT Raw Text</button>
      </div>

      <div class="muted mini">Shows active antibiotics filtered by Unit.</div>
      <div class="sep"></div>
      <div id="abtActiveTable"></div>
      <div class="sep"></div>
      <div class="row noprint" style="justify-content:space-between">
        <label class="chip" style="gap:8px; cursor:pointer">
          <input id="toggleAbtShowHistory" type="checkbox" style="transform:scale(1.1)"/>
          <span>Show ABT History (not just active)</span>
        </label>
        <div class="muted mini">Import ABT raw text → editable preview → apply.</div>
      </div>
      <div class="sep"></div>
      <div id="abtAllTable"></div>
    </div>
  </section>

  <section id="tab-ip" class="tab" style="display:none">
  <div class="card">
    <div class="row" style="justify-content:space-between; align-items:flex-start">
      <div>
        <h2>Infection Prevention (IP)</h2>
    <div class="row" style="gap:10px; flex-wrap:wrap; margin-top:10px">
      <div class="field" style="min-width:260px">
        <label class="mini muted">Search (Name/MRN/Room)</label>
        <input placeholder="Type to filter…" oninput="setFilter('ip', this.value)" />
      </div>
    </div>

        <div class="muted mini">CDC-style line listing + contact tracing linkage. ABT “Line Listing” flags can auto-suggest cases into Respiratory/GI line lists.</div>
        <div class="muted mini" id="ipDiag"></div>
      </div>
      <div class="row noprint" style="gap:8px">
        <button class="btn" id="btnIpImportSuggestions">Import ABT Suggestions</button>
        <button class="btn" id="btnIpRepairNow" onclick="repairIpNow()">Repair IP Data</button>
        <button class="btn primary" id="btnIpNewCase">Add Line List Case</button>
      </div>
    </div>

    <div class="sep"></div>

    <div class="row" style="gap:10px; flex-wrap:wrap">
      <button class="tabbtn active" id="ipTab_resp" onclick="setIpView('resp')">Respiratory Line List</button>
      <button class="tabbtn" id="ipTab_gi" onclick="setIpView('gi')">GI Line List</button>
      <button class="tabbtn" id="ipTab_ct" onclick="setIpView('ct')">Contact Tracing</button>
      <button class="tabbtn" id="ipTab_tests" onclick="setIpView('tests')">Testing / Labs</button>
      <button class="tabbtn" id="ipTab_prec" onclick="setIpView('prec')">Active Precautions</button>
      <button class="tabbtn" id="ipTab_outbreak" onclick="setIpView('outbreak')">Outbreak (Case-first)</button>
    </div>

    <div class="sep"></div>

    <div id="ipView_resp"></div>
    <div id="ipView_gi" style="display:none"></div>
    <div id="ipView_ct" style="display:none"></div>
    <div id="ipView_tests" style="display:none"></div>
    <div id="ipView_prec" style="display:none"></div>
    <div id="ipView_outbreak" style="display:none"></div>
  </div>
</section>

  <section id="tab-vax" class="tab" style="display:none">
  <div class="card">
    <h2>Vaccination Report Center</h2>
    <div class="row" style="gap:10px; flex-wrap:wrap; margin-top:10px">
      <div class="field" style="min-width:260px">
        <label class="mini muted">Search (Name/MRN/Room)</label>
        <input placeholder="Type to filter…" oninput="setFilter('vax', this.value)" />
      </div>
    </div>

    <div class="muted mini">Weekly vaccinated/declined/pending + Due Today + Due This Week + Monthly Matrix + Active Snapshot. Unit filter applies.</div>
    <div class="sep"></div>

    <div class="row" id="vaxSubnav" style="gap:8px">
      <button class="tabbtn" data-vxt="matrix" id="vaxTab_matrix">Monthly Matrix</button>
      <button class="tabbtn" data-vxt="weekly" id="vaxTab_weekly">Weekly Resident List</button>
      <button class="tabbtn" data-vxt="dueToday" id="vaxTab_dueToday">Due Today</button>
      <button class="tabbtn" data-vxt="dueWeek" id="vaxTab_dueWeek">Due This Week</button>
      <button class="tabbtn" data-vxt="snapshot" id="vaxTab_snapshot">Active Snapshot</button>
    </div>

    <div class="sep"></div>

    <div id="vaxView_matrix" style="display:none">
      <h3>Monthly Vaccine Matrix</h3>
      <div class="muted mini">Resident-by-vaccine matrix using a date range. Shows most recent status on/before the end date.</div>
      <div class="sep"></div>
      <div class="grid cols3">
        <div><label>Start Date</label><input id="vxmFrom" type="date"/></div>
        <div><label>End Date</label><input id="vxmTo" type="date"/></div>
        <div><label>Census Status</label>
          <select id="vxmCensus"><option value="active">Active Only</option><option value="all">All Census Status</option></select>
        </div>
      </div>
      <div class="grid cols3" style="margin-top:10px">
        <div><label>Report Vaccine Status</label>
          <select id="vxmStatus">
            <option value="">All Statuses</option>
            <option value="vaccinated">Vaccinated (Complete/Historical)</option>
            <option value="declined">Declined</option>
            <option value="pending">Pending</option>
          </select>
        </div>
        <div><label>Vaccine Type</label><select id="vxmType"><option value="">All Types</option></select></div>
        <div><label>Vaccine Set</label>
          <select id="vxmSet"><option value="core">Core (COVID/Flu/Pneumo/RSV)</option><option value="all">All Types Found</option></select>
        </div>
      </div>
      <div class="row end" style="margin-top:10px">
        <button class="btn" id="btnVxmPreview">Preview</button>
        <button class="btn primary" id="btnVxmPrint">Print</button>
      </div>
      <div class="sep"></div>
      <div id="vxmOut" class="muted mini">Click <b>Preview</b> to generate.</div>
    </div>

    <div id="vaxView_weekly" style="display:none">
      <h3>Weekly Resident Vaccine List</h3>
      <div class="muted mini">Shows vaccine events in the selected week. Includes vaccinated/declined/pending.</div>
      <div class="sep"></div>
      <div class="grid cols3">
        <div><label>Date Within Week</label><input id="vxwAny" type="date"/></div>
        <div><label>Vaccine Type</label><select id="vxwType"><option value="">All Types</option></select></div>
        <div><label>Census Status</label>
          <select id="vxwCensus"><option value="active">Active Only</option><option value="all">All Census Status</option></select>
        </div>
      </div>
      <div class="row end" style="margin-top:10px">
        <button class="btn" id="btnVxwPreview">Preview</button>
        <button class="btn primary" id="btnVxwPrint">Print</button>
      </div>
      <div class="sep"></div>
      <div id="vxwOut" class="muted mini">Click <b>Preview</b> to generate.</div>
    </div>

    <div id="vaxView_dueToday" style="display:none">
      <h3>Due Today Reminder Sheet</h3>
      <div class="muted mini">Shows <b>Pending</b> vaccine events scheduled for the selected date.</div>
      <div class="sep"></div>
      <div class="grid cols3">
        <div><label>Date</label><input id="vxdToday" type="date"/></div>
        <div><label>Vaccine Type</label><select id="vxdTodayType"><option value="">All Types</option></select></div>
        <div><label>Census Status</label>
          <select id="vxdTodayCensus"><option value="active">Active Only</option><option value="all">All Census Status</option></select>
        </div>
      </div>
      <div class="row end" style="margin-top:10px">
        <button class="btn" id="btnVxdTodayPreview">Preview</button>
        <button class="btn primary" id="btnVxdTodayPrint">Print</button>
      </div>
      <div class="sep"></div>
      <div id="vxdTodayOut" class="muted mini">Click <b>Preview</b> to generate.</div>
    </div>

    <div id="vaxView_dueWeek" style="display:none">
      <h3>Due This Week</h3>
      <div class="muted mini">Shows <b>Pending</b> vaccine events scheduled within the selected week (Monday–Sunday).</div>
      <div class="sep"></div>
      <div class="grid cols3">
        <div><label>Date Within Week</label><input id="vxdWeekAny" type="date"/></div>
        <div><label>Vaccine Type</label><select id="vxdWeekType"><option value="">All Types</option></select></div>
        <div><label>Census Status</label>
          <select id="vxdWeekCensus"><option value="active">Active Only</option><option value="all">All Census Status</option></select>
        </div>
      </div>
      <div class="row end" style="margin-top:10px">
        <button class="btn" id="btnVxdWeekPreview">Preview</button>
        <button class="btn primary" id="btnVxdWeekPrint">Print</button>
      </div>
      <div class="sep"></div>
      <div id="vxdWeekOut" class="muted mini">Click <b>Preview</b> to generate.</div>
    </div>

    <div id="vaxView_snapshot" style="display:none">
      <h3>Active Census Vaccinated Snapshot</h3>
      <div class="muted mini">Counts residents with Vaccinated/Complete/Historical for core vaccine types (or all types).</div>
      <div class="sep"></div>
      <div class="grid cols3">
        <div><label>As-of Date</label><input id="vxsAsOf" type="date"/></div>
        <div><label>Core types</label>
          <select id="vxsCore"><option value="core">COVID-19 / Pneumonia / Influenza / RSV</option><option value="all">All Types</option></select>
        </div>
        <div><label>Census Status</label>
          <select id="vxsCensus"><option value="active">Active Only</option><option value="all">All Census Status</option></select>
        </div>
      </div>
      <div class="row end" style="margin-top:10px">
        <button class="btn" id="btnVxsPreview">Preview</button>
        <button class="btn primary" id="btnVxsPrint">Print</button>
      </div>
      <div class="sep"></div>
      <div id="vxsOut" class="muted mini">Click <b>Preview</b> to generate.</div>
    </div>

    <div class="sep"></div>
    <h3>Vax Log</h3>
    <div class="muted mini">Raw vaccine events (audit log). Use the Report Center above for weekly/due/matrix/snapshot outputs.</div>
    <div class="sep"></div>
    <div id="vaxTable"></div>
  </div>
</section>

  <section id="tab-warehouse" class="tab" style="display:none">
    <div class="card">
      <h2>Data Warehouse (Long Logs)</h2>
      <div class="muted mini">Residents + ABT + IP precautions + Vax.</div>
      <div class="sep"></div>
      <div class="row noprint">
        <button class="btn" id="whResidentsBtn">Residents</button>
        <button class="btn" id="whAbtBtn">ABT Courses</button>
        <button class="btn" id="whPrecBtn">IP Precautions</button>
        <button class="btn" id="whVaxBtn">Vax Events</button>
      </div>
      <div class="sep"></div>
      <div id="warehouseView"></div>
    </div>
  </section>

  <section id="tab-config" class="tab" style="display:none">
    <div class="grid cols2">
      <div class="card">
        <h2>Facility Configuration</h2>
        <div class="muted mini">Set total building capacity and unit capacities. Dashboard occupancy auto-calcs from pasted census.</div>
        <div class="sep"></div>
        <div class="grid cols2">
          <div><label>Facility Name</label><input id="cfgFacilityName" type="text"/></div>
          <div><label>Total Licensed Capacity</label><input id="cfgTotalCap" type="number" min="0"/></div>
        </div>
        <div class="sep"></div>
        <h3>Units</h3>
        <div class="sep"></div>
        <div id="cfgUnitsTable"></div>
        <div class="row end">
          <button class="btn" id="btnAddUnit">Add Unit</button>
          <button class="btn primary" id="btnSaveConfig">Save Config</button>
        </div>
        <div class="sep"></div>
        <h3>Unit Aliases (optional)</h3>
        <textarea id="cfgAliases" placeholder="2 = U2&#10;UNIT 2 = U2"></textarea>
<div class="sep"></div>

<h3>Room Inventory</h3>
<div class="muted mini">Paste your full room-bed list (one per line, e.g. 251-A). This enables accurate empty-room drilldowns.</div>
<div class="sep"></div>
<label>Room Inventory (one per line)</label>
<textarea id="cfgRoomInventoryText" style="min-height:140px" placeholder="251-A
251-B
252-A
..."></textarea>



<div class="sep"></div>
<h3>QAPI / Compliance Thresholds</h3>
<div class="muted mini">Used by Surveillance triggers, the Compliance Dashboard, and the QAPI Weekly Summary report.</div>
<div class="sep"></div>

<div class="grid cols3">
  <div>
    <label>Resident Days (last 7 days)</label>
    <input id="cfgPatientDays7" type="number" min="0" placeholder="e.g., 980"/>
    <div class="muted mini">Used for rate calculations (per 1,000 resident days).</div>
  </div>
  <div>
    <label>Infection rate alert (per 1,000)</label>
    <input id="cfgInfectRate" type="number" min="0" step="0.1"/>
    <div class="muted mini">Above this = flagged in dashboard.</div>
  </div>
  <div>
    <label>ABT utilization alert (per 1,000)</label>
    <input id="cfgAbtRate" type="number" min="0" step="0.1"/>
    <div class="muted mini">Antibiotic starts rate threshold.</div>
  </div>
</div>

<div class="sep"></div>
<div class="grid cols3">
  <div>
    <label>GI trigger (72h)</label>
    <input id="cfgTrigGI" type="number" min="1"/>
    <div class="muted mini">GI cases within 72 hours (per unit).</div>
  </div>
  <div>
    <label>Respiratory trigger (72h)</label>
    <input id="cfgTrigResp" type="number" min="1"/>
    <div class="muted mini">Resp cases within 72 hours (per unit).</div>
  </div>
  <div>
    <label>ABT starts spike (per day)</label>
    <input id="cfgTrigAbtDay" type="number" min="1"/>
    <div class="muted mini">Starts today across the active view.</div>
  </div>
</div>

<div class="sep"></div>
<div class="grid cols3">
  <div>
    <label>Pending test backlog alert</label>
    <input id="cfgTrigPending" type="number" min="0"/>
  </div>
  <div>
    <label>Vax data completeness target (%)</label>
    <input id="cfgVaxTarget" type="number" min="0" max="100" step="1"/>
    <div class="muted mini">% of active residents with at least one vax entry recorded.</div>
  </div>
  <div>
    <label>Rate window (days)</label>
    <input id="cfgWindowDays" type="number" min="1" max="28"/>
    <div class="muted mini">Used by Compliance Dashboard rates.</div>
  </div>
</div>

<div class="sep"></div>

<h3>User Directory</h3>
<div class="muted mini">Add users and choose the Current User. Admin Notes + Contact Tracing will use the Current User as the author.</div>
<div class="sep"></div>

<div class="grid cols3">
  <div>
    <label>Current User</label>
    <select id="cfgCurrentUser"></select>
  </div>
  <div>
    <label>Add User (Name)</label>
    <input id="cfgNewUserName" type="text" placeholder="e.g., Juan Enguerra, RN"/>
  </div>
  <div>
    <label>Add User (Role)</label>
    <input id="cfgNewUserRole" type="text" placeholder="e.g., Admin / IP Nurse / RN Supervisor"/>
  </div>
</div>

<div class="row end" style="margin-top:10px; gap:8px">
  <button class="smallbtn" id="btnCfgAddUser">Add User</button>
  <button class="smallbtn danger" id="btnCfgRemoveUser">Remove Selected</button>
</div>

      </div>

      <div class="card">
        <h2>Administration</h2>
        <div class="muted mini">Role-based views, audit log, and encrypted backups.</div>
        <div class="sep"></div>

        <h3>Backup / Restore</h3>
        <div class="muted mini">Creates an encrypted JSON file you can move between devices. Requires your password to restore.</div>
        <div class="sep"></div>
        <div class="row edit-only" style="gap:8px; flex-wrap:wrap">
          <button class="btn primary admin-only" id="btnExportEncrypted">Export Encrypted Backup</button>
          <button class="btn admin-only" id="btnImportEncrypted">Import Encrypted Backup</button>
          <input type="file" id="fileImportEncrypted" accept=".json,.txt,.enc" style="display:none"/>
        </div>
        <div class="muted mini" id="backupStatus" style="margin-top:8px"></div>

        <div class="sep"></div>

        <h3>Audit Log</h3>
        <div class="muted mini">Tracks key actions with timestamp + user + role. (Latest 500)</div>
        <div class="sep"></div>
        <div class="row end edit-only" style="gap:8px">
          <button class="smallbtn admin-only" id="btnExportAudit">Export Audit Log</button>
          <button class="smallbtn danger admin-only" id="btnClearAudit">Clear Log</button>
        </div>
        <div class="sep"></div>
        <div id="auditTableWrap" style="max-height:340px; overflow:auto; border:1px solid var(--line); border-radius:14px; background:#fff"></div>

        <div class="sep"></div>
        <h3>Config Health</h3>
        <div id="cfgHealth" class="muted"></div>
      </div>
    </div>
  </section>
</div>

<div class="modalback" id="modalBack">
  <div class="modal">
    <div class="top">
      <h2 id="modalTitle">Modal</h2>
      <button class="closex" id="modalClose">Close</button>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<script id="mainScript">
// ===================== Standardized Resident Picker (All Modules) =====================
function getActiveResidents(s){
  try{ return getFilteredResidents ? getFilteredResidents(s) : (s.census?.activeResidents||[]); }catch(e){ return []; }
}
function residentOptionsHtml(residents, selectedId){
  selectedId = selectedId || "";
  return `<option value="">— Select from active census —</option>` + (residents||[]).map(r=>{
    const sel = String(r.id)===String(selectedId) ? "selected" : "";
    const label = `${escapeHtml(r.name||"")} (${escapeHtml(r.mrn||"")})`;
    return `<option value="${escapeHtml(r.id)}" ${sel}>${label}</option>`;
  }).join("");
}
function bindResidentPicker(selectId, map){
  // map: {name, mrn, unit, room, residentIdHidden}
  const sel = document.getElementById(selectId);
  if(!sel) return;
  const s = Store.load();
  const residents = getActiveResidents(s);
  const apply = ()=>{
    const rid = sel.value || "";
    const r = rid ? (s.residentsById?.[rid] || residents.find(x=>String(x.id)===String(rid))) : null;
    if(map.residentIdHidden){
      const h = document.getElementById(map.residentIdHidden);
      if(h) h.value = rid;
    }
    if(!r) return;
    if(map.name){ const el=document.getElementById(map.name); if(el){ el.value = r.name||""; el.readOnly = true; } }
    if(map.mrn){ const el=document.getElementById(map.mrn); if(el){ el.value = r.mrn||""; el.readOnly = true; } }
    if(map.unit){ const el=document.getElementById(map.unit); if(el){
      const raw = (r.unit||r.unitKey||r.unitName||"");
      let val = String(raw||"");
      try{
        // Standardize to Unit 2/3/4 names based on config
        const key = (typeof unitKeyFromText==="function") ? unitKeyFromText(raw, s.config) : ((typeof unitKeyFromAny==="function") ? unitKeyFromAny(raw, s.config) : "");
        if(key && s.config && Array.isArray(s.config.units)){
          const u = s.config.units.find(x=>String(x.unitKey)===String(key));
          if(u && u.unitName) val = u.unitName;
        }
      }catch(e){}
      el.value = normalizeUnitName(val, s.config);
      el.readOnly = true;
    } }
    if(map.room){ const el=document.getElementById(map.room); if(el){ const rv = (r.room||r.roomNumber||r.room_no||r.rm||""); el.value = String(rv||"").toUpperCase(); el.readOnly = true; } }
  };
  sel.addEventListener("change", apply);
  // initial
  setTimeout(apply, 0);
}
// =================== End Standardized Resident Picker ================================



const STORE_KEY="ltc_unified_newbuild_v1";



// --- Storage safety wrappers (prevents iOS/Safari QuotaExceeded crashes) ---
function storageGet(k){ try{ return localStorage.getItem(k); }catch(e){ return null; } }
function storageSet(k,v){
  try{ localStorage.setItem(k,v); return true; }
  catch(e){
    try{ console.warn('[storageSet] failed', e); }catch(_){ }
    try{ toastSafe('Storage save failed (device storage limit or Private mode). Export Backup, then Reset Local Data, then re-import.'); }catch(_){ }
    return false;
  }
}
function storageRemove(k){ try{ localStorage.removeItem(k); return true; }catch(e){ return false; } }

// --- Smart localStorage migration (prevents blank modules after opening a new build) ---
// Some older versions saved state under different keys. If this file opens and STORE_KEY is empty,
// we pick the most data-rich legacy key and migrate it into STORE_KEY automatically.
function _lsSafeKeys(){
  try{ return Object.keys(localStorage||{}); }catch(e){ return []; }
}
function _lsCount(v){
  try{
    if(Array.isArray(v)) return v.length;
    if(v && typeof v==='object') return Object.keys(v).length;
  }catch(e){}
  return 0;
}
function _stateScore(obj){
  try{
    const m = (obj && obj.modules) ? obj.modules : {};
    const ip = m.ip || m.IP || obj.ip || {};
    const ipLL = _lsCount(ip.lineListCases || ip.cases || ip.lineList || ip.lineListing || ip.lineListItems);
    const ipPrec = _lsCount(ip.precautions || ip.isolation || obj.ipPrecautions || obj.precautions);
    const abt = m.abt || {};
    const vax = m.vax || {};
    const residents = _lsCount(obj.residentsById);
    const abtN = _lsCount(abt.courses);
    const vaxN = _lsCount(vax.events);
    // Weight IP heavily because blank IP is the current pain point.
    return (ipLL*1000) + (ipPrec*100) + (abtN*10) + (vaxN*2) + residents;
  }catch(e){ return 0; }
}
function _pickBestLegacyRaw(){
  const keys = _lsSafeKeys();
  if(!keys.length) return null;
  const rx = /(icn|ltc|unified|compliance|tracker|suite)/i;
  let bestKey = null;
  let bestScore = 0;
  for(const k of keys){
    if(!k || k===STORE_KEY) continue;
    if(!rx.test(String(k))) continue;
    let raw = null;
    try{ raw = localStorage.getItem(k); }catch(e){ raw=null; }
    if(!raw || raw.length < 30) continue;
    let obj = null;
    try{ obj = JSON.parse(raw); }catch(e){ obj=null; }
    if(!obj || typeof obj!=='object') continue;
    const sc = _stateScore(obj);
    if(sc > bestScore){ bestScore = sc; bestKey = k; }
  }
  if(!bestKey || bestScore <= 0) return null;
  try{ return localStorage.getItem(bestKey); }catch(e){ return null; }
}






const CURRENT_SCHEMA = 2;

// =========================
// Phase 2: Schema Versioning + Migrations (skeleton)
// - Keeps older saves/imports from crashing newer UI
// - Adds forward-only migration hooks
// =========================
function ensureShape(s){
  if(!s || typeof s!=="object") s = {};
  if(typeof s.schema !== "number") s.schema = 1;
  if(!s.config) s.config = {};
  if(!s.config.qapi) s.config.qapi = { patientDaysLast7:0, windowDays:7, thresholds:{ infectionRatePer1000:10, abtUtilPer1000:20, gi72h:2, resp72h:2, abtStartsDay:3, pendingBacklog:5, vaxAnyTarget:80 } };
  if(!s.config.qapi.thresholds) s.config.qapi.thresholds = { infectionRatePer1000:10, abtUtilPer1000:20, gi72h:2, resp72h:2, abtStartsDay:3, pendingBacklog:5, vaxAnyTarget:80 };
  if(!s.ui) s.ui = {};
  if(!Array.isArray(s.auditLog)) s.auditLog = [];
  if(!s.census) s.census = { rawText:"", lastPastedAt:null, activeResidentIds:[] };
  if(!Array.isArray(s.census.activeResidentIds)) s.census.activeResidentIds = [];
  if(!s.residentsById) s.residentsById = {};
  if(!s.modules) s.modules = {};
  if(!s.modules.abt) s.modules.abt = { courses: [] };
  if(!Array.isArray(s.modules.abt.courses)) s.modules.abt.courses = [];
  if(!s.modules.ip) s.modules.ip = { precautions: [] };
  if(!Array.isArray(s.modules.ip.precautions)) s.modules.ip.precautions = [];
  if(!s.modules.vax) s.modules.vax = { events: [], ui: { range:"week", status:"all", type:"all", startISO:"", endISO:"" } };
  if(!Array.isArray(s.modules.vax.events)) s.modules.vax.events = [];
  if(!s.modules.vax.ui) s.modules.vax.ui = { range:"week", status:"all", type:"all", startISO:"", endISO:"" };
  // New (safe) containers for upcoming phases
  if(!Array.isArray(s.notes)) s.notes = [];
  if(!Array.isArray(s.tasks)) s.tasks = [];
  if(!s.audits) s.audits = { sessions: [], entries: [] };
  if(!Array.isArray(s.audits.sessions)) s.audits.sessions = [];
  if(!Array.isArray(s.audits.entries)) s.audits.entries = [];
  return s;
}

function migrateToV2(s){
  // v2 introduces notes/tasks/audits containers + bumps schema
  s = ensureShape(s);
  s.schema = 2;
  return s;
}

function migrateState(s){
  s = ensureShape(s);
  // forward-only migrations
  if(s.schema < 2) s = migrateToV2(s);
  // keep future hooks here (v3, v4...)
  if(s.schema > CURRENT_SCHEMA){
    // Unknown future schema: keep app alive but warn
    console.warn('[Schema] Save schema is newer than this tool:', s.schema, '>', CURRENT_SCHEMA);
  }
  return s;
}
// =========================
// ELHub (Error + Logic Hub)
// Phase 1 Guard Rails
// - Captures errors without killing the app
// - Provides a small health chip + diagnostics panel
// - Runs startup checks and safely kicks off renderAll()
// =========================
const ELHub = (()=>{
  const state = {
    started:false,
    errors:[],
    warns:[],
    checks:[],
    lastRunAt:null,
  };

  const maxKeep = 40;
  const push = (arr, item)=>{ arr.push(item); if(arr.length>maxKeep) arr.splice(0, arr.length-maxKeep); };

  const stamp = ()=> new Date().toISOString();
  const fmtErr = (e)=>{
    try{
      if(!e) return 'Unknown error';
      if(typeof e === 'string') return e;
      const msg = e.message || String(e);
      const st = e.stack ? String(e.stack) : '';
      return st ? `${msg}\n${st}` : msg;
    }catch(_){ return 'Unknown error'; }
  };

  const record = (kind, where, e, extra={})=>{
    const entry = { ts: stamp(), kind, where, message: fmtErr(e), ...extra };
    if(kind==='error') push(state.errors, entry);
    else push(state.warns, entry);
    updateChip();
  };

  const level = ()=>{
    if(state.errors.length) return 'bad';
    if(state.warns.length) return 'warn';
    return 'good';
  };

  const ensureChip = ()=>{
    if(document.getElementById('elhubChip')) return;
    const chipbar = document.querySelector('.chipbar');
    if(!chipbar) return;
    const el = document.createElement('button');
    el.id = 'elhubChip';
    el.className = 'chip';
    el.type = 'button';
    el.style.cursor = 'pointer';
    el.title = 'Health & Diagnostics';
    el.innerHTML = `<span>Health</span> <span class="n" id="elhubChipTxt">OK</span>`;
    el.addEventListener('click', ()=> showPanel());
    chipbar.appendChild(el);
  };

  const updateChip = ()=>{
    ensureChip();
    const el = document.getElementById('elhubChip');
    const txt = document.getElementById('elhubChipTxt');
    if(!el || !txt) return;
    const lv = level();
    el.classList.remove('good','warn','bad');
    if(lv==='good'){ el.classList.add('good'); txt.textContent = 'OK'; }
    if(lv==='warn'){ el.classList.add('warn'); txt.textContent = `WARN (${state.warns.length})`; }
    if(lv==='bad'){ el.classList.add('bad'); txt.textContent = `ERR (${state.errors.length})`; }
  };

  const showPanel = ()=>{
    // lightweight, self-contained modal so it works even if other modals break
    let back = document.getElementById('elhubBack');
    if(!back){
      back = document.createElement('div');
      back.id = 'elhubBack';
      back.className = 'modalback';
      back.style.display = 'flex';
      back.innerHTML = `
        <div class="modal">
          <div class="top">
            <div>
              <div style="font-weight:900">Health & Diagnostics</div>
              <div class="muted mini" id="elhubMeta"></div>
            </div>
            <div class="row" style="gap:8px">
              <button class="btn" id="elhubRun">Run Diagnostics</button>
              <button class="closex" id="elhubClose">Close</button>
            </div>
          </div>
          <div class="sep"></div>
          <div id="elhubBody"></div>
        </div>`;
      document.body.appendChild(back);
      back.addEventListener('click', (ev)=>{ if(ev.target===back) closePanel(); });
      back.querySelector('#elhubClose').addEventListener('click', closePanel);
      back.querySelector('#elhubRun').addEventListener('click', ()=>{ runDiagnostics(true); renderPanel(); });
    }
    back.style.display = 'flex';
    renderPanel();
  };

  const closePanel = ()=>{
    const back = document.getElementById('elhubBack');
    if(back) back.style.display = 'none';
  };

  const htmlEsc = (s)=> (s??'').toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');

  const renderPanel = ()=>{
    const meta = document.getElementById('elhubMeta');
    if(meta){
      meta.textContent = `Status: ${level().toUpperCase()} · Errors: ${state.errors.length} · Warnings: ${state.warns.length}`;
    }
    const body = document.getElementById('elhubBody');
    if(!body) return;

    const checks = state.checks.length ? `
      <div class="card" style="box-shadow:none">
        <h3 style="margin:0 0 6px">Startup Checks</h3>
        <table class="thin">
          <thead><tr><th>Check</th><th>Status</th><th>Detail</th></tr></thead>
          <tbody>
            
      
      
      
${state.checks.map(c=>`<tr><td>${htmlEsc(c.name)}</td><td class="nowrap">${htmlEsc(c.status)}</td><td>${htmlEsc(c.detail||'')}</td></tr>`).join('')}
          </tbody>
        </table>
      </div>` : '';

    const errs = state.errors.length ? `
      <div class="card" style="box-shadow:none;margin-top:10px">
        <h3 style="margin:0 0 6px">Errors</h3>
        ${state.errors.slice().reverse().map(e=>`
          <div style="border:1px solid var(--line);border-radius:12px;padding:10px;margin-top:8px;background:#fff">
            <div class="row" style="justify-content:space-between">
              <div><b>${htmlEsc(e.where||'')}</b> <span class="muted mini">${htmlEsc(e.ts)}</span></div>
            </div>
            <pre style="white-space:pre-wrap;margin:8px 0 0;font-family:var(--mono);font-size:12px">${htmlEsc(e.message)}</pre>
          </div>`).join('')}
      </div>` : '';

    const warns = state.warns.length ? `
      <div class="card" style="box-shadow:none;margin-top:10px">
        <h3 style="margin:0 0 6px">Warnings</h3>
        <table class="thin"><thead><tr><th>Where</th><th>When</th><th>Detail</th></tr></thead><tbody>
          ${state.warns.slice().reverse().map(w=>`<tr><td>${htmlEsc(w.where||'')}</td><td class="nowrap">${htmlEsc(w.ts)}</td><td>${htmlEsc(w.message)}</td></tr>`).join('')}
        </tbody></table>
      </div>` : '';

    body.innerHTML = checks + errs + warns + (!checks && !errs && !warns ? `<div class="muted">No issues detected.</div>` : '');
  };


  // --- Preflight Linter (syntax guardrail) ---
  const preflightLintMainScript = ()=>{
    try{
      const el = document.getElementById('mainScript');
      if(!el) return { ok:false, detail:'mainScript tag not found' };
      const code = el.textContent || '';
      // Basic balance checks (ignores strings/comments as best-effort)
      let brace=0, paren=0, bracket=0;
      let backtick=0;
      let inS=false, inD=false, inT=false; // single, double, template
      let inLineC=false, inBlockC=false;
      let esc=false;
      for(let i=0;i<code.length;i++){
        const ch = code[i];
        const nx = code[i+1];

        if(inLineC){
          if(ch === '\n'){ inLineC=false; }
          continue;
        }
        if(inBlockC){
          if(ch==='*' && nx=== '/'){ inBlockC=false; i++; }
          continue;
        }

        if(inS){
          if(esc){ esc=false; continue; }
          if(ch==='\\'){ esc=true; continue; }
          if(ch==="'"){ inS=false; }
          continue;
        }
        if(inD){
          if(esc){ esc=false; continue; }
          if(ch==='\\'){ esc=true; continue; }
          if(ch==='"'){ inD=false; }
          continue;
        }
        if(inT){
          if(esc){ esc=false; continue; }
          if(ch==='\\'){ esc=true; continue; }
          if(ch==='`'){ inT=false; backtick = Math.max(0, backtick-1); }
          continue;
        }

        // comments start
        if(ch==='/' && nx=== '/'){ inLineC=true; i++; continue; }
        if(ch==='/' && nx=== '*'){ inBlockC=true; i++; continue; }

        // strings
        if(ch==="'"){ inS=true; continue; }
        if(ch==='"'){ inD=true; continue; }
        if(ch==='`'){ inT=true; backtick++; continue; }

        if(ch==='{'){ brace++; }
        else if(ch==='}'){ brace--; if(brace<0) return { ok:false, detail:`Extra '}' near offset ${i}` }; }
        else if(ch==='('){ paren++; }
        else if(ch===')'){ paren--; }
        else if(ch==='['){ bracket++; }
        else if(ch===']'){ bracket--; }
      }
      // finalize states
      if(inBlockC) return { ok:false, detail:'Unclosed block comment /* */' };
      if(inS) return { ok:false, detail:"Unclosed single-quote string" };
      if(inD) return { ok:false, detail:'Unclosed double-quote string' };
      if(inT || backtick>0) return { ok:false, detail:'Unclosed template literal `...`' };
      if(brace!==0) return { ok:false, detail:`Unbalanced braces: ${brace}` };
      // Note: parentheses balance not enforced (regex literals can cause false positives).
      // Note: bracket balance not enforced (regex literals can cause false positives).
      return { ok:true, detail:'OK' };
    }catch(e){
      return { ok:false, detail:'Preflight error' };
    }
  };

  const runDiagnostics = (deep=false)=>{
    state.checks = [];
    const addCheck = (name, ok, detail='')=> state.checks.push({ name, status: ok ? 'OK' : 'FAIL', detail });

    // Preflight linter
    const pf = preflightLintMainScript();
    addCheck('Preflight Linter (JS syntax)', pf.ok, pf.detail);


    // DOM essentials
    const requiredIds = [
      'btnBackup','btnRestore','btnLegacy','btnReset',
      'tab-dashboard','tab-reports','tab-ip','tab-abt','tab-vax',
      'modalBack','modalBody'
    ];
    const missing = requiredIds.filter(id=> !document.getElementById(id));
    addCheck('Required DOM IDs', missing.length===0, missing.length ? `Missing: ${missing.join(', ')}` : 'All present');

    // Storage parse
    try{
      if(typeof Store==='object' && typeof Store.load==='function'){
        const s = Store.load();
        addCheck('Store.load()', !!s && typeof s==='object', s ? 'Loaded' : 'No data');
        // Minimal shape checks
        addCheck('State.ui exists', !!(s && s.ui), s && s.ui ? 'OK' : 'Missing ui');
        addCheck('State.modules exists', !!(s && s.modules), s && s.modules ? 'OK' : 'Missing modules');
      } else {
        addCheck('Store object', false, 'Store.load not found');
      }
    }catch(e){
      addCheck('Store.load()', false, fmtErr(e));
      record('error','ELHub:Store.load', e);
    }

    // Critical functions
    addCheck('renderAll()', typeof window.renderAll==='function', typeof window.renderAll);

    if(deep){
      // Deep-ish: attempt non-destructive calls
      try{
        if(typeof window.renderAll==='function') window.safeRenderAll();
        addCheck('renderAll() run', true, 'Completed (see console if warnings)');
      }catch(e){
        addCheck('renderAll() run', false, fmtErr(e));
        record('error','ELHub:renderAll', e);
      }
    }

    state.lastRunAt = stamp();
    updateChip();
  };

  const safeRun = (where, fn)=>{
    try{ return fn(); }
    catch(e){ record('error', where, e); }
  };

  const installGlobalGuards = ()=>{
  window.addEventListener('error', (ev)=>{
    try{
      // Distinguish script/runtime errors vs resource load errors
      const isResource = ev && ev.target && (ev.target.src || ev.target.href) && !ev.error;
      if(isResource){
        const t = ev.target;
        record('error','window.error.resource', {
          tag: t.tagName,
          src: t.src || null,
          href: t.href || null
        });
        return;
      }
      const err = ev && ev.error ? ev.error : null;
      record('error','window.error', {
        message: (ev && ev.message) ? String(ev.message) : (err ? String(err.message||err) : String(ev||'')),
        filename: ev && ev.filename ? ev.filename : null,
        lineno: ev && typeof ev.lineno==='number' ? ev.lineno : null,
        colno: ev && typeof ev.colno==='number' ? ev.colno : null,
        stack: err && err.stack ? String(err.stack) : null
      });
    }catch(_){ }
  });
  window.addEventListener('unhandledrejection', (ev)=>{
    try{
      const r = ev && ev.reason ? ev.reason : ev;
      record('error','promise.rejection', {
        message: (r && r.message) ? String(r.message) : String(r||''),
        stack: (r && r.stack) ? String(r.stack) : null
      });
    }catch(_){ }
  });
};


  const runSmokeTests = ()=>{
    const results = [];
    const ok = (name, pass, detail="")=>{
      results.push({name, pass, detail});
      record(`Smoke: ${name}`, !!pass, detail||"");
    };
    try{
      // 1) Modal open/close
      openModal("Smoke Test", "<div class='muted'>Hello</div>");
      
  try{ renderFollowUps(a); }catch(e){}
closeModal();
      ok("Modal open/close", true);
    }catch(e){ ok("Modal open/close", false, "modal shell missing or error"); }

    try{
      // 2) Render core tabs without throwing
      const s = Store.load();
      // These functions exist in the app; call defensively
      try{ renderDash && renderDash(); }catch(e){}
      try{ renderIp && renderIp(); }catch(e){}
      ok("Core renders (dash/ip)", true);
    }catch(e){ ok("Core renders (dash/ip)", false, "render threw"); }

    try{
      // 3) IP view switching (ct/prec/outbreak if available)
      try{ setIpView && setIpView("ct"); }catch(e){}
      try{ setIpView && setIpView("prec"); }catch(e){}
      try{ setIpView && setIpView("outbreak"); }catch(e){}
      ok("IP subview switching", true);
    }catch(e){ ok("IP subview switching", false, "setIpView error"); }

    try{
      // 4) Dry-run line listing generator (doesn't print if no cases)
      const s = Store.load(); ensureIpData(s);
      ok("Line listing dry-run", true, (s.modules?.ip?.lineListCases?.length ? "cases present" : "no cases (ok)"));
    }catch(e){ ok("Line listing dry-run", false, "case store error"); }

    // Summary toast
    const fails = results.filter(r=>!r.pass);
    toastSafe(fails.length ? `Smoke Tests: ${fails.length} failed` : "Smoke Tests: all passed");
    return { results, fails };
  };

  const init = ()=>{
    if(state.started) return;
    state.started = true;
    installGlobalGuards();
    ensureChip();
    runDiagnostics(false);
    // safe kickoff
    safeRun('init:renderAll', ()=>{ if(typeof window.renderAll==='function') window.safeRenderAll(); });
  };

  return { init, safeRun, runDiagnostics, runSmokeTests, record };
})();

const nowISO = ()=> new Date().toISOString();
const safeJsonParse = (s, fb=null)=>{ try{return JSON.parse(s);}catch(e){return fb;} };
const uid = (p="id")=> `${p}_${Math.random().toString(16).slice(2)}_${Date.now().toString(16)}`;
const normalizeText = (s)=> (s||"").toString().trim().replace(/\s+/g," ").toUpperCase();

// ========================= Reliability Pack (Phase 4 Step 2) =========================
// DOM helpers
const must = (id)=>{
  const el = document.getElementById(id);
  if(!el){
    toastSafe(`Missing required element: ${id}`);
    throw new Error(`Missing required element: ${id}`);
  }
  return el;
};
// Toast fallback (never let missing toast crash the app)
function toastSafe(msg){
  try{
    if(typeof toast === "function") return toast(msg);
  }catch(e){}
  try{ alert(String(msg||"")); }catch(e){}
}
// Bind once helper to prevent double-wiring
function bindOnce(el, evt, fn){
  try{
    if(!el) return;
    const k = `bound_${evt}`;
    if(el.dataset && el.dataset[k]==="1") return;
    el.addEventListener(evt, fn);
    if(el.dataset) el.dataset[k] = "1";
  }catch(e){}
}
// Dedupe helper by key
function dedupeBy(arr, keyFn){
  const out = [];
  const seen = new Set();
  for(const x of (arr||[])){
    const k = String(keyFn(x)||"");
    if(!k || seen.has(k)) continue;
    seen.add(k); out.push(x);
  }
  return out;
}
// Runtime error capture -> Diagnostics record (non-fatal)
(function wireGlobalErrorCapture(){
  if(window.__icnErrCaptureWired) return;
  window.__icnErrCaptureWired = true;
  window.addEventListener("error", (ev)=>{
    try{
      const msg = ev?.message || "Unknown error";
      const loc = (ev?.filename ? `${ev.filename}:${ev.lineno||""}:${ev.colno||""}` : "");
      diagnostics.record(`Runtime error: ${msg}`, false, loc);
      toastSafe("Runtime error captured. Open Health & Diagnostics.");
    }catch(e){}
  });
  window.addEventListener("unhandledrejection", (ev)=>{
    try{
      const msg = (ev?.reason && (ev.reason.message||String(ev.reason))) || "Unhandled promise rejection";
      diagnostics.record(`Unhandled rejection: ${msg}`, false, "");
      toastSafe("Unhandled rejection captured. Open Health & Diagnostics.");
    }catch(e){}
  });
})();
// ======================= End Reliability Pack =======================================

const escapeHtml = (s)=> (s??"").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;");

// Resolve resident display name for logs/reports (prevents blank Resident column)
function resolveResidentDisplayName(state, row){
  try{
    const s = state || {};
    const rr = row || {};
    const rid = (rr.residentId || rr.resId || rr.residentID || rr.resident_id || '').toString().trim();
    if(rid && s.residentsById && s.residentsById[rid] && (s.residentsById[rid].name||'').trim()) return (s.residentsById[rid].name||'').trim();
    const mrn = (rr.mrn || '').toString().trim();
    if(mrn){
      const vals = Object.values(s.residentsById || {});
      for(const x of vals){
        if(((x.mrn||'').toString().trim())===mrn && (x.name||'').trim()) return (x.name||'').trim();
      }
    }
    const nm = (rr.residentName || rr.name || '').toString().trim();
    return nm;
  }catch(e){ return (row && (row.residentName||row.name) || '')+''; }
}
const parseMDY = (s)=>{
const m = (s||"").trim().match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
if(!m) return null;
const mm=parseInt(m[1],10), dd=parseInt(m[2],10), yy=parseInt(m[3],10);
const yyyy=yy<100?(yy+2000):yy;
const dt=new Date(yyyy,mm-1,dd);
if(dt.getFullYear()!==yyyy||dt.getMonth()!==mm-1||dt.getDate()!==dd) return null;
return dt;
};
const isoToMDY = (iso)=>{
const t=(iso||"").toString().trim();
const m=t.match(/^(\d{4})-(\d{2})-(\d{2})$/);
if(!m) return t;
return `${m[2]}/${m[3]}/${m[1]}`;
};
const mdyToISO = (mdy)=>{
const d=parseMDY(mdy);
if(!d) return "";
const mm=String(d.getMonth()+1).padStart(2,"0");
const dd=String(d.getDate()).padStart(2,"0");
return `${d.getFullYear()}-${mm}-${dd}`;
};
const todayISO = ()=>{
const d=new Date();
const mm=String(d.getMonth()+1).padStart(2,"0");
const dd=String(d.getDate()).padStart(2,"0");
return `${d.getFullYear()}-${mm}-${dd}`;
};
const fmtPct = (x)=> isFinite(x) ? `${x.toFixed(1)}%` : "—";

function deepMerge(target, src){
if(Array.isArray(target) && Array.isArray(src)) return src;
if(typeof target!=="object" || target===null) return src;
if(typeof src!=="object" || src===null) return target;
const out = Array.isArray(target) ? [...target] : {...target};
for(const k of Object.keys(src)){
if(k in target) out[k] = deepMerge(target[k], src[k]);
else out[k] = src[k];
}
return out;
}

function safeRenderAll(){
  try{
    if(typeof window.renderAll==="function") window.renderAll();
  }catch(e){
    try{ console.warn("renderAll failed", e); }catch(_){}
  }
}

const Store = {
defaults(){
return {
schema: CURRENT_SCHEMA,
config: {
facilityName: "Long Beach Nursing & Rehabilitation Center",
totalCapacity: 150,
units: [
{ unitKey:"U2", unitName:"Unit 2", bedCapacity: 50 },
{ unitKey:"U3", unitName:"Unit 3", bedCapacity: 50 },
{ unitKey:"U4", unitName:"Unit 4", bedCapacity: 50 }
],
unitAliases: { "UNIT 2":"U2","2":"U2","UNIT 3":"U3","3":"U3","UNIT 4":"U4","4":"U4" },
qapi:{
  patientDaysLast7: 0,
  windowDays: 7,
  thresholds:{
    infectionRatePer1000: 10,
    abtUtilPer1000: 20,
    gi72h: 2,
    resp72h: 2,
    abtStartsDay: 3,
    pendingBacklog: 5,
    vaxAnyTarget: 80
  }
}

},
ui: { unitFilter:"ALL", includeDischarged:false, selectedResidentId:"", viewAsRole:"", pendingDrilldown:null },
auditLog: [],
census: { rawText:"", lastPastedAt:null, activeResidentIds:[] },
residentsById: {},
modules: {
abt: { courses: [] },
ip: { precautions: [] },
vax: { events: [], ui: { range:"week", status:"all", type:"all", startISO:"", endISO:"" } }
},
notes: [],
tasks: [],
audits: { sessions: [], entries: [] },
};
},
load(){
let raw = null;
try{ raw = storageGet(STORE_KEY); }catch(e){ raw = null; }
let data = safeJsonParse(raw, null);
// If missing or effectively empty, try to migrate from a legacy key.
try{
  const currentScore = (data && typeof data==='object') ? _stateScore(data) : 0;
  if(!data || typeof data!=="object" || currentScore===0){
    const legacyRaw = _pickBestLegacyRaw();
    if(legacyRaw){
      const legacyObj = safeJsonParse(legacyRaw, null);
      const legacyScore = (legacyObj && typeof legacyObj==='object') ? _stateScore(legacyObj) : 0;
      if(legacyScore > currentScore){
        raw = legacyRaw;
        data = legacyObj;
        try{ storageSet(STORE_KEY, legacyRaw); }catch(e){}
      }
    }
  }
}catch(e){}

if(!data || typeof data !== "object") return migrateState(this.defaults());
const merged = deepMerge(this.defaults(), data);
try{ const ms = migrateState(merged); try{ autoRepairState(ms); }catch(_){ } return ms; }catch(e){ console.warn("migrateState failed", e); const ms = ensureShape(merged); try{ autoRepairState(ms); }catch(_){ } return ms; }
},
save(s){
  try{ s = migrateState(s); }catch(e){}
  storageSet(STORE_KEY, JSON.stringify(s));
},
patch(fn){
const s = this.load();
ensureDefaultUsers(s);
ensureAudit(s);
const role = (typeof getEffectiveRole==="function") ? getEffectiveRole(s) : "Staff";
const ctx = window.__auditContext || null;
if(role==="Surveyor"){
if(!(ctx && ctx.action && (ctx.action==="View" || ctx.action.startsWith("Select")))){
alert("Surveyor view is read-only.");
return;
}
}
fn(s);
const tab = window.__activeTab || "";
const action = (ctx && ctx.action) ? ctx.action : (tab ? `Update (${tab})` : "Update");
const details = (ctx && ctx.details) ? ctx.details : {};
logAction(s, action, details);
this.save(s);
safeRenderAll();
}
};

function ensureAudit(s){
if(!Array.isArray(s.auditLog)) s.auditLog = [];
if(s.auditLog.length > 500) s.auditLog = s.auditLog.slice(0,500);
}

function getCurrentUser(s){
ensureDefaultUsers(s);
const id = s.config.currentUserId;
return (s.config.users||[]).find(u=>u.id===id) || {name:"Admin", role:"Admin"};
}

function getEffectiveRole(s){
const u = getCurrentUser(s);
const viewAs = (s.ui && s.ui.viewAsRole) ? s.ui.viewAsRole : "";
if((u.role||"")==="Admin" && viewAs) return viewAs;
return u.role || "Staff";
}

function applyRoleToDOM(role){
document.body.dataset.role = role || "Staff";
document.querySelectorAll(".tabbtn, .menubtn").forEach(b=>{
const t = b.dataset.tab;
if(!t) return;
if(role==="Surveyor"){
const ok = (t==="dashboard" || t==="ip" || t==="vax" || t==="surveillance" || t==="comms" || t==="decisions" || t==="reports" || t==="audits" || t==="staff" || t==="env");
b.style.display = ok ? "" : "none";
} else if(role==="Staff"){
const ok = (t==="dashboard" || t==="census" || t==="abt" || t==="ip" || t==="vax" || t==="surveillance" || t==="comms" || t==="decisions" || t==="reports" || t==="audits" || t==="staff" || t==="env");
b.style.display = ok ? "" : "none";
} else {
b.style.display = "";
}
});
}

function canEdit(s){ return getEffectiveRole(s) !== "Surveyor"; }
function canAdmin(s){ return getEffectiveRole(s) === "Admin"; }

function withAudit(action, details, fn){
const prev = window.__auditContext;
window.__auditContext = { action, details };
try{ return fn(); } finally { window.__auditContext = prev; }
}

function logAction(s, action, details){
ensureAudit(s);
const u = getCurrentUser(s);
const role = getEffectiveRole(s);
const entry = {
ts: new Date().toISOString(),
user: u.name || "User",
role,
action: action || "Update",
details: details || {}
};
s.auditLog.unshift(entry);
if(s.auditLog.length > 500) s.auditLog.length = 500;
}

function renderAuditLog(s){
const wrap = document.getElementById("auditTableWrap");
if(!wrap) return;
ensureAudit(s);
const rows = s.auditLog || [];
if(!rows.length){
wrap.innerHTML = `<div class="muted" style="padding:12px">No audit entries yet.</div>`;
return;
}
wrap.innerHTML = `
<table>
<thead><tr>
<th style="width:160px">Timestamp</th>
<th style="width:160px">User</th>
<th style="width:90px">Role</th>
<th style="width:220px">Action</th>
<th>Details</th>
</tr></thead>
<tbody>
${rows.slice(0,250).map(e=>`
<tr>
<td class="nowrap">${escapeHtml(new Date(e.ts).toLocaleString())}</td>
<td>${escapeHtml(e.user||"")}</td>
<td class="nowrap">${escapeHtml(e.role||"")}</td>
<td>${escapeHtml(e.action||"")}</td>
<td class="muted">${escapeHtml(formatAuditDetails(e.details))}</td>
</tr>
`).join("")}
</tbody>
</table>
${rows.length>250?`<div class="muted mini" style="padding:10px">Showing latest 250 of ${rows.length} entries.</div>`:""}
`;
}
function formatAuditDetails(d){
if(!d) return "";
try{ return (typeof d==="string") ? d : JSON.stringify(d); }catch(e){ return ""; }
}

function bufToB64(buf){
const bytes = new Uint8Array(buf);
let s = "";
for(let i=0;i<bytes.length;i++) s += String.fromCharCode(bytes[i]);
return btoa(s);
}
function b64ToBuf(b64){
const bin = atob(b64);
const bytes = new Uint8Array(bin.length);
for(let i=0;i<bin.length;i++) bytes[i] = bin.charCodeAt(i);
return bytes.buffer;
}
async function deriveKeyFromPassword(password, saltB64, iterations){
const enc = new TextEncoder();
const baseKey = await crypto.subtle.importKey("raw", enc.encode(password), {name:"PBKDF2"}, false, ["deriveKey"]);
const salt = new Uint8Array(b64ToBuf(saltB64));
return crypto.subtle.deriveKey(
{ name:"PBKDF2", salt, iterations, hash:"SHA-256" },
baseKey,
{ name:"AES-GCM", length:256 },
false,
["encrypt","decrypt"]
);
}
async function encryptState(password, state){
const salt = crypto.getRandomValues(new Uint8Array(16));
const iv   = crypto.getRandomValues(new Uint8Array(12));
const iter = 200000;
const key  = await deriveKeyFromPassword(password, bufToB64(salt.buffer), iter);
const plaintext = new TextEncoder().encode(JSON.stringify(state));
const ct = await crypto.subtle.encrypt({name:"AES-GCM", iv}, key, plaintext);
return {
v: 1,
tool: "Infection Control Nurse Compliance Suite",
createdAt: new Date().toISOString(),
kdf: "PBKDF2",
hash: "SHA-256",
iter,
alg: "AES-GCM",
salt: bufToB64(salt.buffer),
iv: bufToB64(iv.buffer),
data: bufToB64(ct)
};
}
async function decryptState(password, pkg){
if(!pkg || !pkg.salt || !pkg.iv || !pkg.data) throw new Error("Invalid package");
const iter = Number(pkg.iter||200000);
const key  = await deriveKeyFromPassword(password, pkg.salt, iter);
const iv   = new Uint8Array(b64ToBuf(pkg.iv));
const ct   = b64ToBuf(pkg.data);
const ptBuf = await crypto.subtle.decrypt({name:"AES-GCM", iv}, key, ct);
const jsonStr = new TextDecoder().decode(ptBuf);
return JSON.parse(jsonStr);
}
window.__drilldownExport = null;

function setDrilldownExport(payload){
window.__drilldownExport = payload || null;
}

function csvEscape(v){
const s = (v===null || v===undefined) ? "" : String(v);
const needs = /[",\n]/.test(s);
const out = s.replace(/"/g,'""');
return needs ? `"${out}"` : out;
}

function downloadCSV(filename, csvText){
const blob = new Blob([csvText], {type:"text/csv"});
const url = URL.createObjectURL(blob);
const a = document.createElement("a");
a.href = url;
a.download = filename;
document.body.appendChild(a);
a.click();
setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 500);
}

function exportDrilldownCSV(){
const p = window.__drilldownExport;
if(!p){ alert("Nothing to export."); return; }
const cols = p.columns || [];
const rows = p.rows || [];
const header = cols.map(c=>csvEscape(c.label)).join(",");
const lines = [header];
for(const r of rows){
lines.push(cols.map(c=>csvEscape(r[c.key])).join(","));
}
const date = new Date().toISOString().slice(0,10);
const safe = (p.type||"drilldown").replace(/[^a-z0-9_-]/gi,"_");
downloadCSV(`${safe}_${date}.csv`, lines.join("\n"));
}

function printDrilldown(){
const p = window.__drilldownExport;
if(!p){ alert("Nothing to print."); return; }
const cols = p.columns || [];
const rows = p.rows || [];
const table = `
<table>
<thead><tr>${cols.map(c=>`<th>${escapeHtml(c.label)}</th>`).join("")}</tr></thead>
<tbody>
${rows.map(r=>`<tr>${cols.map(c=>`<td>${escapeHtml((r[c.key] ?? ""))}</td>`).join("")}</tr>`).join("")}
</tbody>
</table>
`;
const body = `
<div class="title">${escapeHtml(p.title||"Drilldown")}</div>
${p.subtitle?`<div class="muted" style="margin-top:4px">${escapeHtml(p.subtitle)}</div>`:""}
<div style="height:10px"></div>
${table}
`;
openPrintWindow(p.title||"Drilldown", body, `
@page{ size: landscape; margin: 0.4in; }
body{ font-size: 11px; }
th,td{ font-size: 11px; }
`);
}

function downloadText(filename, text){
const blob = new Blob([text], {type:"application/json"});
const url = URL.createObjectURL(blob);
const a = document.createElement("a");
a.href = url;
a.download = filename;
document.body.appendChild(a);
a.click();
setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 500);
}


function renderQapiEffectivenessReport(){
  const s = Store.load();
  const actions = (s.qapiActions||[]).slice();
  const fromV = document.getElementById("qapiEffFrom")?.value || "";
  const toV = document.getElementById("qapiEffTo")?.value || "";
  const include = document.getElementById("qapiEffInclude")?.value || "all";
  const from = fromV ? new Date(fromV) : null;
  const to = toV ? new Date(toV) : null;

  let rows = actions.filter(a=>{
    const d = a.date || a.createdDate || a.created || "";
    const dt = d ? new Date(d) : null;
    if(from && dt && !isNaN(dt.getTime()) && dt < from) return false;
    if(to && dt && !isNaN(dt.getTime()) && dt > to) return false;
    return true;
  });
  if(include==="closed") rows = rows.filter(a=> (a.status||"Open")==="Closed" || a.isClosed);
  if(include==="open") rows = rows.filter(a=> (a.status||"Open")!=="Closed" && !a.isClosed);

  const counts = { total: rows.length, verified:0, improved:0, nochange:0, worse:0, na:0, missingDue:0 };
  rows.forEach(a=>{
    if((a.verifiedDate||"").trim()) counts.verified++;
    const o = (a.effectOutcome||"").toLowerCase();
    if(o==="improved") counts.improved++;
    else if(o==="no change") counts.nochange++;
    else if(o==="worse") counts.worse++;
    else if(o==="n/a") counts.na++;
    if(!(a.followUpDate||a.dueDate)) counts.missingDue++;
  });
  const pct = (n,d)=> d? Math.round((n/d)*100) : 0;
  const sumEl = document.getElementById("qapiEffSummary");
  if(sumEl){
    sumEl.innerHTML = `
      <div class="row" style="gap:10px; flex-wrap:wrap">
        <span class="pill">Total: <b>${counts.total}</b></span>
        <span class="pill">Verified: <b>${counts.verified}</b> (${pct(counts.verified, counts.total)}%)</span>
        <span class="pill">Improved: <b>${counts.improved}</b></span>
        <span class="pill">No Change: <b>${counts.nochange}</b></span>
        <span class="pill">Worse: <b>${counts.worse}</b></span>
        <span class="pill">N/A: <b>${counts.na}</b></span>
        <span class="pill">Missing Follow-up Date: <b>${counts.missingDue}</b></span>
      </div>`;
  }
  const tb = document.getElementById("qapiEffTbody");
  if(!tb) return;
  tb.innerHTML = rows.map(a=>{
    const status = (a.status|| (a.isClosed ? "Closed" : "Open")) || "Open";
    return `<tr>
      <td>${escapeHtml(a.date||"")}</td>
      <td>${escapeHtml(a.title||a.issue||"")}</td>
      <td>${escapeHtml(a.unit||"")}</td>
      <td>${escapeHtml(a.residentName||"")}</td>
      <td>${escapeHtml(status)}</td>
      <td>${escapeHtml(a.followUpDate||a.dueDate||"")}</td>
      <td>${escapeHtml(a.verifiedDate||"")}</td>
      <td>${escapeHtml(a.effectOutcome||"")}</td>
      <td>${escapeHtml(a.verificationMethod||"")}</td>
    </tr>`;
  }).join("") || `<tr><td colspan="9" class="muted">No actions in range.</td></tr>`;
}
function exportQapiEffectivenessCsv(){
  const s = Store.load();
  const rows = (s.qapiActions||[]).slice();
  const header = ["date","title","unit","residentName","status","followUpDate","verifiedDate","effectOutcome","verificationMethod","verifiedBy"];
  const csv = [header.join(",")].concat(rows.map(a=> header.map(k=>`"${String(a[k]||"").replace(/"/g,'""')}"`).join(","))).join("\n");
  downloadText("qapi_effectiveness.csv", csv, "text/csv");
}
function initQapiEffDates(){
  try{
    const to = new Date();
    const from = new Date(); from.setDate(from.getDate()-30);
    const z = (n)=> String(n).padStart(2,"0");
    const fmt = (d)=> `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;
    const a = document.getElementById("qapiEffFrom"); if(a && !a.value) a.value = fmt(from);
    const b = document.getElementById("qapiEffTo"); if(b && !b.value) b.value = fmt(to);
  }catch(e){}
}



async function doExportEncrypted(){
const s = Store.load();
if(!canAdmin(s)){ alert("Admin only."); return; }
const pw1 = prompt("Set a password for this encrypted backup:");
if(!pw1) return;
const pw2 = prompt("Confirm password:");
if(pw1 !== pw2){ alert("Passwords do not match."); return; }
const pkg = await encryptState(pw1, s);
const fname = `ICN_Compliance_EncryptedBackup_${new Date().toISOString().slice(0,10)}.json`;
downloadText(fname, JSON.stringify(pkg, null, 2));
Store.patch(st=>{ st.ui.lastBackupAt = nowISO(); st.ui.lastBackupFile = fname; });
const bs = document.getElementById("backupStatus");
if(bs) bs.textContent = `Exported: ${fname}`;
}
function normalizeUnitKey(unit){
const u = (unit||"").toString().trim();
if(!u) return "";
if(/^U\d+$/i.test(u)) return u.toUpperCase();
const m = u.match(/(\d+)/);
if(m) return "U" + m[1];
return u.toUpperCase();
}
function normalizeResidentStatus(st){
const s = (st||"").toString().trim().toLowerCase();
if(!s) return "";
if(s==="active" || s==="current") return "Active";
if(s==="discharged" || s==="inactive" || s==="dc") return "Discharged";
if(s.includes("not on current")) return "Discharged";
return s.charAt(0).toUpperCase() + s.slice(1);
}
function normalizeImportedState(s){
if(!s) return;
ensureConfig(s);
ensureIpData(s);
if(!s.census) s.census = {};
if(!s.residentsById) s.residentsById = {};

Object.values(s.residentsById).forEach(r=>{
if(!r) return;
r.room = (r.room||"").toString().trim();
r.name = (r.name||"").toString().trim();
r.mrn = (r.mrn||"").toString().trim();
r.unit = normalizeUnitKey(r.unit||"");
r.status = normalizeResidentStatus(r.status||r.censusStatus||"");
if(r.status==="Active" && !r.lastSeenOnCensus) r.lastSeenOnCensus = r.lastSeenOnCensus || null;
});

if(!Array.isArray(s.config.units) || !s.config.units.length){
const unitKeys = Array.from(new Set(Object.values(s.residentsById).map(r=>r.unit).filter(Boolean)));
s.config.units = unitKeys.sort().map(k=>{
const n = k.replace(/^U/i,"");
return { unitKey:k, unitName:`Unit ${n}`, capacity:0 };
});
} else {
s.config.units.forEach(u=>{
u.unitKey = normalizeUnitKey(u.unitKey||u.key||u.unit||"");
if(!u.unitName) {
const n = u.unitKey.replace(/^U/i,"");
u.unitName = `Unit ${n}`;
}
});
}

const ids = Array.isArray(s.census.activeResidentIds) ? s.census.activeResidentIds.slice() : [];
if(!ids.length){
s.census.activeResidentIds = Object.values(s.residentsById)
.filter(r=> (r.status||"") === "Active")
.map(r=> r.id)
.filter(Boolean);
}

if(s.modules && s.modules.abt && Array.isArray(s.modules.abt.courses)){
s.modules.abt.courses.forEach(c=>{
c.mrn = (c.mrn||"").toString().trim();
c.antibiotic = (c.antibiotic||c.abx||"").toString().trim();
c.startDate = (c.startDate||c.start||"").toString().trim();
c.endDate = (c.endDate||c.end||"").toString().trim();
});
}
}

async function doImportEncrypted(file){
const s0 = Store.load();
if(!canAdmin(s0)){ alert("Admin only."); return; }
const pw = prompt("Enter the password for this backup:");
if(!pw) return;
const txt = await file.text();
let pkg;
try{ pkg = JSON.parse(txt); }catch(e){ alert("Invalid file (not JSON)."); return; }
try{
const restored = await decryptState(pw, pkg);
if(!restored || typeof restored!=="object" || !restored.modules || !restored.residentsById){
alert("Backup decrypted but does not look like a valid tool state.");
return;
}
storageSet(STORE_KEY, JSON.stringify(restored));
const s1 = Store.load();
try{ normalizeImportedState(s1); }catch(e){ console.warn('normalizeImportedState failed', e); }
ensureDefaultUsers(s1);
ensureAudit(s1);
logAction(s1, "Import Encrypted Backup", {file: file.name});
Store.save(s1);
const bs = document.getElementById("backupStatus");
if(bs) bs.textContent = `Imported: ${file.name}`;
safeRenderAll();
}catch(e){
console.error(e);
alert("Could not decrypt (wrong password or corrupted file).");
}
}

function makeResidentId({mrn, unit, room, name}){
const m = (mrn||"").trim();
if(m) return `MRN-${m}`;
const key = `${(unit||"").trim()}|${(room||"").trim()}|${(name||"").trim()}`.toUpperCase();
let h=0; for(let i=0;i<key.length;i++) h=(h*31 + key.charCodeAt(i))>>>0;
return `H-${h.toString(16)}`;
}
function getUnitKeyFromAny(rawUnit, config){
const t = normalizeText(rawUnit);
if(!t) return "";
if(config.unitAliases && config.unitAliases[t]) return config.unitAliases[t];
const u = (config.units||[]).find(x=> normalizeText(x.unitName)===t || normalizeText(x.unitKey)===t);
return u ? u.unitKey : (rawUnit||"");
}
function inferUnitFromRoom(room, config){
const r=(room||"").trim(); const m=r.match(/^(\d)/);
if(!m) return "";
return config.unitAliases?.[m[1]] || "";
}
function normalizeRoomForEdit(v){
const t = (v||"").toString().trim().toUpperCase();
if(!t) return "";
const m = t.match(/^(\d{2,3})\s*-\s*([A-Z])$/);
if(m) return `${m[1]}-${m[2]}`;
return t.replace(/\s+/g,"");
}
function updateParsedEntry(idx, field, value){
if(!window.__lastParsedCensus || !window.__lastParsedCensus[idx]) return;
const e = window.__lastParsedCensus[idx];
if(field==="room"){
e.room = normalizeRoomForEdit(value);
const s = Store.load();
if(!((e.unit||"").trim())){
const u = inferUnitFromRoom(e.room||"", s.config) || "";
if(u) e.unit = u;
}
return;
}
if(field==="name"){ e.name = (value||"").toString().trim().replace(/\s+/g," "); return; }
if(field==="mrn"){ e.mrn = (value||"").toString().trim(); return; }
if(field==="unit"){ e.unit = (value||"").toString().trim(); return; }
if(field==="dob"){ e.dob = (value||"").toString().trim(); return; }
if(field==="payorSource"){ e.payorSource = (value||"").toString().trim().replace(/\s+/g," "); return; }
}

function rekeyResidentId(oldId, newId){
if(!oldId || !newId || oldId===newId) return;
Store.patch(s=>{
if(!s.residentsById[oldId]) return;

const src = s.residentsById[oldId];
const dst = s.residentsById[newId] || { id:newId, createdAt: src.createdAt || nowISO() };

const merged = {...src, ...dst};
merged.id = newId;

const a = Array.isArray(dst.profileNotesLog) ? dst.profileNotesLog : [];
const b = Array.isArray(src.profileNotesLog) ? src.profileNotesLog : [];
merged.profileNotesLog = [...b, ...a];

s.residentsById[newId] = merged;
delete s.residentsById[oldId];

if(Array.isArray(s.census.activeResidentIds)){
s.census.activeResidentIds = s.census.activeResidentIds.map(x=> x===oldId ? newId : x);
}
if(s.ui.selectedResidentId===oldId) s.ui.selectedResidentId = newId;

(s.modules.abt.courses||[]).forEach(c=>{ if(c.residentId===oldId) c.residentId=newId; });
(s.modules.ip.precautions||[]).forEach(p=>{ if(p.residentId===oldId) p.residentId=newId; });
(s.modules.vax.events||[]).forEach(v=>{ if(v.residentId===oldId) v.residentId=newId; });
});
}

function openResidentEditModal(residentId){
const s = Store.load();
const r = s.residentsById[residentId];
if(!r){ alert("Resident not found."); return; }

const isDis = r.status && r.status!=="active";
const room = isDis ? (r.lockedRoom||r.room||"") : (r.room||"");
const unit = isDis ? (r.lockedUnit||r.unit||"") : (r.unit||"");

openModal("Edit Resident", `
<div class="muted mini">For discharged residents, Room/Unit edits update the locked historical location.</div>
<div class="sep"></div>
<div class="grid cols2">
<div>
<label>Name</label>
<input id="editR_name" type="text" value="${escapeHtml(r.name||"")}"/>
</div>
<div>
<label>MRN</label>
<input id="editR_mrn" type="text" value="${escapeHtml(r.mrn||"")}"/>
<div class="muted mini" style="margin-top:6px">If this residentId is MRN-based, changing MRN will re-key and update ABT/IP/Vax links.</div>
</div>
</div>
<div class="grid cols3" style="margin-top:10px">
<div>
<label>Room</label>
<input id="editR_room" type="text" value="${escapeHtml(room)}"/>
</div>
<div>
<label>Unit</label>
<input id="editR_unit" type="text" value="${escapeHtml(unit)}"/>
</div>
<div>
<label>DOB</label>
<input id="editR_dob" type="text" value="${escapeHtml(r.dob||"")}"/>
</div>
</div>
<div style="margin-top:10px">
<label>Payor Source</label>
<input id="editR_payor" type="text" value="${escapeHtml(r.payorSource||"")}"/>
</div>
<div class="sep"></div>
<div class="row end">
<button class="btn" onclick="closeModal()">Cancel</button>
<button class="btn primary" onclick="saveResidentEdits('${escapeHtml(residentId)}')">Save</button>
</div>
`);
}

window.saveResidentEdits = function(residentId){
const name = (document.getElementById("editR_name").value||"").trim().replace(/\s+/g," ");
const mrn  = (document.getElementById("editR_mrn").value||"").trim();
const room = normalizeRoomForEdit(document.getElementById("editR_room").value||"");
const unit = (document.getElementById("editR_unit").value||"").trim();
const dob  = (document.getElementById("editR_dob").value||"").trim();
const pay  = (document.getElementById("editR_payor").value||"").trim().replace(/\s+/g," ");

const s0 = Store.load();
const r0 = s0.residentsById[residentId];
if(!r0){ alert("Resident not found."); return; }

if(mrn && residentId.startsWith("MRN-")){
const newId = "MRN-" + mrn;
if(newId !== residentId){
rekeyResidentId(residentId, newId);
residentId = newId;
}
}

Store.patch(s=>{
const r = s.residentsById[residentId];
if(!r) return;
r.name = name || r.name || "";
r.mrn  = mrn  || r.mrn  || "";
r.dob  = dob  || r.dob  || "";
r.payorSource = pay || r.payorSource || "";

const isDis = r.status && r.status!=="active";
if(isDis){
if(room) r.lockedRoom = room;
if(unit) r.lockedUnit = unit;
} else {
if(room) r.room = room;
if(unit) r.unit = unit;
}
r.updatedAt = nowISO();
});

closeModal();
};

function parseCensusRaw(raw){
const cfg = Store.load().config;
const lines = (raw||"").split(/\r?\n/);
const entries = [];

const roomRe = /^(\d{2,3})(?:\s*-\s*[A-Z])?$/i;         // 251 or 251-B
const roomRe2 = /^(\d{2,3})\s*-\s*([A-Z])$/i;          // 251-B (normalize spacing)
const dobRe = /^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/;     // 5/2/1960

const badStarts = [
"DATE:", "TIME:", "USER:", "UNIT:", "FLOOR:", "FACILITY", "PAGE", "CENSUS", "ROOM-BED", "CARE LEVEL",
"RESIDENT", "STATUS", "PAYOR", "BED", "CERTIFICATION"
];

function normalizeRoom(s){
const t = (s||"").toString().trim();
const m = t.match(roomRe2);
if(m) return `${m[1]}-${m[2].toUpperCase()}`;
return t.replace(/\s+/g,"").toUpperCase();
}

function looksLikeHeader(line){
const t = (line||"").toString().trim().toUpperCase();
if(!t) return true;
for(const b of badStarts){
if(t.startsWith(b)) return true;
}
if(t.includes("LONG BEACH NURSING") || t.includes("REHABILITATION CENTER")) return true;
if(t.includes("REPORT") && t.includes("CENSUS")) return true;
return false;
}

const payorTokens = [
"MEDICARE", "MEDICAID", "HMO", "MANAGED", "PRIVATE", "COMMERCIAL", "BCBS", "AETNA", "UNITED",
"HUMANA", "CIGNA", "KAISER", "TRICARE", "SELF PAY"
];
function extractPayor(cols){
for(const c of cols){
const t = (c||"").toString().trim();
if(!t) continue;
const u = t.toUpperCase();
if(payorTokens.some(p=>u.includes(p))) return t;
}
return "";
}

for(const rawLine of lines){
const line = (rawLine||"").toString();
if(!line.trim()) continue;

if(!line.includes("\t")) continue;

if(looksLikeHeader(line)) continue;

const cols = line.split("\t").map(x=>x.trim());
if(cols.length < 2) continue;

const roomRaw = cols[0] || "";
const room = normalizeRoom(roomRaw);
if(!room) continue;

const roomCore = room.split("-")[0];
if(!roomRe.test(room) && !/^\d{2,3}$/i.test(roomCore)) continue;

const nameCol = (cols[1]||"").trim();
if(!nameCol) continue;

const mrnMatch = nameCol.match(/\(([^)]+)\)/);
const mrn = mrnMatch ? mrnMatch[1].trim() : "";

const looksLikeName = /,/.test(nameCol) && /[A-Z]/i.test(nameCol);
if(!mrn && !looksLikeName) continue;

const name = nameCol.replace(/\s*\([^)]*\)\s*/g,"").trim();

const dobCand = (cols[2]||"").trim();
const dob = dobRe.test(dobCand) ? dobCand : "";

const status = (cols[3]||"").trim();

const unit = inferUnitFromRoom(room, cfg) || "";

const payorSource = extractPayor(cols);

entries.push({ name, mrn, room, unit, dob, status, payorSource, rawCols: cols });
}

const seen = new Set();
const out = [];
for(const e of entries){
const key = e.mrn ? `MRN:${e.mrn}` : `NR:${(e.name||"").toUpperCase()}|${e.room}`;
if(seen.has(key)) continue;
seen.add(key);
out.push(e);
}
return out;
}

// --- Census History Snapshots (PATCH: patient-days auto-calc) ---
function recordDailyCensusSnapshot(entries){
  try{
    const d = new Date();
    const dateKey = d.toISOString().slice(0,10);
    const unitCounts = {};
    let total = 0;
    (entries||[]).forEach(e=>{
      if(!e) return;
      const u = (e.unit||"").toString().trim() || "Unassigned";
      unitCounts[u] = (unitCounts[u]||0) + 1;
      total += 1;
    });
    Store.patch(s=>{
      s.censusHistory = s.censusHistory || [];
      // Upsert by dateKey
      const idx = s.censusHistory.findIndex(x=>x && x.date===dateKey);
      const snap = { date: dateKey, unitCounts, total, updatedAt: new Date().toISOString() };
      if(idx>=0) s.censusHistory[idx] = snap;
      else s.censusHistory.push(snap);
      // Keep last 120 days max to avoid bloat
      if(s.censusHistory.length > 120){
        s.censusHistory = s.censusHistory.slice(s.censusHistory.length-120);
      }
    });
  }catch(e){ /* silent */ }
}

function applyCensus(entries, rawText){
Store.patch(s=>{
const seen = new Set();
s.census.rawText = rawText || "";
s.census.lastPastedAt = nowISO();

for(const e of entries){
const id = makeResidentId(e);
seen.add(id);

const r = s.residentsById[id] || { id, createdAt: nowISO() };

r.name = e.name || r.name || "";
r.mrn  = e.mrn  || r.mrn  || "";

if(e.room) r.room = e.room;
if(e.unit) r.unit = e.unit;

if(e.dob) r.dob = e.dob;
if(e.payorSource) r.payorSource = e.payorSource;
if(e.status) r.censusStatus = e.status;

r.status = "active";
r.lastSeenOnCensus = nowISO();
r.dischargedAt = null;
r.lockedRoom = null;
r.lockedUnit = null;

s.residentsById[id] = r;
}

for(const id of Object.keys(s.residentsById)){
const r = s.residentsById[id];
if(r.status === "active" && !seen.has(id)){
r.status = "discharged";
r.dischargedAt = nowISO();
r.lockedRoom = r.room || "";
r.lockedUnit = r.unit || "";
}
}

s.census.activeResidentIds = Array.from(seen);
// Phase4: reconcile precautions against updated resident census
try{ reconcileIpPrecautions(s); }catch(e){}
});
}

function mapLegacyToNew(legacy, mode){
const exportedAt = legacy?.exportedAt || legacy?.payload?.updatedAt || nowISO();
const payload = legacy?.payload || legacy;
const residentsById = payload?.residentsById || {};
const census = payload?.census || {};
const legacyModules = payload?.modules || {};
const ipCases = legacyModules?.ip?.cases || [];
const abtCourses = legacyModules?.abt?.courses || [];
const vaxEvents = legacyModules?.vax?.events || [];

Store.patch(s=>{
if(mode==="replace"){
const fresh = Store.defaults();
fresh.config = s.config;
s = fresh;
}

for(const [rid, r] of Object.entries(residentsById)){
if(!r) continue;
const mrn = (r.mrn||"").toString().trim();
const id = (r.id && String(r.id)) || (mrn ? `MRN-${mrn}` : rid);
const unitKey = getUnitKeyFromAny(r.unit, s.config) || inferUnitFromRoom(r.room, s.config) || "";
const status = (String(r.status||"").toLowerCase()==="discharged") ? "discharged" : "active";
const out = s.residentsById[id] || { id, createdAt: r.createdAt || exportedAt };
out.name = r.name || out.name || "";
out.mrn = mrn || out.mrn || "";
out.room = r.room || out.room || "";
out.unit = unitKey || out.unit || "";
out.dob = isoToMDY(r.dob || out.dob || "");
out.status = status;
out.updatedAt = r.updatedAt || exportedAt;
out.lastSeenOnCensus = r.lastSeenOnCensus || null;
if(status==="discharged"){
out.lockedRoom = r.room || out.room || "";
out.lockedUnit = unitKey || out.unit || "";
out.dischargedAt = r.dischargeDate || r.updatedAt || exportedAt;
}
const legacyNotes = (r.notes||"").toString().trim();
if(legacyNotes){
if(!Array.isArray(out.profileNotesLog)) out.profileNotesLog = [];
const already = out.profileNotesLog.some(n => (n?.text||"").trim() === legacyNotes);
if(!already){
out.profileNotesLog.unshift({ id: uid("note"), createdAt: exportedAt, author: "Legacy Import", text: legacyNotes });
}
}
s.residentsById[id] = out;
}

const legacyActiveIds = Array.isArray(census.activeResidentIds) ? census.activeResidentIds : [];
s.census.activeResidentIds = legacyActiveIds.filter(x=>typeof x==="string" && s.residentsById[x]);
s.census.rawText = census.rawText || s.census.rawText || "";
s.census.lastPastedAt = census.lastPastedAt || s.census.lastPastedAt || null;

const existingAbtIds = new Set((s.modules.abt.courses||[]).map(c=>String(c.id||"")));
for(const c of abtCourses){
if(!c) continue;
const id = String(c.id||"") || uid("abt");
if(existingAbtIds.has(id)) continue;
const unitKey = getUnitKeyFromAny(c.unit, s.config) || inferUnitFromRoom(c.room, s.config) || "";
s.modules.abt.courses.push({
id,
residentId: c.residentId || (c.mrn ? `MRN-${c.mrn}` : ""),
residentName: c.residentName || "",
mrn: (c.mrn||"").toString(),
unit: unitKey || "",
room: c.room || "",
dob: isoToMDY(c.dob || ""),
antibiotic: c.antibiotic || "",
abxClass: c.klass || c.class || "",
startDate: isoToMDY(c.startDate || ""),
endDate: isoToMDY(c.endDate || ""),
route: c.route || "",
indication: c.indication || c.reason || "",
infectionSource: c.infectionSource || c.infectedSource || c.source || "",
createdAt: c.createdAt || exportedAt,
updatedAt: c.updatedAt || exportedAt
});
existingAbtIds.add(id);
}

const existingPrecIds = new Set((s.modules.ip.precautions||[]).map(p=>String(p.id||"")));
for(const ca of ipCases){
if(!ca) continue;
const id = String(ca.id||"") || uid("prec");
if(existingPrecIds.has(id)) continue;
const unitKey = getUnitKeyFromAny(ca.unit, s.config) || inferUnitFromRoom(ca.room, s.config) || "";
const active = (String(ca.status||"").toUpperCase()==="ACTIVE") || (String(ca.caseStatus||"").toUpperCase()==="ACTIVE");
const precType = String(ca.precautionType||"").toUpperCase();
let type = "Isolation - Other";
if(precType==="EBP") type = "Enhanced Barrier Precautions (EBP)";
else if(precType==="ISOLATION") type = ca.isolationType ? `Isolation - ${ca.isolationType}` : "Isolation - Other";
else if(precType) type = precType;
s.modules.ip.precautions.push({
id,
residentId: ca.residentId || (ca.mrn ? `MRN-${ca.mrn}` : ""),
residentName: ca.residentName || "",
unit: unitKey || "",
room: ca.room || ca.lockedRoom || "",
type,
infectedSource: ca.sourceCondition || ca.isolationType || "",
startDate: isoToMDY(ca.onsetDate || ""),
endDate: isoToMDY(ca.resolutionDate || ""),
status: active ? "active" : "resolved",
createdAt: ca.createdAt || exportedAt,
updatedAt: ca.updatedAt || exportedAt
});

// Also seed Line Listing / Outbreak cases from legacy ip.cases (source of truth)
try{
  const ll = s.modules.ip.lineListCases || (s.modules.ip.lineListCases = []);
  const llId = String(ca.caseId||ca.id||"") || uid("case");
  const exists = ll.some(x=>String(x.id||"")===llId);
  if(!exists){
    const kind = String(ca.kind||ca.category||ca.type||"resp").toLowerCase();
    const normKind = (kind.includes("gi") ? "gi" : (kind.includes("resp") ? "resp" : "other"));
    ll.push({
      id: llId,
      kind: normKind,
      residentId: ca.residentId || (ca.mrn ? `MRN-${ca.mrn}` : ""),
      name: ca.residentName || ca.name || "",
      mrn: (ca.mrn||"").toString().trim(),
      unit: unitKey || "",
      room: (ca.room||"").toString().trim(),
      status: active ? "active" : (String(ca.status||ca.caseStatus||"").toLowerCase() || "active"),
      onsetDate: ca.onsetDate || ca.startDate || ca.date || "",
      specimenDate: ca.specimenDate || "",
      testDate: ca.testDate || "",
      testType: ca.testType || "",
      result: ca.result || ca.testResult || "",
      notes: ca.notes || "",
      createdAt: ca.createdAt || exportedAt
    });
  }
}catch(e){}


existingPrecIds.add(id);
}

const existingVaxIds = new Set((s.modules.vax.events||[]).map(e=>String(e.id||"")));
for(const e of vaxEvents){
if(!e) continue;
const rawId = String(e.id||"");
const id = rawId ? `vax_${rawId}` : uid("vax");
if(existingVaxIds.has(id)) continue;
const mrn = (e.mrn||"").toString().trim();
const residentId = mrn ? `MRN-${mrn}` : "";
const unitKey = getUnitKeyFromAny(e.unit, s.config) || inferUnitFromRoom(e.roomNumber, s.config) || "";
s.modules.vax.events.push({
id,
batchId: e.batchId || "",
residentId,
mrn,
residentName: e.patientName || "",
room: e.roomNumber || "",
unit: unitKey || "",
dob: isoToMDY(e.dateOfBirth || ""),
status: (e.status||"").toLowerCase() || "vaccinated",
vaccineType: e.vaccineType || "Other",
date: isoToMDY(e.date || ""),
notes: e.notes || "",
createdAt: e.createdAt || exportedAt,
updatedAt: e.updatedAt || exportedAt
});
existingVaxIds.add(id);
}

storageSet(STORE_KEY, JSON.stringify(s));
});
}

// --- Smart import detector (accepts legacy wrapper exports) ---
function isLegacyLikeImport(obj){
  try{
    if(!obj || typeof obj!=="object") return false;
    // Legacy wrapper format: { exportedAt, app, schemaVersion, payload:{...} }
    if(obj.payload && (obj.exportedAt || obj.app || obj.schemaVersion)) return true;
    const payload = obj.payload || obj;
    // If it's already this build backup, it should have a numeric schema
    if(Object.prototype.hasOwnProperty.call(payload, 'schema')) return false;
    const mods = payload.modules || null;
    if(mods && mods.ip && Array.isArray(mods.ip.cases)) return true;
    // Some older merged exports may keep ip cases at top-level
    if(payload.ip && Array.isArray(payload.ip.cases)) return true;
    return false;
  }catch(e){ return false; }
}


function openModal(title, html){
  try{
    must("modalTitle").textContent = String(title||"");
    must("modalBody").innerHTML = String(html||"");
    must("modalBack").style.display = "flex";
  }catch(e){ /* toastSafe already fired */ }
}
function closeModal(){
  try{ const mb = document.getElementById("modalBack"); if(mb) mb.style.display = "none"; }catch(e){}
}// =========================
const APP_VERSION = "V1.16.4";
const APP_BUILD_DATE = "2026-01-17";
const APP_VERSION_HISTORY = [
{ version:"Phase 6 Step 2 — Smart Restore (file picker + legacy wrapper auto-map) — WORKING", date:"2026-01-17", notes:["Import Backup JSON now accepts file uploads (no copy/paste needed).","Auto-detects legacy wrapper exports and maps them via Legacy Import logic when pasted into Restore.","Reduces empty-tab issues after restore by ensuring schema-consistent state." ]},

{ version:"Phase 5 Step 3 — Buttons Reliability Fix (packetExport/import) — WORKING", date:"2026-01-17", notes:["Fixed non-working Survey Packet buttons by restoring missing functions: packetExport() + packetGetSettings() + packetBackupImportGo().","Prevents silent button failures due to missing handlers."]},

{ version:"Phase 5 Step 3 — IP Data Populate Fix (Legacy ip.cases → lineListCases) — WORKING", date:"2026-01-17", notes:["Fixed IP views not populating by seeding modules.ip.lineListCases from imported legacy modules.ip.cases during JSON import.","Maintains single source of truth for Contact Tracing + Line Listing + Precautions from imported case data."]},

{ version:"Phase 5 Step 3 — Follow-up Effectiveness + Verification Reporting — WORKING", date:"2026-01-17", notes:["Added Effectiveness & Verification fields to QAPI Actions (Outcome, Verified By/Date, Method, Evidence).","Added QAPI Effectiveness Summary report with date range + CSV export.","Improves survey readiness: closed-loop QAPI evidence."]},

{ version:"Phase 5 Step 2 — QAPI Auto-Flag Runner + ABT Parse Header Fix — WORKING", date:"2026-01-16", notes:["Added qapiRunAutoFlags compatibility wrapper to prevent missing-function errors.","Removed legacy python stub tokens (Exception/except) that break JS parsing.","Fixed ABT parsed table header alignment + sticky thead + column widths for survey-safe readability."]},

{ version:"Phase 5 Step 2 — Vax Room Fix + Search Filters + Unit 2/3/4 Standardization — WORKING", date:"2026-01-16", notes:["Vaccination events now populate room from census room fallbacks (roomNumber etc).","Added search boxes to filter lists by Name/MRN/Room in each tracker tab.","Standardized unit display to Unit 2/Unit 3/Unit 4 where possible."]},

{ version:"Phase 5 Step 2.x — Resident Picker Standardization + Profile Quick Add — WORKING", date:"2026-01-16", notes:["Standardized resident picker across IP Line List, Outbreak Case-first, Vaccination (wrapper), and new Precaution add modal.","Enforced census-based selection (auto-populates identifiers; blocks manual entry).","Added Resident Profile Quick Add buttons: Add Vax, Add Line List Case, Add Outbreak Case, Add Precaution (deep-links)."]},

{ version:"Phase 5 Step 2 — Follow-up & Effectiveness — WORKING", date:"2026-01-16", notes:["Added 7/30/90-day follow-up schedule to each QAPI action.","Added effectiveness status + note for outcome tracking.","Added Follow-up Due Report (next 30 days) for weekly/monthly huddles and QAPI prep."]},

{ version:"Phase 5 Step 1 — QAPI Action Center (Auto-Flag + Action Tracking) — WORKING", date:"2026-01-16", notes:["Added QAPI Actions tab with action lifecycle (Open/In Progress/Complete) and exports (Print/CSV).","Added Auto-Flag engine (missing case fields, prolonged precautions, missing contact tracing) with optional suggestion modal.","Added dashboard widget showing open/overdue actions and quick access."]},

{ version:"Phase 4 Step 6 — Role-based Views (Admin/Staff/Surveyor) — WORKING", date:"2026-01-16", notes:["Added role selector and enforcement: Admin/Staff/Surveyor modes.","Surveyor mode hides Admin tab, disables editing controls, and defaults packet exports to de-identified.","Role changes logged to Audit Trail."]},

{ version:"Phase 4 Step 5 — Packet Backup + Checklist (Encrypted) — WORKING", date:"2026-01-16", notes:["Added encrypted JSON backup/restore for Packet Runs + Audit Log (AES-GCM + PBKDF2).","Added Survey Packet Checklist print page (survey-ready).","Audit trail records backup/export/restore and checklist printing."]},

{ version:"Phase 4 Step 4 — Packet Builder + Audit Log + QAPI Snapshot — WORKING", date:"2026-01-16", notes:["Added packet presets, saved runs, and local audit log for QA traceability.","Added QAPI Snapshot (counts + cases/1000 patient days) with print + CSV export.","All packet exports now write to the audit trail."]},

{ version:"Phase 4 Step 2 — Outbreak Enhancements (Edit/Delete + Exposure Window + Packet Page) — WORKING", date:"2026-01-16", notes:["Added Edit/Delete case workflow with safe persistence and linked contact cleanup.","Contacts now include exposure window based on onset date (configurable back/forward days).","Added Packet Page print (Line Listing + Contact Tracing) for survey-ready exports."]},

{ version:"Phase 4 Step 2 — Outbreak Engine UI wiring fix — WORKING", date:"2026-01-16", notes:["Added IP subtab button + container for Outbreak view and wired setIpView to show it.","Updated Outbreak renderer to write into ipView_outbreak (matches existing IP UI pattern).","Contact Tracing now respects ctCaseFilter when opened from a case."]},

{ version:"Phase 4 Step 2 — Outbreak Engine (Case-first) — WORKING", date:"2026-01-16", notes:["Added Outbreak (Case-first) IP view with Add Case flow.","Auto-generate Contact Tracing contacts from census proximity (same room/same unit) and link by caseId.","Line Listing print template generated from the same case records (modules.ip.lineListCases)."]},

{ version:"Phase 4 Step 1 — LOCKED Baseline (Preflight Linter Guardrail)", date:"2026-01-16", notes:["Locked Phase 4 Step 1 baseline with Preflight Linter guardrail (brace/template/string checks) to prevent syntax regressions.","This is the approved starting point for Phase 4 Step 2 (Outbreak Engine — Case-first)."]},

{ version:"v1.63 QAPI Locked Patch — Facility-wide Patient Days", date:"2026-01-16", notes:[
"Patient-days are calculated facility-wide only (no unit filtering).",
"Rates derive from censusHistory total (7-day window) when available; fallback to manual Config value.",
"Compliance Dashboard unit selector hidden to prevent confusion."
]},
{ version:"v1.63 QAPI Locked Patch — Census Snapshot Auto Patient-Days", date:"2026-01-16", notes:[
"Auto-stores daily census snapshots on Apply Census (date + unit counts + total).",
"Compliance Dashboard can now derive patient-days from stored census history (7-day window).",
"Added safe retention cap (keeps last 120 days) to prevent localStorage bloat."
]},
{ version:"Phase 4 Step 1 — Reporting Reliability Sweep (Precautions + Printing)", date:"2026-01-16", notes:[
"Precaution list population reconciled across imported JSON + current census (resident/unit/room backfill).",
"Daily Active Precaution List print now uses unified reconciled source of truth.",
"Added Isolation/Precaution Signage print set (one page per active resident).",
"Precautions print + CSV export share the same reconciled row generator."
]},
{ version:"V1.16.3", date:"2026-01-16", notes:[
"Fix: Precaution Listing print now pulls active precautions reliably (status case-insensitive + auto-fill name/room/unit from resident DB).",
"Reports: added Export CSV to Unit Precaution Listing print setup and ensured Surveyor Packet ‘Unit Precaution Listing’ section populates."
]},
{ version:"V1.16.1", date:"2026-01-16", notes:[
"Deep cleanup sweep: reduced internal comments/whitespace to keep file size smaller and removed noisy debug logging while preserving functionality."
]},
{ version:"V1.16.0", date:"2026-01-16", notes:[
"Stability sweep: hardened tab navigation (prevents blank screens by detecting missing tabs), auto-hides nav items that don’t exist in the build, and added a lightweight in-app Health Check for quick troubleshooting.",
"No new dependencies; focused on reliability and keeping file size small."
]},
{ version:"V1.15.8.1", date:"2026-01-16", notes:[
"Hotfix: fixed tab switching so Report Center and other tabpane sections render (setTab now toggles both .tab and .tabpane)."
]},
{ version:"V1.15.8.0", date:"2026-01-16", notes:[
"Report Center upgrade: added Outbreak Packet printing (Resp/GI + unit + date window) and Case Roster CSV export for rapid reporting.",
"Added Syndrome filter to Report Center (kept lightweight; no new dependencies)."
]},
{ version:"V1.15.7.1", date:"2026-01-16", notes:[
"Dashboard layout fix: enforced two-column Dashboard on desktop/tablet widths (Facility Snapshot left; Resident Snapshot + Situation Board right) without leaving an empty right panel."
]},
{ version:"V1.15.7.0", date:"2026-01-16", notes:[
"Outbreak printing upgrade: Case Drilldown modal now includes ‘Print Outbreak Packet’ (bundles case list + exposure events + linked roster per case).",
"Lightweight implementation: reuses existing print window and stored case/contact/event data (no new dependencies)."
]},
{ version:"V1.15.6.0", date:"2026-01-16", notes:[
"Vaccination Tracker upgrade: added per-row Edit/Delete controls, duplicate protection on Add/Save (same resident + type + date + status), and audit logging for edits/deletes.",
"Vax table now includes an Actions column while preserving existing report outputs (kept lightweight)."
]},
{ version:"V1.15.5.0", date:"2026-01-16", notes:[
"Import compatibility: added legacy state normalizer (unit keys, resident status casing, rebuild active census list) so building and per-unit census counts populate after importing older JSON backups.",
"Import process now runs a post-restore rebuild step (non-destructive) for consistent reporting."
]},
{ version:"V1.15.4.3", date:"2026-01-16", notes:[
"Hotfix: fixed Dashboard two-column layout wrapper so content no longer collapses into a single left column."
]},
{ version:"V1.15.4.2", date:"2026-01-16", notes:[
"Hotfix: restored Dashboard two-column layout on desktop (Facility Snapshot left; Resident Snapshot + Situation Board right)."
]},
{ version:"V1.15.4.1", date:"2026-01-16", notes:[
"Hotfix: restored ABT import summary (moved inside apply function) and fixed Floor Map crash by adding missing ensureConfig()."
]},
{ version:"V1.15.4.0", date:"2026-01-16", notes:[
"Added Backup Reminder banner ribbon under the header: shows last backup status, offers ‘Backup Now’, and provides a settings icon to configure reminder frequency.",
"Export Encrypted Backup now stamps ‘Last Backup’ in-app for overdue detection (no external dependencies)."
]},
{ version:"V1.15.3.0", date:"2026-01-16", notes:[
"ABT import safeguard: parsed preview now flags potential duplicates against the ABT long log before applying (duplicate rows are marked and will be skipped).",
"ABT course editing upgraded: added Delete capability (with audit logging) and improved post-import summary (added vs skipped duplicates vs not selected)."
]},
{ version:"V1.15.2.0", date:"2026-01-16", notes:[
"Added one-click ‘Generate Contact Records’ from an Exposure Event (auto-creates resident/staff/visitor monitoring/testing rows linked to the case).",
"Duplicate-safe generation + uses Case Workspace plan defaults (monitoring/test due) while keeping manual edit control."
]},
{ version:"V1.15.1.0", date:"2026-01-16", notes:[
"Added Case Exposure Events: log where/when/activity and link multiple residents/staff/visitors to a case (built for outbreak investigations).",
"Case Workspace now includes an Exposure Events timeline + one-click Appendix print (events + linked roster) for survey-ready contact tracing."
]},
{ version:"V1.15.0.2", date:"2026-01-16", notes:[
"Contact tracing linkage upgrade: added a ‘Linkage Note’ field when linking a resident/staff/visitor to a case (reason/purpose of the linkage).",
"Linkage Note now appears in Case Workspace tables and exports for survey-ready outbreak documentation."
]},
{ version:"V1.15.0.1", date:"2026-01-16", notes:[
"Dashboard layout upgrade: split into a two-column grid (Facility Snapshot left; Resident Snapshot + Situation Board right) for better use of widescreen space.",
"Mobile layout remains single-column for readability."
]},
{ version:"V1.15.0", date:"2026-01-16", notes:[
"Added Floor Map (heatmap) view: per-unit room grid showing occupied/empty and key risk markers (precautions, active cases, active antibiotics).",
"Added Floor Map config (paste room lists per unit), room drilldown, and Print Floor Map."
]},
{ version:"V1.14.3.2", date:"2026-01-16", notes:[
"Added quick-jump search inside the “More” menu (type to filter; press Enter to open) for faster navigation on mobile.",
"Made the “More” menu scroll-safe with a max height so it never covers the whole screen."
]},
{ version:"V1.14.3.1", date:"2026-01-16", notes:[
"Fixed iPhone/iOS dropdown rendering for the “More” menu by forcing an opaque background and stronger stacking (no transparency bleed-through)."
]},
{ version:"V1.14.3", date:"2026-01-16", notes:[
"Navigation cleanup: reduced top nav clutter by grouping secondary modules under a “More” menu (Census, ABT, Vax, Surveillance, Comms, Decision Log, Staffing, Environment, Data, Config).",
"Added responsive “More” menu behavior (click to open/close, click outside to close) without changing module content."
]},
{ version:"V1.14.2.1", date:"2026-01-16", notes:[
"Fixed Audit Hub rendering (resolved a duplicate variable declaration that could disable all buttons)."
]},
{ version:"V1.14.2", date:"2026-01-16", notes:[
"Upgraded Contact Tracing: added Case Workspace (index case plan, exposure window, monitoring/testing due dates, cohorting notes) and per-case contact list with Print + CSV.",
"IP line list ‘Contacts’ button now opens the Case Workspace for a 2-click workflow (case → contacts → actions)."
]},
{ version:"V1.14.1", date:"2026-01-16", notes:[
"Added Environmental & Equipment Controls: enhanced cleaning tracker, shared equipment cleaning log, and PPE supply par-level panel.",
"Situation Board now supports environment/equipment alerts (active enhanced cleaning, overdue equipment cleaning, low supplies) with drilldowns + Print/CSV."
]},
{ version:"V1.14.0", date:"2026-01-16", notes:[
"Added Staffing & Exposure Tracker: staff illness log (symptoms/tests/return-to-work) with filters, Print + CSV export, and audit logging.",
"Situation Board now supports staff illness alerts with clickable drilldowns and one-click Convert → Action Item."
]},
{ version:"V1.13.9", date:"2026-01-16", notes:[
"Audit Hub close-the-loop upgrade: selectable rows + bulk actions (Create Action Item from selected audits; Mark follow-up done).",
"Added follow-up status tracking for noncompliant audits and a filter to show follow-up backlog."
]},
{ version:"V1.13.8", date:"2026-01-16", notes:[
"Added Rapid Audit Rounds: start a 10‑observation (or custom) round for HH/PPE/Isolation/EBP/Cleaning with fast entry and one‑click batch save.",
"Added printable blank round sheet (for paper rounds) and kept exports/filters consistent with the Audit Hub."
]},
{ version:"V1.13.7", date:"2026-01-16", notes:[
"Added audit triggers to the Situation Board (PPE/HH/Isolation/EBP/Cleaning compliance thresholds in last 7 days) with clickable drilldowns and Convert → Action Item.",
"Added Audit Drilldown modal (filtered list) with Print + CSV export for quick follow-up."
]},
{ version:"V1.13.6", date:"2026-01-16", notes:[
"Added Audit Hub: log and filter infection-control audits (hand hygiene, PPE, isolation/EBP, cleaning) with Print + CSV export.",
"Added Reports button to print the Audit Hub list, and added Surveyor Packet option to include Audit Hub entries."
]},
{ version:"V1.13.5", date:"2026-01-16", notes:[
"Added Report Walkthrough: a clickable guide (modal) that shows exactly how to generate each report (Leadership, Surveyor Packet, QAPI, ABT, Vax, CSV bundle).",
"Placed a Help button directly in the Reports tab and linked the same guide from About → Reports for quick access."
]},
{ version:"V1.13.4.2", date:"2026-01-16", notes:[
"Hard fix: repaired a broken function header in Report Center script that could prevent all buttons from working."
]},
{ version:"V1.13.4.1", date:"2026-01-16", notes:[
"Fixed ABT suggestion + Create IP Case buttons (resolved a template-string syntax issue that could disable button handlers)."
]},
{ version:"V1.13.4", date:"2026-01-16", notes:[
"ABT workflow upgraded: added “Review Suggestions” and per-row “Create IP Case” when Line Listing is Respiratory or GI.",
"ABT → IP linkage: one-click prefilled IP line list case from ABT course (resident, MRN, room/unit, onset from ABT start date, antibiotic info).",
"ABT Suggestions modal lists all flagged Respiratory/GI ABT courses, checks if an active IP case already exists, and supports Print/CSV."
]},
{ version:"V1.13.3", date:"2026-01-16", notes:[
"Expanded Situation Board to include ABT Active + ABT SOC gaps and vaccine pending counts (today/week) with quick buttons.",
"Added new smart alerts for ABT SOC gaps and vaccine pending due items, with drilldown modals and Print/CSV export.",
"Report Center ABT/Vax wiring remains the source of truth; SOC stays value-only (gap-focused)."
]},
{ version:"V1.13.2", date:"2026-01-16", notes:[
"Expanded Report Center: added ABT reports (Active Antibiotics print, ABT SOC gap list, ABT CSV export) and vaccination outputs (weekly/due/matrix prints + vax CSV export).",
"Added value-only SOC summary report focused on antibiotic stewardship documentation gaps (no duplicate reports).",
"Surveyor Packet Builder can now optionally include ABT Active Antibiotics and a Vaccination Snapshot section."
]},
{ version:"V1.13.1", date:"2026-01-16", notes:[
"Surveyor Packet printing upgraded: added cover page + table of contents + consistent headers/footers per section page for a true bundle-style packet."
]},
{ version:"V1.13.0", date:"2026-01-16", notes:[
"Built the Infection Prevention Command Center front page (Situation Board): outbreak status, syndromes, isolation counts, ABT signal, and smart alerts.",
"Alerts are clickable drilldowns (auto-filtering by unit/date window) and auto-open resident/case lists with Print + Export CSV.",
"Added Unit Active Precaution Listing print template (exact unit sheet) with Unit/Date/Shift setup and unit names printed as “Unit 2/3/4”.",
"Added Surveillance Dashboard (7/14/28-day trends + threshold triggers) with clickable drilldowns.",
"Added IP Testing/Labs Tracker (ordered/collected/resulted workflow, retest due, communication tracking) + Situation Board testing alerts.",
"Added Communications Center and Action Plan/Decision Log (actions, decisions, stop rules) with Print + Export CSV.",
"Added 1-click “Convert Alert → Action Item” (prefilled unit/priority/rationale) + auto-open for editing.",
"Added Report Center: Leadership Update, Surveyor Packet Builder, QAPI Weekly Summary, and CSV bundle exports."
]},
{ version:"V1.12.2", date:"2026-01-16", notes:[
"Added About button + modal (version history, capabilities, reports, guidance references).",
"Modular render baseline (stability) + continuing IP build-out."
]},
{ version:"V1.12.0", date:"2026-01-14", notes:[
"Improved stability so the tool runs reliably without unexpected crashes.",
"Cleaned up older behaviors so the dashboard and pages stay consistent."
]},
{ version:"V1.11.x", date:"2026-01-14", notes:[
"ABT import and review are now easier, with selectable rows and cleaner parsing.",
"Dashboard drilldowns and resident profile notes make follow-up and continuity easier."
]}
];

function aboutRefsHTML(){
return `
<ul>
<li><a href="https://www.cdc.gov/long-term-care-facilities/hcp/respiratory-virus-toolkit/index.html" target="_blank" rel="noopener">CDC: Viral Respiratory Pathogens Toolkit for Nursing Homes</a></li>
<li><a href="https://www.cdc.gov/long-term-care-facilities/media/pdfs/Infection Control-Resp-OutbreakResources-P.pdf" target="_blank" rel="noopener">CDC: Infection Control Respiratory Surveillance Line List (PDF)</a></li>
<li><a href="https://www.cdc.gov/long-term-care-facilities/media/pdfs/Infection Control-AcuteGastro-OutbreakResources-P.pdf" target="_blank" rel="noopener">CDC: Infection Control Acute Gastroenteritis Surveillance Line List (PDF)</a></li>
<li><a href="https://www.cdc.gov/infection-control/hcp/norovirus-guidelines/index.html" target="_blank" rel="noopener">CDC: Norovirus Prevention & Control Guideline</a></li>
<li><a href="https://www.cms.gov/files/document/qso-24-08-nh-2024-03-20.pdf" target="_blank" rel="noopener">CMS: QSO-24-08-NH (includes F880 Infection Control regulatory guidance)</a></li>
<li><a href="https://www.health.ny.gov/professionals/diseases/reporting/communicable/infection/" target="_blank" rel="noopener">NYSDOH: Infection Control (reporting + guidance hub)</a></li>
<li><a href="https://www.health.ny.gov/professionals/diseases/reporting/communicable/infection/reporting.htm" target="_blank" rel="noopener">NYSDOH: Reporting Requirements</a></li>
</ul>`;
}

function buildAboutModalHTML(s){
const fac = escapeHtml(s.config.facilityName || "Facility");
const cap = Number(s.config.totalCapacity||0);
const census = (s.census.activeResidentIds||[]).length;
const occ = cap>0 ? fmtPct((census/cap)*100) : "—";

const vh = APP_VERSION_HISTORY.map(v=>`
<div class="card" style="box-shadow:none;margin:0 0 10px">
<div class="row" style="justify-content:space-between;align-items:flex-end">
<div style="font-weight:900">${escapeHtml(v.version)}</div>
<div class="muted mini">${escapeHtml(v.date)}</div>
</div>
<div class="sep"></div>
<ul style="margin:0;padding-left:18px">
${(v.notes||[]).map(n=>`<li>${escapeHtml(n)}</li>`).join("")}
</ul>
</div>
`).join("");

return `
<div class="row noprint" style="justify-content:flex-end; margin-bottom:8px"><button class="smallbtn" onclick="openReportWalkthroughModal()">Open Report Walkthrough</button></div>

<div class="aboutTabs">
<button class="aboutTab active" data-about-tab="overview">Overview</button>
<button class="aboutTab" data-about-tab="capabilities">Capabilities</button>
<button class="aboutTab" data-about-tab="reports">Reports</button>
<button class="aboutTab" data-about-tab="guidance">Guidance & Standards</button>
<button class="aboutTab" data-about-tab="data">Data & privacy</button>
<button class="aboutTab" data-about-tab="versions">Version history</button>
</div>
<div class="sep"></div>

<div class="aboutPanel active" data-about-panel="overview">
<div class="aboutK">
<div class="muted mini">App</div><div><b>Infection Control Nurse Compliance Suite</b> — ${escapeHtml(APP_VERSION)} (Build ${escapeHtml(APP_BUILD_DATE)})</div>
<div class="muted mini">Facility</div><div>${fac}</div>
<div class="muted mini">Occupancy</div><div>${census} / ${cap||"—"} (${occ})</div>
<div class="muted mini">Purpose</div><div>Single resident-centered dashboard for <b>census</b>, <b>antibiotics (ABT)</b>, <b>vaccinations</b>, and <b>infection prevention (IP)</b> workflows — optimized for daily ops and survey readiness.</div>
</div>
<div class="sep"></div>
<div class="muted mini">
Disclaimer: This tool supports documentation and surveillance workflows. It does not replace facility policy, clinical judgment, or official guidance. Always follow current CMS, CDC, and NYSDOH requirements.
</div>
</div>

<div class="aboutPanel" data-about-panel="capabilities">
<ul style="margin:0;padding-left:18px">
<li><b>Census</b>: paste raw census text → parse to residents; detects discharges; locks last-known room/unit for historical records.</li>
<li><b>Resident database</b>: MRN-linked central record with profile view and continuous admin notes log.</li>
<li><b>ABT</b>: import antibiotic orders (legacy-like tabbed export), edit rows, long-log table, bulk line-listing flagging (Resp/GI/etc.).</li>
<li><b>Vaccinations</b>: weekly vaccinated/declined/pending/due drilldowns + resident vaccine history.</li>
<li><b>IP</b>: respiratory & GI line listing + contact tracing linkage (resident/staff/visitor) + active precautions view.</li>
<li><b>Operations</b>: unit occupancy cards + empty rooms/beds drilldown (Room Inventory recommended for accuracy).</li>
<li><b>Data</b>: localStorage-based persistence + JSON export/import (backup).</li>
</ul>
</div>

<div class="aboutPanel" data-about-panel="reports">
<div class="muted mini">Current and planned printable outputs:</div>
<div class="sep"></div>
<ul style="margin:0;padding-left:18px">
<li>Unit Active Precaution Listing (per-unit distribution template)</li>
<li>Respiratory/ILI line listing (CDC-style template + your facility layout)</li>
<li>GI line listing (CDC-style template + your facility layout)</li>
<li>ABT: Active antibiotics list + history drilldowns</li>
<li>Vax: weekly vaccinated/declined/pending/due lists</li>
<li>Empty rooms list by unit (from Room Inventory)</li>
</ul>
</div>

<div class="aboutPanel" data-about-panel="guidance">
<div class="muted mini">This app is designed to support workflows commonly reviewed under CMS survey processes (e.g., Infection Prevention & Control programs) and outbreak surveillance practices aligned with CDC tools for Infection Control settings.</div>
<div class="sep"></div>
<div class="card" style="box-shadow:none">
<b>How we align</b>
<ul style="margin:8px 0 0;padding-left:18px">
<li><b>CDC</b>: line listing templates and outbreak monitoring structure (respiratory + acute gastroenteritis) + norovirus guidance for GI outbreaks.</li>
<li><b>CMS</b>: supports organization of evidence for IPCP elements typically evaluated under infection control regulatory expectations (e.g., F880).</li>
<li><b>NYSDOH</b>: supports infection control reporting readiness and internal tracking consistent with state reporting/communication needs.</li>
</ul>
</div>
<div class="sep"></div>
<b>Reference links (official)</b>
${aboutRefsHTML()}
</div>

<div class="aboutPanel" data-about-panel="data">
<div class="card" style="box-shadow:none">
<b>Storage</b>
<div class="muted mini" style="margin-top:6px">Data is stored locally in your browser (localStorage). Use Export/Import for backups across devices.</div>
</div>
<div class="sep"></div>
<div class="card" style="box-shadow:none">
<b>PHI/Privacy</b>
<div class="muted mini" style="margin-top:6px">This tool may contain resident PHI. Use on approved devices, follow facility policies, and keep backups protected.</div>
</div>
</div>

<div class="aboutPanel" data-about-panel="versions">
${vh}
</div>
`;
}

function bindAboutTabs(){
const back = document.getElementById("modalBack");
if(!back) return;
const tabs = back.querySelectorAll("[data-about-tab]");
const panels = back.querySelectorAll("[data-about-panel]");
if(!tabs.length || !panels.length) return;

const show = (key)=>{
tabs.forEach(t=>t.classList.toggle("active", t.getAttribute("data-about-tab")===key));
panels.forEach(p=>p.classList.toggle("active", p.getAttribute("data-about-panel")===key));
};

tabs.forEach(t=>{
if(t.dataset.bound) return;
t.dataset.bound="1";
t.addEventListener("click", ()=> show(t.getAttribute("data-about-tab")));
});
}

function openAboutModal(){
const s = Store.load();
openModal(`About — ${escapeHtml(s.config.facilityName || "Infection Control Nurse Compliance Suite")}`, buildAboutModalHTML(s));
setTimeout(bindAboutTabs, 0);
}

function downloadText(filename, text){
const blob = new Blob([text], {type:"application/json"});
const url = URL.createObjectURL(blob);
const a = document.createElement("a");
a.href = url; a.download = filename; document.body.appendChild(a);
a.click(); a.remove();
setTimeout(()=>URL.revokeObjectURL(url), 1000);
}

function weekRangeISO(d=new Date()){
const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
const day = (x.getDay()+6)%7;
const start = new Date(x); start.setDate(x.getDate()-day);
const end = new Date(start); end.setDate(start.getDate()+6);
const toISO=(dt)=>`${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,"0")}-${String(dt.getDate()).padStart(2,"0")}`;
return { startISO: toISO(start), endISO: toISO(end) };
}
function inRangeISO(dateMDY, startISO, endISO){
const iso = mdyToISO(dateMDY);
if(!iso) return false;
if(startISO && iso < startISO) return false;
if(endISO && iso > endISO) return false;
return true;
}

function tabEl(name){ return document.getElementById(`tab-${name}`); }
function listMissingTabs(){
const required = ["dashboard","ip","audits","reports"];
const optional = ["census","abt","vax","surveillance","comms","decisions","staff","env","floormap","warehouse","config","about","settings"];
const missReq = required.filter(t=>!tabEl(t));
const missOpt = optional.filter(t=>!tabEl(t));
return {missReq, missOpt};
}
function openHealthCheck(){
const s = Store.load();
const role = effectiveRole(s);
const tabs = listMissingTabs();
const fnMissing = [];
const mustFns = ["renderAll","setTab","openPrintWindow","downloadText","doExportEncrypted"];
mustFns.forEach(n=>{ if(typeof window[n]!=="function") fnMissing.push(n); });

openModal("Health Check", `
<div class="muted mini">Quick self-check to diagnose “blank tab” and button issues. Safe to run anytime.</div>
<div class="sep"></div>

<div class="grid cols2">
<div class="card" style="box-shadow:none">
<div style="font-weight:900">Role</div>
<div class="muted mini">Current: <b>${escapeHtml(role)}</b></div>
</div>
<div class="card" style="box-shadow:none">
<div style="font-weight:900">Build</div>
<div class="muted mini">Version: <b>${escapeHtml(APP_VERSION)}</b></div>
</div>
</div>

<div class="sep"></div>

<div class="card" style="box-shadow:none">
<div style="font-weight:900">Tab integrity</div>
${tabs.missReq.length ? `<div class="badge red">Missing required tabs: ${escapeHtml(tabs.missReq.join(", "))}</div>` : `<div class="badge green">Required tabs OK</div>`}
${tabs.missOpt.length ? `<div class="muted mini" style="margin-top:6px">Missing optional tabs (OK if not in this build): ${escapeHtml(tabs.missOpt.join(", "))}</div>` : ``}
</div>

<div class="card" style="box-shadow:none; margin-top:10px">
<div style="font-weight:900">Core functions</div>
${fnMissing.length ? `<div class="badge red">Missing: ${escapeHtml(fnMissing.join(", "))}</div>` : `<div class="badge green">Core functions OK</div>`}
</div>

<div class="sep"></div>
<div class="row end" style="gap:8px">
<button class="btn" onclick="closeModal()">Close</button>
</div>
`);
}

function setTab(name){
if(!tabEl(name)){
console.warn('[setTab] Missing tab:', name);
toast(`This section isn't available in this build: ${name}`);
name = 'dashboard';
}

// --- Robust tab navigation (PATCH) ---
(function(){
  function safeGetTabFromEvent(ev){
    try{
      const el = ev.target && ev.target.closest ? ev.target.closest('[data-tab]') : null;
      return el && el.dataset ? el.dataset.tab : undefined;
    }catch(e){ return undefined; }
  }
  // Patch global click delegate for any element with data-tab
  document.addEventListener('click', function(ev){
    const tab = safeGetTabFromEvent(ev);
    if(!tab) return;
    if(typeof window.setTab === 'function'){
      window.setTab(tab);
      ev.preventDefault();
      ev.stopPropagation();
    }
  }, true);
})();

window.__activeTab = name;

document.querySelectorAll(".tabbtn").forEach(b=>{
if(!b.dataset || !b.dataset.tab) return;
b.classList.toggle("active", b.dataset.tab===name);
});
document.querySelectorAll(".menubtn").forEach(b=>{
if(!b.dataset || !b.dataset.tab) return;
b.classList.toggle("active", b.dataset.tab===name);
});

document.querySelectorAll(".tab, .tabpane").forEach(sec=>{
sec.style.display = (sec.id===`tab-${name}`) ? "" : "none";
});

try{ closeMoreMenu(); }catch(e){}
}

function closeMoreMenu(){
const mm = document.getElementById("moreMenu");
const btn = document.getElementById("btnMore");
if(mm) mm.classList.remove("open");
if(btn) btn.setAttribute("aria-expanded","false");
}
function toggleMoreMenu(){
const mm = document.getElementById("moreMenu");
const btn = document.getElementById("btnMore");
if(!mm || !btn) return;
const open = !mm.classList.contains("open");
if(open) mm.classList.add("open"); else mm.classList.remove("open");
btn.setAttribute("aria-expanded", open ? "true" : "false");
if(open){
const inp = document.getElementById("moreSearch");
if(inp){
inp.value = "";
filterMoreMenu("");
setTimeout(()=>inp.focus(), 10);
}
}}
function initMoreMenu(){
document.querySelectorAll('.tabbtn[data-tab], .menubtn[data-tab]').forEach(b=>{
const t=b.dataset.tab;
if(!t) return;
const exists = !!tabEl(t);
if(['dashboard','ip','audits','reports'].includes(t)) { b.style.display=''; return; }
b.style.display = exists ? '' : 'none';
});

const btn = document.getElementById("btnMore");
const mm = document.getElementById("moreMenu");
if(btn && !btn.dataset.bound){
btn.dataset.bound="1";
btn.addEventListener("click", (e)=>{ e.stopPropagation(); toggleMoreMenu(); });
}
if(mm && !mm.dataset.bound){
mm.dataset.bound="1";
mm.addEventListener("click", (e)=>{
e.stopPropagation();
const t = e.target;
if(t && t.dataset && t.dataset.tab){
setTab(t.dataset.tab);
}
});
}

const inp = document.getElementById("moreSearch");
if(inp && !inp.dataset.bound){
inp.dataset.bound="1";
inp.addEventListener("input", ()=>{ filterMoreMenu(inp.value); });
inp.addEventListener("keydown", (e)=>{
if(e.key==="Enter"){
e.preventDefault();
const first = filterMoreMenu(inp.value);
if(first && first.dataset && first.dataset.tab){
setTab(first.dataset.tab);
}
}
if(e.key==="Escape"){
closeMoreMenu();
}
});
}

if(!document.body.dataset.moreBound){
document.body.dataset.moreBound="1";
document.addEventListener("click", ()=>closeMoreMenu());
document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeMoreMenu(); });
}
}

function filterMoreMenu(q){
const mm = document.getElementById("moreMenu");
if(!mm) return;
const query = (q||"").trim().toLowerCase();
const items = Array.from(mm.querySelectorAll(".menubtn"));
let firstVisible = null;
items.forEach(b=>{
const txt = (b.textContent||"").toLowerCase();
const show = !query || txt.includes(query);
b.style.display = show ? "" : "none";
if(show && !firstVisible) firstVisible = b;
});
mm.querySelectorAll(".menudiv").forEach(d=>{
d.style.opacity = query ? "0.35" : "1";
});
return firstVisible;
}

function getFilteredResidents(s){
const includeDis = !!s.ui.includeDischarged;
const unitFilter = s.ui.unitFilter;
return Object.values(s.residentsById)
.filter(r=>{
if(!includeDis && r.status!=="active") return false;
if(unitFilter==="ALL") return true;
return (r.unit===unitFilter) || (r.lockedUnit===unitFilter);
})
.sort((a,b)=> (a.name||"").localeCompare(b.name||""));
}
function getActiveAbt(s){
const today = new Date();
const unitFilter = s.ui.unitFilter;
return (s.modules.abt.courses||[]).filter(c=>{
if(unitFilter!=="ALL"){
const u = c.unit || (s.residentsById[c.residentId]?.unit||"");
if(u!==unitFilter) return false;
}
const end = parseMDY(c.endDate);
if(!c.endDate) return true;
if(!end) return false;
return end >= new Date(today.getFullYear(), today.getMonth(), today.getDate());
});
}
function getActivePrecautions(s){
const unitFilter = s.ui.unitFilter;
return (s.modules.ip.precautions||[]).filter(p=>{
if(p.status!=="active") return false;
if(unitFilter==="ALL") return true;
return p.unit===unitFilter;
});
}
function getWeekCounts(s){
const wr = weekRangeISO(new Date());
const unitFilter = s.ui.unitFilter;
const ev = (s.modules.vax.events||[]).filter(e=>{
if(unitFilter!=="ALL" && (e.unit||"")!==unitFilter) return false;
return inRangeISO(e.date, wr.startISO, wr.endISO);
});
const vacc = ev.filter(x=>x.status==="vaccinated").length;
const decl = ev.filter(x=>x.status==="declined").length;
const pend = ev.filter(x=>x.status==="pending").length;
return {wr, total: ev.length, vacc, decl, pend};
}
function getFilteredVaxEvents(s){
const ui = s.modules.vax.ui || {};
const unitFilter = s.ui.unitFilter;
let startISO = "", endISO = "";
if(ui.range==="week"){
const wr = weekRangeISO(new Date());
startISO = wr.startISO; endISO = wr.endISO;
} else if(ui.range==="30"){
const d = new Date();
const end = new Date(d.getFullYear(), d.getMonth(), d.getDate());
const start = new Date(end); start.setDate(end.getDate()-29);
const toISO=(dt)=>`${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,"0")}-${String(dt.getDate()).padStart(2,"0")}`;
startISO = toISO(start); endISO = toISO(end);
} else if(ui.range==="custom"){
startISO = ui.startISO || ""; endISO = ui.endISO || "";
}
return (s.modules.vax.events||[]).filter(e=>{
if(unitFilter!=="ALL" && (e.unit||"")!==unitFilter) return false;
if(ui.status && ui.status!=="all" && (e.status||"")!==ui.status) return false;
if(ui.type && ui.type!=="all" && (e.vaccineType||"")!==ui.type) return false;
if(ui.range!=="all" && !inRangeISO(e.date, startISO, endISO)) return false;
return true;
});
}

function renderProfilePanel(s){
const id = s.ui.selectedResidentId;
const panel = document.getElementById("profilePanel");
if(!id || !s.residentsById[id]){
panel.innerHTML = `<div class="muted">Select a resident to view snapshot.</div>`;
return;
}
const r = s.residentsById[id];
const room = (r.status==="active") ? (r.room||"") : (r.lockedRoom||r.room||"");
const unit = (r.status==="active") ? (r.unit||"") : (r.lockedUnit||r.unit||"");
const statusBadge = r.status==="active" ? `<span class="badge green">Active</span>` : (r.status==="discharged" ? `<span class="badge red">Discharged</span>` : `<span class="badge amber">${escapeHtml(r.status||"")}</span>`);
const abtAll = (s.modules.abt.courses||[]).filter(c=>c.residentId===id);
const abtActive = abtAll.filter(c=>{
const end = parseMDY(c.endDate);
if(!c.endDate) return true;
if(!end) return false;
return end >= new Date();
});
const precActive = (s.modules.ip.precautions||[]).filter(p=>p.residentId===id && p.status==="active");
const vaxAll = (s.modules.vax.events||[]).filter(e=> e.residentId===id || (r.mrn && e.mrn===r.mrn));
const vaxSorted = vaxAll.slice().sort((a,b)=> (mdyToISO(b.date)||"").localeCompare(mdyToISO(a.date)||""));
const vaxLatest = vaxSorted.slice(0,3);
const notes = Array.isArray(r.profileNotesLog) ? r.profileNotesLog : [];
panel.innerHTML = `
<div class="card" style="box-shadow:none; padding:10px; border-style:dashed">
<div class="row" style="justify-content:space-between;align-items:flex-start">
<div>
<div style="font-weight:900; font-size:14px">${escapeHtml(r.name||"")}</div>
<div class="muted mini">MRN: ${escapeHtml(r.mrn||"—")} · Room: ${escapeHtml(room||"—")} · Unit: ${escapeHtml(unit||"—")}</div>
</div>
<div>${statusBadge}</div>
</div>
<div class="sep"></div>
<div class="row" style="gap:8px">
<button class="badge blue" onclick="openResidentDrilldown('abtActive')">ABT Active: ${abtActive.length}</button>
<button class="badge" onclick="openResidentDrilldown('abtHistory')">ABT History: ${abtAll.length}</button>
<button class="badge red" onclick="openResidentDrilldown('ipActive')">Active Precautions: ${precActive.length}</button>
<button class="badge green" onclick="openResidentDrilldown('vax')">Vax Events: ${vaxAll.length}</button>
</div>
<div class="sep"></div>
<div class="grid cols2">
<div>
<div style="font-weight:900">Most Recent Vaccinations (latest 3)</div>
${vaxLatest.length ? `
<table style="margin-top:8px">
<thead><tr><th>Type</th><th>Status</th><th>Date</th></tr></thead>
<tbody>
${vaxLatest.map(v=>`
<tr>
<td>${escapeHtml(v.vaccineType||"")}</td>
<td class="nowrap">${escapeHtml(v.status||"")}</td>
<td class="nowrap">${escapeHtml(v.date||"")}</td>
</tr>
`).join("")}
</tbody>
</table>
` : `<div class="muted" style="margin-top:6px">No vaccine events linked yet.</div>`}
</div>
<div>
<div style="font-weight:900">Admin Notes (latest 3)</div>
${notes.slice(0,3).map(n=>`
<div class="noteitem" style="margin-top:8px">
<div class="meta"><span>${escapeHtml(n.author||"Admin")}</span><span>${escapeHtml(new Date(n.createdAt).toLocaleString())}</span></div>
<div class="txt">${escapeHtml(n.text||"")}</div>
</div>
`).join("") || `<div class="muted" style="margin-top:8px">No notes yet.</div>`}
</div>
</div>
</div>
`;
}

function renderVax(s){
const box = document.getElementById("vaxTable");
if(!box) return;

const unitFilter = s.ui.unitFilter || "ALL";
let rows = (s.modules.vax.events||[]).slice();

  // Search filter (Name/MRN/Room)
  const vf = (FILTERS.vax||"");
  if(vf){
    rows = rows.filter(v=> rowMatchesFilter(`${v.residentName||""} ${v.mrn||""} ${v.room||""} ${v.unit||""}`, vf));
  }

if(unitFilter!=="ALL"){
rows = rows.filter(v=> (v.unit||"")===unitFilter);
}

rows.sort((a,b)=> (mdyToISO(b.date)||"").localeCompare(mdyToISO(a.date)||"") || (a.residentName||"").localeCompare(b.residentName||""));

if(rows.length===0){
box.innerHTML = `<div class="muted">No vaccine events in current unit filter.</div>`;
return;
}

box.innerHTML = `
<table>
<thead><tr><th>Date</th><th>Resident</th><th>MRN</th><th>Unit</th><th>Room</th><th>Type</th><th>Status</th><th>Notes</th><th class="noprint" style="width:110px">Actions</th></tr></thead>
<tbody>
${rows.slice(0,900).map(v=>`
<tr>
<td class="nowrap">${escapeHtml(v.date||"")}</td>
<td>${escapeHtml(resolveResidentDisplayName(s,v)||"")}</td>
<td class="nowrap">${escapeHtml(v.mrn||"")}</td>
<td class="nowrap">${escapeHtml(v.unit||"")}</td>
<td class="nowrap">${escapeHtml(v.room||"")}</td>
<td>${escapeHtml(v.vaccineType||"")}</td>
<td class="nowrap">${escapeHtml(v.status||"")}</td>
<td>${escapeHtml(v.notes||"")}</td>
<td class="noprint nowrap"><button class="smallbtn" onclick="openVaxEditModal('${escapeHtml(v.id)}')">Edit</button></td>
</tr>
`).join("")}
</tbody>
</table>
${rows.length>900? `<div class="muted mini" style="margin-top:8px">Showing first 900 rows.</div>`:""}
`;
}

function renderWarehouse(s){
const box = document.getElementById("warehouseView");
const mode = window.__whMode || "residents";
if(mode==="residents"){
const rows = Object.values(s.residentsById).sort((a,b)=>(a.name||"").localeCompare(b.name||""));
box.innerHTML = `
<table>
<thead><tr>
<th>Name</th><th>MRN</th><th>Status</th><th>Room</th><th>Unit</th><th>Locked Room</th><th>Locked Unit</th><th>Edit</th>
</tr></thead>
<tbody>
${rows.slice(0,600).map(r=>`
<tr>
<td>${escapeHtml(r.name||"")}</td>
<td class="nowrap">${escapeHtml(r.mrn||"")}</td>
<td class="nowrap">${escapeHtml(r.status||"")}</td>
<td class="nowrap">${escapeHtml(r.room||"")}</td>
<td class="nowrap">${escapeHtml(r.unit||"")}</td>
<td class="nowrap">${escapeHtml(r.lockedRoom||"")}</td>
<td class="nowrap">${escapeHtml(r.lockedUnit||"")}</td>
<td class="nowrap"><button class="smallbtn" onclick="openResidentEditModal('${escapeHtml(r.id)}')">Edit</button></td>
</tr>
`).join("")}
</tbody>
</table>
${rows.length>600? `<div class="muted mini" style="margin-top:8px">Showing first 600 residents.</div>`:""}
`;
return;
}
if(mode==="abt"){
const rows = s.modules.abt.courses || [];
box.innerHTML = `<table><thead><tr><th>Resident</th><th>MRN</th><th>Unit</th><th>Room</th><th>Antibiotic</th><th>Start</th><th>End</th><th>Class</th></tr></thead><tbody>
${rows.slice(0,900).map(c=>`<tr><td>${escapeHtml(c.residentName||"")}</td><td class="nowrap">${escapeHtml(c.mrn||"")}</td><td class="nowrap">${escapeHtml(c.unit||"")}</td><td class="nowrap">${escapeHtml(c.room||"")}</td><td>${escapeHtml(c.antibiotic||"")}</td><td class="nowrap">${escapeHtml(c.startDate||"")}</td><td class="nowrap">${escapeHtml(c.endDate||"")}</td><td>${escapeHtml(c.abxClass||"")}</td></tr>`).join("")}
</tbody></table>`;
return;
}
if(mode==="prec"){
const rows = s.modules.ip.precautions || [];
box.innerHTML = `<table><thead><tr><th>Status</th><th>Resident</th><th>Unit</th><th>Room</th><th>Type</th><th>Source</th><th>Start</th><th>End</th></tr></thead><tbody>
${rows.slice(0,900).map(p=>`<tr><td class="nowrap">${escapeHtml(p.status||"")}</td><td>${escapeHtml(p.residentName||"")}</td><td class="nowrap">${escapeHtml(p.unit||"")}</td><td class="nowrap">${escapeHtml(p.room||"")}</td><td>${escapeHtml(p.type||"")}</td><td>${escapeHtml(p.infectedSource||"")}</td><td class="nowrap">${escapeHtml(p.startDate||"")}</td><td class="nowrap">${escapeHtml(p.endDate||"")}</td></tr>`).join("")}
</tbody></table>`;
return;
}
if(mode==="vax"){
const rows = s.modules.vax.events || [];
box.innerHTML = `<table><thead><tr><th>Date</th><th>Resident</th><th>MRN</th><th>Unit</th><th>Room</th><th>Type</th><th>Status</th><th>Notes</th></tr></thead><tbody>
${rows.slice(0,900).map(v=>`<tr><td class="nowrap">${escapeHtml(v.date||"")}</td><td>${escapeHtml(resolveResidentDisplayName(s,v)||"")}</td><td class="nowrap">${escapeHtml(v.mrn||"")}</td><td class="nowrap">${escapeHtml(v.unit||"")}</td><td class="nowrap">${escapeHtml(v.room||"")}</td><td>${escapeHtml(v.vaccineType||"")}</td><td class="nowrap">${escapeHtml(v.status||"")}</td><td>${escapeHtml(v.notes||"")}</td></tr>`).join("")}
</tbody></table>`;
return;
}
}

function renderConfig(s){
document.getElementById("cfgFacilityName").value = s.config.facilityName || "";
document.getElementById("cfgTotalCap").value = s.config.totalCapacity ?? "";

const __ri = document.getElementById("cfgRoomInventoryText");
if(__ri) __ri.value = s.config.roomInventoryText || "";const box = document.getElementById("cfgUnitsTable");
box.innerHTML = `<table><thead><tr><th>UnitKey</th><th>Unit Name</th><th>Bed Capacity</th><th>Remove</th></tr></thead><tbody>
${(s.config.units||[]).map((u,idx)=>`
<tr>
<td class="nowrap"><input type="text" value="${escapeHtml(u.unitKey||"")}" oninput="cfgEditUnit(${idx},'unitKey',this.value)"/></td>
<td><input type="text" value="${escapeHtml(u.unitName||"")}" oninput="cfgEditUnit(${idx},'unitName',this.value)"/></td>
<td class="nowrap"><input type="number" min="0" value="${escapeHtml(u.bedCapacity??0)}" oninput="cfgEditUnit(${idx},'bedCapacity',this.value)"/></td>
<td class="nowrap"><button class="smallbtn danger" onclick="cfgRemoveUnit(${idx})">Remove</button></td>
</tr>
`).join("")}
</tbody></table>`;
const aliasesText = Object.entries(s.config.unitAliases||{}).sort((a,b)=>a[0].localeCompare(b[0])).map(([k,v])=>`${k} = ${v}`).join("\n");
document.getElementById("cfgAliases").value = aliasesText;
  // QAPI thresholds
  try{
    const q = getQapiCfg(s);
    const setVal = (id,val)=>{ const el=document.getElementById(id); if(el) el.value = (val??''); };
    setVal('cfgPatientDays7', q.patientDaysLast7??0);
    setVal('cfgWindowDays', q.windowDays??7);
    setVal('cfgInfectRate', q.thresholds.infectionRatePer1000??10);
    setVal('cfgAbtRate', q.thresholds.abtUtilPer1000??20);
    setVal('cfgTrigGI', q.thresholds.gi72h??2);
    setVal('cfgTrigResp', q.thresholds.resp72h??2);
    setVal('cfgTrigAbtDay', q.thresholds.abtStartsDay??3);
    setVal('cfgTrigPending', q.thresholds.pendingBacklog??5);
    setVal('cfgVaxTarget', q.thresholds.vaxAnyTarget??80);
  }catch(e){}

const sum = (s.config.units||[]).reduce((a,u)=>a + (Number(u.bedCapacity)||0), 0);
const tot = Number(s.config.totalCapacity||0);
const diff = sum - tot;
document.getElementById("cfgHealth").innerHTML = `<div><b>Sum of unit capacities:</b> ${sum}</div><div><b>Total capacity:</b> ${tot||"—"}</div><div style="margin-top:8px"><b>Difference:</b> ${diff===0?`<span class="badge green">OK (0)</span>`:`<span class="badge amber">${diff>0?'+':''}${diff}</span>`}</div>`;
}


function openUnitPrecautionSignagePrintSetup(){
  const s = Store.load(); ensureIpData(s); ensureConfig(s);
  reconcileIpPrecautions(s);
  const unitFilter = s.ui.unitFilter || "ALL";
  const units = (s.config.units||[]);
  const user = getCurrentUser(s);
  openModal("Print Isolation / Precaution Signage", `
    <div class="muted mini">Print one sign per active resident on precautions/isolation/EBP. Designed for survey-ready use.</div>
    <div class="sep"></div>
    <div class="grid cols3">
      <div>
        <label>Unit</label>
        <select id="ps_unit">
          <option value="ALL">All Units</option>
          ${units.map(u=>`<option value="${escapeHtml(u.unitKey)}">${escapeHtml(u.unitName||u.unitKey)}</option>`).join("")}
        </select>
      </div>
      <div>
        <label>Include</label>
        <select id="ps_include">
          <option value="all">All active precautions</option>
          <option value="isolation">Isolation only</option>
          <option value="ebp">EBP only</option>
        </select>
      </div>
    </div>
    <div class="sep"></div>
    <div class="row end" style="gap:8px">
      <button class="btn" onclick="closeModal()">Cancel</button>
      <button class="btn primary" onclick="printUnitPrecautionSignageFromSetup()">Print Signage Set</button>
    </div>
    <div class="sep"></div>
    <div class="muted mini">Prepared by: <b>${escapeHtml(user.name||"")}</b></div>
  `);
  const sel = document.getElementById("ps_unit");
  if(sel) sel.value = (unitFilter==="ALL" ? "ALL" : unitFilter);
}
window.printUnitPrecautionSignageFromSetup = function(){
  const unit = document.getElementById("ps_unit")?.value || "ALL";
  const include = document.getElementById("ps_include")?.value || "all";
  closeModal();
  openUnitPrecautionSignagePrint(unit, include);
};
function openUnitPrecautionSignagePrint(unitKey, include){
  const s = Store.load(); ensureIpData(s); ensureConfig(s);
  reconcileIpPrecautions(s);
  const facility = s.config.facilityName || "Facility";
  const rows = getActivePrecautionsRowsUnified(s, unitKey);
  const filt = rows.filter(p=>{
    const t = String(p.type||"").toUpperCase();
    if(include==="isolation") return t.includes("ISOLATION");
    if(include==="ebp") return t.includes("ENHANCED BARRIER") || t==="EBP";
    return true;
  });
  if(!filt.length){ toast("No active precautions to print."); return; }
  const pages = filt.map(p=>{
    const resident = escapeHtml(p.residentName||"");
    const room = escapeHtml(p.room||"");
    const unit = escapeHtml(unitNamePretty(s,p.unit)||p.unit||"");
    const type = escapeHtml(p.type||"");
    const src = escapeHtml(p.infectedSource||"");
    return `
      <div class="printPage">
        <div class="printHeader">
          <div style="font-weight:900; font-size:16px">${escapeHtml(facility)}</div>
          <div style="font-size:12px; color:#333">Isolation / Precaution Signage</div>
        </div>
        <div class="sep"></div>
        <div style="font-size:22px; font-weight:900; margin-top:10px">${type}</div>
        <div style="margin-top:10px; font-size:16px"><b>Resident:</b> ${resident}</div>
        <div style="margin-top:4px; font-size:16px"><b>Room:</b> ${room} &nbsp; <span class="muted">(${unit})</span></div>
        ${src ? `<div style="margin-top:10px; font-size:14px"><b>Reason/Source:</b> ${src}</div>` : ``}
        <div class="sep"></div>
        <div style="font-size:13px; line-height:1.35">
          <b>Staff Reminder:</b> Follow facility PPE and hand hygiene policy. Confirm appropriate isolation cart/supplies are available and signage is posted at the point of entry.
        </div>
        <div style="margin-top:18px; font-size:12px; color:#444">
          Generated: ${escapeHtml(dayISO(new Date()))}
        </div>
      </div>
    `;
  }).join("");
  openPrintWindow(`
    <html><head><title>Signage Set</title>
    <style>
      @media print { .printPage{page-break-after:always;} }
      body{font-family:Arial,Helvetica,sans-serif; margin:18px;}
      .printHeader{display:flex; justify-content:space-between; align-items:flex-end;}
      .sep{border-top:1px solid #ddd; margin:10px 0;}
    </style>
    </head><body>${pages}</body></html>
  `);
}

function openPrecautionListPrintSetup(){
const s = Store.load();
ensureIpData(s);
const units = (s.config.units||[]);

const unitFilter = s.ui.unitFilter || "ALL";
const today = new Date().toISOString().slice(0,10);
const user = getCurrentUser(s);

openModal("Print Unit Precaution Listing", `
<div class="muted mini">Generates the exact “Residents on Precautions or Isolation” unit sheet.</div>
<div class="sep"></div>

<div class="grid cols3">
<div>
<label>Unit</label>
<select id="pl_unit">
<option value="ALL" ${unitFilter==="ALL"?"selected":""}>ALL (separate pages)</option>
${units.map(u=>`<option value="${escapeHtml(u.unitKey)}" ${(unitFilter===u.unitKey)?"selected":""}>${escapeHtml(u.unitName||u.unitKey)}</option>`).join("")}
</select>
</div>
<div>
<label>Date</label>
<input id="pl_date" type="date" value="${today}"/>
</div>
<div>
<label>Shift</label>
<select id="pl_shift">
<option value="Day">Day</option>
<option value="Evening">Evening</option>
<option value="Night">Night</option>
</select>
</div>
</div>

<div class="sep"></div>
<div class="row end" style="gap:8px">
<button class="btn" onclick="closeModal()">Cancel</button>
<button class="btn" onclick="exportUnitPrecautionListingCSVFromSetup()">Export CSV</button>
<button class="btn primary" onclick="printUnitPrecautionListingFromSetup()">Print</button>
</div>

<div class="sep"></div>
<div class="muted mini">Prepared by: <b>${escapeHtml(user.name||"")}</b></div>
`);
}

window.printUnitPrecautionListingFromSetup = function(){
const unit = document.getElementById("pl_unit")?.value || "ALL";
const dateISO = document.getElementById("pl_date")?.value || new Date().toISOString().slice(0,10);
const shift = document.getElementById("pl_shift")?.value || "Day";
closeModal();
openUnitPrecautionListPrintTemplate(unit, dateISO, shift);
}

window.exportUnitPrecautionListingCSVFromSetup = function(){
  const s = Store.load();
  ensureIpData(s); ensureConfig(s);
  const unit = document.getElementById("pl_unit")?.value || "ALL";
  const dateISO = document.getElementById("pl_date")?.value || dayISO(new Date());
  const shift = document.getElementById("pl_shift")?.value || "Day";
  const rows = getActivePrecautionsRows(s, unit).map(p=>({
    unit: unit==="ALL" ? (unitNamePretty(s,p.unit)||p.unit||"") : (unitNamePretty(s,unit)||unit),
    room: p.room||"",
    resident: p.residentName||"",
    precaution: p.type||"",
    source: p.infectedSource||"",
    duration: p.duration||"",
    date: dateISO,
    shift: shift
  }));
  const csv = toCSV(rows, ["unit","room","resident","precaution","source","duration","date","shift"]);
  const fname = `Unit_Precaution_Listing_${unit}_${dateISO}.csv`.replace(/[^A-Za-z0-9_.-]+/g,"_");
  downloadText(fname, csv);
  toast("Precaution listing CSV exported.");
};

;

function openUnitPrecautionListPrintTemplate(unitKey, dateISO, shift){
const s = Store.load();
ensureIpData(s);
ensureConfig(s);

const facility = s.config.facilityName || "Facility";
const dateDisp = dateISO ? (dateISO.slice(5,7)+"/"+dateISO.slice(8,10)+"/"+dateISO.slice(0,4)) : "";

// Duration helper for printouts (start date -> selected/current date + day count)
const _dur = (p)=>{
  const endISO = (dateISO || todayISO()).slice(0,10);
  const startISO = mdyToISO(p?.startDate||"") || String(p?.startDate||"").slice(0,10);
  if(!startISO) return "";
  const sdt = new Date(startISO+"T00:00:00");
  const edt = new Date(endISO+"T00:00:00");
  const days = Math.max(0, Math.floor((edt - sdt)/86400000));
  const startDisp = isoToMDY(startISO);
  const endDisp = isoToMDY(endISO);
  return `${startDisp} - ${endDisp} (${days}d)`;
};
const user = getCurrentUser(s);

const units = (s.config.units||[]);
const unitLabel = (uk)=>{
const u = units.find(x=>x.unitKey===uk);
if(u && (u.unitName||"").trim()) return u.unitName.trim();
const mm = String(uk||"").trim().match(/^U\s*0*([0-9]+)$/i);
if(mm) return `Unit ${mm[1]}`;
return String(uk||"").trim();
};

const buildRows = (uk)=> getActivePrecautionsRows(s, uk);
const onePage = (uk)=>{
const rows = buildRows(uk);
const unitText = uk==="ALL" ? "All Units" : unitLabel(uk);

return `
<div class="uplist-page">
<div class="center" style="font-weight:900; font-size:18px; margin-top:6px">${escapeHtml(facility)}</div>
<div class="center" style="font-weight:900; font-size:13px; margin-top:6px">RESIDENTS ON PRECAUTIONS OR ISOLATION</div>

<div style="display:flex; justify-content:center; gap:36px; margin-top:12px; font-weight:900; font-size:12px">
<div>UNIT: <span class="line">${escapeHtml(unitText)}</span></div>
<div>DATE: <span class="line">${escapeHtml(dateDisp)}</span></div>
<div>SHIFT: <span class="line">${escapeHtml(shift)}</span></div>
</div>

<div style="height:10px"></div>

<table class="uplist thin">
<thead>
<tr>
<th style="width:90px" class="center">RM. #</th>
<th style="width:360px" class="center">RESIDENT'S NAME</th>
<th class="center">PRECAUTION/ISOLATION</th>
<th style="width:240px" class="center">INFECTED<br/>SOURCE</th>
<th style="width:220px" class="center">DURATION</th>
</tr>
</thead>
<tbody>
${(rows.length ? rows : Array.from({length:10}).map(()=>null)).map(p=>{
if(!p){
return `<tr>
<td>&nbsp;</td><td></td><td></td><td></td><td></td>
</tr>`;
}
return `<tr>
<td class="nowrap">${escapeHtml(p.room||"")}</td>
<td>${escapeHtml(p.residentName||"")}</td>
<td>${escapeHtml(p.type||"")}</td>
<td>${escapeHtml(p.infectedSource||"")}</td>
<td>${escapeHtml(_dur(p))}</td>
</tr>`;
}).join("")}
</tbody>
</table>

<div style="height:12px"></div>

<div style="display:flex; gap:18px; font-size:11px; font-weight:900; align-items:flex-end">
<div style="flex:1">Prepared by: <span class="line">${escapeHtml(user.name||"")}</span></div>
<div style="flex:1">Title: <span class="line"></span></div>
</div>
<div style="display:flex; gap:18px; font-size:11px; font-weight:900; align-items:flex-end; margin-top:8px">
<div style="flex:1">Signature: <span class="line"></span></div>
<div style="flex:1">Date/Time: <span class="line"></span></div>
</div>

<div style="margin-top:10px; font-size:9.5px; font-weight:700">
* If the patient is known to have an MRSA, VRE or any Multidrug resistant infection or colonization, the health care worker should wear disposable gloves. Depending on the type of contact, a gown should also be worn. Patients must also wash their hands to avoid spreading the bacteria to others.
</div>
</div>
`;
};

let pagesHtml = "";
if(unitKey==="ALL"){
const unitKeys = (s.config.units||[]).map(u=>u.unitKey);
pagesHtml = unitKeys.map((uk,i)=> onePage(uk) + (i<unitKeys.length-1?'<div style="page-break-after:always"></div>':"")).join("");
} else {
pagesHtml = onePage(unitKey);
}

openPrintWindow("Unit Precaution Listing", pagesHtml, `
@page{ size: landscape; margin: 0.35in; }
.uplist-page{ }
.center{text-align:center}
.line{ display:inline-block; min-width: 160px; border-bottom: 2px solid #111; height: 0.95em; vertical-align: bottom; }
table.uplist th, table.uplist td{ border: 2px solid #111; }
table.uplist th{ font-weight: 900; font-size: 12px; }
table.uplist td{ font-size: 12px; padding: 6px 6px; line-height: 1.35; }
tr{ height: 28px; }
`);
}

function openPrintWindow(title, bodyHtml, extraCss){
const w = window.open("", "_blank");
if(!w){ alert("Pop-up blocked. Allow pop-ups to print."); return; }
const css = `
<style>
${extraCss||""}
@page { size: landscape; margin: 0.4in; }
body{ font-family: Arial, Helvetica, sans-serif; font-size: 11px; color:#000; }
.noprint{ display:none !important; }
table{ border-collapse: collapse; width: 100%; }
th, td{ border: 1px solid #111; padding: 2px 3px; vertical-align: middle; }
.center{ text-align:center; }
.right{ text-align:right; }
.muted{ color:#333; }
.v{ writing-mode: vertical-rl; transform: rotate(180deg); white-space: nowrap; font-size:10px; }
.thin td, .thin th{ padding: 1px 2px; }
.title{ font-weight: 900; font-size: 16px; letter-spacing: .5px; }
.sub{ font-weight: 900; font-size: 13px; }
.line{ display:inline-block; min-width: 280px; border-bottom: 2px solid #111; height: 0.9em; vertical-align: bottom; }
</style>
`;
w.document.open();
w.document.write(`<!doctype html><html><head><meta charset="utf-8"/><title>${title}</title>${css}</head><body>${bodyHtml}</body></html>`);
w.document.close();
w.focus();
setTimeout(()=>{ w.print(); }, 300);
}

function $(id){ return document.getElementById(id); }

function safeCall(label, fn){
try{ fn(); }catch(e){ console.error(`[Render:${label}]`, e); }
}

function renderHeader(s){
const titleEl = $("appTitle");
if(titleEl) titleEl.textContent = s.config.facilityName || "Infection Control Nurse Compliance Suite";

const inc = $("toggleIncludeDischarged");
if(inc){
inc.checked = !!s.ui.includeDischarged;
if(!inc.dataset.bound){
inc.dataset.bound="1";
inc.addEventListener("change", ()=> Store.patch(st=>{ st.ui.includeDischarged = !!inc.checked; }));
}
}

const unitPills = $("unitPills");
if(unitPills){
unitPills.innerHTML = "";
const mkPill = (key, label)=>{
const b=document.createElement("button");
b.className="pill";
b.textContent=label;
b.setAttribute("aria-pressed", (s.ui.unitFilter===key) ? "true" : "false");
b.onclick=()=>Store.patch(st=>{ st.ui.unitFilter=key; });
return b;
};
unitPills.appendChild(mkPill("ALL","All"));
for(const u of (s.config.units||[])){
unitPills.appendChild(mkPill(u.unitKey, u.unitName || u.unitKey));
}
}

const aboutBtn = $("btnAbout");
if(aboutBtn && !aboutBtn.dataset.bound){
aboutBtn.dataset.bound="1";
aboutBtn.addEventListener("click", openAboutModal);
}

const subEl = document.getElementById("appSub");
if(subEl){
subEl.textContent = `${APP_VERSION} — Unified Census + ABT + IP + Vax + Ops (New Build)`;
}
}


// =========================
// Phase 3: Dashboard Settings + Favorites
// =========================
const DASH_BLOCKS = [
  {key:'controls', label:'Dashboard Controls (Favorites Bar)'},
  {key:'facility', label:'Facility Snapshot / Quick Drilldowns'},
  {key:'resident', label:'Resident Snapshot'},
  {key:'situation', label:'Situation Board'}
];

const DASH_FAVS = [
  {key:'precList', label:'Daily Precaution Listing', tab:'reports', btn:'btnRpPrecList'},
  {key:'outbreak', label:'Outbreak Packet', tab:'reports', btn:'btnRpOutbreakPacket'},
  {key:'qapi', label:'QAPI Weekly Summary', tab:'reports', btn:'btnRpQapi'},
  {key:'surveyor', label:'Surveyor Packet Bundle', tab:'reports', btn:'btnRpSurveyor'},
  {key:'abtActive', label:'Active Antibiotics', tab:'reports', btn:'btnRpAbtActive'}
];

function dashGetView(s){
  if(!s.ui) s.ui = {};
  if(!s.ui.dashView || typeof s.ui.dashView !== 'object'){
    s.ui.dashView = { controls:true, facility:true, resident:true, situation:true };
  }
  // Ensure all keys exist
  for(const b of DASH_BLOCKS){
    if(!(b.key in s.ui.dashView)) s.ui.dashView[b.key] = true;
  }
  return s.ui.dashView;
}

function dashGetFavs(s){
  if(!s.ui) s.ui = {};
  if(!Array.isArray(s.ui.dashFavs) || s.ui.dashFavs.length===0){
    s.ui.dashFavs = ['precList','outbreak','qapi','surveyor'];
  }
  // Filter to known keys
  const known = new Set(DASH_FAVS.map(f=>f.key));
  s.ui.dashFavs = s.ui.dashFavs.filter(k=>known.has(k));
  if(s.ui.dashFavs.length===0) s.ui.dashFavs = ['precList','outbreak','qapi','surveyor'];
  return s.ui.dashFavs;
}

function applyDashView(s){
  const view = dashGetView(s);
  document.querySelectorAll('[data-dashblock]').forEach(el=>{
    const k = el.getAttribute('data-dashblock');
    const on = !!view[k];
    el.style.display = on ? '' : 'none';
  });
}

function runDashboardFavorite(key){
  const fav = DASH_FAVS.find(f=>f.key===key);
  if(!fav){ toast('Unknown favorite.'); return; }
  try{ setTab(fav.tab); }catch(e){ console.error(e); }
  // Small delay so tab content is visible
  setTimeout(()=>{
    const btn = document.getElementById(fav.btn);
    if(btn) btn.click();
    else toast('That report button is missing in this build.');
  }, 50);
}

function renderDashboardControls(s){
  const wrap = document.getElementById('dashFavBar');
  if(!wrap) return;
  const favs = dashGetFavs(s);
  const items = favs.map(k=>DASH_FAVS.find(f=>f.key===k)).filter(Boolean);
  wrap.innerHTML = '';
  if(items.length===0){
    wrap.innerHTML = '<span class="muted mini">No favorites pinned.</span>';
  } else {
    for(const it of items){
      const b = document.createElement('button');
      b.className = 'pill';
      b.type = 'button';
      b.textContent = it.label;
      b.addEventListener('click', ()=>runDashboardFavorite(it.key));
      wrap.appendChild(b);
    }
  }

  const btnS = document.getElementById('btnDashSettings');
  if(btnS && !btnS.dataset.bound){
    btnS.dataset.bound='1';
    btnS.addEventListener('click', ()=>openDashboardSettings());
  }
  const btnF = document.getElementById('btnDashFavs');
  if(btnF && !btnF.dataset.bound){
    btnF.dataset.bound='1';
    btnF.addEventListener('click', ()=>openDashboardFavorites());
  }
}

function openDashboardSettings(){
  const s = Store.load();
  const view = dashGetView(s);
  openModal('Dashboard Settings', `
    <div class="muted mini">Choose which dashboard blocks are visible. (Desktop stays 2-column; phone collapses by design.)</div>
    <div class="sep"></div>
    <div class="grid cols2">
      ${DASH_BLOCKS.map(b=>`
        <label style="display:flex;gap:10px;align-items:center;padding:10px;border:1px solid var(--line);border-radius:14px;background:#fff">
          <input type="checkbox" id="dashShow_${b.key}" ${view[b.key]?'checked':''}/>
          <div><div style="font-weight:900">${escapeHtml(b.label)}</div><div class="muted mini">${escapeHtml(b.key)}</div></div>
        </label>`).join('')}
    </div>
    <div class="sep"></div>
    <div class="row end" style="gap:8px">
      <button class="btn" onclick="closeModal()">Cancel</button>
      <button class="btn primary" id="btnDashSave">Save</button>
    </div>
  `);
  setTimeout(()=>{
    const b = document.getElementById('btnDashSave');
    if(!b) return;
    b.addEventListener('click', ()=>{
      Store.patch(st=>{
        const v = dashGetView(st);
        for(const blk of DASH_BLOCKS){
          const cb = document.getElementById(`dashShow_${blk.key}`);
          if(cb) v[blk.key] = !!cb.checked;
        }
        st.ui.dashView = v;
      });
      safeRenderAll();
      closeModal();
      toast('Dashboard settings saved.');
    });
  }, 30);
}

function openDashboardFavorites(){
  const s = Store.load();
  const favs = new Set(dashGetFavs(s));
  openModal('Manage Favorites', `
    <div class="muted mini">Select favorites to pin on the dashboard. Order is fixed for now (we can add drag-reorder later).</div>
    <div class="sep"></div>
    <div class="grid cols2">
      ${DASH_FAVS.map(f=>`
        <label style="display:flex;gap:10px;align-items:center;padding:10px;border:1px solid var(--line);border-radius:14px;background:#fff">
          <input type="checkbox" id="fav_${f.key}" ${favs.has(f.key)?'checked':''}/>
          <div><div style="font-weight:900">${escapeHtml(f.label)}</div><div class="muted mini">Opens: ${escapeHtml(f.tab)} → ${escapeHtml(f.btn)}</div></div>
        </label>`).join('')}
    </div>
    <div class="sep"></div>
    <div class="row end" style="gap:8px">
      <button class="btn" onclick="closeModal()">Cancel</button>
      <button class="btn primary" id="btnFavSave">Save</button>
    </div>
  `);
  setTimeout(()=>{
    const b = document.getElementById('btnFavSave');
    if(!b) return;
    b.addEventListener('click', ()=>{
      const chosen = [];
      for(const f of DASH_FAVS){
        const cb = document.getElementById(`fav_${f.key}`);
        if(cb && cb.checked) chosen.push(f.key);
      }
      Store.patch(st=>{ st.ui.dashFavs = chosen; });
      safeRenderAll();
      closeModal();
      toast('Favorites updated.');
    });
  }, 30);
}

function renderDashboardKPIs(s){
const censusCount = (s.census.activeResidentIds||[]).length;
const cap = Number(s.config.totalCapacity||0);

const occ = (cap>0) ? (censusCount/cap*100) : NaN;

const censusTotal = $("censusTotal");
if(censusTotal) censusTotal.textContent = censusCount;

const capTotal = $("capTotal");
if(capTotal) capTotal.textContent = cap ? cap : "—";

const occPct = $("occPct");
if(occPct) occPct.textContent = fmtPct(occ);

const kpiCensus = $("kpiCensus");
if(kpiCensus) kpiCensus.textContent = `${censusCount} / ${cap||"—"}`;

const occText = $("occText");
if(occText) occText.textContent = isFinite(occ) ? `${fmtPct(occ)} occupancy` : "—";

const occBar = $("occBar");
if(occBar) occBar.style.width = isFinite(occ) ? `${Math.max(0, Math.min(100, occ))}%` : "0%";

const pillEmpty = $("pillEmptyRooms");
if(pillEmpty && typeof getEmptyRoomsSnapshot === "function"){
try{
const snap = getEmptyRoomsSnapshot(s);
if(snap){
if(snap.emptyBeds===null) pillEmpty.textContent = snap.emptyRooms?.length ? `Rooms: ${snap.emptyRooms.length}` : "—";
else pillEmpty.textContent = `Rooms: ${(snap.emptyRooms||[]).length} · Beds: ${snap.emptyBeds}`;
}
}catch(e){}
}
}

function renderQuickDrillCounts(s){
const abtActive = (typeof getActiveAbt==="function") ? getActiveAbt(s) : [];
const ipActive  = (typeof getActivePrecautions==="function") ? getActivePrecautions(s) : [];
const wc = (typeof getWeekCounts==="function") ? getWeekCounts(s) : { total:0, vacc:0, decl:0, pend:0 };

const pillAbt = $("pillAbtActive"); if(pillAbt) pillAbt.textContent = `Active: ${abtActive.length}`;
const pillIp  = $("pillIpActive");  if(pillIp)  pillIp.textContent  = `Active: ${ipActive.length}`;

const pillWk  = $("pillVaxWeek");   if(pillWk)  pillWk.textContent  = `Week: ${wc.total}`;
const pillV   = $("pillVaxVacc");   if(pillV)   pillV.textContent   = wc.vacc;
const pillD   = $("pillVaxDecl");   if(pillD)   pillD.textContent   = wc.decl;
const pillP   = $("pillVaxPend");   if(pillP)   pillP.textContent   = wc.pend;

const goAbt = $("goAbt");
if(goAbt && !goAbt.dataset.bound){
goAbt.dataset.bound="1";
goAbt.addEventListener("click", ()=> { if(typeof setTab==="function") setTab("abt"); });
}
const goIp = $("goIp");
if(goIp && !goIp.dataset.bound){
goIp.dataset.bound="1";
goIp.addEventListener("click", ()=> { if(typeof setTab==="function") setTab("ip"); });
}
const goV = $("goVaxWeek");
if(goV && !goV.dataset.bound){
goV.dataset.bound="1";
goV.addEventListener("click", ()=> { if(typeof setTab==="function") setTab("vax"); });
}
const goEmpty = $("goEmptyRooms");
if(goEmpty && !goEmpty.dataset.bound){
goEmpty.dataset.bound="1";
goEmpty.addEventListener("click", ()=> { if(typeof openEmptyRoomsModal==="function") openEmptyRoomsModal(); });
}
}

function renderUnitOccupancyCards(s){
const unitCards = $("unitCards");
if(!unitCards) return;
unitCards.innerHTML = "";

const cap = Number(s.config.totalCapacity||0);
const activeIds = (s.census.activeResidentIds||[]);
for(const u of (s.config.units||[])){
const count = activeIds.map(id=>s.residentsById[id]).filter(r=>{
if(!r) return false;
const uk = (typeof getUnitKeyFromAny==="function" ? getUnitKeyFromAny(r.unit||r.lockedUnit||"", s.config) : (r.unit||""))
|| (typeof inferUnitFromRoom==="function" ? inferUnitFromRoom(r.room||r.lockedRoom||"", s.config) : "")
|| "";
return uk === u.unitKey;
}).length;

const pct = u.bedCapacity ? (count/u.bedCapacity*100) : NaN;

const div = document.createElement("div");
div.className="card";
div.style.boxShadow="none";
div.innerHTML = `
<div class="row" style="justify-content:space-between; align-items:flex-start">
<div>
<div class="mini muted">${escapeHtml(u.unitKey)}</div>
<div style="font-weight:900; font-size:16px; margin-top:2px">${escapeHtml(u.unitName||u.unitKey)}</div>
</div>
<span class="badge">${count}</span>
</div>
<div class="mini muted" style="margin-top:6px">${isFinite(pct)?`${count} / ${u.bedCapacity} (${fmtPct(pct)})`:"—"}</div>
<div class="row end noprint" style="margin-top:8px">
<button class="smallbtn" data-unit="${escapeHtml(u.unitKey)}">View Residents</button>
</div>
`;
unitCards.appendChild(div);
}

unitCards.querySelectorAll('button[data-unit]').forEach(btn=>{
if(btn.dataset.bound) return;
btn.dataset.bound="1";
btn.addEventListener("click", ()=>{
const unitKey = btn.getAttribute("data-unit");
if(typeof openUnitResidentListModal==="function") openUnitResidentListModal(unitKey);
});
});
}

function renderResidentSnapshot(s){
const sel = $("residentSelect");
if(!sel) return;

const includeDis = !!s.ui.includeDischarged;
const unitFilter = s.ui.unitFilter || "ALL";

let list = [];
if(includeDis){
list = Object.values(s.residentsById||{});
} else {
list = (s.census.activeResidentIds||[]).map(id=>s.residentsById[id]).filter(Boolean);
}

if(unitFilter!=="ALL"){
list = list.filter(r=>{
const uk = (typeof getUnitKeyFromAny==="function" ? getUnitKeyFromAny(r.unit||r.lockedUnit||"", s.config) : (r.unit||""))
|| (typeof inferUnitFromRoom==="function" ? inferUnitFromRoom(r.room||r.lockedRoom||"", s.config) : "")
|| "";
return uk === unitFilter;
});
}

list.sort((a,b)=>{
const ra = (a.room||a.lockedRoom||"");
const rb = (b.room||b.lockedRoom||"");
return ra.localeCompare(rb, undefined, {numeric:true}) || (a.name||"").localeCompare(b.name||"");
});

const cur = s.ui.selectedResidentId || "";
sel.innerHTML = `<option value="">— Select —</option>` + list.map(r=>{
const room = (r.status && r.status!=="active") ? (r.lockedRoom||r.room||"") : (r.room||"");
const label = `${room||"—"} — ${r.name||""} (${r.mrn||""})${(r.status && r.status!=="active")?" [Discharged]":""}`;
return `<option value="${escapeHtml(r.id)}">${escapeHtml(label)}</option>`;
}).join("");

if(cur && list.some(r=>r.id===cur)) sel.value = cur;
else sel.value = "";

if(!sel.dataset.bound){
sel.dataset.bound="1";
sel.addEventListener("change", ()=>{
const id = sel.value || "";
Store.patch(st=>{ st.ui.selectedResidentId = id; });
});
}

const btn = $("btnOpenProfile");
if(btn){
btn.disabled = !(sel.value);
}
}

function bindAdminControls(){
const s = Store.load();
const role = getEffectiveRole(s);
const rb = document.getElementById("roleBadge");
if(rb) rb.textContent = `Role: ${role}`;

const va = document.getElementById("viewAsRole");
const isAdmin = (getCurrentUser(s).role||"")==="Admin";
if(va){
va.style.display = isAdmin ? "" : "none";
va.value = (isAdmin && s.ui.viewAsRole) ? s.ui.viewAsRole : "";
if(!va.dataset.bound){
va.dataset.bound="1";
va.addEventListener("change", ()=>{
const v = va.value || "";
withAudit("Set View As Role", {role:v}, ()=> Store.patch(st=>{ st.ui.viewAsRole = v; }));
});
}
}

applyRoleToDOM(role);

const exp = document.getElementById("btnExportEncrypted");
if(exp) exp.style.display = canAdmin(s) ? "" : "none";
if(exp && !exp.dataset.bound){
exp.dataset.bound="1";
exp.addEventListener("click", ()=> withAudit("Export Encrypted Backup", {}, ()=>doExportEncrypted()));
}
const imp = document.getElementById("btnImportEncrypted");
const fileIn = document.getElementById("fileImportEncrypted");
if(imp) imp.style.display = canAdmin(s) ? "" : "none";
if(imp && fileIn && !imp.dataset.bound){
imp.dataset.bound="1";
imp.addEventListener("click", ()=> fileIn.click());
fileIn.addEventListener("change", async ()=>{
if(!fileIn.files || !fileIn.files[0]) return;
await withAudit("Import Encrypted Backup", {file: fileIn.files[0].name}, async ()=>doImportEncrypted(fileIn.files[0]));
fileIn.value="";
});
}

const exA = document.getElementById("btnExportAudit");
if(exA) exA.style.display = canAdmin(s) ? "" : "none";
if(exA && !exA.dataset.bound){
exA.dataset.bound="1";
exA.addEventListener("click", ()=>{
const st = Store.load();
if(!canAdmin(st)){ alert("Admin only."); return; }
const fname = `ICN_AuditLog_${new Date().toISOString().slice(0,10)}.json`;
downloadText(fname, JSON.stringify(st.auditLog||[], null, 2));
withAudit("Export Audit Log", {file: fname}, ()=> Store.patch(x=>{}));
});
}
const clr = document.getElementById("btnClearAudit");
if(clr) clr.style.display = canAdmin(s) ? "" : "none";
if(clr && !clr.dataset.bound){
clr.dataset.bound="1";
clr.addEventListener("click", ()=>{
const st = Store.load();
if(!canAdmin(st)){ alert("Admin only."); return; }
if(!confirm("Clear audit log?")) return;
withAudit("Clear Audit Log", {}, ()=> Store.patch(x=>{ x.auditLog = []; }));
});
}
}

function dayISO(d){
const dt = d ? new Date(d) : new Date();
const y = dt.getFullYear();
const m = String(dt.getMonth()+1).padStart(2,"0");
const da = String(dt.getDate()).padStart(2,"0");
return `${y}-${m}-${da}`;
}

function toDateInputValue(v){
  v = (v==null) ? "" : String(v).trim();
  if(!v) return "";
  if(/^\d{4}-\d{2}-\d{2}$/.test(v)) return v;
  // Try parse common formats
  const d = new Date(v);
  if(isNaN(d.getTime())) return "";
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const da = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${da}`;
}

function fromDateInputValue(v){
  v = String(v||"").trim();
  if(!v) return "";
  if(/^\d{4}-\d{2}-\d{2}$/.test(v)) return v;
  const d = new Date(v);
  if(isNaN(d.getTime())) return "";
  const z = (n)=> String(n).padStart(2,"0");
  return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;
}



// ===================== Tracker Filters (Name/MRN/Room) =====================
const FILTERS = { vax:"", ip:"", outbreak:"", prec:"", abt:"", actions:"" };
function setFilter(key, val){
  FILTERS[key] = String(val||"").trim().toLowerCase();
  try{ safeRenderAll(); }catch(e){}
}
function rowMatchesFilter(text, filter){
  if(!filter) return true;
  return String(text||"").toLowerCase().includes(filter);
}
// =================== End Tracker Filters ================================

function normalizeUnitName(u, config){
  const raw = String(u||"").trim();
  if(!raw) return "";
  // Already standardized
  if(/^Unit\s*[234]$/i.test(raw)) return "Unit " + raw.match(/[234]/)[0];
  try{
    // Try to map via config.units (unitKey/unitName)
    const key = (typeof unitKeyFromText==="function") ? unitKeyFromText(raw, config) : ((typeof unitKeyFromAny==="function") ? unitKeyFromAny(raw, config) : "");
    if(key && config && Array.isArray(config.units)) {
      const found = config.units.find(x=>String(x.unitKey)===String(key));
      if(found && found.unitName) return found.unitName;
    }
  }catch(e){}
  // Fallback: extract 2-4 if present
  const m = raw.match(/\b([234])\b/);
  if(m) return "Unit " + m[1];
  return raw;
}





function isSameDay(isoA, isoB){
return (isoA||"").slice(0,10) === (isoB||"").slice(0,10);
}
function getUnitKeyForCase(c, config){
const u = getUnitKeyFromAny(c.unit||"", config) || c.unit || "";
return u || "—";
}
function syndromeLabel(kind){
if(kind==="resp") return "Respiratory";
if(kind==="gi") return "GI";
if(kind==="skin") return "Skin";
if(kind==="uti") return "UTI";
return "Other";
}
function isoTypeFromPrec(p){
const t = (p.type||"").toUpperCase();
if(t.includes("DROPLET")) return "Droplet";
if(t.includes("AIRBORNE")) return "Airborne";
if(t.includes("CONTACT")) return "Contact";
if(t.includes("EBP") || t.includes("ENHANCED")) return "EBP";
return "Other";
}

function isPositiveResult(txt){
const s = (txt||"").toString().toLowerCase();
return s.includes("positive") || s.includes("detected") || s.includes("+");
}

function computeVaxStats(s, unitKey){
const today = dayISO(new Date());
const d0 = new Date(); d0.setDate(d0.getDate()-6);
const weekStart = dayISO(d0);
const weekEnd = today;

const activeIds = new Set((s.census?.activeResidentIds||[]));
const includeDis = !!s.ui.includeDischarged;

let rows = (s.modules.vax?.events||[]).slice();

if(unitKey && unitKey!=="ALL"){
rows = rows.filter(e=>{
const uk = getUnitKeyFromAny(e.unit||"", s.config) || e.unit || "";
return uk === unitKey;
});
}

if(!includeDis){
rows = rows.filter(e=> activeIds.has(e.residentId));
}

const iso = (e)=> mdyToISO(e.date||"") || (e.date||"").slice(0,10);

const pendingToday = rows.filter(e=> (e.status||"").toLowerCase()==="pending" && iso(e)===today);
const pendingWeek  = rows.filter(e=> (e.status||"").toLowerCase()==="pending" && iso(e)>=weekStart && iso(e)<=weekEnd);
const givenWeek    = rows.filter(e=> (e.status||"").toLowerCase()==="given" && iso(e)>=weekStart && iso(e)<=weekEnd);
const declinedWeek = rows.filter(e=> (e.status||"").toLowerCase()==="declined" && iso(e)>=weekStart && iso(e)<=weekEnd);

return {
today, weekStart, weekEnd,
pendingToday, pendingWeek,
givenWeek, declinedWeek
};
}

function openVaxPendingModal(mode, unitKey){
const s = Store.load();
const unit = unitKey || (s.ui.unitFilter||"ALL");
const stats = computeVaxStats(s, unit);
const list = mode==="today" ? stats.pendingToday : stats.pendingWeek;

const unitPretty = unit==="ALL" ? "All Units" : unitNamePretty(s, unit);
const title = mode==="today" ? `Vaccines Pending Today — ${unitPretty}` : `Vaccines Pending This Week — ${unitPretty}`;

setDrilldownExport({
type: "vax_pending",
title,
subtitle: mode==="today" ? stats.today : `${stats.weekStart} to ${stats.weekEnd}`,
columns: [
{key:"room",label:"Room"},
{key:"residentName",label:"Resident"},
{key:"mrn",label:"MRN"},
{key:"unit",label:"Unit"},
{key:"vaccineType",label:"Vaccine Type"},
{key:"date",label:"Date"},
{key:"status",label:"Status"},
{key:"notes",label:"Notes"}
],
rows: list.map(e=>({
room: e.room||"",
residentName: e.residentName||"",
mrn: e.mrn||"",
unit: unitNamePretty(s, getUnitKeyFromAny(e.unit||"", s.config) || e.unit || ""),
vaccineType: e.vaccineType||"",
date: e.date||"",
status: e.status||"",
notes: e.notes||""
}))
});

openModal(title, `
<div class="row end noprint" style="gap:8px">
<button class="smallbtn" onclick="printDrilldown()">Print</button>
<button class="smallbtn" onclick="exportDrilldownCSV()">Export CSV</button>
</div>
<div class="muted mini">Pending vaccine events in scope. Edit from the Vax tab if needed.</div>
<div class="sep"></div>

${list.length ? `
<table>
<thead><tr>
<th style="width:70px">Room</th>
<th>Resident</th>
<th style="width:120px">MRN</th>
<th style="width:110px">Unit</th>
<th style="width:200px">Vaccine</th>
<th style="width:120px">Date</th>
<th style="width:90px">Status</th>
<th>Notes</th>
</tr></thead>
<tbody>
${list.map(e=>`
<tr>
<td class="nowrap">${escapeHtml(e.room||"")}</td>
<td>${escapeHtml(e.residentName||"")}</td>
<td class="nowrap">${escapeHtml(e.mrn||"")}</td>
<td class="nowrap">${escapeHtml(unitNamePretty(s, getUnitKeyFromAny(e.unit||"", s.config) || e.unit || ""))}</td>
<td>${escapeHtml(e.vaccineType||"")}</td>
<td class="nowrap">${escapeHtml(e.date||"")}</td>
<td class="nowrap"><span class="badge blue">${escapeHtml((e.status||"pending").toUpperCase())}</span></td>
<td class="muted">${escapeHtml(e.notes||"")}</td>
</tr>
`).join("")}
</tbody>
</table>
` : `<div class="muted">No pending vaccines in this scope.</div>`}
`);
}

function openAbtSocGapsModal(unitKey){
const s = Store.load();
const unit = unitKey || (s.ui.unitFilter||"ALL");
const unitPretty = unit==="ALL" ? "All Units" : unitNamePretty(s, unit);
const gaps = computeAbtSocGapsRows(s, unit);

setDrilldownExport({
type:"abt_soc_gaps",
title:`ABT SOC Gaps — ${unitPretty}`,
subtitle:"Active antibiotics missing key stewardship documentation fields.",
columns:[
{key:"resident",label:"Resident"},
{key:"mrn",label:"MRN"},
{key:"unit",label:"Unit"},
{key:"room",label:"Room"},
{key:"antibiotic",label:"Antibiotic"},
{key:"start",label:"Start"},
{key:"missing",label:"Missing"}
],
rows:gaps
});

openModal(`ABT SOC Gaps — ${unitPretty}`, `
<div class="row end noprint" style="gap:8px">
<button class="smallbtn" onclick="printDrilldown()">Print</button>
<button class="smallbtn" onclick="exportDrilldownCSV()">Export CSV</button>
</div>
<div class="muted mini">Active antibiotic courses missing key documentation fields.</div>
<div class="sep"></div>

${gaps.length ? `
<table>
<thead><tr>
<th>Resident</th><th style="width:120px">MRN</th><th style="width:110px">Unit</th><th style="width:80px">Room</th>
<th style="width:180px">Antibiotic</th><th style="width:110px">Start</th><th>Missing</th>
</tr></thead>
<tbody>
${gaps.map(g=>`
<tr>
<td>${escapeHtml(g.resident)}</td>
<td class="nowrap">${escapeHtml(g.mrn)}</td>
<td class="nowrap">${escapeHtml(g.unit)}</td>
<td class="nowrap">${escapeHtml(g.room)}</td>
<td>${escapeHtml(g.antibiotic)}</td>
<td class="nowrap">${escapeHtml(g.start)}</td>
<td>${escapeHtml(g.missing)}</td>
</tr>
`).join("")}
</tbody>
</table>
` : `<div class="muted">No SOC gaps detected.</div>`}
`);
}

function computeTestStats(s, unitKey){
ensureIpData(s);
const today = dayISO(new Date());
let rows = (s.modules.ip.tests||[]).slice();

if(unitKey && unitKey!=="ALL"){
rows = rows.filter(t=>{
if(!t.residentId) return false;
const r = s.residentsById[t.residentId];
const uk = getUnitKeyFromAny(r?.unit||"", s.config) || r?.unit || "";
return uk === unitKey;
});
}

const counts = { Ordered:0, Pending:0, Resulted:0, Draft:0, RetestDue:0, UncommPositive:0 };
let tatSum=0, tatN=0;

for(const t of rows){
const st = testStatus(t);
counts[st] = (counts[st]||0) + 1;

if(t.retestDue && t.retestDue <= today && !t.resultedDate) counts.RetestDue++;

if(t.resultedDate && isPositiveResult(t.result) && (t.communicated||"N")!=="Y"){
counts.UncommPositive++;
}

const tat = daysBetween(t.collectedDate, t.resultedDate);
if(tat!==null){ tatSum += tat; tatN++; }
}

const avgTat = tatN ? (tatSum/tatN).toFixed(1) : "";
return { rows, counts, avgTat };
}

function openIpTestsListModal(payload){
const s = Store.load();
ensureIpData(s);
const unit = payload.unit || "ALL";
const mode = payload.mode || "pending";

const stats = computeTestStats(s, unit);
let rows = stats.rows;

const today = dayISO(new Date());
if(mode==="pending"){
rows = rows.filter(t=> testStatus(t)==="Pending");
} else if(mode==="retest"){
rows = rows.filter(t=> t.retestDue && t.retestDue <= today && !t.resultedDate);
} else if(mode==="uncommPos"){
rows = rows.filter(t=> t.resultedDate && isPositiveResult(t.result) && (t.communicated||"N")!=="Y");
} else if(mode==="ordered"){
rows = rows.filter(t=> testStatus(t)==="Ordered");
}

rows.sort((a,b)=> (a.retestDue||"").localeCompare(b.retestDue||"") || (b.orderedDate||"").localeCompare(a.orderedDate||""));

const title = mode==="pending" ? `Pending Tests — ${unit}` :
mode==="retest" ? `Retest Due — ${unit}` :
mode==="uncommPos" ? `Positive Not Communicated — ${unit}` :
`Tests — ${unit}`;

setDrilldownExport({
type: "ip_tests",
title,
subtitle: "Testing/Labs drilldown list",
columns: [
{key:"room", label:"Room"},
{key:"resident", label:"Resident"},
{key:"mrn", label:"MRN"},
{key:"testType", label:"Test Type"},
{key:"ordered", label:"Ordered"},
{key:"collected", label:"Collected"},
{key:"resulted", label:"Resulted"},
{key:"result", label:"Result"},
{key:"retestDue", label:"Retest Due"},
{key:"communicated", label:"Communicated"}
],
rows: rows.map(t=>{
const r = t.residentId ? s.residentsById[t.residentId] : null;
return {
room: r?.room || r?.lockedRoom || "",
resident: r?.name || "",
mrn: r?.mrn || "",
testType: t.testType||"",
ordered: t.orderedDate||"",
collected: t.collectedDate||"",
resulted: t.resultedDate||"",
result: t.result||"",
retestDue: t.retestDue||"",
communicated: (t.communicated||"N")==="Y" ? `Y (${t.communicatedDate||""})` : "N"
};
})
});

openModal(title, `
<div class="row end noprint" style="gap:8px">
<button class="smallbtn" onclick="printDrilldown()">Print</button>
<button class="smallbtn" onclick="exportDrilldownCSV()">Export CSV</button>
</div>
<div class="muted mini">Click Edit to update results/communication quickly.</div>
<div class="sep"></div>

${rows.length ? `
<table>
<thead><tr>
<th style="width:70px">Room</th>
<th>Resident</th>
<th style="width:120px">MRN</th>
<th style="width:150px">Test</th>
<th style="width:110px">Ordered</th>
<th style="width:110px">Collected</th>
<th style="width:110px">Resulted</th>
<th style="width:130px">Result</th>
<th style="width:110px">Retest</th>
<th style="width:110px">Comm</th>
<th style="width:140px" class="noprint edit-only">Actions</th>
</tr></thead>
<tbody>
${rows.map(t=>{
const r = t.residentId ? s.residentsById[t.residentId] : null;
const room = r?.room || r?.lockedRoom || "";
const name = r?.name || "";
const mrn = r?.mrn || "";
const comm = (t.communicated||"N")==="Y" ? "Y" : "N";
return `<tr>
<td class="nowrap">${escapeHtml(room)}</td>
<td>${escapeHtml(name)}</td>
<td class="nowrap">${escapeHtml(mrn)}</td>
<td>${escapeHtml(t.testType||"")}</td>
<td class="nowrap">${escapeHtml(t.orderedDate||"")}</td>
<td class="nowrap">${escapeHtml(t.collectedDate||"")}</td>
<td class="nowrap">${escapeHtml(t.resultedDate||"")}</td>
<td>${escapeHtml(t.result||"")}</td>
<td class="nowrap">${escapeHtml(t.retestDue||"")}</td>
<td class="nowrap">${escapeHtml(comm)}</td>
<td class="noprint edit-only nowrap">
<button class="smallbtn" onclick="openIpTestModal('${escapeHtml(t.id)}')">Edit</button>
<button class="smallbtn" onclick="jumpToResidentByMRN('${escapeHtml(mrn)}')">Resident</button>
</td>
</tr>`;
}).join("")}
</tbody>
</table>
` : `<div class="muted">No matching test records.</div>`}
`);
}

function computeAuditStats(s, unitKey){
ensureIpData(s);
const today = dayISO(new Date());
const d0 = new Date(); d0.setDate(d0.getDate()-6);
const from = dayISO(d0);

let rows = (s.modules.ip.audits||[]).slice();
if(unitKey && unitKey!=="ALL") rows = rows.filter(r=>(r.unit||"")===unitKey);
rows = rows.filter(r=>(r.date||"")>=from && (r.date||"")<=today);

const byType = {};
for(const r of rows){
const t = r.type || "Other";
if(!byType[t]) byType[t] = {total:0, non:0};
byType[t].total++;
if((r.compliant||"Y")==="N") byType[t].non++;
}
return {from, today, byType};
}

function openAuditDrilldownModal(payload){
const s = Store.load();
ensureIpData(s);
const unit = payload.unit || (s.ui.unitFilter||"ALL");
const auditType = payload.auditType || "ALL";
const from = payload.from || "";
const to = payload.to || "";

let rows = (s.modules.ip.audits||[]).slice();
if(unit!=="ALL") rows = rows.filter(r=>(r.unit||"")===unit);
if(auditType!=="ALL") rows = rows.filter(r=>(r.type||"")===auditType);
if(from) rows = rows.filter(r=>(r.date||"")>=from);
if(to) rows = rows.filter(r=>(r.date||"")<=to);
rows.sort((a,b)=> (b.date||"").localeCompare(a.date||"") || (b.time||"").localeCompare(a.time||""));

const non = rows.filter(r=>(r.compliant||"Y")==="N").length;
const unitPretty = unit==="ALL" ? "All Units" : unitNamePretty(s, unit);
const title = `Audit Drilldown — ${auditType==="ALL"?"All Types":auditType} (${unitPretty})`;

setDrilldownExport({
type:"audit_drilldown",
title,
subtitle:`${from||"…"} to ${to||"…"}`,
columns:[
{key:"date",label:"Date"},
{key:"time",label:"Time"},
{key:"type",label:"Type"},
{key:"unit",label:"Unit"},
{key:"location",label:"Location"},
{key:"observedBy",label:"Observed By"},
{key:"compliant",label:"Compliant"},
{key:"correction",label:"Correction"},
{key:"followupNeeded",label:"Follow-up"},
{key:"notes",label:"Notes"}
],
rows: rows.map(r=>({
date:r.date||"", time:r.time||"", type:r.type||"",
unit: r.unit?unitNamePretty(s,r.unit):"",
location:r.location||"", observedBy:r.observedBy||"",
compliant:r.compliant||"", correction:r.correction||"",
followupNeeded:r.followupNeeded||"", notes:r.notes||""
}))
});

openModal(title, `
<div class="row end noprint" style="gap:8px">
<button class="smallbtn" onclick="printDrilldown()">Print</button>
<button class="smallbtn" onclick="exportDrilldownCSV()">Export CSV</button>
</div>
<div class="muted mini">Non-compliance count: <b>${non}</b>. Scope: ${escapeHtml(from||"…")} to ${escapeHtml(to||"…")}.</div>
<div class="sep"></div>
<table>
<thead><tr>
<th style="width:110px">Date</th><th style="width:90px">Time</th><th style="width:140px">Type</th><th style="width:120px">Unit</th>
<th style="width:220px">Location</th><th style="width:140px">Observed By</th><th style="width:100px">Compliant</th><th>Notes</th>
</tr></thead>
<tbody>
${rows.length?rows.map(r=>{
const comp = (r.compliant||"Y")==="Y";
return `<tr>
<td class="nowrap">${escapeHtml(r.date||"")}</td>
<td class="nowrap">${escapeHtml(r.time||"")}</td>
<td>${escapeHtml(r.type||"")}</td>
<td class="nowrap">${escapeHtml(r.unit?unitNamePretty(s,r.unit):"—")}</td>
<td>${escapeHtml(r.location||"")}</td>
<td>${escapeHtml(r.observedBy||"")}</td>
<td class="nowrap">${comp?`<span class="badge green">YES</span>`:`<span class="badge red">NO</span>`}</td>
<td class="muted">${escapeHtml(r.notes||"")}${r.correction?`<div class="mini">Correction: ${escapeHtml(r.correction)}</div>`:""}</td>
</tr>`;
}).join(""):`<tr><td colspan="8" class="muted">No audits in scope.</td></tr>`}
</tbody>
</table>
`);
}

function computeSituationBoard(s){
ensureIpData(s);
const today = dayISO(new Date());

const unitFilter = s.ui.unitFilter || "ALL";

let cases = (s.modules.ip.lineListCases||[]);
if(unitFilter!=="ALL"){
cases = cases.filter(c => (getUnitKeyForCase(c, s.config)) === unitFilter);
}
const activeCases = cases.filter(c=> (c.status||"active")!=="resolved");
const newToday = cases.filter(c=> isSameDay(c.createdAt||c.onsetDate||"", today));

const byUnit = (arr)=>{
const map = {};
for(const c of arr){
const uk = getUnitKeyForCase(c, s.config);
map[uk] = (map[uk]||0)+1;
}
return map;
};

const synd = { Respiratory:0, GI:0, Skin:0, UTI:0, Other:0 };
for(const c of activeCases){
const k = c.kind || "other";
const label = syndromeLabel(k);
if(label==="Respiratory") synd.Respiratory++;
else if(label==="GI") synd.GI++;
else if(label==="Skin") synd.Skin++;
else if(label==="UTI") synd.UTI++;
else synd.Other++;
}

let prec = (s.modules.ip.precautions||[]).filter(p=>p.status==="active");
if(unitFilter!=="ALL"){
prec = prec.filter(p=> (getUnitKeyFromAny(p.unit||"", s.config) || p.unit) === unitFilter);
}
const iso = { Contact:0, Droplet:0, Airborne:0, EBP:0, Other:0 };
for(const p of prec){
const t = isoTypeFromPrec(p);
iso[t] = (iso[t]||0)+1;
}

const abt = (s.modules.abt?.courses||[]);
let abtToday = abt.filter(c=> isSameDay(c.createdAt||c.startDate||"", today));
if(unitFilter!=="ALL"){
abtToday = abtToday.filter(c=> (getUnitKeyFromAny(c.unit||"", s.config) || c.unit) === unitFilter);
}
const abtByUnit = {};
for(const c of abtToday){
const uk = (getUnitKeyFromAny(c.unit||"", s.config) || c.unit || "—");
abtByUnit[uk] = (abtByUnit[uk]||0)+1;
}

const testStats = computeTestStats(s, unitFilter);

const abtAll = (s.modules.abt?.courses||[]);
let abtActive = abtAll.filter(c=>abtIsActiveCourse(c));
if(unitFilter!=="ALL"){
abtActive = abtActive.filter(c=>{
const uk = getUnitKeyFromAny(c.unit||"", s.config) || c.unit || "";
return uk === unitFilter;
});
}
const abtSocGaps = computeAbtSocGapsRows(s, unitFilter);

const vaxStats = computeVaxStats(s, unitFilter);

const auditStats = computeAuditStats(s, unitFilter);

const staffStats = computeStaffStats(s, unitFilter);

const envStats = computeEnvStats(s, unitFilter);
const cc = s.modules.ip.commandCenter || {outbreakStatus:"None", statusNotes:""};
const status = cc.outbreakStatus || "None";
const statusNotes = cc.statusNotes || "";

const alerts = [];

const tMap = auditStats.byType || {};
const mkPct = (v)=> v.total ? Math.round(((v.total - v.non)/v.total)*100) : 100;
const mkTrig = (type, minN, maxPct)=>{
const v = tMap[type];
if(!v || v.total < minN) return;
const pct = mkPct(v);
if(pct <= maxPct){
alerts.push({
severity: (pct<=70 ? "high" : "med"),
title: `${type} audit compliance low`,
detail: `${pct}% compliance (${v.total - v.non}/${v.total}) in the last 7 days.`,
action: { type:"audits", auditType:type, unit: unitFilter, from: auditStats.from, to: auditStats.today }
});
}
};
mkTrig("PPE", 8, 85);
mkTrig("Hand Hygiene", 8, 85);
mkTrig("Isolation/Precautions", 5, 90);
mkTrig("EBP", 5, 90);
mkTrig("Cleaning", 5, 90);

const lookbackDays = 3;
const cutoff = new Date(); cutoff.setDate(cutoff.getDate()-lookbackDays);
const cutoffISO = dayISO(cutoff);
const recentActive = activeCases.filter(c=>{
const d = (c.onsetDate||c.createdAt||"").slice(0,10);
return d && d >= cutoffISO;
});

const unitGroups = {};
for(const c of recentActive){
const uk = getUnitKeyForCase(c, s.config);
if(!unitGroups[uk]) unitGroups[uk] = [];
unitGroups[uk].push(c);
}

Object.keys(unitGroups).forEach(uk=>{
const arr = unitGroups[uk];
const giCount = arr.filter(c=>c.kind==="gi").length;
const respCount = arr.filter(c=>c.kind==="resp").length;

if(giCount >= 2){
alerts.push({
severity:"high",
title:`GI cluster signal in ${uk}`,
detail:`${giCount} GI cases within last ${lookbackDays} days. Consider outbreak actions (line list, contact tracing, enhanced cleaning).`,
action:{ type:'ip', kind:'gi', unit:uk, days:lookbackDays }
});
}
if(respCount >= 2){
alerts.push({
severity:"high",
title:`Respiratory cluster signal in ${uk}`,
detail:`${respCount} respiratory cases within last ${lookbackDays} days. Consider droplet precautions/testing plan.`,
action:{ type:'ip', kind:'resp', unit:uk, days:lookbackDays }
});
}
});

const abtCount = abtToday.length;
if(abtCount >= 3){
alerts.push({
severity:"med",
title:"Antibiotic start spike today",
detail:`${abtCount} new antibiotic starts today. Review for possible syndromic clusters and line listing needs.`,
action:{ type:'abt', days:1 }
});
}

if(status !== "None" && activeCases.length === 0){
alerts.push({
severity:"low",
title:"Status set but no active cases detected",
detail:"Outbreak status is not 'None' but active cases count is 0. Confirm cases list or update status."
});
}

if(iso.Airborne > 0){
alerts.push({
severity:"med",
title:"Airborne precautions present",
detail:`${iso.Airborne} resident(s) on airborne precautions. Verify signage, PPE supply, and staff education.`,
action:{ type:'ipPrec', days:lookbackDays }
});
}

if(testStats.counts.RetestDue > 0){
alerts.push({
severity:"med",
title:"Retest due today/overdue",
detail:`${testStats.counts.RetestDue} test(s) have a retest due date today or earlier (not resulted).`,
action:{ type:"ipTests", mode:"retest", unit: unitFilter, days: 1 }
});
}

if(testStats.counts.UncommPositive > 0){
alerts.push({
severity:"high",
title:"Positive result not marked as communicated",
detail:`${testStats.counts.UncommPositive} positive test(s) have not been marked as communicated.`,
action:{ type:"ipTests", mode:"uncommPos", unit: unitFilter, days: 7 }
});
}

if(testStats.counts.Pending >= 5){
alerts.push({
severity:"low",
title:"Pending tests backlog",
detail:`${testStats.counts.Pending} tests are pending. Review turnaround time and follow-up.`,
action:{ type:"ipTests", mode:"pending", unit: unitFilter, days: 7 }
});
}

if(abtSocGaps.length > 0){
alerts.push({
severity: abtSocGaps.length >= 5 ? "med" : "low",
title: "ABT stewardship documentation gaps",
detail: `${abtSocGaps.length} active antibiotic course(s) are missing key fields (indication/source/stop date/route).`,
action:{ type:"abtSoc", unit: unitFilter, days: 7 }
});
}

if(vaxStats.pendingToday.length > 0){
alerts.push({
severity: vaxStats.pendingToday.length >= 5 ? "med" : "low",
title: "Vaccines pending today",
detail: `${vaxStats.pendingToday.length} pending vaccine event(s) due today.`,
action:{ type:"vaxPending", mode:"today", unit: unitFilter, days: 1 }
});
}

if(vaxStats.pendingWeek.length >= 10){
alerts.push({
severity: "low",
title: "Vaccines pending this week",
detail: `${vaxStats.pendingWeek.length} pending vaccine event(s) scheduled this week.`,
action:{ type:"vaxPending", mode:"week", unit: unitFilter, days: 7 }
});
}

const sc = staffStats.counts || {};
if((sc["Positive"]||0) > 0){
alerts.push({
severity: "high",
title: "Staff positive cases logged",
detail: `${sc["Positive"]} staff positive case(s) in last 7 days.`,
action: { type:"staffIllness", unit: unitFilter, status:"Positive", from: staffStats.from7, to: staffStats.today }
});
}
if((sc["Test Pending"]||0) >= 2){
alerts.push({
severity: "med",
title: "Staff tests pending",
detail: `${sc["Test Pending"]} staff with tests pending in last 7 days.`,
action: { type:"staffIllness", unit: unitFilter, status:"Test Pending", from: staffStats.from7, to: staffStats.today }
});
}
if((sc["Symptomatic"]||0) >= 2){
alerts.push({
severity: "med",
title: "Staff symptomatic cluster signal",
detail: `${sc["Symptomatic"]} staff symptomatic entries in last 7 days.`,
action: { type:"staffIllness", unit: unitFilter, status:"Symptomatic", from: staffStats.from7, to: staffStats.today }
});
}

if((envStats.activeCleaning||[]).length > 0){
alerts.push({
severity: "low",
title: "Enhanced cleaning active",
detail: `${envStats.activeCleaning.length} enhanced cleaning event(s) currently active.`,
action: { type:"env", kind:"cleanActive", unit: unitFilter }
});
}
if((envStats.overdueEquip||[]).length > 0){
alerts.push({
severity: ((envStats.overdueEquip.length>=3) ? "med" : "low"),
title: "Overdue equipment cleaning",
detail: `${envStats.overdueEquip.length} shared equipment item(s) overdue for cleaning.`,
action: { type:"env", kind:"equipOverdue", unit: unitFilter }
});
}
if((envStats.lowSupplies||[]).length > 0){
alerts.push({
severity: "med",
title: "PPE supplies below par",
detail: `${envStats.lowSupplies.length} supply item(s) below par level.`,
action: { type:"env", kind:"suppliesLow", unit: unitFilter }
});
}
return {
auditStats,
staffStats,
envStats,
abtActiveCount: abtActive.length,
abtSocGaps,
vaxStats,

testStats,
today,
status, statusNotes,
newCases: newToday.length,
activeCases: activeCases.length,
newByUnit: byUnit(newToday),
activeByUnit: byUnit(activeCases),
synd,
iso,
abtStarts: abtToday.length,
abtByUnit,
alerts
};
}

function fmtByUnit(map){
const keys = Object.keys(map||{}).sort((a,b)=>a.localeCompare(b));
if(!keys.length) return "—";
return keys.map(k=>`${k}: ${map[k]}`).join(" · ");
}

function jumpToResidentByMRN(mrn){
const s = Store.load();
const key = (mrn||"").trim().toUpperCase();
if(!key){ alert("No MRN available for this case."); return; }
const res = Object.values(s.residentsById||{}).find(r=> (r.mrn||"").toUpperCase()===key);
if(!res){ alert("Resident not found in database (MRN not in current records)."); return; }
Store.patch(st=>{ st.ui.selectedResidentId = res.id; });
if(typeof setTab==="function") setTab("dashboard");
}

function openCaseDrilldownModal(payload){
const s = Store.load();
ensureIpData(s);
const kind = payload.kind || "resp";
const unit = payload.unit || "ALL";
const start = (payload.startISO||"").slice(0,10);
const end = (payload.endISO||"").slice(0,10);

let rows = (s.modules.ip.lineListCases||[]).filter(c=>{ const k=(c&&c.kind)||''; return String(k).toLowerCase()===String(kind).toLowerCase(); });
  // If you have IP cases but none show here, it is usually a kind-label mismatch from legacy imports.
  // ensureIpData() normalizes most variants; this is a last-resort hint.

if(unit!=="ALL"){
rows = rows.filter(c => (getUnitKeyFromAny(c.unit||"", s.config) || c.unit) === unit);
}
rows = rows.filter(c=>{
const d = (c.onsetDate || c.createdAt || "").slice(0,10);
if(!d) return false;
if(start && d < start) return false;
if(end && d > end) return false;
return (c.status||"active")!=="resolved";
});
rows.sort((a,b)=> (a.room||"").localeCompare(b.room||"", undefined, {numeric:true}) || (a.name||"").localeCompare(b.name||""));

const title = `${kind==="gi"?"GI":"Respiratory"} Cases — ${unit}${start&&end?` (${start} to ${end})`:""}`;

setDrilldownExport({
type: "ip_cases",
title,
subtitle: "Active cases in alert window",
columns: [
{key:"room", label:"Room"},
{key:"resident", label:"Resident"},
{key:"mrn", label:"MRN"},
{key:"onset", label:"Onset"},
{key:"unit", label:"Unit"},
{key:"caseType", label:"Type"}
],
rows: rows.map(c=>({
room: c.room||"",
resident: c.name||"",
mrn: c.mrn||"",
onset: (c.onsetDate||c.createdAt||"").slice(0,10),
unit: unit,
caseType: (kind==="gi" ? "GI" : "Respiratory")
}))
});
openModal(title, `
<div class="row end noprint" style="gap:8px">
<button class="smallbtn" onclick="printDrilldown()">Print</button>
<button class="smallbtn" onclick="exportDrilldownCSV()">Export CSV</button>
</div>
<div class="muted mini">Showing active cases that triggered the alert window.</div>
<div class="sep"></div>
${rows.length ? `
<table>
<thead><tr>
<th style="width:70px">Room</th>
<th>Resident</th>
<th style="width:120px">MRN</th>
<th style="width:110px">Onset</th>
<th style="width:120px">Actions</th>
</tr></thead>
<tbody>
${rows.map(c=>`
<tr>
<td class="nowrap">${escapeHtml(c.room||"")}</td>
<td>${escapeHtml(c.name||"")}</td>
<td class="nowrap">${escapeHtml(c.mrn||"")}</td>
<td class="nowrap">${escapeHtml((c.onsetDate||c.createdAt||"").slice(0,10))}</td>
<td class="nowrap">
<button class="smallbtn" onclick="openIpCaseModal('${escapeHtml(c.id)}')">Open Case</button>
<button class="smallbtn" onclick="jumpToResidentByMRN('${escapeHtml(c.mrn||"")}')">Resident</button>
</td>
</tr>
`).join("")}
</tbody>
</table>
` : `<div class="muted">No matching cases found.</div>`}
`);
}

function openPrecautionsDrilldownModal(payload){
const s = Store.load();
ensureIpData(s);
const unit = payload.unit || (s.ui.unitFilter||"ALL");
const iso = payload.iso || "Airborne";

let rows = (s.modules.ip.precautions||[]).filter(p=>p.status==="active");
if(unit!=="ALL"){
rows = rows.filter(p=> (getUnitKeyFromAny(p.unit||"", s.config) || p.unit) === unit);
}
rows = rows.filter(p => isoTypeFromPrec(p) === iso);
rows.sort((a,b)=> (a.room||"").localeCompare(b.room||"", undefined, {numeric:true}) || (a.residentName||"").localeCompare(b.residentName||""));

setDrilldownExport({
type: "ip_precautions",
title: `${iso} Precautions — ${unit}`,
subtitle: "Active precautions matching the alert",
columns: [
{key:"room", label:"Room"},
{key:"resident", label:"Resident"},
{key:"type", label:"Type"},
{key:"source", label:"Source"},
{key:"duration", label:"Duration"},
{key:"unit", label:"Unit"}
],
rows: rows.map(p=>({
room: p.room||"",
resident: p.residentName||"",
type: p.type||"",
source: p.infectedSource||"",
duration: p.duration||"",
unit: unit
}))
});
openModal(`${iso} Precautions — ${unit}`, `
<div class="row end noprint" style="gap:8px">
<button class="smallbtn" onclick="printDrilldown()">Print</button>
<button class="smallbtn" onclick="exportDrilldownCSV()">Export CSV</button>
</div>
<div class="muted mini">Active precautions matching the alert.</div>
<div class="sep"></div>
${rows.length ? `
<table>
<thead><tr>
<th style="width:70px">Room</th>
<th>Resident</th>
<th style="width:160px">Type</th>
<th>Source</th>
<th style="width:120px">Duration</th>
</tr></thead>
<tbody>
${rows.map(p=>`
<tr>
<td class="nowrap">${escapeHtml(p.room||"")}</td>
<td>${escapeHtml(p.residentName||"")}</td>
<td class="nowrap">${escapeHtml(p.type||"")}</td>
<td>${escapeHtml(p.infectedSource||"")}</td>
<td class="nowrap">${escapeHtml(p.duration||"")}</td>
<td class="noprint edit-only"><button class="smallbtn" onclick="openEditPrecautionModal('${escapeHtml(p.id)}')">Edit</button></td>
</tr>
`).join("")}
</tbody>
</table>
` : `<div class="muted">No matching precautions found.</div>`}
`);
}

function openAbtStartsModal(payload){
const s = Store.load();
const unit = payload.unit || (s.ui.unitFilter||"ALL");
const start = (payload.startISO||dayISO(new Date())).slice(0,10);
const end = (payload.endISO||start).slice(0,10);

let rows = (s.modules.abt?.courses||[]);
if(unit!=="ALL"){
rows = rows.filter(c=> (getUnitKeyFromAny(c.unit||"", s.config) || c.unit) === unit);
}
rows = rows.filter(c=>{
const d = (c.createdAt || c.startDate || "").slice(0,10);
if(!d) return false;
if(start && d < start) return false;
if(end && d > end) return false;
return true;
});
rows.sort((a,b)=> (a.room||"").localeCompare(b.room||"", undefined, {numeric:true}) || (a.residentName||"").localeCompare(b.residentName||""));

setDrilldownExport({
type: "abt_starts",
title: `ABT Starts — ${unit} (${start})`,
subtitle: "Antibiotic starts in the alert window",
columns: [
{key:"room", label:"Room"},
{key:"resident", label:"Resident"},
{key:"mrn", label:"MRN"},
{key:"antibiotic", label:"Antibiotic"},
{key:"start", label:"Start Date"},
{key:"unit", label:"Unit"}
],
rows: rows.map(c=>({
room: c.room||"",
resident: c.residentName||"",
mrn: c.mrn||"",
antibiotic: c.antibiotic||"",
start: (c.startDate||c.createdAt||"").slice(0,10),
unit: unit
}))
});
openModal(`ABT Starts — ${unit} (${start})`, `
<div class="row end noprint" style="gap:8px">
<button class="smallbtn" onclick="printDrilldown()">Print</button>
<button class="smallbtn" onclick="exportDrilldownCSV()">Export CSV</button>
</div>
<div class="muted mini">Antibiotic starts in the alert window.</div>
<div class="sep"></div>
${rows.length ? `
<table>
<thead><tr>
<th style="width:70px">Room</th>
<th>Resident</th>
<th style="width:120px">MRN</th>
<th style="width:140px">Antibiotic</th>
<th style="width:120px">Start</th>
<th style="width:120px">Actions</th>
</tr></thead>
<tbody>
${rows.map(c=>`
<tr>
<td class="nowrap">${escapeHtml(c.room||"")}</td>
<td>${escapeHtml(c.residentName||"")}</td>
<td class="nowrap">${escapeHtml(c.mrn||"")}</td>
<td>${escapeHtml(c.antibiotic||"")}</td>
<td class="nowrap">${escapeHtml((c.startDate||c.createdAt||"").slice(0,10))}</td>
<td class="nowrap">
<button class="smallbtn" onclick="jumpToResidentByMRN('${escapeHtml(c.mrn||"")}')">Resident</button>
</td>
</tr>
`).join("")}
</tbody>
</table>
` : `<div class="muted">No matching ABT starts found.</div>`}
`);
}

function tryOpenPendingDrilldown(s){
const pd = s?.ui?.pendingDrilldown;
if(!pd) return;

s.ui.pendingDrilldown = null;
Store.save(s);

setTimeout(()=>{
try{
if(pd.type==="ipCases") openCaseDrilldownModal(pd);
else if(pd.type==="ipPrec") openPrecautionsDrilldownModal(pd);
else if(pd.type==="abtStarts") openAbtStartsModal(pd);
}catch(e){ console.error(e); }
}, 200);
}

function convertAlertToAction(alert){
const s0 = Store.load();
ensureIpData(s0);

const unit = alert?.action?.unit || s0.ui.unitFilter || "";
const kind = alert?.action?.kind || "";
const title = (alert?.title||"Alert").replace(/\s+/g," ").trim();
const detail = (alert?.detail||"").trim();

const today = dayISO(new Date());
const dueD = new Date(); dueD.setDate(dueD.getDate()+1);
const due = dayISO(dueD);

const suggested = [];
if(kind==="gi"){
suggested.push("Review GI line list and confirm case definition; consider enhanced cleaning and appropriate isolation.");
}else if(kind==="resp"){
suggested.push("Review respiratory line list; verify droplet/EBP use; assess testing and cohorting plan.");
}else{
suggested.push("Review details and document containment plan.");
}
suggested.push("Document communications (provider/family/staff) and update outbreak status if needed.");

const item = `${title} — ${detail}`.slice(0,240);
const notes = `Auto-created from alert on ${today}.\n\nSuggested next steps:\n- ${suggested.join("\n- ")}\n\nEvidence/trigger:\n${detail}`;

withAudit("Convert Alert → Action Item", {title, unit, kind}, ()=>Store.patch(s=>{
ensureIpData(s);
const me = getCurrentUser(s);
const a = {
id: uid("act"),
date: today,
dueDate: due,
status: "Open",
owner: me.name || "",
unit: unit || "",
priority: (alert?.severity==="high") ? "High" : (alert?.severity==="med" ? "Medium" : "Low"),
item,
notes,
createdAt: nowISO(),
updatedAt: nowISO(),
createdBy: me.name||"",
updatedBy: me.name||"",
followUps: [
{ label:"7-day", due:"", done:"", result:"" },
{ label:"30-day", due:"", done:"", result:"" },
{ label:"90-day", due:"", done:"", result:"" }
],
effectiveness: { status:"", note:"" },
effectOutcome: "",
verifiedBy: "",
verifiedDate: "",
verificationMethod: "",
effectNotes: ""
};
s.modules.ip.actions.push(a);
s.ui.pendingDrilldown = { type:"openAction", actionId: a.id };
}));

if(typeof setTab==="function") setTab("decisions");
}

function runAlertDrilldown(act){
const s0 = Store.load();
const today = dayISO(new Date());
const days = Math.max(1, Number(act.days||3));
const startD = new Date(); startD.setDate(startD.getDate()-(days-1));
const startISO = dayISO(startD);
const endISO = today;

if(act.type==="ip"){
withAudit("Drilldown Alert", {type:"ip", kind:act.kind, unit:act.unit, days}, ()=>Store.patch(s=>{
ensureIpData(s);
s.ui.unitFilter = act.unit || "ALL";
s.modules.ip.ui.view = act.kind || "resp";
s.modules.ip.ui.alertFilter = { kind: (act.kind||"resp"), startISO, endISO, unit: act.unit||"" };
s.ui.pendingDrilldown = { type:"ipCases", kind:(act.kind||"resp"), unit:(act.unit||"ALL"), startISO, endISO };
}));
if(typeof setTab==="function") setTab("ip");
return;
}

if(act.type==="ipPrec"){
withAudit("Drilldown Alert", {type:"ipPrec", iso:"Airborne", days}, ()=>Store.patch(s=>{
ensureIpData(s);
s.modules.ip.ui.view = "prec";
s.modules.ip.ui.alertFilter = null;
s.ui.pendingDrilldown = { type:"ipPrec", iso:"Airborne", unit:(s.ui.unitFilter||"ALL") };
}));
if(typeof setTab==="function") setTab("ip");
return;
}

if(act.type==="abt"){
withAudit("Drilldown Alert", {type:"abt", days}, ()=>Store.patch(s=>{
const unit = s.ui.unitFilter || "ALL";
s.ui.pendingDrilldown = { type:"abtStarts", unit, startISO, endISO };
}));
if(typeof setTab==="function") setTab("abt");
return;
}
if(act.type==="ipTests"){
const unit = act.unit || (Store.load().ui.unitFilter||"ALL");
const mode = act.mode || "pending";
withAudit("Drilldown Alert", {type:"ipTests", mode, unit}, ()=>Store.patch(s=>{
ensureIpData(s);
s.ui.unitFilter = unit;
s.modules.ip.ui.view = "tests";
s.ui.pendingDrilldown = { type:"ipTestsList", unit, mode };
}));
if(typeof setTab==="function") setTab("ip");
return;
}

if(act.type==="abtSoc"){
const unit = act.unit || (Store.load().ui.unitFilter||"ALL");
withAudit("Drilldown Alert", {type:"abtSoc", unit}, ()=>Store.patch(s=>{
ensureIpData(s);
s.ui.unitFilter = unit;
s.ui.pendingDrilldown = { type:"abtSocList", unit };
}));
if(typeof setTab==="function") setTab("dashboard");
return;
}

if(act.type==="vaxPending"){
const unit = act.unit || (Store.load().ui.unitFilter||"ALL");
const mode = act.mode || "today";
withAudit("Drilldown Alert", {type:"vaxPending", unit, mode}, ()=>Store.patch(s=>{
s.ui.unitFilter = unit;
s.ui.pendingDrilldown = { type:"vaxPendingList", unit, mode };
}));
if(typeof setTab==="function") setTab("dashboard");
return;
}

if(act.type==="audits"){
const unit = act.unit || (Store.load().ui.unitFilter||"ALL");
const auditType = act.auditType || "ALL";
withAudit("Drilldown Alert", {type:"audits", unit, auditType}, ()=>Store.patch(s=>{
ensureIpData(s);
s.ui.unitFilter = unit;
s.ui.pendingDrilldown = { type:"auditDrilldown", unit, auditType, from: act.from||"", to: act.to||"" };
}));
if(typeof setTab==="function") setTab("dashboard");
return;
}

if(act.type==="staffIllness"){
const unit = act.unit || (Store.load().ui.unitFilter||"ALL");
const status = act.status || "ALL";
withAudit("Drilldown Alert", {type:"staffIllness", unit, status}, ()=>Store.patch(s=>{
ensureIpData(s);
s.ui.unitFilter = unit;
s.ui.pendingDrilldown = { type:"staffDrilldown", unit, status, from: act.from||"", to: act.to||"" };
}));
if(typeof setTab==="function") setTab("dashboard");
return;
}

if(act.type==="env"){
const unit = act.unit || (Store.load().ui.unitFilter||"ALL");
const kind = act.kind || "";
withAudit("Drilldown Alert", {type:"env", unit, kind}, ()=>Store.patch(s=>{
ensureIpData(s);
s.ui.unitFilter = unit;
s.ui.pendingDrilldown = { type:"envDrilldown", unit, kind };
}));
if(typeof setTab==="function") setTab("dashboard");
return;
}

}

function renderSituationBoard(s){
const card = document.getElementById("situationBoardCard");
if(!card) return;

ensureIpData(s);
const data = computeSituationBoard(s);

const sel = document.getElementById("outbreakStatusSel");
const notes = document.getElementById("outbreakStatusNotes");
const btn = document.getElementById("btnSaveStatus");
if(sel){
sel.value = s.modules.ip.commandCenter.outbreakStatus || "None";
}
if(notes){
notes.value = s.modules.ip.commandCenter.statusNotes || "";
}
if(btn && !btn.dataset.bound){
btn.dataset.bound="1";
btn.addEventListener("click", ()=>{
const v = document.getElementById("outbreakStatusSel")?.value || "None";
const n = (document.getElementById("outbreakStatusNotes")?.value||"").trim();
withAudit("Update Outbreak Status", {status:v}, ()=>Store.patch(st=>{
ensureIpData(st);
st.modules.ip.commandCenter.outbreakStatus = v;
st.modules.ip.commandCenter.statusNotes = n;
st.modules.ip.commandCenter.updatedAt = nowISO();
}));
});
}

const setText = (id, val)=>{
const el=document.getElementById(id);
if(el) el.textContent = val;
};
setText("sbNewCases", String(data.newCases));
setText("sbActiveCases", String(data.activeCases));
setText("sbNewCasesByUnit", fmtByUnit(data.newByUnit));
setText("sbActiveCasesByUnit", fmtByUnit(data.activeByUnit));

const stBadge = document.getElementById("sbOutbreakStatus");
if(stBadge){
stBadge.textContent = data.status;
stBadge.className = "badge " + (data.status==="None" ? "" : (data.status==="Watch" ? "green" : (data.status==="Controlled" ? "green" : "red")));
}
setText("sbOutbreakStatusNotes", data.statusNotes || "—");

setText("sbSyndromeTotal", String(data.activeCases));
const sb = document.getElementById("sbSyndromeBreakdown");
if(sb){
const entries = [
["Respiratory", data.synd.Respiratory],
["GI", data.synd.GI],
["Skin", data.synd.Skin],
["UTI", data.synd.UTI],
["Other", data.synd.Other]
];
sb.innerHTML = entries.filter(e=>e[1]>0).map(([k,v])=>`<span class="badge">${escapeHtml(k)}: ${v}</span>`).join("")
|| `<span class="muted">No active cases</span>`;
}

const isoTotal = data.iso.Contact + data.iso.Droplet + data.iso.Airborne + data.iso.EBP + data.iso.Other;
setText("sbIsoTotal", String(isoTotal));
const ib = document.getElementById("sbIsoBreakdown");
if(ib){
const entries = [
["Contact", data.iso.Contact],
["Droplet", data.iso.Droplet],
["Airborne", data.iso.Airborne],
["EBP", data.iso.EBP],
["Other", data.iso.Other]
];
ib.innerHTML = entries.filter(e=>e[1]>0).map(([k,v])=>`<span class="badge">${escapeHtml(k)}: ${v}</span>`).join("")
|| `<span class="muted">No active precautions</span>`;
}

setText("sbAbtStarts", String(data.abtStarts));
setText("sbAbtStartsByUnit", fmtByUnit(data.abtByUnit));

setText("sbAbtActive", String(data.abtActiveCount||0));
const socChip = document.getElementById("sbAbtSocChip");
if(socChip){
const n = (data.abtSocGaps||[]).length || 0;
socChip.innerHTML = `<span class="badge ${n? "red":""}">SOC gaps: ${n}</span>`;
}

const vs = data.vaxStats || {pendingToday:[], pendingWeek:[], givenWeek:[], declinedWeek:[], today:"", weekStart:"", weekEnd:""};
setText("sbVaxPendingToday", String(vs.pendingToday.length||0));
const pc = document.getElementById("sbVaxPendingChips");
if(pc){
pc.innerHTML = `<span class="badge blue">Pending today: ${vs.pendingToday.length||0}</span>` +
`<span class="badge">Pending week: ${vs.pendingWeek.length||0}</span>`;
}
setText("sbVaxGivenWeek", String(vs.givenWeek.length||0));
const wc = document.getElementById("sbVaxWeekChips");
if(wc){
wc.innerHTML = `<span class="badge green">Given: ${vs.givenWeek.length||0}</span>` +
`<span class="badge">Declined: ${vs.declinedWeek.length||0}</span>`;
}

const bAbtA = document.getElementById("btnOpenAbtActive");
if(bAbtA && !bAbtA.dataset.bound){
bAbtA.dataset.bound="1";
bAbtA.addEventListener("click", ()=>printAbtActiveReport());
}
const bAbtS = document.getElementById("btnOpenAbtSoc");
if(bAbtS && !bAbtS.dataset.bound){
bAbtS.dataset.bound="1";
bAbtS.addEventListener("click", ()=>openAbtSocGapsModal(s.ui.unitFilter||"ALL"));
}

const bVt = document.getElementById("btnOpenVaxToday");
if(bVt && !bVt.dataset.bound){
bVt.dataset.bound="1";
bVt.addEventListener("click", ()=>openVaxPendingModal("today", s.ui.unitFilter||"ALL"));
}
const bVw = document.getElementById("btnOpenVaxWeek");
if(bVw && !bVw.dataset.bound){
bVw.dataset.bound="1";
bVw.addEventListener("click", ()=>openVaxPendingModal("week", s.ui.unitFilter||"ALL"));
}
const bVp = document.getElementById("btnOpenVaxWeeklyPrint");
if(bVp && !bVp.dataset.bound){
bVp.dataset.bound="1";
bVp.addEventListener("click", ()=>printVaxWeeklyFromReports());
}
const bVa = document.getElementById("btnOpenVaxAdd");
if(bVa && !bVa.dataset.bound){
bVa.dataset.bound="1";
bVa.addEventListener("click", ()=>openAddVaxModal());
}

const ts = data.testStats || {counts:{Pending:0, Ordered:0, Resulted:0, RetestDue:0, UncommPositive:0}, avgTat:""};
setText("sbTestsPending", String(ts.counts.Pending||0));
const tb = document.getElementById("sbTestsBreakdown");
if(tb){
const chips = [
["Ordered", ts.counts.Ordered||0],
["Pending", ts.counts.Pending||0],
["Resulted", ts.counts.Resulted||0],
["Retest due", ts.counts.RetestDue||0]
];
tb.innerHTML = chips.map(([k,v])=>`<span class="badge ${k==="Pending"?"blue":(k==="Retest due"?"red":"")}">${escapeHtml(k)}: ${v}</span>`).join("");
}
setText("sbUncommPos", String(ts.counts.UncommPositive||0));
setText("sbAvgTat", ts.avgTat ? `${ts.avgTat} d` : "—");

const btnTests = document.getElementById("btnOpenTests");
if(btnTests && !btnTests.dataset.bound){
btnTests.dataset.bound="1";
btnTests.addEventListener("click", ()=> runAlertDrilldown({type:"ipTests", mode:"pending", unit:(s.ui.unitFilter||"ALL"), days:7}));
}
const btnUn = document.getElementById("btnReviewUncomm");
if(btnUn && !btnUn.dataset.bound){
btnUn.dataset.bound="1";
btnUn.addEventListener("click", ()=> runAlertDrilldown({type:"ipTests", mode:"uncommPos", unit:(s.ui.unitFilter||"ALL"), days:7}));
}

const wrap = document.getElementById("sbAlerts");
if(wrap){
const mk = (a)=>{
const sev = a.severity || "low";
const badge = sev==="high" ? "red" : (sev==="med" ? "blue" : "");
const act = a.action ? encodeURIComponent(JSON.stringify(a.action)) : "";
const aj = encodeURIComponent(JSON.stringify(a));
const clickable = a.action ? "sbAlertCard" : "";
return `<div class="card ${clickable}" data-action="${act}" data-alert="${aj}" style="cursor:${a.action?"pointer":"default"}; box-shadow:none; border-left:6px solid ${sev==="high"?"#c01818":(sev==="med"?"#1b4f8a":"#777")};">
<div class="row" style="justify-content:space-between; align-items:flex-start">
<div>
<div style="font-weight:900">${escapeHtml(a.title||"Alert")}</div>
<div class="muted mini" style="margin-top:4px">${escapeHtml(a.detail||"")}</div>
</div>
<div class="row" style="gap:8px; align-items:flex-start">
<span class="badge ${badge}">${escapeHtml(sev.toUpperCase())}</span>
${a.action ? `<button class="smallbtn noprint edit-only sbCreateAction" data-alert="${aj}">Create Action</button>` : ``}
</div>
</div>
</div>`;
};
wrap.innerHTML = (data.alerts && data.alerts.length) ? data.alerts.map(mk).join("") : `<div class="muted">No alerts right now.</div>`;

wrap.querySelectorAll(".sbAlertCard").forEach(card=>{
if(card.dataset.bound) return;
card.dataset.bound="1";
card.addEventListener("click", ()=>{
const payload = card.getAttribute("data-action") || "";
if(!payload) return;
let act=null;
try{ act = JSON.parse(decodeURIComponent(payload)); }catch(e){ return; }
runAlertDrilldown(act);
});
});

wrap.querySelectorAll(".sbCreateAction").forEach(btn=>{
if(btn.dataset.bound) return;
btn.dataset.bound="1";
btn.addEventListener("click", (ev)=>{
ev.stopPropagation();
const payload = btn.getAttribute("data-alert") || "";
if(!payload) return;
let alertObj=null;
try{ alertObj = JSON.parse(decodeURIComponent(payload)); }catch(e){ return; }
convertAlertToAction(alertObj);
});
});

}

const refBtn = document.getElementById("btnRefreshAlerts");
if(refBtn && !refBtn.dataset.bound){
refBtn.dataset.bound="1";
refBtn.addEventListener("click", ()=>renderAll());
}

const as = data.auditStats || null;
const chipHost = document.getElementById("sbAuditChips");
if(chipHost){
if(!as || !as.byType){
chipHost.innerHTML = `<span class="muted mini">No audit stats.</span>`;
} else {
const mk = (k)=>{
const v = as.byType[k]; if(!v || !v.total) return null;
const pct = Math.round(((v.total-v.non)/v.total)*100);
const cls = pct<85 ? "red" : (pct<90 ? "blue" : "green");
return `<span class="badge ${cls}">${escapeHtml(k)}: ${pct}%</span>`;
};
const chips = [mk("Hand Hygiene"), mk("PPE"), mk("Isolation/Precautions"), mk("EBP"), mk("Cleaning")].filter(Boolean);
chipHost.innerHTML = chips.join("") || `<span class="muted mini">No audit entries in last 7 days.</span>`;
}
}

}

function dateRangeList(days){
const out=[];
const d=new Date();
for(let i=days-1;i>=0;i--){
const x=new Date(d); x.setDate(d.getDate()-i);
out.push(dayISO(x));
}
return out;
}

function getCaseDateISO(c){
return (c.onsetDate || c.createdAt || "").slice(0,10);
}

function dailyCountsBySyndrome(s, unitKey, days){
ensureIpData(s);
const dates = dateRangeList(days);
const make = ()=>Object.fromEntries(dates.map(d=>[d,0]));
const map = { resp: make(), gi: make(), other: make() };

let cases = (s.modules.ip.lineListCases||[]);
if(unitKey && unitKey!=="ALL"){
cases = cases.filter(c => (getUnitKeyFromAny(c.unit||"", s.config) || c.unit) === unitKey);
}
for(const c of cases){
const d = getCaseDateISO(c);
if(!d || !(d in map.resp)) continue;
const k = c.kind || "other";
if(k==="resp") map.resp[d] += 1;
else if(k==="gi") map.gi[d] += 1;
else map.other[d] += 1;
}
return { dates, map };
}

function dailyAbtStarts(s, unitKey, days){
const dates = dateRangeList(days);
const counts = Object.fromEntries(dates.map(d=>[d,0]));
let rows = (s.modules.abt?.courses||[]);
if(unitKey && unitKey!=="ALL"){
rows = rows.filter(c => (getUnitKeyFromAny(c.unit||"", s.config) || c.unit) === unitKey);
}
for(const c of rows){
const d = (c.createdAt || c.startDate || "").slice(0,10);
if(d && (d in counts)) counts[d] += 1;
}
return { dates, counts };
}

function computeThresholdTriggers(s, unitKey){
ensureIpData(s);
const q = getQapiCfg(s);
const lookbackDays = 3;
const startD = new Date(); startD.setDate(startD.getDate()-(lookbackDays-1));
const startISO = dayISO(startD);
const endISO = dayISO(new Date());

let cases = (s.modules.ip.lineListCases||[]).filter(c=>(c.status||"active")!=="resolved");
if(unitKey && unitKey!=="ALL"){
cases = cases.filter(c => (getUnitKeyFromAny(c.unit||"", s.config) || c.unit) === unitKey);
}

const groups = {};
for(const c of cases){
const d = getCaseDateISO(c);
if(!d || d < startISO || d > endISO) continue;
const uk = (getUnitKeyFromAny(c.unit||"", s.config) || c.unit || "—");
if(!groups[uk]) groups[uk] = {resp:0, gi:0, other:0};
const k = c.kind || "other";
if(k==="resp") groups[uk].resp++;
else if(k==="gi") groups[uk].gi++;
else groups[uk].other++;
}

const triggers=[];
Object.keys(groups).sort().forEach(uk=>{
const g = groups[uk];
if(g.gi >= (q.thresholds.gi72h||2)){
triggers.push({
severity:"high",
title:`GI threshold trigger in ${uk}`,
detail:`${g.gi} GI cases within 72 hours (threshold: ${(q.thresholds.gi72h||2)}).`,
action:{ type:"ip", kind:"gi", unit:uk, days:lookbackDays }
});
}
if(g.resp >= (q.thresholds.resp72h||2)){
triggers.push({
severity:"high",
title:`Respiratory threshold trigger in ${uk}`,
detail:`${g.resp} respiratory cases within 72 hours (threshold: ${(q.thresholds.resp72h||2)}).`,
action:{ type:"ip", kind:"resp", unit:uk, days:lookbackDays }
});
}
});

const today = dayISO(new Date());
const abt = dailyAbtStarts(s, unitKey, 1).counts;
const abtToday = abt[today] || 0;
if(abtToday >= (q.thresholds.abtStartsDay||3)){
triggers.push({
severity:"med",
title:"ABT start spike today",
detail:`${abtToday} antibiotic starts today (threshold: ${(q.thresholds.abtStartsDay||3)}).`,
action:{ type:"abt", days:1 }
});
}

return triggers;
}

function renderSurveillance(s){
const pane = document.getElementById("tab-surveillance");
if(!pane) return;

const sel = document.getElementById("svUnit");
const win = document.getElementById("svWindow");
const btn = document.getElementById("btnSvRefresh");

const units = (s.config.units||[]);
if(sel && !sel.dataset.bound){
sel.dataset.bound="1";
sel.addEventListener("change", ()=>renderAll());
}
if(win && !win.dataset.bound){
win.dataset.bound="1";
win.addEventListener("change", ()=>renderAll());
}
if(btn && !btn.dataset.bound){
btn.dataset.bound="1";
btn.addEventListener("click", ()=>renderAll());
}

if(sel){
const cur = sel.value || "ALL";
sel.innerHTML = `<option value="ALL">All Units</option>` + units.map(u=>`<option value="${escapeHtml(u.unitKey)}">${escapeHtml(u.unitName||u.unitKey)}</option>`).join("");
sel.value = (cur && (cur==="ALL" || units.some(u=>u.unitKey===cur))) ? cur : "ALL";
}
const unitKey = sel ? (sel.value||"ALL") : "ALL";
const days = win ? Math.max(7, Math.min(28, Number(win.value||7))) : 7;

const trend = dailyCountsBySyndrome(s, unitKey, days);
const dates = trend.dates;

const totalCases = dates.reduce((sum,d)=>sum + (trend.map.resp[d]||0) + (trend.map.gi[d]||0) + (trend.map.other[d]||0), 0);
const badge = document.getElementById("svCasesTotal");
if(badge) badge.textContent = String(totalCases);

const wrap = document.getElementById("svTrendTableWrap");
if(wrap){
const hdr = `<th>Syndrome</th>` + dates.map(d=>`<th class="center">${d.slice(5)}</th>`).join("") + `<th class="center">Total</th>`;
const row = (label, obj)=>{
const tot = dates.reduce((s2,d)=>s2+(obj[d]||0),0);
return `<tr>
<td class="nowrap"><b>${escapeHtml(label)}</b></td>
${dates.map(d=>`<td class="center">${obj[d]||0}</td>`).join("")}
<td class="center"><b>${tot}</b></td>
</tr>`;
};
wrap.innerHTML = `<table>
<thead><tr>${hdr}</tr></thead>
<tbody>
${row("Respiratory", trend.map.resp)}
${row("GI", trend.map.gi)}
${row("Other", trend.map.other)}
</tbody>
</table>`;
}

const abt = dailyAbtStarts(s, unitKey, days);
const abtWrap = document.getElementById("svAbtTableWrap");
const abtTotal = abt.dates.reduce((sum,d)=>sum + (abt.counts[d]||0), 0);
const abtBadge = document.getElementById("svAbtTotal");
if(abtBadge) abtBadge.textContent = String(abtTotal);

if(abtWrap){
abtWrap.innerHTML = `<table>
<thead><tr><th>Date</th><th class="center">Starts</th></tr></thead>
<tbody>
${abt.dates.map(d=>`<tr><td class="nowrap">${d}</td><td class="center">${abt.counts[d]||0}</td></tr>`).join("")}
</tbody>
</table>`;
}

const triggers = computeThresholdTriggers(s, unitKey);
const tBadge = document.getElementById("svTriggersCount");
if(tBadge) tBadge.textContent = String(triggers.length);

const tWrap = document.getElementById("svTriggers");
if(tWrap){
if(!triggers.length){
tWrap.innerHTML = `<div class="muted">No triggers in the last 72 hours.</div>`;
} else {
tWrap.innerHTML = triggers.map(t=>{
const sev=t.severity||"low";
const badge = sev==="high" ? "red" : (sev==="med" ? "blue" : "");
const act = t.action ? encodeURIComponent(JSON.stringify(t.action)) : "";
const aj = encodeURIComponent(JSON.stringify(t));
return `<div class="card sbAlertCard" data-action="${act}" data-alert="${aj}" style="cursor:pointer; box-shadow:none; border-left:6px solid ${sev==="high"?"#c01818":(sev==="med"?"#1b4f8a":"#777")};">
<div class="row" style="justify-content:space-between; align-items:flex-start">
<div>
<div style="font-weight:900">${escapeHtml(t.title||"Trigger")}</div>
<div class="muted mini" style="margin-top:4px">${escapeHtml(t.detail||"")}</div>
</div>
<div class="row" style="gap:8px; align-items:flex-start">
<span class="badge ${badge}">${escapeHtml(sev.toUpperCase())}</span>
${t.action ? `<button class="smallbtn noprint edit-only sbCreateAction" data-alert="${aj}">Create Action</button>` : ``}
</div>
</div>
</div>`;
}).join("");

tWrap.querySelectorAll(".sbAlertCard").forEach(card=>{
if(card.dataset.bound) return;
card.dataset.bound="1";
card.addEventListener("click", ()=>{
const payload = card.getAttribute("data-action") || "";
if(!payload) return;
let act=null;
try{ act = JSON.parse(decodeURIComponent(payload)); }catch(e){ return; }
runAlertDrilldown(act);
});
});

tWrap.querySelectorAll(".sbCreateAction").forEach(btn=>{
if(btn.dataset.bound) return;
btn.dataset.bound="1";
btn.addEventListener("click", (ev)=>{
ev.stopPropagation();
const payload = btn.getAttribute("data-alert") || "";
if(!payload) return;
let alertObj=null;
try{ alertObj = JSON.parse(decodeURIComponent(payload)); }catch(e){ return; }
convertAlertToAction(alertObj);
});
});

}
}
}

function unitNamePretty(s, uk){
const u = (s.config.units||[]).find(x=>x.unitKey===uk);
if(u && (u.unitName||"").trim()) return u.unitName.trim();
const m = String(uk||"").trim().match(/^U\s*0*([0-9]+)$/i);
if(m) return `Unit ${m[1]}`;
return uk || "—";
}

function openCommModal(commId){
const s = Store.load();
ensureIpData(s);
const me = getCurrentUser(s);

const c = commId ? (s.modules.ip.comms||[]).find(x=>x.id===commId) : null;
const today = dayISO(new Date());

const units = (s.config.units||[]);
const unitSel = `<option value="">—</option>` + units.map(u=>`<option value="${escapeHtml(u.unitKey)}" ${(c?.unit||"")===u.unitKey?"selected":""}>${escapeHtml(u.unitName||u.unitKey)}</option>`).join("");

openModal(`${commId?"Edit":"New"} Communication`, `
<div class="grid cols3">
<div><label>Date</label><input id="cm_date" type="date" value="${escapeHtml(c?.date||today)}"/></div>
<div><label>Time</label><input id="cm_time" type="time" value="${escapeHtml(c?.time||"")}"/></div>
<div><label>Category</label>
<select id="cm_cat">
${["Provider","Family","Resident","Staff","External","Other"].map(x=>`<option value="${x}" ${(c?.category||"Provider")===x?"selected":""}>${x}</option>`).join("")}
</select>
</div>
</div>

<div class="grid cols3" style="margin-top:10px">
<div><label>Unit</label><select id="cm_unit">${unitSel}</select></div>
<div><label>To/Who</label><input id="cm_to" type="text" value="${escapeHtml(c?.to||"")}" placeholder="Dr. __ / Family __ / Staff __"/></div>
<div><label>Method</label>
<select id="cm_method">
${["Phone","In-person","Fax","Email","Secure message","Other"].map(x=>`<option value="${x}" ${(c?.method||"Phone")===x?"selected":""}>${x}</option>`).join("")}
</select>
</div>
</div>

<div style="margin-top:10px">
<label>Summary</label>
<input id="cm_summary" type="text" value="${escapeHtml(c?.summary||"")}" placeholder="What was communicated + key outcome"/>
</div>

<div style="margin-top:10px">
<label>Action Taken / Follow-up</label>
<input id="cm_follow" type="text" value="${escapeHtml(c?.followup||"")}" placeholder="e.g., MD ordered PCR panel; family updated; staff huddle completed"/>
</div>

<div class="sep"></div>
<div class="row end" style="gap:8px">
${commId?`<button class="btn danger" onclick="deleteComm('${escapeHtml(commId)}')">Delete</button>`:""}
<button class="btn" onclick="closeModal()">Cancel</button>
<button class="btn primary" onclick="saveComm('${escapeHtml(commId||"")}')">Save</button>
</div>

<div class="sep"></div>
<div class="muted mini">Entered by: <b>${escapeHtml(me.name||"")}</b></div>
`);
}

window.saveComm = function(commId){
const date = document.getElementById("cm_date")?.value || "";
const time = document.getElementById("cm_time")?.value || "";
const category = document.getElementById("cm_cat")?.value || "Provider";
const unit = document.getElementById("cm_unit")?.value || "";
const to = (document.getElementById("cm_to")?.value||"").trim();
const method = document.getElementById("cm_method")?.value || "Phone";
const summary = (document.getElementById("cm_summary")?.value||"").trim();
const followup = (document.getElementById("cm_follow")?.value||"").trim();

withAudit("Save Communication", {category, unit}, ()=>Store.patch(s=>{
ensureIpData(s);
const me = getCurrentUser(s);
const arr = s.modules.ip.comms;
if(commId){
const c = arr.find(x=>x.id===commId);
if(!c) return;
Object.assign(c, {date, time, category, unit, to, method, summary, followup, updatedAt: nowISO(), updatedBy: me.name||""});
}else{
arr.push({id: uid("comm"), date, time, category, unit, to, method, summary, followup, createdAt: nowISO(), updatedAt: nowISO(), createdBy: me.name||"", updatedBy: me.name||""});
}
}));
closeModal();
};

window.deleteComm = function(commId){
if(!confirm("Delete this communication entry?")) return;
withAudit("Delete Communication", {id:commId}, ()=>Store.patch(s=>{
ensureIpData(s);
s.modules.ip.comms = (s.modules.ip.comms||[]).filter(x=>x.id!==commId);
}));
closeModal();
};

function renderComms(s){
ensureIpData(s);
const pane = document.getElementById("tab-comms");
if(!pane) return;

const uSel = document.getElementById("commUnit");
const cSel = document.getElementById("commCat");
const dFrom = document.getElementById("commFrom");
const dTo = document.getElementById("commTo");
const btnA = document.getElementById("btnCommFilter");
const btnC = document.getElementById("btnCommClear");

const units = (s.config.units||[]);
if(uSel){
const cur = uSel.value || "ALL";
uSel.innerHTML = `<option value="ALL">All Units</option>` + units.map(u=>`<option value="${escapeHtml(u.unitKey)}">${escapeHtml(u.unitName||u.unitKey)}</option>`).join("");
uSel.value = (cur && (cur==="ALL" || units.some(u=>u.unitKey===cur))) ? cur : "ALL";
}
if(!cSel?.value) cSel.value = "ALL";

if(btnA && !btnA.dataset.bound){
btnA.dataset.bound="1";
btnA.addEventListener("click", ()=>renderAll());
}
if(btnC && !btnC.dataset.bound){
btnC.dataset.bound="1";
btnC.addEventListener("click", ()=>{
if(uSel) uSel.value="ALL";
if(cSel) cSel.value="ALL";
if(dFrom) dFrom.value="";
if(dTo) dTo.value="";
safeRenderAll();
});
}

const unitKey = uSel ? (uSel.value||"ALL") : "ALL";
const cat = cSel ? (cSel.value||"ALL") : "ALL";
const from = dFrom?.value || "";
const to = dTo?.value || "";

let rows = (s.modules.ip.comms||[]).slice();
if(unitKey!=="ALL") rows = rows.filter(x => (x.unit||"")===unitKey);
if(cat!=="ALL") rows = rows.filter(x => (x.category||"")==cat);
if(from) rows = rows.filter(x => (x.date||"") >= from);
if(to) rows = rows.filter(x => (x.date||"") <= to);

rows.sort((a,b)=> (b.date||"").localeCompare(a.date||"") || (b.time||"").localeCompare(a.time||""));

const sum = {};
for(const r of rows){
const k = r.category || "Other";
sum[k] = (sum[k]||0)+1;
}
const sumBox = document.getElementById("commSummary");
if(sumBox){
sumBox.innerHTML = Object.keys(sum).sort().map(k=>`<span class="badge">${escapeHtml(k)}: ${sum[k]}</span>`).join("") || `<span class="muted">No entries in this filter.</span>`;
}

const body = document.getElementById("commTbody");
if(body){
body.innerHTML = rows.length ? rows.map(r=>`
<tr>
<td class="nowrap">${escapeHtml(r.date||"")}</td>
<td class="nowrap">${escapeHtml(r.time||"")}</td>
<td>${escapeHtml(r.category||"")}</td>
<td class="nowrap">${escapeHtml(r.unit ? unitNamePretty(s, r.unit) : "—")}</td>
<td>${escapeHtml(r.to||"")}</td>
<td>${escapeHtml(r.method||"")}</td>
<td class="muted">${escapeHtml(r.summary||"")}${r.followup?`<div class="mini">Follow-up: ${escapeHtml(r.followup)}</div>`:""}</td>
<td class="noprint edit-only nowrap">
<button class="smallbtn" onclick="openCommModal('${escapeHtml(r.id)}')">Edit</button>
</td>
</tr>
`).join("") : `<tr><td colspan="8" class="muted">No communication entries yet.</td></tr>`;
}

setDrilldownExport({
type: "communications",
title: "Communications Center",
subtitle: `${unitKey==="ALL"?"All Units":unitNamePretty(s, unitKey)} · ${cat==="ALL"?"All categories":cat}${from||to?` · ${from||"…"} to ${to||"…"}`
:""
}`,
columns: [
{key:"date", label:"Date"},
{key:"time", label:"Time"},
{key:"category", label:"Category"},
{key:"unit", label:"Unit"},
{key:"to", label:"To/Who"},
{key:"method", label:"Method"},
{key:"summary", label:"Summary"},
{key:"followup", label:"Follow-up"}
],
rows: rows.map(r=>({
date: r.date||"",
time: r.time||"",
category: r.category||"",
unit: r.unit ? unitNamePretty(s, r.unit) : "",
to: r.to||"",
method: r.method||"",
summary: r.summary||"",
followup: r.followup||""
}))
});

const btnNew = document.getElementById("btnNewComm");
if(btnNew && !btnNew.dataset.bound){
btnNew.dataset.bound="1";
btnNew.addEventListener("click", ()=>openCommModal(null));
}
const btnP = document.getElementById("btnCommPrint");
if(btnP && !btnP.dataset.bound){
btnP.dataset.bound="1";
btnP.addEventListener("click", ()=>printDrilldown());
}
const btnX = document.getElementById("btnCommCSV");
if(btnX && !btnX.dataset.bound){
btnX.dataset.bound="1";
btnX.addEventListener("click", ()=>exportDrilldownCSV());
}
}

function openActionModal(actionId){
const s = Store.load();
ensureIpData(s);
const me = getCurrentUser(s);
const a = actionId ? (s.modules.ip.actions||[]).find(x=>x.id===actionId) : null;
const today = dayISO(new Date());

const units = (s.config.units||[]);
const unitSel = `<option value="">—</option>` + units.map(u=>`<option value="${escapeHtml(u.unitKey)}" ${(a?.unit||"")===u.unitKey?"selected":""}>${escapeHtml(u.unitName||u.unitKey)}</option>`).join("");

openModal(`${actionId?"Edit":"New"} Action Item`, `
<div class="grid cols3">
<div><label>Date</label><input id="ac_date" type="date" value="${escapeHtml(a?.date||today)}"/></div>
<div><label>Due Date</label><input id="ac_due" type="date" value="${escapeHtml(a?.dueDate||"")}"/></div>
<div><label>Status</label>
<select id="ac_status">
${["Open","In Progress","Done"].map(x=>`<option value="${x}" ${(a?.status||"Open")===x?"selected":""}>${x}</option>`).join("")}
</select>
</div>
</div>

<div class="grid cols3" style="margin-top:10px">
<div><label>Owner</label><input id="ac_owner" type="text" value="${escapeHtml(a?.owner||me.name||"")}"/></div>
<div><label>Unit</label><select id="ac_unit">${unitSel}</select></div>
<div><label>Priority</label>
<select id="ac_pri">
${["High","Medium","Low"].map(x=>`<option value="${x}" ${(a?.priority||"Medium")===x?"selected":""}>${x}</option>`).join("")}
</select>
</div>
</div>

<div style="margin-top:10px">
<label>Action Item</label>
<input id="ac_item" type="text" value="${escapeHtml(a?.item||"")}" placeholder="What needs to be done?"/>
</div>

<div style="margin-top:10px">
<label>Notes</label>
<input id="ac_notes" type="text" value="${escapeHtml(a?.notes||"")}" placeholder="Rationale / context / evidence"/>
</div>

<div class="sep"></div>
<div class="row end" style="gap:8px">
${actionId?`<button class="btn danger" onclick="deleteAction('${escapeHtml(actionId)}')">Delete</button>`:""}
<button class="btn" onclick="closeModal()">Cancel</button>
<button class="btn primary" onclick="saveAction('${escapeHtml(actionId||"")}')">Save</button>
</div>
`);
}

window.saveAction = function(actionId){
const date = document.getElementById("ac_date")?.value || "";
const dueDate = document.getElementById("ac_due")?.value || "";
const status = document.getElementById("ac_status")?.value || "Open";
const owner = (document.getElementById("ac_owner")?.value||"").trim();
const unit = document.getElementById("ac_unit")?.value || "";
const priority = document.getElementById("ac_pri")?.value || "Medium";
const item = (document.getElementById("ac_item")?.value||"").trim();
const notes = (document.getElementById("ac_notes")?.value||"").trim();

withAudit("Save Action Item", {status, unit, priority}, ()=>Store.patch(s=>{
ensureIpData(s);
const me = getCurrentUser(s);
const arr = s.modules.ip.actions;
if(actionId){
const a = arr.find(x=>x.id===actionId);
if(!a) return;
Object.assign(a, {date, dueDate, status, owner, unit, priority, item, notes, updatedAt: nowISO(), updatedBy: me.name||""});
}else{
arr.push({id: uid("act"), date, dueDate, status, owner, unit, priority, item, notes, createdAt: nowISO(), updatedAt: nowISO(), createdBy: me.name||"", updatedBy: me.name||""});
}
}));
closeModal();
};

window.deleteAction = function(actionId){
if(!confirm("Delete this action item?")) return;
withAudit("Delete Action Item", {id:actionId}, ()=>Store.patch(s=>{
ensureIpData(s);
s.modules.ip.actions = (s.modules.ip.actions||[]).filter(x=>x.id!==actionId);
}));
closeModal();
};

function openDecisionModal(decId){
const s = Store.load();
ensureIpData(s);
const me = getCurrentUser(s);
const d = decId ? (s.modules.ip.decisions||[]).find(x=>x.id===decId) : null;
const today = dayISO(new Date());

const units = (s.config.units||[]);
const unitSel = `<option value="">—</option>` + units.map(u=>`<option value="${escapeHtml(u.unitKey)}" ${(d?.unit||"")===u.unitKey?"selected":""}>${escapeHtml(u.unitName||u.unitKey)}</option>`).join("");

openModal(`${decId?"Edit":"New"} Decision`, `
<div class="grid cols3">
<div><label>Date</label><input id="dc_date" type="date" value="${escapeHtml(d?.date||today)}"/></div>
<div><label>Unit</label><select id="dc_unit">${unitSel}</select></div>
<div><label>Entered by</label><input type="text" disabled value="${escapeHtml(me.name||"")}"/></div>
</div>

<div style="margin-top:10px">
<label>Decision</label>
<input id="dc_decision" type="text" value="${escapeHtml(d?.decision||"")}" placeholder="What did we decide?"/>
</div>

<div style="margin-top:10px">
<label>Rationale</label>
<input id="dc_rationale" type="text" value="${escapeHtml(d?.rationale||"")}" placeholder="Why? (evidence, risk, guidance, threshold trigger)"/>
</div>

<div style="margin-top:10px">
<label>Notes</label>
<input id="dc_notes" type="text" value="${escapeHtml(d?.notes||"")}" placeholder="Extra context, communications, follow-up"/>
</div>

<div class="sep"></div>
<div class="row end" style="gap:8px">
${decId?`<button class="btn danger" onclick="deleteDecision('${escapeHtml(decId)}')">Delete</button>`:""}
<button class="btn" onclick="closeModal()">Cancel</button>
<button class="btn primary" onclick="saveDecision('${escapeHtml(decId||"")}')">Save</button>
</div>
`);
}

window.saveDecision = function(decId){
const date = document.getElementById("dc_date")?.value || "";
const unit = document.getElementById("dc_unit")?.value || "";
const decision = (document.getElementById("dc_decision")?.value||"").trim();
const rationale = (document.getElementById("dc_rationale")?.value||"").trim();
const notes = (document.getElementById("dc_notes")?.value||"").trim();

withAudit("Save Decision", {unit}, ()=>Store.patch(s=>{
ensureIpData(s);
const me = getCurrentUser(s);
const arr = s.modules.ip.decisions;
if(decId){
const d = arr.find(x=>x.id===decId);
if(!d) return;
Object.assign(d, {date, unit, decision, rationale, notes, updatedAt: nowISO(), updatedBy: me.name||""});
}else{
arr.push({id: uid("dec"), date, unit, decision, rationale, notes, createdAt: nowISO(), updatedAt: nowISO(), createdBy: me.name||"", updatedBy: me.name||""});
}
}));
closeModal();
};

window.deleteDecision = function(decId){
if(!confirm("Delete this decision entry?")) return;
withAudit("Delete Decision", {id:decId}, ()=>Store.patch(s=>{
ensureIpData(s);
s.modules.ip.decisions = (s.modules.ip.decisions||[]).filter(x=>x.id!==decId);
}));
closeModal();
};

function openStopRuleModal(ruleId){
const s = Store.load();
ensureIpData(s);
const r = ruleId ? (s.modules.ip.stopRules||[]).find(x=>x.id===ruleId) : null;
openModal(`${ruleId?"Edit":"Add"} Stop Rule`, `
<div class="muted mini">Example: “No new cases x 14 days on affected unit” or “Last positive resident cleared isolation”.</div>
<div class="sep"></div>
<div>
<label>Rule</label>
<input id="sr_text" type="text" value="${escapeHtml(r?.text||"")}" placeholder="Stop rule criteria..."/>
</div>
<div style="margin-top:10px">
<label>Status</label>
<select id="sr_status">
${["Active","Met"].map(x=>`<option value="${x}" ${(r?.status||"Active")===x?"selected":""}>${x}</option>`).join("")}
</select>
</div>
<div class="sep"></div>
<div class="row end" style="gap:8px">
${ruleId?`<button class="btn danger" onclick="deleteStopRule('${escapeHtml(ruleId)}')">Delete</button>`:""}
<button class="btn" onclick="closeModal()">Cancel</button>
<button class="btn primary" onclick="saveStopRule('${escapeHtml(ruleId||"")}')">Save</button>
</div>
`);
}

window.saveStopRule = function(ruleId){
const text = (document.getElementById("sr_text")?.value||"").trim();
const status = document.getElementById("sr_status")?.value || "Active";
withAudit("Save Stop Rule", {status}, ()=>Store.patch(s=>{
ensureIpData(s);
const arr = s.modules.ip.stopRules;
if(ruleId){
const r = arr.find(x=>x.id===ruleId);
if(!r) return;
Object.assign(r, {text, status, updatedAt: nowISO()});
}else{
arr.push({id: uid("stop"), text, status, createdAt: nowISO(), updatedAt: nowISO()});
}
}));
closeModal();
};

window.deleteStopRule = function(ruleId){
if(!confirm("Delete this stop rule?")) return;
withAudit("Delete Stop Rule", {id:ruleId}, ()=>Store.patch(s=>{
ensureIpData(s);
s.modules.ip.stopRules = (s.modules.ip.stopRules||[]).filter(x=>x.id!==ruleId);
}));
closeModal();
};

function renderDecisions(s){
ensureIpData(s);
const pane = document.getElementById("tab-decisions");
if(!pane) return;

const today = dayISO(new Date());

let actions = (s.modules.ip.actions||[]).slice();
actions.sort((a,b)=> (a.status||"Open").localeCompare(b.status||"Open") || (b.date||"").localeCompare(a.date||""));

const openActions = actions.filter(a=>(a.status||"Open")!=="Done");
const actOpen = document.getElementById("actOpenCount");
if(actOpen) actOpen.textContent = String(openActions.length);

const actQuick = document.getElementById("actQuick");
if(actQuick){
const top = openActions.slice(0,3).map(a=>`• ${a.item||""}${a.dueDate?` (due ${a.dueDate})`:""}`).join("<br/>");
actQuick.innerHTML = top || "—";
}

const stop = (s.modules.ip.stopRules||[]).slice();
const stopCount = document.getElementById("stopCount");
if(stopCount) stopCount.textContent = String(stop.length);

const stopQuick = document.getElementById("stopQuick");
if(stopQuick){
const top = stop.slice(0,2).map(r=>`• ${r.text||""} [${r.status||"Active"}]`).join("<br/>");
stopQuick.innerHTML = top || "—";
}

const decs = (s.modules.ip.decisions||[]).slice().sort((a,b)=> (b.date||"").localeCompare(a.date||""));
const decCount = document.getElementById("decCount");
if(decCount) decCount.textContent = String(decs.length);

const decQuick = document.getElementById("decQuick");
if(decQuick){
const top = decs.slice(0,2).map(d=>`• ${d.decision||""}`).join("<br/>");
decQuick.innerHTML = top || "—";
}

const actBody = document.getElementById("actTbody");
if(actBody){
actBody.innerHTML = actions.length ? actions.map(a=>{
const badge = (a.status||"Open")==="Done" ? "green" : ((a.priority||"Medium")==="High" ? "red" : "");
return `<tr>
<td class="nowrap">${escapeHtml(a.date||"")}</td>
<td class="nowrap">${escapeHtml(a.dueDate||"")}</td>
<td class="nowrap"><span class="badge ${badge}">${escapeHtml(a.status||"Open")}</span></td>
<td>${escapeHtml(a.owner||"")}</td>
<td class="nowrap">${escapeHtml(a.unit?unitNamePretty(s,a.unit):"—")}</td>
<td>${escapeHtml(a.item||"")}<div class="mini muted">${escapeHtml(a.notes||"")}</div></td>
<td class="noprint edit-only nowrap">
<button class="smallbtn" onclick="openActionModal('${escapeHtml(a.id)}')">Edit</button>
</td>
</tr>`;
}).join("") : `<tr><td colspan="7" class="muted">No action items yet.</td></tr>`;
}

const decBody = document.getElementById("decTbody");
if(decBody){
decBody.innerHTML = decs.length ? decs.map(d=>`
<tr>
<td class="nowrap">${escapeHtml(d.date||"")}</td>
<td class="nowrap">${escapeHtml(d.unit?unitNamePretty(s,d.unit):"—")}</td>
<td>${escapeHtml(d.decision||"")}</td>
<td class="muted">${escapeHtml(d.rationale||"")}${d.notes?`<div class="mini">Notes: ${escapeHtml(d.notes)}</div>`:""}</td>
<td class="noprint edit-only nowrap">
<button class="smallbtn" onclick="openDecisionModal('${escapeHtml(d.id)}')">Edit</button>
</td>
</tr>
`).join("") : `<tr><td colspan="5" class="muted">No decisions yet.</td></tr>`;
}

const stopList = document.getElementById("stopList");
if(stopList){
stopList.innerHTML = stop.length ? stop.map(r=>`
<div class="card" style="box-shadow:none">
<div class="row" style="justify-content:space-between; align-items:flex-start">
<div>
<div style="font-weight:900">${escapeHtml(r.text||"")}</div>
<div class="muted mini" style="margin-top:4px">Status: <b>${escapeHtml(r.status||"Active")}</b></div>
</div>
<div class="noprint edit-only">
<button class="smallbtn" onclick="openStopRuleModal('${escapeHtml(r.id)}')">Edit</button>
</div>
</div>
</div>
`).join("") : `<div class="muted">No stop rules yet.</div>`;
}

setDrilldownExport({
type: "decision_log",
title: "Action Plan + Decision Log",
subtitle: `As of ${today}`,
columns: [
{key:"section", label:"Section"},
{key:"date", label:"Date"},
{key:"unit", label:"Unit"},
{key:"owner", label:"Owner"},
{key:"due", label:"Due"},
{key:"status", label:"Status"},
{key:"text", label:"Text"},
{key:"notes", label:"Notes"}
],
rows: [
...actions.map(a=>({section:"Action", date:a.date||"", unit:a.unit?unitNamePretty(s,a.unit):"", owner:a.owner||"", due:a.dueDate||"", status:a.status||"", text:a.item||"", notes:a.notes||""})),
...decs.map(d=>({section:"Decision", date:d.date||"", unit:d.unit?unitNamePretty(s,d.unit):"", owner:"", due:"", status:"", text:d.decision||"", notes:`Rationale: ${d.rationale||""}${d.notes?` | ${d.notes}`:""}`})),
...stop.map(r=>({section:"Stop Rule", date:"", unit:"", owner:"", due:"", status:r.status||"", text:r.text||"", notes:""}))
]
});

const b1 = document.getElementById("btnNewAction");
if(b1 && !b1.dataset.bound){
b1.dataset.bound="1";
b1.addEventListener("click", ()=>openActionModal(null));
}
const b2 = document.getElementById("btnNewDecision");
if(b2 && !b2.dataset.bound){
b2.dataset.bound="1";
b2.addEventListener("click", ()=>openDecisionModal(null));
}
const b3 = document.getElementById("btnAddStop");
if(b3 && !b3.dataset.bound){
b3.dataset.bound="1";
b3.addEventListener("click", ()=>openStopRuleModal(null));
}
const bp = document.getElementById("btnDecPrint");
if(bp && !bp.dataset.bound){
bp.dataset.bound="1";
bp.addEventListener("click", ()=>printDrilldown());
}
const bx = document.getElementById("btnDecCSV");
if(bx && !bx.dataset.bound){
bx.dataset.bound="1";
bx.addEventListener("click", ()=>exportDrilldownCSV());
}
const bcp = document.getElementById("btnCommPrint");
const bcx = document.getElementById("btnCommCSV");
}

function openReportWalkthroughModal(){
const s = Store.load();
const unitFilter = (document.getElementById("rpUnit")?.value) || (s.ui.unitFilter||"ALL");
const from = document.getElementById("rpFrom")?.value || "";
const to = document.getElementById("rpTo")?.value || "";
const unitText = unitFilter==="ALL" ? "All Units" : unitNamePretty(s, unitFilter);

const step = (n, title, body)=>`
<div class="card" style="box-shadow:none">
<div style="font-weight:900">${n}. ${escapeHtml(title)}</div>
<div class="sep"></div>
<div class="muted mini">${body}</div>
</div>
`;

const badge = (t)=>`<span class="badge">${escapeHtml(t)}</span>`;

openModal("Report Walkthrough — How to Generate Outputs", `
<div class="muted mini">
This guide shows the exact clicks to produce each report. Current filters: <b>${escapeHtml(unitText)}</b>${(from||to)?` · <b>${escapeHtml(from||"…")} to ${escapeHtml(to||"…")}</b>`:""}.
</div>
<div class="sep"></div>

<div class="grid cols3">
${step("A","Set report scope (recommended)",
`Go to ${badge("Reports")} tab → set ${badge("Unit")} and optional ${badge("From/To")} dates → press ${badge("Apply")}.\\n\\nThese filters are used by Leadership Update, Surveyor Packet, QAPI, CSV bundle, ABT/Vax exports.`
)}
${step("B","Daily Precaution List (unit sheet)",
`Reports → ${badge("Print Unit Precaution Listing")} → choose Unit/Date/Shift → Print.\\n\\nThis matches your distribution template.`
)}
${step("C","Line Listing (ILI / GI templates)",
`Reports → ${badge("Print ILI Template")} or ${badge("Print GI Template")}.\\n mentioning: use Unit + date filters for scope when needed (Survey Packet uses scope).`
)}
</div>

<div class="sep"></div>

<div class="grid cols3">
${step("D","Leadership Outbreak Status Update",
`Reports → ${badge("Print Leadership Update")}.\\nIncludes: outbreak status, counts, key alerts, ABT starts, testing summary, open actions, decisions, communications.`
)}
${step("E","Surveyor Packet Bundle",
`Reports → ${badge("Build & Print Packet")} → choose Unit + date range → select included sections → ${badge("Build & Print")}.\\n\\nBundle includes cover + TOC + consistent headers/footers.`
)}
${step("F","QAPI Weekly Summary",
`Reports → ${badge("Print QAPI Summary")}.\\nShows trends, triggers, gaps (testing/communication), corrective actions and decisions.`
)}
</div>

<div class="sep"></div>

<div class="grid cols3">
${step("G","ABT Reports",
`Reports → ${badge("Print Active ABT")} for current active antibiotics.\\nReports → ${badge("Print ABT SOC Gaps")} for stewardship documentation gaps (missing indication/source/stop date/route).\\nReports → ${badge("Export ABT CSV")} for full ABT data export.`
)}
${step("H","Vaccination Reports",
`Reports → ${badge("Print Weekly List")} (vaccinated/declined/pending).\\nReports → ${badge("Print Due Today")} and ${badge("Print Due This Week")}.\\nReports → ${badge("Print Monthly Matrix")}.\\nReports → ${badge("Export Vax CSV")}.`
)}
${step("I","CSV Bundle (one-click exports)",
`Reports → ${badge("Export CSV Bundle")}.\\nExports multiple CSV files (Comms, Actions, Decisions, Tests, plus ABT/Vax exports are separate buttons).`
)}
</div>

<div class="sep"></div>

<div class="row end noprint" style="gap:8px">
<button class="btn" onclick="closeModal()">Close</button>
<button class="btn primary" onclick="setTab('reports'); closeModal();">Go to Reports</button>
</div>

<div class="sep"></div>
<div class="muted mini">
Tip: Keep ${badge("Decision Log")} updated—surveyors care about the “why” (rationale) as much as the data.
</div>
`);
}

function getUnitForReports(){
const uSel = document.getElementById("rpUnit");
return uSel ? (uSel.value||"ALL") : (Store.load().ui.unitFilter||"ALL");
}

function getAbtFilteredCourses(s, unitKey, activeOnly=true){
const courses = (s.modules.abt?.courses||[]).slice();
let rows = courses;
if(unitKey!=="ALL"){
rows = rows.filter(c=>{
const u = c.unit || (s.residentsById?.[c.residentId]?.unit||"");
const uk = getUnitKeyFromAny(u||"", s.config) || u || "";
return uk === unitKey;
});
}
if(activeOnly){
rows = rows.filter(c=>abtIsActiveCourse(c));
}
rows.sort((a,b)=> (mdyToISO(a.startDate||"")||"").localeCompare(mdyToISO(b.startDate||"")||"") || (a.room||"").localeCompare(b.room||"", undefined, {numeric:true}));
return rows;
}

function printAbtActiveReport(){
const s = Store.load();
const unitKey = getReportFilters().unit;
const unitPretty = unitKey==="ALL" ? "All Units" : unitNamePretty(s, unitKey);
const facility = s.config.facilityName || "Facility";

const rows = getAbtFilteredCourses(s, unitKey, true);

setDrilldownExport({
type:"abt_active",
title:`Active Antibiotics — ${unitPretty}`,
subtitle:"Active courses only (per current unit filter).",
columns:[
{key:"resident",label:"Resident"},
{key:"mrn",label:"MRN"},
{key:"unit",label:"Unit"},
{key:"room",label:"Room"},
{key:"antibiotic",label:"Antibiotic"},
{key:"start",label:"Start"},
{key:"end",label:"End"},
{key:"route",label:"Route"},
{key:"indication",label:"Indication"},
{key:"source",label:"Source"},
{key:"lineListing",label:"Line Listing"}
],
rows: rows.map(c=>({
resident: c.residentName||"",
mrn: c.mrn||"",
unit: unitNamePretty(s, getUnitKeyFromAny(c.unit||"", s.config) || c.unit || ""),
room: c.room||"",
antibiotic: c.antibiotic||"",
start: c.startDate||"",
end: c.endDate||"",
route: c.route||"",
indication: c.indication||"",
source: c.infectionSource||"",
lineListing: c.lineListing||""
}))
});

const body = `
<div class="title">${escapeHtml(facility)} — Active Antibiotics</div>
<div class="muted" style="margin-top:4px">${escapeHtml(unitPretty)} · Generated ${escapeHtml(new Date().toLocaleString())}</div>
<div style="height:10px"></div>
<table class="thin">
<thead><tr>
<th>Resident</th><th style="width:120px">MRN</th><th style="width:110px">Unit</th><th style="width:80px">Room</th>
<th style="width:180px">Antibiotic</th><th style="width:110px">Start</th><th style="width:110px">End</th><th style="width:90px">Route</th>
<th>Indication</th><th style="width:160px">Source</th><th style="width:140px">Line Listing</th>
</tr></thead>
<tbody>
${rows.length ? rows.map(c=>`
<tr>
<td>${escapeHtml(c.residentName||"")}</td>
<td class="nowrap">${escapeHtml(c.mrn||"")}</td>
<td class="nowrap">${escapeHtml(unitNamePretty(s, getUnitKeyFromAny(c.unit||"", s.config) || c.unit || ""))}</td>
<td class="nowrap">${escapeHtml(c.room||"")}</td>
<td>${escapeHtml(c.antibiotic||"")}</td>
<td class="nowrap">${escapeHtml(c.startDate||"")}</td>
<td class="nowrap">${escapeHtml(c.endDate||"")}</td>
<td class="nowrap">${escapeHtml(c.route||"")}</td>
<td>${escapeHtml(c.indication||"")}</td>
<td>${escapeHtml(c.infectionSource||"")}</td>
<td>${escapeHtml(c.lineListing||"")}</td>
</tr>
`).join("") : `<tr><td colspan="11" class="muted">No active antibiotics in scope.</td></tr>`}
</tbody>
</table>
`;
openPrintWindow("Active Antibiotics", body, `
@page{ size: landscape; margin: 0.4in; }
body{ font-size: 11px; }
th{ background:#f3f6fb; }
`);
}

function computeAbtSocGapsRows(s, unitKey){
const rows = getAbtFilteredCourses(s, unitKey, true);
const gaps = [];
for(const c of rows){
const missing = [];
if(!(c.indication||"").trim()) missing.push("Indication");
if(!(c.infectionSource||"").trim()) missing.push("Source");
if(!(c.endDate||"").trim()) missing.push("Stop/End Date");
if(!(c.route||"").trim()) missing.push("Route");
if(missing.length){
gaps.push({
resident: c.residentName||"",
mrn: c.mrn||"",
unit: unitNamePretty(s, getUnitKeyFromAny(c.unit||"", s.config) || c.unit || ""),
room: c.room||"",
antibiotic: c.antibiotic||"",
start: c.startDate||"",
missing: missing.join(", ")
});
}
}
return gaps;
}

function printAbtSocGaps(){
const s = Store.load();
const unitKey = getReportFilters().unit;
const unitPretty = unitKey==="ALL" ? "All Units" : unitNamePretty(s, unitKey);
const facility = s.config.facilityName || "Facility";

const gaps = computeAbtSocGapsRows(s, unitKey);

setDrilldownExport({
type:"abt_soc_gaps",
title:`ABT SOC Gaps — ${unitPretty}`,
subtitle:"Active antibiotics missing key stewardship documentation fields.",
columns:[
{key:"resident",label:"Resident"},
{key:"mrn",label:"MRN"},
{key:"unit",label:"Unit"},
{key:"room",label:"Room"},
{key:"antibiotic",label:"Antibiotic"},
{key:"start",label:"Start"},
{key:"missing",label:"Missing"}
],
rows:gaps
});

const body = `
<div class="title">${escapeHtml(facility)} — Antibiotic Stewardship SOC Gaps</div>
<div class="muted" style="margin-top:4px">${escapeHtml(unitPretty)} · Active courses only · Generated ${escapeHtml(new Date().toLocaleString())}</div>
<div style="height:10px"></div>
<table class="thin">
<thead><tr>
<th>Resident</th><th style="width:120px">MRN</th><th style="width:110px">Unit</th><th style="width:80px">Room</th>
<th style="width:180px">Antibiotic</th><th style="width:110px">Start</th><th>Missing fields</th>
</tr></thead>
<tbody>
${gaps.length ? gaps.map(g=>`
<tr>
<td>${escapeHtml(g.resident)}</td>
<td class="nowrap">${escapeHtml(g.mrn)}</td>
<td class="nowrap">${escapeHtml(g.unit)}</td>
<td class="nowrap">${escapeHtml(g.room)}</td>
<td>${escapeHtml(g.antibiotic)}</td>
<td class="nowrap">${escapeHtml(g.start)}</td>
<td>${escapeHtml(g.missing)}</td>
</tr>
`).join("") : `<tr><td colspan="7" class="muted">No SOC gaps detected in current scope.</td></tr>`}
</tbody>
</table>
`;
openPrintWindow("ABT SOC Gaps", body, `
@page{ size: landscape; margin: 0.4in; }
body{ font-size: 11px; }
th{ background:#f3f6fb; }
`);
}

function exportAbtCSV(){
const s = Store.load();
const unitKey = getReportFilters().unit;
const rows = getAbtFilteredCourses(s, unitKey, false); // include history for export
const date = new Date().toISOString().slice(0,10);
const u = unitKey==="ALL" ? "ALL" : unitKey;

const cols = [
{key:"status",label:"Status"},
{key:"residentName",label:"Resident"},
{key:"mrn",label:"MRN"},
{key:"unit",label:"Unit"},
{key:"room",label:"Room"},
{key:"antibiotic",label:"Antibiotic"},
{key:"startDate",label:"Start"},
{key:"endDate",label:"End"},
{key:"route",label:"Route"},
{key:"indication",label:"Indication"},
{key:"infectionSource",label:"Source"},
{key:"lineListing",label:"Line Listing"}
];
const header = cols.map(c=>csvEscape(c.label)).join(",");
const lines = [header];
for(const c of rows){
const rec = {
status: abtIsActiveCourse(c) ? "ACTIVE" : "HIST",
residentName: c.residentName||"",
mrn: c.mrn||"",
unit: unitNamePretty(s, getUnitKeyFromAny(c.unit||"", s.config) || c.unit || ""),
room: c.room||"",
antibiotic: c.antibiotic||"",
startDate: c.startDate||"",
endDate: c.endDate||"",
route: c.route||"",
indication: c.indication||"",
infectionSource: c.infectionSource||"",
lineListing: c.lineListing||""
};
lines.push(cols.map(col=>csvEscape(rec[col.key])).join(","));
}
downloadCSV(`abt_${u}_${date}.csv`, lines.join("\n"));
}

function openVaxSubtab(vxt){
if(typeof setTab==="function") setTab("vax");
setTimeout(()=>{
const btn = document.querySelector(`#vaxSubnav .tabbtn[data-vxt="${vxt}"]`);
if(btn) btn.click();
}, 50);
}

function printVaxWeeklyFromReports(){
const s = Store.load();
const {unit, from, to} = getReportFilters();
Store.patch(st=>{ st.ui.unitFilter = unit; });

openVaxSubtab("weekly");
setTimeout(()=>{
const d = document.getElementById("vxwDate");
if(d) d.value = from || dayISO(new Date());
const typeSel = document.getElementById("vxwType");
if(typeSel) typeSel.value = "";
const censusSel = document.getElementById("vxwCensus");
if(censusSel) censusSel.value = "active";
if(typeof vaxPreviewWeekly==="function") vaxPreviewWeekly(true);
}, 120);
}

function printVaxDueTodayFromReports(){
const {unit, from} = getReportFilters();
Store.patch(st=>{ st.ui.unitFilter = unit; });

openVaxSubtab("dueToday");
setTimeout(()=>{
const d = document.getElementById("vxdToday");
if(d) d.value = from || dayISO(new Date());
const typeSel = document.getElementById("vxdTodayType");
if(typeSel) typeSel.value = "";
const censusSel = document.getElementById("vxdTodayCensus");
if(censusSel) censusSel.value = "active";
if(typeof vaxPreviewDueToday==="function") vaxPreviewDueToday(true);
}, 120);
}

function printVaxDueWeekFromReports(){
const {unit, from} = getReportFilters();
Store.patch(st=>{ st.ui.unitFilter = unit; });

openVaxSubtab("dueWeek");
setTimeout(()=>{
const d = document.getElementById("vxdWeek");
if(d) d.value = from || dayISO(new Date());
const typeSel = document.getElementById("vxdWeekType");
if(typeSel) typeSel.value = "";
const censusSel = document.getElementById("vxdWeekCensus");
if(censusSel) censusSel.value = "active";
if(typeof vaxPreviewDueWeek==="function") vaxPreviewDueWeek(true);
}, 120);
}

function printVaxMatrixFromReports(){
const {unit, from, to} = getReportFilters();
Store.patch(st=>{ st.ui.unitFilter = unit; });

openVaxSubtab("matrix");
setTimeout(()=>{
const f = document.getElementById("vxmFrom");
const t = document.getElementById("vxmTo");
if(f) f.value = from || dayISO(new Date(new Date().setDate(new Date().getDate()-30)));
if(t) t.value = to || dayISO(new Date());
const censusSel = document.getElementById("vxmCensus");
if(censusSel) censusSel.value = "active";
if(typeof vaxPreviewMatrix==="function") vaxPreviewMatrix(true);
}, 120);
}

function exportVaxCSV(){
const s = Store.load();
const {unit, from, to} = getReportFilters();
let rows = (s.modules.vax?.events||[]).slice();
if(unit!=="ALL") rows = rows.filter(e=>(e.unit||"")===unit);
const getDateISO = (e)=> mdyToISO(e.date||"") || (e.date||"");
rows = filterByDate(rows, getDateISO, from, to);
rows.sort((a,b)=> (getDateISO(b)||"").localeCompare(getDateISO(a)||"") || (a.residentName||"").localeCompare(b.residentName||""));

const date = new Date().toISOString().slice(0,10);
const u = unit==="ALL" ? "ALL" : unit;

const cols = [
{key:"date",label:"Date"},
{key:"residentName",label:"Resident"},
{key:"mrn",label:"MRN"},
{key:"unit",label:"Unit"},
{key:"room",label:"Room"},
{key:"vaccineType",label:"Vaccine Type"},
{key:"status",label:"Status"},
{key:"notes",label:"Notes"}
];
const header = cols.map(c=>csvEscape(c.label)).join(",");
const lines = [header];
for(const e of rows){
const rec = {
date: e.date||"",
residentName: e.residentName||"",
mrn: e.mrn||"",
unit: unitNamePretty(s, e.unit||""),
room: e.room||"",
vaccineType: e.vaccineType||"",
status: e.status||"",
notes: e.notes||""
};
lines.push(cols.map(c=>csvEscape(rec[c.key])).join(","));
}
downloadCSV(`vax_${u}_${date}.csv`, lines.join("\n"));
}

function printSocSummary(){
const s = Store.load();
const unitKey = getReportFilters().unit;
const unitPretty = unitKey==="ALL" ? "All Units" : unitNamePretty(s, unitKey);
const facility = s.config.facilityName || "Facility";

const gaps = computeAbtSocGapsRows(s, unitKey);
const counts = {
totalActive: getAbtFilteredCourses(s, unitKey, true).length,
gapCount: gaps.length
};

const body = `
<div class="title">${escapeHtml(facility)} — Standard of Care (SOC) Summary</div>
<div class="muted" style="margin-top:4px">${escapeHtml(unitPretty)} · Generated ${escapeHtml(new Date().toLocaleString())}</div>

<div style="height:12px"></div>

<h3>Antibiotic Stewardship Documentation (ABT)</h3>
<table class="thin">
<tr><th style="width:260px">Metric</th><th>Count</th></tr>
<tr><td>Active antibiotic courses</td><td><b>${counts.totalActive}</b></td></tr>
<tr><td>Active courses with missing key fields (SOC gaps)</td><td><b>${counts.gapCount}</b></td></tr>
</table>

<div style="height:12px"></div>

<h3>SOC Gaps — Resident List</h3>
${gaps.length?`
<table class="thin">
<thead><tr><th>Resident</th><th style="width:120px">MRN</th><th style="width:110px">Unit</th><th style="width:80px">Room</th><th style="width:180px">Antibiotic</th><th style="width:110px">Start</th><th>Missing</th></tr></thead>
<tbody>${gaps.map(g=>`<tr><td>${escapeHtml(g.resident)}</td><td class="nowrap">${escapeHtml(g.mrn)}</td><td class="nowrap">${escapeHtml(g.unit)}</td><td class="nowrap">${escapeHtml(g.room)}</td><td>${escapeHtml(g.antibiotic)}</td><td class="nowrap">${escapeHtml(g.start)}</td><td>${escapeHtml(g.missing)}</td></tr>`).join("")}</tbody>
</table>
`:`<div class="muted">No SOC gaps detected.</div>`}
`;

openPrintWindow("SOC Summary", body, `
@page{ size: letter; margin: 0.55in; }
body{ font-size: 12px; }
th{ background:#f3f6fb; }
`);
}

function getReportFilters(){
const s = Store.load();
const unitSel = document.getElementById("rpUnit");
const fromEl = document.getElementById("rpFrom");
const toEl = document.getElementById("rpTo");
return {
unit: unitSel ? (unitSel.value||"ALL") : (s.ui.unitFilter||"ALL"),
from: fromEl?.value || "",
to: toEl?.value || ""
};
}

function filterByDate(list, getDateISO, fromISO, toISO){
let rows = list.slice();
if(fromISO) rows = rows.filter(x => (getDateISO(x)||"") >= fromISO);
if(toISO) rows = rows.filter(x => (getDateISO(x)||"") <= toISO);
return rows;
}

function computeLeadershipUpdate(s, unitKey, fromISO, toISO){
ensureIpData(s);
const sb = computeSituationBoard(s);
const unitPretty = unitKey==="ALL" ? "All Units" : unitNamePretty(s, unitKey);

let comms = (s.modules.ip.comms||[]).slice();
comms = filterByDate(comms, x=>x.date, fromISO, toISO);
if(unitKey!=="ALL") comms = comms.filter(x=>(x.unit||"")===unitKey);
comms.sort((a,b)=> (b.date||"").localeCompare(a.date||"") || (b.time||"").localeCompare(a.time||""));
comms = comms.slice(0,8);

let actions = (s.modules.ip.actions||[]).slice();
if(unitKey!=="ALL") actions = actions.filter(x=>(x.unit||"")===unitKey);
actions = actions.filter(x=>(x.status||"Open")!=="Done");
actions.sort((a,b)=> (a.dueDate||"").localeCompare(b.dueDate||"") || (b.date||"").localeCompare(a.date||""));
actions = actions.slice(0,10);

let decisions = (s.modules.ip.decisions||[]).slice();
decisions = filterByDate(decisions, x=>x.date, fromISO, toISO);
if(unitKey!=="ALL") decisions = decisions.filter(x=>(x.unit||"")===unitKey);
decisions.sort((a,b)=> (b.date||"").localeCompare(a.date||""));
decisions = decisions.slice(0,6);

return { unitPretty, sb, comms, actions, decisions };
}

function printLeadershipUpdate(){
const s = Store.load();
ensureIpData(s);

const {unit, from, to} = getReportFilters();

const prev = s.ui.unitFilter;
s.ui.unitFilter = unit;

const data = computeLeadershipUpdate(s, unit, from, to);
s.ui.unitFilter = prev;

const facility = s.config.facilityName || "Facility";
const dateLine = (from||to) ? `${from||"…"} to ${to||"…"}`
: dayISO(new Date());

const status = data.sb.status || "None";
const statusNotes = data.sb.statusNotes || "";

const alerts = (data.sb.alerts||[]).slice(0,8);

const body = `
<div class="title">${escapeHtml(facility)} — Outbreak Status Update</div>
<div class="muted" style="margin-top:4px">${escapeHtml(data.unitPretty)} · ${escapeHtml(dateLine)}</div>

<div style="height:12px"></div>

<table class="thin">
<tr>
<th style="width:220px">Outbreak Status</th>
<td><b>${escapeHtml(status)}</b> ${statusNotes?`— ${escapeHtml(statusNotes)}`:""}</td>
</tr>
<tr>
<th>Today: New Cases</th>
<td>${data.sb.newCases} (${escapeHtml(fmtByUnit(data.sb.newByUnit))})</td>
</tr>
<tr>
<th>Active Cases</th>
<td>${data.sb.activeCases} (${escapeHtml(fmtByUnit(data.sb.activeByUnit))})</td>
</tr>
<tr>
<th>Syndromes (Active)</th>
<td>Resp: ${data.sb.synd.Respiratory} · GI: ${data.sb.synd.GI} · Skin: ${data.sb.synd.Skin} · UTI: ${data.sb.synd.UTI} · Other: ${data.sb.synd.Other}</td>
</tr>
<tr>
<th>Precautions (Active)</th>
<td>Contact: ${data.sb.iso.Contact} · Droplet: ${data.sb.iso.Droplet} · Airborne: ${data.sb.iso.Airborne} · EBP: ${data.sb.iso.EBP}</td>
</tr>
<tr>
<th>Testing / Labs</th>
<td>Pending: ${data.sb.testStats?.counts?.Pending||0} · Retest due: ${data.sb.testStats?.counts?.RetestDue||0} · Pos not communicated: ${data.sb.testStats?.counts?.UncommPositive||0}</td>
</tr>
<tr>
<th>ABT Starts (Today)</th>
<td>${data.sb.abtStarts} (${escapeHtml(fmtByUnit(data.sb.abtByUnit))})</td>
</tr>
</table>

<div style="height:14px"></div>

<h3>Key Signals / Alerts</h3>
${alerts.length?`
<ul>
${alerts.map(a=>`<li><b>${escapeHtml((a.severity||"").toUpperCase())}</b> — ${escapeHtml(a.title||"")}: ${escapeHtml(a.detail||"")}</li>`).join("")}
</ul>
`:`<div class="muted">No alerts in current view.</div>`}

<div style="height:12px"></div>

<h3>Open Action Items</h3>
${data.actions.length?`
<table class="thin">
<thead><tr><th style="width:110px">Due</th><th style="width:140px">Owner</th><th>Action</th></tr></thead>
<tbody>
${data.actions.map(a=>`<tr><td class="nowrap">${escapeHtml(a.dueDate||"")}</td><td>${escapeHtml(a.owner||"")}</td><td>${escapeHtml(a.item||"")}</td></tr>`).join("")}
</tbody>
</table>
`:`<div class="muted">No open action items in scope.</div>`}

<div style="height:12px"></div>

<h3>Recent Decisions</h3>
${data.decisions.length?`
<ul>
${data.decisions.map(d=>`<li>${escapeHtml(d.date||"")} — <b>${escapeHtml(d.decision||"")}</b> (${escapeHtml(d.rationale||"")})</li>`).join("")}
</ul>
`:`<div class="muted">No decisions logged in scope.</div>`}

<div style="height:12px"></div>

<h3>Recent Communications</h3>
${data.comms.length?`
<table class="thin">
<thead><tr><th style="width:110px">Date</th><th style="width:90px">Time</th><th style="width:140px">Category</th><th style="width:220px">To/Who</th><th>Summary</th></tr></thead>
<tbody>
${data.comms.map(c=>`<tr><td class="nowrap">${escapeHtml(c.date||"")}</td><td class="nowrap">${escapeHtml(c.time||"")}</td><td>${escapeHtml(c.category||"")}</td><td>${escapeHtml(c.to||"")}</td><td>${escapeHtml(c.summary||"")}</td></tr>`).join("")}
</tbody>
</table>
`:`<div class="muted">No comms logged in scope.</div>`}

<div style="height:16px"></div>
<div class="muted mini">Prepared by: <b>${escapeHtml(getCurrentUser(s).name||"")}</b> · Generated: ${escapeHtml(new Date().toLocaleString())}</div>
`;

openPrintWindow("Leadership Update", body, `
@page{ size: letter; margin: 0.55in; }
body{ font-size: 12px; }
th{ background:#f3f6fb; }
`);
}

function computeQapiSummary(s, unitKey, fromISO, toISO){
ensureIpData(s);
const days = 7;
const trend = dailyCountsBySyndrome(s, unitKey, days);
const abt = dailyAbtStarts(s, unitKey, days);
const triggers = computeThresholdTriggers(s, unitKey);
const sb = computeSituationBoard(s);

const gaps = [];
if(sb.testStats?.counts?.UncommPositive) gaps.push(`Positive results not marked communicated: ${sb.testStats.counts.UncommPositive}`);
if(sb.testStats?.counts?.RetestDue) gaps.push(`Retest due today/overdue: ${sb.testStats.counts.RetestDue}`);
if(sb.testStats?.counts?.Pending>=5) gaps.push(`Pending test backlog: ${sb.testStats.counts.Pending}`);

let actions = (s.modules.ip.actions||[]).slice();
if(unitKey!=="ALL") actions = actions.filter(a=>(a.unit||"")===unitKey);
const openActions = actions.filter(a=>(a.status||"Open")!=="Done").slice(0,12);

let decisions = (s.modules.ip.decisions||[]).slice();
decisions = filterByDate(decisions, x=>x.date, fromISO, toISO);
if(unitKey!=="ALL") decisions = decisions.filter(d=>(d.unit||"")===unitKey);
decisions = decisions.slice(0,10);

return { trend, abt, triggers, gaps, openActions, decisions, sb };
}

function printQapiSummary(){
const s = Store.load();
ensureIpData(s);

const {unit, from, to} = getReportFilters();
const unitPretty = unit==="ALL" ? "All Units" : unitNamePretty(s, unit);

const prev = s.ui.unitFilter;
s.ui.unitFilter = unit;

const data = computeQapiSummary(s, unit, from, to);

s.ui.unitFilter = prev;

const facility = s.config.facilityName || "Facility";
const dateLine = (from||to) ? `${from||"…"} to ${to||"…"}` : `Last 7 days ending ${dayISO(new Date())}`;

const body = `
<div class="title">${escapeHtml(facility)} — QAPI Weekly Infection Prevention Summary</div>
<div class="muted" style="margin-top:4px">${escapeHtml(unitPretty)} · ${escapeHtml(dateLine)}</div>

<div style="height:12px"></div>

<h3>Trends (Last 7 days)</h3>
<table class="thin">
<thead><tr><th>Syndrome</th>${data.trend.dates.map(d=>`<th class="center">${d.slice(5)}</th>`).join("")}<th class="center">Total</th></tr></thead>
<tbody>
${["resp","gi","other"].map(k=>{
const label = k==="resp"?"Respiratory":(k==="gi"?"GI":"Other");
const obj = data.trend.map[k];
const tot = data.trend.dates.reduce((s2,d)=>s2+(obj[d]||0),0);
return `<tr><td><b>${label}</b></td>${data.trend.dates.map(d=>`<td class="center">${obj[d]||0}</td>`).join("")}<td class="center"><b>${tot}</b></td></tr>`;
}).join("")}
</tbody>
</table>

<div style="height:12px"></div>

<h3>Antibiotic Starts (Last 7 days)</h3>
<table class="thin">
<thead><tr><th>Date</th><th class="center">Starts</th></tr></thead>
<tbody>${data.abt.dates.map(d=>`<tr><td class="nowrap">${d}</td><td class="center">${data.abt.counts[d]||0}</td></tr>`).join("")}</tbody>
</table>

<div style="height:12px"></div>

<h3>Threshold Triggers (Last 72 hours)</h3>
${data.triggers.length?`
<ul>${data.triggers.map(t=>`<li><b>${escapeHtml((t.severity||"").toUpperCase())}</b> — ${escapeHtml(t.title||"")}: ${escapeHtml(t.detail||"")}</li>`).join("")}</ul>
`:`<div class="muted">No triggers.</div>`}

<div style="height:12px"></div>

<h3>Gaps / Risks</h3>
${data.gaps.length?`<ul>${data.gaps.map(g=>`<li>${escapeHtml(g)}</li>`).join("")}</ul>`:`<div class="muted">No gaps flagged by the tool today.</div>`}

<div style="height:12px"></div>

<h3>Corrective Actions (Open)</h3>
${data.openActions.length?`
<table class="thin">
<thead><tr><th style="width:110px">Due</th><th style="width:140px">Owner</th><th>Action</th></tr></thead>
<tbody>${data.openActions.map(a=>`<tr><td class="nowrap">${escapeHtml(a.dueDate||"")}</td><td>${escapeHtml(a.owner||"")}</td><td>${escapeHtml(a.item||"")}</td></tr>`).join("")}</tbody>
</table>
`:`<div class="muted">No open corrective actions.</div>`}

<div style="height:12px"></div>

<h3>Decisions / Rationale</h3>
${data.decisions.length?`
<ul>${data.decisions.map(d=>`<li>${escapeHtml(d.date||"")} — <b>${escapeHtml(d.decision||"")}</b>: ${escapeHtml(d.rationale||"")}</li>`).join("")}</ul>
`:`<div class="muted">No decision entries in scope.</div>`}

<div style="height:16px"></div>
<div class="muted mini">Prepared by: <b>${escapeHtml(getCurrentUser(s).name||"")}</b> · Generated: ${escapeHtml(new Date().toLocaleString())}</div>
`;

openPrintWindow("QAPI Summary", body, `
@page{ size: letter; margin: 0.55in; }
body{ font-size: 12px; }
th{ background:#f3f6fb; }
`);
}

function openSurveyorPacketSetup(){
const s = Store.load();
ensureIpData(s);
const units = (s.config.units||[]);
const today = dayISO(new Date());
const weekAgo = (d=>{const x=new Date(d); x.setDate(x.getDate()-7); return dayISO(x);} )(new Date());

openModal("Surveyor Packet Builder", `
<div class="muted mini">Choose scope and included sections. Output prints as a bundled packet with page breaks.</div>
<div class="sep"></div>

<div class="grid cols3">
<div>
<label>Unit</label>
<select id="sp_unit">
<option value="ALL">All Units</option>
${units.map(u=>`<option value="${escapeHtml(u.unitKey)}">${escapeHtml(u.unitName||u.unitKey)}</option>`).join("")}
</select>
</div>
<div><label>From</label><input id="sp_from" type="date" value="${weekAgo}"/></div>
<div><label>To</label><input id="sp_to" type="date" value="${today}"/></div>
</div>

<div class="sep"></div>

<div class="grid cols3">
<label class="chip" style="cursor:pointer"><input type="checkbox" id="sp_inc_status" checked/> <span>Situation/Status Update</span></label>
<label class="chip" style="cursor:pointer"><input type="checkbox" id="sp_inc_prec" checked/> <span>Unit Precaution Listing</span></label>
<label class="chip" style="cursor:pointer"><input type="checkbox" id="sp_inc_tests" checked/> <span>Testing/Labs Tracker</span></label>
<label class="chip" style="cursor:pointer"><input type="checkbox" id="sp_inc_abt" checked/> <span>ABT Active Antibiotics</span></label>
<label class="chip" style="cursor:pointer"><input type="checkbox" id="sp_inc_vax" /> <span>Vaccination Snapshot</span></label>
<label class="chip" style="cursor:pointer"><input type="checkbox" id="sp_inc_ili" checked/> <span>ILI Line List</span></label>
<label class="chip" style="cursor:pointer"><input type="checkbox" id="sp_inc_gi" checked/> <span>GI Line List</span></label>
<label class="chip" style="cursor:pointer"><input type="checkbox" id="sp_inc_comms" checked/> <span>Communications Log</span></label>
<label class="chip" style="cursor:pointer"><input type="checkbox" id="sp_inc_dec" checked/> <span>Actions/Decisions/Stop Rules</span></label>
<label class="chip" style="cursor:pointer"><input type="checkbox" id="sp_inc_audits" checked/> <span>Audit Hub Entries</span></label>
<label class="chip" style="cursor:pointer"><input type="checkbox" id="sp_inc_staff" checked/> <span>Staff Illness Log</span></label>
<label class="chip" style="cursor:pointer"><input type="checkbox" id="sp_inc_env" checked/> <span>Environment & Equipment Controls</span></label>
<label class="chip" style="cursor:pointer"><input type="checkbox" id="sp_inc_audit"/> <span>Audit Log (last 100)</span></label>
<div></div>
</div>

<div class="sep"></div>
<div class="row end" style="gap:8px">
<button class="btn" onclick="closeModal()">Cancel</button>
<button class="btn primary" onclick="printSurveyorPacket()">Build & Print</button>
</div>
`);
}

function buildTestsTableHTML(s, unitKey, fromISO, toISO){
ensureIpData(s);
let rows = (s.modules.ip.tests||[]).slice();
if(unitKey!=="ALL"){
rows = rows.filter(t=>{
if(!t.residentId) return false;
const r = s.residentsById[t.residentId];
const uk = getUnitKeyFromAny(r?.unit||"", s.config) || r?.unit || "";
return uk === unitKey;
});
}
rows = filterByDate(rows, t=>(t.resultedDate||t.collectedDate||t.orderedDate||""), fromISO, toISO);
rows.sort((a,b)=> (b.orderedDate||"").localeCompare(a.orderedDate||""));

const rowsHtml = rows.length ? rows.map(t=>{
const r = t.residentId ? s.residentsById[t.residentId] : null;
const room = r?.room || r?.lockedRoom || "";
const name = r?.name || "";
const mrn  = r?.mrn || "";
const comm = (t.communicated||"N")==="Y" ? `Y (${t.communicatedDate||""})` : "N";
return `<tr>
<td class="nowrap">${escapeHtml(testStatus(t))}</td>
<td class="nowrap">${escapeHtml(room)}</td>
<td>${escapeHtml(name)}</td>
<td class="nowrap">${escapeHtml(mrn)}</td>
<td>${escapeHtml(t.testType||"")}</td>
<td class="nowrap">${escapeHtml(t.orderedDate||"")}</td>
<td class="nowrap">${escapeHtml(t.collectedDate||"")}</td>
<td class="nowrap">${escapeHtml(t.resultedDate||"")}</td>
<td>${escapeHtml(t.result||"")}</td>
<td class="nowrap">${escapeHtml(t.retestDue||"")}</td>
<td class="nowrap">${escapeHtml(comm)}</td>
</tr>`;
}).join("") : `<tr><td colspan="11" class="muted">No tests in scope.</td></tr>`;

return `<h3>Testing / Labs</h3>
<table class="thin">
<thead><tr>
<th style="width:90px">Status</th><th style="width:70px">Room</th><th>Resident</th><th style="width:120px">MRN</th>
<th style="width:160px">Test</th><th style="width:110px">Ordered</th><th style="width:110px">Collected</th>
<th style="width:110px">Resulted</th><th style="width:140px">Result</th><th style="width:110px">Retest Due</th><th style="width:120px">Comm</th>
</tr></thead>
<tbody>${rowsHtml}</tbody>
</table>`;
}

function buildCommsHTML(s, unitKey, fromISO, toISO){
ensureIpData(s);
let rows = (s.modules.ip.comms||[]).slice();
rows = filterByDate(rows, x=>x.date, fromISO, toISO);
if(unitKey!=="ALL") rows = rows.filter(x=>(x.unit||"")===unitKey);
rows.sort((a,b)=> (b.date||"").localeCompare(a.date||"") || (b.time||"").localeCompare(a.time||""));
rows = rows.slice(0,120);

const body = rows.length ? rows.map(r=>`<tr>
<td class="nowrap">${escapeHtml(r.date||"")}</td>
<td class="nowrap">${escapeHtml(r.time||"")}</td>
<td>${escapeHtml(r.category||"")}</td>
<td>${escapeHtml(r.to||"")}</td>
<td>${escapeHtml(r.method||"")}</td>
<td>${escapeHtml(r.summary||"")}</td>
<td>${escapeHtml(r.followup||"")}</td>
</tr>`).join("") : `<tr><td colspan="7" class="muted">No comms in scope.</td></tr>`;

return `<h3>Communications Log</h3>
<table class="thin">
<thead><tr><th style="width:110px">Date</th><th style="width:90px">Time</th><th style="width:140px">Category</th><th style="width:220px">To/Who</th><th style="width:120px">Method</th><th>Summary</th><th>Follow-up</th></tr></thead>
<tbody>${body}</tbody>
</table>`;
}

function buildDecisionsHTML(s, unitKey, fromISO, toISO){
ensureIpData(s);
let actions = (s.modules.ip.actions||[]).slice();
if(unitKey!=="ALL") actions = actions.filter(a=>(a.unit||"")===unitKey);
actions = actions.slice(0,200);

let decisions = (s.modules.ip.decisions||[]).slice();
decisions = filterByDate(decisions, x=>x.date, fromISO, toISO);
if(unitKey!=="ALL") decisions = decisions.filter(d=>(d.unit||"")===unitKey);

const stop = (s.modules.ip.stopRules||[]).slice();

const actRows = actions.length ? actions.map(a=>`<tr>
<td class="nowrap">${escapeHtml(a.date||"")}</td>
<td class="nowrap">${escapeHtml(a.dueDate||"")}</td>
<td>${escapeHtml(a.status||"")}</td>
<td>${escapeHtml(a.owner||"")}</td>
<td>${escapeHtml(a.unit?unitNamePretty(s,a.unit):"")}</td>
<td>${escapeHtml(a.item||"")}</td>
</tr>`).join("") : `<tr><td colspan="6" class="muted">No actions.</td></tr>`;

const decRows = decisions.length ? decisions.map(d=>`<tr>
<td class="nowrap">${escapeHtml(d.date||"")}</td>
<td>${escapeHtml(d.unit?unitNamePretty(s,d.unit):"")}</td>
<td>${escapeHtml(d.decision||"")}</td>
<td>${escapeHtml(d.rationale||"")}</td>
</tr>`).join("") : `<tr><td colspan="4" class="muted">No decisions in scope.</td></tr>`;

const stopRows = stop.length ? stop.map(r=>`<li>${escapeHtml(r.text||"")} — <b>${escapeHtml(r.status||"Active")}</b></li>`).join("") : `<li class="muted">No stop rules.</li>`;

return `
<h3>Action Items</h3>
<table class="thin">
<thead><tr><th style="width:110px">Date</th><th style="width:110px">Due</th><th style="width:110px">Status</th><th style="width:160px">Owner</th><th style="width:140px">Unit</th><th>Action</th></tr></thead>
<tbody>${actRows}</tbody>
</table>

<div style="height:10px"></div>

<h3>Decision Log</h3>
<table class="thin">
<thead><tr><th style="width:110px">Date</th><th style="width:140px">Unit</th><th style="width:260px">Decision</th><th>Rationale</th></tr></thead>
<tbody>${decRows}</tbody>
</table>

<div style="height:10px"></div>

<h3>Stop Rules</h3>
<ul>${stopRows}</ul>
`;
}

function buildAuditHTML(s){
const rows = (s.auditLog||[]).slice(0,100);
const body = rows.length ? rows.map(e=>`<tr>
<td class="nowrap">${escapeHtml(new Date(e.ts).toLocaleString())}</td>
<td>${escapeHtml(e.user||"")}</td>
<td>${escapeHtml(e.role||"")}</td>
<td>${escapeHtml(e.action||"")}</td>
<td class="muted">${escapeHtml(formatAuditDetails(e.details))}</td>
</tr>`).join("") : `<tr><td colspan="5" class="muted">No audit entries.</td></tr>`;
return `<h3>Audit Log (Latest 100)</h3>
<table class="thin">
<thead><tr><th style="width:170px">Timestamp</th><th style="width:140px">User</th><th style="width:90px">Role</th><th style="width:220px">Action</th><th>Details</th></tr></thead>
<tbody>${body}</tbody>
</table>`;
}

function printSurveyorPacket(){
const s = Store.load();
ensureIpData(s);

const unit = document.getElementById("sp_unit")?.value || "ALL";
const from = document.getElementById("sp_from")?.value || "";
const to = document.getElementById("sp_to")?.value || "";

const inc = (id)=> !!document.getElementById(id)?.checked;

closeModal();

const prev = s.ui.unitFilter;
s.ui.unitFilter = unit;

const facility = s.config.facilityName || "Facility";
const unitPretty = unit==="ALL" ? "All Units" : unitNamePretty(s, unit);
const dateLine = (from||to) ? `${from||"…"} to ${to||"…"}` : dayISO(new Date());

const parts = [];

if(inc("sp_inc_status")){
const prev2 = s.ui.unitFilter;
s.ui.unitFilter = unit;
const ld = computeLeadershipUpdate(s, unit, from, to);
s.ui.unitFilter = prev2;
parts.push(`<div class="title">${escapeHtml(facility)} — Survey Packet</div>
<div class="muted">${escapeHtml(unitPretty)} · ${escapeHtml(dateLine)}</div>
<div style="height:10px"></div>` +
`<h3>Situation / Status</h3>` +
`<div><b>Outbreak Status:</b> ${escapeHtml(ld.sb.status||"None")} ${ld.sb.statusNotes?`— ${escapeHtml(ld.sb.statusNotes)}`:""}</div>` +
`<div style="height:8px"></div>` +
`<div><b>Active cases:</b> ${ld.sb.activeCases} · <b>New today:</b> ${ld.sb.newCases}</div>` +
`<div><b>Precautions:</b> Contact ${ld.sb.iso.Contact} · Droplet ${ld.sb.iso.Droplet} · Airborne ${ld.sb.iso.Airborne} · EBP ${ld.sb.iso.EBP}</div>` +
`<div><b>Testing:</b> Pending ${ld.sb.testStats?.counts?.Pending||0} · Retest due ${ld.sb.testStats?.counts?.RetestDue||0}</div>` +
`<div style="height:10px"></div>`
);
}

if(inc("sp_inc_prec")){
const rows = (s.modules.ip.precautions||[]).filter(p=>p.status==="active").filter(p=> unit==="ALL" ? true : ((getUnitKeyFromAny(p.unit||"", s.config) || p.unit)===unit));
rows.sort((a,b)=> (a.room||"").localeCompare(b.room||"", undefined, {numeric:true}));
const table = `<h3>Unit Precaution Listing</h3>
<table class="thin">
<thead><tr><th style="width:80px">Room</th><th style="width:260px">Resident</th><th>Precaution/Isolation</th><th style="width:220px">Source</th><th style="width:170px">Duration</th></tr></thead>
<tbody>${rows.length?rows.map(p=>`<tr><td class="nowrap">${escapeHtml(p.room||"")}</td><td>${escapeHtml(p.residentName||"")}</td><td>${escapeHtml(p.type||"")}</td><td>${escapeHtml(p.infectedSource||"")}</td><td>${escapeHtml(p.duration||"")}</td></tr>`).join(""):`<tr><td colspan="5" class="muted">No active precautions.</td></tr>`}</tbody>
</table>`;

parts.push(table)
}

if(inc("sp_inc_tests")){
parts.push(buildTestsTableHTML(s, unit, from, to));
}

if(inc("sp_inc_ili")){
const cases = (s.modules.ip.lineListCases||[]).filter(c=>c.kind==="resp");
const filtered = (unit==="ALL") ? cases : cases.filter(c=> (getUnitKeyFromAny(c.unit||"", s.config) || c.unit)===unit);
const scoped = filterByDate(filtered, c=>getCaseDateISO(c), from, to);
const rows = scoped.slice().sort((a,b)=> (a.room||"").localeCompare(b.room||"", undefined, {numeric:true}));
parts.push(`<h3>Respiratory Line List (Scoped)</h3>
<table class="thin">
<thead><tr><th style="width:70px">Room</th><th>Resident</th><th style="width:120px">MRN</th><th style="width:110px">Onset</th><th style="width:110px">Status</th><th>Notes</th></tr></thead>
<tbody>${rows.length?rows.map(c=>`<tr><td class="nowrap">${escapeHtml(c.room||"")}</td><td>${escapeHtml(c.name||"")}</td><td class="nowrap">${escapeHtml(c.mrn||"")}</td><td class="nowrap">${escapeHtml((c.onsetDate||c.createdAt||"").slice(0,10))}</td><td>${escapeHtml(c.status||"active")}</td><td class="muted">${escapeHtml(c.notes||"")}</td></tr>`).join(""):`<tr><td colspan="6" class="muted">No respiratory cases in scope.</td></tr>`}</tbody>
</table>`);
}

if(inc("sp_inc_gi")){
const cases = (s.modules.ip.lineListCases||[]).filter(c=>c.kind==="gi");
const filtered = (unit==="ALL") ? cases : cases.filter(c=> (getUnitKeyFromAny(c.unit||"", s.config) || c.unit)===unit);
const scoped = filterByDate(filtered, c=>getCaseDateISO(c), from, to);
const rows = scoped.slice().sort((a,b)=> (a.room||"").localeCompare(b.room||"", undefined, {numeric:true}));
parts.push(`<h3>GI Line List (Scoped)</h3>
<table class="thin">
<thead><tr><th style="width:70px">Room</th><th>Resident</th><th style="width:120px">MRN</th><th style="width:110px">Onset</th><th style="width:110px">Status</th><th>Notes</th></tr></thead>
<tbody>${rows.length?rows.map(c=>`<tr><td class="nowrap">${escapeHtml(c.room||"")}</td><td>${escapeHtml(c.name||"")}</td><td class="nowrap">${escapeHtml(c.mrn||"")}</td><td class="nowrap">${escapeHtml((c.onsetDate||c.createdAt||"").slice(0,10))}</td><td>${escapeHtml(c.status||"active")}</td><td class="muted">${escapeHtml(c.notes||"")}</td></tr>`).join(""):`<tr><td colspan="6" class="muted">No GI cases in scope.</td></tr>`}</tbody>
</table>`);
}

if(inc("sp_inc_comms")){
parts.push(buildCommsHTML(s, unit, from, to));
}

if(inc("sp_inc_dec")){
parts.push(buildDecisionsHTML(s, unit, from, to));
}

if(inc("sp_inc_audit")){
parts.push(buildAuditHTML(s));
}

s.ui.unitFilter = prev;

const included = [];
if(inc("sp_inc_status")) included.push("Situation / Status");
if(inc("sp_inc_prec")) included.push("Unit Precaution Listing");
if(inc("sp_inc_tests")) included.push("Testing / Labs");
if(inc("sp_inc_abt")) included.push("ABT Active Antibiotics");
if(inc("sp_inc_vax")) included.push("Vaccination Snapshot");
if(inc("sp_inc_ili")) included.push("Respiratory Line List (Scoped)");
if(inc("sp_inc_gi")) included.push("GI Line List (Scoped)");
if(inc("sp_inc_comms")) included.push("Communications Log");
if(inc("sp_inc_dec")) included.push("Actions / Decisions / Stop Rules");
if(inc("sp_inc_audit")) included.push("Audit Log (Latest 100)");
if(inc("sp_inc_audits")) included.push("Audit Hub Entries");
if(inc("sp_inc_staff")) included.push("Staff Illness Log");
if(inc("sp_inc_env")) included.push("Environment & Equipment Controls");

const genBy = getCurrentUser(s).name || "";
const genAt = new Date().toLocaleString();

const cover = `
<div class="packet-page">
<div class="packet-header">
<div class="packet-facility">${escapeHtml(facility)}</div>
<div class="packet-title">Surveyor Packet Bundle</div>
<div class="packet-sub">${escapeHtml(unitPretty)} · ${escapeHtml(dateLine)}</div>
</div>

<div class="packet-body">
<div style="height:14px"></div>

<div class="card" style="box-shadow:none">
<div style="font-weight:900; font-size:14px">Packet Details</div>
<div class="sep"></div>
<div><b>Prepared by:</b> ${escapeHtml(genBy)}</div>
<div><b>Generated:</b> ${escapeHtml(genAt)}</div>
<div><b>Scope:</b> ${escapeHtml(unitPretty)} · ${escapeHtml(dateLine)}</div>
</div>

<div style="height:14px"></div>

<div class="card" style="box-shadow:none">
<div style="font-weight:900; font-size:14px">Table of Contents</div>
<div class="sep"></div>
<ol class="toc">
${included.map(t=>`<li>${escapeHtml(t)}</li>`).join("")}
</ol>
<div class="muted mini">Note: Page numbers may vary based on printer settings.</div>
</div>

<div style="height:14px"></div>
<div class="muted mini">This packet is generated from the tool’s source-of-truth logs (cases, precautions, tests, communications, actions/decisions).</div>
</div>

<div class="packet-footer">
<div>Prepared by: <b>${escapeHtml(genBy)}</b></div>
<div class="packet-pageNo">Page <span class="pno"></span></div>
</div>
</div>
`;

const wrapSection = (title, innerHtml)=>{
return `
<div class="packet-page">
<div class="packet-header">
<div class="packet-facility">${escapeHtml(facility)}</div>
<div class="packet-title">${escapeHtml(title)}</div>
<div class="packet-sub">${escapeHtml(unitPretty)} · ${escapeHtml(dateLine)}</div>
</div>
<div class="packet-body">
${innerHtml}
</div>
<div class="packet-footer">
<div>Prepared by: <b>${escapeHtml(genBy)}</b></div>
<div class="packet-pageNo">Page <span class="pno"></span></div>
</div>
</div>
`;
};

const sectionPages = [];
if(inc("sp_inc_status")){
const prev2 = s.ui.unitFilter;
s.ui.unitFilter = unit;
const ld = computeLeadershipUpdate(s, unit, from, to);
s.ui.unitFilter = prev2;

const statusHtml = `
<h3>Outbreak Status</h3>
<div><b>Status:</b> ${escapeHtml(ld.sb.status||"None")} ${ld.sb.statusNotes?`— ${escapeHtml(ld.sb.statusNotes)}`:""}</div>
<div><b>New today:</b> ${ld.sb.newCases} · <b>Active:</b> ${ld.sb.activeCases}</div>
<div><b>By unit:</b> New — ${escapeHtml(fmtByUnit(ld.sb.newByUnit))} · Active — ${escapeHtml(fmtByUnit(ld.sb.activeByUnit))}</div>
<div style="height:10px"></div>
<h3>Key Signals / Alerts</h3>
${(ld.sb.alerts||[]).length ? `<ul>${ld.sb.alerts.slice(0,12).map(a=>`<li><b>${escapeHtml((a.severity||"").toUpperCase())}</b> — ${escapeHtml(a.title||"")}: ${escapeHtml(a.detail||"")}</li>`).join("")}</ul>` : `<div class="muted">No alerts in scope.</div>`}
`;
sectionPages.push(wrapSection("Situation / Status", statusHtml));
}

if(inc("sp_inc_prec")){
const rows = (s.modules.ip.precautions||[]).filter(p=>p.status==="active").filter(p=> unit==="ALL" ? true : ((getUnitKeyFromAny(p.unit||"", s.config) || p.unit)===unit));
rows.sort((a,b)=> (a.room||"").localeCompare(b.room||"", undefined, {numeric:true}));

const precHtml = `<table class="thin">
<thead><tr><th style="width:80px">Room</th><th style="width:260px">Resident</th><th>Precaution/Isolation</th><th style="width:220px">Source</th><th style="width:170px">Duration</th></tr></thead>
<tbody>${rows.length?rows.map(p=>`<tr><td class="nowrap">${escapeHtml(p.room||"")}</td><td>${escapeHtml(p.residentName||"")}</td><td>${escapeHtml(p.type||"")}</td><td>${escapeHtml(p.infectedSource||"")}</td><td>${escapeHtml(p.duration||"")}</td></tr>`).join(""):`<tr><td colspan="5" class="muted">No active precautions.</td></tr>`}</tbody>
</table>`;
sectionPages.push(wrapSection("Unit Precaution Listing", precHtml));
}

if(inc("sp_inc_tests")){
sectionPages.push(wrapSection("Testing / Labs", buildTestsTableHTML(s, unit, from, to)));
}
if(inc("sp_inc_abt")){
const rows = getAbtFilteredCourses(s, unit, true);
const abtHtml = `<table class="thin">
<thead><tr><th>Resident</th><th style="width:120px">MRN</th><th style="width:110px">Unit</th><th style="width:80px">Room</th>
<th style="width:180px">Antibiotic</th><th style="width:110px">Start</th><th style="width:110px">End</th><th style="width:90px">Route</th>
<th>Indication</th><th style="width:160px">Source</th><th style="width:140px">Line Listing</th></tr></thead>
<tbody>${rows.length?rows.map(c=>`<tr><td>${escapeHtml(c.residentName||"")}</td><td class="nowrap">${escapeHtml(c.mrn||"")}</td><td class="nowrap">${escapeHtml(unitNamePretty(s, getUnitKeyFromAny(c.unit||"", s.config) || c.unit || ""))}</td><td class="nowrap">${escapeHtml(c.room||"")}</td><td>${escapeHtml(c.antibiotic||"")}</td><td class="nowrap">${escapeHtml(c.startDate||"")}</td><td class="nowrap">${escapeHtml(c.endDate||"")}</td><td class="nowrap">${escapeHtml(c.route||"")}</td><td>${escapeHtml(c.indication||"")}</td><td>${escapeHtml(c.infectionSource||"")}</td><td>${escapeHtml(c.lineListing||"")}</td></tr>`).join(""):`<tr><td colspan="11" class="muted">No active antibiotics in scope.</td></tr>`}</tbody>
</table>`;
sectionPages.push(wrapSection("ABT Active Antibiotics", abtHtml));
}
if(inc("sp_inc_vax")){
let rows = (s.modules.vax?.events||[]).slice();
if(unit!=="ALL") rows = rows.filter(e=>(e.unit||"")===unit);
rows = filterByDate(rows, e=>mdyToISO(e.date||"")||e.date||"", from, to);
rows.sort((a,b)=> (mdyToISO(b.date)||"").localeCompare(mdyToISO(a.date)||"") || (a.residentName||"").localeCompare(b.residentName||""));
rows = rows.slice(0,200);
const vaxHtml = `<table class="thin">
<thead><tr><th style="width:110px">Date</th><th>Resident</th><th style="width:120px">MRN</th><th style="width:110px">Unit</th><th style="width:80px">Room</th><th style="width:170px">Type</th><th style="width:120px">Status</th><th>Notes</th></tr></thead>
<tbody>${rows.length?rows.map(e=>`<tr><td class="nowrap">${escapeHtml(e.date||"")}</td><td>${escapeHtml(e.residentName||"")}</td><td class="nowrap">${escapeHtml(e.mrn||"")}</td><td class="nowrap">${escapeHtml(unitNamePretty(s, e.unit||""))}</td><td class="nowrap">${escapeHtml(e.room||"")}</td><td>${escapeHtml(e.vaccineType||"")}</td><td>${escapeHtml(e.status||"")}</td><td class="muted">${escapeHtml(e.notes||"")}</td></tr>`).join(""):`<tr><td colspan="8" class="muted">No vaccination events in scope.</td></tr>`}</tbody>
</table>`;
sectionPages.push(wrapSection("Vaccination Snapshot", vaxHtml));
}

if(inc("sp_inc_ili")){
const cases = (s.modules.ip.lineListCases||[]).filter(c=>c.kind==="resp");
const filtered = (unit==="ALL") ? cases : cases.filter(c=> (getUnitKeyFromAny(c.unit||"", s.config) || c.unit)===unit);
const scoped = filterByDate(filtered, c=>getCaseDateISO(c), from, to);
const rows = scoped.slice().sort((a,b)=> (a.room||"").localeCompare(b.room||"", undefined, {numeric:true}));
const iliHtml = `<table class="thin">
<thead><tr><th style="width:70px">Room</th><th>Resident</th><th style="width:120px">MRN</th><th style="width:110px">Onset</th><th style="width:110px">Status</th><th>Notes</th></tr></thead>
<tbody>${rows.length?rows.map(c=>`<tr><td class="nowrap">${escapeHtml(c.room||"")}</td><td>${escapeHtml(c.name||"")}</td><td class="nowrap">${escapeHtml(c.mrn||"")}</td><td class="nowrap">${escapeHtml((c.onsetDate||c.createdAt||"").slice(0,10))}</td><td>${escapeHtml(c.status||"active")}</td><td class="muted">${escapeHtml(c.notes||"")}</td></tr>`).join(""):`<tr><td colspan="6" class="muted">No respiratory cases in scope.</td></tr>`}</tbody>
</table>`;
sectionPages.push(wrapSection("Respiratory Line List (Scoped)", iliHtml));
}
if(inc("sp_inc_gi")){
const cases = (s.modules.ip.lineListCases||[]).filter(c=>c.kind==="gi");
const filtered = (unit==="ALL") ? cases : cases.filter(c=> (getUnitKeyFromAny(c.unit||"", s.config) || c.unit)===unit);
const scoped = filterByDate(filtered, c=>getCaseDateISO(c), from, to);
const rows = scoped.slice().sort((a,b)=> (a.room||"").localeCompare(b.room||"", undefined, {numeric:true}));
const giHtml = `<table class="thin">
<thead><tr><th style="width:70px">Room</th><th>Resident</th><th style="width:120px">MRN</th><th style="width:110px">Onset</th><th style="width:110px">Status</th><th>Notes</th></tr></thead>
<tbody>${rows.length?rows.map(c=>`<tr><td class="nowrap">${escapeHtml(c.room||"")}</td><td>${escapeHtml(c.name||"")}</td><td class="nowrap">${escapeHtml(c.mrn||"")}</td><td class="nowrap">${escapeHtml((c.onsetDate||c.createdAt||"").slice(0,10))}</td><td>${escapeHtml(c.status||"active")}</td><td class="muted">${escapeHtml(c.notes||"")}</td></tr>`).join(""):`<tr><td colspan="6" class="muted">No GI cases in scope.</td></tr>`}</tbody>
</table>`;
sectionPages.push(wrapSection("GI Line List (Scoped)", giHtml));
}
if(inc("sp_inc_comms")){
sectionPages.push(wrapSection("Communications Log", buildCommsHTML(s, unit, from, to)));
}
if(inc("sp_inc_dec")){
sectionPages.push(wrapSection("Actions / Decisions / Stop Rules", buildDecisionsHTML(s, unit, from, to)));
}

if(inc("sp_inc_audits")){
let rows = (s.modules.ip.audits||[]).slice();
if(unit!=="ALL") rows = rows.filter(r=>(r.unit||"")===unit);
rows = filterByDate(rows, r=>r.date||"", from, to);
rows.sort((a,b)=> (b.date||"").localeCompare(a.date||"") || (b.time||"").localeCompare(a.time||""));
rows = rows.slice(0,250);

const auHtml = `<table class="thin">
<thead><tr><th style="width:110px">Date</th><th style="width:90px">Time</th><th style="width:140px">Type</th><th style="width:120px">Unit</th><th style="width:220px">Location</th><th style="width:140px">Observed By</th><th style="width:90px">Compliant</th><th>Notes</th></tr></thead>
<tbody>${rows.length?rows.map(r=>`<tr><td class="nowrap">${escapeHtml(r.date||"")}</td><td class="nowrap">${escapeHtml(r.time||"")}</td><td>${escapeHtml(r.type||"")}</td><td class="nowrap">${escapeHtml(r.unit?unitNamePretty(s,r.unit):"—")}</td><td>${escapeHtml(r.location||"")}</td><td>${escapeHtml(r.observedBy||"")}</td><td class="nowrap">${escapeHtml(r.compliant||"")}</td><td class="muted">${escapeHtml(r.notes||"")}</td></tr>`).join(""):`<tr><td colspan="8" class="muted">No audit entries in scope.</td></tr>`}</tbody>
</table>`;
sectionPages.push(wrapSection("Audit Hub Entries", auHtml));
}
if(inc("sp_inc_staff")){
let rows = (s.modules.ip.staffIllness||[]).slice();
if(unit!=="ALL") rows = rows.filter(r=>(r.unit||"")===unit);
rows = filterByDate(rows, r=>r.onsetDate||"", from, to);
rows.sort((a,b)=> (b.onsetDate||"").localeCompare(a.onsetDate||"") || (a.staffName||"").localeCompare(b.staffName||""));
rows = rows.slice(0,250);

const stHtml = `<table class="thin">
<thead><tr>
<th style="width:110px">Onset</th><th style="width:200px">Staff</th><th style="width:140px">Role</th><th style="width:120px">Unit</th>
<th style="width:110px">Last Worked</th><th style="width:110px">Test Date</th><th style="width:120px">Result</th><th style="width:110px">RTW</th>
<th style="width:140px">Status</th><th>Notes</th>
</tr></thead>
<tbody>${rows.length?rows.map(r=>`<tr>
<td class="nowrap">${escapeHtml(r.onsetDate||"")}</td>
<td>${escapeHtml(r.staffName||"")}</td>
<td>${escapeHtml(r.role||"")}</td>
<td class="nowrap">${escapeHtml(r.unit?unitNamePretty(s,r.unit):"—")}</td>
<td class="nowrap">${escapeHtml(r.lastWorkedDate||"")}</td>
<td class="nowrap">${escapeHtml(r.testDate||"")}</td>
<td class="nowrap">${escapeHtml(r.testResult||"")}</td>
<td class="nowrap">${escapeHtml(r.rtwDate||"")}</td>
<td class="nowrap">${escapeHtml(r.status||"")}</td>
<td class="muted">${escapeHtml(r.notes||"")}</td>
</tr>`).join(""):`<tr><td colspan="10" class="muted">No staff entries in scope.</td></tr>`}</tbody>
</table>`;
sectionPages.push(wrapSection("Staff Illness Log", stHtml));
}
if(inc("sp_inc_env")){
const unitKey = unit;
const env = computeEnvStats(s, unitKey);

const sup = s.modules.ip.envControls.supplies || {};
const low = env.lowSupplies||[];

const supHtml = `
<h3>PPE Supplies (Par Levels)</h3>
<table class="thin">
<thead><tr><th>Item</th><th style="width:140px">On-hand</th><th style="width:140px">Par</th><th style="width:140px">Status</th></tr></thead>
<tbody>
${["gloves","masks","gowns","sanitizer"].map(k=>{
const on = Number(sup?.[k]?.onHand||0);
const par = Number(sup?.[k]?.par||0);
const isLow = (par>0 && on<par);
return `<tr><td>${escapeHtml(k==="sanitizer"?"Hand Sanitizer":k.charAt(0).toUpperCase()+k.slice(1))}</td><td class="nowrap">${on}</td><td class="nowrap">${par}</td><td class="nowrap">${isLow?`<span class="badge red">LOW</span>`:`<span class="badge green">OK</span>`}</td></tr>`;
}).join("")}
</tbody>
</table>
`;

const ce = (s.modules.ip.envControls.cleaningEvents||[]).filter(x=> unit==="ALL" ? true : (x.unit||"")===unit);
const eq = (s.modules.ip.envControls.equipmentLog||[]).filter(x=> unit==="ALL" ? true : (x.unit||"")===unit);
const today = dayISO(new Date());
const overdue = eq.filter(x=> (x.status==="Overdue") || (x.nextDueDate && x.nextDueDate < today));

const ceHtml = `
<h3>Enhanced Cleaning (Active)</h3>
<table class="thin">
<thead><tr><th style="width:110px">Start</th><th style="width:110px">End</th><th style="width:120px">Unit</th><th style="width:220px">Area</th><th style="width:180px">Reason</th><th>Status</th></tr></thead>
<tbody>
${(ce.filter(x=>(x.status||"Active")==="Active").length) ? ce.filter(x=>(x.status||"Active")==="Active").map(x=>`<tr><td class="nowrap">${escapeHtml(x.startDate||"")}</td><td class="nowrap">${escapeHtml(x.endDate||"")}</td><td class="nowrap">${escapeHtml(x.unit?unitNamePretty(s,x.unit):"—")}</td><td>${escapeHtml(x.area||"")}</td><td>${escapeHtml(x.reason||"")}</td><td class="nowrap"><span class="badge blue">ACTIVE</span></td></tr>`).join("") : `<tr><td colspan="6" class="muted">No active enhanced cleaning events.</td></tr>`}
</tbody>
</table>
`;

const eqHtml = `
<h3>Shared Equipment Cleaning (Overdue)</h3>
<table class="thin">
<thead><tr><th style="width:170px">Equipment</th><th style="width:120px">Unit</th><th style="width:220px">Location</th><th style="width:110px">Last</th><th style="width:110px">Due</th><th>Notes</th></tr></thead>
<tbody>
${overdue.length ? overdue.map(x=>`<tr><td>${escapeHtml(x.equipment||"")}</td><td class="nowrap">${escapeHtml(x.unit?unitNamePretty(s,x.unit):"—")}</td><td>${escapeHtml(x.location||"")}</td><td class="nowrap">${escapeHtml(x.lastCleanDate||"")}</td><td class="nowrap">${escapeHtml(x.nextDueDate||"")}</td><td class="muted">${escapeHtml(x.notes||"")}</td></tr>`).join("") : `<tr><td colspan="6" class="muted">No overdue equipment in scope.</td></tr>`}
</tbody>
</table>
`;

sectionPages.push(wrapSection("Environment & Equipment Controls", supHtml + `<div style="height:10px"></div>` + ceHtml + `<div style="height:10px"></div>` + eqHtml));

}

if(inc("sp_inc_audit")){
sectionPages.push(wrapSection("Audit Log (Latest 100)", buildAuditHTML(s)));
}

const pages = [cover, ...sectionPages].map((p,i)=> p + (i<sectionPages.length?'<div style="page-break-after:always"></div>':"")).join("");
openPrintWindow("Surveyor Packet", pages, `
@page{ size: letter; margin: 0.55in; }
body{ font-size: 11px; }
th{ background:#f3f6fb; }

.packet-page{ position: relative; min-height: 10in; }
.packet-header{ border-bottom: 2px solid #111; padding-bottom: 8px; }
.packet-facility{ font-weight: 900; font-size: 16px; text-align:center; }
.packet-title{ font-weight: 900; font-size: 14px; text-align:center; margin-top: 4px; }
.packet-sub{ font-weight: 700; font-size: 11px; text-align:center; margin-top: 4px; }
.packet-body{ padding-top: 10px; padding-bottom: 24px; }
.packet-footer{ border-top: 2px solid #111; padding-top: 6px; font-size: 10px; display:flex; justify-content:space-between; align-items:flex-end; position: absolute; left:0; right:0; bottom:0; }
.packet-pageNo{ font-weight: 900; }
.packet-pageNo .pno:after{ content: counter(page); }

ol.toc{ margin: 0; padding-left: 20px; }
ol.toc li{ margin: 6px 0; }
`);
}

function exportCaseRosterCSV(){
const s = Store.load();
ensureConfig(s);
ensureIpData(s);

const f = getReportFilters();
const k = (f.syndrome||"resp");
const unit = f.unit || "ALL";
const start = (f.fromISO||"").slice(0,10);
const end = (f.toISO||"").slice(0,10);

let cases = (s.modules.ip.lineListCases||[]).filter(c=>c.kind===k);
if(unit!=="ALL"){
cases = cases.filter(c => (getUnitKeyFromAny(c.unit||"", s.config) || c.unit) === unit);
}
cases = cases.filter(c=>{
const d = (c.onsetDate || c.createdAt || "").slice(0,10);
if(start && d < start) return false;
if(end && d > end) return false;
return true;
}).sort((a,b)=> (a.room||"").localeCompare(b.room||"", undefined, {numeric:true}) || (a.name||"").localeCompare(b.name||""));

const rows = cases.map(c=>({
kind: (k==="gi"?"GI":"Respiratory"),
unit: unitNamePretty(s, c.unit)||c.unit||"",
room: c.room||"",
name: c.name||"",
mrn: c.mrn||"",
onset: (c.onsetDate||c.createdAt||"").slice(0,10),
antibiotic: c.antibiotic||"",
status: c.status||"active"
}));

const csv = toCSV(rows, ["kind","unit","room","name","mrn","onset","antibiotic","status"]);
const fname = `Case_Roster_${k}_${unit}_${dayISO(new Date())}.csv`.replace(/[^A-Za-z0-9_.-]+/g,"_");
downloadText(fname, csv);
toast("Case roster CSV exported.");
}


// --- QAPI Patient Days (PATCH: unit-filtered + optional derived) ---
function getQapiDaysCfg(){
  const cfg = (window.Store && Store.get && Store.get().cfg) ? Store.get().cfg : (window.state && state.cfg ? state.cfg : {});
  return cfg || {};
}
function getPatientDaysForUnit(unit){
  // Facility-wide patient days (source of truth): derived from censusHistory total when available,
  // otherwise fallback to Admin/Config manual patient-days entry.
  const cfg = getQapiDaysCfg();
  const days = 7;
  const facilityPD = Number(cfg.qapi_patientDays_7d || cfg.qapi_patientDays || 0) || 0;
  const derivedAll = calcPatientDaysFromCensusHistory("All", days);
  if(derivedAll!=null) return derivedAll;
  return facilityPD;
}
function calcPatientDaysFromCensusHistory(unit, days){
  // Optional: if your build stores daily census snapshots, derive patient-days.
  // Expected format: state.censusHistory = [{date:"YYYY-MM-DD", unitCounts:{Unit2:23,Unit3:18,...}, total:41}, ...]
  try{
    const hist = (window.state && state.censusHistory) ? state.censusHistory : ((window.Store && Store.get && Store.get().censusHistory) ? Store.get().censusHistory : null);
    if(!hist || !Array.isArray(hist) || hist.length===0) return null;
    const cutoff = new Date();
    cutoff.setDate(cutoff.getDate() - (days-1));
    let sum = 0, n = 0;
    for(const row of hist){
      if(!row || !row.date) continue;
      const d = new Date(row.date);
      if(isNaN(d)) continue;
      if(d < cutoff) continue;
      let c = 0;
      if(unit==="All") c = Number(row.total || 0) || 0;
      else if(row.unitCounts && row.unitCounts[unit]!=null) c = Number(row.unitCounts[unit]) || 0;
      sum += c; n += 1;
    }
    if(n===0) return null;
    // patient days approx = average census * days
    return Math.round((sum/n) * days);
  }catch(e){ return null; }
}

function exportCSVBundle(){
const s = Store.load();
ensureIpData(s);
const {unit, from, to} = getReportFilters();

let comms = (s.modules.ip.comms||[]).slice();
comms = filterByDate(comms, x=>x.date, from, to);
if(unit!=="ALL") comms = comms.filter(x=>(x.unit||"")===unit);

let actions = (s.modules.ip.actions||[]).slice();
if(unit!=="ALL") actions = actions.filter(x=>(x.unit||"")===unit);

let decisions = (s.modules.ip.decisions||[]).slice();
decisions = filterByDate(decisions, x=>x.date, from, to);
if(unit!=="ALL") decisions = decisions.filter(x=>(x.unit||"")===unit);

const testsStats = computeTestStats(s, unit);
let tests = testsStats.rows;
tests = filterByDate(tests, t=>(t.resultedDate||t.collectedDate||t.orderedDate||""), from, to);

const date = new Date().toISOString().slice(0,10);
const u = unit==="ALL" ? "ALL" : unit;

const toCSV = (columns, rows)=>{
const header = columns.map(c=>csvEscape(c.label)).join(",");
const lines = [header];
for(const r of rows){
lines.push(columns.map(c=>csvEscape(r[c.key])).join(","));
}
return lines.join("\n");
};

downloadCSV(`bundle_comms_${u}_${date}.csv`, toCSV([
{key:"date",label:"Date"},{key:"time",label:"Time"},{key:"category",label:"Category"},{key:"unit",label:"Unit"},
{key:"to",label:"To/Who"},{key:"method",label:"Method"},{key:"summary",label:"Summary"},{key:"followup",label:"Follow-up"}
], comms.map(r=>({date:r.date||"",time:r.time||"",category:r.category||"",unit:r.unit?unitNamePretty(s,r.unit):"",to:r.to||"",method:r.method||"",summary:r.summary||"",followup:r.followup||""}))));

downloadCSV(`bundle_actions_${u}_${date}.csv`, toCSV([
{key:"date",label:"Date"},{key:"due",label:"Due"},{key:"status",label:"Status"},{key:"owner",label:"Owner"},{key:"unit",label:"Unit"},{key:"priority",label:"Priority"},{key:"item",label:"Action"},{key:"notes",label:"Notes"}
], actions.map(a=>({date:a.date||"",due:a.dueDate||"",status:a.status||"",owner:a.owner||"",unit:a.unit?unitNamePretty(s,a.unit):"",priority:a.priority||"",item:a.item||"",notes:a.notes||""}))));

downloadCSV(`bundle_decisions_${u}_${date}.csv`, toCSV([
{key:"date",label:"Date"},{key:"unit",label:"Unit"},{key:"decision",label:"Decision"},{key:"rationale",label:"Rationale"},{key:"notes",label:"Notes"}
], decisions.map(d=>({date:d.date||"",unit:d.unit?unitNamePretty(s,d.unit):"",decision:d.decision||"",rationale:d.rationale||"",notes:d.notes||""}))));

downloadCSV(`bundle_tests_${u}_${date}.csv`, toCSV([
{key:"status",label:"Status"},{key:"room",label:"Room"},{key:"resident",label:"Resident"},{key:"mrn",label:"MRN"},
{key:"testType",label:"Test Type"},{key:"ordered",label:"Ordered"},{key:"collected",label:"Collected"},{key:"resulted",label:"Resulted"},
{key:"result",label:"Result"},{key:"retestDue",label:"Retest Due"},{key:"communicated",label:"Communicated"}
], tests.map(t=>{
const r = t.residentId ? s.residentsById[t.residentId] : null;
return {
status: testStatus(t),
room: r?.room || r?.lockedRoom || "",
resident: r?.name || "",
mrn: r?.mrn || "",
testType: t.testType||"",
ordered: t.orderedDate||"",
collected: t.collectedDate||"",
resulted: t.resultedDate||"",
result: t.result||"",
retestDue: t.retestDue||"",
communicated: (t.communicated||"N")==="Y" ? `Y (${t.communicatedDate||""})` : "N"
};
})));

alert("CSV bundle exported (4 files).");
}

function renderReports(s){
const pane = document.getElementById("tab-reports");
if(!pane) return;

ensureIpData(s);

const units = (s.config.units||[]);
const uSel = document.getElementById("rpUnit");
const from = document.getElementById("rpFrom");
const to = document.getElementById("rpTo");
const btnA = document.getElementById("btnRpApply");
const btnC = document.getElementById("btnRpClear");
const syn = document.getElementById("rpSyndrome");

if(uSel){
const cur = uSel.value || (s.ui.unitFilter||"ALL");
uSel.innerHTML = `<option value="ALL">All Units</option>` + units.map(u=>`<option value="${escapeHtml(u.unitKey)}">${escapeHtml(u.unitName||u.unitKey)}</option>`).join("");
uSel.value = (cur && (cur==="ALL" || units.some(u=>u.unitKey===cur))) ? cur : "ALL";
}

if(btnA && !btnA.dataset.bound){
btnA.dataset.bound="1";
btnA.addEventListener("click", ()=>{
const uk = uSel ? (uSel.value||"ALL") : "ALL";
withAudit("Set Report Filters", {unit:uk}, ()=>Store.patch(st=>{ st.ui.unitFilter = uk; }));
safeRenderAll();
});
}
if(btnC && !btnC.dataset.bound){
btnC.dataset.bound="1";
btnC.addEventListener("click", ()=>{
if(uSel) uSel.value="ALL";
if(from) from.value="";
if(to) to.value="";
withAudit("Clear Report Filters", {}, ()=>Store.patch(st=>{ st.ui.unitFilter = "ALL"; }));
safeRenderAll();
});
}

const b1 = document.getElementById("btnRpPrecList");
if(b1 && !b1.dataset.bound){
b1.dataset.bound="1";
b1.addEventListener("click", openPrecautionListPrintSetup);
}
const b2 = document.getElementById("btnRpILI");
if(b2 && !b2.dataset.bound){
b2.dataset.bound="1";
b2.addEventListener("click", ()=>openIpILIPrintTemplate());
}
const b3 = document.getElementById("btnRpGI");
if(b3 && !b3.dataset.bound){
b3.dataset.bound="1";
b3.addEventListener("click", ()=>openIpGIAcuteTemplatePrint());
}
const b4 = document.getElementById("btnRpLeadership");
const ob = document.getElementById("btnRpOutbreakPacket");
if(ob && !ob.dataset.bound){
ob.dataset.bound="1";
ob.addEventListener("click", ()=>{
const f = getReportFilters();
const kind = (f.syndrome||"resp");
printOutbreakPacket(kind, f.unit, f.fromISO, f.toISO);
});
}
const ocsv = document.getElementById("btnRpCaseCSV");
if(ocsv && !ocsv.dataset.bound){
ocsv.dataset.bound="1";
ocsv.addEventListener("click", exportCaseRosterCSV);
}

if(b4 && !b4.dataset.bound){
b4.dataset.bound="1";
b4.addEventListener("click", printLeadershipUpdate);
}
const b5 = document.getElementById("btnRpSurveyor");
if(b5 && !b5.dataset.bound){
b5.dataset.bound="1";
b5.addEventListener("click", openSurveyorPacketSetup);
}
const b6 = document.getElementById("btnRpQapi");
if(b6 && !b6.dataset.bound){
b6.dataset.bound="1";
b6.addEventListener("click", printQapiSummary);
}
const b7 = document.getElementById("btnRpCSVBundle");
if(b7 && !b7.dataset.bound){
b7.dataset.bound="1";
b7.addEventListener("click", exportCSVBundle);
}
const ab1 = document.getElementById("btnRpAbtActive");
if(ab1 && !ab1.dataset.bound){ ab1.dataset.bound="1"; ab1.addEventListener("click", printAbtActiveReport); }
const ab2 = document.getElementById("btnRpAbtSoc");
if(ab2 && !ab2.dataset.bound){ ab2.dataset.bound="1"; ab2.addEventListener("click", printAbtSocGaps); }
const ab3 = document.getElementById("btnRpAbtCsv");
if(ab3 && !ab3.dataset.bound){ ab3.dataset.bound="1"; ab3.addEventListener("click", exportAbtCSV); }

const vx1 = document.getElementById("btnRpVaxWeekly");
if(vx1 && !vx1.dataset.bound){ vx1.dataset.bound="1"; vx1.addEventListener("click", printVaxWeeklyFromReports); }
const vx2 = document.getElementById("btnRpVaxDueToday");
if(vx2 && !vx2.dataset.bound){ vx2.dataset.bound="1"; vx2.addEventListener("click", printVaxDueTodayFromReports); }
const vx3 = document.getElementById("btnRpVaxDueWeek");
if(vx3 && !vx3.dataset.bound){ vx3.dataset.bound="1"; vx3.addEventListener("click", printVaxDueWeekFromReports); }
const vx4 = document.getElementById("btnRpVaxMatrix");
if(vx4 && !vx4.dataset.bound){ vx4.dataset.bound="1"; vx4.addEventListener("click", printVaxMatrixFromReports); }
const vx5 = document.getElementById("btnRpVaxCsv");
if(vx5 && !vx5.dataset.bound){ vx5.dataset.bound="1"; vx5.addEventListener("click", exportVaxCSV); }

const soc1 = document.getElementById("btnRpSocSummary");
if(soc1 && !soc1.dataset.bound){ soc1.dataset.bound="1"; soc1.addEventListener("click", printSocSummary); }

const bh = document.getElementById("btnRpHelp");
if(bh && !bh.dataset.bound){
bh.dataset.bound="1";
bh.addEventListener("click", openReportWalkthroughModal);
}

const ba = document.getElementById("btnRpAudits");
if(ba && !ba.dataset.bound){
ba.dataset.bound="1";
ba.addEventListener("click", ()=>{
if(typeof setTab==="function") setTab("audits");
setTimeout(()=>{ printDrilldown(); }, 120);
});
}

const bs = document.getElementById("btnRpStaff");
if(bs && !bs.dataset.bound){
bs.dataset.bound="1";
bs.addEventListener("click", ()=>{
if(typeof setTab==="function") setTab("staff");
setTimeout(()=>{ printDrilldown(); }, 120);
});
}

const be = document.getElementById("btnRpEnv");
if(be && !be.dataset.bound){
be.dataset.bound="1";
be.addEventListener("click", ()=>{
if(typeof setTab==="function") setTab("env");
setTimeout(()=>{ printDrilldown(); }, 120);
});
}

}

function printBlankAuditRound(){
const s = Store.load();
const unitKey = document.getElementById("auUnit")?.value || (s.ui.unitFilter||"ALL");
const unitPretty = unitKey==="ALL" ? "All Units" : unitNamePretty(s, unitKey);
const facility = s.config.facilityName || "Facility";
const today = dayISO(new Date());

const body = `
<div class="title">${escapeHtml(facility)} — Audit Round Sheet</div>
<div class="muted" style="margin-top:4px">${escapeHtml(unitPretty)} · ${escapeHtml(today)}</div>
<div style="height:10px"></div>

<table class="thin">
<tr>
<th style="width:180px">Audit Type</th>
<td>☐ Hand Hygiene ☐ PPE ☐ Isolation/Precautions ☐ EBP ☐ Cleaning ☐ Other: __________</td>
</tr>
<tr>
<th>Observed By</th><td>______________________________</td>
</tr>
<tr>
<th>Shift</th><td>☐ Day ☐ Evening ☐ Night ☐ Other: _______</td>
</tr>
</table>

<div style="height:12px"></div>

<table class="thin">
<thead><tr>
<th style="width:60px">#</th>
<th style="width:240px">Location / Area</th>
<th style="width:100px" class="center">Compliant</th>
<th>Notes / Immediate Correction</th>
</tr></thead>
<tbody>
${Array.from({length:10}).map((_,i)=>`
<tr>
<td class="center">${i+1}</td>
<td>___________________________</td>
<td class="center">☐ Yes ☐ No</td>
<td>______________________________________________</td>
</tr>
`).join("")}
</tbody>
</table>

<div style="height:14px"></div>
<div class="muted mini">Tip: enter results into the tool (Audits tab) to generate compliance trends, triggers, and survey packet evidence.</div>
`;

openPrintWindow("Audit Round Sheet", body, `
@page{ size: letter; margin: 0.55in; }
body{ font-size: 12px; }
th{ background:#f3f6fb; }
.center{text-align:center;}
`);
}

function openAuditRoundModal(){
const s = Store.load();
ensureIpData(s);
const me = getCurrentUser(s);

const units = (s.config.units||[]);
const unitKey = document.getElementById("auUnit")?.value || (s.ui.unitFilter||"ALL");
const unitSel = `<option value="ALL">All Units</option>` + units.map(u=>`<option value="${escapeHtml(u.unitKey)}" ${u.unitKey===unitKey?"selected":""}>${escapeHtml(u.unitName||u.unitKey)}</option>`).join("");

const now = new Date();
const hh = String(now.getHours()).padStart(2,"0");
const mm = String(now.getMinutes()).padStart(2,"0");
const time = `${hh}:${mm}`;
const today = dayISO(now);

openModal("Start Rapid Audit Round", `
<div class="muted mini">Fast entry for rounds (recommended: 10 observations). Saves as individual audit entries in the Audit Hub.</div>
<div class="sep"></div>

<div class="grid cols3">
<div><label>Date</label><input id="ar_date" type="date" value="${today}"/></div>
<div><label>Start Time</label><input id="ar_time" type="time" value="${time}"/></div>
<div><label>Audit Type</label>
<select id="ar_type">
${["Hand Hygiene","PPE","Isolation/Precautions","EBP","Cleaning","Other"].map(x=>`<option value="${x}">${x}</option>`).join("")}
</select>
</div>
</div>

<div class="grid cols3" style="margin-top:10px">
<div><label>Unit</label><select id="ar_unit">${unitSel}</select></div>
<div><label>Observed By</label><input id="ar_obs" type="text" value="${escapeHtml(me.name||"")}"/></div>
<div><label># Observations</label><input id="ar_n" type="number" min="1" max="50" value="10"/></div>
</div>

<div class="sep"></div>

<div class="row noprint" style="gap:8px; flex-wrap:wrap; align-items:center">
<button class="smallbtn" id="ar_build">Build List</button>
<span class="muted mini">Tip: tap YES/NO quickly; add location notes as needed.</span>
</div>

<div class="sep"></div>

<div id="ar_tableWrap" style="display:none; overflow:auto; border:1px solid var(--line); border-radius:14px">
<table>
<thead><tr>
<th style="width:60px">#</th>
<th style="width:260px">Location / Area</th>
<th style="width:120px">Compliant?</th>
<th>Notes / Correction</th>
</tr></thead>
<tbody id="ar_tbody"></tbody>
</table>
</div>

<div class="sep"></div>

<div class="row end" style="gap:8px">
<button class="btn" onclick="closeModal()">Cancel</button>
<button class="btn primary" id="ar_save" disabled>Save Round</button>
</div>
`);

const build = ()=>{
const n = Math.max(1, Math.min(50, parseInt(document.getElementById("ar_n")?.value||"10",10)));
const tbody = document.getElementById("ar_tbody");
const wrap = document.getElementById("ar_tableWrap");
if(!tbody || !wrap) return;

tbody.innerHTML = Array.from({length:n}).map((_,i)=>`
<tr>
<td class="center">${i+1}</td>
<td><input type="text" class="ar_loc" placeholder="e.g., Room 312, nurses station, hallway"/></td>
<td>
<select class="ar_comp">
<option value="Y">Yes</option>
<option value="N">No</option>
</select>
</td>
<td><input type="text" class="ar_note" placeholder="brief note / immediate correction"/></td>
</tr>
`).join("");
wrap.style.display = "block";
const btnSave = document.getElementById("ar_save");
if(btnSave) btnSave.disabled = false;
};

const btnBuild = document.getElementById("ar_build");
if(btnBuild) btnBuild.addEventListener("click", build);

const btnSave = document.getElementById("ar_save");
if(btnSave) btnSave.addEventListener("click", ()=>{
const date = document.getElementById("ar_date")?.value || dayISO(new Date());
const time0 = document.getElementById("ar_time")?.value || "";
const type = document.getElementById("ar_type")?.value || "Hand Hygiene";
const unit = document.getElementById("ar_unit")?.value || "";
const observedBy = (document.getElementById("ar_obs")?.value||"").trim();

const locs = Array.from(document.querySelectorAll(".ar_loc")).map(x=>x.value.trim());
const comps = Array.from(document.querySelectorAll(".ar_comp")).map(x=>x.value);
const notes = Array.from(document.querySelectorAll(".ar_note")).map(x=>x.value.trim());

withAudit("Save Audit Round", {type, unit, n:locs.length}, ()=>Store.patch(st=>{
ensureIpData(st);
const me = getCurrentUser(st);
const arr = st.modules.ip.audits;

for(let i=0;i<locs.length;i++){
const loc = locs[i] || "";
const compliant = comps[i] || "Y";
const note = notes[i] || "";
if(!loc && !note) continue; // skip empty row
arr.push({
id: uid("audit"),
date,
time: time0,
type,
unit: unit==="ALL" ? "" : unit,
location: loc,
observedBy,
compliant,
correction: compliant==="N" ? note : "",
followupNeeded: compliant==="N" ? "Y" : "N",
followupStatus: compliant==="N" ? "OPEN" : "NA",
notes: note,
createdAt: nowISO(),
updatedAt: nowISO(),
createdBy: me.name||"",
updatedBy: me.name||""
});
}
}));

closeModal();
if(typeof setTab==="function") setTab("audits");
});
}

function auditGetFilteredRows(s){
ensureIpData(s);
const uSel = document.getElementById("auUnit");
const tSel = document.getElementById("auType");
const fSel = document.getElementById("auFollow");
const dFrom = document.getElementById("auFrom");
const dTo = document.getElementById("auTo");

const unitKey = uSel ? (uSel.value||"ALL") : "ALL";
const type = tSel ? (tSel.value||"ALL") : "ALL";
const follow = fSel ? (fSel.value||"ALL") : "ALL";
const from = dFrom?.value || "";
const to = dTo?.value || "";

let rows = (s.modules.ip.audits||[]).slice();
if(unitKey!=="ALL") rows = rows.filter(x=>(x.unit||"")===unitKey);
if(type!=="ALL") rows = rows.filter(x=>(x.type||"")===type);
if(from) rows = rows.filter(x=>(x.date||"")>=from);
if(to) rows = rows.filter(x=>(x.date||"")<=to);

rows = rows.map(r=>{
const fuNeeded = (r.followupNeeded||"N")==="Y";
const fuStatus = r.followupStatus || (fuNeeded ? "OPEN" : "NA");
return Object.assign({}, r, {followupStatus: fuStatus});
});

if(follow==="OPEN") rows = rows.filter(r=>(r.followupNeeded||"N")==="Y" && (r.followupStatus||"OPEN")==="OPEN");
if(follow==="DONE") rows = rows.filter(r=>(r.followupNeeded||"N")==="Y" && (r.followupStatus||"")!=="OPEN");
if(follow==="NA") rows = rows.filter(r=>(r.followupNeeded||"N")!=="Y");

rows.sort((a,b)=> (b.date||"").localeCompare(a.date||"") || (b.time||"").localeCompare(a.time||""));
return rows;
}

function auditSelectAllFiltered(){
const s = Store.load();
const rows = auditGetFilteredRows(s);
const ids = new Set(rows.map(r=>r.id));
document.querySelectorAll(".auSelBox").forEach(cb=>{
if(ids.has(cb.value)) cb.checked = true;
});
}

function auditClearSelection(){
document.querySelectorAll(".auSelBox").forEach(cb=> cb.checked = false);
}

function auditGetSelectedIds(){
return Array.from(document.querySelectorAll(".auSelBox")).filter(cb=>cb.checked).map(cb=>cb.value);
}

function auditCreateActionFromSelected(){
const s0 = Store.load();
ensureIpData(s0);
const ids = auditGetSelectedIds();
if(!ids.length){ alert("Select at least one audit row first."); return; }

const all = (s0.modules.ip.audits||[]);
const picked = ids.map(id=>all.find(x=>x.id===id)).filter(Boolean);
const non = picked.filter(r=>(r.compliant||"Y")==="N");

const unitKey = document.getElementById("auUnit")?.value || (s0.ui.unitFilter||"ALL");
const unitPretty = unitKey==="ALL" ? "All Units" : unitNamePretty(s0, unitKey);

const today = dayISO(new Date());
const title = `Audit follow-up: ${picked.length} observation(s) (${non.length} non-compliant)`;
const lines = picked.slice(0,20).map(r=>{
const comp = (r.compliant||"Y")==="Y" ? "YES" : "NO";
return `• ${r.date||""} ${r.time||""} — ${r.type||""} — ${r.location||""} — ${comp}${r.notes?` — ${r.notes}`:""}`;
}).join("\\n");

const notes = `Auto-created from Audit Hub selection on ${today} (${unitPretty}).\\n\\nSelected observations:\\n${lines}${picked.length>20?"\\n… (more not shown)":""}\\n\\nRecommended actions:\\n- Immediate coaching/education as needed\\n- Verify PPE/precaution signage and supplies\\n- Re-audit after intervention`;

withAudit("Audits → Create Action Item", {n:picked.length, unit:unitKey}, ()=>Store.patch(s=>{
ensureIpData(s);
const me = getCurrentUser(s);
const dueD = new Date(); dueD.setDate(dueD.getDate()+1);
const due = dayISO(dueD);
const a = {
id: uid("act"),
date: today,
dueDate: due,
status: "Open",
owner: me.name || "",
unit: (unitKey==="ALL") ? "" : unitKey,
priority: (non.length>=3) ? "High" : (non.length>=1 ? "Medium" : "Low"),
item: title,
notes,
createdAt: nowISO(),
updatedAt: nowISO(),
createdBy: me.name||"",
updatedBy: me.name||""
};
s.modules.ip.actions.push(a);
s.ui.pendingDrilldown = { type:"openAction", actionId: a.id };
}));

if(typeof setTab==="function") setTab("decisions");
}

function auditMarkFollowupDone(){
const ids = auditGetSelectedIds();
if(!ids.length){ alert("Select at least one audit row first."); return; }
withAudit("Audits → Mark Follow-up Done", {n:ids.length}, ()=>Store.patch(s=>{
ensureIpData(s);
const now = nowISO();
(s.modules.ip.audits||[]).forEach(r=>{
if(ids.includes(r.id)){
if((r.followupNeeded||"N")==="Y") r.followupStatus = "DONE";
r.updatedAt = now;
}
});
}));
safeRenderAll();
}

function openAuditModal(auditId){
const s = Store.load();
ensureIpData(s);
const me = getCurrentUser(s);
const a = auditId ? (s.modules.ip.audits||[]).find(x=>x.id===auditId) : null;
const today = dayISO(new Date());

const units = (s.config.units||[]);
const unitSel = `<option value="">—</option>` + units.map(u=>`<option value="${escapeHtml(u.unitKey)}" ${(a?.unit||"")===u.unitKey?"selected":""}>${escapeHtml(u.unitName||u.unitKey)}</option>`).join("");

openModal(`${auditId?"Edit":"New"} Audit`, `
<div class="grid cols3">
<div><label>Date</label><input id="au_date" type="date" value="${escapeHtml(a?.date||today)}"/></div>
<div><label>Time</label><input id="au_time" type="time" value="${escapeHtml(a?.time||"")}"/></div>
<div><label>Type</label>
<select id="au_type">
${["Hand Hygiene","PPE","Isolation/Precautions","EBP","Cleaning","Other"].map(x=>`<option value="${x}" ${(a?.type||"Hand Hygiene")===x?"selected":""}>${x}</option>`).join("")}
</select>
</div>
</div>

<div class="grid cols3" style="margin-top:10px">
<div><label>Unit</label><select id="au_unit">${unitSel}</select></div>
<div><label>Area/Location</label><input id="au_loc" type="text" value="${escapeHtml(a?.location||"")}" placeholder="e.g., Unit 3 hallway, Room 312, Nurses station"/></div>
<div><label>Observed By</label><input id="au_obs" type="text" value="${escapeHtml(a?.observedBy||me.name||"")}"/></div>
</div>

<div class="grid cols3" style="margin-top:10px">
<div><label>Compliant?</label>
<select id="au_comp">
<option value="Y" ${(a?.compliant||"Y")==="Y"?"selected":""}>Yes</option>
<option value="N" ${(a?.compliant||"Y")==="N"?"selected":""}>No</option>
</select>
</div>
<div><label>Immediate Correction</label><input id="au_fix" type="text" value="${escapeHtml(a?.correction||"")}" placeholder="e.g., re-educated, donned PPE, cleaned equipment"/></div>
<div><label>Follow-up Needed?</label>
<select id="au_follow">
<option value="N" ${(a?.followupNeeded||"N")==="N"?"selected":""}>No</option>
<option value="Y" ${(a?.followupNeeded||"N")==="Y"?"selected":""}>Yes</option>
</select>
</div>
</div>

<div style="margin-top:10px">
<label>Notes</label>
<input id="au_notes" type="text" value="${escapeHtml(a?.notes||"")}" placeholder="What was observed, guidance referenced, who was coached"/>
</div>

<div class="sep"></div>
<div class="row end" style="gap:8px">
${auditId?`<button class="btn danger" onclick="deleteAudit('${escapeHtml(auditId)}')">Delete</button>`:""}
<button class="btn" onclick="closeModal()">Cancel</button>
<button class="btn primary" onclick="saveAudit('${escapeHtml(auditId||"")}')">Save</button>
</div>
`);
}

window.saveAudit = function(auditId){
const date = document.getElementById("au_date")?.value || "";
const time = document.getElementById("au_time")?.value || "";
const type = document.getElementById("au_type")?.value || "Hand Hygiene";
const unit = document.getElementById("au_unit")?.value || "";
const location = (document.getElementById("au_loc")?.value||"").trim();
const observedBy = (document.getElementById("au_obs")?.value||"").trim();
const compliant = document.getElementById("au_comp")?.value || "Y";
const correction = (document.getElementById("au_fix")?.value||"").trim();
const followupNeeded = document.getElementById("au_follow")?.value || "N";
const followupStatus = (followupNeeded==="Y") ? "OPEN" : "NA";
const notes = (document.getElementById("au_notes")?.value||"").trim();

withAudit("Save Audit", {type, unit, compliant}, ()=>Store.patch(s=>{
ensureIpData(s);
const me = getCurrentUser(s);
const arr = s.modules.ip.audits;
if(auditId){
const a = arr.find(x=>x.id===auditId);
if(!a) return;
Object.assign(a, {date,time,type,unit,location,observedBy,compliant,correction,followupNeeded,followupStatus:(followupNeeded==="Y" ? (a.followupStatus||"OPEN") : "NA"),notes,updatedAt:nowISO(),updatedBy:me.name||""});
}else{
arr.push({id:uid("audit"),date,time,type,unit,location,observedBy,compliant,correction,followupNeeded,followupStatus,notes,createdAt:nowISO(),updatedAt:nowISO(),createdBy:me.name||"",updatedBy:me.name||""});
}
}));
closeModal();
};

window.deleteAudit = function(auditId){
if(!confirm("Delete this audit entry?")) return;
withAudit("Delete Audit", {id:auditId}, ()=>Store.patch(s=>{
ensureIpData(s);
s.modules.ip.audits = (s.modules.ip.audits||[]).filter(x=>x.id!==auditId);
}));
closeModal();
};

function renderAudits(s){
ensureIpData(s);
const pane = document.getElementById("tab-audits");
if(!pane) return;

const units = (s.config.units||[]);
const uSel = document.getElementById("auUnit");
const tSel = document.getElementById("auType");
const dFrom = document.getElementById("auFrom");
const dTo = document.getElementById("auTo");
const fSel = document.getElementById("auFollow");
const btnA = document.getElementById("btnAuApply");
const btnC = document.getElementById("btnAuClear");

if(uSel){
const cur = uSel.value || "ALL";
uSel.innerHTML = `<option value="ALL">All Units</option>` + units.map(u=>`<option value="${escapeHtml(u.unitKey)}">${escapeHtml(u.unitName||u.unitKey)}</option>`).join("");
uSel.value = (cur && (cur==="ALL" || units.some(u=>u.unitKey===cur))) ? cur : "ALL";
}
if(!tSel?.value) tSel.value = "ALL";
if(!fSel?.value) fSel.value = "ALL";

if(btnA && !btnA.dataset.bound){
btnA.dataset.bound="1";
btnA.addEventListener("click", ()=>renderAll());
}
if(btnC && !btnC.dataset.bound){
btnC.dataset.bound="1";
btnC.addEventListener("click", ()=>{
if(uSel) uSel.value="ALL";
if(tSel) tSel.value="ALL";
if(dFrom) dFrom.value="";
if(dTo) dTo.value="";
safeRenderAll();
});
}

const unitKey = uSel ? (uSel.value||"ALL") : "ALL";
const type = tSel ? (tSel.value||"ALL") : "ALL";
const follow = fSel ? (fSel.value||"ALL") : "ALL";
const from = dFrom?.value || "";
const to = dTo?.value || "";

let rows = auditGetFilteredRows(s);

const total = rows.length;
const non = rows.filter(r=>(r.compliant||"Y")==="N").length;
const followOpen = rows.filter(r=>(r.followupNeeded||"N")==="Y" && (r.followupStatus||"OPEN")==="OPEN").length;
const rate = total ? Math.round(((total-non)/total)*100) : 0;

const sum = {};
for(const r of rows){
const k = r.type || "Other";
if(!sum[k]) sum[k] = {total:0, non:0};
sum[k].total++;
if((r.compliant||"Y")==="N") sum[k].non++;
}

const sumBox = document.getElementById("auSummary");
if(sumBox){
const chips = [
`<span class="badge">Total: ${total}</span>`,
`<span class="badge ${non? "red":""}">Non-compliant: ${non}</span>`,
`<span class="badge ${follow? "blue":""}">Follow-up: ${followOpen}</span>`,
`<span class="badge green">Compliance: ${total?rate:0}%</span>`
];
const byType = Object.keys(sum).sort().map(k=>{
const v = sum[k];
const ok = v.total - v.non;
const pct = v.total ? Math.round((ok/v.total)*100) : 0;
return `<span class="badge">${escapeHtml(k)}: ${pct}% (${ok}/${v.total})</span>`;
});
sumBox.innerHTML = chips.concat(byType).join("");
}

const body = document.getElementById("auTbody");
if(body){
body.innerHTML = rows.length ? rows.map(r=>{
const comp = (r.compliant||"Y")==="Y";
const compBadge = comp ? "green" : "red";
const compText = comp ? "YES" : "NO";
return `<tr>
<td class="noprint edit-only center"><input class="auSelBox" type="checkbox" value="${escapeHtml(r.id)}"/></td>
<td class="nowrap">${escapeHtml(r.date||"")}</td>
<td class="nowrap">${escapeHtml(r.time||"")}</td>
<td>${escapeHtml(r.type||"")}</td>
<td class="nowrap">${escapeHtml(r.unit?unitNamePretty(s,r.unit):"—")}</td>
<td>${escapeHtml(r.location||"")}</td>
<td>${escapeHtml(r.observedBy||"")}</td>
<td class="nowrap"><span class="badge ${compBadge}">${compText}</span></td>
<td class="nowrap">${(r.followupNeeded||"N")==="Y" ? ((r.followupStatus||"OPEN")==="OPEN" ? `<span class="badge red">OPEN</span>` : `<span class="badge green">DONE</span>`) : `<span class="badge">N/A</span>`}</td>
<td class="muted">${escapeHtml(r.notes||"")}${r.correction?`<div class="mini">Correction: ${escapeHtml(r.correction)}</div>`:""}${(r.followupNeeded||"N")==="Y"?`<div class="mini">Follow-up needed</div>`:""}</td>
<td class="noprint edit-only nowrap">
<button class="smallbtn" onclick="openAuditModal('${escapeHtml(r.id)}')">Edit</button>
</td>
</tr>`;
}).join("") : `<tr><td colspan="10" class="muted">No audit entries yet.</td></tr>`;
}

setDrilldownExport({
type:"audit_hub",
title:"Audit Hub",
subtitle:`${unitKey==="ALL"?"All Units":unitNamePretty(s,unitKey)} · ${type==="ALL"?"All types":type}${from||to?` · ${from||"…"} to ${to||"…"}`
:""
}`,
columns:[
{key:"date",label:"Date"},
{key:"time",label:"Time"},
{key:"type",label:"Type"},
{key:"unit",label:"Unit"},
{key:"location",label:"Area/Location"},
{key:"observedBy",label:"Observed By"},
{key:"compliant",label:"Compliant"},
{key:"correction",label:"Immediate Correction"},
{key:"followupNeeded",label:"Follow-up"},
{key:"notes",label:"Notes"}
],
rows: rows.map(r=>({
date:r.date||"", time:r.time||"", type:r.type||"",
unit: r.unit?unitNamePretty(s,r.unit):"",
location:r.location||"", observedBy:r.observedBy||"",
compliant:r.compliant||"", correction:r.correction||"",
followupNeeded:r.followupNeeded||"", notes:r.notes||""
}))
});

const bNew = document.getElementById("btnNewAudit");
if(bNew && !bNew.dataset.bound){
bNew.dataset.bound="1";
bNew.addEventListener("click", ()=>openAuditModal(null));
}
const bP = document.getElementById("btnAuditPrint");
if(bP && !bP.dataset.bound){
bP.dataset.bound="1";
bP.addEventListener("click", ()=>printDrilldown());
}
const bX = document.getElementById("btnAuditCSV");
if(bX && !bX.dataset.bound){
bX.dataset.bound="1";
bX.addEventListener("click", ()=>exportDrilldownCSV());
}
const bRound = document.getElementById("btnAuditRound");
if(bRound && !bRound.dataset.bound){
bRound.dataset.bound="1";
bRound.addEventListener("click", openAuditRoundModal);
}
const bBlank = document.getElementById("btnAuditBlank");
if(bBlank && !bBlank.dataset.bound){
bBlank.dataset.bound="1";
bBlank.addEventListener("click", printBlankAuditRound);
}

const bSel = document.getElementById("btnAuSelectAll");
if(bSel && !bSel.dataset.bound){ bSel.dataset.bound="1"; bSel.addEventListener("click", auditSelectAllFiltered); }
const bClr = document.getElementById("btnAuClearSel");
if(bClr && !bClr.dataset.bound){ bClr.dataset.bound="1"; bClr.addEventListener("click", auditClearSelection); }
const bAct = document.getElementById("btnAuCreateAction");
if(bAct && !bAct.dataset.bound){ bAct.dataset.bound="1"; bAct.addEventListener("click", auditCreateActionFromSelected); }
const bDone = document.getElementById("btnAuMarkDone");
if(bDone && !bDone.dataset.bound){ bDone.dataset.bound="1"; bDone.addEventListener("click", auditMarkFollowupDone); }

}

function computeStaffStats(s, unitKey){
ensureIpData(s);
const today = dayISO(new Date());
const d7 = new Date(); d7.setDate(d7.getDate()-6);
const from7 = dayISO(d7);

let rows = (s.modules.ip.staffIllness||[]).slice();
if(unitKey && unitKey!=="ALL") rows = rows.filter(r=>(r.unit||"")===unitKey);
rows = rows.filter(r=> (r.onsetDate||"") >= from7 && (r.onsetDate||"") <= today);

const counts = {Symptomatic:0, "Test Pending":0, Positive:0, Recovered:0, "Cleared/RTW":0};
for(const r of rows){
const st = r.status || "Symptomatic";
if(counts[st]===undefined) counts[st]=0;
counts[st]++;
}
return {from7, today, rows, counts};
}

function openStaffIllModal(entryId){
const s = Store.load();
ensureIpData(s);
const me = getCurrentUser(s);
const e = entryId ? (s.modules.ip.staffIllness||[]).find(x=>x.id===entryId) : null;

const units = (s.config.units||[]);
const unitSel = `<option value="">—</option>` + units.map(u=>`<option value="${escapeHtml(u.unitKey)}" ${(e?.unit||"")===u.unitKey?"selected":""}>${escapeHtml(u.unitName||u.unitKey)}</option>`).join("");

const today = dayISO(new Date());

openModal(`${entryId?"Edit":"New"} Staff Illness/Exposure`, `
<div class="grid cols3">
<div><label>Onset Date</label><input id="si_onset" type="date" value="${escapeHtml(e?.onsetDate||today)}"/></div>
<div><label>Status</label>
<select id="si_status">
${["Symptomatic","Test Pending","Positive","Recovered","Cleared/RTW"].map(x=>`<option value="${x}" ${(e?.status||"Symptomatic")===x?"selected":""}>${x}</option>`).join("")}
</select>
</div>
<div><label>Unit Worked</label><select id="si_unit">${unitSel}</select></div>
</div>

<div class="grid cols3" style="margin-top:10px">
<div><label>Staff Name</label><input id="si_name" type="text" value="${escapeHtml(e?.staffName||"")}" placeholder="Last, First"/></div>
<div><label>Role</label><input id="si_role" type="text" value="${escapeHtml(e?.role||"")}" placeholder="RN / CNA / Therapy / EVS / etc"/></div>
<div><label>Last Worked Date</label><input id="si_lastWorked" type="date" value="${escapeHtml(e?.lastWorkedDate||"")}"/></div>
</div>

<div class="grid cols3" style="margin-top:10px">
<div><label>Test Date</label><input id="si_testDate" type="date" value="${escapeHtml(e?.testDate||"")}"/></div>
<div><label>Test Result</label>
<select id="si_result">
${["","Negative","Positive","Pending","Not Done"].map(x=>`<option value="${x}" ${(e?.testResult||"")===x?"selected":""}>${x||"—"}</option>`).join("")}
</select>
</div>
<div><label>Return-to-Work (RTW) Date</label><input id="si_rtw" type="date" value="${escapeHtml(e?.rtwDate||"")}"/></div>
</div>

<div style="margin-top:10px">
<label>Notes</label>
<input id="si_notes" type="text" value="${escapeHtml(e?.notes||"")}" placeholder="Symptoms, exposure details, isolation guidance, clearance rationale, etc."/>
</div>

<div class="sep"></div>
<div class="row end" style="gap:8px">
${entryId?`<button class="btn danger" onclick="deleteStaffIll('${escapeHtml(entryId)}')">Delete</button>`:""}
<button class="btn" onclick="closeModal()">Cancel</button>
<button class="btn primary" onclick="saveStaffIll('${escapeHtml(entryId||"")}')">Save</button>
</div>
`);
}

window.saveStaffIll = function(entryId){
const onsetDate = document.getElementById("si_onset")?.value || "";
const status = document.getElementById("si_status")?.value || "Symptomatic";
const unit = document.getElementById("si_unit")?.value || "";
const staffName = (document.getElementById("si_name")?.value||"").trim();
const role = (document.getElementById("si_role")?.value||"").trim();
const lastWorkedDate = document.getElementById("si_lastWorked")?.value || "";
const testDate = document.getElementById("si_testDate")?.value || "";
const testResult = document.getElementById("si_result")?.value || "";
const rtwDate = document.getElementById("si_rtw")?.value || "";
const notes = (document.getElementById("si_notes")?.value||"").trim();

if(!staffName){ alert("Staff name is required."); return; }

withAudit("Save Staff Illness", {status, unit}, ()=>Store.patch(s=>{
ensureIpData(s);
const me = getCurrentUser(s);
const arr = s.modules.ip.staffIllness;
if(entryId){
const e = arr.find(x=>x.id===entryId);
if(!e) return;
Object.assign(e, {onsetDate,status,unit,staffName,role,lastWorkedDate,testDate,testResult,rtwDate,notes,updatedAt:nowISO(),updatedBy:me.name||""});
} else {
arr.push({id:uid("st"),onsetDate,status,unit,staffName,role,lastWorkedDate,testDate,testResult,rtwDate,notes,createdAt:nowISO(),updatedAt:nowISO(),createdBy:me.name||"",updatedBy:me.name||""});
}
}));
closeModal();
};

window.deleteStaffIll = function(entryId){
if(!confirm("Delete this staff entry?")) return;
withAudit("Delete Staff Illness", {id:entryId}, ()=>Store.patch(s=>{
ensureIpData(s);
s.modules.ip.staffIllness = (s.modules.ip.staffIllness||[]).filter(x=>x.id!==entryId);
}));
closeModal();
};

function openStaffDrilldownModal(payload){
const s = Store.load();
ensureIpData(s);
const unit = payload.unit || (s.ui.unitFilter||"ALL");
const status = payload.status || "ALL";
const from = payload.from || "";
const to = payload.to || "";

let rows = (s.modules.ip.staffIllness||[]).slice();
if(unit!=="ALL") rows = rows.filter(r=>(r.unit||"")===unit);
if(status!=="ALL") rows = rows.filter(r=>(r.status||"")===status);
if(from) rows = rows.filter(r=>(r.onsetDate||"")>=from);
if(to) rows = rows.filter(r=>(r.onsetDate||"")<=to);
rows.sort((a,b)=> (b.onsetDate||"").localeCompare(a.onsetDate||"") || (a.staffName||"").localeCompare(b.staffName||""));

const unitPretty = unit==="ALL" ? "All Units" : unitNamePretty(s, unit);
const title = `Staff Illness Drilldown — ${status==="ALL"?"All Status":status} (${unitPretty})`;

setDrilldownExport({
type:"staff_illness",
title,
subtitle:`${from||"…"} to ${to||"…"}`,
columns:[
{key:"onsetDate",label:"Onset"},
{key:"staffName",label:"Staff"},
{key:"role",label:"Role"},
{key:"unit",label:"Unit"},
{key:"lastWorkedDate",label:"Last Worked"},
{key:"testDate",label:"Test Date"},
{key:"testResult",label:"Result"},
{key:"rtwDate",label:"RTW Date"},
{key:"status",label:"Status"},
{key:"notes",label:"Notes"}
],
rows: rows.map(r=>({
onsetDate:r.onsetDate||"", staffName:r.staffName||"", role:r.role||"",
unit:r.unit?unitNamePretty(s,r.unit):"",
lastWorkedDate:r.lastWorkedDate||"", testDate:r.testDate||"", testResult:r.testResult||"",
rtwDate:r.rtwDate||"", status:r.status||"", notes:r.notes||""
}))
});

openModal(title, `
<div class="row end noprint" style="gap:8px">
<button class="smallbtn" onclick="printDrilldown()">Print</button>
<button class="smallbtn" onclick="exportDrilldownCSV()">Export CSV</button>
</div>
<div class="muted mini">Scope is based on Onset Date. Edit entries from the Staffing tab.</div>
<div class="sep"></div>
<table>
<thead><tr>
<th style="width:110px">Onset</th><th style="width:180px">Staff</th><th style="width:140px">Role</th><th style="width:110px">Unit</th>
<th style="width:110px">Last Worked</th><th style="width:110px">Test</th><th style="width:120px">Result</th><th style="width:110px">RTW</th>
<th style="width:140px">Status</th><th>Notes</th>
</tr></thead>
<tbody>
${rows.length?rows.map(r=>`
<tr>
<td class="nowrap">${escapeHtml(r.onsetDate||"")}</td>
<td>${escapeHtml(r.staffName||"")}</td>
<td>${escapeHtml(r.role||"")}</td>
<td class="nowrap">${escapeHtml(r.unit?unitNamePretty(s,r.unit):"—")}</td>
<td class="nowrap">${escapeHtml(r.lastWorkedDate||"")}</td>
<td class="nowrap">${escapeHtml(r.testDate||"")}</td>
<td class="nowrap">${escapeHtml(r.testResult||"")}</td>
<td class="nowrap">${escapeHtml(r.rtwDate||"")}</td>
<td class="nowrap"><span class="badge">${escapeHtml(r.status||"")}</span></td>
<td class="muted">${escapeHtml(r.notes||"")}</td>
</tr>
`).join(""):`<tr><td colspan="10" class="muted">No staff entries in scope.</td></tr>`}
</tbody>
</table>
`);
}

function renderStaffing(s){
ensureIpData(s);
const pane = document.getElementById("tab-staff");
if(!pane) return;

const units = (s.config.units||[]);
const uSel = document.getElementById("stUnit");
const stSel = document.getElementById("stStatus");
const dFrom = document.getElementById("stFrom");
const dTo = document.getElementById("stTo");
const btnA = document.getElementById("btnStApply");
const btnC = document.getElementById("btnStClear");

if(uSel){
const cur = uSel.value || "ALL";
uSel.innerHTML = `<option value="ALL">All Units</option>` + units.map(u=>`<option value="${escapeHtml(u.unitKey)}">${escapeHtml(u.unitName||u.unitKey)}</option>`).join("");
uSel.value = (cur && (cur==="ALL" || units.some(u=>u.unitKey===cur))) ? cur : "ALL";
}
if(!stSel?.value) stSel.value = "ALL";

if(btnA && !btnA.dataset.bound){
btnA.dataset.bound="1";
btnA.addEventListener("click", ()=>renderAll());
}
if(btnC && !btnC.dataset.bound){
btnC.dataset.bound="1";
btnC.addEventListener("click", ()=>{
if(uSel) uSel.value="ALL";
if(stSel) stSel.value="ALL";
if(dFrom) dFrom.value="";
if(dTo) dTo.value="";
safeRenderAll();
});
}

const unitKey = uSel ? (uSel.value||"ALL") : "ALL";
const status = stSel ? (stSel.value||"ALL") : "ALL";
const from = dFrom?.value || "";
const to = dTo?.value || "";

let rows = (s.modules.ip.staffIllness||[]).slice();
if(unitKey!=="ALL") rows = rows.filter(r=>(r.unit||"")===unitKey);
if(status!=="ALL") rows = rows.filter(r=>(r.status||"")===status);
if(from) rows = rows.filter(r=>(r.onsetDate||"")>=from);
if(to) rows = rows.filter(r=>(r.onsetDate||"")<=to);
rows.sort((a,b)=> (b.onsetDate||"").localeCompare(a.onsetDate||"") || (a.staffName||"").localeCompare(b.staffName||""));

const cnt = {Symptomatic:0,"Test Pending":0,Positive:0,Recovered:0,"Cleared/RTW":0};
for(const r of rows){
const k = r.status||"Symptomatic";
if(cnt[k]===undefined) cnt[k]=0;
cnt[k]++;
}
const sum = document.getElementById("stSummary");
if(sum){
const chips = [
`<span class="badge">Total: ${rows.length}</span>`,
`<span class="badge red">Positive: ${cnt["Positive"]||0}</span>`,
`<span class="badge blue">Test pending: ${cnt["Test Pending"]||0}</span>`,
`<span class="badge">Symptomatic: ${cnt["Symptomatic"]||0}</span>`,
`<span class="badge green">Cleared: ${cnt["Cleared/RTW"]||0}</span>`
];
sum.innerHTML = chips.join("");
}

const body = document.getElementById("stTbody");
if(body){
body.innerHTML = rows.length ? rows.map(r=>`
<tr>
<td class="nowrap">${escapeHtml(r.onsetDate||"")}</td>
<td>${escapeHtml(r.staffName||"")}</td>
<td>${escapeHtml(r.role||"")}</td>
<td class="nowrap">${escapeHtml(r.unit?unitNamePretty(s,r.unit):"—")}</td>
<td class="nowrap">${escapeHtml(r.lastWorkedDate||"")}</td>
<td class="nowrap">${escapeHtml(r.testDate||"")}</td>
<td class="nowrap">${escapeHtml(r.testResult||"")}</td>
<td class="nowrap">${escapeHtml(r.rtwDate||"")}</td>
<td class="muted">${escapeHtml(r.notes||"")}</td>
<td class="noprint edit-only nowrap">
<button class="smallbtn" onclick="openStaffIllModal('${escapeHtml(r.id)}')">Edit</button>
</td>
</tr>
`).join("") : `<tr><td colspan="10" class="muted">No staff entries yet.</td></tr>`;
}

const unitPretty = unitKey==="ALL" ? "All Units" : unitNamePretty(s, unitKey);
setDrilldownExport({
type:"staff_tab",
title:"Staff Illness Log",
subtitle:`${unitPretty} · ${status==="ALL"?"All status":status}${from||to?` · ${from||"…"} to ${to||"…"}`
:""
}`,
columns:[
{key:"onsetDate",label:"Onset"},
{key:"staffName",label:"Staff"},
{key:"role",label:"Role"},
{key:"unit",label:"Unit"},
{key:"lastWorkedDate",label:"Last Worked"},
{key:"testDate",label:"Test Date"},
{key:"testResult",label:"Result"},
{key:"rtwDate",label:"RTW Date"},
{key:"status",label:"Status"},
{key:"notes",label:"Notes"}
],
rows: rows.map(r=>({
onsetDate:r.onsetDate||"", staffName:r.staffName||"", role:r.role||"",
unit:r.unit?unitNamePretty(s,r.unit):"",
lastWorkedDate:r.lastWorkedDate||"", testDate:r.testDate||"", testResult:r.testResult||"",
rtwDate:r.rtwDate||"", status:r.status||"", notes:r.notes||""
}))
});

const bNew = document.getElementById("btnNewStaffIll");
if(bNew && !bNew.dataset.bound){
bNew.dataset.bound="1";
bNew.addEventListener("click", ()=>openStaffIllModal(null));
}
const bP = document.getElementById("btnStaffPrint");
if(bP && !bP.dataset.bound){
bP.dataset.bound="1";
bP.addEventListener("click", ()=>printDrilldown());
}
const bX = document.getElementById("btnStaffCSV");
if(bX && !bX.dataset.bound){
bX.dataset.bound="1";
bX.addEventListener("click", ()=>exportDrilldownCSV());
}
}

function supplyChip(label, key, obj){
const on = Number(obj?.onHand||0);
const par = Number(obj?.par||0);
const ok = (par<=0) ? true : (on >= par);
const cls = ok ? "green" : "red";
const txt = (par>0) ? `${on}/${par}` : `${on}`;
return `<span class="badge ${cls}">${escapeHtml(label)}: ${escapeHtml(txt)}</span>`;
}

function openPpeModal(){
const s = Store.load();
ensureIpData(s);
const sup = s.modules.ip.envControls.supplies || {};
const row = (k,label)=>`
<div class="grid cols3" style="align-items:end; margin-top:8px">
<div><label>${escapeHtml(label)} On-hand</label><input id="ppe_${k}_on" type="number" min="0" value="${Number(sup?.[k]?.onHand||0)}"/></div>
<div><label>${escapeHtml(label)} Par</label><input id="ppe_${k}_par" type="number" min="0" value="${Number(sup?.[k]?.par||0)}"/></div>
<div class="muted mini">If par is 0, tool won’t flag as low.</div>
</div>
`;
openModal("Update PPE Supplies (Par Levels)", `
<div class="muted mini">Set on-hand and par levels. Used for Situation Board alerts and survey packet evidence.</div>
<div class="sep"></div>
${row("gloves","Gloves")}
${row("masks","Masks")}
${row("gowns","Gowns")}
${row("sanitizer","Hand Sanitizer")}
<div class="sep"></div>
<div class="row end" style="gap:8px">
<button class="btn" onclick="closeModal()">Cancel</button>
<button class="btn primary" onclick="savePpe()">Save</button>
</div>
`);
}

window.savePpe = function(){
const get = (k)=>({
onHand: Number(document.getElementById(`ppe_${k}_on`)?.value||0),
par: Number(document.getElementById(`ppe_${k}_par`)?.value||0)
});
withAudit("Save PPE Supplies", {}, ()=>Store.patch(s=>{
ensureIpData(s);
s.modules.ip.envControls.supplies = {
gloves:get("gloves"),
masks:get("masks"),
gowns:get("gowns"),
sanitizer:get("sanitizer")
};
}));
closeModal();
};

function openCleaningEventModal(id){
const s = Store.load();
ensureIpData(s);
const me = getCurrentUser(s);
const ev = id ? (s.modules.ip.envControls.cleaningEvents||[]).find(x=>x.id===id) : null;
const today = dayISO(new Date());
const units = (s.config.units||[]);
const unitSel = `<option value="">—</option>` + units.map(u=>`<option value="${escapeHtml(u.unitKey)}" ${(ev?.unit||"")===u.unitKey?"selected":""}>${escapeHtml(u.unitName||u.unitKey)}</option>`).join("");

openModal(`${id?"Edit":"New"} Enhanced Cleaning Event`, `
<div class="grid cols3">
<div><label>Start</label><input id="ce_start" type="date" value="${escapeHtml(ev?.startDate||today)}"/></div>
<div><label>End</label><input id="ce_end" type="date" value="${escapeHtml(ev?.endDate||"")}"/></div>
<div><label>Status</label>
<select id="ce_status">
${["Active","Completed"].map(x=>`<option value="${x}" ${(ev?.status||"Active")===x?"selected":""}>${x}</option>`).join("")}
</select>
</div>
</div>
<div class="grid cols3" style="margin-top:10px">
<div><label>Unit</label><select id="ce_unit">${unitSel}</select></div>
<div><label>Area</label><input id="ce_area" type="text" value="${escapeHtml(ev?.area||"")}" placeholder="e.g., hallway, dining, room cluster"/></div>
<div><label>Reason</label><input id="ce_reason" type="text" value="${escapeHtml(ev?.reason||"")}" placeholder="GI cluster, respiratory outbreak, terminal clean"/></div>
</div>
<div style="margin-top:10px">
<label>Notes</label>
<input id="ce_notes" type="text" value="${escapeHtml(ev?.notes||"")}" placeholder="Products used, frequency, who notified, etc."/>
</div>
<div class="sep"></div>
<div class="row end" style="gap:8px">
${id?`<button class="btn danger" onclick="deleteCleaningEvent('${escapeHtml(id)}')">Delete</button>`:""}
<button class="btn" onclick="closeModal()">Cancel</button>
<button class="btn primary" onclick="saveCleaningEvent('${escapeHtml(id||"")}')">Save</button>
</div>
`);
}

window.saveCleaningEvent = function(id){
const startDate = document.getElementById("ce_start")?.value || "";
const endDate = document.getElementById("ce_end")?.value || "";
const status = document.getElementById("ce_status")?.value || "Active";
const unit = document.getElementById("ce_unit")?.value || "";
const area = (document.getElementById("ce_area")?.value||"").trim();
const reason = (document.getElementById("ce_reason")?.value||"").trim();
const notes = (document.getElementById("ce_notes")?.value||"").trim();
withAudit("Save Cleaning Event", {unit,status}, ()=>Store.patch(s=>{
ensureIpData(s);
const me = getCurrentUser(s);
const arr = s.modules.ip.envControls.cleaningEvents;
if(id){
const ev = arr.find(x=>x.id===id);
if(!ev) return;
Object.assign(ev,{startDate,endDate,status,unit,area,reason,notes,updatedAt:nowISO(),updatedBy:me.name||""});
} else {
arr.push({id:uid("ce"),startDate,endDate,status,unit,area,reason,notes,createdAt:nowISO(),updatedAt:nowISO(),createdBy:me.name||"",updatedBy:me.name||""});
}
}));
closeModal();
};

window.deleteCleaningEvent = function(id){
if(!confirm("Delete this cleaning event?")) return;
withAudit("Delete Cleaning Event", {id}, ()=>Store.patch(s=>{
ensureIpData(s);
s.modules.ip.envControls.cleaningEvents = (s.modules.ip.envControls.cleaningEvents||[]).filter(x=>x.id!==id);
}));
closeModal();
};

function openEquipmentModal(id){
const s = Store.load();
ensureIpData(s);
const me = getCurrentUser(s);
const eq = id ? (s.modules.ip.envControls.equipmentLog||[]).find(x=>x.id===id) : null;
const today = dayISO(new Date());
const units = (s.config.units||[]);
const unitSel = `<option value="">—</option>` + units.map(u=>`<option value="${escapeHtml(u.unitKey)}" ${(eq?.unit||"")===u.unitKey?"selected":""}>${escapeHtml(u.unitName||u.unitKey)}</option>`).join("");

openModal(`${id?"Edit":"New"} Equipment Cleaning Log`, `
<div class="grid cols3">
<div><label>Equipment</label><input id="eq_name" type="text" value="${escapeHtml(eq?.equipment||"")}" placeholder="e.g., vitals machine, glucometer"/></div>
<div><label>Unit</label><select id="eq_unit">${unitSel}</select></div>
<div><label>Location</label><input id="eq_loc" type="text" value="${escapeHtml(eq?.location||"")}" placeholder="where stored/used"/></div>
</div>
<div class="grid cols3" style="margin-top:10px">
<div><label>Last Clean</label><input id="eq_last" type="date" value="${escapeHtml(eq?.lastCleanDate||today)}"/></div>
<div><label>Next Due</label><input id="eq_due" type="date" value="${escapeHtml(eq?.nextDueDate||"")}"/></div>
<div><label>Cleaned By</label><input id="eq_by" type="text" value="${escapeHtml(eq?.cleanedBy||me.name||"")}"/></div>
</div>
<div class="grid cols3" style="margin-top:10px">
<div><label>Status</label>
<select id="eq_status">
${["OK","Overdue"].map(x=>`<option value="${x}" ${(eq?.status||"OK")===x?"selected":""}>${x}</option>`).join("")}
</select>
</div>
<div><label>Notes</label><input id="eq_notes" type="text" value="${escapeHtml(eq?.notes||"")}" placeholder="product used, contact time, etc."/></div>
<div class="muted mini">Tip: set Next Due based on policy.</div>
</div>
<div class="sep"></div>
<div class="row end" style="gap:8px">
${id?`<button class="btn danger" onclick="deleteEquipment('${escapeHtml(id)}')">Delete</button>`:""}
<button class="btn" onclick="closeModal()">Cancel</button>
<button class="btn primary" onclick="saveEquipment('${escapeHtml(id||"")}')">Save</button>
</div>
`);
}

window.saveEquipment = function(id){
const equipment = (document.getElementById("eq_name")?.value||"").trim();
if(!equipment){ alert("Equipment name is required."); return; }
const unit = document.getElementById("eq_unit")?.value || "";
const location = (document.getElementById("eq_loc")?.value||"").trim();
const lastCleanDate = document.getElementById("eq_last")?.value || "";
const nextDueDate = document.getElementById("eq_due")?.value || "";
const cleanedBy = (document.getElementById("eq_by")?.value||"").trim();
const status = document.getElementById("eq_status")?.value || "OK";
const notes = (document.getElementById("eq_notes")?.value||"").trim();

withAudit("Save Equipment Cleaning", {unit,status}, ()=>Store.patch(s=>{
ensureIpData(s);
const me = getCurrentUser(s);
const arr = s.modules.ip.envControls.equipmentLog;
if(id){
const eq = arr.find(x=>x.id===id);
if(!eq) return;
Object.assign(eq,{equipment,unit,location,lastCleanDate,nextDueDate,cleanedBy,status,notes,updatedAt:nowISO(),updatedBy:me.name||""});
} else {
arr.push({id:uid("eq"),equipment,unit,location,lastCleanDate,nextDueDate,cleanedBy,status,notes,createdAt:nowISO(),updatedAt:nowISO(),createdBy:me.name||"",updatedBy:me.name||""});
}
}));
closeModal();
};

window.deleteEquipment = function(id){
if(!confirm("Delete this equipment log?")) return;
withAudit("Delete Equipment Log", {id}, ()=>Store.patch(s=>{
ensureIpData(s);
s.modules.ip.envControls.equipmentLog = (s.modules.ip.envControls.equipmentLog||[]).filter(x=>x.id!==id);
}));
closeModal();
};

function computeEnvStats(s, unitKey){
ensureIpData(s);
const sup = s.modules.ip.envControls.supplies || {};
const low = [];
const check = (k,label)=>{
const on = Number(sup?.[k]?.onHand||0);
const par = Number(sup?.[k]?.par||0);
if(par>0 && on < par){
low.push({key:k,label,on,par});
}
};
check("gloves","Gloves");
check("masks","Masks");
check("gowns","Gowns");
check("sanitizer","Hand Sanitizer");

let ce = (s.modules.ip.envControls.cleaningEvents||[]).slice();
if(unitKey && unitKey!=="ALL") ce = ce.filter(x=>(x.unit||"")===unitKey);
const activeCleaning = ce.filter(x=>(x.status||"Active")==="Active");

let eq = (s.modules.ip.envControls.equipmentLog||[]).slice();
if(unitKey && unitKey!=="ALL") eq = eq.filter(x=>(x.unit||"")===unitKey);
const today = dayISO(new Date());
const overdue = eq.filter(x=>{
if((x.status||"") === "Overdue") return true;
if(x.nextDueDate && x.nextDueDate < today) return true;
return false;
});

return {lowSupplies: low, activeCleaning, overdueEquip: overdue};
}
function openEnvDrilldown(kind, unitKey){
const s = Store.load();
ensureIpData(s);
const unit = unitKey || (document.getElementById("envUnit")?.value||s.ui.unitFilter||"ALL");
const unitPretty = unit==="ALL" ? "All Units" : unitNamePretty(s, unit);

if(kind==="cleanActive"){
let rows = (s.modules.ip.envControls.cleaningEvents||[]).filter(x=>(x.status||"Active")==="Active");
if(unit!=="ALL") rows = rows.filter(x=>(x.unit||"")===unit);
setDrilldownExport({
type:"clean_active",
title:`Enhanced Cleaning — Active (${unitPretty})`,
subtitle:"Active enhanced cleaning periods.",
columns:[{key:"startDate",label:"Start"},{key:"endDate",label:"End"},{key:"unit",label:"Unit"},{key:"area",label:"Area"},{key:"reason",label:"Reason"},{key:"status",label:"Status"},{key:"notes",label:"Notes"}],
rows: rows.map(x=>({startDate:x.startDate||"", endDate:x.endDate||"", unit:x.unit?unitNamePretty(s,x.unit):"", area:x.area||"", reason:x.reason||"", status:x.status||"", notes:x.notes||""}))
});
openModal(`Enhanced Cleaning — Active (${unitPretty})`, `
<div class="row end noprint" style="gap:8px">
<button class="smallbtn" onclick="printDrilldown()">Print</button>
<button class="smallbtn" onclick="exportDrilldownCSV()">Export CSV</button>
</div>
<div class="sep"></div>
${rows.length?`
<table><thead><tr><th style="width:110px">Start</th><th style="width:110px">End</th><th style="width:120px">Unit</th><th style="width:220px">Area</th><th style="width:160px">Reason</th><th style="width:110px">Status</th><th>Notes</th></tr></thead>
<tbody>${rows.map(x=>`<tr><td class="nowrap">${escapeHtml(x.startDate||"")}</td><td class="nowrap">${escapeHtml(x.endDate||"")}</td><td class="nowrap">${escapeHtml(x.unit?unitNamePretty(s,x.unit):"—")}</td><td>${escapeHtml(x.area||"")}</td><td>${escapeHtml(x.reason||"")}</td><td class="nowrap"><span class="badge">${escapeHtml(x.status||"")}</span></td><td class="muted">${escapeHtml(x.notes||"")}</td></tr>`).join("")}</tbody></table>
`:`<div class="muted">No active enhanced cleaning events.</div>`}
`);
return;
}

if(kind==="equipOverdue"){
const st = computeEnvStats(s, unit);
const rows = st.overdueEquip || [];
setDrilldownExport({
type:"equip_overdue",
title:`Equipment Cleaning — Overdue (${unitPretty})`,
subtitle:"Overdue items (status Overdue or next due date passed).",
columns:[{key:"equipment",label:"Equipment"},{key:"unit",label:"Unit"},{key:"location",label:"Location"},{key:"lastCleanDate",label:"Last Clean"},{key:"nextDueDate",label:"Next Due"},{key:"cleanedBy",label:"Cleaned By"},{key:"status",label:"Status"},{key:"notes",label:"Notes"}],
rows: rows.map(x=>({equipment:x.equipment||"", unit:x.unit?unitNamePretty(s,x.unit):"", location:x.location||"", lastCleanDate:x.lastCleanDate||"", nextDueDate:x.nextDueDate||"", cleanedBy:x.cleanedBy||"", status:x.status||"", notes:x.notes||""}))
});
openModal(`Equipment Cleaning — Overdue (${unitPretty})`, `
<div class="row end noprint" style="gap:8px">
<button class="smallbtn" onclick="printDrilldown()">Print</button>
<button class="smallbtn" onclick="exportDrilldownCSV()">Export CSV</button>
</div>
<div class="sep"></div>
${rows.length?`
<table><thead><tr><th style="width:160px">Equipment</th><th style="width:120px">Unit</th><th style="width:220px">Location</th><th style="width:110px">Last</th><th style="width:110px">Due</th><th style="width:140px">By</th><th style="width:110px">Status</th><th>Notes</th></tr></thead>
<tbody>${rows.map(x=>`<tr><td>${escapeHtml(x.equipment||"")}</td><td class="nowrap">${escapeHtml(x.unit?unitNamePretty(s,x.unit):"—")}</td><td>${escapeHtml(x.location||"")}</td><td class="nowrap">${escapeHtml(x.lastCleanDate||"")}</td><td class="nowrap">${escapeHtml(x.nextDueDate||"")}</td><td>${escapeHtml(x.cleanedBy||"")}</td><td class="nowrap"><span class="badge red">OVERDUE</span></td><td class="muted">${escapeHtml(x.notes||"")}</td></tr>`).join("")}</tbody></table>
`:`<div class="muted">No overdue equipment in this scope.</div>`}
`);
return;
}
}

function renderEnvironment(s){
ensureIpData(s);
const pane = document.getElementById("tab-env");
if(!pane) return;

const units = (s.config.units||[]);
const uSel = document.getElementById("envUnit");
const dFrom = document.getElementById("envFrom");
const dTo = document.getElementById("envTo");
const btnA = document.getElementById("btnEnvApply");
const btnC = document.getElementById("btnEnvClear");

if(uSel){
const cur = uSel.value || "ALL";
uSel.innerHTML = `<option value="ALL">All Units</option>` + units.map(u=>`<option value="${escapeHtml(u.unitKey)}">${escapeHtml(u.unitName||u.unitKey)}</option>`).join("");
uSel.value = (cur && (cur==="ALL" || units.some(u=>u.unitKey===cur))) ? cur : "ALL";
}

if(btnA && !btnA.dataset.bound){
btnA.dataset.bound="1";
btnA.addEventListener("click", ()=>renderAll());
}
if(btnC && !btnC.dataset.bound){
btnC.dataset.bound="1";
btnC.addEventListener("click", ()=>{
if(uSel) uSel.value="ALL";
if(dFrom) dFrom.value="";
if(dTo) dTo.value="";
safeRenderAll();
});
}

const unitKey = uSel ? (uSel.value||"ALL") : "ALL";
const from = dFrom?.value || "";
const to = dTo?.value || "";

const stats = computeEnvStats(s, unitKey);
const ppe = document.getElementById("ppeChips");
if(ppe){
const sup = s.modules.ip.envControls.supplies || {};
const chips = [
supplyChip("Gloves","gloves", sup.gloves),
supplyChip("Masks","masks", sup.masks),
supplyChip("Gowns","gowns", sup.gowns),
supplyChip("Sanitizer","sanitizer", sup.sanitizer)
];
ppe.innerHTML = chips.join("");
}
const cs = document.getElementById("cleanSummary");
if(cs){
cs.innerHTML = `<span class="badge ${stats.activeCleaning.length? "blue":""}">Active events: ${stats.activeCleaning.length}</span>`;
}
const es = document.getElementById("equipSummary");
if(es){
es.innerHTML = `<span class="badge ${stats.overdueEquip.length? "red":""}">Overdue: ${stats.overdueEquip.length}</span>`;
}

let ce = (s.modules.ip.envControls.cleaningEvents||[]).slice();
if(unitKey!=="ALL") ce = ce.filter(x=>(x.unit||"")===unitKey);
if(from) ce = ce.filter(x=>(x.startDate||"")>=from);
if(to) ce = ce.filter(x=>(x.startDate||"")<=to);
ce.sort((a,b)=> (b.startDate||"").localeCompare(a.startDate||""));

const ctb = document.getElementById("cleanTbody");
if(ctb){
ctb.innerHTML = ce.length ? ce.map(x=>`
<tr>
<td class="nowrap">${escapeHtml(x.startDate||"")}</td>
<td class="nowrap">${escapeHtml(x.endDate||"")}</td>
<td class="nowrap">${escapeHtml(x.unit?unitNamePretty(s,x.unit):"—")}</td>
<td>${escapeHtml(x.area||"")}</td>
<td>${escapeHtml(x.reason||"")}</td>
<td class="nowrap"><span class="badge ${x.status==="Active"?"blue":"green"}">${escapeHtml((x.status||"").toUpperCase())}</span></td>
<td class="muted">${escapeHtml(x.notes||"")}</td>
<td class="noprint edit-only nowrap">
<button class="smallbtn" onclick="openCleaningEventModal('${escapeHtml(x.id)}')">Edit</button>
</td>
</tr>
`).join("") : `<tr><td colspan="8" class="muted">No cleaning events in scope.</td></tr>`;
}

let eq = (s.modules.ip.envControls.equipmentLog||[]).slice();
if(unitKey!=="ALL") eq = eq.filter(x=>(x.unit||"")===unitKey);
if(from) eq = eq.filter(x=>(x.lastCleanDate||"")>=from);
if(to) eq = eq.filter(x=>(x.lastCleanDate||"")<=to);
eq.sort((a,b)=> (b.lastCleanDate||"").localeCompare(a.lastCleanDate||"") || (a.equipment||"").localeCompare(b.equipment||""));

const etb = document.getElementById("equipTbody");
if(etb){
const today = dayISO(new Date());
etb.innerHTML = eq.length ? eq.map(x=>{
const overdue = (x.status==="Overdue") || (!!x.nextDueDate && x.nextDueDate < today);
return `
<tr>
<td>${escapeHtml(x.equipment||"")}</td>
<td class="nowrap">${escapeHtml(x.unit?unitNamePretty(s,x.unit):"—")}</td>
<td>${escapeHtml(x.location||"")}</td>
<td class="nowrap">${escapeHtml(x.lastCleanDate||"")}</td>
<td class="nowrap">${escapeHtml(x.nextDueDate||"")}</td>
<td>${escapeHtml(x.cleanedBy||"")}</td>
<td class="nowrap">${overdue?`<span class="badge red">OVERDUE</span>`:`<span class="badge green">OK</span>`}</td>
<td class="muted">${escapeHtml(x.notes||"")}</td>
<td class="noprint edit-only nowrap">
<button class="smallbtn" onclick="openEquipmentModal('${escapeHtml(x.id)}')">Edit</button>
</td>
</tr>
`;
}).join("") : `<tr><td colspan="9" class="muted">No equipment logs in scope.</td></tr>`;
}

setDrilldownExport({
type:"env_export",
title:"Environmental & Equipment Controls",
subtitle:`${unitKey==="ALL"?"All Units":unitNamePretty(s,unitKey)}${from||to?` · ${from||"…"} to ${to||"…"}`
:""
}`,
columns:[
{key:"category",label:"Category"},
{key:"startDate",label:"Start/Last"},
{key:"endDate",label:"End/Due"},
{key:"unit",label:"Unit"},
{key:"item",label:"Item/Area"},
{key:"status",label:"Status"},
{key:"notes",label:"Notes"}
],
rows: [
...(ce.map(x=>({category:"Cleaning", startDate:x.startDate||"", endDate:x.endDate||"", unit:x.unit?unitNamePretty(s,x.unit):"", item:(x.area||""), status:x.status||"", notes:`${x.reason||""}${x.notes?(" — "+x.notes):""}`}))),
...(eq.map(x=>({category:"Equipment", startDate:x.lastCleanDate||"", endDate:x.nextDueDate||"", unit:x.unit?unitNamePretty(s,x.unit):"", item:`${x.equipment||""} (${x.location||""})`, status:x.status||"", notes:`Cleaned by ${x.cleanedBy||""}${x.notes?(" — "+x.notes):""}`})))
]
});

const b1 = document.getElementById("btnNewCleanEvent");
if(b1 && !b1.dataset.bound){ b1.dataset.bound="1"; b1.addEventListener("click", ()=>openCleaningEventModal(null)); }
const b2 = document.getElementById("btnNewEquipLog");
if(b2 && !b2.dataset.bound){ b2.dataset.bound="1"; b2.addEventListener("click", ()=>openEquipmentModal(null)); }
const b3 = document.getElementById("btnPpeUpdate");
if(b3 && !b3.dataset.bound){ b3.dataset.bound="1"; b3.addEventListener("click", openPpeModal); }
const b4 = document.getElementById("btnCleanActive");
if(b4 && !b4.dataset.bound){ b4.dataset.bound="1"; b4.addEventListener("click", ()=>openEnvDrilldown("cleanActive", unitKey)); }
const b5 = document.getElementById("btnEquipOverdue");
if(b5 && !b5.dataset.bound){ b5.dataset.bound="1"; b5.addEventListener("click", ()=>openEnvDrilldown("equipOverdue", unitKey)); }
const bp = document.getElementById("btnEnvPrint");
if(bp && !bp.dataset.bound){ bp.dataset.bound="1"; bp.addEventListener("click", ()=>printDrilldown()); }
const bx = document.getElementById("btnEnvCSV");
if(bx && !bx.dataset.bound){ bx.dataset.bound="1"; bx.addEventListener("click", ()=>exportDrilldownCSV()); }
}

function roomSortKey(room){
const s = String(room||"").trim();
const m = s.match(/^(\d+)\s*[- ]?\s*([A-Za-z]?)$/);
if(m) return [parseInt(m[1],10), (m[2]||"").toUpperCase()];
const n = parseInt(s,10);
if(!isNaN(n)) return [n,""];
return [999999, s.toUpperCase()];
}

function getUnitFromRoomGuess(s, room){
const num = parseInt(String(room||"").match(/\d+/)?.[0]||"",10);
if(!isNaN(num)){
const h = Math.floor(num/100);
const key = `U${h}`;
if((s.config.units||[]).some(u=>u.unitKey===key)) return key;
}
return "";
}

function getRoomsForUnit(s, unitKey){
ensureConfig(s);
const fm = s.config.floorMap || {};
let rooms = Array.isArray(fm[unitKey]) ? fm[unitKey].slice() : [];
if(!rooms.length){
const residents = Object.values(s.residentsById||{});
rooms = residents.filter(r=>(r.unit||"")===unitKey && (r.status||"Active")==="Active" && r.room)
.map(r=>r.room);
}
rooms = rooms.map(x=>String(x||"").trim()).filter(Boolean);
const seen = new Set();
rooms = rooms.filter(r=> (seen.has(r) ? false : (seen.add(r), true)));

rooms.sort((a,b)=>{
const ka = roomSortKey(a); const kb = roomSortKey(b);
if(ka[0]!==kb[0]) return ka[0]-kb[0];
return String(ka[1]).localeCompare(String(kb[1]));
});
return rooms;
}

function openFloorMapConfig(){
const s = Store.load();
ensureConfig(s);
const units = (s.config.units||[]);

const rows = units.map(u=>{
const cur = (s.config.floorMap?.[u.unitKey]||[]).join("\n");
return `
<div class="card" style="box-shadow:none">
<div style="font-weight:900">${escapeHtml(u.unitName||u.unitKey)}</div>
<div class="muted mini">Paste one room per line (e.g., 251-A). Leave blank to auto-derive from census.</div>
<textarea id="fm_cfg_${escapeHtml(u.unitKey)}" style="width:100%; height:120px; margin-top:8px">${escapeHtml(cur)}</textarea>
</div>
`;
}).join("");

openModal("Configure Floor Map Rooms", `
<div class="muted mini">This controls the room grid order. If a unit is blank, the map will auto-derive rooms from the current census.</div>
<div class="sep"></div>
<div class="grid cols2">${rows || `<div class="muted">No units configured yet. Configure units under Config.</div>`}</div>
<div class="sep"></div>
<div class="row end" style="gap:8px">
<button class="btn" onclick="closeModal()">Cancel</button>
<button class="btn primary" onclick="saveFloorMapConfig()">Save</button>
</div>
`);
}

window.saveFloorMapConfig = function(){
const s0 = Store.load();
ensureConfig(s0);
const units = (s0.config.units||[]);
withAudit("Save Floor Map Config", {}, ()=>Store.patch(s=>{
ensureConfig(s);
if(!s.config.floorMap) s.config.floorMap = {};
units.forEach(u=>{
const el = document.getElementById(`fm_cfg_${u.unitKey}`);
if(!el) return;
const lines = (el.value||"").split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
s.config.floorMap[u.unitKey] = lines;
});
}));
closeModal();
safeRenderAll();
};

function getPrecautionMarkerForResident(s, rid){
ensureIpData(s);
const prec = (s.modules.ip.precautions||[]).find(p=>p.residentId===rid && (p.status||"Active")==="Active");
if(!prec) return "";
const t = (prec.type||prec.precaution||"").toUpperCase();
if(t.includes("EBP")) return "EBP";
if(t.includes("DROPLET")) return "Droplet";
if(t.includes("AIR")) return "Airborne";
if(t.includes("CONTACT")) return "Contact";
return prec.type || prec.precaution || "Precaution";
}

function hasActiveAntibioticForMrn(s, mrn){
const arr = (s.modules.abt?.longLog||s.modules.abt?.records||[]);
const today = dayISO(new Date());
return (arr||[]).some(r=>{
if((r.mrn||"")!==mrn) return false;
const end = r.endDate || r.end || "";
return !end || end >= today;
});
}

function hasActiveCaseForMrn(s, mrn){
ensureIpData(s);
const cases = (s.modules.ip.lineListCases||[]);
return cases.some(c=> (c.mrn||"")===mrn && (c.status||"active")!=="resolved");
}

function openFloorRoomModal(unitKey, room){
const s = Store.load();
ensureConfig(s);
ensureIpData(s);

const residents = Object.values(s.residentsById||{});
const occ = residents.find(r=> (r.room||"")===room && (r.status||"Active")==="Active");
const dis = residents.filter(r=> (r.room||"")===room && (r.status||"")!=="Active").slice(0,3);

const badges = (r)=>{
if(!r) return "";
const parts = [];
const prec = getPrecautionMarkerForResident(s, r.id);
if(prec) parts.push(`<span class="badge blue">${escapeHtml(prec)}</span>`);
if(hasActiveCaseForMrn(s, r.mrn||"")) parts.push(`<span class="badge red">Case</span>`);
if(hasActiveAntibioticForMrn(s, r.mrn||"")) parts.push(`<span class="badge blue">ABT</span>`);
return parts.join("");
};

openModal(`Room ${escapeHtml(room)} — ${escapeHtml(unitNamePretty(s, unitKey)||unitKey)}`, `
${occ ? `
<div style="font-weight:900; font-size:16px">${escapeHtml(occ.name||"")}</div>
<div class="muted mini">MRN: <b>${escapeHtml(occ.mrn||"")}</b> · Unit: <b>${escapeHtml(unitNamePretty(s, unitKey)||unitKey)}</b></div>
<div class="fmBadges" style="margin-top:10px">${badges(occ) || `<span class="badge green">Occupied</span>`}</div>
<div class="sep"></div>
<div class="row end noprint" style="gap:8px">
<button class="btn" onclick="setTab('dashboard'); closeModal();">Go to Dashboard</button>
<button class="btn" onclick="setTab('ip'); closeModal();">Go to Cases</button>
</div>
` : `
<div class="muted">No active resident currently mapped to this room.</div>
`}
${dis.length ? `
<div class="sep"></div>
<div class="muted mini">Recent discharged history (locked room/unit):</div>
<ul class="mini">
${dis.map(r=>`<li>${escapeHtml(r.name||"")} — MRN ${escapeHtml(r.mrn||"")} (${escapeHtml(r.status||"")})</li>`).join("")}
</ul>
` : ``}
<div class="sep"></div>
<div class="row end">
<button class="btn" onclick="closeModal()">Close</button>
</div>
`);
}

function renderFloorMap(s){
const pane = document.getElementById("tab-floormap");
if(!pane) return;
ensureConfig(s);
ensureIpData(s);

const units = (s.config.units||[]);
const uSel = document.getElementById("fmUnit");
const cbEmpty = document.getElementById("fmShowEmpty");
const cbDis = document.getElementById("fmShowDischarged");
const grid = document.getElementById("fmGrid");
const legend = document.getElementById("fmLegend");

if(uSel){
const cur = uSel.value || (s.ui.unitFilter||"ALL");
uSel.innerHTML = `<option value="ALL">All Units</option>` + units.map(u=>`<option value="${escapeHtml(u.unitKey)}">${escapeHtml(u.unitName||u.unitKey)}</option>`).join("");
uSel.value = (cur && (cur==="ALL" || units.some(u=>u.unitKey===cur))) ? cur : "ALL";
if(!uSel.dataset.bound){
uSel.dataset.bound="1";
uSel.addEventListener("change", ()=>renderAll());
}
}

if(cbEmpty && !cbEmpty.dataset.bound){
cbEmpty.dataset.bound="1"; cbEmpty.addEventListener("change", ()=>renderAll());
}
if(cbDis && !cbDis.dataset.bound){
cbDis.dataset.bound="1"; cbDis.addEventListener("change", ()=>renderAll());
}

const unitKey = uSel ? (uSel.value||"ALL") : "ALL";
const showEmpty = cbEmpty ? cbEmpty.checked : true;
const showDis = cbDis ? cbDis.checked : false;

let rooms = [];
if(unitKey==="ALL"){
units.forEach(u=> rooms.push(...getRoomsForUnit(s, u.unitKey)));
} else {
rooms = getRoomsForUnit(s, unitKey);
}
const seen = new Set();
rooms = rooms.filter(r=> (seen.has(r) ? false : (seen.add(r), true)));

const residents = Object.values(s.residentsById||{});
const activeByRoom = {};
residents.filter(r=>(r.status||"Active")==="Active" && r.room).forEach(r=> activeByRoom[r.room] = r);

const cards = [];
for(const room of rooms){
const r = activeByRoom[room];
const u = (unitKey==="ALL") ? (r?.unit || getUnitFromRoomGuess(s, room) || "") : unitKey;
if(!r && !showEmpty) continue;

const hasDis = showDis && residents.some(x=> (x.room||"")===room && (x.status||"")!=="Active");
const isEmpty = !r;

let statusBadge = isEmpty ? `<span class="badge">Empty</span>` : `<span class="badge green">Occupied</span>`;
const bits = [];

if(!isEmpty){
const prec = getPrecautionMarkerForResident(s, r.id);
if(prec) bits.push(`<span class="badge blue">${escapeHtml(prec)}</span>`);
if(hasActiveCaseForMrn(s, r.mrn||"")) bits.push(`<span class="badge red">Case</span>`);
if(hasActiveAntibioticForMrn(s, r.mrn||"")) bits.push(`<span class="badge blue">ABT</span>`);
} else if(hasDis){
bits.push(`<span class="badge blue">History</span>`);
}

cards.push(`
<div class="fmcell" onclick="openFloorRoomModal('${escapeHtml(u||unitKey)}','${escapeHtml(room)}')">
<div class="fmTop">
<div class="fmRoom">${escapeHtml(room)}</div>
${statusBadge}
</div>
<div class="fmMini muted">${escapeHtml(u ? unitNamePretty(s,u)||u : "")}</div>
<div class="fmName">${escapeHtml(r?.name || (hasDis ? "Discharged history" : "—"))}</div>
<div class="fmBadges">${bits.join("")}</div>
</div>
`);
}

if(legend){
legend.innerHTML = `Legend: <span class="badge green">Occupied</span> <span class="badge">Empty</span> <span class="badge blue">Precaution/ABT</span> <span class="badge red">Case</span>`;
}
if(grid){
grid.innerHTML = cards.join("") || `<div class="muted">No rooms available. Configure units/rooms, or import census to auto-derive.</div>`;
}

const bCfg = document.getElementById("btnFmConfig");
if(bCfg && !bCfg.dataset.bound){
bCfg.dataset.bound="1"; bCfg.addEventListener("click", openFloorMapConfig);
}
const bPr = document.getElementById("btnFmPrint");
if(bPr && !bPr.dataset.bound){
bPr.dataset.bound="1"; bPr.addEventListener("click", ()=>{
const s2 = Store.load();
const title = `${s2.config.facilityName||"Facility"} — Floor Map`;
const body = document.getElementById("tab-floormap")?.innerHTML || "";
openPrintWindow(title, `<div class="printWrap">${body}</div>`, `
@page{ size: letter landscape; margin:0.35in; }
.noprint{ display:none !important; }
.card{ box-shadow:none !important; border:0 !important; }
.fmgrid{ grid-template-columns: repeat(5, 1fr); }
`);
});
}
}

function ensureBackupPrefs(s){
if(!s.ui) s.ui = {};
if(!s.ui.backupReminder) s.ui.backupReminder = { enabled:true, everyDays:7, mode:"OVERDUE" };
if(!s.ui.backupReminder.everyDays || s.ui.backupReminder.everyDays < 1) s.ui.backupReminder.everyDays = 7;
if(!s.ui.backupReminder.mode) s.ui.backupReminder.mode = "OVERDUE";
}

function daysSince(iso){
if(!iso) return null;
const t = new Date(iso).getTime();
if(!t) return null;
const now = Date.now();
return Math.floor((now - t) / (1000*60*60*24));
}

function openBackupReminderSettings(){
const s = Store.load();
ensureBackupPrefs(s);
const p = s.ui.backupReminder;

openModal("Backup Reminder Settings", `
<div class="muted mini">This tool runs offline, so reminders appear as an in-app banner (no system notifications).</div>
<div class="sep"></div>

<div class="grid cols3">
<div>
<label>Enable reminder</label>
<select id="br_en">
<option value="Y" ${p.enabled? "selected":""}>Yes</option>
<option value="N" ${!p.enabled? "selected":""}>No</option>
</select>
</div>
<div>
<label>Remind every (days)</label>
<input id="br_days" type="number" min="1" value="${escapeHtml(String(p.everyDays||7))}"/>
</div>
<div>
<label>Banner display</label>
<select id="br_mode">
<option value="OVERDUE" ${p.mode==="OVERDUE"?"selected":""}>Only when due/overdue</option>
<option value="ALWAYS" ${p.mode==="ALWAYS"?"selected":""}>Always show</option>
</select>
</div>
</div>

<div class="sep"></div>
<div class="row end" style="gap:8px">
<button class="btn" onclick="closeModal()">Cancel</button>
<button class="btn primary" onclick="saveBackupReminderSettings()">Save</button>
</div>
`);
}

window.saveBackupReminderSettings = function(){
const enabled = (document.getElementById("br_en")?.value||"Y")==="Y";
const everyDays = Math.max(1, Number(document.getElementById("br_days")?.value||7));
const mode = document.getElementById("br_mode")?.value || "OVERDUE";
withAudit("Update Backup Reminder Settings", {enabled, everyDays, mode}, ()=>Store.patch(s=>{
ensureBackupPrefs(s);
s.ui.backupReminder = { enabled, everyDays, mode };
}));
closeModal();
safeRenderAll();
};

function renderBackupRibbon(s){
const el = document.getElementById("backupRibbon");
if(!el) return;
ensureBackupPrefs(s);

const role = effectiveRole(s);
if(role==="Surveyor"){ el.style.display="none"; return; }

const p = s.ui.backupReminder;
if(!p.enabled){ el.style.display="none"; return; }

const last = s.ui.lastBackupAt || "";
const d = daysSince(last); // null if never
const due = p.everyDays || 7;

const overdue = (d===null) ? true : (d >= due);
const show = (p.mode==="ALWAYS") ? true : overdue;
if(!show){ el.style.display="none"; return; }

const dot = document.getElementById("brDot");
const txt = document.getElementById("brText");
if(dot){
dot.classList.remove("green","yellow","red");
if(d===null) dot.classList.add("red");
else if(d >= due) dot.classList.add("red");
else if(d >= Math.max(1, Math.floor(due*0.7))) dot.classList.add("yellow");
else dot.classList.add("green");
}

const lastHuman = last ? new Date(last).toLocaleString() : "Never";
const msg = (d===null)
? `Backup reminder: No backup recorded yet. Recommended every ${due} day(s).`
: `Backup reminder: Last backup ${lastHuman} (${d} day(s) ago). Recommended every ${due} day(s).`;

if(txt) txt.textContent = msg;

el.style.display = "";

const bNow = document.getElementById("btnBackupNow");
const bCfg = document.getElementById("btnBackupCfg");

if(bNow && !bNow.dataset.bound){
bNow.dataset.bound="1";
bNow.addEventListener("click", ()=>{
const st = Store.load();
if(!canAdmin(st)){
alert("Backup is Admin-only. Please ask an Admin user to export an encrypted backup.");
return;
}
withAudit("Backup Now (Ribbon)", {}, ()=>doExportEncrypted());
});
}
if(bCfg && !bCfg.dataset.bound){
bCfg.dataset.bound="1";
bCfg.addEventListener("click", ()=>{
const st = Store.load();
if(!canAdmin(st)){
alert("Settings are Admin-only.");
return;
}
openBackupReminderSettings();
});
}
}

function renderAll(){
  const s = Store.load();
  if(!s.ui) s.ui = {};
  if(!s.ui.__normalizedOnce){ try{ normalizeImportedState(s); }catch(e){} s.ui.__normalizedOnce = true; Store.save(s); }

  // Always-on lightweight UI (safe for iPhone)
  try{ initMoreMenu(); }catch(e){}
  try{ renderBackupRibbon(s); }catch(e){}
  safeCall("header", ()=>renderHeader(s));

  // Only render the active tab to avoid mobile crashes from huge DOM builds.
  const tab = (window.__activeTab || "dashboard");

  // Dashboard-only widgets
  if(tab==="dashboard"){
    safeCall("dash-controls", ()=>{ if(typeof renderDashboardControls==="function") renderDashboardControls(s); });
    safeCall("dash-view", ()=>{ if(typeof applyDashView==="function") applyDashView(s); });
    safeCall("dashboard-kpis", ()=>renderDashboardKPIs(s));
    safeCall("quick-counts", ()=>renderQuickDrillCounts(s));
    try{ renderSituationBoard(s); try{ renderSurveillance(s); }catch(e){ console.error('[Render:Surveillance]', e); } }catch(e){ console.error('[Render:SituationBoard]', e); }
    safeCall("unit-occupancy", ()=>renderUnitOccupancyCards(s));
    safeCall("resident-snapshot", ()=>renderResidentSnapshot(s));
    safeCall("dash-compliance", ()=>{ try{ renderComplianceDashboard(s); }catch(e){} });
    safeCall("profile-panel", ()=>{ if(typeof renderProfilePanel==="function") renderProfilePanel(s); });
  }

  // Core modules
  if(tab==="census"){
    safeCall("census-preview", ()=>{ if(typeof renderCensusPreview==="function") renderCensusPreview(s); });
  }
  if(tab==="abt"){
    safeCall("abt", ()=>{ if(typeof renderAbtTables==="function") renderAbtTables(s); });
  }
  if(tab==="vax"){
    safeCall("vax", ()=>{ if(typeof renderVax==="function") renderVax(s); });
  }
  if(tab==="ip" || tab==="cases"){
    safeCall("ip", ()=>{ if(typeof renderIp==="function") renderIp(s); });
  }

  // Secondary modules
  if(tab==="comms"){
    try{ renderComms(s); }catch(e){ console.error('[Render:Comms]', e); }
  }
  if(tab==="decisions"){
    try{ renderDecisions(s); }catch(e){ console.error('[Render:Decisions]', e); }
  }
  if(tab==="reports"){
    try{ renderReports(s); }catch(e){ console.error('[Render:Reports]', e); }
  }
  if(tab==="audits"){
    try{ renderAudits(s); }catch(e){ console.error('[Render:Audits]', e); }
  }
  if(tab==="staff"){
    try{ renderStaffing(s); }catch(e){ console.error('[Render:Staff]', e); }
  }
  if(tab==="env"){
    try{ renderEnvironment(s); }catch(e){ console.error('[Render:Env]', e); }
  }
  if(tab==="floormap"){
    try{ renderFloorMap(s); }catch(e){ console.error('[Render:FloorMap]', e); }
  }
  if(tab==="surveillance"){
    try{ renderSurveillance(s); }catch(e){ console.error('[Render:Surveillance]', e); }
  }

  // Admin tabs
  if(tab==="warehouse"){
    safeCall("warehouse", ()=>{ if(typeof renderWarehouse==="function") renderWarehouse(s); });
    try{ renderAuditLog(s); }catch(e){}
  }
  if(tab==="config"){
    safeCall("config", ()=>{ if(typeof renderConfig==="function") renderConfig(s); });
    safeCall("users-config", ()=>{ if(typeof renderUsersConfig==="function") renderUsersConfig(s); });
    try{ bindAdminControls(); }catch(e){}
    try{ renderAuditLog(s); }catch(e){}
  }

  // QAPI Actions and Survey Packet
  if(tab==="actions"){
    try{ if(typeof qapiRenderActions==='function') qapiRenderActions(); }catch(e){}
  }
  if(tab==="packet"){
    try{ if(typeof renderSurveyPacket==='function') renderSurveyPacket(s); }catch(e){}
  }

  try{ tryOpenPendingDrilldown(s); }catch(e){}
}

function renderCensusPreview(){
const box = document.getElementById("censusPreview");
const entries = window.__lastParsedCensus;
if(!entries){ box.innerHTML = `<div class="muted">No parsed data yet.</div>`; return; }

box.innerHTML = `
<div class="row" style="justify-content:space-between; align-items:flex-end">
<div class="muted mini">Parsed rows: <b>${entries.length}</b> (editable before Apply)</div>
<div class="row" style="gap:8px">
<button class="smallbtn" id="btnCensusAutoUnit">Auto-fix Unit from Room</button>
<button class="smallbtn" id="btnCensusTrim">Trim / Normalize</button>
</div>
</div>
<div class="sep"></div>
<table>
<thead><tr><th>Room</th><th>Name</th><th>MRN</th><th>Unit</th><th class="nowrap">DOB</th><th>Payor</th></tr></thead>
<tbody>
${entries.slice(0,450).map((e,i)=>`
<tr>
<td class="nowrap">
<input type="text" value="${escapeHtml(e.room||"")}" oninput="updateParsedEntry(${i},'room',this.value)"/>
</td>
<td>
<input type="text" value="${escapeHtml(e.name||"")}" oninput="updateParsedEntry(${i},'name',this.value)"/>
</td>
<td class="nowrap">
<input type="text" value="${escapeHtml(e.mrn||"")}" oninput="updateParsedEntry(${i},'mrn',this.value)"/>
</td>
<td class="nowrap">
<input type="text" value="${escapeHtml(e.unit||"")}" oninput="updateParsedEntry(${i},'unit',this.value)"/>
</td>
<td class="nowrap">
<input type="text" value="${escapeHtml(e.dob||"")}" oninput="updateParsedEntry(${i},'dob',this.value)"/>
</td>
<td>
<input type="text" value="${escapeHtml(e.payorSource||"")}" oninput="updateParsedEntry(${i},'payorSource',this.value)"/>
</td>
</tr>
`).join("")}
</tbody>
</table>
${entries.length>450? `<div class="muted mini" style="margin-top:8px">Showing first 450 rows in preview (still applies all rows).</div>`:""}
`;

const b1 = document.getElementById("btnCensusAutoUnit");
if(b1 && !b1.dataset.bound){
b1.dataset.bound="1";
b1.onclick = ()=>{
const s = Store.load();
(window.__lastParsedCensus||[]).forEach((e,idx)=>{
const u = inferUnitFromRoom(e.room||"", s.config) || "";
if(u) e.unit = u;
});
renderCensusPreview();
};
}
const b2 = document.getElementById("btnCensusTrim");
if(b2 && !b2.dataset.bound){
b2.dataset.bound="1";
b2.onclick = ()=>{
(window.__lastParsedCensus||[]).forEach((e,idx)=>{
e.room = normalizeRoomForEdit(e.room);
e.name = (e.name||"").toString().trim().replace(/\s+/g," ");
e.mrn = (e.mrn||"").toString().trim();
e.unit = (e.unit||"").toString().trim();
e.dob = (e.dob||"").toString().trim();
e.payorSource = (e.payorSource||"").toString().trim().replace(/\s+/g," ");
});
renderCensusPreview();
};
}
}

function applyVaxFiltersFromUI(){
const rangeEl = document.getElementById("vaxRange");
const statusEl = document.getElementById("vaxStatus");
const typeEl = document.getElementById("vaxType");
const startEl = document.getElementById("vaxStart");
const endEl = document.getElementById("vaxEnd");
if(!rangeEl || !statusEl || !typeEl || !startEl || !endEl) return;

const range = rangeEl.value;
const status = statusEl.value;
const type = typeEl.value;
const startISO = startEl.value;
const endISO = endEl.value;

Store.patch(s=>{
if(!s.modules.vax.ui) s.modules.vax.ui = {};
s.modules.vax.ui.range = range;
s.modules.vax.ui.status = status;
s.modules.vax.ui.type = type;
s.modules.vax.ui.startISO = startISO;
s.modules.vax.ui.endISO = endISO;
});
}

function vaxEventKey(v){
return [
(v.residentId||"").toString(),
(v.vaccineType||"").toString().trim().toUpperCase(),
(v.date||"").toString().trim(),
(v.status||"").toString().trim().toUpperCase()
].join("|");
}
function vaxHasDuplicate(s, v){
const key = vaxEventKey(v);
return (s.modules.vax.events||[]).some(x=> vaxEventKey(x)===key && (x.id!==v.id));
}
function openVaxEditModal(id){
const s = Store.load();
const v = (s.modules.vax.events||[]).find(x=>x.id===id);
if(!v){ alert("Vax event not found."); return; }

openModal("Edit Vaccine Event", `
<div class="muted mini">Edit or delete this vaccination record.</div>
<div class="sep"></div>

<div class="grid cols2">
<div><label>Date</label><input id="vx_date" type="date" value="${escapeHtml(mdyToISO(v.date)||"")}"/></div>
<div><label>Status</label>
<select id="vx_status">
${["vaccinated","declined","pending","contraindicated","unknown"].map(x=>`<option value="${x}" ${(String(v.status||"").toLowerCase()===x)?"selected":""}>${x}</option>`).join("")}
</select>
</div>
</div>

<div class="grid cols2" style="margin-top:10px">
<div><label>Vaccine Type</label><input id="vx_type" type="text" value="${escapeHtml(v.vaccineType||"")}"/></div>
<div><label>Notes</label><input id="vx_notes" type="text" value="${escapeHtml(v.notes||"")}"/></div>
</div>

<div class="sep"></div>
<div class="row end" style="gap:8px">
<button class="btn danger" onclick="deleteVaxEvent('${escapeHtml(id)}')">Delete</button>
<button class="btn" onclick="closeModal()">Cancel</button>
<button class="btn primary" onclick="saveVaxEdit('${escapeHtml(id)}')">Save</button>
</div>
`);
}
window.saveVaxEdit = function(id){
const s0 = Store.load();
const v0 = (s0.modules.vax.events||[]).find(x=>x.id===id);
if(!v0){ alert("Vax event not found."); return; }

const dateISO = document.getElementById("vx_date")?.value || "";
const status = document.getElementById("vx_status")?.value || "";
const vaccineType = (document.getElementById("vx_type")?.value||"").trim();
const notes = (document.getElementById("vx_notes")?.value||"").trim();

if(!dateISO){ alert("Date is required."); return; }
if(!vaccineType){ alert("Vaccine Type is required."); return; }

const candidate = {
id,
residentId: v0.residentId||"",
vaccineType,
date: isoToMDY(dateISO),
status
};

const sCheck = Store.load();
if(vaxHasDuplicate(sCheck, candidate)){
if(!confirm("This looks like a duplicate (same resident + type + date + status). Save anyway?")) return;
}

withAudit("Edit Vax Event", {id}, ()=>Store.patch(s=>{
const v = (s.modules.vax.events||[]).find(x=>x.id===id);
if(!v) return;
v.date = isoToMDY(dateISO);
v.status = status;
v.vaccineType = vaccineType;
v.notes = notes;
v.updatedAt = nowISO();
}));
closeModal();
safeRenderAll();
};

window.deleteVaxEvent = function(id){
if(!confirm("Delete this vaccination record?")) return;
withAudit("Delete Vax Event", {id}, ()=>Store.patch(s=>{
s.modules.vax.events = (s.modules.vax.events||[]).filter(x=>x.id!==id);
}));
closeModal();
safeRenderAll();
};


function openAddPrecautionModal(residentId){
  const s = Store.load(); ensureIpData(s);
  const residents = getActiveResidents(s);
  openModal("Add Precaution / Isolation", `
    <div class="grid cols2">
      <div>
        <label>Resident (active census)</label>
        <select id="prec_res_select"></select>
        <input id="prec_residentId" type="hidden" value="${escapeHtml(residentId||"")}"/>
      </div>
      <div>
        <label>Precaution Type</label>
        <select id="prec_type">
          <option value="Contact">Contact</option>
          <option value="Droplet">Droplet</option>
          <option value="Airborne">Airborne</option>
          <option value="Enhanced Barrier">Enhanced Barrier</option>
          <option value="Enteric">Enteric</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div>
        <label>Start Date</label>
        <input id="prec_start" type="date" value="${dayISO(new Date())}"/>
      </div>
      <div>
        <label>Status</label>
        <select id="prec_status">
          <option value="active" selected>Active</option>
          <option value="discontinued">Discontinued</option>
        </select>
      </div>
      <div>
        <label>End Date (if discontinued)</label>
        <input id="prec_end" type="date" />
      </div>
      <div>
        <label>Source Condition / Reason (Source of infection)</label>
        <input id="prec_source" placeholder="e.g., UTI, C. diff, RSV, PICC line, wound, scabies..."/>
      </div>
      <div>
        <label>Pathogen / Resistance (free text)</label>
        <input id="prec_pathogen" placeholder="e.g., MRSA, VRE, CRE, ESBL..."/>
      </div>
      <div>
        <label>NHSN Pathogen Code (optional)</label>
        <input id="prec_nhsn" placeholder="Optional code"/>
      </div>
      <div>
        <label>Notes</label>
        <input id="prec_notes" placeholder="Optional notes..."/>
      </div>
    </div>
    <div class="sep"></div>
    <div class="row end">
      <button class="btn" onclick="closeModal()">Cancel</button>
      <button class="btn primary" onclick="savePrecautionFromModal()">Save</button>
    </div>
  `);
  const sel = document.getElementById("prec_res_select");
  if(sel){
    sel.innerHTML = residentOptionsHtml(residents, residentId||"");
    sel.value = residentId||"";
  }
  bindResidentPicker("prec_res_select", { residentIdHidden:"prec_residentId", name:null, mrn:null, unit:null, room:null });
}
window.savePrecautionFromModal = function(){
  const s = Store.load(); ensureIpData(s);
  const rid = (document.getElementById("prec_res_select")?.value||"").trim();
  if(!rid){ toastSafe("Select a resident from census."); return; }
  const r = s.residentsById?.[rid];
  const type = (document.getElementById("prec_type")?.value||"").trim();
  const startDate = document.getElementById("prec_start")?.value || "";
  const status = (document.getElementById("prec_status")?.value||"active").trim();
  const endDate = document.getElementById("prec_end")?.value || "";
  const infectedSource = (document.getElementById("prec_source")?.value||"").trim();
  const pathogenResistance = (document.getElementById("prec_pathogen")?.value||"").trim();
  const nhsnPathogenCode = (document.getElementById("prec_nhsn")?.value||"").trim();
  const notes = (document.getElementById("prec_notes")?.value||"").trim();
  const rec = {
    id: "PREC-" + Date.now().toString(16) + "-" + Math.random().toString(16).slice(2),
    residentId: rid,
    residentName: r?.name || "",
    mrn: r?.mrn || "",
    unit: r?.unit || "",
    room: (r?.room||"").toUpperCase(),
    precaution: type,
    type: type,
    infectedSource: infectedSource || notes || "",
    sourceCondition: infectedSource || "",
    pathogenResistance,
    nhsnPathogenCode,
    startDate,
    endDate: (status==="discontinued" ? (endDate||dayISO(new Date())) : ""),
    status: status==="discontinued" ? "inactive" : "active",
    notes
  };
  Store.patch(st=>{
    ensureIpData(st);
    st.modules.ip.precautions = st.modules.ip.precautions || [];
    st.modules.ip.precautions.push(rec);
  });
  auditTrail("precaution_added", { type, unit: rec.unit, room: rec.room });
  toastSafe("Precaution saved.");
  closeModal();
  try{ safeRenderAll(); }catch(e){};

};



// --- Edit Precaution / Isolation (template-aligned fields) ---
window.openEditPrecautionModal = function(precId){
  const s = Store.load(); ensureIpData(s);
  const p = (s.modules.ip.precautions||[]).find(x=>String(x.id||"")===String(precId||""));
  if(!p){ toastSafe("Precaution not found."); return; }

  const statusUi = (String(p.status||"active").toLowerCase()==="active") ? "active" : "discontinued";
  const endISO = mdyToISO(p.endDate||"") || (p.endDate||"").slice(0,10) || "";
  const startISO = (p.startDate||"").slice(0,10) || (mdyToISO(p.startDate||"")||"") || "";

  openModal("Edit Precaution / Isolation", `
    <div class="grid cols2">
      <div>
        <label>Resident</label>
        <input value="${escapeHtml(p.residentName||"")}" disabled />
        <div class="muted mini">MRN: <b>${escapeHtml(p.mrn||"")}</b> • Room: <b>${escapeHtml(p.room||"")}</b> • Unit: <b>${escapeHtml(p.unit||"")}</b></div>
      </div>
      <div>
        <label>Precaution Type</label>
        <select id="precE_type">
          ${["Contact","Droplet","Airborne","Enhanced Barrier","Enteric","Other"].map(v=>`<option value="${v}" ${(String(p.type||p.precaution||"")===v)?"selected":""}>${v}</option>`).join("")}
        </select>
      </div>
      <div>
        <label>Start Date</label>
        <input id="precE_start" type="date" value="${escapeHtml(startISO)}" />
      </div>
      <div>
        <label>Status</label>
        <select id="precE_status">
          <option value="active" ${statusUi==="active"?"selected":""}>Active</option>
          <option value="discontinued" ${statusUi==="discontinued"?"selected":""}>Discontinued</option>
        </select>
      </div>
      <div>
        <label>End Date (if discontinued)</label>
        <input id="precE_end" type="date" value="${escapeHtml(endISO)}" />
      </div>
      <div>
        <label>Source Condition / Reason (Source of infection)</label>
        <input id="precE_source" value="${escapeHtml(p.infectedSource||p.sourceCondition||p.infectionSource||"")}" />
      </div>
      <div>
        <label>Pathogen / Resistance (free text)</label>
        <input id="precE_pathogen" value="${escapeHtml(p.pathogenResistance||"")}" />
      </div>
      <div>
        <label>NHSN Pathogen Code (optional)</label>
        <input id="precE_nhsn" value="${escapeHtml(p.nhsnPathogenCode||"")}" />
      </div>
      <div>
        <label>Notes</label>
        <input id="precE_notes" value="${escapeHtml(p.notes||"")}" />
      </div>
    </div>
    <div class="sep"></div>
    <div class="row between" style="gap:8px; flex-wrap:wrap">
      <button class="btn danger" onclick="deletePrecautionById('${escapeHtml(p.id)}')">Delete</button>
      <div class="row end" style="gap:8px">
        <button class="btn" onclick="closeModal()">Cancel</button>
        <button class="btn primary" onclick="savePrecautionEditFromModal('${escapeHtml(p.id)}')">Save</button>
      </div>
    </div>
  `);
};

window.savePrecautionEditFromModal = function(precId){
  const type = (document.getElementById("precE_type")?.value||"").trim();
  const startDate = document.getElementById("precE_start")?.value || "";
  const statusUi = (document.getElementById("precE_status")?.value||"active").trim();
  const endDate = document.getElementById("precE_end")?.value || "";
  const infectedSource = (document.getElementById("precE_source")?.value||"").trim();
  const pathogenResistance = (document.getElementById("precE_pathogen")?.value||"").trim();
  const nhsnPathogenCode = (document.getElementById("precE_nhsn")?.value||"").trim();
  const notes = (document.getElementById("precE_notes")?.value||"").trim();

  if(!startDate){ toastSafe("Start date is required."); return; }
  if(!type){ toastSafe("Precaution type is required."); return; }

  Store.patch(s=>{
    ensureIpData(s);
    const p = (s.modules.ip.precautions||[]).find(x=>String(x.id||"")===String(precId||""));
    if(!p) return;
    p.type = type;
    p.precaution = type;
    p.startDate = startDate;
    p.status = (statusUi==="discontinued") ? "resolved" : "active";
    p.endDate = (statusUi==="discontinued") ? (endDate || dayISO(new Date())) : "";
    p.infectedSource = infectedSource || notes || p.infectedSource || "";
    p.sourceCondition = infectedSource || p.sourceCondition || "";
    p.pathogenResistance = pathogenResistance;
    p.nhsnPathogenCode = nhsnPathogenCode;
    p.notes = notes;
    p.updatedAt = nowISO();
  });

  auditTrail("precaution_edited", { id: precId, type });
  toastSafe("Precaution updated.");
  closeModal();
  try{ safeRenderAll(); }catch(e){}
};

window.deletePrecautionById = function(precId){
  if(!confirm("Delete this precaution entry?")) return;
  Store.patch(s=>{
    ensureIpData(s);
    s.modules.ip.precautions = (s.modules.ip.precautions||[]).filter(x=>String(x.id||"")!==String(precId||""));
  });
  auditTrail("precaution_deleted", { id: precId });
  toastSafe("Precaution deleted.");
  closeModal();
  try{ safeRenderAll(); }catch(e){}
};

function openAddVaxModalForResident(residentId){
  openAddVaxModal();
  setTimeout(()=>{ try{ const sel=document.getElementById('addVaxResident'); if(sel){ sel.value = residentId||''; } }catch(e){} }, 0);
}

function openAddVaxModal(){
const s = Store.load();
const residents = getFilteredResidents(s);
openModal("Add Vaccine Event", `
<div class="muted mini">Adds a new vaccination event to the log.</div>
<div class="sep"></div>
<div class="grid cols2">
<div>
<label>Resident</label>
<select id="addVaxResident">
<option value="">—</option>
${residents.map(r=>`<option value="${escapeHtml(r.id)}">${escapeHtml(r.name||"")} (${escapeHtml(r.mrn||"")})</option>`).join("")}
</select>
</div>
<div>
<label>Vaccine Type</label>
<input id="addVaxType" type="text" placeholder="COVID-19 / Influenza / Pneumo / RSV / Other"/>
</div>
</div>
<div class="grid cols3" style="margin-top:10px">
<div>
<label>Status</label>
<select id="addVaxStatus">
<option value="vaccinated">vaccinated</option>
<option value="declined">declined</option>
<option value="pending">pending</option>
</select>
</div>
<div>
<label>Date</label>
<input id="addVaxDate" type="date" value="${todayISO()}"/>
</div>
<div>
<label>&nbsp;</label>
<button class="btn primary" onclick="saveAddVax()">Save</button>
</div>
</div>
<div style="margin-top:10px">
<label>Notes</label>
<input id="addVaxNotes" type="text" placeholder="Optional notes..."/>
</div>
`);
}
window.saveAddVax = function(){
const rid = document.getElementById("addVaxResident").value;
if(!rid){ alert("Select a resident."); return; }
const type = (document.getElementById("addVaxType").value||"Other").trim() || "Other";
const status = document.getElementById("addVaxStatus").value;
const dateISO = document.getElementById("addVaxDate").value;
const notes = (document.getElementById("addVaxNotes").value||"").trim();

const cand = { id:"", residentId: rid, vaccineType: type, date: isoToMDY(dateISO), status };
const sDup = Store.load();
if(vaxHasDuplicate(sDup, cand)){
if(!confirm("This looks like a duplicate vaccine event (same resident + type + date + status). Add anyway?")) return;
}

Store.patch(s=>{
const r = s.residentsById[rid];
if(!r) return;
const unit = r.unit || r.lockedUnit || "";
const room = String((r.room || r.roomNumber || r.room_no || r.rm || r.lockedRoom || "")||"").toUpperCase();
s.modules.vax.events.push({
id: uid("vax"),
batchId: "MANUAL",
residentId: rid,
mrn: r.mrn || "",
residentName: r.name || "",
room,
unit,
dob: r.dob || "",
status,
vaccineType: type,
date: isoToMDY(dateISO),
notes,
createdAt: nowISO(),
updatedAt: nowISO()
});
});
closeModal();
setTab("vax");
};

document.querySelectorAll(".tabbtn[data-tab]").forEach(b=> b.addEventListener("click", ()=> setTab(b.dataset.tab)));
document.getElementById("toggleIncludeDischarged")?.addEventListener("change", e=> Store.patch(s=>{ s.ui.includeDischarged = !!e.target.checked; }));
document.getElementById("residentSelect")?.addEventListener("change", e=> Store.patch(s=>{ s.ui.selectedResidentId = e.target.value; }));
document.getElementById("btnOpenProfile")?.addEventListener("click", ()=>{ const s=Store.load(); const id=s.ui.selectedResidentId; if(!id) return; openResidentProfileModal(id); });
document.getElementById("goAbt")?.addEventListener("click", ()=> setTab("abt"));
document.getElementById("goIp")?.addEventListener("click", ()=> setTab("ip"));
document.getElementById("goVaxWeek")?.addEventListener("click", ()=>{ vaxSetSubtab("weekly"); setTab("vax"); });

document.getElementById("btnParseCensus")?.addEventListener("click", ()=>{
const raw=document.getElementById("censusRaw").value||"";
window.__lastParsedCensus = parseCensusRaw(raw);
document.getElementById("btnApplyCensus").disabled = !window.__lastParsedCensus.length;
renderCensusPreview();
});
document.getElementById("btnApplyCensus")?.addEventListener("click", ()=>{
const raw=document.getElementById("censusRaw").value||"";
const entries = window.__lastParsedCensus || parseCensusRaw(raw);
applyCensus(entries, raw);
window.__lastParsedCensus=null;
document.getElementById("btnApplyCensus").disabled=true;
document.getElementById("censusRaw").value="";
});

document.getElementById("btnBackup")?.addEventListener("click", ()=>{
const s = Store.load();
downloadText(`Infection Control_NewBuild_Backup_${new Date().toISOString().slice(0,10)}.json`, JSON.stringify(s, null, 2));
});
document.getElementById("btnRestore")?.addEventListener("click", ()=>{
openModal("Import Backup JSON", `
<div class="muted mini">Paste backup JSON below (or choose a .json file). Legacy wrapper exports are auto-mapped.</div>
<div class="sep"></div>
<label class="mini muted">Choose file (.json)</label>
<input id="restoreFile" type="file" accept=".json,application/json,text/plain"/>
<div class="sep"></div>
<textarea id="restoreBox" style="min-height:220px" placeholder='{"schema":1,...}'></textarea>
<div class="row end">
<button class="btn" onclick="closeModal()">Cancel</button>
<button class="btn primary" onclick="doRestore()">Import</button>
</div>
`);
setTimeout(()=>{
  try{
    const inp = document.getElementById('restoreFile');
    if(inp && !inp.dataset.bound){
      inp.dataset.bound='1';
      inp.addEventListener('change', async ()=>{
        const f = inp.files && inp.files[0];
        if(!f) return;
        const txt = await f.text();
        const box = document.getElementById('restoreBox');
        if(box) box.value = txt;
      });
    }
  }catch(e){}
}, 0);
});
window.doRestore = function(){
  const raw = document.getElementById("restoreBox")?.value || "";
  const data = safeJsonParse(raw, null);
  if(!data){ alert("Invalid JSON."); return; }

  // Auto-detect legacy wrapper exports and map them into this build.
  try{
    if(isLegacyLikeImport(data)){
      closeModal();
      mapLegacyToNew(data, "merge");
      try{ toastSafe("Legacy JSON mapped and imported."); }catch(_){ }
      safeRenderAll();
      return;
    }
  }catch(e){
    console.warn("Smart restore legacy detect/map failed; falling back to raw restore.", e);
  }

  storageSet(STORE_KEY, JSON.stringify(data));
  closeModal();
  safeRenderAll();
};

document.getElementById("btnReset")?.addEventListener("click", ()=>{
if(!confirm("Reset local data for this tool? This cannot be undone.")) return;
storageRemove(STORE_KEY);
safeRenderAll();
});

document.getElementById("btnLegacy")?.addEventListener("click", ()=>{
openModal("Import Legacy JSON (Unified Infection Control Suite) → Map into this Build", `
<div class="muted mini">Choose file or paste JSON. Merge recommended.</div>
<div class="sep"></div>
<div class="grid cols2">
<div>
<label>Choose file (.json)</label>
<input id="legacyFile" type="file" accept=".json,application/json,text/plain"/>
</div>
<div>
<label>Import Mode</label>
<select id="legacyMode">
<option value="merge">Merge (recommended)</option>
<option value="replace">Replace (keep current Config)</option>
</select>
</div>
</div>
<div class="sep"></div>
<label>Or paste JSON</label>
<textarea id="legacyPaste" style="min-height:220px" placeholder='Paste the legacy JSON here...'></textarea>
<div class="row end">
<button class="btn" onclick="closeModal()">Cancel</button>
<button class="btn primary" onclick="runLegacyImport()">Import & Map</button>
</div>
<div class="sep"></div>
<div class="muted mini" id="legacyStatus">Ready.</div>
`);
const inp = document.getElementById("legacyFile");
inp.addEventListener("change", async ()=>{
const f = inp.files && inp.files[0];
if(!f) return;
const txt = await f.text();
document.getElementById("legacyPaste").value = txt;
document.getElementById("legacyStatus").textContent = `Loaded file: ${f.name} (${Math.round(f.size/1024)} KB)`;
});
});
window.runLegacyImport = function(){
const txt = document.getElementById("legacyPaste").value || "";
const legacy = safeJsonParse(txt, null);
if(!legacy){ alert("Invalid JSON."); return; }
const mode = document.getElementById("legacyMode").value || "merge";
mapLegacyToNew(legacy, mode);
closeModal();
setTab("dashboard");
};

const __btnVaxApply = document.getElementById("btnVaxApply"); if(__btnVaxApply) __btnVaxApply.addEventListener("click", applyVaxFiltersFromUI);
const __btnVaxAdd = document.getElementById("btnVaxAdd"); if(__btnVaxAdd) __btnVaxAdd.addEventListener("click", openAddVaxModal);
const __vaxRange = document.getElementById("vaxRange"); if(__vaxRange) __vaxRange.addEventListener("change", ()=>applyVaxFiltersFromUI());
const __vaxStatus = document.getElementById("vaxStatus"); if(__vaxStatus) __vaxStatus.addEventListener("change", ()=>applyVaxFiltersFromUI());
const __vaxType = document.getElementById("vaxType"); if(__vaxType) __vaxType.addEventListener("change", ()=>applyVaxFiltersFromUI());

document.getElementById("modalClose")?.addEventListener("click", closeModal);
document.getElementById("modalBack")?.addEventListener("click", (e)=>{ if(e.target.id==="modalBack") closeModal(); });

document.getElementById("whResidentsBtn")?.addEventListener("click", ()=>{ window.__whMode="residents"; safeRenderAll(); });
document.getElementById("whAbtBtn")?.addEventListener("click", ()=>{ window.__whMode="abt"; safeRenderAll(); });
document.getElementById("whPrecBtn")?.addEventListener("click", ()=>{ window.__whMode="prec"; safeRenderAll(); });
document.getElementById("whVaxBtn")?.addEventListener("click", ()=>{ window.__whMode="vax"; safeRenderAll(); });

document.getElementById("btnSaveConfig")?.addEventListener("click", ()=>{
const name = document.getElementById("cfgFacilityName").value || "";
const total = Number(document.getElementById("cfgTotalCap").value || 0);
const aliasRaw = document.getElementById("cfgAliases").value || "";
const roomInventoryText = (document.getElementById("cfgRoomInventoryText")?.value||"");

const qapiPatientDays7 = Number(document.getElementById("cfgPatientDays7")?.value || 0);
const qapiWindowDays = Math.max(1, Math.min(28, Number(document.getElementById("cfgWindowDays")?.value || 7)));
const qInfectRate = Number(document.getElementById("cfgInfectRate")?.value || 10);
const qAbtRate = Number(document.getElementById("cfgAbtRate")?.value || 20);
const qTrigGI = Math.max(1, Number(document.getElementById("cfgTrigGI")?.value || 2));
const qTrigResp = Math.max(1, Number(document.getElementById("cfgTrigResp")?.value || 2));
const qTrigAbtDay = Math.max(1, Number(document.getElementById("cfgTrigAbtDay")?.value || 3));
const qTrigPending = Math.max(0, Number(document.getElementById("cfgTrigPending")?.value || 5));
const qVaxTarget = Math.max(0, Math.min(100, Number(document.getElementById("cfgVaxTarget")?.value || 80)));
const aliasMap = {};
aliasRaw.split(/\r?\n/).map(x=>x.trim()).filter(Boolean).forEach(line=>{
const m = line.split("=");
if(m.length>=2){
const k = normalizeText(m[0]);
const v = (m.slice(1).join("=")).trim();
if(k && v) aliasMap[k]=v;
}
});
Store.patch(s=>{
s.config.facilityName = name;
s.config.totalCapacity = total;
s.config.unitAliases = aliasMap;
s.config.roomInventoryText = roomInventoryText;

// QAPI thresholds
if(!s.config.qapi) s.config.qapi = {};
s.config.qapi.patientDaysLast7 = qapiPatientDays7;
s.config.qapi.windowDays = qapiWindowDays;
if(!s.config.qapi.thresholds) s.config.qapi.thresholds = {};
s.config.qapi.thresholds.infectionRatePer1000 = qInfectRate;
s.config.qapi.thresholds.abtUtilPer1000 = qAbtRate;
s.config.qapi.thresholds.gi72h = qTrigGI;
s.config.qapi.thresholds.resp72h = qTrigResp;
s.config.qapi.thresholds.abtStartsDay = qTrigAbtDay;
s.config.qapi.thresholds.pendingBacklog = qTrigPending;
s.config.qapi.thresholds.vaxAnyTarget = qVaxTarget;
ensureDefaultUsers(s);
});
});
document.getElementById("btnAddUnit")?.addEventListener("click", ()=>{
Store.patch(s=>{
const n=(s.config.units||[]).length+1;
s.config.units.push({unitKey:`U${n}`, unitName:`Unit ${n}`, bedCapacity:0});
});
});

window.cfgEditUnit = function(idx, field, value){
Store.patch(s=>{
const u=s.config.units[idx]; if(!u) return;
if(field==="bedCapacity") u[field]=Number(value||0);
else u[field]=value;
});
};
window.cfgRemoveUnit = function(idx){
Store.patch(s=>{ s.config.units.splice(idx,1); });
};

function vaxGetAllTypes(s){
const set = new Set((s.modules.vax.events||[]).map(e=> (e.vaccineType||"Other").toString().trim()).filter(Boolean));
if(set.size===0){
["Influenza","COVID-19","Pneumonia","RSV","Other"].forEach(x=>set.add(x));
}
return Array.from(set).sort((a,b)=>a.localeCompare(b));
}
function vaxCoreTypes(){ return ["COVID-19","Influenza","Pneumonia","RSV"]; }

function vaxWeekRangeISOFrom(dateISO){
const d = dateISO ? new Date(dateISO+"T00:00:00") : new Date();
const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
const day = (x.getDay()+6)%7; // Monday=0
const start = new Date(x); start.setDate(x.getDate()-day);
const end = new Date(start); end.setDate(start.getDate()+6);
const toISO=(dt)=>`${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,"0")}-${String(dt.getDate()).padStart(2,"0")}`;
return { startISO: toISO(start), endISO: toISO(end) };
}

function vaxResidentsByCensus(s, censusMode){
if(censusMode==="all") return Object.values(s.residentsById||{});
const ids = Array.isArray(s.census.activeResidentIds) ? s.census.activeResidentIds : [];
if(ids.length) return ids.map(id=>s.residentsById[id]).filter(Boolean);
return Object.values(s.residentsById||{}).filter(r=>r.status==="active");
}
function vaxApplyUnitFilter(s, residents){
const uf = s.ui.unitFilter;
if(uf==="ALL") return residents;
return residents.filter(r=> (r.unit===uf) || (r.lockedUnit===uf));
}
function vaxEventMatchesResident(e, r){
if(e.residentId && r.id && e.residentId===r.id) return true;
if(e.mrn && r.mrn && e.mrn===r.mrn) return true;
return false;
}
function vaxISO(e){ return mdyToISO(e.date||""); }
function vaxGetLatestStatusAsOf(events, vaccineType, asOfISO){
const rows = events
.filter(e=> (e.vaccineType||"Other")===vaccineType)
.filter(e=> !asOfISO || (vaxISO(e) && vaxISO(e) <= asOfISO))
.sort((a,b)=> (vaxISO(b)||"").localeCompare(vaxISO(a)||""));
return rows[0] || null;
}
function vaxStatusBadge(status){
const s=(status||"").toLowerCase();
if(s==="vaccinated") return `<span class="badge green">vaccinated</span>`;
if(s==="declined") return `<span class="badge amber">declined</span>`;
if(s==="pending") return `<span class="badge blue">pending</span>`;
return `<span class="badge">${escapeHtml(status||"")}</span>`;
}
function vaxSetSubtab(tab){
Store.patch(s=>{
s.modules.vax.ui = s.modules.vax.ui || {};
s.modules.vax.ui.reportTab = tab;
});
}

function vaxRenderReportCenter(s){
const ui = s.modules.vax.ui || {};
const tab = ui.reportTab || "weekly";

["matrix","weekly","dueToday","dueWeek","snapshot"].forEach(t=>{
const b = document.getElementById(`vaxTab_${t}`);
if(b) b.classList.toggle("active", t===tab);
const v = document.getElementById(`vaxView_${t}`);
if(v) v.style.display = (t===tab) ? "" : "none";
});

const types = vaxGetAllTypes(s);
const fillTypeSelect = (id)=>{
const el = document.getElementById(id);
if(!el) return;
const current = el.value;
el.innerHTML = `<option value="">All Types</option>` + types.map(t=>`<option>${escapeHtml(t)}</option>`).join("");
if(current && types.includes(current)) el.value = current; else el.value = "";
};
["vxmType","vxwType","vxdTodayType","vxdWeekType"].forEach(fillTypeSelect);

const today = todayISO();
const setIfEmpty = (id, v)=>{
const el = document.getElementById(id);
if(el && !el.value) el.value = v;
};
const d = new Date();
const first = new Date(d.getFullYear(), d.getMonth(), 1);
const last = new Date(d.getFullYear(), d.getMonth()+1, 0);
const toISO=(dt)=>`${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,"0")}-${String(dt.getDate()).padStart(2,"0")}`;
setIfEmpty("vxmFrom", toISO(first));
setIfEmpty("vxmTo", toISO(last));
setIfEmpty("vxwAny", today);
setIfEmpty("vxdToday", today);
setIfEmpty("vxdWeekAny", today);
setIfEmpty("vxsAsOf", today);

document.querySelectorAll("#vaxSubnav .tabbtn").forEach(btn=>{
if(btn.dataset.bound==="1") return;
btn.dataset.bound="1";
btn.onclick = ()=> vaxSetSubtab(btn.dataset.vxt);
});

const bindOnce = (id, fn)=>{
const el = document.getElementById(id);
if(!el) return;
if(el.dataset.bound==="1") return;
el.dataset.bound="1";
el.onclick = fn;
};
bindOnce("btnVxmPreview", ()=> vaxPreviewMatrix(false));
bindOnce("btnVxmPrint", ()=> vaxPreviewMatrix(true));
bindOnce("btnVxwPreview", ()=> vaxPreviewWeekly(false));
bindOnce("btnVxwPrint", ()=> vaxPreviewWeekly(true));
bindOnce("btnVxdTodayPreview", ()=> vaxPreviewDueToday(false));
bindOnce("btnVxdTodayPrint", ()=> vaxPreviewDueToday(true));
bindOnce("btnVxdWeekPreview", ()=> vaxPreviewDueWeek(false));
bindOnce("btnVxdWeekPrint", ()=> vaxPreviewDueWeek(true));
bindOnce("btnVxsPreview", ()=> vaxPreviewSnapshot(false));
bindOnce("btnVxsPrint", ()=> vaxPreviewSnapshot(true));
}

function vaxGetEventsForResident(s, r){
const all = s.modules.vax.events||[];
return all.filter(e=>vaxEventMatchesResident(e,r));
}

function vaxPreviewMatrix(printMode){
const s = Store.load();
const fromISO = document.getElementById("vxmFrom").value;
const toISO = document.getElementById("vxmTo").value;
const census = document.getElementById("vxmCensus").value;
const status = document.getElementById("vxmStatus").value;
const type = document.getElementById("vxmType").value;
const set = document.getElementById("vxmSet").value || "core";

let types = (set==="core") ? vaxCoreTypes() : vaxGetAllTypes(s);
if(type) types = [type];

let residents = vaxApplyUnitFilter(s, vaxResidentsByCensus(s, census));
residents = residents.sort((a,b)=> (a.room||"").localeCompare(b.room||"", undefined, {numeric:true}) || (a.name||"").localeCompare(b.name||""));

const rows = residents.map(r=>{
const ev = vaxGetEventsForResident(s, r);
const cells = types.map(t=>{
const latest = vaxGetLatestStatusAsOf(ev, t, toISO);
if(!latest) return {t, status:""};
if(status && (latest.status||"")!==status) return {t, status:""};
return {t, status: latest.status||"", date: latest.date||""};
});
return { r, cells };
});

const table = `
<table>
<thead>
<tr>
<th>Resident</th><th>Unit</th><th>Room</th>
${types.map(t=>`<th>${escapeHtml(t)}</th>`).join("")}
</tr>
</thead>
<tbody>
${rows.map(x=>`
<tr>
<td>${escapeHtml(x.r.name||"")}</td>
<td class="nowrap">${escapeHtml(x.r.unit||x.r.lockedUnit||"")}</td>
<td class="nowrap">${escapeHtml(x.r.room||x.r.lockedRoom||"")}</td>
${x.cells.map(c=>{
if(!c.status) return `<td class="muted"></td>`;
return `<td>${vaxStatusBadge(c.status)} <span class="muted mini">${escapeHtml(c.date||"")}</span></td>`;
}).join("")}
</tr>
`).join("")}
</tbody>
</table>
`;
const title = `Monthly Vaccine Matrix (${fromISO} to ${toISO})`;
if(printMode){
openModal(title, `
<div class="noprint row end"><button class="btn primary" onclick="window.print()">Print</button></div>
<div class="card" style="box-shadow:none">
<h2 style="margin:0 0 6px">${escapeHtml(Store.load().config.facilityName||"Facility")}</h2>
<div class="muted mini">${escapeHtml(title)} · Unit filter: ${escapeHtml(Store.load().ui.unitFilter||"ALL")}</div>
<div class="sep"></div>
${table}
</div>
`);
} else document.getElementById("vxmOut").innerHTML = table;
}

function vaxPreviewWeekly(printMode){
const s = Store.load();
const anyISO = document.getElementById("vxwAny").value || todayISO();
const {startISO, endISO} = vaxWeekRangeISOFrom(anyISO);
const type = document.getElementById("vxwType").value;
const census = document.getElementById("vxwCensus").value;

let residents = vaxApplyUnitFilter(s, vaxResidentsByCensus(s, census));
const residentSet = new Set(residents.map(r=>r.id));

let ev = (s.modules.vax.events||[])
.filter(e=> inRangeISO(e.date, startISO, endISO))
.filter(e=> !type || (e.vaccineType||"Other")===type)
.filter(e=>{
if(census==="all") return true;
if(e.residentId && residentSet.has(e.residentId)) return true;
if(e.mrn){
const match = residents.find(r=>r.mrn && r.mrn===e.mrn);
return !!match;
}
return false;
});

if(s.ui.unitFilter!=="ALL") ev = ev.filter(e=> (e.unit||"")===s.ui.unitFilter);

ev.sort((a,b)=> (mdyToISO(a.date)||"").localeCompare(mdyToISO(b.date)||"") || (a.residentName||"").localeCompare(b.residentName||""));

const table = `
<table>
<thead><tr><th>Date</th><th>Resident</th><th>Unit</th><th>Room</th><th>Vaccine Type</th><th>Status</th><th>Notes</th></tr></thead>
<tbody>
${ev.map(e=>`
<tr>
<td class="nowrap">${escapeHtml(e.date||"")}</td>
<td>${escapeHtml(e.residentName||"")}</td>
<td class="nowrap">${escapeHtml(e.unit||"")}</td>
<td class="nowrap">${escapeHtml(e.room||"")}</td>
<td>${escapeHtml(e.vaccineType||"")}</td>
<td class="nowrap">${vaxStatusBadge(e.status||"")}</td>
<td>${escapeHtml(e.notes||"")}</td>
</tr>
`).join("")}
</tbody>
</table>
`;
const title = `Weekly Resident Vaccine List (${startISO} to ${endISO})`;
if(printMode){
openModal(title, `
<div class="noprint row end"><button class="btn primary" onclick="window.print()">Print</button></div>
<div class="card" style="box-shadow:none">
<h2 style="margin:0 0 6px">${escapeHtml(Store.load().config.facilityName||"Facility")}</h2>
<div class="muted mini">${escapeHtml(title)} · Unit filter: ${escapeHtml(Store.load().ui.unitFilter||"ALL")}</div>
<div class="sep"></div>
${table}
</div>
`);
} else document.getElementById("vxwOut").innerHTML = table;
}

function vaxPreviewDueToday(printMode){
const s = Store.load();
const dayISO = document.getElementById("vxdToday").value || todayISO();
const type = document.getElementById("vxdTodayType").value;
const census = document.getElementById("vxdTodayCensus").value;

let residents = vaxApplyUnitFilter(s, vaxResidentsByCensus(s, census));
const residentSet = new Set(residents.map(r=>r.id));

let ev = (s.modules.vax.events||[])
.filter(e=> mdyToISO(e.date||"")===dayISO)
.filter(e=> (e.status||"").toLowerCase()==="pending")
.filter(e=> !type || (e.vaccineType||"Other")===type)
.filter(e=>{
if(census==="all") return true;
if(e.residentId && residentSet.has(e.residentId)) return true;
if(e.mrn){
const match = residents.find(r=>r.mrn && r.mrn===e.mrn);
return !!match;
}
return false;
});

if(s.ui.unitFilter!=="ALL") ev = ev.filter(e=> (e.unit||"")===s.ui.unitFilter);

ev.sort((a,b)=> (a.room||"").localeCompare(b.room||"", undefined, {numeric:true}) || (a.residentName||"").localeCompare(b.residentName||""));

const table = `
<table>
<thead><tr><th>Resident</th><th>Unit</th><th>Room</th><th>Vaccine Type</th><th>Status</th><th>Notes</th></tr></thead>
<tbody>
${ev.map(e=>`
<tr>
<td>${escapeHtml(e.residentName||"")}</td>
<td class="nowrap">${escapeHtml(e.unit||"")}</td>
<td class="nowrap">${escapeHtml(e.room||"")}</td>
<td>${escapeHtml(e.vaccineType||"")}</td>
<td class="nowrap">${vaxStatusBadge(e.status||"")}</td>
<td>${escapeHtml(e.notes||"")}</td>
</tr>
`).join("")}
</tbody>
</table>
`;
const title = `Due Today Reminder Sheet (${dayISO})`;
if(printMode){
openModal(title, `
<div class="noprint row end"><button class="btn primary" onclick="window.print()">Print</button></div>
<div class="card" style="box-shadow:none">
<h2 style="margin:0 0 6px">${escapeHtml(Store.load().config.facilityName||"Facility")}</h2>
<div class="muted mini">${escapeHtml(title)} · Unit filter: ${escapeHtml(Store.load().ui.unitFilter||"ALL")}</div>
<div class="sep"></div>
${table}
</div>
`);
} else document.getElementById("vxdTodayOut").innerHTML = table;
}

function vaxPreviewDueWeek(printMode){
const s = Store.load();
const anyISO = document.getElementById("vxdWeekAny").value || todayISO();
const {startISO, endISO} = vaxWeekRangeISOFrom(anyISO);
const type = document.getElementById("vxdWeekType").value;
const census = document.getElementById("vxdWeekCensus").value;

let residents = vaxApplyUnitFilter(s, vaxResidentsByCensus(s, census));
const residentSet = new Set(residents.map(r=>r.id));

let ev = (s.modules.vax.events||[])
.filter(e=> inRangeISO(e.date, startISO, endISO))
.filter(e=> (e.status||"").toLowerCase()==="pending")
.filter(e=> !type || (e.vaccineType||"Other")===type)
.filter(e=>{
if(census==="all") return true;
if(e.residentId && residentSet.has(e.residentId)) return true;
if(e.mrn){
const match = residents.find(r=>r.mrn && r.mrn===e.mrn);
return !!match;
}
return false;
});

if(s.ui.unitFilter!=="ALL") ev = ev.filter(e=> (e.unit||"")===s.ui.unitFilter);

ev.sort((a,b)=> (mdyToISO(a.date)||"").localeCompare(mdyToISO(b.date)||"") || (a.room||"").localeCompare(b.room||"", undefined, {numeric:true}));

const table = `
<table>
<thead><tr><th>Date</th><th>Resident</th><th>Unit</th><th>Room</th><th>Vaccine Type</th><th>Status</th><th>Notes</th></tr></thead>
<tbody>
${ev.map(e=>`
<tr>
<td class="nowrap">${escapeHtml(e.date||"")}</td>
<td>${escapeHtml(e.residentName||"")}</td>
<td class="nowrap">${escapeHtml(e.unit||"")}</td>
<td class="nowrap">${escapeHtml(e.room||"")}</td>
<td>${escapeHtml(e.vaccineType||"")}</td>
<td class="nowrap">${vaxStatusBadge(e.status||"")}</td>
<td>${escapeHtml(e.notes||"")}</td>
</tr>
`).join("")}
</tbody>
</table>
`;
const title = `Due This Week (${startISO} to ${endISO})`;
if(printMode){
openModal(title, `
<div class="noprint row end"><button class="btn primary" onclick="window.print()">Print</button></div>
<div class="card" style="box-shadow:none">
<h2 style="margin:0 0 6px">${escapeHtml(Store.load().config.facilityName||"Facility")}</h2>
<div class="muted mini">${escapeHtml(title)} · Unit filter: ${escapeHtml(Store.load().ui.unitFilter||"ALL")}</div>
<div class="sep"></div>
${table}
</div>
`);
} else document.getElementById("vxdWeekOut").innerHTML = table;
}

function vaxPreviewSnapshot(printMode){
const s = Store.load();
const asOfISO = document.getElementById("vxsAsOf").value || todayISO();
const coreSel = document.getElementById("vxsCore").value || "core";
const census = document.getElementById("vxsCensus").value;

const types = (coreSel==="core") ? vaxCoreTypes() : vaxGetAllTypes(s);
let residents = vaxApplyUnitFilter(s, vaxResidentsByCensus(s, census));
residents = residents.sort((a,b)=> (a.room||"").localeCompare(b.room||"", undefined, {numeric:true}) || (a.name||"").localeCompare(b.name||""));

const rows = residents.map(r=>{
const ev = vaxGetEventsForResident(s, r);
const perType = types.map(t=>{
const latest = vaxGetLatestStatusAsOf(ev, t, asOfISO);
const ok = latest && (latest.status||"")==="vaccinated";
return {t, ok, latest};
});
return {r, perType};
});

const counts = types.map(t=>{
let ok=0;
rows.forEach(x=>{
const cell = x.perType.find(c=>c.t===t);
if(cell && cell.ok) ok++;
});
return {t, ok, total: residents.length};
});

const summary = `
<div class="row" style="gap:8px; flex-wrap:wrap">
${counts.map(c=>`<span class="badge green">${escapeHtml(c.t)}: ${c.ok}/${c.total}</span>`).join("")}
</div>
`;
const table = `
${summary}
<div class="sep"></div>
<table>
<thead><tr><th>Resident</th><th>Unit</th><th>Room</th>${types.map(t=>`<th>${escapeHtml(t)}</th>`).join("")}</tr></thead>
<tbody>
${rows.map(x=>`
<tr>
<td>${escapeHtml(x.r.name||"")}</td>
<td class="nowrap">${escapeHtml(x.r.unit||x.r.lockedUnit||"")}</td>
<td class="nowrap">${escapeHtml(x.r.room||x.r.lockedRoom||"")}</td>
${x.perType.map(c=>{
if(!c.latest) return `<td class="muted"></td>`;
return `<td>${vaxStatusBadge(c.latest.status||"")} <span class="muted mini">${escapeHtml(c.latest.date||"")}</span></td>`;
}).join("")}
</tr>
`).join("")}
</tbody>
</table>
`;
const title = `Active Census Vaccinated Snapshot (as-of ${asOfISO})`;
if(printMode){
openModal(title, `
<div class="noprint row end"><button class="btn primary" onclick="window.print()">Print</button></div>
<div class="card" style="box-shadow:none">
<h2 style="margin:0 0 6px">${escapeHtml(Store.load().config.facilityName||"Facility")}</h2>
<div class="muted mini">${escapeHtml(title)} · Unit filter: ${escapeHtml(Store.load().ui.unitFilter||"ALL")}</div>
<div class="sep"></div>
${table}
</div>
`);
} else document.getElementById("vxsOut").innerHTML = table;
}

function abtNormalizeDate(s){
const t=(s||"").toString().trim();
if(!t) return "";
const m=t.match(/^(\d{4})-(\d{2})-(\d{2})$/);
if(m) return `${m[2]}/${m[3]}/${m[1]}`;
if(parseMDY(t)) return t;
const m2=t.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2})$/);
if(m2) return `${m2[1]}/${m2[2]}/20${m2[3]}`;
return t;
}
function abtTrim(s){ return (s||"").toString().trim().replace(/\s+/g," "); }
function abtInferCourseKey(r){
const mrn = (r.mrn||"").toString().trim().toUpperCase();
const abx = (r.antibiotic||"").toString().trim().toUpperCase();
const sd  = (r.startDate||"").toString().trim();
const ed  = (r.endDate||"").toString().trim();
return `${mrn}|${abx}|${sd}|${ed}`;
}

function abtParseFromTSV(lines){
const headIdx = lines.findIndex(l => l.includes("\t") && /resident/i.test(l) && /(antibiotic|abx|drug)/i.test(l));
if(headIdx === -1) return null;

const headers = lines[headIdx].split("\t").map(h=>abtTrim(h));
const idx = (name)=>{
const n=name.toLowerCase();
return headers.findIndex(h => h.toLowerCase()===n || h.toLowerCase().includes(n));
};

const col = {
room: idx("room"),
resident: idx("resident"),
name: idx("name"),
mrn: idx("mrn"),
dob: idx("dob"),
unit: idx("unit"),
antibiotic: idx("antibiotic"),
route: idx("route"),
start: idx("start"),
end: idx("end"),
indication: idx("indication"),
source: idx("source"),
notes: idx("notes"),
klass: idx("class")
};

const rows = [];
for(let i=headIdx+1;i<lines.length;i++){
const l = lines[i];
if(!l.includes("\t")) continue;
const cols = l.split("\t").map(c=>c.trim());
if(cols.every(c=>!c)) continue;

const room = col.room>=0 ? cols[col.room] : (cols[0]||"");
const residentCol = col.resident>=0 ? cols[col.resident] : (col.name>=0 ? cols[col.name] : (cols[1]||""));
const mrnCol = col.mrn>=0 ? cols[col.mrn] : "";
const mrnMatch = (residentCol||"").match(/\(([^)]+)\)/);
const mrn = abtTrim(mrnCol || (mrnMatch?mrnMatch[1]:""));
const name = abtTrim((residentCol||"").replace(/\s*\([^)]*\)\s*/g,""));

rows.push({
room: abtTrim(room),
unit: abtTrim(col.unit>=0 ? cols[col.unit] : ""),
name,
mrn,
dob: abtNormalizeDate(col.dob>=0 ? cols[col.dob] : ""),
antibiotic: abtTrim(col.antibiotic>=0 ? cols[col.antibiotic] : ""),
abxClass: abtTrim(col.klass>=0 ? cols[col.klass] : ""),
route: abtTrim(col.route>=0 ? cols[col.route] : ""),
startDate: abtNormalizeDate(col.start>=0 ? cols[col.start] : ""),
endDate: abtNormalizeDate(col.end>=0 ? cols[col.end] : ""),
indication: abtTrim(col.indication>=0 ? cols[col.indication] : ""),
infectionSource: abtTrim(col.source>=0 ? cols[col.source] : ""),
notes: abtTrim(col.notes>=0 ? cols[col.notes] : "")
});
}
return rows;
}

function looksLikeABTRow_legacy(cols){
if(!cols || cols.length < 7) return false;
const hasMRN = /\([^)]+\)/.test(cols[0] || "");
const start = (cols[3] || "").trim();
const startOk = /^\d{1,2}\/\d{1,2}\/\d{4}$/.test(start);
return hasMRN && startOk;
}
function parseResidentColStrict_legacy(residentCol){
const m = (residentCol || "").match(/^(.*)\(([^)]+)\)\s*$/);
if(!m){
return { residentName: (residentCol || "").trim(), mrn: "", warning: "MRN not found in parentheses" };
}
return { residentName: (m[1] || "").trim(), mrn: (m[2] || "").trim(), warning: "" };
}
function cleanDrugNameFromSig_legacy(sig){
const raw = (sig || "").trim();
if(!raw) return "";
const cut = raw.split(/\b(Use|Give)\b/i)[0].trim();
return (cut || raw).replace(/\s+/g," ").trim();
}
function parseDoseFromSig_legacy(sig){
const s = sig || "";
let m = s.match(/\bUse\s+(\d+(\.\d+)?\s*(mg|g|gram|mcg|units|mL|ml))\b/i);
if(m) return m[1].replace(/\s+/g," ").trim();
m = s.match(/\bGive\s+(\d+(\.\d+)?\s*(tablet|tab|capsule|cap|mL|ml))\b/i);
if(m) return m[1].replace(/\s+/g," ").trim();
m = s.match(/\b(\d+(\.\d+)?\s*(mg|g|gram|mcg|units|mL|ml))\b/i);
if(m) return m[1].replace(/\s+/g," ").trim();
return "";
}
function parseFrequencyFromSig_legacy(sig){
const s = (sig || "").toLowerCase();
let m = s.match(/every\s+(\d{1,2})\s*hours?/i);
if(m) return `q${m[1]}h`;
if(/two\s+times\s+a\s+day|\b2\s+times\s+a\s+day\b|\bbid\b/.test(s)) return "BID";
if(/three\s+times\s+a\s+day|\btid\b/.test(s)) return "TID";
if(/four\s+times\s+a\s+day|\bqid\b/.test(s)) return "QID";
if(/\bonce\s+a\s+day\b|\bqd\b|\bdaily\b/.test(s)) return "QD";
return "";
}
function maybeInferInfectionSource_legacy(indication){
const t = (indication || "").toLowerCase();
if(/pneum|influenza|\bflu\b|resp|cough|sob|\buri\b/.test(t)) return "Respiratory Tract";
if(/uti|urinary|dysuria|frequency|\bcyst\b|pyelo/.test(t)) return "Urinary Tract";
if(/c\.?\s*diff|diarrhea|\bgi\b|gastro|n\/v|vomit|\bcdiff\b/.test(t)) return "Gastrointestinal";
if(/skin|cellulitis|wound|ulcer|abscess|ssti|mucos|oral|thrush/.test(t)) return "Skin, Soft Tissue and Mucosal";
return "Other";
}
function inferRouteSimple_legacy(routeCol, sigCol){
const t = `${routeCol||""} ${sigCol||""}`.toLowerCase();
if(/\biv\b|intraven/.test(t)) return "IV";
if(/\bim\b|intramus/.test(t)) return "IM";
if(/\bpo\b|oral|by mouth/.test(t)) return "PO";
if(/topical|\btop\b/.test(t)) return "TOP";
if(/neb|nebul/.test(t)) return "NEB";
if(/oph|eye/.test(t)) return "OPH";
return (routeCol||"").trim().toUpperCase();
}
function parseABTTabDelimited_legacy(text){
const lines = (text || "").replace(/\r/g,"").split("\n").map(l => l.replace(/\s+$/,"")).filter(l => l.trim().length>0);
const rows = [];
let accepted = 0, rejected = 0;

for(const line of lines){
const cols = line.split("\t").map(c=>c.trim());
if(!looksLikeABTRow_legacy(cols)){
rejected++;
continue;
}
accepted++;

const residentCol = cols[0] || "";
const sigCol      = cols[1] || "";
const classCol    = cols[2] || "";
const startCol    = cols[3] || "";
const endCol      = cols[4] || "";
const routeCol    = cols[5] || "";
const indicCol    = cols[6] || "";

const r = parseResidentColStrict_legacy(residentCol);
const antibiotic = cleanDrugNameFromSig_legacy(sigCol);
const dose = parseDoseFromSig_legacy(sigCol);
const frequency = parseFrequencyFromSig_legacy(sigCol);
const route = inferRouteSimple_legacy(routeCol, sigCol);

rows.push({
room: "",
unit: "",
name: r.residentName || "",
mrn: (r.mrn || "").toUpperCase(),
dob: "",
antibiotic,
abxClass: abtTrim(classCol),
route,
startDate: abtNormalizeDate(startCol),
endDate: abtNormalizeDate(endCol),
indication: abtTrim(indicCol),
infectionSource: maybeInferInfectionSource_legacy(indicCol),
notes: abtTrim(sigCol),
dose,
frequency
});
}

return { rows, accepted, rejected };
}

function abtParseFallback(raw){
const legacy = parseABTTabDelimited_legacy(raw||"");
if(legacy && Array.isArray(legacy.rows) && legacy.rows.length){
return legacy.rows;
}

const lines = (raw||"").split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
const tsv = abtParseFromTSV(lines);
if(tsv && tsv.length) return tsv;

const rows = [];
for(const line of lines){
if(!line.includes("\t")) continue;
const cols = line.split("\t").map(c=>c.trim());
const joined = cols.join(" ");
const up = joined.toUpperCase();
if(up.includes("ORDER LIST") || up.includes("FACILITY") || up.startsWith("DATE:") || up.startsWith("TIME:") || up.startsWith("USER:")) continue;

const resCell = cols.find(c=>/\([^)]+\)/.test(c||""));
if(!resCell) continue;

const mrnMatch = resCell.match(/\(([^)]+)\)/);
const mrn = mrnMatch ? mrnMatch[1].trim() : "";
const name = abtTrim(resCell.replace(/\s*\([^)]*\)\s*/g,""));
if(!name || !mrn) continue;

const after = cols.slice(cols.indexOf(resCell)+1);
const antibiotic = abtTrim(after.find(x=>/[A-Za-z]/.test(x||"")) || "");

rows.push({
room:"",
unit:"",
name,
mrn: mrn.toUpperCase(),
dob:"",
antibiotic,
abxClass:"",
route:"",
startDate:"",
endDate:"",
indication:"",
infectionSource:"",
notes:""
});
}
return rows;
}

function openAbtImportModal(){
openModal("ABT Import (Paste Raw Text)", `
<div class="muted mini">
Paste the ABT export/raw text here. We’ll parse into an editable preview before applying to the ABT long log.
<br/>Supported: PCC ABT tab-delimited export (Resident (NAME (MRN)) | Sig | Class | Start | End | Route | Indication). Other tabbed formats are best-effort.
</div>
<div class="sep"></div>
<label>Raw ABT Text</label>
<textarea id="abtRawBox" style="min-height:220px" placeholder="Paste ABT raw text here..."></textarea>
<div class="row end" style="margin-top:10px">
<button class="btn" onclick="abtDoParse()">Parse</button>
<button class="btn primary" id="btnAbtApplyParsed" onclick="abtApplyParsed()" disabled>Apply Parsed</button>
</div>
<div class="sep"></div>
<div id="abtParsedOut" class="muted mini">No parsed preview yet.</div>
`);
}

window.abtDoParse = function(){
const raw = document.getElementById("abtRawBox").value || "";
const rows = abtParseFallback(raw);
window.__lastParsedABT = rows;

(rows||[]).forEach(r=>{ if(r && r.__selected===undefined) r.__selected=true; });
const btn = document.getElementById("btnAbtApplyParsed");
if(btn) btn.disabled = !rows.length;

abtRenderParsedPreview();
};

function abtAutoLinkFromCensus(){
const s = Store.load();
const byMrn = {};
Object.values(s.residentsById||{}).forEach(r=>{
const mrn = (r.mrn||"").toString().trim();
if(mrn) byMrn[mrn.toUpperCase()] = r;
});
(window.__lastParsedABT||[]).forEach(row=>{
const mrn = (row.mrn||"").toString().trim().toUpperCase();
const r = mrn ? byMrn[mrn] : null;
if(r){
row.name = row.name || r.name || "";
row.unit = row.unit || r.unit || r.lockedUnit || "";
row.room = row.room || r.room || r.lockedRoom || "";
row.dob  = row.dob  || r.dob || "";
} else {
if(!row.unit && row.room){
const u = inferUnitFromRoom(row.room, s.config) || "";
if(u) row.unit = u;
}
}
});
abtRenderParsedPreview();
}

function abtTrimNormalizeParsed(){
(window.__lastParsedABT||[]).forEach(r=>{
r.room = normalizeRoomForEdit(r.room||"");
r.unit = abtTrim(r.unit||"");
r.name = abtTrim(r.name||"");
r.mrn  = abtTrim(r.mrn||"");
r.dob  = abtNormalizeDate(r.dob||"");
r.antibiotic = abtTrim(r.antibiotic||"");
r.abxClass = abtTrim(r.abxClass||"");
r.route = abtTrim(r.route||"");
r.startDate = abtNormalizeDate(r.startDate||"");
r.endDate = abtNormalizeDate(r.endDate||"");
r.indication = abtTrim(r.indication||"");
r.infectionSource = abtTrim(r.infectionSource||"");
r.notes = abtTrim(r.notes||"");
});
abtRenderParsedPreview();
}

window.updateParsedAbt = function(idx, field, value){
if(!window.__lastParsedABT || !window.__lastParsedABT[idx]) return;
const r = window.__lastParsedABT[idx];

if(field==="__selected"){ r.__selected = !!value; return; }

if(field==="unit"){ r.unit = abtTrim(value); return; }
if(field==="name"){ r.name = abtTrim(value); return; }
if(field==="mrn"){ r.mrn = abtTrim(value).toUpperCase(); return; }
if(field==="antibiotic"){ r.antibiotic = abtTrim(value); return; }
if(field==="abxClass"){ r.abxClass = abtTrim(value); return; }
if(field==="route"){ r.route = abtTrim(value); return; }
if(field==="startDate"){ r.startDate = abtNormalizeDate(value); return; }
if(field==="endDate"){ r.endDate = abtNormalizeDate(value); return; }
if(field==="indication"){ r.indication = abtTrim(value); return; }
if(field==="infectionSource"){ r.infectionSource = abtTrim(value) || ""; return; }
if(field==="notes"){ r.notes = abtTrim(value); return; }
};

function abtNormKeyPart(x){ return (x||"").toString().trim().toUpperCase(); }
function abtRowKey(row){
const mrn = abtNormKeyPart(row?.mrn||"");
const abx = abtNormKeyPart(row?.antibiotic||"");
const sd  = (row?.startDate||"").toString().trim();
const ed  = (row?.endDate||"").toString().trim();
return `${mrn}|${abx}|${sd}|${ed}`;
}
function abtExistingKeySet(s){
const set = new Set();
(s.modules.abt.courses||[]).forEach(c=>{
set.add(`${abtNormKeyPart(c.mrn)}|${abtNormKeyPart(c.antibiotic)}|${(c.startDate||"").toString().trim()}|${(c.endDate||"").toString().trim()}`);
});
return set;
}

function abtRenderParsedPreview(){
const box = document.getElementById("abtParsedOut");
const rows = window.__lastParsedABT || [];
if(!box) return;

if(!rows.length){
box.innerHTML = `
<div class="row" style="justify-content:space-between; align-items:center; gap:10px; margin-bottom:8px">
<div class="muted mini">
<b>Parsed:</b> ${rows.length} row(s) · <b>Duplicates:</b> ${dupCount} (marked; will be skipped on apply)
</div>
<div class="row" style="gap:8px; flex-wrap:wrap">
<button class="smallbtn" onclick="abtAutoLinkFromCensus()">Auto-link from census</button>
</div>
</div>
<div class="muted">No parsable rows found.</div>`;
return;
}

const s = Store.load();
const existingKeys = abtExistingKeySet(s);
let dupCount = 0;
rows.forEach(r=>{
const k = abtRowKey(r);
r.__dup = (!!k && existingKeys.has(k));
if(r.__dup && r.__selected) dupCount++;
});
rows.forEach(r=>{ if(r && r.__selected===undefined) r.__selected=true; });

const sourceOptionsBase = [
"", "Respiratory Tract", "Gastrointestinal", "Urinary Tract",
"Skin, Soft Tissue and Mucosal", "Bloodstream", "Other"
];

const extra = Array.from(new Set(rows.map(r=>(r.infectionSource||"").trim()).filter(v=>v && !sourceOptionsBase.includes(v))));
const sourceOptions = sourceOptionsBase.concat(extra);

box.innerHTML = `
<div class="row" style="justify-content:space-between; align-items:flex-end">
<div class="muted mini">Parsed ABT rows: <b>${rows.length}</b> (use checkbox to select what gets added)</div>
<div class="row" style="gap:8px">
<button class="smallbtn" id="btnAbtSelectAll">Select All</button>
<button class="smallbtn" id="btnAbtSelectNone">Select None</button>
<button class="smallbtn" id="btnAbtTrim">Trim / Normalize</button>
</div>
</div>
<div class="sep"></div>
<table>
<thead><tr>
<th class="nowrap">Add</th>
<th>Resident</th><th>MRN</th>
<th>Antibiotic</th><th>Class</th><th>Route</th>
<th>Start</th><th>End</th>
<th>Indication</th><th>Source</th><th>Notes</th>
</tr></thead>
<tbody>
${rows.slice(0,400).map((r,i)=>`
<tr>
<tr class="${r.__dup? "trDup": ""}">
<td class="nowrap" style="text-align:center">
<input type="checkbox" ${r.__selected ? "checked" : ""} onchange="updateParsedAbt(${i},'__selected',this.checked)"/>
</td>
<td class="nowrap">${r.__dup?`<span class="badge badgeDup">DUP</span>`:""}</td>
<td><input type="text" value="${escapeHtml(r.name||"")}" oninput="updateParsedAbt(${i},'name',this.value)"/></td>
<td class="nowrap"><input type="text" value="${escapeHtml(r.mrn||"")}" oninput="updateParsedAbt(${i},'mrn',this.value)"/></td>
<td><input type="text" value="${escapeHtml(r.antibiotic||"")}" oninput="updateParsedAbt(${i},'antibiotic',this.value)"/></td>
<td class="nowrap"><input type="text" value="${escapeHtml(r.abxClass||"")}" oninput="updateParsedAbt(${i},'abxClass',this.value)"/></td>
<td class="nowrap"><input type="text" value="${escapeHtml(r.route||"")}" oninput="updateParsedAbt(${i},'route',this.value)"/></td>
<td class="nowrap"><input type="text" value="${escapeHtml(r.startDate||"")}" oninput="updateParsedAbt(${i},'startDate',this.value)"/></td>
<td class="nowrap"><input type="text" value="${escapeHtml(r.endDate||"")}" oninput="updateParsedAbt(${i},'endDate',this.value)"/></td>
<td><input type="text" value="${escapeHtml(r.indication||"")}" oninput="updateParsedAbt(${i},'indication',this.value)"/></td>
<td class="nowrap">
<select onchange="updateParsedAbt(${i},'infectionSource',this.value)">
${sourceOptions.map(opt=>{
const sel = (opt===(r.infectionSource||"")) ? "selected" : "";
const label = opt ? opt : "—";
return `<option value="${escapeHtml(opt)}" ${sel}>${escapeHtml(label)}</option>`;
}).join("")}
</select>
</td>
<td><input type="text" value="${escapeHtml(r.notes||"")}" oninput="updateParsedAbt(${i},'notes',this.value)"/></td>
</tr>
`).join("")}
</tbody>
</table>
${rows.length>400? `<div class="muted mini" style="margin-top:8px">Showing first 400 rows in preview (still applies all selected rows).</div>`:""}
`;

const trimBtn = document.getElementById("btnAbtTrim");
if(trimBtn && !trimBtn.dataset.bound){
trimBtn.dataset.bound="1";
trimBtn.onclick = ()=>{
abtTrimNormalizeParsed();
};
}

const selAll = document.getElementById("btnAbtSelectAll");
if(selAll && !selAll.dataset.bound){
selAll.dataset.bound="1";
selAll.onclick = ()=>{
(window.__lastParsedABT||[]).forEach(r=>{ r.__selected=true; });
abtRenderParsedPreview();
};
}
const selNone = document.getElementById("btnAbtSelectNone");
if(selNone && !selNone.dataset.bound){
selNone.dataset.bound="1";
selNone.onclick = ()=>{
(window.__lastParsedABT||[]).forEach(r=>{ r.__selected=false; });
abtRenderParsedPreview();
};
}
}

window.abtApplyParsed = function(){
const rows = window.__lastParsedABT || [];
if(!rows.length) return;

let added=0, skippedDup=0, skippedNotSel=0;
Store.patch(s=>{
const existing = new Set((s.modules.abt.courses||[]).map(c=>{
const mrn = (c.mrn||"").toString().trim().toUpperCase();
const abx = (c.antibiotic||"").toString().trim().toUpperCase();
const sd  = (c.startDate||"").toString().trim();
const ed  = (c.endDate||"").toString().trim();
return `${mrn}|${abx}|${sd}|${ed}`;
}));

const byMrn = {};
Object.values(s.residentsById||{}).forEach(r=>{
const mrn = (r.mrn||"").toString().trim();
if(mrn) byMrn[mrn.toUpperCase()] = r;
});

for(const r of rows){
if(r && r.__selected===false){ skippedNotSel++; continue; }
const key = abtInferCourseKey(r);
if(existing.has(key)){ skippedDup++; continue; }

const mrnUp = (r.mrn||"").toString().trim().toUpperCase();
const rr = mrnUp ? byMrn[mrnUp] : null;

const residentId = mrnUp ? ("MRN-" + mrnUp) : makeResidentId({mrn:"", unit:r.unit||"", room:r.room||"", name:r.name||""});
const residentName = rr?.name || r.name || "";
const unit = rr?.unit || rr?.lockedUnit || r.unit || inferUnitFromRoom(r.room||"", s.config) || "";
const room = rr?.room || rr?.lockedRoom || r.room || "";

s.modules.abt.courses.push({
id: uid("abt"),
residentId,
residentName,
mrn: mrnUp || "",
unit: unit || "",
room: room || "",
dob: r.dob || (rr?.dob||"") || "",
antibiotic: r.antibiotic || "",
abxClass: r.abxClass || "",
startDate: r.startDate || "",
endDate: r.endDate || "",
route: r.route || "",
indication: r.indication || "",
infectionSource: r.infectionSource || "",
notes: r.notes || "",
createdAt: nowISO(),
updatedAt: nowISO(),
source: "ABT_IMPORT"
});

existing.add(key);
added++;
}
s.modules.abt.lastImportAdded = added;
s.modules.abt.lastImportSkippedDup = skippedDup;
s.modules.abt.lastImportSkippedNotSelected = skippedNotSel;
s.modules.abt.lastImportAt = nowISO();
});

window.__lastParsedABT = null;
closeModal();
setTab("abt");
alert(`ABT Import Summary\n\nAdded: ${added}\nSkipped duplicates: $${skippedDup}\nNot selected: $${skippedNotSel}\n\nTip: Use Edit to revise or delete entries.`);

}
function openAbtEditModal(courseId){
const s = Store.load();
const c = (s.modules.abt.courses||[]).find(x=>x.id===courseId);
if(!c){ alert("Course not found."); return; }

openModal("Edit ABT Course", `
<div class="muted mini">Edits update the ABT long log entry.</div>
<div class="sep"></div>

<div class="grid cols3">
<div><label>Resident</label><input id="abtE_name" type="text" value="${escapeHtml(c.residentName||"")}"/></div>
<div><label>MRN</label><input id="abtE_mrn" type="text" value="${escapeHtml(c.mrn||"")}"/></div>
<div><label>DOB</label><input id="abtE_dob" type="text" value="${escapeHtml(c.dob||"")}"/></div>
</div>

<div class="grid cols3" style="margin-top:10px">
<div><label>Room</label><input id="abtE_room" type="text" value="${escapeHtml(c.room||"")}"/></div>
<div><label>Unit</label><input id="abtE_unit" type="text" value="${escapeHtml(c.unit||"")}"/></div>
<div><label>Route</label><input id="abtE_route" type="text" value="${escapeHtml(c.route||"")}"/></div>
</div>

<div class="grid cols3" style="margin-top:10px">
<div><label>Antibiotic</label><input id="abtE_abx" type="text" value="${escapeHtml(c.antibiotic||"")}"/></div>
<div><label>Class</label><input id="abtE_class" type="text" value="${escapeHtml(c.abxClass||"")}"/></div>
<div><label>Infection Source</label><input id="abtE_src" type="text" value="${escapeHtml(c.infectionSource||"")}"/></div>
</div>

<div class="grid cols3" style="margin-top:10px">
<div><label>Start Date</label><input id="abtE_start" type="text" value="${escapeHtml(c.startDate||"")}"/></div>
<div><label>End Date</label><input id="abtE_end" type="text" value="${escapeHtml(c.endDate||"")}"/></div>
<div><label>&nbsp;</label><button class="btn danger" onclick="abtDeleteCourse('${escapeHtml(courseId)}')">Delete</button></div>
</div>

<div style="margin-top:10px">
<label>Indication</label>
<input id="abtE_ind" type="text" value="${escapeHtml(c.indication||"")}"/>
</div>
<div style="margin-top:10px">
<label>Notes</label>
<input id="abtE_notes" type="text" value="${escapeHtml(c.notes||"")}"/>
</div>

<div class="sep"></div>
<div class="row end">
<button class="btn" onclick="closeModal()">Cancel</button>
<button class="btn primary" onclick="abtSaveCourse('${escapeHtml(courseId)}')">Save</button>
</div>
`);
}

window.abtSaveCourse = function(courseId){
const name = abtTrim(document.getElementById("abtE_name").value||"");
const mrn  = abtTrim(document.getElementById("abtE_mrn").value||"").toUpperCase();
const dob  = abtNormalizeDate(document.getElementById("abtE_dob").value||"");
const room = normalizeRoomForEdit(document.getElementById("abtE_room").value||"");
const unit = abtTrim(document.getElementById("abtE_unit").value||"");
const route = abtTrim(document.getElementById("abtE_route").value||"");
const abx = abtTrim(document.getElementById("abtE_abx").value||"");
const klass = abtTrim(document.getElementById("abtE_class").value||"");
const src = abtTrim(document.getElementById("abtE_src").value||"");
const sd = abtNormalizeDate(document.getElementById("abtE_start").value||"");
const ed = abtNormalizeDate(document.getElementById("abtE_end").value||"");
const ind = abtTrim(document.getElementById("abtE_ind").value||"");
const notes = abtTrim(document.getElementById("abtE_notes").value||"");

Store.patch(s=>{
const c = (s.modules.abt.courses||[]).find(x=>x.id===courseId);
if(!c) return;

c.residentName = name || c.residentName || "";
c.mrn = mrn || c.mrn || "";
if(mrn) c.residentId = "MRN-" + mrn;
c.dob = dob || c.dob || "";
c.room = room || c.room || "";
c.unit = unit || c.unit || "";
c.route = route || c.route || "";
c.antibiotic = abx || c.antibiotic || "";
c.abxClass = klass || c.abxClass || "";
c.infectionSource = src || c.infectionSource || "";
c.startDate = sd || c.startDate || "";
c.endDate = ed || c.endDate || "";
c.indication = ind || c.indication || "";
c.notes = notes || c.notes || "";
c.updatedAt = nowISO();
});

closeModal();
};

window.abtDeleteCourse = function(courseId){
if(!confirm("Delete this ABT course entry?")) return;
Store.patch(s=>{
s.modules.abt.courses = (s.modules.abt.courses||[]).filter(x=>x.id!==courseId);
});
closeModal();
};

function abtIsActiveCourse(c){
const today = new Date();
const end = parseMDY(c.endDate);
if(!c.endDate) return true;
if(!end) return false;
return end >= new Date(today.getFullYear(), today.getMonth(), today.getDate());
}

function renderAbtTables(s){
const showHistory = !!(document.getElementById("toggleAbtShowHistory")?.checked);
const unitFilter = s.ui.unitFilter || "ALL";
const courses = (s.modules.abt.courses||[]).slice();

const filtered = courses.filter(c=>{
if(unitFilter!=="ALL"){
const u = c.unit || (s.residentsById[c.residentId]?.unit||"");
const uk = getUnitKeyFromAny(u||"", s.config) || u;
if(uk!==unitFilter) return false;
}
return showHistory ? true : abtIsActiveCourse(c);
});

filtered.sort((a,b)=> (mdyToISO(b.startDate)||"").localeCompare(mdyToISO(a.startDate)||"") || (a.residentName||"").localeCompare(b.residentName||""));

const box = document.getElementById("abtAllTable");
if(!box) return;

const llOpts = ["", "Respiratory", "GI", "UTI", "Skin/Soft Tissue", "Bloodstream", "Other"];
const srcBase = ["", "Respiratory", "Gastrointestinal", "Urinary", "Skin/Soft Tissue", "Bloodstream", "Other"];
const srcExtra = Array.from(new Set(filtered.map(x=>(x.infectionSource||"").trim()).filter(v=>v && !srcBase.includes(v))));
const srcOpts = srcBase.concat(srcExtra);
const srcOptHtml = (cur)=> srcOpts.map(v=>{ const label = v ? v : "—"; const sel = (v===(cur||""))?"selected":""; return `<option value="${escapeHtml(v)}" ${sel}>${escapeHtml(label)}</option>`; }).join("");
const optHtml = (cur)=> llOpts.map(v=>{
const label = v ? v : "—";
const sel = (v===(cur||"")) ? "selected" : "";
return `<option value="${escapeHtml(v)}" ${sel}>${escapeHtml(label)}</option>`;
}).join("");

if(!filtered.length){
box.innerHTML = `<div class="muted">No ABT courses in current filter.</div>`;
return;
}

box.innerHTML = `
<div class="row noprint" style="justify-content:space-between; align-items:flex-end; margin-bottom:8px">
<div class="muted mini">Bulk tools: select rows → set Line Listing category.</div>
<div class="row" style="gap:8px; flex-wrap:wrap">
<button class="smallbtn" onclick="openAbtSuggestionModal()">Review Suggestions</button>
<button class="smallbtn" onclick="abtSelectAllFiltered()">Select All</button>
<button class="smallbtn" onclick="abtSelectNone()">Select None</button>
<select id="abtBulkLL" style="min-width:190px">
<option value="">Set Line Listing…</option>
${llOpts.filter(x=>x).map(x=>`<option value="${escapeHtml(x)}">${escapeHtml(x)}</option>`).join("")}
</select>
<button class="smallbtn primary" onclick="abtBulkApplyLL()">Apply</button>
</div>
</div>

<table>
<thead><tr>
<th class="nowrap">Sel</th>
<th>Status</th><th>Resident</th><th>MRN</th><th>Unit</th><th>Room</th>
<th>Antibiotic</th><th>Start</th><th>End</th><th>Route</th>
<th>Indication</th>
<th class="nowrap">Source</th>
<th class="nowrap">Line Listing</th>
<th class="noprint">Suggest</th>
<th>Edit</th>
</tr></thead>
<tbody>
${filtered.slice(0,900).map(c=>`
<tr>
<td class="nowrap" style="text-align:center">
<input type="checkbox" ${c._sel ? "checked" : ""} onchange="abtToggleSel('${escapeHtml(c.id)}', this.checked)"/>
</td>
<td class="nowrap">${abtIsActiveCourse(c)?`<span class="badge blue">ACTIVE</span>`:`<span class="badge">HIST</span>`}</td>
<td>${escapeHtml(c.residentName||"")}</td>
<td class="nowrap">${escapeHtml(c.mrn||"")}</td>
<td class="nowrap">${escapeHtml(getUnitKeyFromAny(c.unit||"", s.config) || c.unit || "")}</td>
<td class="nowrap">${escapeHtml(c.room||"")}</td>
<td>${escapeHtml(c.antibiotic||"")}</td>
<td class="nowrap">${escapeHtml(c.startDate||"")}</td>
<td class="nowrap">${escapeHtml(c.endDate||"")}</td>
<td class="nowrap">${escapeHtml(c.route||"")}</td>
<td>${escapeHtml(c.indication||"")}</td>
<td class="nowrap"><select onchange="abtSetSource(\'${escapeHtml(c.id)}\', this.value)">${srcOptHtml(c.infectionSource||"")}</select></td>
<td class="nowrap">
<select onchange="abtSetLL(\'${escapeHtml(c.id)}\', this.value)">${optHtml(c.lineListing||"")}</select>
</td>
<td class="noprint nowrap"><button class="smallbtn" onclick="importAbtCourseToIp(\'${escapeHtml(c.id)}\')">Suggest</button></td>
<td class="nowrap"><button class="smallbtn" onclick="openAbtEditModal(\'${escapeHtml(c.id)}\')">Edit</button></td>
</tr>
`).join("")}
</tbody>
</table>
${filtered.length>900? `<div class="muted mini" style="margin-top:8px">Showing first 900 rows.</div>`:""}
`;

window.__abtFilteredIds = filtered.map(x=>x.id);
}

const __abtBtn = document.getElementById("btnAbtImport");
if(__abtBtn && !__abtBtn.dataset.bound){
__abtBtn.dataset.bound="1";
__abtBtn.addEventListener("click", openAbtImportModal);
}
const __abtToggle = document.getElementById("toggleAbtShowHistory");
if(__abtToggle && !__abtToggle.dataset.bound){
__abtToggle.dataset.bound="1";
__abtToggle.addEventListener("change", ()=> renderAll());
}

function openUnitResidentListModal(unitKey){
const s = Store.load();
const ids = s.census.activeResidentIds || [];
const rows = ids.map(id=>s.residentsById[id]).filter(Boolean).filter(r=>{
const uk = getUnitKeyFromAny(r.unit||r.lockedUnit||"", s.config) || inferUnitFromRoom(r.room||r.lockedRoom||"", s.config) || "";
return uk === unitKey;
}).sort((a,b)=> (a.room||"").localeCompare(b.room||"", undefined, {numeric:true}) || (a.name||"").localeCompare(b.name||""));

const unitName = (s.config.units||[]).find(u=>u.unitKey===unitKey)?.unitName || unitKey;
openModal(`${unitName} — Active Census (${rows.length})`, `
<div class="muted mini">Sorted by room.</div>
<div class="sep"></div>
${rows.length ? `
<table>
<thead><tr><th>Room</th><th>Name</th><th>MRN</th><th>Profile</th></tr></thead>
<tbody>
${rows.map(r=>`
<tr>
<td class="nowrap">${escapeHtml(r.room||"")}</td>
<td>${escapeHtml(r.name||"")}</td>
<td class="nowrap">${escapeHtml(r.mrn||"")}</td>
<td class="nowrap"><button class="smallbtn" onclick="openResidentProfileModal('${escapeHtml(r.id)}')">Open</button></td>
</tr>
`).join("")}
</tbody>
</table>
` : `<div class="muted">No active residents found for this unit.</div>`}
`);
}

function openResidentDrilldown(kind){
const s = Store.load();
const id = s.ui.selectedResidentId;
if(!id || !s.residentsById[id]) return;

const r = s.residentsById[id];

if(kind==="abtActive" || kind==="abtHistory"){
let rows = (s.modules.abt.courses||[]).filter(c=>c.residentId===id || (r.mrn && c.mrn===r.mrn));
if(kind==="abtActive") rows = rows.filter(c=>abtIsActiveCourse(c));
rows.sort((a,b)=> (mdyToISO(b.startDate)||"").localeCompare(mdyToISO(a.startDate)||""));
openModal(`${r.name||"Resident"} — ABT ${kind==="abtActive"?"Active":"History"} (${rows.length})`, `
${rows.length ? `
<table>
<thead><tr><th>Status</th><th>Antibiotic</th><th>Start</th><th>End</th><th>Route</th><th>Indication</th><th>Source</th></tr></thead>
<tbody>
${rows.map(c=>`
<tr>
<td class="nowrap">${abtIsActiveCourse(c)?`<span class="badge blue">ACTIVE</span>`:`<span class="badge">HIST</span>`}</td>
<td>${escapeHtml(c.antibiotic||"")}</td>
<td class="nowrap">${escapeHtml(c.startDate||"")}</td>
<td class="nowrap">${escapeHtml(c.endDate||"")}</td>
<td class="nowrap">${escapeHtml(c.route||"")}</td>
<td>${escapeHtml(c.indication||"")}</td>
<td>${escapeHtml(c.infectionSource||"")}</td>
</tr>
`).join("")}
</tbody>
</table>
` : `<div class="muted">No ABT entries.</div>`}
`);
return;
}

if(kind==="ipActive"){
const rows = (s.modules.ip.precautions||[]).filter(p=>p.residentId===id && p.status==="active");
openModal(`${r.name||"Resident"} — Active Precautions (${rows.length})`, `
${rows.length ? `
<table>
<thead><tr><th>Type</th><th>Source</th><th>Start</th></tr></thead>
<tbody>
${rows.map(p=>`
<tr>
<td>${escapeHtml(p.type||"")}</td>
<td>${escapeHtml(p.infectedSource||"")}</td>
<td class="nowrap">${escapeHtml(p.startDate||"")}</td>
</tr>
`).join("")}
</tbody>
</table>
` : `<div class="muted">No active precautions.</div>`}
`);
return;
}

if(kind==="vax"){
const rows = (s.modules.vax.events||[]).filter(v=> v.residentId===id || (r.mrn && v.mrn===r.mrn))
.sort((a,b)=> (mdyToISO(b.date)||"").localeCompare(mdyToISO(a.date)||""));
openModal(`${r.name||"Resident"} — Vaccine Events (${rows.length})`, `
${rows.length ? `
<table>
<thead><tr><th>Date</th><th>Type</th><th>Status</th><th>Notes</th></tr></thead>
<tbody>
${rows.map(v=>`
<tr>
<td class="nowrap">${escapeHtml(v.date||"")}</td>
<td>${escapeHtml(v.vaccineType||"")}</td>
<td class="nowrap">${escapeHtml(v.status||"")}</td>
<td>${escapeHtml(v.notes||"")}</td>
</tr>
`).join("")}
</tbody>
</table>
` : `<div class="muted">No vaccine events.</div>`}
`);
return;
}
}


function profileQuickAdd(kind, residentId){
  try{
    closeModal();
  }catch(e){}
  try{
    if(kind==="vax"){
      setTab("vax");
      setTimeout(()=> openAddVaxModalForResident(residentId), 0);
      return;
    }
    if(kind==="ipcase"){
      setTab("ip");
      setTimeout(()=> {
        try{ openIpCaseModal(null); }catch(e){}
        // preselect resident after modal opens
        setTimeout(()=>{ try{ const sel=document.getElementById("ipCase_res_select"); if(sel){ sel.value=residentId; sel.dispatchEvent(new Event("change")); } }catch(e){} }, 50);
      }, 0);
      return;
    }
    if(kind==="outbreak"){
      // outbreak case-first lives in Reports/Outbreak block; open modal directly
      setTab("reports");
      setTimeout(()=>{
        try{ openAddOutbreakCaseModal(); }catch(e){}
        setTimeout(()=>{ try{ const sel=document.getElementById("ob_res_select"); if(sel){ sel.value=residentId; sel.dispatchEvent(new Event("change")); } }catch(e){} }, 50);
      }, 0);
      return;
    }
    if(kind==="prec"){
      setTab("ip");
      setTimeout(()=> openAddPrecautionModal(residentId), 0);
      return;
    }
  }catch(e){}
}

function openResidentProfileModal(residentId){
const s = Store.load();
const r = s.residentsById[residentId];
if(!r){ alert("Resident not found."); return; }

const isDis = r.status && r.status!=="active";
const room = isDis ? (r.lockedRoom||r.room||"") : (r.room||"");
const unit = isDis ? (r.lockedUnit||r.unit||"") : (r.unit||"");
const notes = Array.isArray(r.profileNotesLog) ? r.profileNotesLog : [];

const abtAll = (s.modules.abt.courses||[]).filter(c=>c.residentId===residentId || (r.mrn && c.mrn===r.mrn));
const abtActive = abtAll.filter(c=>abtIsActiveCourse(c));
const ipActive = (s.modules.ip.precautions||[]).filter(p=>p.residentId===residentId && p.status==="active");
const vaxAll = (s.modules.vax.events||[]).filter(v=> v.residentId===residentId || (r.mrn && v.mrn===r.mrn))
.sort((a,b)=> (mdyToISO(b.date)||"").localeCompare(mdyToISO(a.date)||""));

openModal(`${r.name||"Resident"} — Profile`, `
<div class="grid cols2">
<div class="card" style="box-shadow:none">
<h3>Resident Details</h3>
<div class="row" style="gap:8px; flex-wrap:wrap; margin:8px 0 10px">
  <span class="badge">Quick Add</span>
  <button class="smallbtn" onclick="profileQuickAdd('vax', '${escapeHtml(residentId)}')">Add Vax</button>
  <button class="smallbtn" onclick="profileQuickAdd('ipcase', '${escapeHtml(residentId)}')">Add Line List Case</button>
  <button class="smallbtn" onclick="profileQuickAdd('outbreak', '${escapeHtml(residentId)}')">Add Outbreak Case</button>
  <button class="smallbtn" onclick="profileQuickAdd('prec', '${escapeHtml(residentId)}')">Add Precaution</button>
</div>
<div class="grid cols2">
<div><label>Name</label><input id="prof_name" type="text" value="${escapeHtml(r.name||"")}"/></div>
<div><label>MRN</label><input id="prof_mrn" type="text" value="${escapeHtml(r.mrn||"")}"/></div>
</div>
<div class="grid cols3" style="margin-top:10px">
<div><label>Room</label><input id="prof_room" type="text" value="${escapeHtml(room)}"/></div>
<div><label>Unit</label><input id="prof_unit" type="text" value="${escapeHtml(unit)}"/></div>
<div><label>DOB</label><input id="prof_dob" type="text" value="${escapeHtml(r.dob||"")}"/></div>
</div>
<div style="margin-top:10px">
<label>Payor Source</label><input id="prof_payor" type="text" value="${escapeHtml(r.payorSource||"")}"/>
</div>
<div class="sep"></div>
<div class="row end">
<button class="btn primary" onclick="saveResidentProfileEdits('${escapeHtml(residentId)}')">Save Changes</button>
</div>
<div class="muted mini" style="margin-top:8px">${isDis ? "Discharged resident: Room/Unit edits update locked location for history." : "Active resident."}</div>
</div>

<div class="card" style="box-shadow:none">
<h3>Snapshot</h3>
<div class="row" style="gap:8px; flex-wrap:wrap">
<span class="badge blue">ABT Active: ${abtActive.length}</span>
<span class="badge">ABT History: ${abtAll.length}</span>
<span class="badge red">Active Precautions: ${ipActive.length}</span>
<span class="badge green">Vax Events: ${vaxAll.length}</span>
</div>
<div class="sep"></div>

<h3>Active Antibiotics</h3>
${abtActive.length ? `
<table>
<thead><tr><th>Antibiotic</th><th>Start</th><th>End</th><th>Source</th></tr></thead>
<tbody>
${abtActive.slice(0,8).map(c=>`
<tr><td>${escapeHtml(c.antibiotic||"")}</td><td class="nowrap">${escapeHtml(c.startDate||"")}</td><td class="nowrap">${escapeHtml(c.endDate||"")}</td><td>${escapeHtml(c.infectionSource||"")}</td></tr>
`).join("")}
</tbody>
</table>
` : `<div class="muted mini">None.</div>`}

<div class="sep"></div>
<h3>Most Recent Vaccines</h3>
${vaxAll.length ? `
<table>
<thead><tr><th>Date</th><th>Type</th><th>Status</th></tr></thead>
<tbody>
${vaxAll.slice(0,6).map(v=>`<tr><td class="nowrap">${escapeHtml(v.date||"")}</td><td>${escapeHtml(v.vaccineType||"")}</td><td class="nowrap">${escapeHtml(v.status||"")}</td></tr>`).join("")}
</tbody>
</table>
` : `<div class="muted mini">None.</div>`}
</div>
</div>

<div class="sep"></div>

<div class="card" style="box-shadow:none">
<h3>Admin Notes (Continuous)</h3>
<div class="muted mini">Add a new note each time you open the profile.</div>
<div class="sep"></div>
<textarea id="prof_newNote" placeholder="Type a new note..."></textarea>
<div class="row end" style="margin-top:8px">
<button class="btn primary" onclick="addResidentNote('${escapeHtml(residentId)}')">Add Note</button>
</div>
<div class="sep"></div>
${notes.length ? `
<table>
<thead><tr><th>Date/Time</th><th>Author</th><th>Note</th></tr></thead>
<tbody>
${notes.slice(0,30).map(n=>`
<tr>
<td class="nowrap">${escapeHtml(new Date(n.createdAt).toLocaleString())}</td>
<td class="nowrap">${escapeHtml(n.author||"Admin")}</td>
<td>${escapeHtml(n.text||"")}</td>
</tr>
`).join("")}
</tbody>
</table>
` : `<div class="muted">No notes yet.</div>`}
</div>
`);
}

window.saveResidentProfileEdits = function(residentId){
const name = (document.getElementById("prof_name").value||"").trim().replace(/\\s+/g," ");
const mrn  = (document.getElementById("prof_mrn").value||"").trim();
const room = normalizeRoomForEdit(document.getElementById("prof_room").value||"");
const unit = (document.getElementById("prof_unit").value||"").trim();
const dob  = (document.getElementById("prof_dob").value||"").trim();
const pay  = (document.getElementById("prof_payor").value||"").trim().replace(/\\s+/g," ");

Store.patch(s=>{
const r = s.residentsById[residentId];
if(!r) return;
r.name = name || r.name || "";
r.mrn  = mrn  || r.mrn  || "";
r.dob  = dob  || r.dob  || "";
r.payorSource = pay || r.payorSource || "";
const isDis = r.status && r.status!=="active";
if(isDis){
if(room) r.lockedRoom = room;
if(unit) r.lockedUnit = unit;
} else {
if(room) r.room = room;
if(unit) r.unit = unit;
}
r.updatedAt = nowISO();
});

closeModal();
};

window.addResidentNote = function(residentId){
const txt = (document.getElementById("prof_newNote").value||"").trim();
if(!txt){ alert("Type a note first."); return; }
Store.patch(s=>{
const r = s.residentsById[residentId];
if(!r) return;
if(!Array.isArray(r.profileNotesLog)) r.profileNotesLog = [];
r.profileNotesLog.unshift({ id: uid("note"), createdAt: nowISO(), author: getCurrentUserName(s), text: txt });
r.updatedAt = nowISO();
});
openResidentProfileModal(residentId);
};

window.abtToggleSel = function(courseId, on){
Store.patch(s=>{
const c = (s.modules.abt.courses||[]).find(x=>x.id===courseId);
if(c) c._sel = !!on;
});
};
window.abtSetLL = function(courseId, val){
Store.patch(s=>{
const c = (s.modules.abt.courses||[]).find(x=>x.id===courseId);
if(c) c.lineListing = (val||"");
});
}

window.abtSetSource = function(courseId, val){
Store.patch(s=>{
const c = (s.modules.abt.courses||[]).find(x=>x.id===courseId);
if(c) c.infectionSource = (val||"");
});
};

window.importAbtCourseToIp = function(courseId){
const s0 = Store.load();
ensureIpData(s0);
const c = (s0.modules.abt.courses||[]).find(x=>x.id===courseId);
if(!c){ alert("ABT course not found."); return; }
if(!(c.mrn||"")){ alert("MRN is required to suggest an IP case."); return; }

const ll = (c.lineListing||"");
const kind = (ll==="GI") ? "gi" : (ll==="Respiratory" ? "resp" : "");
if(!kind){
alert("Set Line Listing to Respiratory or GI first (then click Suggest).");
return;
}

const key = `${(c.mrn||"").toUpperCase()}|${kind}`;
const existing = new Set((s0.modules.ip.lineListCases||[]).map(x=>`${(x.mrn||"").toUpperCase()}|${x.kind}`));
if(existing.has(key)){
alert("An IP case already exists for this resident (same kind).");
return;
}

if(!confirm(`Create an IP case from this ABT course?\n\nResident: ${c.residentName||""}\nMRN: ${c.mrn||""}\nKind: ${ll}\nStart: ${c.startDate||""}`)) return;

withAudit("ABT Suggest (Single)", {courseId, kind}, ()=>Store.patch(s=>{
ensureIpData(s);
s.modules.ip.lineListCases.push({
id: uid("ipcase"),
kind,
status: "active",
onsetDate: c.startDate || "",
name: c.residentName || "",
mrn: (c.mrn||"").toUpperCase(),
room: c.room || "",
unit: c.unit || "",
antibiotic: c.antibiotic || "",
lab: "",
symptoms: [],
notes: c.indication ? `ABT: ${c.indication}` : "",
createdAt: nowISO(),
updatedAt: nowISO(),
source: "ABT_SUGGEST"
});
}));

toast("Suggested case created.");
setTab("ip");
setIpView(kind==="gi" ? "gi" : "resp");
};

;

function abtLLToIpKind(ll){
const x = (ll||"").toLowerCase();
if(x.includes("gi")) return "gi";
if(x.includes("resp")) return "resp";
return "";
}
function ipHasActiveCaseForMrn(s, mrn, kind){
ensureIpData(s);
const key = (mrn||"").trim().toUpperCase();
if(!key) return false;
return (s.modules.ip.lineListCases||[]).some(c=>{
if((c.status||"active")==="resolved") return false;
const ck = (c.mrn||"").trim().toUpperCase();
if(ck!==key) return false;
if(kind && (c.kind||"")!==kind) return false;
return true;
});
}

window.abtCreateIpCaseFromCourse = function(courseId){
const s = Store.load();
const c = (s.modules.abt?.courses||[]).find(x=>x.id===courseId);
if(!c){ alert("ABT course not found."); return; }
const kind = abtLLToIpKind(c.lineListing||"");
if(!kind){ alert("Set Line Listing to Respiratory or GI first."); return; }

if(ipHasActiveCaseForMrn(s, c.mrn, kind)){
if(!confirm("An active IP case already exists for this MRN/type. Create another anyway?")) return;
}

withAudit("ABT → Create IP Case", {mrn:c.mrn, kind}, ()=>Store.patch(st=>{
ensureIpData(st);
st.ui.unitFilter = getUnitKeyFromAny(c.unit||"", st.config) || c.unit || st.ui.unitFilter || "ALL";
st.modules.ip.ui.view = kind;
}));
if(typeof setTab==="function") setTab("ip");

setTimeout(()=>{
openIpCaseModal(null);
setTimeout(()=>{
const setv = (id,val)=>{ const el=document.getElementById(id); if(el) el.value = val||""; };
setv("ipCase_kind", kind);
const onsetISO = mdyToISO(c.startDate||"") || (c.startDate||"");
setv("ipCase_onset", onsetISO);
setv("ipCase_status", "active");
setv("ipCase_name", c.residentName||"");
setv("ipCase_mrn", c.mrn||"");
setv("ipCase_room", (c.room||"").toUpperCase());
setv("ipCase_unit", getUnitKeyFromAny(c.unit||"", Store.load().config) || c.unit || "");
setv("ipCase_abx", c.antibiotic||"");
const note = `Suggested from ABT start ${c.startDate||""} (${c.antibiotic||""}). Source: ${c.infectionSource||""}.`;
const n = document.getElementById("ipCase_notes");
if(n) n.value = (n.value||"") ? (n.value + "\n" + note) : note;
}, 80);
}, 100);
};

window.openAbtSuggestionModal = function(){
const s = Store.load();
ensureIpData(s);
const unitFilter = s.ui.unitFilter || "ALL";
const activeOnly = !(document.getElementById("toggleAbtShowHistory")?.checked);

let rows = (s.modules.abt?.courses||[]).slice();
if(unitFilter!=="ALL"){
rows = rows.filter(c=>{
const uk = getUnitKeyFromAny(c.unit||"", s.config) || c.unit || "";
return uk===unitFilter;
});
}
if(activeOnly) rows = rows.filter(c=>abtIsActiveCourse(c));

const cand = rows.filter(c=>{
const k = abtLLToIpKind(c.lineListing||"");
return (k==="resp" || k==="gi");
}).map(c=>{
const k = abtLLToIpKind(c.lineListing||"");
const has = ipHasActiveCaseForMrn(s, c.mrn, k);
return Object.assign({}, c, {__kind:k, __has:has});
}).sort((a,b)=> (a.__has===b.__has?0:(a.__has?1:-1)) || (a.room||"").localeCompare(b.room||"", undefined, {numeric:true}));

const unitPretty = (unitFilter==="ALL" ? "All Units" : unitNamePretty(s, unitFilter));
const title = `ABT → Line Listing Suggestions (${unitPretty})`;

setDrilldownExport({
type:"abt_ll_suggestions",
title,
subtitle:"ABT courses flagged Respiratory/GI in Line Listing; create IP cases as needed.",
columns:[
{key:"status",label:"Status"},
{key:"room",label:"Room"},
{key:"resident",label:"Resident"},
{key:"mrn",label:"MRN"},
{key:"unit",label:"Unit"},
{key:"antibiotic",label:"Antibiotic"},
{key:"start",label:"Start"},
{key:"source",label:"Source"},
{key:"lineListing",label:"Line Listing"},
{key:"ipCase",label:"IP Case Exists"}
],
rows: cand.map(c=>({
status: abtIsActiveCourse(c) ? "ACTIVE" : "HIST",
room: (c.room||"").toUpperCase(),
resident: c.residentName||"",
mrn: c.mrn||"",
unit: unitNamePretty(s, getUnitKeyFromAny(c.unit||"", s.config) || c.unit || ""),
antibiotic: c.antibiotic||"",
start: c.startDate||"",
source: c.infectionSource||"",
lineListing: c.lineListing||"",
ipCase: c.__has ? "Yes" : "No"
}))
});

openModal(title, `
<div class="row end noprint" style="gap:8px">
<button class="smallbtn" onclick="printDrilldown()">Print</button>
<button class="smallbtn" onclick="exportDrilldownCSV()">Export CSV</button>
</div>
<div class="muted mini">This list is ABT-only. “IP Case Exists” checks active IP line list by MRN + type.</div>
<div class="sep"></div>
${cand.length?`
<table>
<thead><tr>
<th style="width:70px">Room</th>
<th>Resident</th>
<th style="width:120px">MRN</th>
<th style="width:110px">Unit</th>
<th style="width:170px">Antibiotic</th>
<th style="width:110px">Start</th>
<th style="width:150px">Source</th>
<th style="width:120px">Line List</th>
<th style="width:110px">IP Case?</th>
<th class="noprint edit-only" style="width:140px">Action</th>
</tr></thead>
<tbody>
${cand.slice(0,300).map(c=>`
<tr>
<td class="nowrap">${escapeHtml((c.room||"").toUpperCase())}</td>
<td>${escapeHtml(c.residentName||"")}</td>
<td class="nowrap">${escapeHtml(c.mrn||"")}</td>
<td class="nowrap">${escapeHtml(unitNamePretty(s, getUnitKeyFromAny(c.unit||"", s.config) || c.unit || ""))}</td>
<td>${escapeHtml(c.antibiotic||"")}</td>
<td class="nowrap">${escapeHtml(c.startDate||"")}</td>
<td>${escapeHtml(c.infectionSource||"")}</td>
<td class="nowrap"><span class="badge">${escapeHtml(c.lineListing||"")}</span></td>
<td class="nowrap">${c.__has?'<span class="badge green">Yes</span>':'<span class="badge red">No</span>'}</td>
<td class="noprint edit-only nowrap">
<button class="smallbtn" onclick="abtCreateIpCaseFromCourse('${escapeHtml(c.id)}')">Create IP Case</button>
</td>
</tr>
`).join("")}
</tbody>
</table>
${cand.length>300?'<div class="muted mini" style="margin-top:8px">Showing first 300 rows.</div>':""}
`:`<div class="muted">No ABT courses flagged for respiratory/GI line listing in this scope.</div>`}
`);
};

window.abtSelectAllFiltered = function(){
const ids = window.__abtFilteredIds || [];
Store.patch(s=>{
(s.modules.abt.courses||[]).forEach(c=>{
if(ids.includes(c.id)) c._sel = true;
});
});
};
window.abtSelectNone = function(){
Store.patch(s=>{
(s.modules.abt.courses||[]).forEach(c=>{ c._sel = false; });
});
};
window.abtBulkApplyLL = function(){
const sel = document.getElementById("abtBulkLL");
const val = sel ? (sel.value||"") : "";
if(!val){ alert("Choose a Line Listing category first."); return; }
Store.patch(s=>{
(s.modules.abt.courses||[]).forEach(c=>{
if(c._sel) c.lineListing = val;
});
s.modules.abt.lastBulkLineListingAt = nowISO();
});
};

function parseRoomInventoryText(txt){
const lines = (txt||"").toString().replace(/\r/g,"").split("\n")
.map(l=>l.trim().toUpperCase())
.filter(l=>l);
return Array.from(new Set(lines.map(l=>{
const m=l.match(/^(\d{2,3})\s*-\s*([A-Z])$/);
return m ? `${m[1]}-${m[2]}` : l.replace(/\s+/g,"");
}))).sort((a,b)=>a.localeCompare(b, undefined, {numeric:true}));
}

function getKnownRoomsFromDatabase(s){
const set = new Set();
Object.values(s.residentsById||{}).forEach(r=>{
const a = (r.room||"").toString().trim().toUpperCase();
const b = (r.lockedRoom||"").toString().trim().toUpperCase();
if(a) set.add(a);
if(b) set.add(b);
});
return Array.from(set).sort((a,b)=>a.localeCompare(b, undefined, {numeric:true}));
}

function getRoomInventory(s){
const txt = (s.config.roomInventoryText||"").toString();
const inv = parseRoomInventoryText(txt);
if(inv.length) return { rooms: inv, mode: "inventory" };
const known = getKnownRoomsFromDatabase(s);
return { rooms: known, mode: "known" };
}

function getOccupiedRoomsActive(s){
const set = new Set();
(s.census.activeResidentIds||[]).forEach(id=>{
const r = s.residentsById[id];
if(!r) return;
const room = (r.room||"").toString().trim().toUpperCase();
if(room) set.add(room);
});
return set;
}

function getEmptyRoomsSnapshot(s){
const activeCount = (s.census.activeResidentIds||[]).length;
const totalCap = Number(s.config.totalCapacity||0);
const emptyBeds = totalCap ? Math.max(0, totalCap - activeCount) : null;

const inv = getRoomInventory(s);
const occupied = getOccupiedRoomsActive(s);

let emptyRooms = [];
if(inv.rooms.length){
emptyRooms = inv.rooms.filter(r=>!occupied.has(r));
}

return { emptyBeds, emptyRooms, inventoryMode: inv.mode, inventoryCount: inv.rooms.length, occupiedRoomsCount: occupied.size };
}

function openEmptyRoomsModal(){
const s = Store.load();
const snap = getEmptyRoomsSnapshot(s);

const groups = {};
(snap.emptyRooms||[]).forEach(room=>{
const uk = inferUnitFromRoom(room, s.config) || "—";
if(!groups[uk]) groups[uk] = [];
groups[uk].push(room);
});

const order = Object.keys(groups).sort((a,b)=>a.localeCompare(b));
const inventoryNote = snap.inventoryMode==="inventory"
? `Using Room Inventory (${snap.inventoryCount} rooms).`
: `Room Inventory not set — using known rooms (${snap.inventoryCount}). For full accuracy, set Room Inventory in Facility Config.`;

openModal(`Empty Rooms/Beds`, `
<div class="muted mini">${escapeHtml(inventoryNote)}</div>
<div class="muted mini" style="margin-top:4px">
${snap.emptyBeds===null ? "Total capacity not set — cannot calculate empty beds count." : `Empty beds (capacity-based): <b>${snap.emptyBeds}</b>`}
</div>
<div class="sep"></div>

${snap.emptyRooms.length ? `
${order.map(k=>`
<div class="row" style="justify-content:space-between; align-items:flex-end">
<div style="font-weight:900">${escapeHtml(k)}</div>
<div class="muted mini">${groups[k].length} empty</div>
</div>
<div class="sep"></div>
<div class="row" style="gap:6px; flex-wrap:wrap; margin-bottom:10px">
${groups[k].sort((a,b)=>a.localeCompare(b, undefined, {numeric:true})).map(r=>`<span class="badge">${escapeHtml(r)}</span>`).join("")}
</div>
`).join("")}
` : `
<div class="muted">No empty rooms detected from the current room list source.</div>
<div class="muted mini" style="margin-top:8px">
If this looks wrong, set a complete Room Inventory in Facility Config.
</div>
`}
`);
}

(function(){
const __emptyBtn = document.getElementById("goEmptyRooms");
if(__emptyBtn && !__emptyBtn.dataset.bound){
__emptyBtn.dataset.bound="1";
__emptyBtn.addEventListener("click", openEmptyRoomsModal);
}
})();

function ensureDefaultUsers(s){
if(!s.config) s.config = {};
if(!s.config.floorMap) s.config.floorMap = {};
if(!Array.isArray(s.config.users) || s.config.users.length===0){
s.config.users = [{ id: uid("usr"), name: "Admin", role: "Admin" }];
}
if(!s.config.currentUserId){
s.config.currentUserId = s.config.users[0].id;
}
}
function getCurrentUserName(s){
ensureDefaultUsers(s);
const u = (s.config.users||[]).find(x=>x.id===s.config.currentUserId);
return u ? (u.name||"Admin") : "Admin";
}
function renderUsersConfig(s){
const sel = document.getElementById("cfgCurrentUser");
if(!sel) return;
ensureDefaultUsers(s);
const users = s.config.users || [];
sel.innerHTML = users.map(u=>`<option value="${escapeHtml(u.id)}">${escapeHtml(u.name||"User")}${u.role?` — ${escapeHtml(u.role)}`:""}</option>`).join("");
if(s.config.currentUserId) sel.value = s.config.currentUserId;

if(!sel.dataset.bound){
sel.dataset.bound="1";
sel.addEventListener("change", ()=>{
const id = sel.value;
Store.patch(st=>{ ensureDefaultUsers(st); st.config.currentUserId = id; });
});
}

const addBtn = document.getElementById("btnCfgAddUser");
const rmBtn  = document.getElementById("btnCfgRemoveUser");
if(addBtn && !addBtn.dataset.bound){
addBtn.dataset.bound="1";
addBtn.addEventListener("click", ()=>{
const name = (document.getElementById("cfgNewUserName")?.value||"").trim();
const role = (document.getElementById("cfgNewUserRole")?.value||"").trim();
if(!name){ alert("Enter a user name."); return; }
Store.patch(st=>{
ensureDefaultUsers(st);
st.config.users.push({ id: uid("usr"), name, role });
st.config.currentUserId = st.config.users[st.config.users.length-1].id;
});
const n=document.getElementById("cfgNewUserName"); if(n) n.value="";
const r=document.getElementById("cfgNewUserRole"); if(r) r.value="";
safeRenderAll();
});
}
if(rmBtn && !rmBtn.dataset.bound){
rmBtn.dataset.bound="1";
rmBtn.addEventListener("click", ()=>{
const id = sel.value;
if(!id) return;
if(!confirm("Remove selected user?")) return;
Store.patch(st=>{
ensureDefaultUsers(st);
st.config.users = (st.config.users||[]).filter(u=>u.id!==id);
if(st.config.users.length===0){
st.config.users = [{ id: uid("usr"), name: "Admin", role: "Admin" }];
}
st.config.currentUserId = st.config.users[0].id;
});
safeRenderAll();
});
}
}

function parseRoomInventoryText(txt){
const lines = (txt||"").toString().replace(/\r/g,"").split("\n")
.map(l=>l.trim().toUpperCase())
.filter(Boolean);
return Array.from(new Set(lines.map(l=>{
const m=l.match(/^(\d{2,3})\s*-\s*([A-Z])$/);
return m ? `${m[1]}-${m[2]}` : l.replace(/\s+/g,"");
}))).sort((a,b)=>a.localeCompare(b, undefined, {numeric:true}));
}
function getKnownRoomsFromDatabase(s){
const set = new Set();
Object.values(s.residentsById||{}).forEach(r=>{
const a = (r.room||"").toString().trim().toUpperCase();
const b = (r.lockedRoom||"").toString().trim().toUpperCase();
if(a) set.add(a);
if(b) set.add(b);
});
return Array.from(set).sort((a,b)=>a.localeCompare(b, undefined, {numeric:true}));
}
function getRoomInventory(s){
const txt = (s.config.roomInventoryText||"").toString();
const inv = parseRoomInventoryText(txt);
if(inv.length) return { rooms: inv, mode: "inventory" };
const known = getKnownRoomsFromDatabase(s);
return { rooms: known, mode: "known" };
}
function getOccupiedRoomsActive(s){
const set = new Set();
(s.census.activeResidentIds||[]).forEach(id=>{
const r = s.residentsById[id];
if(!r) return;
const room = (r.room||"").toString().trim().toUpperCase();
if(room) set.add(room);
});
return set;
}
function getEmptyRoomsSnapshot(s){
const activeCount = (s.census.activeResidentIds||[]).length;
const totalCap = Number(s.config.totalCapacity||0);
const emptyBeds = totalCap ? Math.max(0, totalCap - activeCount) : null;

const inv = getRoomInventory(s);
const occupied = getOccupiedRoomsActive(s);
const emptyRooms = inv.rooms.filter(r=>!occupied.has(r));
return { emptyBeds, emptyRooms, inventoryMode: inv.mode, inventoryCount: inv.rooms.length };
}
function openEmptyRoomsModal(){
const s = Store.load();
const snap = getEmptyRoomsSnapshot(s);

const groups = {};
(snap.emptyRooms||[]).forEach(room=>{
const uk = inferUnitFromRoom(room, s.config) || "—";
if(!groups[uk]) groups[uk] = [];
groups[uk].push(room);
});
const order = Object.keys(groups).sort((a,b)=>a.localeCompare(b));

const note = snap.inventoryMode==="inventory"
? `Using Room Inventory (${snap.inventoryCount} rooms).`
: `Room Inventory not set — using known rooms (${snap.inventoryCount}).`;

openModal("Empty Rooms/Beds", `
<div class="muted mini">${escapeHtml(note)}</div>
<div class="muted mini" style="margin-top:4px">${snap.emptyBeds===null ? "Total capacity not set." : `Empty beds (capacity-based): <b>${snap.emptyBeds}</b>`}</div>
<div class="sep"></div>
${snap.emptyRooms.length ? order.map(k=>`
<div class="row" style="justify-content:space-between">
<div style="font-weight:900">${escapeHtml(k)}</div>
<div class="muted mini">${groups[k].length} empty</div>
</div>
<div class="sep"></div>
<div class="row" style="gap:6px; flex-wrap:wrap; margin-bottom:10px">
${groups[k].sort((a,b)=>a.localeCompare(b, undefined, {numeric:true})).map(r=>`<span class="badge">${escapeHtml(r)}</span>`).join("")}
</div>
`).join("") : `<div class="muted">No empty rooms detected.</div>`}
`);
}

function ipNormalizeYN(v){
const t = (v||"").toString().trim().toUpperCase();
if(t==="Y" || t==="YES" || t==="1" || t==="TRUE") return "Y";
if(t==="N" || t==="NO"  || t==="0" || t==="FALSE") return "N";
return "";
}
function ipBoolMark(v){ return v ? "X" : ""; }

function openIpILIPrintTemplate(){
const s = Store.load();
ensureIpData(s);
const unitFilter = s.ui.unitFilter || "ALL";
let cases = (s.modules.ip.lineListCases||[]).filter(c=>c.kind==="resp");
if(unitFilter!=="ALL"){
cases = cases.filter(c => (getUnitKeyFromAny(c.unit||"", s.config) || c.unit) === unitFilter);
}
cases.sort((a,b)=> (a.room||"").localeCompare(b.room||"", undefined, {numeric:true}) || (a.name||"").localeCompare(b.name||""));

const facility = s.config.facilityName || "FACILITY";
const today = new Date();
const dateStr = `${String(today.getMonth()+1).padStart(2,"0")}/${String(today.getDate()).padStart(2,"0")}/${today.getFullYear()}`;

const rows = cases.slice(0,12);
while(rows.length < 12) rows.push(null);

const body = `
<div class="center title" style="margin-top:6px">INFLUENZA-LIKE ILLNESS</div>
<div class="center sub" style="margin-top:2px">LINE LIST</div>

<div class="row" style="display:flex; justify-content:flex-end; gap:40px; margin-top:10px; font-weight:900">
<div>FACILITY: <span class="line">${escapeHtml(facility)}</span></div>
<div>DATE: <span class="line">${escapeHtml(dateStr)}</span></div>
</div>

<div style="height:10px"></div>

<table class="thin">
<thead>
<tr>
<th class="center" style="width:42px">Rm</th>
<th class="center" style="width:34px"><span class="v">Age</span></th>
<th class="center" style="width:160px">Resident</th>

<th class="center" colspan="2" style="width:46px">Sex</th>

<th class="center" colspan="2" style="width:64px"><span class="v">Influenza<br/>Vaccine</span></th>
<th class="center" colspan="2" style="width:64px"><span class="v">Pneum<br/>Vaccine</span></th>

<th class="center" colspan="7">Predisposing Factors</th>

<th class="center" style="width:72px">Date<br/>of<br/>Onset</th>

<th class="center" colspan="6">Symptoms</th>

<th class="center" style="width:70px">Duration<br/>of Fever</th>
<th class="center" style="width:60px">Hosp.<br/>Date</th>
<th class="center" style="width:60px">Date<br/>Died</th>
<th class="center" style="width:96px">Lab<br/>Results</th>
<th class="center" style="width:84px">Antibiotic</th>
<th class="center" style="width:52px">X-Ray</th>
<th class="center" style="width:70px">Pneumonia</th>
</tr>
<tr>
<th></th><th></th><th></th>

<th class="center" style="width:22px">M</th>
<th class="center" style="width:22px">F</th>

<th class="center" style="width:32px">Y</th>
<th class="center" style="width:32px">N</th>
<th class="center" style="width:32px">Y</th>
<th class="center" style="width:32px">N</th>

<th class="center" style="width:22px"><span class="v">CVD</span></th>
<th class="center" style="width:22px"><span class="v">COPD</span></th>
<th class="center" style="width:22px"><span class="v">DM</span></th>
<th class="center" style="width:22px"><span class="v">Anemia</span></th>
<th class="center" style="width:22px"><span class="v">Renal</span></th>
<th class="center" style="width:22px"><span class="v">CA</span></th>
<th class="center" style="width:22px"><span class="v">Steroids</span></th>

<th></th>

<th class="center" style="width:52px"><span class="v">Highest<br/>Temp</span></th>
<th class="center" style="width:22px"><span class="v">Cough</span></th>
<th class="center" style="width:22px"><span class="v">Congest</span></th>
<th class="center" style="width:22px"><span class="v">Sore<br/>Throat</span></th>
<th class="center" style="width:22px"><span class="v">Pharyngit</span></th>
<th class="center" style="width:22px"><span class="v">Rhinitis</span></th>
<th class="center" style="width:22px"><span class="v">Headach</span></th>

<th></th><th></th><th></th><th></th><th></th><th></th><th></th>
</tr>
</thead>
<tbody>
${rows.map(c=>{
if(!c){
return `<tr>
${"<td>&nbsp;</td>".repeat(1)}
<td></td><td></td>
<td></td><td></td>
<td></td><td></td><td></td><td></td>
${"<td></td>".repeat(7)}
<td></td>
${"<td></td>".repeat(7)}
<td></td><td></td><td></td><td></td><td></td><td></td><td></td>
</tr>`;
}
const r = (c.residentId && s.residentsById[c.residentId]) ? s.residentsById[c.residentId] : null;
const room = c.room || r?.room || r?.lockedRoom || "";
const name = c.name || r?.name || "";
const dob = c.dob || r?.dob || "";
const age = dob ? calcAgeFromMDY(dob) : "";
const sex = (c.sex||"").toUpperCase();
const flu = ipNormalizeYN(c.fluVax);
const pne = ipNormalizeYN(c.pneumoVax);

const pf = c.predispose || {};
const sx = c.symptoms || {};

return `<tr>
<td class="center">${escapeHtml(room)}</td>
<td class="center">${escapeHtml(age)}</td>
<td>${escapeHtml(name)}</td>

<td class="center">${sex==="M" ? "X":""}</td>
<td class="center">${sex==="F" ? "X":""}</td>

<td class="center">${flu==="Y" ? "X":""}</td>
<td class="center">${flu==="N" ? "X":""}</td>
<td class="center">${pne==="Y" ? "X":""}</td>
<td class="center">${pne==="N" ? "X":""}</td>

<td class="center">${ipBoolMark(!!pf.cvd)}</td>
<td class="center">${ipBoolMark(!!pf.copd)}</td>
<td class="center">${ipBoolMark(!!pf.dm)}</td>
<td class="center">${ipBoolMark(!!pf.anemia)}</td>
<td class="center">${ipBoolMark(!!pf.renal)}</td>
<td class="center">${ipBoolMark(!!pf.ca)}</td>
<td class="center">${ipBoolMark(!!pf.steroids)}</td>

<td class="center">${escapeHtml(c.onsetDate||"")}</td>

<td class="center">${escapeHtml(sx.highestTemp||"")}</td>
<td class="center">${ipBoolMark(!!sx.cough)}</td>
<td class="center">${ipBoolMark(!!sx.congestion)}</td>
<td class="center">${ipBoolMark(!!sx.soreThroat)}</td>
<td class="center">${ipBoolMark(!!sx.pharyngitis)}</td>
<td class="center">${ipBoolMark(!!sx.rhinitis)}</td>
<td class="center">${ipBoolMark(!!sx.headache)}</td>

<td class="center">${escapeHtml(c.durationFever||"")}</td>
<td class="center">${escapeHtml(c.hospDate||"")}</td>
<td class="center">${escapeHtml(c.dateDied||"")}</td>
<td>${escapeHtml(c.labResults||"")}</td>
<td>${escapeHtml(c.antibiotic||"")}</td>
<td class="center">${escapeHtml(c.xray||"")}</td>
<td class="center">${escapeHtml(c.pneumonia||"")}</td>
</tr>`;
}).join("")}
</tbody>
</table>
`;

openPrintWindow("ILI Line List", body, "");
}

function openIpDirectoryModal(kind){
kind = (kind||"").toLowerCase();
if(kind==="visitor") kind="visitors";

const s = Store.load();
ensureIpData(s);

const isStaff = kind==="staff";
const title = isStaff ? "Staff Directory" : "Visitor Directory";
const arr = isStaff ? (s.modules.ip.staff||[]) : (s.modules.ip.visitors||[]);
const rows = arr.slice().sort((a,b)=> (a.name||"").localeCompare(b.name||""));

openModal(title, `
<div class="muted mini">Used by Contact Tracing dropdowns.</div>
<div class="sep"></div>

<div class="grid cols3">
<div><label>Name</label><input id="dir_name" type="text" placeholder="Name..."/></div>
<div><label>${isStaff ? "Role" : "Relationship"}</label><input id="dir_role" type="text" placeholder="${isStaff ? "CNA / RN / RT / EVS" : "Family / Visitor"}"/></div>
<div><label>${isStaff ? "Unit" : "Phone (optional)"}</label><input id="dir_unit" type="text" placeholder="${isStaff ? "Unit 2 / U2" : ""}"/></div>
</div>

<div class="row end" style="margin-top:10px">
<button class="btn primary" onclick="addIpDirectoryEntry('${kind}')">Add</button>
</div>

<div class="sep"></div>

${rows.length ? `
<table>
<thead><tr><th>Name</th><th>${isStaff ? "Role" : "Relationship"}</th><th>${isStaff ? "Unit" : "Phone"}</th><th></th></tr></thead>
<tbody>
${rows.map(r=>`
<tr>
<td>${escapeHtml(r.name||"")}</td>
<td>${escapeHtml(r.role||"")}</td>
<td>${escapeHtml(r.unit||"")}</td>
<td class="nowrap"><button class="smallbtn danger" onclick="removeIpDirectoryEntry('${kind}','${escapeHtml(r.id)}')">Remove</button></td>
</tr>
`).join("")}
</tbody>
</table>
` : `<div class="muted">No entries yet.</div>`}
`);
}

window.addIpDirectoryEntry = function(kind){
const name = (document.getElementById("dir_name")?.value||"").trim();
const role = (document.getElementById("dir_role")?.value||"").trim();
const unit = (document.getElementById("dir_unit")?.value||"").trim();
if(!name){ alert("Enter a name."); return; }

Store.patch(s=>{
ensureIpData(s);
const arr = kind==="staff" ? s.modules.ip.staff : s.modules.ip.visitors;
arr.push({ id: uid(kind==="staff"?"stf":"vis"), name, role, unit, createdAt: nowISO() });
});

closeModal();
openIpDirectoryModal(kind);
};

window.removeIpDirectoryEntry = function(kind, id){
if(!confirm("Remove this entry?")) return;
Store.patch(s=>{
ensureIpData(s);
if(kind==="staff") s.modules.ip.staff = (s.modules.ip.staff||[]).filter(x=>x.id!==id);
else s.modules.ip.visitors = (s.modules.ip.visitors||[]).filter(x=>x.id!==id);
});
closeModal();
openIpDirectoryModal(kind);
};

function buildResidentOptions(s){
const ids = s.census.activeResidentIds||[];
const rows = ids.map(id=>s.residentsById[id]).filter(Boolean)
.sort((a,b)=> (a.room||"").localeCompare(b.room||"", undefined, {numeric:true}) || (a.name||"").localeCompare(b.name||""));
return `<option value="">— Select —</option>` + rows.map(r=>{
const label = `${r.room||"—"} — ${r.name||""} (${r.mrn||""})`;
return `<option value="${escapeHtml(r.id)}">${escapeHtml(label)}</option>`;
}).join("");
}
function buildSimpleOptions(arr){
const rows = (arr||[]).slice().sort((a,b)=> (a.name||"").localeCompare(b.name||""));
return `<option value="">— Select —</option>` + rows.map(r=>`<option value="${escapeHtml(r.id)}">${escapeHtml(r.name||"")}</option>`).join("");
}

function getCaseLabel(s, c){
if(!c) return "Manual";
const kind = ipCaseKindLabel(c.kind);
return `${kind}: ${c.name||""} (${c.room||""})`;
}

function getContactsForCase(s, caseId){
ensureIpData(s);
return (s.modules.ip.contacts||[]).filter(r=>(r.caseId||"")===caseId)
.sort((a,b)=> (b.exposureDate||b.date||"").localeCompare(a.exposureDate||a.date||""));
}

window.saveContactPlan = function(caseId){
const exposureStart = document.getElementById("ctw_start")?.value || "";
const exposureEnd = document.getElementById("ctw_end")?.value || "";
const monitoringFreq = document.getElementById("ctw_freq")?.value || "Each shift";
const monitoringEnd = document.getElementById("ctw_monEnd")?.value || "";
const testingPlan = (document.getElementById("ctw_testPlan")?.value||"").trim();
const testDueDate = document.getElementById("ctw_testDue")?.value || "";
const cohorting = (document.getElementById("ctw_cohort")?.value||"").trim();
const notes = (document.getElementById("ctw_notes")?.value||"").trim();

withAudit("Save Contact Plan", {caseId}, ()=>Store.patch(s=>{
ensureIpData(s);
s.modules.ip.contactPlans[caseId] = {exposureStart, exposureEnd, monitoringFreq, monitoringEnd, testingPlan, testDueDate, cohorting, notes, updatedAt:nowISO()};
}));
toast("Contact tracing plan saved.");
};

window.markContactCleared = function(recId){
withAudit("Contact cleared", {id:recId}, ()=>Store.patch(s=>{
ensureIpData(s);
const r = (s.modules.ip.contacts||[]).find(x=>x.id===recId);
if(r){
r.status = "Cleared";
r.clearedAt = nowISO();
}
}));
safeRenderAll();
};

function getExposureEventsForCase(s, caseId){
ensureIpData(s);
return (s.modules.ip.exposureEvents||[]).filter(e=>(e.caseId||"")===caseId)
.sort((a,b)=> ((b.startDate||"")+" "+(b.startTime||"")).localeCompare((a.startDate||"")+" "+(a.startTime||"")));
}
function uniqKey(p){ return `${p.type||""}:${p.id||p.name||""}`; }

function buildPeopleMultiSelect(s, selected){
const selSet = new Set((selected||[]).map(uniqKey));
const residents = Object.values(s.residentsById||{}).filter(r=>(r.status||"Active")==="Active")
.sort((a,b)=> (a.unit||"").localeCompare(b.unit||"") || (a.room||"").localeCompare(b.room||"", undefined, {numeric:true}) || (a.name||"").localeCompare(b.name||""));
const staff = (s.modules.ip.staff||[]).slice().sort((a,b)=> (a.name||"").localeCompare(b.name||""));
const vis = (s.modules.ip.visitors||[]).slice().sort((a,b)=> (a.name||"").localeCompare(b.name||""));

const mk = (type, id, label)=>{
const k = `${type}:${id}`;
const checked = selSet.has(k) ? "checked" : "";
return `<label class="chip" style="cursor:pointer; display:inline-flex; gap:8px; align-items:center; margin:4px 6px 0 0">
<input type="checkbox" class="pePick" data-type="${escapeHtml(type)}" data-id="${escapeHtml(id)}" data-label="${escapeHtml(label)}" ${checked}/>
<span>${escapeHtml(label)}</span>
</label>`;
};

const resHtml = residents.slice(0,250).map(r=>{
const label = `${r.name||""} — ${r.room||""} ${unitNamePretty(s,r.unit)||r.unit||""} (MRN ${r.mrn||""})`;
return mk("Resident", r.id, label);
}).join("") || `<div class="muted mini">No active residents.</div>`;

const staffHtml = staff.map(x=> mk("Staff", x.id||x.name, x.name||"")).join("") || `<div class="muted mini">No staff entries.</div>`;
const visHtml = vis.map(x=> mk("Visitor", x.id||x.name, x.name||"")).join("") || `<div class="muted mini">No visitor entries.</div>`;

return {resHtml, staffHtml, visHtml};
}

function readPickedPeople(){
const boxes = Array.from(document.querySelectorAll(".pePick"));
const out = [];
boxes.forEach(cb=>{
if(cb.checked){
out.push({type: cb.dataset.type||"", id: cb.dataset.id||"", name: cb.dataset.label||""});
}
});
const seen = new Set();
return out.filter(p=>{ const k=uniqKey(p); if(seen.has(k)) return false; seen.add(k); return true; });
}

function openExposureEventModal(caseId, eventId){
const s = Store.load();
ensureIpData(s);
const me = getCurrentUser(s);

const c = (s.modules.ip.lineListCases||[]).find(x=>x.id===caseId);
if(!c){ alert("Case not found."); return; }
const ev = eventId ? (s.modules.ip.exposureEvents||[]).find(x=>x.id===eventId) : null;

const today = dayISO(new Date());
const now = new Date();
const hh = String(now.getHours()).padStart(2,"0");
const mm = String(now.getMinutes()).padStart(2,"0");
const t = `${hh}:${mm}`;

const people = buildPeopleMultiSelect(s, ev?.people||[]);

openModal(`${eventId?"Edit":"Add"} Exposure Event`, `
<div class="muted mini">Log where/when/activity and link people involved. This becomes your outbreak investigation “who/where/when/what”.</div>
<div class="sep"></div>

<div class="grid cols3">
<div><label>Date</label><input id="pe_date" type="date" value="${escapeHtml(ev?.startDate||today)}"/></div>
<div><label>Start time</label><input id="pe_t1" type="time" value="${escapeHtml(ev?.startTime||t)}"/></div>
<div><label>End time</label><input id="pe_t2" type="time" value="${escapeHtml(ev?.endTime||"")}"/></div>
</div>

<div class="grid cols3" style="margin-top:10px">
<div style="grid-column: span 2"><label>Location</label><input id="pe_loc" type="text" value="${escapeHtml(ev?.location||"")}" placeholder="Dining room, therapy gym, Room 251, van, etc."/></div>
<div><label>Activity</label><input id="pe_act" type="text" value="${escapeHtml(ev?.activity||"")}" placeholder="Meal, group activity, therapy, visit"/></div>
</div>

<div style="margin-top:10px">
<label>Event note (reason/purpose)</label>
<input id="pe_note" type="text" value="${escapeHtml(ev?.note||"")}" placeholder="Why is this exposure event relevant? (cluster, shared meal, PPE breach, etc.)"/>
</div>

<div class="sep"></div>
<div class="grid cols2">
<div>
<div style="font-weight:900">Residents</div>
<div class="muted mini">Tip: you can link multiple residents at once.</div>
<div style="margin-top:6px; max-height:220px; overflow:auto; border:1px solid var(--line); border-radius:14px; padding:8px">${people.resHtml}</div>
</div>
<div>
<div style="font-weight:900">Staff / Visitors</div>
<div class="muted mini">Use Manage Staff/Visitors in Contact Tracing if list is empty.</div>
<div style="margin-top:6px; max-height:220px; overflow:auto; border:1px solid var(--line); border-radius:14px; padding:8px">
<div style="font-weight:900; margin-bottom:4px">Staff</div>
${people.staffHtml}
<div class="menudiv" style="margin:10px 0"></div>
<div style="font-weight:900; margin-bottom:4px">Visitors</div>
${people.visHtml}
</div>
</div>
</div>

<div class="sep"></div>
<div class="row end" style="gap:8px">
${eventId?`<button class="btn danger" onclick="deleteExposureEvent('${escapeHtml(eventId)}')">Delete</button>`:""}
<button class="btn" onclick="closeModal()">Cancel</button>
<button class="btn primary" onclick="saveExposureEvent('${escapeHtml(caseId)}','${escapeHtml(eventId||"")}')">Save</button>
</div>
`);
}

window.saveExposureEvent = function(caseId, eventId){
const date = document.getElementById("pe_date")?.value || "";
const startTime = document.getElementById("pe_t1")?.value || "";
const endTime = document.getElementById("pe_t2")?.value || "";
const location = (document.getElementById("pe_loc")?.value||"").trim();
const activity = (document.getElementById("pe_act")?.value||"").trim();
const note = (document.getElementById("pe_note")?.value||"").trim();
const people = readPickedPeople();

if(!date){ alert("Date is required."); return; }
if(!location && !activity && !people.length){ alert("Add at least a location/activity or select people."); return; }

withAudit("Save Exposure Event", {caseId, n:people.length}, ()=>Store.patch(s=>{
ensureIpData(s);
const me = getCurrentUser(s);
const arr = s.modules.ip.exposureEvents;
if(eventId){
const ev = arr.find(x=>x.id===eventId);
if(!ev) return;
Object.assign(ev, {caseId, startDate:date, startTime, endTime, location, activity, note, people, updatedAt:nowISO(), updatedBy:me.name||""});
} else {
arr.push({id:uid("pe"), caseId, startDate:date, startTime, endTime, location, activity, note, people, createdAt:nowISO(), updatedAt:nowISO(), createdBy:me.name||"", updatedBy:me.name||""});
}
}));
closeModal();
setTimeout(()=>openIpContactWorkspace(caseId), 50);
};

window.deleteExposureEvent = function(eventId){
if(!confirm("Delete this exposure event?")) return;
withAudit("Delete Exposure Event", {id:eventId}, ()=>Store.patch(s=>{
ensureIpData(s);
s.modules.ip.exposureEvents = (s.modules.ip.exposureEvents||[]).filter(x=>x.id!==eventId);
}));
closeModal();
};

function generateContactsFromEvent(caseId, eventId){
const s0 = Store.load();
ensureIpData(s0);

const ev = (s0.modules.ip.exposureEvents||[]).find(x=>x.id===eventId && (x.caseId||"")===caseId);
if(!ev){ alert("Exposure event not found."); return; }

const c = (s0.modules.ip.lineListCases||[]).find(x=>x.id===caseId);
const caseLabel = c ? getCaseLabel(s0, c) : "Manual";

const plan = s0.modules.ip.contactPlans?.[caseId] || {};
const exposureDate = ev.startDate || ev.date || "";
const location = ev.location || "";
const evNote = [ev.activity, ev.note].filter(Boolean).join(" — ").trim();

const people = (ev.people||[]);
if(!people.length){ alert("No linked people on this event yet."); return; }

const existing = (s0.modules.ip.contacts||[]);
const key = (p)=> `${caseId}|${p.type||""}|${p.id||p.name||""}|${exposureDate}|${location}`;
const existingKeys = new Set(existing.map(r=> `${r.caseId||""}|${r.contactType||""}|${r.contactId||r.contactName||""}|${(r.exposureDate||r.date||"")}|${r.location||""}`));

const toAdd = people.filter(p=> !existingKeys.has(key(p)));
const skipped = people.length - toAdd.length;

if(!confirm(`Generate contact records for this exposure event?\n\nWill create: ${toAdd.length}\nSkipped duplicates: ${skipped}\n\nYou can edit details afterward.`)) return;

withAudit("Generate Contacts From Exposure Event", {caseId, eventId, create:toAdd.length, skipped}, ()=>Store.patch(s=>{
ensureIpData(s);
const me = getCurrentUser(s);
const arr = s.modules.ip.contacts;
const plan2 = s.modules.ip.contactPlans?.[caseId] || {};
const monFreq = plan2.monitoringFreq || "Each shift";
const monEnd = plan2.monitoringEnd || "";
const testDue = plan2.testDueDate || "";

toAdd.forEach(p=>{
let contactName = p.name || "";
let contactId = p.id || "";
let contactType = p.type || "Resident";

if(contactType==="Resident" && contactId){
const r = s.residentsById?.[contactId];
if(r) contactName = r.name || contactName;
}

if(contactType==="Staff" && contactId){
contactName = (s.modules.ip.staff||[]).find(x=>(x.id||x.name)===contactId)?.name || contactName;
}
if(contactType==="Visitor" && contactId){
contactName = (s.modules.ip.visitors||[]).find(x=>(x.id||x.name)===contactId)?.name || contactName;
}

arr.push({
id: uid("ct"),
caseId,
caseLabel,
exposureDate,
date: exposureDate,
contactType,
contactId,
contactName,
location,
monitoringFreq: monFreq,
monitoringEnd: monEnd,
testDueDate: testDue,
testResult: "",
status: "Monitoring",
outcome: "",
notes: evNote ? `From exposure event: ${evNote}` : "From exposure event",
linkNote: ev.note || ev.activity || "Generated from exposure event",
author: me.name||"",
createdAt: nowISO(),
updatedAt: nowISO()
});
});
}));

setTimeout(()=>openIpContactWorkspace(caseId), 80);
}

function printCaseAppendix(caseId){
const s = Store.load();
ensureIpData(s);
ensureConfig(s);

const c = (s.modules.ip.lineListCases||[]).find(x=>x.id===caseId);
if(!c){ alert("Case not found."); return; }

const events = getExposureEventsForCase(s, caseId);
const contacts = getContactsForCase(s, caseId);

const roster = [];
const addP = (p)=>{
if(!p) return;
const key = `${p.type||""}:${p.id||p.name||""}`;
if(roster.some(x=>`${x.type}:${x.id||x.name||""}`===key)) return;
roster.push(p);
};
events.forEach(ev=> (ev.people||[]).forEach(addP));
contacts.forEach(r=> addP({type:r.contactType||"", id:r.contactId||"", name:r.contactName||""}));

const byType = (t)=> roster.filter(p=>(p.type||"")===t).sort((a,b)=> (a.name||"").localeCompare(b.name||""));
const fmtRes = (p)=>{
const r = s.residentsById?.[p.id];
if(r) return `${r.name||p.name||""} — ${r.room||""} ${unitNamePretty(s,r.unit)||r.unit||""} (MRN ${r.mrn||""})`;
return p.name||"";
};

const title = `${s.config.facilityName||"Facility"} — Case Appendix`;
const caseLabel = `${ipCaseKindLabel(c.kind)}: ${c.name||""} (${c.room||""})`;
const body = `
<div class="title">${escapeHtml(title)}</div>
<div class="muted" style="margin-top:4px">${escapeHtml(caseLabel)} · MRN ${escapeHtml(c.mrn||"")} · ${escapeHtml(unitNamePretty(s,c.unit)||c.unit||"")}</div>
<div class="sep"></div>

<h3>Exposure Events (where/when/activity)</h3>
<table class="thin">
<thead><tr><th style="width:130px">Date</th><th style="width:110px">Start</th><th style="width:110px">End</th><th style="width:240px">Location</th><th style="width:180px">Activity</th><th>Note</th><th style="width:110px">Linked</th></tr></thead>
<tbody>
${events.length?events.map(ev=>`
<tr>
<td class="nowrap">${escapeHtml(ev.startDate||"")}</td>
<td class="nowrap">${escapeHtml(ev.startTime||"")}</td>
<td class="nowrap">${escapeHtml(ev.endTime||"")}</td>
<td>${escapeHtml(ev.location||"")}</td>
<td>${escapeHtml(ev.activity||"")}</td>
<td class="muted">${escapeHtml(ev.note||"")}</td>
<td class="nowrap">${(ev.people||[]).length}</td>
</tr>
`).join(""):`<tr><td colspan="7" class="muted">No exposure events recorded.</td></tr>`}
</tbody>
</table>

<div style="height:12px"></div>

<h3>Linked Roster (who)</h3>
<div class="grid cols2">
<div>
<div style="font-weight:900">Residents</div>
<ul class="mini">
${byType("Resident").length?byType("Resident").map(p=>`<li>${escapeHtml(fmtRes(p))}</li>`).join(""):`<li class="muted">None</li>`}
</ul>
</div>
<div>
<div style="font-weight:900">Staff</div>
<ul class="mini">
${byType("Staff").length?byType("Staff").map(p=>`<li>${escapeHtml(p.name||"")}</li>`).join(""):`<li class="muted">None</li>`}
</ul>
<div style="height:8px"></div>
<div style="font-weight:900">Visitors</div>
<ul class="mini">
${byType("Visitor").length?byType("Visitor").map(p=>`<li>${escapeHtml(p.name||"")}</li>`).join(""):`<li class="muted">None</li>`}
</ul>
</div>
</div>
`;
openPrintWindow("Case Appendix", body, `
@page{ size: letter; margin: 0.55in; }
body{ font-size: 12px; }
.title{ font-size: 18px; font-weight: 900; }
.sep{ height:1px; background:#d8dee8; margin:12px 0; }
table.thin th{ background:#f3f6fb; }
ul{ margin:6px 0 0 18px; }
`);
}

function printOutbreakPacket(kind, unit, startISO, endISO){
const s = Store.load();
ensureConfig(s);
ensureIpData(s);

const start = (startISO||"").slice(0,10);
const end = (endISO||"").slice(0,10);
const k = kind || "resp";
const u = unit || "ALL";

let cases = (s.modules.ip.lineListCases||[]).filter(c=>c.kind===k);
if(u!=="ALL"){
cases = cases.filter(c => (getUnitKeyFromAny(c.unit||"", s.config) || c.unit) === u);
}
cases = cases.filter(c=>{
const d = (c.onsetDate || c.createdAt || "").slice(0,10);
if(!d) return false;
if(start && d < start) return false;
if(end && d > end) return false;
return true;
}).sort((a,b)=> (a.room||"").localeCompare(b.room||"", undefined, {numeric:true}) || (a.name||"").localeCompare(b.name||""));

const unitLabel = (u==="ALL") ? "All Units" : (unitNamePretty(s,u)||u);
const kindLabel = (k==="gi") ? "GI" : "Respiratory";
const rangeLabel = (start || end) ? `${start||"…"} to ${end||"…"}`
: "Current window";

const header = `
<div class="title">${escapeHtml(s.config.facilityName||"Facility")} — Outbreak Packet</div>
<div class="muted" style="margin-top:4px">
<b>${escapeHtml(kindLabel)}</b> · ${escapeHtml(unitLabel)} · ${escapeHtml(rangeLabel)}
</div>
<div class="muted mini" style="margin-top:6px">Includes: case list + exposure events + linked roster per case.</div>
<div class="sep"></div>
`;

const caseTable = `
<h3>Case List</h3>
<table class="thin">
<thead><tr>
<th style="width:70px">Room</th>
<th>Resident</th>
<th style="width:120px">MRN</th>
<th style="width:110px">Onset</th>
<th style="width:160px">ABT</th>
</tr></thead>
<tbody>
${cases.length?cases.map(c=>`
<tr>
<td class="nowrap">${escapeHtml(c.room||"")}</td>
<td>${escapeHtml(c.name||"")}</td>
<td class="nowrap">${escapeHtml(c.mrn||"")}</td>
<td class="nowrap">${escapeHtml((c.onsetDate||c.createdAt||"").slice(0,10))}</td>
<td>${escapeHtml(c.antibiotic||"")}</td>
</tr>
`).join(""):`<tr><td colspan="5" class="muted">No cases in this window.</td></tr>`}
</tbody>
</table>
<div style="height:14px"></div>
`;

const sectionForCase = (c)=>{
const evs = getExposureEventsForCase(s, c.id);
const contacts = getContactsForCase(s, c.id);

const roster = [];
const addP = (p)=>{
if(!p) return;
const key = `${p.type||""}:${p.id||p.name||""}`;
if(roster.some(x=>`${x.type}:${x.id||x.name||""}`===key)) return;
roster.push(p);
};
evs.forEach(ev=> (ev.people||[]).forEach(addP));
contacts.forEach(r=> addP({type:r.contactType||"", id:r.contactId||"", name:r.contactName||""}));

const byType = (t)=> roster.filter(p=>(p.type||"")===t).sort((a,b)=> (a.name||"").localeCompare(b.name||""));
const fmtRes = (p)=>{
const r = s.residentsById?.[p.id];
if(r) return `${r.name||p.name||""} — ${r.room||""} ${unitNamePretty(s,r.unit)||r.unit||""} (MRN ${r.mrn||""})`;
return p.name||"";
};

return `
<div class="caseBlock">
<h3>${escapeHtml(ipCaseKindLabel(c.kind))}: ${escapeHtml(c.name||"")} (${escapeHtml(c.room||"")})</h3>
<div class="muted mini">MRN ${escapeHtml(c.mrn||"")} · Unit ${escapeHtml(unitNamePretty(s,c.unit)||c.unit||"")} · Onset ${(c.onsetDate||c.createdAt||"").slice(0,10)}</div>

<div style="height:10px"></div>
<div style="font-weight:900">Exposure Events</div>
<table class="thin">
<thead><tr><th style="width:110px">Date</th><th style="width:90px">Start</th><th style="width:90px">End</th><th style="width:240px">Location</th><th style="width:180px">Activity</th><th>Note</th><th style="width:90px">Linked</th></tr></thead>
<tbody>
${evs.length?evs.map(ev=>`
<tr>
<td class="nowrap">${escapeHtml(ev.startDate||"")}</td>
<td class="nowrap">${escapeHtml(ev.startTime||"")}</td>
<td class="nowrap">${escapeHtml(ev.endTime||"")}</td>
<td>${escapeHtml(ev.location||"")}</td>
<td>${escapeHtml(ev.activity||"")}</td>
<td class="muted">${escapeHtml(ev.note||"")}</td>
<td class="nowrap">${(ev.people||[]).length}</td>
</tr>
`).join(""):`<tr><td colspan="7" class="muted">No exposure events recorded.</td></tr>`}
</tbody>
</table>

<div style="height:10px"></div>
<div style="font-weight:900">Linked Roster</div>
<div class="grid cols2">
<div>
<div style="font-weight:900">Residents</div>
<ul class="mini">
${byType("Resident").length?byType("Resident").map(p=>`<li>${escapeHtml(fmtRes(p))}</li>`).join(""):`<li class="muted">None</li>`}
</ul>
</div>
<div>
<div style="font-weight:900">Staff</div>
<ul class="mini">
${byType("Staff").length?byType("Staff").map(p=>`<li>${escapeHtml(p.name||"")}</li>`).join(""):`<li class="muted">None</li>`}
</ul>
<div style="height:8px"></div>
<div style="font-weight:900">Visitors</div>
<ul class="mini">
${byType("Visitor").length?byType("Visitor").map(p=>`<li>${escapeHtml(p.name||"")}</li>`).join(""):`<li class="muted">None</li>`}
</ul>
</div>
</div>

<div class="sep"></div>
</div>
`;
};

const body = header + caseTable + (cases.map(sectionForCase).join(""));
openPrintWindow("Outbreak Packet", body, `
@page{ size: letter landscape; margin: 0.45in; }
body{ font-size: 11px; }
.title{ font-size: 18px; font-weight: 900; }
.sep{ height:1px; background:#d8dee8; margin:12px 0; }
table.thin th{ background:#f3f6fb; }
th,td{ font-size: 11px; }
ul{ margin:6px 0 0 18px; }
.caseBlock{ page-break-inside: avoid; }
`);
}

function openIpContactWorkspace(caseId){
const s = Store.load();
ensureIpData(s);

const c = (s.modules.ip.lineListCases||[]).find(x=>x.id===caseId);
if(!c){ alert("Case not found."); return; }

const plan = s.modules.ip.contactPlans[caseId] || {
exposureStart:"",
exposureEnd:"",
monitoringFreq:"Each shift",
monitoringEnd:"",
testingPlan:"",
testDueDate:"",
cohorting:"",
notes:""
};

const rows = getContactsForCase(s, caseId);
const unitPretty = (getUnitKeyFromAny(c.unit||"", s.config) || c.unit || "");
const caseLabel = getCaseLabel(s, c);

setDrilldownExport({
type:"contact_workspace",
title:`Contact Tracing — ${caseLabel}`,
subtitle:`Unit ${unitPretty}`,
columns:[
{key:"exposureDate",label:"Exposure Date"},
{key:"contactType",label:"Type"},
{key:"contactName",label:"Contact"},
{key:"location",label:"Location"},
{key:"monitoringFreq",label:"Monitoring Freq"},
{key:"monitoringEnd",label:"Monitoring End"},
{key:"testDueDate",label:"Test Due"},
{key:"testResult",label:"Result"},
{key:"status",label:"Status"},
{key:"notes",label:"Notes"},
{key:"linkNote",label:"Linkage Note"}
],
rows: rows.map(r=>({
exposureDate:r.exposureDate||r.date||"",
contactType:r.contactType||"",
contactName:r.contactName||"",
location:r.location||"",
monitoringFreq:r.monitoringFreq||"",
monitoringEnd:r.monitoringEnd||"",
testDueDate:r.testDueDate||"",
testResult:r.testResult||"",
status:r.status||"",
notes:r.notes||"",
linkNote:r.linkNote||""
}))
});

const statusBadge = (st)=>{
const x = (st||"Monitoring");
const lc = x.toLowerCase();
const cls = lc.includes("cleared") ? "green" : (lc.includes("positive") ? "red" : (lc.includes("pending") ? "blue" : ""));
return `<span class="badge ${cls}">${escapeHtml(x)}</span>`;
};

openModal(`Contact Tracing — Case Workspace`, `
<div class="row" style="justify-content:space-between; align-items:flex-start; gap:10px">
<div>
<div style="font-weight:900; font-size:16px">${escapeHtml(caseLabel)}</div>
<div class="muted mini">MRN: <b>${escapeHtml(c.mrn||"")}</b> · Room: <b>${escapeHtml(c.room||"")}</b> · Unit: <b>${escapeHtml(unitPretty)}</b></div>
</div>
<div class="row noprint edit-only" style="gap:8px; flex-wrap:wrap">
<button class="smallbtn" onclick="printDrilldown()">Print</button>
<button class="smallbtn" onclick="exportDrilldownCSV()">Export CSV</button>
<button class="smallbtn" onclick="printCaseAppendix(\'${escapeHtml(caseId)}\')">Print Appendix</button>
<button class="btn" onclick="openExposureEventModal(\'${escapeHtml(caseId)}\', \'\')">Add Exposure Event</button>
<button class="btn" onclick="openIpContactRecordModal('${escapeHtml(caseId)}', '')">Add Contact</button>
</div>
</div>

<div class="sep"></div>

<div class="grid cols3">
<div>
<label>Exposure window start</label>
<input id="ctw_start" type="datetime-local" value="${escapeHtml(plan.exposureStart||"")}"/>
</div>
<div>
<label>Exposure window end</label>
<input id="ctw_end" type="datetime-local" value="${escapeHtml(plan.exposureEnd||"")}"/>
</div>
<div>
<label>Monitoring frequency</label>
<select id="ctw_freq">
${["Each shift","Daily","BID","TID","QID","Other"].map(x=>`<option value="${x}" ${(plan.monitoringFreq||"Each shift")===x?"selected":""}>${x}</option>`).join("")}
</select>
</div>
</div>

<div class="grid cols3" style="margin-top:10px">
<div>
<label>Monitoring end date</label>
<input id="ctw_monEnd" type="date" value="${escapeHtml(plan.monitoringEnd||"")}"/>
</div>
<div>
<label>Test due date</label>
<input id="ctw_testDue" type="date" value="${escapeHtml(plan.testDueDate||"")}"/>
</div>
<div>
<label>Testing plan</label>
<input id="ctw_testPlan" type="text" value="${escapeHtml(plan.testingPlan||"")}" placeholder="e.g., test contacts day 0/3/5"/>
</div>
</div>

<div style="margin-top:10px">
<label>Cohorting / Staff assignment notes</label>
<input id="ctw_cohort" type="text" value="${escapeHtml(plan.cohorting||"")}" placeholder="Cohort residents; staff to unit; visitor restrictions"/>
</div>

<div style="margin-top:10px">
<label>Plan notes</label>
<input id="ctw_notes" type="text" value="${escapeHtml(plan.notes||"")}" placeholder="Rationale, decisions, guidance used"/>
</div>

<div class="sep"></div>

<div class="row end noprint edit-only" style="gap:8px">
<button class="smallbtn" onclick="saveContactPlan('${escapeHtml(caseId)}')">Save Plan</button>
</div>

<div class="sep"></div>

<h3>Exposure Events (where/when/activity)</h3>
${ (function(){
const evs = getExposureEventsForCase(s, caseId);
if(!evs.length) return `<div class="muted">No exposure events yet. Use “Add Exposure Event”.</div>`;
return `
<div style="overflow:auto; border:1px solid var(--line); border-radius:14px">
<table>
<thead><tr>
<th style="width:110px">Date</th>
<th style="width:90px">Start</th>
<th style="width:90px">End</th>
<th style="width:220px">Location</th>
<th style="width:160px">Activity</th>
<th>Event Note</th>
<th style="width:90px">Linked</th>
<th style="width:160px" class="noprint edit-only">Actions</th>
</tr></thead>
<tbody>
${evs.map(ev=>`
<tr>
<td class="nowrap">${escapeHtml(ev.startDate||"")}</td>
<td class="nowrap">${escapeHtml(ev.startTime||"")}</td>
<td class="nowrap">${escapeHtml(ev.endTime||"")}</td>
<td>${escapeHtml(ev.location||"")}</td>
<td>${escapeHtml(ev.activity||"")}</td>
<td class="muted">${escapeHtml(ev.note||"")}</td>
<td class="nowrap">${(ev.people||[]).length}</td>
<td class="noprint edit-only nowrap">
<button class="smallbtn" onclick="openExposureEventModal('${escapeHtml(caseId)}','${escapeHtml(ev.id)}')">Edit</button>
<button class="smallbtn" onclick="generateContactsFromEvent('${escapeHtml(caseId)}','${escapeHtml(ev.id)}')">Generate Contacts</button>
</td>
</tr>
`).join("")}
</tbody>
</table>
</div>
`;
})()
}
<div class="sep"></div>
<h3>Contacts linked to this case</h3>
${rows.length ? `
<div style="overflow:auto; border:1px solid var(--line); border-radius:14px">
<table>
<thead><tr>
<th style="width:110px">Exposure</th>
<th style="width:120px">Type</th>
<th style="width:210px">Contact</th>
<th style="width:200px">Location</th>
<th style="width:130px">Monitoring</th>
<th style="width:120px">Mon End</th>
<th style="width:110px">Test Due</th>
<th style="width:120px">Result</th>
<th style="width:120px">Status</th>
<th>Notes</th>
<th style="width:160px" class="noprint edit-only">Actions</th>
</tr></thead>
<tbody>
${rows.map(r=>`
<tr>
<td class="nowrap">${escapeHtml(r.exposureDate||r.date||"")}</td>
<td class="nowrap">${escapeHtml(r.contactType||"")}</td>
<td>${escapeHtml(r.contactName||"")}</td>
<td>${escapeHtml(r.location||"")}</td>
<td class="nowrap">${escapeHtml(r.monitoringFreq||"")}</td>
<td class="nowrap">${escapeHtml(r.monitoringEnd||"")}</td>
<td class="nowrap">${escapeHtml(r.testDueDate||"")}</td>
<td class="nowrap">${escapeHtml(r.testResult||"")}</td>
<td class="nowrap">${statusBadge(r.status||"Monitoring")}</td>
<td class="muted">${escapeHtml(r.notes||"")}${r.linkNote?`<div class="mini">Linkage: ${escapeHtml(r.linkNote)}</div>`:""}</td>
<td class="noprint edit-only nowrap">
<button class="smallbtn" onclick="openIpContactRecordModal('${escapeHtml(caseId)}','${escapeHtml(r.id)}')">Edit</button>
<button class="smallbtn" onclick="markContactCleared('${escapeHtml(r.id)}')">Clear</button>
</td>
</tr>
`).join("")}
</tbody>
</table>
</div>
` : `<div class="muted">No contacts yet. Use “Add Contact”.</div>`}

<div class="sep"></div>
<div class="row end">
<button class="btn" onclick="closeModal()">Close</button>
</div>
`);
}

function openIpContactRecordModal(caseId, recId){
const s = Store.load();
ensureIpData(s);

const c = caseId ? (s.modules.ip.lineListCases||[]).find(x=>x.id===caseId) : null;
const caseLabel = c ? getCaseLabel(s,c) : "Manual";

const plan = caseId ? (s.modules.ip.contactPlans[caseId] || {}) : {};
const resOpts = buildResidentOptions(s);
const stfOpts = buildSimpleOptions(s.modules.ip.staff||[]);
const visOpts = buildSimpleOptions(s.modules.ip.visitors||[]);

const rec = recId ? (s.modules.ip.contacts||[]).find(x=>x.id===recId) : null;

openModal(`${recId?"Edit":"Add"} Contact Record`, `
<div class="muted mini">Use date pickers for survey-ready documentation.</div>
<div class="sep"></div>

<div class="grid cols3">
<div><label>Exposure Date</label><input id="ct_date" type="date" value="${escapeHtml(rec?.exposureDate || rec?.date || dayISO(new Date()))}"/></div>
<div><label>Case</label><input id="ct_case" type="text" value="${escapeHtml(caseLabel)}" disabled/></div>
<div><label>Contact Type</label>
<select id="ct_type" onchange="ctSyncPickers()">
<option value="Resident" ${(rec?.contactType||"Resident")==="Resident"?"selected":""}>Resident</option>
<option value="Staff" ${(rec?.contactType||"Resident")==="Staff"?"selected":""}>Staff</option>
<option value="Visitor" ${(rec?.contactType||"Resident")==="Visitor"?"selected":""}>Visitor</option>
</select>
</div>
</div>

<div class="grid cols3" style="margin-top:10px">
<div id="ct_pick_res">
<label>Pick Resident</label>
<select id="ct_resSel" onchange="ctApplyPicked('Resident')">${resOpts}</select>
</div>
<div id="ct_pick_staff" style="display:none">
<label>Pick Staff</label>
<select id="ct_staffSel" onchange="ctApplyPicked('Staff')">${stfOpts}</select>
<div class="muted mini" style="margin-top:6px"><a href="#" onclick="openIpDirectoryModal('staff');return false;">Manage Staff</a></div>
</div>
<div id="ct_pick_vis" style="display:none">
<label>Pick Visitor</label>
<select id="ct_visSel" onchange="ctApplyPicked('Visitor')">${visOpts}</select>
<div class="muted mini" style="margin-top:6px"><a href="#" onclick="openIpDirectoryModal('visitors');return false;">Manage Visitors</a></div>
</div>

<div style="grid-column: span 2">
<label>Contact Name (or manual)</label>
<input id="ct_name" type="text" value="${escapeHtml(rec?.contactName||"")}" placeholder="Name of contact..."/>
</div>
</div>

<div class="grid cols3" style="margin-top:10px">
<div><label>Location</label><input id="ct_loc" type="text" value="${escapeHtml(rec?.location||"")}" placeholder="Room/area of exposure"/></div>
<div><label>Monitoring frequency</label>
<select id="ct_freq">
${["Each shift","Daily","BID","TID","QID","Other"].map(x=>`<option value="${x}" ${(rec?.monitoringFreq||plan.monitoringFreq||"Each shift")===x?"selected":""}>${x}</option>`).join("")}
</select>
</div>
<div><label>Monitoring end</label><input id="ct_monEnd" type="date" value="${escapeHtml(rec?.monitoringEnd||plan.monitoringEnd||"")}"/></div>
</div>

<div class="grid cols3" style="margin-top:10px">
<div><label>Test due</label><input id="ct_testDue" type="date" value="${escapeHtml(rec?.testDueDate||plan.testDueDate||"")}"/></div>
<div><label>Test result</label>
<select id="ct_testRes">
${["","Pending","Negative","Positive","Not Done"].map(x=>`<option value="${x}" ${(rec?.testResult||"")===x?"selected":""}>${x||"—"}</option>`).join("")}
</select>
</div>
<div><label>Status</label>
<select id="ct_status">
${["Monitoring","Test Pending","Positive","Negative","Cleared"].map(x=>`<option value="${x}" ${(rec?.status||"Monitoring")===x?"selected":""}>${x}</option>`).join("")}
</select>
</div>
</div>

<div class="grid cols2" style="margin-top:10px">
<div><label>Outcome</label><input id="ct_outcome" type="text" value="${escapeHtml(rec?.outcome||"")}" placeholder="e.g., monitor x 7 days"/></div>
<div><label>Notes</label><input id="ct_notes" type="text" value="${escapeHtml(rec?.notes||"")}" placeholder="PPE, exposure type, etc."/></div>
</div>

<div style="margin-top:10px">
<label>Linkage Note (reason / purpose)</label>
<input id="ct_linkNote" type="text" value="${escapeHtml(rec?.linkNote||"")}" placeholder="Why is this person linked to this case? (e.g., dining exposure, roommate, therapy group)"/>
</div>

<div><label>Notes</label><input id="ct_notes" type="text" value="${escapeHtml(rec?.notes||"")}" placeholder="PPE, exposure type, etc."/></div>
</div>

<div class="sep"></div>
<div class="row end" style="gap:8px">
${recId?`<button class="btn danger" onclick="deleteContactRecord('${escapeHtml(recId)}')">Delete</button>`:""}
<button class="btn" onclick="closeModal()">Cancel</button>
<button class="btn primary" onclick="saveContactRecord('${escapeHtml(caseId||"")}', '${escapeHtml(recId||"")}')">Save</button>
</div>
`);

setTimeout(()=>{
ctSyncPickers();
if(rec?.contactType==="Resident"){
const sel=document.getElementById("ct_resSel"); if(sel && rec.contactId) sel.value = rec.contactId;
}
if(rec?.contactType==="Staff"){
const sel=document.getElementById("ct_staffSel"); if(sel && rec.contactId) sel.value = rec.contactId;
}
if(rec?.contactType==="Visitor"){
const sel=document.getElementById("ct_visSel"); if(sel && rec.contactId) sel.value = rec.contactId;
}
}, 30);
}

window.saveContactRecord = function(caseId, recId){
const s = Store.load();
ensureIpData(s);
const me = getCurrentUser(s);

const exposureDate = document.getElementById("ct_date")?.value || "";
const contactType = document.getElementById("ct_type")?.value || "Resident";
let contactName = (document.getElementById("ct_name")?.value||"").trim();
const location = (document.getElementById("ct_loc")?.value||"").trim();
const monitoringFreq = document.getElementById("ct_freq")?.value || "";
const monitoringEnd = document.getElementById("ct_monEnd")?.value || "";
const testDueDate = document.getElementById("ct_testDue")?.value || "";
const testResult = document.getElementById("ct_testRes")?.value || "";
const status = document.getElementById("ct_status")?.value || "Monitoring";
const outcome = (document.getElementById("ct_outcome")?.value||"").trim();
const notes = (document.getElementById("ct_notes")?.value||"").trim();
const linkNote = (document.getElementById("ct_linkNote")?.value||"").trim();

let contactId = "";
if(contactType==="Resident") contactId = document.getElementById("ct_resSel")?.value || "";
if(contactType==="Staff") contactId = document.getElementById("ct_staffSel")?.value || "";
if(contactType==="Visitor") contactId = document.getElementById("ct_visSel")?.value || "";

const caseObj = caseId ? (s.modules.ip.lineListCases||[]).find(x=>x.id===caseId) : null;
const caseLabel = caseObj ? getCaseLabel(s, caseObj) : "Manual";

if(!contactName){
if(contactType==="Staff" && contactId){
contactName = (s.modules.ip.staff||[]).find(x=>x.id===contactId)?.name || "";
}
if(contactType==="Visitor" && contactId){
contactName = (s.modules.ip.visitors||[]).find(x=>x.id===contactId)?.name || "";
}
if(contactType==="Resident" && contactId){
const r = s.residentsById?.[contactId];
if(r) contactName = r.name || "";
}
}
if(!contactName){ alert("Contact name is required."); return; }

withAudit("Save Contact Record", {caseId, contactType}, ()=>Store.patch(st=>{
ensureIpData(st);
const arr = st.modules.ip.contacts;
if(recId){
const r = arr.find(x=>x.id===recId);
if(!r) return;
Object.assign(r,{caseId,caseLabel,exposureDate,date:exposureDate,contactType,contactId,contactName,location,monitoringFreq,monitoringEnd,testDueDate,testResult,status,outcome,notes,linkNote,author:me.name||"",updatedAt:nowISO()});
} else {
arr.push({id:uid("ct"),caseId,caseLabel,exposureDate,date:exposureDate,contactType,contactId,contactName,location,monitoringFreq,monitoringEnd,testDueDate,testResult,status,outcome,notes,linkNote,author:me.name||"",createdAt:nowISO(),updatedAt:nowISO()});
}
}));
closeModal();
if(caseId) setTimeout(()=>openIpContactWorkspace(caseId), 60);
};

window.deleteContactRecord = function(recId){
if(!confirm("Delete this contact record?")) return;
withAudit("Delete Contact Record", {id:recId}, ()=>Store.patch(s=>{
ensureIpData(s);
s.modules.ip.contacts = (s.modules.ip.contacts||[]).filter(x=>x.id!==recId);
}));
closeModal();
};

function openIpContactModalForCase(caseId){
if(caseId) return openIpContactWorkspace(caseId);
return openIpContactRecordModal("", "");
}

window.ctSyncPickers = function(){
const t = document.getElementById("ct_type")?.value || "Resident";
const a = document.getElementById("ct_pick_res");
const b = document.getElementById("ct_pick_staff");
const c = document.getElementById("ct_pick_vis");
if(a) a.style.display = (t==="Resident") ? "" : "none";
if(b) b.style.display = (t==="Staff") ? "" : "none";
if(c) c.style.display = (t==="Visitor") ? "" : "none";
};

window.ctApplyPicked = function(kind){
const nameEl = document.getElementById("ct_name");
if(!nameEl) return;
const s = Store.load();
ensureIpData(s);

if(kind==="Resident"){
const id = document.getElementById("ct_resSel")?.value || "";
const r = id ? s.residentsById[id] : null;
if(r) nameEl.value = `${r.name||""} (${r.mrn||""})`;
} else if(kind==="Staff"){
const id = document.getElementById("ct_staffSel")?.value || "";
const r = (s.modules.ip.staff||[]).find(x=>x.id===id);
if(r) nameEl.value = r.name||"";
} else {
const id = document.getElementById("ct_visSel")?.value || "";
const r = (s.modules.ip.visitors||[]).find(x=>x.id===id);
if(r) nameEl.value = r.name||"";
}
};

function openIpGIAcuteTemplatePrint(){
const s = Store.load();
ensureIpData(s);
const unitFilter = s.ui.unitFilter || "ALL";
let cases = (s.modules.ip.lineListCases||[]).filter(c=>c.kind==="gi");
if(unitFilter!=="ALL"){
cases = cases.filter(c => (getUnitKeyFromAny(c.unit||"", s.config) || c.unit) === unitFilter);
}
cases.sort((a,b)=> (a.room||"").localeCompare(b.room||"", undefined, {numeric:true}) || (a.name||"").localeCompare(b.name||""));

const facility = s.config.facilityName || "Facility";
const today = new Date();
const dateStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,"0")}-${String(today.getDate()).padStart(2,"0")}`;

const rows = cases.slice(0,10);
while(rows.length < 10) rows.push(null);

const v = (t)=>`<div class="v">${escapeHtml(t)}</div>`;
const has = (arr, code)=> (arr||[]).includes(code) ? "X" : "";

const addCodes = ["A","B","C","D","E","F","G","H","I","J","K","L"];
const specCodes = ["A","B","C","D"];
const testCodes = ["0","1","2","3","4","5","6","7"];
const pathCodes = ["0","1","2","3","4","5","6","7"];

const body = `
<div style="border:1px solid #111">
<div style="display:flex; align-items:stretch; border-bottom:1px solid #111">
<div style="flex:1; background:#0a4b57; color:#fff; font-weight:900; text-align:center; padding:6px 8px; font-size:16px">
LTC Acute Gastroenteritis Surveillance Line List
</div>
<div style="width:220px; background:#e9e9e9; border-left:1px solid #111; padding:6px 10px; font-weight:900">
Date: <span style="display:inline-block; min-width:110px; border-bottom:1px solid #111">${escapeHtml(dateStr)}</span>
</div>
</div>

<div style="padding:8px 10px; font-size:11px; border-bottom:1px solid #111">
This worksheet was created to help nursing homes and other LTC facilities detect, characterize, and investigate a possible outbreak of acute gastroenteritis.
</div>

<table class="thin" style="width:100%">
<thead>
<tr style="background:#e6e6e6; font-weight:900">
<th colspan="6" class="center">A. Case Demographics</th>
<th colspan="5" class="center">B. Case Location</th>
<th colspan="${3+addCodes.length+specCodes.length+1}" class="center">C. Signs and Symptoms (s/s)</th>
<th colspan="${1+testCodes.length+pathCodes.length}" class="center">D. Diagnostics</th>
<th colspan="4" class="center">E. Outcome During Outbreak*</th>
</tr>
<tr>
<th style="width:26px" class="center">&nbsp;</th>
<th style="width:200px" class="center">Name</th>
<th style="width:32px" class="center">${v("Age")}</th>
<th style="width:32px" class="center">${v("Sex (M/F)")}</th>
<th style="width:34px" class="center">${v("Resident (R) or staff (S)")}</th>
<th style="width:34px" class="center">${v("Short stay (S) / Long stay (L)")}</th>

<th style="width:70px" class="center">${v("Bldg / Floor / Unit")}</th>
<th style="width:56px" class="center">${v("Room / Bed")}</th>
<th style="width:86px" class="center">${v("Staff only: Primary assignment")}</th>
<th style="width:32px" class="center">${v("Food handler (Y/N)")}</th>
<th style="width:62px" class="center">${v("Symptom onset date")}</th>

<th style="width:32px" class="center">${v("Abd pain/tenderness (Y/N)")}</th>
<th style="width:32px" class="center">${v("Diarrhea (Y/N)")}</th>
<th style="width:32px" class="center">${v("Vomiting (Y/N)")}</th>

${addCodes.map(c=>`<th style="width:22px" class="center">${v(c)}</th>`).join("")}

${specCodes.map(c=>`<th style="width:22px" class="center">${v(c)}</th>`).join("")}
<th style="width:62px" class="center">${v("Date of collection")}</th>

${testCodes.map(c=>`<th style="width:22px" class="center">${v(c)}</th>`).join("")}
${pathCodes.map(c=>`<th style="width:22px" class="center">${v(c)}</th>`).join("")}

<th style="width:62px" class="center">${v("Symptom resolution date")}</th>
<th style="width:34px" class="center">${v("Hospitalized (Y/N)")}</th>
<th style="width:34px" class="center">${v("Died (Y/N)")}</th>
<th style="width:44px" class="center">${v("Case (Y/N)")}</th>
</tr>
<tr>
<!-- Add legend row for codes (small) -->
<th colspan="11"></th>
<th colspan="${3+addCodes.length}" style="font-size:9px">
<span style="font-weight:900">Additional s/s codes:</span>
A fever; B diarrhea ≤3d; C blood in stool; D loss appetite; E nausea; F myalgias; G chills; H headache; I cough; J sore throat; K runny nose; L other
</th>
<th colspan="${specCodes.length+1}" style="font-size:9px">
<span style="font-weight:900">Specimen:</span> A stool; B rectal swab; C vomitus; D other
</th>
<th colspan="${testCodes.length}" style="font-size:9px">
<span style="font-weight:900">Test ordered:</span> 0 none; 1 culture; 2 PCR; 3 EIA; 4 O&amp;P; 5 other; 6 unknown; 7 other(specify)
</th>
<th colspan="${pathCodes.length}" style="font-size:9px">
<span style="font-weight:900">Pathogen:</span> 0 none/NR; 1 C.diff; 2 PCR panel; 3 Salmonella/Campy; 4 Shigella; 5 Rota; 6 Noro; 7 other
</th>
<th colspan="4"></th>
</tr>
</thead>

<tbody>
${rows.map((c, idx)=>{
if(!c){
return `<tr>${"<td>&nbsp;</td>".repeat(6+5+(3+addCodes.length+specCodes.length+1)+(1+testCodes.length+pathCodes.length)+4)}</tr>`;
}
const r = (c.residentId && s.residentsById[c.residentId]) ? s.residentsById[c.residentId] : null;
const g = c.gi || {};
const name = c.name || r?.name || "";
const unit = g.unit || c.unit || r?.unit || r?.lockedUnit || "";
const roomBed = g.roomBed || c.room || r?.room || r?.lockedRoom || "";
const onset = g.onsetDate || c.onsetDate || "";
const add = g.addSx || [];
const spec = g.specimen || [];
const tests = g.tests || [];
const paths = g.pathogens || [];
return `<tr>
<td class="center">${idx+1}.</td>
<td>${escapeHtml(name)}</td>
<td class="center">${escapeHtml(g.age||"")}</td>
<td class="center">${escapeHtml((g.sex||"").toUpperCase())}</td>
<td class="center">${escapeHtml((g.caseType||"Resident")==="Staff" ? "S" : "R")}</td>
<td class="center">${escapeHtml(g.stay||"")}</td>

<td class="center">${escapeHtml(unit)}</td>
<td class="center">${escapeHtml(roomBed)}</td>
<td class="center">${escapeHtml(g.assignment||"")}</td>
<td class="center">${escapeHtml((g.foodHandler||"").toUpperCase())}</td>
<td class="center">${escapeHtml(onset)}</td>

<td class="center">${escapeHtml((g.abdPain||"").toUpperCase())}</td>
<td class="center">${escapeHtml((g.diarrhea||"").toUpperCase())}</td>
<td class="center">${escapeHtml((g.vomiting||"").toUpperCase())}</td>

${addCodes.map(code=>`<td class="center">${has(add, code)}</td>`).join("")}

${specCodes.map(code=>`<td class="center">${has(spec, code)}</td>`).join("")}
<td class="center">${escapeHtml(g.collectDate||"")}</td>

${testCodes.map(code=>`<td class="center">${has(tests, code)}</td>`).join("")}
${pathCodes.map(code=>`<td class="center">${has(paths, code)}</td>`).join("")}

<td class="center">${escapeHtml(g.resolveDate||"")}</td>
<td class="center">${escapeHtml((g.hospitalized||"").toUpperCase())}</td>
<td class="center">${escapeHtml((g.died||"").toUpperCase())}</td>
<td class="center">${escapeHtml((g.caseStatus||"").toUpperCase())}</td>
</tr>`;
}).join("")}
</tbody>
</table>

<div style="padding:10px; font-size:11px">
<div style="font-weight:900; margin-bottom:6px">If faxing to your local Public Health Department, please complete the following information:</div>
<div style="display:flex; gap:18px; flex-wrap:wrap">
<div style="min-width:320px">Facility Name: <span style="display:inline-block; min-width:240px; border-bottom:1px solid #111">${escapeHtml(facility)}</span></div>
<div style="min-width:220px">City, State: <span style="display:inline-block; min-width:150px; border-bottom:1px solid #111"></span></div>
<div style="min-width:220px">County: <span style="display:inline-block; min-width:150px; border-bottom:1px solid #111"></span></div>
</div>
<div style="display:flex; gap:18px; flex-wrap:wrap; margin-top:6px">
<div style="min-width:320px">Contact Person: <span style="display:inline-block; min-width:240px; border-bottom:1px solid #111"></span></div>
<div style="min-width:220px">Phone: <span style="display:inline-block; min-width:170px; border-bottom:1px solid #111"></span></div>
<div style="min-width:260px">Email: <span style="display:inline-block; min-width:200px; border-bottom:1px solid #111"></span></div>
</div>
<div style="margin-top:8px" class="muted">* Note: Outbreak period defined as date of first case to resolution of last case.</div>
</div>
</div>
`;

openPrintWindow("GI Line List — Acute Gastroenteritis Surveillance", body, `
@page{ size: landscape; margin: 0.30in; }
th,td{ font-size:9px; }
`);
}

function openIpGIAcuteTemplatePrint(){
const s = Store.load();
ensureIpData(s);
const unitFilter = s.ui.unitFilter || "ALL";
let cases = (s.modules.ip.lineListCases||[]).filter(c=>c.kind==="gi");
if(unitFilter!=="ALL"){
cases = cases.filter(c => (getUnitKeyFromAny(c.unit||"", s.config) || c.unit) === unitFilter);
}
cases.sort((a,b)=> (a.room||"").localeCompare(b.room||"", undefined, {numeric:true}) || (a.name||"").localeCompare(b.name||""));

const facility = s.config.facilityName || "FACILITY";
const today = new Date();
const dateStr = `${String(today.getMonth()+1).padStart(2,"0")}/${String(today.getDate()).padStart(2,"0")}/${today.getFullYear()}`;

const rows = cases.slice(0,14);
while(rows.length < 14) rows.push(null);

const body = `
<div class="center title" style="margin-top:6px">GASTROINTESTINAL ILLNESS</div>
<div class="center sub" style="margin-top:2px">LINE LIST</div>

<div class="row" style="display:flex; justify-content:flex-end; gap:40px; margin-top:10px; font-weight:900">
<div>FACILITY: <span class="line">${escapeHtml(facility)}</span></div>
<div>DATE: <span class="line">${escapeHtml(dateStr)}</span></div>
</div>

<div style="height:10px"></div>

<table class="thin">
<thead>
<tr>
<th class="center" style="width:52px">Room</th>
<th style="width:190px">Resident</th>
<th class="center" style="width:90px">MRN</th>
<th class="center" style="width:78px">Onset</th>
<th class="center" style="width:60px">Diarrhea</th>
<th class="center" style="width:60px">Vomiting</th>
<th class="center" style="width:70px">Abd Pain</th>
<th class="center" style="width:60px">Fever</th>
<th class="center" style="width:70px">Temp</th>
<th class="center" style="width:120px">Stool/Lab</th>
<th class="center" style="width:80px">Hosp?</th>
<th class="center" style="width:90px">Resolved</th>
<th style="width:180px">Notes</th>
</tr>
</thead>
<tbody>
${rows.map(c=>{
if(!c){
return `<tr>${"<td>&nbsp;</td>".repeat(13)}</tr>`;
}
const r = (c.residentId && s.residentsById[c.residentId]) ? s.residentsById[c.residentId] : null;
const room = c.room || r?.room || r?.lockedRoom || "";
const name = c.name || r?.name || "";
const mrn = c.mrn || r?.mrn || "";
const gs = c.giSym || {};
return `<tr>
<td class="center">${escapeHtml(room)}</td>
<td>${escapeHtml(name)}</td>
<td class="center">${escapeHtml(mrn)}</td>
<td class="center">${escapeHtml(c.onsetDate||"")}</td>
<td class="center">${ipBoolMark(!!gs.diarrhea)}</td>
<td class="center">${ipBoolMark(!!gs.vomiting)}</td>
<td class="center">${ipBoolMark(!!gs.abdPain)}</td>
<td class="center">${ipBoolMark(!!gs.fever)}</td>
<td class="center">${escapeHtml(gs.temp||"")}</td>
<td>${escapeHtml(c.labResults||"")}</td>
<td class="center">${escapeHtml(c.hospDate ? "Y" : "")}</td>
<td class="center">${escapeHtml(c.status==="resolved" ? "Y" : "")}</td>
<td>${escapeHtml(c.notes||"")}</td>
</tr>`;
}).join("")}
</tbody>
</table>
`;

openPrintWindow("GI Line List", body, "");
}

function calcAgeFromMDY(mdy){
const parts = (mdy||"").split("/");
if(parts.length!==3) return "";
const m = parseInt(parts[0],10)-1;
const d = parseInt(parts[1],10);
const y = parseInt(parts[2],10);
if(!isFinite(m)||!isFinite(d)||!isFinite(y)) return "";
const dob = new Date(y,m,d);
if(String(dob)==="Invalid Date") return "";
const now = new Date();
let age = now.getFullYear() - dob.getFullYear();
const mo = now.getMonth() - dob.getMonth();
if(mo < 0 || (mo===0 && now.getDate()<dob.getDate())) age--;
return age>=0 && age<130 ? String(age) : "";
}

function ensureConfig(s){
if(!s) return;
if(!s.config) s.config = {};
if(!Array.isArray(s.config.units)) s.config.units = [];
if(!s.config.floorMap) s.config.floorMap = {};

// Seed default unit capacities if missing (do NOT overwrite existing configured values)
if(s.config.units.length===0){
  s.config.units = [
    { unitKey:"U2", unitName:"Unit 2", bedCapacity: 50 },
    { unitKey:"U3", unitName:"Unit 3", bedCapacity: 50 },
    { unitKey:"U4", unitName:"Unit 4", bedCapacity: 50 }
  ];
}

// If total capacity is not set (0/blank), default to sum of unit capacities
try{
  const tot = Number(s.config.totalCapacity||0);
  if(!isFinite(tot) || tot<=0){
    const sum = (s.config.units||[]).reduce((a,u)=>a + (Number(u.bedCapacity)||0), 0);
    if(sum>0) s.config.totalCapacity = sum;
  }
}catch(e){}
}


function getQapiCfg(s){
  ensureConfig(s);
  if(!s.config.qapi) s.config.qapi = { patientDaysLast7:0, windowDays:7, thresholds:{ infectionRatePer1000:10, abtUtilPer1000:20, gi72h:2, resp72h:2, abtStartsDay:3, pendingBacklog:5, vaxAnyTarget:80 } };
  if(typeof s.config.qapi.patientDaysLast7 !== 'number') s.config.qapi.patientDaysLast7 = Number(s.config.qapi.patientDaysLast7||0);
  if(typeof s.config.qapi.windowDays !== 'number') s.config.qapi.windowDays = Number(s.config.qapi.windowDays||7);
  if(!s.config.qapi.thresholds) s.config.qapi.thresholds = { infectionRatePer1000:10, abtUtilPer1000:20, gi72h:2, resp72h:2, abtStartsDay:3, pendingBacklog:5, vaxAnyTarget:80 };
  const t = s.config.qapi.thresholds;
  const normNum = (k, d)=>{ const v = Number(t[k]); t[k] = isFinite(v) ? v : d; };
  normNum('infectionRatePer1000', 10);
  normNum('abtUtilPer1000', 20);
  normNum('gi72h', 2);
  normNum('resp72h', 2);
  normNum('abtStartsDay', 3);
  normNum('pendingBacklog', 5);
  normNum('vaxAnyTarget', 80);
  if(!isFinite(s.config.qapi.windowDays) || s.config.qapi.windowDays<1) s.config.qapi.windowDays = 7;
  if(s.config.qapi.windowDays>28) s.config.qapi.windowDays = 28;
  if(t.vaxAnyTarget<0) t.vaxAnyTarget=0;
  if(t.vaxAnyTarget>100) t.vaxAnyTarget=100;
  return s.config.qapi;
}

function renderComplianceDashboard(s){
  const card = document.getElementById('dashComplianceCard');
  if(!card) return;
  ensureIpData(s);
  const q = getQapiCfg(s);
  const days = Math.max(1, Math.min(28, Number(q.windowDays||7)));

  const pd = Number(q.patientDaysLast7||0);

  // New cases in window
  const end = new Date();
  const start = new Date(); start.setDate(end.getDate()-(days-1));
  const startISO = dayISO(start);
  const endISO = dayISO(end);

  const cases = (s.modules.ip.lineListCases||[]).filter(c=>{
    const d = getCaseDateISO(c);
    if(!d) return false;
    return d >= startISO && d <= endISO;
  });
  const newCases = cases.length;

  // ABT starts in window
  const abt = dailyAbtStarts(s, 'ALL', days);
  const abtStarts = (abt.dates||[]).reduce((sum,d)=> sum + (abt.counts[d]||0), 0);

  const infRate = (pd>0) ? (newCases/pd*1000) : NaN;
  const abtRate = (pd>0) ? (abtStarts/pd*1000) : NaN;

  const censusCount = (s.census.activeResidentIds||[]).length;
  const vaxAnyCount = censusCount ? (s.census.activeResidentIds||[]).filter(id=>{
    const rid = String(id||'');
    return (s.modules.vax.events||[]).some(e=>String(e.residentId||'')===rid);
  }).length : 0;
  const vaxAnyPct = censusCount ? (vaxAnyCount/censusCount*100) : NaN;

  const sb = computeSituationBoard(s);
  const pending = Number(sb.testStats?.counts?.Pending||0);
  const uncomm = Number(sb.testStats?.counts?.UncommPositive||0);

  // Checks
  const t = q.thresholds||{};
  const checks = [];
  if(pd>0){
    checks.push({ key:'inf', label:`Infection rate ≤ ${t.infectionRatePer1000} / 1,000`, ok: infRate <= t.infectionRatePer1000, val: infRate, fmt:(v)=>v.toFixed(1) });
    checks.push({ key:'abt', label:`ABT utilization ≤ ${t.abtUtilPer1000} / 1,000`, ok: abtRate <= t.abtUtilPer1000, val: abtRate, fmt:(v)=>v.toFixed(1) });
  } else {
    checks.push({ key:'pd', label:'Resident-days not set (Config)', ok: false, val: NaN, fmt:()=>'' });
  }
  if(isFinite(vaxAnyPct)) checks.push({ key:'vax', label:`Vax completeness ≥ ${t.vaxAnyTarget}%`, ok: vaxAnyPct >= t.vaxAnyTarget, val: vaxAnyPct, fmt:(v)=>v.toFixed(0) });
  checks.push({ key:'pend', label:`Pending tests ≤ ${t.pendingBacklog}`, ok: pending <= t.pendingBacklog, val: pending, fmt:(v)=>String(v) });
  checks.push({ key:'comm', label:'Positive results communicated', ok: uncomm==0, val: uncomm, fmt:(v)=>String(v) });

  const counted = checks.filter(c=>c.key!=='pd');
  const total = counted.length;
  const passed = counted.filter(c=>!!c.ok).length;
  const pct = total? (passed/total*100) : 0;

  const setText = (id, txt)=>{ const el=document.getElementById(id); if(el) el.textContent = txt; };
  setText('kpiWindowDays', String(days));
  setText('kpiWindowDays2', String(days));
  setText('kpiInfRate', (pd>0 && isFinite(infRate)) ? `${infRate.toFixed(1)} (${newCases} cases / ${pd} days)` : 'Set resident-days in Config');
  setText('kpiAbtRate', (pd>0 && isFinite(abtRate)) ? `${abtRate.toFixed(1)} (${abtStarts} starts / ${pd} days)` : '—');
  setText('kpiCompliancePct', `${pct.toFixed(0)}%`);

  const bar = document.getElementById('compBar');
  if(bar) bar.style.width = `${Math.max(0, Math.min(100, pct))}%`;

  const hint = document.getElementById('compHint');
  if(hint){
    const fail = counted.filter(c=>!c.ok);
    hint.textContent = fail.length ? `${fail.length} item(s) need attention` : 'All checks within thresholds';
  }

  const wrap = document.getElementById('compDetails');
  if(wrap){
    wrap.innerHTML = counted.map(c=>{
      const cls = c.ok ? 'green' : 'amber';
      const val = (c.val===undefined || c.val===null || (typeof c.val==='number' && ! isFinite(c.val))) ? '' : (typeof c.val==='number' ? c.fmt(c.val) : String(c.val));
      const right = c.key==='comm' ? (c.ok ? 'OK' : `${val} uncomm`) : (c.key==='pend' ? val : val);
      return `<span class="badge ${c.ok?'green':'amber'}">${escapeHtml(c.label)}${right?` · <span class="n">${escapeHtml(right)}</span>`:''}</span>`;
    }).join('');
  }
}



function ensureIpData(s){
  // --- harden against legacy/case-variant keys ---
  if(!s) return;
  if(!s.modules) s.modules = {};
  // Some legacy exports used modules.IP (capital) or placed IP data at s.ip
  if(!s.modules.ip){
    if(s.modules.IP && typeof s.modules.IP==='object'){ s.modules.ip = s.modules.IP; try{ delete s.modules.IP; }catch(e){} }
    else if(s.ip && typeof s.ip==='object'){ s.modules.ip = s.ip; }
    else {
      // case-insensitive search
      try{
        for(const k of Object.keys(s.modules||{})){
          if(String(k).toLowerCase()==='ip' && typeof s.modules[k]==='object'){ s.modules.ip = s.modules[k]; if(k!=='ip') try{ delete s.modules[k]; }catch(e){}; break; }
        }
      }catch(e){}
    }
  }
  if(!s.modules.ip) s.modules.ip = {};

  const ip = s.modules.ip;

  // Convert legacy object maps -> arrays instead of wiping them.
  function asArray(v){
    if(Array.isArray(v)) return v;
    if(v && typeof v === 'object'){
      try{ return Object.values(v).filter(Boolean); }catch(e){ return []; }
    }
    return [];
  }

  // Normalize kind/category labels so render doesn't filter everything out.
  function normKind(v){
    const t = String(v||'').toLowerCase();
    if(!t) return '';
    if(t==='resp' || t==='respiratory' || t==='ili' || t==='uri' || t==='r' || t==='upper respiratory') return 'resp';
    if(t==='gi' || t==='gastro' || t==='gastrointestinal' || t==='n/v' || t==='nv' || t==='vomiting' || t==='diarrhea' || t==='diarrhoea') return 'gi';
    if(t.includes('gi') || t.includes('gastro') || t.includes('vomit') || t.includes('diarr')) return 'gi';
    return 'resp';
  }

  // Common legacy keys
  if(!ip.lineListCases && ip.lineList) ip.lineListCases = ip.lineList;
  if(!ip.lineListCases && ip.lineListing) ip.lineListCases = ip.lineListing;
  if(!ip.lineListCases && ip.lineListItems) ip.lineListCases = ip.lineListItems;
  if(!ip.lineListCases && ip.cases) ip.lineListCases = ip.cases;

  // Also accept top-level legacy keys
  if(!ip.lineListCases && s.ipLineList) ip.lineListCases = s.ipLineList;
  if(!ip.lineListCases && s.ipLineListing) ip.lineListCases = s.ipLineListing;

  ip.precautions   = asArray(ip.precautions || ip.isolation || ip.ipPrecautions || s.ipPrecautions || s.precautions);
  ip.lineListCases = asArray(ip.lineListCases);

  // Normalize existing case rows in-place
  try{
    ip.lineListCases.forEach(c=>{
      if(!c || typeof c!=='object') return;
      c.kind = normKind(c.kind || c.category || c.type || c.lineListType);
      if(!c.name && (c.residentName||c.Resident||c.resName)) c.name = c.residentName||c.Resident||c.resName;
      if(!c.mrn && (c.MRN||c.medRec||c.medicalRecordNumber)) c.mrn = c.MRN||c.medRec||c.medicalRecordNumber;
      if(!c.room && (c.Room||c.lockedRoom)) c.room = c.Room||c.lockedRoom;
      if(!c.unit && (c.Unit||c.unitKey)) c.unit = c.Unit||c.unitKey;
      if(!c.onsetDate && (c.onset||c.startDate||c.date)) c.onsetDate = c.onset||c.startDate||c.date;
      if(c.status && typeof c.status==='string'){
        const st = c.status.toLowerCase();
        if(st==='closed' || st==='resolved' || st==='inactive') c.status = 'resolved';
        else if(st==='open') c.status = 'active';
      }
    });
  }catch(e){}

  ip.contacts      = asArray(ip.contacts);
  ip.exposureEvents= asArray(ip.exposureEvents);
  ip.staff         = asArray(ip.staff);
  ip.visitors      = asArray(ip.visitors);
  ip.tests         = asArray(ip.tests);
  ip.comms         = asArray(ip.comms);
  ip.actions       = asArray(ip.actions);
  ip.decisions     = asArray(ip.decisions);
  ip.stopRules     = asArray(ip.stopRules);
  ip.audits        = asArray(ip.audits);
  ip.staffIllness  = asArray(ip.staffIllness);

  if(!ip.contactPlans || typeof ip.contactPlans !== 'object') ip.contactPlans = {};

  if(!ip.envControls || typeof ip.envControls !== 'object') ip.envControls = {};
  if(!Array.isArray(ip.envControls.cleaningEvents)) ip.envControls.cleaningEvents = asArray(ip.envControls.cleaningEvents);
  if(!Array.isArray(ip.envControls.equipmentLog)) ip.envControls.equipmentLog = asArray(ip.envControls.equipmentLog);
  if(!ip.envControls.supplies || typeof ip.envControls.supplies !== 'object'){
    ip.envControls.supplies = { gloves:{onHand:0,par:0}, masks:{onHand:0,par:0}, gowns:{onHand:0,par:0}, sanitizer:{onHand:0,par:0} };
  }

  if(!ip.ui || typeof ip.ui !== 'object') ip.ui = { view: 'resp', alertFilter: null };
  if(!ip.commandCenter || typeof ip.commandCenter !== 'object') ip.commandCenter = { outbreakStatus:'None', statusNotes:'', updatedAt:'' };
}


// --- Auto-repair for legacy backups (keeps IP lists from going blank) ---
function autoRepairState(s){
  try{
    s = ensureShape(s);
    ensureIpData(s);
    ensureConfig(s);

    // 1) If older backups stored cases at modules.ip.cases, seed lineListCases
    const legacyCases = (s.modules && s.modules.ip) ? (
      (Array.isArray(s.modules.ip.cases) ? s.modules.ip.cases : (s.modules.ip.cases && typeof s.modules.ip.cases==='object' ? Object.values(s.modules.ip.cases).filter(Boolean) : []))
      .concat(Array.isArray(s.modules.ip.lineList) ? s.modules.ip.lineList : (s.modules.ip.lineList && typeof s.modules.ip.lineList==='object' ? Object.values(s.modules.ip.lineList).filter(Boolean) : []))
      .concat(Array.isArray(s.modules.ip.lineListing) ? s.modules.ip.lineListing : (s.modules.ip.lineListing && typeof s.modules.ip.lineListing==='object' ? Object.values(s.modules.ip.lineListing).filter(Boolean) : []))
      .concat(Array.isArray(s.modules.ip.lineListItems) ? s.modules.ip.lineListItems : (s.modules.ip.lineListItems && typeof s.modules.ip.lineListItems==='object' ? Object.values(s.modules.ip.lineListItems).filter(Boolean) : []))
    ) : [];
    if(legacyCases.length){
      const ll = Array.isArray(s.modules.ip.lineListCases) ? s.modules.ip.lineListCases : (s.modules.ip.lineListCases = []);
      const prec = Array.isArray(s.modules.ip.precautions) ? s.modules.ip.precautions : (s.modules.ip.precautions = []);
      const seenLL = new Set(ll.map(x=>String(x && x.id || '')));
      const seenPrec = new Set(prec.map(x=>String(x && x.id || '')));

      for(const ca of legacyCases){
        if(!ca) continue;
        const unitKey = getUnitKeyFromAny(ca.unit, s.config) || inferUnitFromRoom(ca.room, s.config) || "";
        const active = (String(ca.status||ca.caseStatus||"").toLowerCase()==="active");

        // Seed precaution row (if legacy case carried precaution fields)
        const precId = String(ca.id||"") || uid("prec");
        if(!seenPrec.has(precId)) {
          const precType = String(ca.precautionType||"").toUpperCase();
          let type = "Isolation - Other";
          if(precType==="EBP") type = "Enhanced Barrier Precautions (EBP)";
          else if(precType==="ISOLATION") type = ca.isolationType ? `Isolation - ${ca.isolationType}` : "Isolation - Other";
          else if(precType) type = precType;

          prec.push({
            id: precId,
            residentId: ca.residentId || (ca.mrn ? `MRN-${String(ca.mrn).trim()}` : ""),
            residentName: ca.residentName || ca.name || "",
            unit: unitKey || "",
            room: (ca.room||ca.lockedRoom||"").toString().trim(),
            type,
            infectedSource: ca.sourceCondition || ca.isolationType || ca.infectedSource || ca.source || "",
            startDate: isoToMDY(ca.onsetDate || ca.startDate || ""),
            endDate: isoToMDY(ca.resolutionDate || ca.endDate || ""),
            status: active ? "active" : "resolved",
            createdAt: ca.createdAt || nowISO(),
            updatedAt: ca.updatedAt || nowISO()
          });
          seenPrec.add(precId);
        }

        // Seed line list row
        const llId = String(ca.caseId||ca.id||"") || uid("case");
        if(!seenLL.has(llId)) {
          const kindRaw = String(ca.kind||ca.category||ca.type||"resp").toLowerCase();
          const normKind = (kindRaw.includes('gi') || kindRaw.includes('gastro') || kindRaw.includes('n/v') || kindRaw.includes('vomit') || kindRaw.includes('diarr')) ? 'gi' : 'resp';
          ll.push({
            id: llId,
            kind: normKind,
            residentId: ca.residentId || (ca.mrn ? `MRN-${String(ca.mrn).trim()}` : ""),
            name: ca.residentName || ca.name || "",
            mrn: (ca.mrn||"").toString().trim(),
            unit: unitKey || "",
            room: (ca.room||"").toString().trim(),
            status: active ? "active" : (String(ca.status||ca.caseStatus||"").toLowerCase() || "active"),
            onsetDate: ca.onsetDate || ca.startDate || ca.date || "",
            specimenDate: ca.specimenDate || "",
            testDate: ca.testDate || "",
            testType: ca.testType || "",
            result: ca.result || ca.testResult || "",
            symptoms: Array.isArray(ca.symptoms) ? ca.symptoms : (ca.symptoms ? String(ca.symptoms).split(/,\s*/).filter(Boolean) : []),
            notes: ca.notes || "",
            createdAt: ca.createdAt || nowISO()
          });
          seenLL.add(llId);
        }
      }
    }

    // 2) Normalize kinds in existing line list (GI/Resp casing drift)
    if(Array.isArray(s.modules.ip.lineListCases)) {
      for(const c of s.modules.ip.lineListCases){
        if(!c) continue;
        const k = String(c.kind||"resp").toLowerCase();
        c.kind = (k.includes('gi') || k.includes('gastro')) ? 'gi' : 'resp';
        c.unit = getUnitKeyFromAny(c.unit||"", s.config) || c.unit || inferUnitFromRoom(c.room||"", s.config) || "";
      }
    }

    // 3) Reconcile precautions sources (legacy keys like ipPrecautions)
    try{ reconcileIpPrecautions(s); }catch(_){ }
  }catch(e){ }
  return s;
}


// --- Phase 4 Step 1 (PATCH): Precaution reliability + unified sources ---
function reconcileIpPrecautions(s){
  try{
    ensureIpData(s); ensureConfig(s);
    if(!s.residentsById) s.residentsById = {};
    // Merge any legacy precautions arrays into modules.ip.precautions
    const candidates = []
      .concat(Array.isArray(s.modules?.ip?.precautions) ? s.modules.ip.precautions : [])
      .concat(Array.isArray(s.ipPrecautions) ? s.ipPrecautions : [])
      .concat(Array.isArray(s.precautions) ? s.precautions : [])
      .concat(Array.isArray(s.modules?.ip?.isolation) ? s.modules.ip.isolation : []);
    const out = [];
    const seen = new Set();
    for(const p0 of candidates){
      if(!p0) continue;
      const p = Object.assign({}, p0);
      // normalize residentId
      if(!p.residentId && p.mrn){
        p.residentId = `MRN-${String(p.mrn).trim()}`;
      }
      // Try to backfill residentId from name+room hash if needed
      if(!p.residentId && (p.residentName||p.name) && (p.room||p.roomNumber)){
        const rid = makeResidentId({mrn:"", unit:p.unit||"", room:(p.room||p.roomNumber||""), name:(p.residentName||p.name||"")});
        p.residentId = rid;
      }
      const rid = String(p.residentId||p.residentID||p.id||"").trim();
      // Backfill from resident DB if possible
      const r = rid ? (s.residentsById[rid] || null) : null;
      if(r){
        if(!p.residentName) p.residentName = r.name || "";
        if(!p.room) p.room = r.room || p.room || "";
        if(!p.unit) p.unit = r.unit || p.unit || "";
        if(!p.mrn) p.mrn = r.mrn || "";
      }
      // Normalize unit key
      p.unit = getUnitKeyFromAny(p.unit||"", s.config) || p.unit || inferUnitFromRoom(p.room||"", s.config) || "";
      // Normalize type
      if(!p.type && p.precautionType){
        const precType = String(p.precautionType||"").toUpperCase();
        if(precType==="EBP") p.type = "Enhanced Barrier Precautions (EBP)";
        else if(precType==="ISOLATION") p.type = p.isolationType ? `Isolation - ${p.isolationType}` : "Isolation - Other";
        else p.type = precType;
      }
      // Normalize source
      if(!p.infectedSource && p.infectionSource) p.infectedSource = p.infectionSource;
      if(!p.infectedSource && p.sourceCondition) p.infectedSource = p.sourceCondition;
      if(!p.infectedSource && p.sourceReason) p.infectedSource = p.sourceReason;
      if(!p.infectedSource && p.reason) p.infectedSource = p.reason;
      if(!p.infectedSource && p.source) p.infectedSource = p.source;
      if(!p.infectedSource && p.notes) p.infectedSource = p.notes;
      // Normalize status
      const st = String(p.status||"active").toLowerCase();
      p.status = (st==="resolved" || st==="inactive" || st==="closed") ? "resolved" : "active";
      // Stable dedupe key
      const k = `${rid||""}|${(p.type||"").toUpperCase()}|${String(p.startDate||p.onsetDate||"")}`;
      if(seen.has(k)) continue;
      seen.add(k);
      out.push(p);
    }
    s.modules.ip.precautions = out;
  }catch(e){}
}
function getActivePrecautionsRowsUnified(s, unitKey){
  ensureIpData(s); ensureConfig(s);
  reconcileIpPrecautions(s);
  let rows = (s.modules.ip.precautions||[]).slice().filter(p=>String(p.status||"active").toLowerCase()==="active");
  if(unitKey && unitKey!=="ALL"){
    rows = rows.filter(p => (getUnitKeyFromAny(p.unit||"", s.config) || p.unit) === unitKey);
  }
  rows.sort((a,b)=> (a.room||"").localeCompare(b.room||"", undefined, {numeric:true}) || (a.residentName||"").localeCompare(b.residentName||""));
  return rows;
}

function getActivePrecautionsRows(s, unitKey){
  // Backwards-compatible wrapper: use unified reconciled source of truth
  return getActivePrecautionsRowsUnified(s, unitKey);
}


// =========================
// Source-of-truth getters (Phase 2 foundation)
// Every report should ultimately read through these to avoid
// "works here but blank there" data path drift.
// =========================

function getCaseRowsByWindow(s, {fromISO="", toISO="", unitKey="ALL", kind=""}={}){
  ensureIpData(s); ensureConfig(s);
  let rows = (s.modules.ip.lineListCases||[]).slice();
  if(kind) rows = rows.filter(c => (c.kind||"") === kind);
  // Normalize status (legacy may use Active/active/true)
  rows = rows.filter(c => {
    const st = String(c.status||"active").toLowerCase();
    return st==="active";
  });
  if(unitKey && unitKey!=="ALL"){
    rows = rows.filter(c => (getUnitKeyFromAny(c.unit||"", s.config) || c.unit) === unitKey);
  }
  if(fromISO || toISO){
    const from = fromISO || "0000-01-01";
    const to = toISO || "9999-12-31";
    rows = rows.filter(c=>{
      const d = mdyToISO(c.onsetDate||"") || (c.onsetDate||"").slice(0,10);
      if(!d) return true;
      return d>=from && d<=to;
    });
  }
  rows.sort((a,b)=> (mdyToISO(b.onsetDate||"")||"").localeCompare(mdyToISO(a.onsetDate||"")||"") || (a.room||"").localeCompare(b.room||"", undefined, {numeric:true}));
  return rows;
}

function getWeeklyAbtStarts(s, {fromISO="", toISO="", unitKey="ALL"}={}){
  ensureConfig(s);
  const courses = (s.modules?.abt?.courses||[]).slice();
  const from = fromISO || "0000-01-01";
  const to = toISO || "9999-12-31";
  let rows = courses.filter(c=>{
    const d = mdyToISO(c.startDate||"") || (c.startDate||"").slice(0,10);
    if(!d) return false;
    return d>=from && d<=to;
  });
  if(unitKey && unitKey!=="ALL"){
    rows = rows.filter(c => (getUnitKeyFromAny(c.unit||"", s.config) || c.unit) === unitKey);
  }
  // stable sort
  rows.sort((a,b)=> (mdyToISO(b.startDate||"")||"").localeCompare(mdyToISO(a.startDate||"")||"") || (a.residentName||"").localeCompare(b.residentName||""));
  return rows;
}

function getTasksByWindow(s, {fromISO="", toISO="", status="OPEN"}={}){
  s = ensureShape(s);
  const from = fromISO || "0000-01-01";
  const to = toISO || "9999-12-31";
  let rows = (s.tasks||[]).slice();
  if(status){
    rows = rows.filter(t=> String(t.status||"OPEN").toUpperCase()===String(status).toUpperCase());
  }
  if(fromISO || toISO){
    rows = rows.filter(t=>{
      const d = (t.dueISO||t.dueDate||"").slice(0,10);
      if(!d) return true;
      return d>=from && d<=to;
    });
  }
  rows.sort((a,b)=> (String(a.dueISO||a.dueDate||"")).localeCompare(String(b.dueISO||b.dueDate||"")) );
  return rows;
}


function repairIpNow(){
  try{
    Store.patch(s=>{ try{ autoRepairState(s); }catch(e){} });
    toast('IP data repair ran.');
  }catch(e){ alert('Repair failed.'); }
}

function clearIpAlertFilter(){
Store.patch(s=>{
ensureIpData(s);
s.modules.ip.ui.alertFilter = null;
});
}

function setIpView(v){ Store.patch(s=>{ ensureIpData(s); s.modules.ip.ui.view=v; 
  // Outbreak view
  const ob = document.getElementById('ipView_outbreak');
  if(ob) ob.style.display = (v==='outbreak') ? '' : 'none';
  const btnOb = document.getElementById('ipTab_outbreak');
  if(btnOb) btnOb.classList.toggle('active', v==='outbreak');
  if(v==='outbreak') try{ renderIpOutbreak(Store.load()); }catch(e){}

}); }
function ipCaseKindLabel(kind){ return kind==="gi" ? "GI" : "Respiratory"; }

function renderIp(s){
ensureIpData(s);
// Diagnostics: show counts so blank screens are explainable
try{
  const d=document.getElementById('ipDiag');
  if(d){
    const ll = Array.isArray(s.modules?.ip?.lineListCases) ? s.modules.ip.lineListCases.length : 0;
    const prec = Array.isArray(s.modules?.ip?.precautions) ? s.modules.ip.precautions.length : 0;
    const legacy = (s.modules?.ip?.cases && Array.isArray(s.modules.ip.cases)) ? s.modules.ip.cases.length : (s.modules?.ip?.cases && typeof s.modules.ip.cases==='object' ? Object.keys(s.modules.ip.cases).length : 0);
    const f = (FILTERS.ip||'') ? ` · Search="${FILTERS.ip}"` : '';
    d.textContent = `Data: LineListCases ${ll} · Precautions ${prec}${legacy?` · Legacy ${legacy}`:''}${f} · Unit=${(s.ui&&s.ui.unitFilter)||'ALL'}`;
  }
}catch(e){}
const v = s.modules.ip.ui.view || "resp";
["resp","gi","ct","tests","prec","outbreak"].forEach(x=>{
  const el = document.getElementById("ipView_"+x);
  if(el) el.style.display = (x===v) ? "" : "none";
  const b = document.getElementById("ipTab_"+x);
  if(b) b.classList.toggle("active", x===v);
});

renderIpLineList(s,"resp");
renderIpLineList(s,"gi");
renderIpContactTracing(s);
renderIpPrecautions(s);
try{ renderIpTests(s); }catch(e){}
try{ if(v==='outbreak') renderIpOutbreak(s); }catch(e){}

const addBtn = document.getElementById("btnIpNewCase");
if(addBtn && !addBtn.dataset.bound){
addBtn.dataset.bound="1";
addBtn.addEventListener("click", ()=> openIpCaseModal(null));
}
const impBtn = document.getElementById("btnIpImportSuggestions");
if(impBtn && !impBtn.dataset.bound){
impBtn.dataset.bound="1";
impBtn.addEventListener("click", importAbtSuggestionsToIp);
}
}

function renderIpLineList(s, kind){
const box = document.getElementById("ipView_"+kind);
if(!box) return;

const unitFilter = s.ui.unitFilter || "ALL";
let rows = (s.modules.ip.lineListCases||[]).filter(c=>{ const k=(c&&c.kind)||''; return String(k).toLowerCase()===String(kind).toLowerCase(); });
  const _f = (FILTERS.ip||"");
  if(_f){ rows = (rows||[]).filter(r=> rowMatchesFilter(`${r.name||r.residentName||""} ${r.mrn||""} ${r.room||""} ${r.unit||""}`, _f)); }

if(unitFilter!=="ALL"){
rows = rows.filter(c => {
  const u = (getUnitKeyFromAny(c.unit||"", s.config) || inferUnitFromRoom(c.room||"", s.config) || c.unit || "");
  return u === unitFilter;
});
}

const af = (s.modules.ip.ui && s.modules.ip.ui.alertFilter) ? s.modules.ip.ui.alertFilter : null;
if(af && af.kind === kind){
const start = (af.startISO||"").slice(0,10);
const end   = (af.endISO||"").slice(0,10);
rows = rows.filter(c=>{
const d = (c.onsetDate || c.createdAt || "").slice(0,10);
if(!d) return false;
if(start && d < start) return false;
if(end && d > end) return false;
return true;
});
}

rows.sort((a,b)=> (a.room||"").localeCompare(b.room||"", undefined, {numeric:true}) || (a.name||"").localeCompare(b.name||""));
const activeCount = rows.filter(r=>r.status!=="resolved").length;

box.innerHTML = `
<div class="row" style="justify-content:space-between; align-items:flex-end">
<div>
<h3>${ipCaseKindLabel(kind)} Line List</h3>
<div class="muted mini">Active: <b>${activeCount}</b> · Total: <b>${rows.length}</b> · Unit: <b>${escapeHtml(unitFilter)}</b></div>
</div>
<div class="row noprint" style="gap:8px">
<button class="smallbtn" onclick="openIpPrintLineList('${kind}')">Print</button>
${kind==='resp' ? `<button class="smallbtn" onclick="openIpILIPrintTemplate()">Print ILI Template</button>` : ''}
${kind==='gi' ? `<button class="smallbtn" onclick="openIpGIAcuteTemplatePrint()">Print GI Template</button>` : ''}
${(s.modules.ip.ui && s.modules.ip.ui.alertFilter && s.modules.ip.ui.alertFilter.kind===kind) ? `<button class="smallbtn danger" onclick="clearIpAlertFilter()">Clear Alert Filter</button>` : ``}
</div>
</div>
<div class="sep"></div>

${rows.length ? `
<table>
<thead><tr>
<th>Status</th><th>Room</th><th>Resident</th><th>MRN</th><th>Unit</th>
<th>Onset</th><th>Symptoms</th><th>Notes</th><th>ABT</th><th>Actions</th>
</tr></thead>
<tbody>
${rows.map(c=>`
<tr>
<td class="nowrap">${c.status==="resolved" ? `<span class="badge">Resolved</span>` : `<span class="badge blue">Active</span>`}</td>
<td class="nowrap">${escapeHtml(c.room||"")}</td>
<td>${escapeHtml(c.name||"")}</td>
<td class="nowrap">${escapeHtml(c.mrn||"")}</td>
<td class="nowrap">${escapeHtml(getUnitKeyFromAny(c.unit||"", s.config) || c.unit || "")}</td>
<td class="nowrap">${escapeHtml(c.onsetDate||"")}</td>
<td>${escapeHtml((c.symptoms||[]).join(", "))}</td>
<td>${escapeHtml(c.notes||"")}</td>
<td>${escapeHtml(c.antibiotic||"")}</td>
<td class="nowrap">
<button class="smallbtn" onclick="openIpCaseModal('${escapeHtml(c.id)}')">Edit</button>
<button class="smallbtn" onclick="openIpContactModalForCase('${escapeHtml(c.id)}')">Contacts</button>
</td>
</tr>
`).join("")}
</tbody>
</table>
` : `<div class="muted">No cases yet.</div>`}
`;
}

function renderIpPrecautions(s){
reconcileIpPrecautions(s);
const box = document.getElementById("ipView_prec");
if(!box) return;
const unitFilter = s.ui.unitFilter || "ALL";
let rows = (s.modules.ip.precautions||[]).filter(p=>p.status==="active");
  const _f = (FILTERS.prec||"");
  if(_f){ rows = (rows||[]).filter(r=> rowMatchesFilter(`${r.name||r.residentName||""} ${r.mrn||""} ${r.room||""} ${r.unit||""} ${r.type||r.precaution||""}`, _f)); }

if(unitFilter!=="ALL"){
rows = rows.filter(p=> {
  const u = (getUnitKeyFromAny(p.unit||"", s.config) || inferUnitFromRoom(p.room||"", s.config) || p.unit || "");
  return u === unitFilter;
});
}
rows.sort((a,b)=> (a.room||"").localeCompare(b.room||"", undefined, {numeric:true}) || (a.residentName||"").localeCompare(b.residentName||""));
box.innerHTML = `
<h3>Active Precautions</h3>
<div class="row noprint edit-only" style="gap:8px; flex-wrap:wrap; margin-top:8px">
<button class="smallbtn" id="btnPrintPrecList">Print Unit Sheet</button>
<button class="smallbtn" id="btnPrintPrecSigns">Print Isolation/Precaution Signage</button>
</div>
<div class="muted mini">Mapped from legacy IP data.</div>
<div class="sep"></div>
${rows.length ? `
<table>
<thead><tr><th>Room</th><th>Resident</th><th>Type</th><th>Source</th><th>Duration</th><th class="noprint edit-only" style="width:90px">Edit</th></tr></thead>
<tbody>
${rows.map(p=>`
<tr>
<td class="nowrap">${escapeHtml(p.room||"")}</td>
<td>${escapeHtml(p.residentName||"")}</td>
<td class="nowrap">${escapeHtml(p.type||"")}</td>
<td>${escapeHtml(p.infectedSource||"")}</td>
<td class="nowrap">${escapeHtml(p.duration||"")}</td>
<td class="noprint edit-only"><button class="smallbtn" onclick="openEditPrecautionModal('${escapeHtml(p.id||"")}')">Edit</button></td>
</tr>
`).join("")}
</tbody>
</table>
` : `<div class="muted">No active precautions.</div>`}
`;
const pl = document.getElementById("btnPrintPrecList");
if(pl && !pl.dataset.bound){
pl.dataset.bound="1";
pl.addEventListener("click", openPrecautionListPrintSetup);
}
const ps = document.getElementById("btnPrintPrecSigns");
if(ps && !ps.dataset.bound){ ps.dataset.bound="1"; ps.addEventListener("click", openUnitPrecautionSignagePrintSetup); }
}


function normalizeTestType(t){
const x = (t||"").trim();
if(!x) return "";
return x;
}
function testStatus(r){
if(r.resultedDate) return "Resulted";
if(r.collectedDate) return "Pending";
if(r.orderedDate) return "Ordered";
return "Draft";
}
function daysBetween(aISO, bISO){
if(!aISO || !bISO) return null;
const a = new Date(aISO); const b = new Date(bISO);
const ms = b - a;
if(!isFinite(ms)) return null;
return Math.round(ms / 86400000);
}

function openIpTestModal(testId){
const s = Store.load();
ensureIpData(s);

const existing = testId ? (s.modules.ip.tests||[]).find(x=>x.id===testId) : null;

const ids = s.census.activeResidentIds || [];
const residents = ids.map(id=>s.residentsById[id]).filter(Boolean)
.sort((a,b)=> (a.room||"").localeCompare(b.room||"", undefined, {numeric:true}) || (a.name||"").localeCompare(b.name||""));
const resOpts = `<option value="">— Select —</option>` + residents.map(r=>{
const label = `${r.room||"—"} — ${r.name||""} (${r.mrn||""})`;
return `<option value="${escapeHtml(r.id)}" ${(existing?.residentId===r.id)?"selected":""}>${escapeHtml(label)}</option>`;
}).join("");

const cases = (s.modules.ip.lineListCases||[]).filter(c=>(c.status||"active")!=="resolved")
.sort((a,b)=> (a.room||"").localeCompare(b.room||"", undefined, {numeric:true}) || (a.name||"").localeCompare(b.name||""));
const caseOpts = `<option value="">— Optional —</option>` + cases.map(c=>{
const label = `${c.kind==="gi"?"GI":"Resp"} — ${c.room||""} — ${c.name||""}`;
return `<option value="${escapeHtml(c.id)}" ${(existing?.caseId===c.id)?"selected":""}>${escapeHtml(label)}</option>`;
}).join("");

openModal(`${testId?"Edit":"Add"} Test / Lab`, `
<div class="grid cols3">
<div><label>Resident</label><select id="t_res">${resOpts}</select></div>
<div><label>Linked Case</label><select id="t_case">${caseOpts}</select></div>
<div><label>Syndrome</label>
<select id="t_synd">
<option value="">—</option>
<option value="resp" ${(existing?.syndrome||"")==="resp"?"selected":""}>Respiratory</option>
<option value="gi" ${(existing?.syndrome||"")==="gi"?"selected":""}>GI</option>
<option value="skin" ${(existing?.syndrome||"")==="skin"?"selected":""}>Skin</option>
<option value="uti" ${(existing?.syndrome||"")==="uti"?"selected":""}>UTI</option>
<option value="other" ${(existing?.syndrome||"")==="other"?"selected":""}>Other</option>
</select>
</div>
</div>

<div class="grid cols3" style="margin-top:10px">
<div><label>Test Type</label>
<select id="t_type">
${["","COVID-19 PCR","COVID-19 Antigen","Influenza A/B","RSV","Resp PCR Panel","C. diff","GI PCR Panel","Stool culture","Urine culture","Wound culture","Other"].map(x=>`<option value="${escapeHtml(x)}" ${(existing?.testType||"")===x?"selected":""}>${escapeHtml(x||"—")}</option>`).join("")}
</select>
</div>
<div><label>Lab / Facility</label><input id="t_lab" type="text" value="${escapeHtml(existing?.lab||"")}"/></div>
<div><label>Result</label><input id="t_result" type="text" value="${escapeHtml(existing?.result||"")}" placeholder="Positive / Negative / Pending..."/></div>
</div>

<div class="grid cols3" style="margin-top:10px">
<div><label>Ordered Date</label><input id="t_ordered" type="date" value="${escapeHtml(existing?.orderedDate||"")}"/></div>
<div><label>Collected Date</label><input id="t_collected" type="date" value="${escapeHtml(existing?.collectedDate||"")}"/></div>
<div><label>Resulted Date</label><input id="t_resulted" type="date" value="${escapeHtml(existing?.resultedDate||"")}"/></div>
</div>

<div class="grid cols3" style="margin-top:10px">
<div><label>Retest Due</label><input id="t_retest" type="date" value="${escapeHtml(existing?.retestDue||"")}"/></div>
<div><label>Communicated?</label>
<select id="t_comm">
<option value="N" ${(existing?.communicated||"N")==="N"?"selected":""}>No</option>
<option value="Y" ${(existing?.communicated||"N")==="Y"?"selected":""}>Yes</option>
</select>
</div>
<div><label>Communicated Date</label><input id="t_commDate" type="date" value="${escapeHtml(existing?.communicatedDate||"")}"/></div>
</div>

<div style="margin-top:10px">
<label>Notes / Action Taken</label>
<input id="t_notes" type="text" value="${escapeHtml(existing?.notes||"")}" placeholder="e.g., started droplet, notified MD, cohorted, etc."/>
</div>

<div class="sep"></div>
<div class="row end" style="gap:8px">
${testId?`<button class="btn danger" onclick="deleteIpTest('${escapeHtml(testId)}')">Delete</button>`:""}
<button class="btn" onclick="closeModal()">Cancel</button>
<button class="btn primary" onclick="saveIpTest('${escapeHtml(testId||"")}')">Save</button>
</div>
`);
}

window.saveIpTest = function(testId){
const resId = document.getElementById("t_res")?.value || "";
const caseId = document.getElementById("t_case")?.value || "";
const syndrome = document.getElementById("t_synd")?.value || "";
const testType = normalizeTestType(document.getElementById("t_type")?.value || "");
const lab = (document.getElementById("t_lab")?.value || "").trim();
const result = (document.getElementById("t_result")?.value || "").trim();
const orderedDate = document.getElementById("t_ordered")?.value || "";
const collectedDate = document.getElementById("t_collected")?.value || "";
const resultedDate = document.getElementById("t_resulted")?.value || "";
const retestDue = document.getElementById("t_retest")?.value || "";
const communicated = document.getElementById("t_comm")?.value || "N";
const communicatedDate = document.getElementById("t_commDate")?.value || "";
const notes = (document.getElementById("t_notes")?.value || "").trim();

withAudit("Save Test/Lab", {testType, syndrome}, ()=>Store.patch(s=>{
ensureIpData(s);
const arr = s.modules.ip.tests;
if(testId){
const t = arr.find(x=>x.id===testId);
if(!t) return;
Object.assign(t, { residentId:resId, caseId, syndrome, testType, lab, result, orderedDate, collectedDate, resultedDate, retestDue, communicated, communicatedDate, notes, updatedAt: nowISO() });
}else{
arr.push({ id: uid("test"), residentId:resId, caseId, syndrome, testType, lab, result, orderedDate, collectedDate, resultedDate, retestDue, communicated, communicatedDate, notes, createdAt: nowISO(), updatedAt: nowISO() });
}
}));
closeModal();
};

window.deleteIpTest = function(testId){
if(!confirm("Delete this test record?")) return;
withAudit("Delete Test/Lab", {id:testId}, ()=>Store.patch(s=>{
ensureIpData(s);
s.modules.ip.tests = (s.modules.ip.tests||[]).filter(x=>x.id!==testId);
}));
closeModal();
};

function renderIpTests(s){
ensureIpData(s);
const box = document.getElementById("ipView_tests");
if(!box) return;

const unitFilter = s.ui.unitFilter || "ALL";
let rows = (s.modules.ip.tests||[]).slice();

if(unitFilter!=="ALL"){
rows = rows.filter(t=>{
if(!t.residentId) return false;
const r = s.residentsById[t.residentId];
const uk = getUnitKeyFromAny(r?.unit||"", s.config) || r?.unit || "";
return uk === unitFilter;
});
}

const rank = (st)=> st==="Pending" ? 0 : (st==="Ordered" ? 1 : (st==="Resulted" ? 2 : 3));
rows.sort((a,b)=> rank(testStatus(a)) - rank(testStatus(b)) || (b.orderedDate||"").localeCompare(a.orderedDate||""));

const counts = { Ordered:0, Pending:0, Resulted:0, Draft:0, RetestDue:0 };
const today = dayISO(new Date());
let tatSum=0, tatN=0;

for(const t of rows){
const st = testStatus(t);
counts[st] = (counts[st]||0)+1;
if(t.retestDue && t.retestDue <= today && !t.resultedDate) counts.RetestDue++;
const tat = daysBetween(t.collectedDate, t.resultedDate);
if(tat!==null){ tatSum += tat; tatN++; }
}
const avgTat = tatN ? (tatSum/tatN).toFixed(1) : "—";

box.innerHTML = `
<div class="row" style="justify-content:space-between; align-items:flex-start">
<div>
<h3>Testing, Lab, and Results Tracker</h3>
<div class="muted mini">Track ordered → collected → pending → resulted, plus retest due dates and communications.</div>
</div>
<div class="row noprint edit-only" style="gap:8px">
<button class="btn primary" id="btnNewTest">Add Test</button>
</div>
</div>

<div class="sep"></div>

<div class="row" style="gap:8px; flex-wrap:wrap">
<span class="badge">Ordered: ${counts.Ordered}</span>
<span class="badge blue">Pending: ${counts.Pending}</span>
<span class="badge green">Resulted: ${counts.Resulted}</span>
<span class="badge red">Retest due: ${counts.RetestDue}</span>
<span class="badge">Avg TAT (collected→result): ${avgTat} days</span>
</div>

<div class="sep"></div>

<div style="overflow:auto; border:1px solid var(--line); border-radius:14px">
<table>
<thead>
<tr>
<th style="width:90px">Status</th>
<th style="width:70px">Room</th>
<th>Resident</th>
<th style="width:120px">MRN</th>
<th style="width:150px">Test Type</th>
<th style="width:120px">Ordered</th>
<th style="width:120px">Collected</th>
<th style="width:120px">Resulted</th>
<th style="width:110px">Result</th>
<th style="width:110px">Retest Due</th>
<th style="width:110px">Communicated</th>
<th>Notes</th>
<th style="width:120px" class="noprint edit-only">Actions</th>
</tr>
</thead>
<tbody>
${rows.length ? rows.map(t=>{
const r = t.residentId ? s.residentsById[t.residentId] : null;
const room = r?.room || r?.lockedRoom || "";
const name = r?.name || "";
const mrn  = r?.mrn || t.mrn || "";
const st = testStatus(t);
const badgeCls = st==="Pending" ? "blue" : (st==="Resulted" ? "green" : (st==="Ordered" ? "" : ""));
const comm = (t.communicated||"N")==="Y" ? `Y (${t.communicatedDate||""})` : "N";
return `<tr>
<td class="nowrap"><span class="badge ${badgeCls}">${escapeHtml(st)}</span></td>
<td class="nowrap">${escapeHtml(room)}</td>
<td>${escapeHtml(name)}</td>
<td class="nowrap">${escapeHtml(mrn)}</td>
<td>${escapeHtml(t.testType||"")}</td>
<td class="nowrap">${escapeHtml(t.orderedDate||"")}</td>
<td class="nowrap">${escapeHtml(t.collectedDate||"")}</td>
<td class="nowrap">${escapeHtml(t.resultedDate||"")}</td>
<td>${escapeHtml(t.result||"")}</td>
<td class="nowrap">${escapeHtml(t.retestDue||"")}</td>
<td class="nowrap">${escapeHtml(comm)}</td>
<td class="muted">${escapeHtml(t.notes||"")}</td>
<td class="noprint edit-only nowrap">
<button class="smallbtn" onclick="openIpTestModal('${escapeHtml(t.id)}')">Edit</button>
</td>
</tr>`;
}).join("") : `<tr><td colspan="13" class="muted">No test records yet.</td></tr>`}
</tbody>
</table>
</div>
`;

const btn = document.getElementById("btnNewTest");
if(btn && !btn.dataset.bound){
btn.dataset.bound="1";
btn.addEventListener("click", ()=>openIpTestModal(null));
}
}


function ensureOutbreakData(s){
  ensureIpData(s); ensureConfig(s);
  s.modules = s.modules || {}; s.modules.ip = s.modules.ip || {};
  s.modules.ip.lineListCases = Array.isArray(s.modules.ip.lineListCases) ? s.modules.ip.lineListCases : [];
  s.modules.ip.contacts = Array.isArray(s.modules.ip.contacts) ? s.modules.ip.contacts : [];
  // Outbreak defaults (editable in code; future: add UI in Admin)
  s.modules.ip.outbreakCfg = s.modules.ip.outbreakCfg || { exposureBackDays: 2, exposureForwardDays: 7 };
}
function newCaseId(){ return "CASE-" + Math.random().toString(16).slice(2) + "-" + Date.now().toString(16); }

function openAddOutbreakCaseModal(){
  const s = Store.load(); ensureOutbreakData(s);
  const user = getCurrentUser(s);
  const units = (s.config.units||[]).map(u=>u.unitKey);
  openModal("Add Outbreak Case (Case-first)", `
    <div class="grid cols2">
      <div>
        <label>Resident (active census)</label>
        <select id="ob_res_select"></select>
        <input id="ob_residentId" type="hidden" />
        <div class="muted mini">Standardized resident picker (auto-fills name/MRN/unit/room).</div>
      </div>
      <div>
        <label>Onset Date</label>
        <input id="ob_onset" type="date" value="${dayISO(new Date())}" />
      </div>
      <div>
        <label>Syndrome / Condition</label>
        <input id="ob_syndrome" placeholder="e.g., GI (N/V/D), ILI, COVID, UTI..." />
      </div>
      <div>
        <label>Unit</label>
        <select id="ob_unit">
          <option value="">(auto)</option>
          ${(s.config.units||[]).map(u=>`<option value="${escapeHtml(u.unitKey)}">${escapeHtml(u.unitName||u.unitKey)}</option>`).join("")}
        </select>
      </div>
      <div>
        <label>Room</label>
        <input id="ob_room" placeholder="e.g., 201A" />
      </div>
      <div>
        <label>Status</label>
        <select id="ob_status">
          <option value="suspected">Suspected</option>
          <option value="confirmed">Confirmed</option>
          <option value="ruledout">Ruled Out</option>
          <option value="resolved">Resolved</option>
        </select>
      </div>
    </div>
    <div style="margin-top:10px">
      <label>Notes</label>
      <textarea id="ob_notes" rows="3" placeholder="Key details, test date/result, isolation start..."></textarea>
    </div>

    <div class="card" style="margin-top:12px; box-shadow:none; border:1px solid rgba(0,0,0,.08)">
      <h3 style="margin:0 0 8px">Follow-up Schedule</h3>
      <div class="muted mini">Set due dates for 7/30/90-day checks. Document results when completed.</div>
      <div id="fuWrap"></div>
      <div class="sep"></div>
      <div class="grid cols2" style="gap:10px">
        <div>
          <label>Effectiveness Status</label>
          <select id="eff_status">
            <option value="">(not assessed)</option>
            <option value="effective">Effective</option>
            <option value="partially_effective">Partially effective</option>
            <option value="not_effective">Not effective</option>
          </select>
        </div>
        <div>
          <label>Effectiveness Note</label>
          <input id="eff_note" placeholder="Short outcome note (e.g., no repeat cases in 30 days)"/>
        </div>
      </div>
    </div>
    <div class="sep"></div>
    <div class="row end" style="gap:8px">
      <button class="btn" onclick="closeModal()">Cancel</button>
      <button class="btn primary" onclick="saveOutbreakCaseFromModal()">Save Case</button>
    </div>
    <div class="muted mini" style="margin-top:8px">Prepared by: <b>${escapeHtml(user.name||"")}</b></div>
  `);
  // Standard resident picker bind
  try{
    const residents = getActiveResidents(s);
    const sel = document.getElementById("ob_res_select");
    if(sel){ sel.innerHTML = residentOptionsHtml(residents, ""); }
    bindResidentPicker("ob_res_select", { residentIdHidden:"ob_residentId", name:null, mrn:null, unit:"ob_unit", room:"ob_room" });
  }catch(e){}
}
window.saveOutbreakCaseFromModal = function(){
  const s = Store.load(); ensureOutbreakData(s);
  const residentId = (document.getElementById("ob_res_select")?.value||"").trim();
  if(!residentId){ toastSafe("Select a resident from census."); return; }

  const onset = document.getElementById("ob_onset")?.value || "";
  const syndrome = (document.getElementById("ob_syndrome")?.value||"").trim();
  const unit = (document.getElementById("ob_unit")?.value||"").trim();
  const room = (document.getElementById("ob_room")?.value||"").trim();
  const status = (document.getElementById("ob_status")?.value||"suspected").trim();
  const notes = (document.getElementById("ob_notes")?.value||"").trim();

  const rr = s.residentsById?.[residentId] || null;
  const residentName = rr?.name || "";
  const mrn = rr?.mrn || "";

  if(!residentName){
    toastSafe("Selected resident not found in census mapping.");
    return;
  }
  if(!onset || !syndrome){
    toastSafe("Onset date and Syndrome are required.");
    return;
  }

  const rec = {
    id: makeOutbreakId(),
    residentId,
    residentName,
    mrn,
    unit: unit || (rr?.unit||""),
    room: (room || rr?.room || "").toUpperCase(),
    onsetDate: onset,
    syndrome,
    status,
    notes,
    createdAt: dayISO(new Date()),
    updatedAt: dayISO(new Date())
  };

  Store.patch(st=>{
    ensureOutbreakData(st);
    st.modules.outbreak.cases = st.modules.outbreak.cases || [];
    st.modules.outbreak.cases.unshift(rec);
  });
  auditTrail("outbreak_case_added", { syndrome, unit: rec.unit, room: rec.room });
  toastSafe("Outbreak case saved.");
  closeModal();
  try{ safeRenderAll(); }catch(e){}
};

function autoGenerateContactsForCase(s, caseObj){
  // Simple, survey-friendly default: same room or same unit as contacts.
  // You can refine later with exposure windows and roommate logic.
  const contacts = [];
  const residents = Object.values(s.residentsById||{}).filter(r=>r && r.isActive);
  const unit = caseObj.unit || "";
  const room = (caseObj.room||"").trim();
  for(const r of residents){
    if(caseObj.residentId && r.id===caseObj.residentId) continue;
    if(room && (r.room||"").trim()===room){
      contacts.push({ caseId: caseObj.id, residentId:r.id, residentName:r.name||"", mrn:r.mrn||"", unit:r.unit||"", room:r.room||"", exposure:"Same room", risk:"High", action:"Monitor", createdAt:new Date().toISOString() });
    } else if(unit && (r.unit||"")===unit){
      contacts.push({ caseId: caseObj.id, residentId:r.id, residentName:r.name||"", mrn:r.mrn||"", unit:r.unit||"", room:r.room||"", exposure:"Same unit", risk:"Medium", action:"Monitor", createdAt:new Date().toISOString() });
    }
  }
  return dedupeBy(contacts, x=>`${x.caseId||''}|${x.residentId||''}`);
}

function renderIpOutbreak(s){
  const host = document.getElementById('ipView_outbreak');
  if(!host) return;
ensureOutbreakData(s);
  const cases = s.modules.ip.lineListCases || [];
  const _f = (FILTERS.outbreak||"");
  if(_f){ cases = (cases||[]).filter(r=> rowMatchesFilter(`${r.name||r.residentName||""} ${r.mrn||""} ${r.room||""} ${r.unit||""}`, _f)); }

  const contacts = s.modules.ip.contacts || [];
  const unitFilter = s.ui.unitFilter || "ALL";

  const filteredCases = (unitFilter==="ALL") ? cases : cases.filter(c => (c.unit||"")===unitFilter);
  const htmlList = filteredCases.map(c=>{
    const cContacts = contacts.filter(x=>x.caseId===c.id);
    return `
      <div class="card" style="padding:10px; margin:10px 0;">
        <div class="row between">
          <div>
            <div style="font-weight:800">${escapeHtml(c.residentName||"(Unknown)")}</div>
            <div class="muted mini">Onset: ${escapeHtml(c.onsetDate||"")} • ${escapeHtml(c.syndrome||"")} • ${escapeHtml((c.unit||"") + (c.room?(" / "+c.room):""))}</div>
          </div>
          <div class="row" style="gap:8px">
            <span class="pill">${escapeHtml(c.status||"")}</span>
            <button class="smallbtn" onclick="openOutbreakCase('${escapeHtml(c.id)}')">Open</button>
          </div>
        </div>
        <div class="muted mini" style="margin-top:6px">Contacts: <b>${cContacts.length}</b></div>
      </div>
    `;
  }).join("");

  document.getElementById('ipView_outbreak').innerHTML = `
    <div class="row between" style="margin-bottom:8px">
      <div>
        <h3 style="margin:0">Outbreak Engine (Case-first)</h3>
        <div class="muted mini">Add cases first → auto-generate contact tracing + survey-ready line listing from the same source.</div>
      </div>
      <div class="row" style="gap:8px">
        <button class="btn" onclick="openAddOutbreakCaseModal()">+ Add Case</button>
        <button class="btn" onclick="printOutbreakLineListing()">Print Line Listing</button>
        <button class="btn" onclick="printOutbreakPacketPage()">Packet Page</button>
      </div>
    </div>
    <div class="sep"></div>
    ${htmlList || `<div class="muted">No cases yet. Click “Add Case”.</div>`}
  `;
}

window.openOutbreakCase = function(caseId){
  const s = Store.load(); ensureOutbreakData(s);
  const c = (s.modules.ip.lineListCases||[]).find(x=>x.id===caseId);
  if(!c){ toast("Case not found."); return; }
  const existing = (s.modules.ip.contacts||[]).filter(x=>x.caseId===caseId);
  openModal("Outbreak Case", `
    <div class="grid cols2">
      <div><b>Resident:</b> ${escapeHtml(c.residentName||"")}</div>
      <div><b>Onset:</b> ${escapeHtml(c.onsetDate||"")}</div>
      <div><b>Syndrome:</b> ${escapeHtml(c.syndrome||"")}</div>
      <div><b>Location:</b> ${escapeHtml((c.unit||"") + (c.room?(" / "+c.room):""))}</div>
    </div>
    ${c.notes ? `<div class="sep"></div><div><b>Notes:</b><div class="muted mini">${escapeHtml(c.notes)}</div></div>` : ``}
    <div class="sep"></div>
    <div class="row between">
      <div><b>Contact Tracing</b> <span class="muted mini">(from same source of truth)</span></div>
      <div class="row" style="gap:8px">
        <button class="btn" onclick="openEditOutbreakCaseModal('${escapeHtml(caseId)}')">Edit Case</button>
        <button class="btn" onclick="generateContactsForCase('${escapeHtml(caseId)}')">Auto-Generate Contacts</button>
        <button class="btn primary" onclick="openContactTracingFromCase('${escapeHtml(caseId)}')">View Contacts</button>
      </div>
    </div>
    <div class="muted mini" style="margin-top:6px">Current contacts: <b>${existing.length}</b></div>
  `);
};


window.openEditOutbreakCaseModal = function(caseId){
  const s = Store.load(); ensureOutbreakData(s);
  const c = (s.modules.ip.lineListCases||[]).find(x=>x.id===caseId);
  if(!c){ toastSafe("Case not found."); return; }
  openModal("Edit Outbreak Case", `
    <div class="grid cols2">
      <div>
        <label>Resident</label>
        <input id="ob_edit_res" value="${escapeHtml(c.residentName||"")}" />
        <div class="muted mini">Name is editable (case log). MRN/Resident link preserved if available.</div>
      </div>
      <div>
        <label>Onset Date</label>
        <input id="ob_edit_onset" type="date" value="${escapeHtml(c.onsetDate||"")}" />
      </div>
      <div>
        <label>Syndrome / Condition</label>
        <input id="ob_edit_syndrome" value="${escapeHtml(c.syndrome||"")}" />
      </div>
      <div>
        <label>Status</label>
        <select id="ob_edit_status">
          ${["suspected","confirmed","ruledout","resolved"].map(v=>`<option value="${v}" ${c.status===v?"selected":""}>${v}</option>`).join("")}
        </select>
      </div>
      <div>
        <label>Unit</label>
        <input id="ob_edit_unit" value="${escapeHtml(c.unit||"")}" />
      </div>
      <div>
        <label>Room</label>
        <input id="ob_edit_room" value="${escapeHtml(c.room||"")}" />
      </div>
    </div>
    <div style="margin-top:10px">
      <label>Notes</label>
      <textarea id="ob_edit_notes" rows="3">${escapeHtml(c.notes||"")}</textarea>
    </div>

    <div class="card" style="margin-top:12px; box-shadow:none; border:1px solid rgba(0,0,0,.08)">
      <h3 style="margin:0 0 8px">Follow-up Schedule</h3>
      <div class="muted mini">Set due dates for 7/30/90-day checks. Document results when completed.</div>
      <div id="fuWrap"></div>
      <div class="sep"></div>
      <div class="grid cols2" style="gap:10px">
        <div>
          <label>Effectiveness Status</label>
          <select id="eff_status">
            <option value="">(not assessed)</option>
            <option value="effective">Effective</option>
            <option value="partially_effective">Partially effective</option>
            <option value="not_effective">Not effective</option>
          </select>
        </div>
        <div>
          <label>Effectiveness Note</label>
          <input id="eff_note" placeholder="Short outcome note (e.g., no repeat cases in 30 days)"/>
        </div>
      </div>
    </div>
    <div class="sep"></div>
    <div class="row between" style="gap:8px; flex-wrap:wrap">
      <button class="btn danger" onclick="deleteOutbreakCase('${escapeHtml(caseId)}')">Delete Case</button>
      <div class="row" style="gap:8px">
        <button class="btn" onclick="closeModal()">Cancel</button>
        <button class="btn primary" onclick="saveEditedOutbreakCase('${escapeHtml(caseId)}')">Save Changes</button>
      </div>
    </div>
  `);
};

window.saveEditedOutbreakCase = function(caseId){
  const name = (document.getElementById("ob_edit_res")?.value||"").trim();
  const onset = document.getElementById("ob_edit_onset")?.value || "";
  const syndrome = (document.getElementById("ob_edit_syndrome")?.value||"").trim();
  const status = (document.getElementById("ob_edit_status")?.value||"suspected").trim();
  const unit = (document.getElementById("ob_edit_unit")?.value||"").trim();
  const room = (document.getElementById("ob_edit_room")?.value||"").trim();
  const notes = (document.getElementById("ob_edit_notes")?.value||"").trim();
  Store.patch(st=>{
    ensureOutbreakData(st);
    const idx = (st.modules.ip.lineListCases||[]).findIndex(x=>x.id===caseId);
    if(idx<0) return;
    const c = st.modules.ip.lineListCases[idx];
    c.residentName = name || c.residentName;
    c.onsetDate = onset;
    c.syndrome = syndrome;
    c.status = status;
    c.unit = unit;
    c.room = room;
    c.notes = notes;
    c.updatedAt = new Date().toISOString();
  });
  closeModal();
  toastSafe("Case updated.");
  try{ setIpView("outbreak"); }catch(e){}
};

window.deleteOutbreakCase = function(caseId){
  if(!confirm("Delete this case? This will also remove linked contacts.")) return;
  Store.patch(st=>{
    ensureOutbreakData(st);
    st.modules.ip.lineListCases = (st.modules.ip.lineListCases||[]).filter(x=>x.id!==caseId);
    st.modules.ip.contacts = (st.modules.ip.contacts||[]).filter(x=>x.caseId!==caseId);
  });
  closeModal();
  toastSafe("Case deleted.");
  try{ setIpView("outbreak"); }catch(e){}
};

window.generateContactsForCase = function(caseId){
  const s = Store.load(); ensureOutbreakData(s);
  const c = (s.modules.ip.lineListCases||[]).find(x=>x.id===caseId);
  if(!c){ toast("Case not found."); return; }
  const gen = autoGenerateContactsForCase(s, c);
  Store.patch(st=>{
    ensureOutbreakData(st);
    // Remove existing contacts for this case, then add generated
    st.modules.ip.contacts = (st.modules.ip.contacts||[]).filter(x=>x.caseId!==caseId).concat(gen);
  });
  toast("Contacts generated.");
};

window.openContactTracingFromCase = function(caseId){
  // Switch to CT view and filter by caseId
  const s = Store.load(); ensureOutbreakData(s);
  s.ui = s.ui || {};
  s.ui.role = s.ui.role || 'admin'; // admin | staff | surveyor
  s.ui.ctCaseFilter = caseId;
  Store.save(s);
  setIpView('ct');
};

// Patch CT renderer to honor ctCaseFilter if present (non-destructive)
function getContactsFilteredForUI(s){
  ensureOutbreakData(s);
  const caseId = s.ui?.ctCaseFilter || "";
  if(!caseId) return (s.modules.ip.contacts||[]);
  return (s.modules.ip.contacts||[]).filter(x=>x.caseId===caseId);
}


window.printOutbreakPacketPage = function(caseId=""){
  const s = Store.load(); ensureOutbreakData(s);
  const facility = s.config.facilityName || "Facility";
  const unitFilter = s.ui?.unitFilter || "ALL";
  const casesAll = s.modules.ip.lineListCases || [];
  const cases = caseId ? casesAll.filter(c=>c.id===caseId) : (unitFilter==="ALL" ? casesAll : casesAll.filter(c=>(c.unit||"")===unitFilter));
  const contactsAll = s.modules.ip.contacts || [];
  const contacts = caseId ? contactsAll.filter(x=>x.caseId===caseId) : contactsAll;

  const caseRows = cases.map(c=>`
    <tr>
      <td>${escapeHtml(c.residentName||"")}</td>
      <td>${escapeHtml(c.mrn||"")}</td>
      <td>${escapeHtml(c.unit||"")}</td>
      <td>${escapeHtml(c.room||"")}</td>
      <td>${escapeHtml(c.onsetDate||"")}</td>
      <td>${escapeHtml(c.syndrome||"")}</td>
      <td>${escapeHtml(c.status||"")}</td>
      <td>${escapeHtml((c.notes||"").slice(0,160))}</td>
    </tr>
  `).join("");
  const contactRows = contacts.map(c=>`
    <tr>
      <td>${escapeHtml(c.caseId||"")}</td>
      <td>${escapeHtml(c.residentName||"")}</td>
      <td>${escapeHtml(c.mrn||"")}</td>
      <td>${escapeHtml(c.unit||"")}</td>
      <td>${escapeHtml(c.room||"")}</td>
      <td>${escapeHtml(c.exposure||"")}</td>
      <td>${escapeHtml(c.risk||"")}</td>
      <td>${escapeHtml(c.action||"")}</td>
    </tr>
  `).join("");

  openPrintWindow(`
    <html><head><title>Outbreak Packet Page</title>
      <style>
        body{font-family:Arial,Helvetica,sans-serif; margin:16px;}
        h1{font-size:18px; margin:0 0 6px;}
        h2{font-size:14px; margin:14px 0 6px;}
        .muted{color:#555; font-size:12px;}
        table{width:100%; border-collapse:collapse; font-size:12px;}
        th,td{border:1px solid #ddd; padding:6px; vertical-align:top;}
        th{background:#f3f5f7; text-align:left;}
        .small{font-size:11px;}
      </style>
    </head>
    <body>
      <h1>${escapeHtml(facility)} — Outbreak Packet Page</h1>
      <div class="muted">Generated: ${escapeHtml(dayISO(new Date()))} • Unit Filter: ${escapeHtml(unitFilter)}</div>

      <h2>Line Listing</h2>
      <table>
        <thead>
          <tr>
            <th>Resident</th><th>MRN</th><th>Unit</th><th>Room</th>
            <th>Onset</th><th>Syndrome</th><th>Status</th><th>Notes</th>
          </tr>
        </thead>
        <tbody>${caseRows || `<tr><td colspan="8" class="muted">No cases in current filter.</td></tr>`}</tbody>
      </table>

      <h2>Contact Tracing (Linked Source of Truth)</h2>
      <table>
        <thead>
          <tr>
            <th class="small">Case ID</th><th>Resident</th><th>MRN</th><th>Unit</th><th>Room</th>
            <th>Exposure</th><th>Risk</th><th>Action</th>
          </tr>
        </thead>
        <tbody>${contactRows || `<tr><td colspan="8" class="muted">No contacts generated.</td></tr>`}</tbody>
      </table>
    </body></html>
  `);
};

window.printOutbreakLineListing = function(){
  const s = Store.load(); ensureOutbreakData(s);
  const cases = s.modules.ip.lineListCases || [];
  if(!cases.length){ toast("No cases to print."); return; }
  const facility = s.config.facilityName || "Facility";
  const rows = cases.map(c=>`
    <tr>
      <td>${escapeHtml(c.residentName||"")}</td>
      <td>${escapeHtml(c.mrn||"")}</td>
      <td>${escapeHtml(c.unit||"")}</td>
      <td>${escapeHtml(c.room||"")}</td>
      <td>${escapeHtml(c.onsetDate||"")}</td>
      <td>${escapeHtml(c.syndrome||"")}</td>
      <td>${escapeHtml(c.status||"")}</td>
      <td>${escapeHtml((c.notes||"").slice(0,120))}</td>
    </tr>
  `).join("");
  openPrintWindow(`
    <html><head><title>Line Listing</title>
      <style>
        body{font-family:Arial,Helvetica,sans-serif; margin:16px;}
        h1{font-size:18px; margin:0 0 8px;}
        .muted{color:#555; font-size:12px;}
        table{width:100%; border-collapse:collapse; font-size:12px;}
        th,td{border:1px solid #ddd; padding:6px; vertical-align:top;}
        th{background:#f3f5f7; text-align:left;}
      </style>
    </head>
    <body>
      <h1>${escapeHtml(facility)} — Outbreak Line Listing</h1>
      <div class="muted">Generated: ${escapeHtml(dayISO(new Date()))}</div>
      <div class="sep"></div>
      <table>
        <thead>
          <tr>
            <th>Resident</th><th>MRN</th><th>Unit</th><th>Room</th>
            <th>Onset</th><th>Syndrome</th><th>Status</th><th>Notes</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </body></html>
  `);
};

function renderIpContactTracing(s){
const box = document.getElementById("ipView_ct");
if(!box) return;

const recs = (s.modules.ip.contacts||[]).slice()
.sort((a,b)=> (b.exposureDate||b.date||"").localeCompare(a.exposureDate||a.date||""));

const activeCases = (s.modules.ip.lineListCases||[]).slice()
.filter(x=>(x.status||"active")!=="resolved")
.sort((a,b)=> (a.room||"").localeCompare(b.room||"", undefined, {numeric:true}));

box.innerHTML = `
<div class="row" style="justify-content:space-between; align-items:flex-end">
<div>
<h3>Contact Tracing</h3>
<div class="muted mini">Links cases to residents/staff/visitors. Use “Case Workspace” for monitoring/testing plans.</div>
</div>
<div class="row noprint" style="gap:8px; flex-wrap:wrap; align-items:center">
<select id="ct_casePick" class="smallsel" style="min-width:260px">
<option value="">Open Case Workspace…</option>
${activeCases.map(c=>`<option value="${escapeHtml(c.id)}">${escapeHtml(getCaseLabel(s,c))}</option>`).join("")}
</select>
<button class="smallbtn" onclick="(function(){const id=document.getElementById('ct_casePick')?.value||''; if(id) openIpContactWorkspace(id);})()">Open</button>

<button class="smallbtn" onclick="openIpContactModalForCase(null)">New Contact Record</button>
<button class="smallbtn" onclick="openIpDirectoryModal('staff')">Manage Staff</button>
<button class="smallbtn" onclick="openIpDirectoryModal('visitors')">Manage Visitors</button>
</div>
</div>
<div class="sep"></div>
${recs.length ? `
<table>
<thead><tr>
<th style="width:110px">Exposure</th>
<th>Case</th>
<th style="width:120px">Type</th>
<th style="width:220px">Contact</th>
<th style="width:120px">Status</th>
<th style="width:110px">Test Due</th>
<th style="width:180px">Outcome</th>
<th>Notes</th>
<th style="width:120px">By</th>
<th style="width:110px" class="noprint">Action</th>
</tr></thead>
<tbody>
${recs.map(r=>`
<tr>
<td class="nowrap">${escapeHtml(r.exposureDate||r.date||"")}</td>
<td>${escapeHtml(r.caseLabel||"")}</td>
<td class="nowrap">${escapeHtml(r.contactType||"")}</td>
<td>${escapeHtml(r.contactName||"")}</td>
<td class="nowrap">${escapeHtml(r.status||"")}</td>
<td class="nowrap">${escapeHtml(r.testDueDate||"")}</td>
<td>${escapeHtml(r.outcome||"")}</td>
<td class="muted">${escapeHtml(r.notes||"")}</td>
<td class="nowrap">${escapeHtml(r.author||"")}</td>
<td class="noprint nowrap">
${r.caseId ? `<button class="smallbtn" onclick="openIpContactWorkspace('${escapeHtml(r.caseId)}')">Workspace</button>`
: `<button class="smallbtn" onclick="openIpContactRecordModal('','${escapeHtml(r.id)}')">Edit</button>`}
</td>
</tr>
`).join("")}
</tbody>
</table>
` : `<div class="muted">No contact tracing records yet.</div>`}
`;
}

function openIpCaseModal(caseId){
const s = Store.load();
ensureIpData(s);

const c = caseId ? (s.modules.ip.lineListCases||[]).find(x=>x.id===caseId) : null;
const kind0 = c?.kind || (s.modules.ip.ui.view==="gi" ? "gi" : "resp");

const respChips = ["Fever","Cough","SOB","Sore throat","Rhinorrhea","Headache","Other"];
const giChips = ["Diarrhea","Vomiting","Abdominal pain","Fever","Nausea","Other"];

const selectedResp = new Set((c?.symptomList||c?.symptomsList||c?.symptomsArr||c?.symptoms||[])); // legacy safety
const selectedGi = new Set((c?.giSymList||[]));

openModal(`${caseId?"Edit":"Add"} Line List Case`, `
<div class="grid cols3">
<div><label>Type</label>
<select id="ipCase_kind" onchange="ipLineListModalSync()">
<option value="resp" ${kind0==="resp"?"selected":""}>Respiratory</option>
<option value="gi" ${kind0==="gi"?"selected":""}>GI</option>
</select>
</div>
<div><label>Onset Date</label><input id="ipCase_onset" type="date" value="${escapeHtml(c?.onsetDate||"")}"/></div>
<div><label>Status</label>
<select id="ipCase_status">
<option value="active" ${(c?.status||"active")==="active"?"selected":""}>Active</option>
<option value="resolved" ${(c?.status||"active")==="resolved"?"selected":""}>Resolved</option>
</select>
</div>
</div>

<div class="grid cols3" style="margin-top:10px">
<div><label>Resident (active census)</label>
<select id="ipCase_res_select"></select>
<input id="ipCase_residentId" type="hidden" value="${escapeHtml(c?.residentId||"")}"/>
<div class="muted mini">Selecting a resident auto-fills Name/MRN/Unit/Room and enforces cross-module mapping.</div>
</div>
<div><label>Name</label><input id="ipCase_name" type="text" value="${escapeHtml(c?.name||"")}" readonly/></div>
<div><label>MRN</label><input id="ipCase_mrn" type="text" value="${escapeHtml(c?.mrn||"")}" readonly/></div>
<div><label>Room</label><input id="ipCase_room" type="text" value="${escapeHtml(c?.room||"")}"/></div>
</div>

<div class="grid cols3" style="margin-top:10px">
<div><label>Unit</label><input id="ipCase_unit" type="text" value="${escapeHtml(c?.unit||"")}"/></div>
<div><label>Antibiotic</label><input id="ipCase_abx" type="text" value="${escapeHtml(c?.antibiotic||"")}"/></div>
<div><label>Lab/Results</label><input id="ipCase_lab" type="text" value="${escapeHtml(c?.lab||"")}"/></div>
</div>

<div style="margin-top:10px">
<label>Symptoms</label>

<div id="symRespWrap" class="row" style="gap:8px; flex-wrap:wrap; margin-top:6px">
${respChips.map(o=>`<label class="chip" style="cursor:pointer"><input class="ipSymResp" type="checkbox" value="${escapeHtml(o)}" ${selectedResp.has(o)?"checked":""}/><span>${escapeHtml(o)}</span></label>`).join("")}
</div>

<div id="symGiWrap" class="row" style="gap:8px; flex-wrap:wrap; margin-top:6px; display:none">
${giChips.map(o=>`<label class="chip" style="cursor:pointer"><input class="ipSymGi" type="checkbox" value="${escapeHtml(o)}" ${selectedGi.has(o)?"checked":""}/><span>${escapeHtml(o)}</span></label>`).join("")}
</div>

<div class="muted mini" style="margin-top:6px">These selections populate the corresponding print templates.</div>
</div>

<!-- Respiratory template fields -->
<div id="respTemplateBlock" style="display:none">
<div class="sep"></div>
<h3>Respiratory Template Fields (ILI)</h3>

<div class="grid cols3">
<div><label>Sex (M/F)</label><input id="ipResp_sex" type="text" value="${escapeHtml(c?.sex||"")}"/></div>
<div><label>Influenza Vaccine (Y/N)</label><input id="ipResp_fluVax" type="text" value="${escapeHtml(c?.fluVax||"")}"/></div>
<div><label>Pneum Vaccine (Y/N)</label><input id="ipResp_pneumoVax" type="text" value="${escapeHtml(c?.pneumoVax||"")}"/></div>
</div>

<div style="margin-top:10px">
<label>Predisposing Factors</label>
<div class="row" style="gap:10px; flex-wrap:wrap; margin-top:6px">
${["cvd","copd","dm","anemia","renal","ca","steroids"].map(k=>{
const label = k.toUpperCase();
const checked = (c?.predispose||{})[k] ? "checked" : "";
return `<label class="chip" style="cursor:pointer"><input type="checkbox" class="ipPf" data-k="${k}" ${checked}/><span>${label}</span></label>`;
}).join("")}
</div>
</div>

<div style="margin-top:10px">
<label>ILI Symptoms (template columns)</label>
<div class="grid cols3">
<div><label>Highest Temp</label><input id="ipResp_highestTemp" type="text" value="${escapeHtml((c?.symptoms||{}).highestTemp||"")}"/></div>
<div class="row" style="gap:10px; flex-wrap:wrap; grid-column: span 2; align-items:flex-end">
${[
["cough","Cough"],
["congestion","Congestion"],
["soreThroat","Sore Throat"],
["pharyngitis","Pharyngitis"],
["rhinitis","Rhinitis"],
["headache","Headache"]
].map(([k,lbl])=>{
const checked = (c?.symptoms||{})[k] ? "checked" : "";
return `<label class="chip" style="cursor:pointer"><input type="checkbox" class="ipRespSym" data-k="${k}" ${checked}/><span>${lbl}</span></label>`;
}).join("")}
</div>
</div>
</div>

<div class="grid cols3" style="margin-top:10px">
<div><label>Duration of Fever</label><input id="ipResp_durFever" type="text" value="${escapeHtml(c?.durationFever||"")}"/></div>
<div><label>Hosp. Date</label><input id="ipResp_hospDate" type="date" value="${escapeHtml(c?.hospDate||"")}"/></div>
<div><label>Date Died</label><input id="ipResp_dateDied" type="date" value="${escapeHtml(c?.dateDied||"")}"/></div>
</div>

<div class="grid cols3" style="margin-top:10px">
<div><label>Lab Results</label><input id="ipResp_labResults" type="text" value="${escapeHtml(c?.labResults||"")}"/></div>
<div><label>X-Ray</label><input id="ipResp_xray" type="text" value="${escapeHtml(c?.xray||"")}"/></div>
<div><label>Pneumonia</label><input id="ipResp_pneumonia" type="text" value="${escapeHtml(c?.pneumonia||"")}"/></div>
</div>
</div>

<!-- GI template fields -->
<div id="giTemplateBlock" style="display:none">
<div class="sep"></div>
<h3>GI Line List Template Fields</h3>
<div class="muted mini">Matches the “LTC Acute Gastroenteritis Surveillance Line List”. These fields feed the GI print template.</div>
<div class="sep"></div>

<div class="grid cols3">
<div><label>Age</label><input id="ipGI_age" type="text" value="${escapeHtml(c?.gi?.age||"")}"/></div>
<div><label>Sex (M/F)</label><input id="ipGI_sex" type="text" value="${escapeHtml(c?.gi?.sex||"")}"/></div>
<div><label>Resident or Staff</label>
<select id="ipGI_caseType">
<option value="Resident" ${(c?.gi?.caseType||"Resident")==="Resident"?"selected":""}>Resident</option>
<option value="Staff" ${(c?.gi?.caseType||"Resident")==="Staff"?"selected":""}>Staff</option>
</select>
</div>
</div>

<div class="grid cols3" style="margin-top:10px">
<div><label>Resident Stay</label>
<select id="ipGI_stay">
<option value="" ${!c?.gi?.stay?"selected":""}>—</option>
<option value="S" ${(c?.gi?.stay||"")==="S"?"selected":""}>Short stay (S)</option>
<option value="L" ${(c?.gi?.stay||"")==="L"?"selected":""}>Long stay (L)</option>
</select>
</div>
<div><label>Building/Floor/Unit</label><input id="ipGI_unit" type="text" value="${escapeHtml(c?.gi?.unit||c?.unit||"")}"/></div>
<div><label>Room/Bed</label><input id="ipGI_roomBed" type="text" value="${escapeHtml(c?.gi?.roomBed||c?.room||"")}"/></div>
</div>

<div class="grid cols3" style="margin-top:10px">
<div><label>Staff Only: Primary Assignment</label><input id="ipGI_assignment" type="text" value="${escapeHtml(c?.gi?.assignment||"")}"/></div>
<div><label>Staff Only: Food handler (Y/N)</label><input id="ipGI_food" type="text" value="${escapeHtml(c?.gi?.foodHandler||"")}"/></div>
<div><label>Symptom onset date</label><input id="ipGI_onset" type="date" value="${escapeHtml(c?.gi?.onsetDate||c?.onsetDate||"")}"/></div>
</div>

<div class="grid cols3" style="margin-top:10px">
<div><label>Abdominal pain/tenderness (Y/N)</label><input id="ipGI_abdPain" type="text" value="${escapeHtml(c?.gi?.abdPain||"")}"/></div>
<div><label>Diarrhea (Y/N)</label><input id="ipGI_diarrhea" type="text" value="${escapeHtml(c?.gi?.diarrhea||"")}"/></div>
<div><label>Vomiting (Y/N)</label><input id="ipGI_vomiting" type="text" value="${escapeHtml(c?.gi?.vomiting||"")}"/></div>
</div>

<div style="margin-top:10px">
<label>Additional documented signs/symptoms (select all that apply)</label>
<div class="row" style="gap:10px; flex-wrap:wrap; margin-top:6px">
${[
["A","Fever"],["B","Diarrhea ≤3 days"],["C","Blood in stool"],["D","Loss of appetite"],
["E","Nausea"],["F","Muscle aches"],["G","Chills"],["H","Headache"],
["I","Cough"],["J","Sore throat"],["K","Runny nose"],["L","Other"]
].map(([code,label])=>{
const checked = (c?.gi?.addSx||[]).includes(code) ? "checked" : "";
return `<label class="chip" style="cursor:pointer"><input type="checkbox" class="ipGI_addSx" value="${code}" ${checked}/><span>${code} — ${label}</span></label>`;
}).join("")}
</div>
</div>

<div class="sep"></div>

<div class="grid cols3">
<div>
<label>Specimen type (select all that apply)</label>
<div class="row" style="gap:10px; flex-wrap:wrap; margin-top:6px">
${[["A","Stool"],["B","Rectal swab"],["C","Vomitus"],["D","Other"]].map(([code,label])=>{
const checked = (c?.gi?.specimen||[]).includes(code) ? "checked" : "";
return `<label class="chip" style="cursor:pointer"><input type="checkbox" class="ipGI_spec" value="${code}" ${checked}/><span>${code} — ${label}</span></label>`;
}).join("")}
</div>
</div>

<div>
<label>Date of collection</label>
<input id="ipGI_collect" type="date" value="${escapeHtml(c?.gi?.collectDate||"")}"/>
</div>

<div>
<label>Test ordered (select all that apply)</label>
<div class="row" style="gap:10px; flex-wrap:wrap; margin-top:6px">
${[
["0","No test performed"],["1","Culture"],["2","PCR"],["3","Enzyme immunoassay"],
["4","O&P"],["5","Other"],["6","Unknown"],["7","Other (specify)"]
].map(([code,label])=>{
const checked = (c?.gi?.tests||[]).includes(code) ? "checked" : "";
return `<label class="chip" style="cursor:pointer"><input type="checkbox" class="ipGI_tests" value="${code}" ${checked}/><span>${code} — ${label}</span></label>`;
}).join("")}
</div>
</div>
</div>

<div style="margin-top:10px">
<label>Pathogen detected (select all that apply)</label>
<div class="row" style="gap:10px; flex-wrap:wrap; margin-top:6px">
${[
["0","Not tested / No result"],["1","C. diff"],["2","PCR panel"],["3","Salmonella / Campy"],
["4","Shigella"],["5","Rotavirus"],["6","Norovirus"],["7","Other (specify)"]
].map(([code,label])=>{
const checked = (c?.gi?.pathogens||[]).includes(code) ? "checked" : "";
return `<label class="chip" style="cursor:pointer"><input type="checkbox" class="ipGI_path" value="${code}" ${checked}/><span>${code} — ${label}</span></label>`;
}).join("")}
</div>
</div>

<div class="grid cols3" style="margin-top:10px">
<div><label>Symptom resolution date</label><input id="ipGI_resolve" type="date" value="${escapeHtml(c?.gi?.resolveDate||"")}"/></div>
<div><label>Hospitalized? (Y/N)</label><input id="ipGI_hosp" type="text" value="${escapeHtml(c?.gi?.hospitalized||"")}"/></div>
<div><label>Died? (Y/N)</label><input id="ipGI_died" type="text" value="${escapeHtml(c?.gi?.died||"")}"/></div>
</div>

<div class="grid cols3" style="margin-top:10px">
<div><label>Case (Y/N)</label>
<select id="ipGI_caseStatus">
<option value="" ${!c?.gi?.caseStatus?"selected":""}>—</option>
<option value="Y" ${(c?.gi?.caseStatus||"")==="Y"?"selected":""}>Y</option>
<option value="N" ${(c?.gi?.caseStatus||"")==="N"?"selected":""}>N</option>
</select>
</div>
<div><label>Notes (template)</label><input id="ipGI_notes" type="text" value="${escapeHtml(c?.gi?.templateNotes||"")}"/></div>
<div></div>
</div>
</div>

<div style="margin-top:10px">
<label>Notes</label>
<input id="ipCase_notes" type="text" value="${escapeHtml(c?.notes||"")}"/>
</div>

<div class="sep"></div>
<div class="row end" style="gap:8px">
${caseId?`<button class="btn danger" onclick="deleteIpCase('${escapeHtml(caseId)}')">Delete</button>`:""}
<button class="btn" onclick="closeModal()">Cancel</button>
<button class="btn primary" onclick="saveIpCase('${escapeHtml(caseId||"")}')">Save</button>
</div>
`);

try{
  const residents = getActiveResidents(s);
  const sel = document.getElementById("ipCase_res_select");
  if(sel){ sel.innerHTML = residentOptionsHtml(residents, c?.residentId||""); sel.value = c?.residentId||""; }
  bindResidentPicker("ipCase_res_select", { residentIdHidden:"ipCase_residentId", name:"ipCase_name", mrn:"ipCase_mrn", unit:"ipCase_unit", room:"ipCase_room" });
}catch(e){}
setTimeout(()=>{ ipLineListModalSync(); }, 0);
}

window.ipLineListModalSync = function(){
const kind = document.getElementById("ipCase_kind")?.value || "resp";
const sr = document.getElementById("symRespWrap");
const sg = document.getElementById("symGiWrap");
const rb = document.getElementById("respTemplateBlock");
const gb = document.getElementById("giTemplateBlock");
if(sr) sr.style.display = (kind==="resp") ? "" : "none";
if(sg) sg.style.display = (kind==="gi") ? "" : "none";
if(rb) rb.style.display = (kind==="resp") ? "" : "none";
if(gb) gb.style.display = (kind==="gi") ? "" : "none";
};
window.saveIpCase = function(caseId){
const kind = document.getElementById("ipCase_kind").value;
const onset = (document.getElementById("ipCase_onset").value||"").trim();
const status = document.getElementById("ipCase_status").value;
const residentId = (document.getElementById("ipCase_res_select")?.value||"").trim() || (document.getElementById("ipCase_residentId")?.value||"").trim();
if(!residentId){ toastSafe("Select a resident from census."); return; }
const name = (document.getElementById("ipCase_name").value||"").trim();
const mrn = (document.getElementById("ipCase_mrn").value||"").trim();
const room = (document.getElementById("ipCase_room").value||"").trim().toUpperCase();
const unit = (document.getElementById("ipCase_unit").value||"").trim();
const abx = (document.getElementById("ipCase_abx").value||"").trim();
const lab = (document.getElementById("ipCase_lab").value||"").trim();
const notes = (document.getElementById("ipCase_notes").value||"").trim();

const symResp = Array.from(document.querySelectorAll(".ipSymResp")).filter(x=>x.checked).map(x=>x.value);
const symGi   = Array.from(document.querySelectorAll(".ipSymGi")).filter(x=>x.checked).map(x=>x.value);

let sex="", fluVax="", pneumoVax="", predispose=null, symptoms=null, durationFever="", hospDate="", dateDied="", labResults="", xray="", pneumonia="";
if(kind==="resp"){
sex = (document.getElementById("ipResp_sex")?.value||"").trim().toUpperCase();
fluVax = (document.getElementById("ipResp_fluVax")?.value||"").trim().toUpperCase();
pneumoVax = (document.getElementById("ipResp_pneumoVax")?.value||"").trim().toUpperCase();
durationFever = (document.getElementById("ipResp_durFever")?.value||"").trim();
hospDate = (document.getElementById("ipResp_hospDate")?.value||"").trim();
dateDied = (document.getElementById("ipResp_dateDied")?.value||"").trim();
labResults = (document.getElementById("ipResp_labResults")?.value||"").trim();
xray = (document.getElementById("ipResp_xray")?.value||"").trim();
pneumonia = (document.getElementById("ipResp_pneumonia")?.value||"").trim();

predispose = {};
document.querySelectorAll(".ipPf").forEach(cb=>{
const k = cb.getAttribute("data-k");
predispose[k] = !!cb.checked;
});

symptoms = {};
symptoms.highestTemp = (document.getElementById("ipResp_highestTemp")?.value||"").trim();
document.querySelectorAll(".ipRespSym").forEach(cb=>{
const k = cb.getAttribute("data-k");
symptoms[k] = !!cb.checked;
});
}

let gi = null;
if(kind==="gi"){
const yn = (v)=> (v||"").toString().trim().toUpperCase();
gi = {
age: (document.getElementById("ipGI_age")?.value||"").trim(),
sex: yn(document.getElementById("ipGI_sex")?.value||""),
caseType: (document.getElementById("ipGI_caseType")?.value||"Resident"),
stay: (document.getElementById("ipGI_stay")?.value||""),
unit: (document.getElementById("ipGI_unit")?.value||"").trim(),
roomBed: (document.getElementById("ipGI_roomBed")?.value||"").trim(),
assignment: (document.getElementById("ipGI_assignment")?.value||"").trim(),
foodHandler: yn(document.getElementById("ipGI_food")?.value||""),
onsetDate: (document.getElementById("ipGI_onset")?.value||onset||""),
abdPain: yn(document.getElementById("ipGI_abdPain")?.value||""),
diarrhea: yn(document.getElementById("ipGI_diarrhea")?.value||""),
vomiting: yn(document.getElementById("ipGI_vomiting")?.value||""),
addSx: Array.from(document.querySelectorAll(".ipGI_addSx")).filter(x=>x.checked).map(x=>x.value),
specimen: Array.from(document.querySelectorAll(".ipGI_spec")).filter(x=>x.checked).map(x=>x.value),
collectDate: (document.getElementById("ipGI_collect")?.value||""),
tests: Array.from(document.querySelectorAll(".ipGI_tests")).filter(x=>x.checked).map(x=>x.value),
pathogens: Array.from(document.querySelectorAll(".ipGI_path")).filter(x=>x.checked).map(x=>x.value),
resolveDate: (document.getElementById("ipGI_resolve")?.value||""),
hospitalized: yn(document.getElementById("ipGI_hosp")?.value||""),
died: yn(document.getElementById("ipGI_died")?.value||""),
caseStatus: (document.getElementById("ipGI_caseStatus")?.value||""),
templateNotes: (document.getElementById("ipGI_notes")?.value||"").trim()
};

const has = (x)=> symGi.includes(x);
if(has("Diarrhea") && !gi.diarrhea) gi.diarrhea = "Y";
if(has("Vomiting") && !gi.vomiting) gi.vomiting = "Y";
if(has("Abdominal pain") && !gi.abdPain) gi.abdPain = "Y";
if(has("Fever") && !gi.addSx.includes("A")) gi.addSx.push("A");
if(has("Nausea") && !gi.addSx.includes("E")) gi.addSx.push("E");
if(has("Other") && !gi.addSx.includes("L")) gi.addSx.push("L");
}

Store.patch(s=>{
ensureIpData(s);
if(caseId){
const c = (s.modules.ip.lineListCases||[]).find(x=>x.id===caseId);
if(!c) return;
Object.assign(c, {
residentId: residentId,
kind, onsetDate:onset, status, name, mrn, room, unit,
antibiotic:abx, lab, notes,
symptomList: (kind==="resp" ? symResp : symGi),
giSymList: (kind==="gi" ? symGi : []),

sex, fluVax, pneumoVax, predispose, symptoms, durationFever, hospDate, dateDied, labResults, xray, pneumonia,

gi,

updatedAt: nowISO()
});
} else {
s.modules.ip.lineListCases.push({
id: uid("ipcase"),
residentId: residentId,
kind, status, onsetDate:onset, name, mrn, room, unit,
antibiotic:abx, lab, notes,
symptomList: (kind==="resp" ? symResp : symGi),
giSymList: (kind==="gi" ? symGi : []),

sex, fluVax, pneumoVax, predispose, symptoms, durationFever, hospDate, dateDied, labResults, xray, pneumonia,
gi,

createdAt: nowISO(),
updatedAt: nowISO()
});
}
});

closeModal();
};
window.deleteIpCase = function(caseId){
if(!confirm("Delete this case?")) return;
Store.patch(s=>{ ensureIpData(s); s.modules.ip.lineListCases = (s.modules.ip.lineListCases||[]).filter(x=>x.id!==caseId); });
closeModal();
};

function openIpContactModalForCase(caseId){
const s = Store.load();
ensureIpData(s);
const c = caseId ? (s.modules.ip.lineListCases||[]).find(x=>x.id===caseId) : null;
const caseLabel = c ? `${ipCaseKindLabel(c.kind)}: ${c.name||""} (${c.room||""})` : "Manual";

openModal("Contact Tracing Record", `
<div class="grid cols3">
<div><label>Date</label><input id="ct_date" type="text" value="${todayISO()}"/></div>
<div><label>Case</label><input type="text" value="${escapeHtml(caseLabel)}" disabled/></div>
<div><label>Contact Type</label>
<select id="ct_type"><option>Resident</option><option>Staff</option><option>Visitor</option></select>
</div>
</div>
<div style="margin-top:10px"><label>Contact Name</label><input id="ct_name" type="text"/></div>
<div class="grid cols2" style="margin-top:10px">
<div><label>Outcome</label><input id="ct_outcome" type="text"/></div>
<div><label>Notes</label><input id="ct_notes" type="text"/></div>
</div>
<div class="sep"></div>
<div class="row end" style="gap:8px">
<button class="btn" onclick="closeModal()">Cancel</button>
<button class="btn primary" onclick="saveContactRecord('${escapeHtml(caseId||"")}')">Save</button>
</div>
`);
}

function openIpPrintLineList(kind){
const s = Store.load();
ensureIpData(s);
const unitFilter = s.ui.unitFilter || "ALL";
let rows = (s.modules.ip.lineListCases||[]).filter(c=>{ const k=(c&&c.kind)||''; return String(k).toLowerCase()===String(kind).toLowerCase(); });
if(unitFilter!=="ALL"){
rows = rows.filter(c => {
  const u = (getUnitKeyFromAny(c.unit||"", s.config) || inferUnitFromRoom(c.room||"", s.config) || c.unit || "");
  return u === unitFilter;
});
}
rows.sort((a,b)=> (a.room||"").localeCompare(b.room||"", undefined, {numeric:true}));
openModal(`${ipCaseKindLabel(kind)} Line List — Print`, `
<div class="noprint row end"><button class="btn primary" onclick="window.print()">Print</button></div>
<div class="card" style="box-shadow:none">
<h2 style="margin:0 0 6px">${escapeHtml(s.config.facilityName||"Facility")}</h2>
<div class="muted mini">${ipCaseKindLabel(kind)} Line List · Unit: ${escapeHtml(unitFilter)} · Printed: ${new Date().toLocaleString()}</div>
<div class="sep"></div>
<table>
<thead><tr><th>Room</th><th>Resident</th><th>Onset</th><th>Symptoms</th><th>Notes</th><th>ABT</th></tr></thead>
<tbody>
${rows.map(c=>`<tr><td class="nowrap">${escapeHtml(c.room||"")}</td><td>${escapeHtml(c.name||"")}</td><td class="nowrap">${escapeHtml(c.onsetDate||"")}</td><td>${escapeHtml((c.symptoms||[]).join(", "))}</td><td>${escapeHtml(c.notes||"")}</td><td>${escapeHtml(c.antibiotic||"")}</td></tr>`).join("")}
</tbody>
</table>
</div>
`);
}

function importAbtSuggestionsToIp(){
const s0 = Store.load();
ensureIpData(s0);

const existing = new Set((s0.modules.ip.lineListCases||[]).map(c=>`${(c.mrn||"").toUpperCase()}|${c.kind}`));
const suggestions = (s0.modules.abt.courses||[])
.filter(c=> (c.lineListing==="Respiratory" || c.lineListing==="GI") && (c.mrn||""))
.map(c=>({
course:c,
kind: c.lineListing==="GI" ? "gi" : "resp",
key: `${(c.mrn||"").toUpperCase()}|${c.lineListing==="GI" ? "gi" : "resp"}`
}))
.filter(x=> !existing.has(x.key));

if(!suggestions.length){ alert("No new ABT suggestions found (based on ABT Line Listing flags)."); return; }

const preview = suggestions.slice(0,20).map(x=>`${x.course.residentName||""} (${x.course.mrn}) → ${ipCaseKindLabel(x.kind)}`).join("\n");
if(!confirm(`Import ${suggestions.length} suggested cases into IP line lists?\n\n${preview}${suggestions.length>20?`\n… (+${suggestions.length-20} more)`:""}`)) return;

Store.patch(s=>{
ensureIpData(s);
for(const x of suggestions){
const c = x.course;
s.modules.ip.lineListCases.push({
id: uid("ipcase"),
kind: x.kind,
status: "active",
onsetDate: c.startDate || "",
name: c.residentName || "",
mrn: (c.mrn||"").toUpperCase(),
room: c.room || "",
unit: c.unit || "",
antibiotic: c.antibiotic || "",
lab: "",
symptoms: [],
notes: c.indication ? `ABT: ${c.indication}` : "",
createdAt: nowISO(),
updatedAt: nowISO(),
source: "ABT_SUGGEST"
});
}
});

setTab("ip");
setIpView("resp");
}

ELHub.init();


// Ensure print() is available in all browsers/contexts
try{ if(typeof print!=='function' && typeof window.print==='function'){ window.print = window.print; } }catch(e){}
</script>

<script>

</script>

<script>

</script>

<script>

</script>

<script>

</script>

<script>

</script>

<script>

</script>


<script>
// === PHASE3 HOTFIX: SAFE TOAST FALLBACK (prevents ReferenceError) ===
(function(){
  if (typeof window.toast !== 'function') {
    window.toast = function(msg){
      try{ console.warn('[toast]', msg); }catch(e){}
    };
  }
})();


function wireQapiUnitFilter(){
  // Facility-wide only: no unit selector.
  window.__qapiUnitSelected = "All";
}



// ===================== Phase 5 Step 2: Follow-up & Effectiveness =====================
function ensureActionExtras(a){
  a.followUps = Array.isArray(a.followUps) ? a.followUps : [
    { label:"7-day", due:"", done:"", result:"" },
    { label:"30-day", due:"", done:"", result:"" },
    { label:"90-day", due:"", done:"", result:"" }
  ];
  a.effectiveness = a.effectiveness || { status:"", note:"" };
}
function renderFollowUps(a){
  ensureActionExtras(a);
  const wrap = document.getElementById("fuWrap");
  if(!wrap) return;
  const rows = a.followUps.map((fu, idx)=>`
    <div class="grid cols3" style="gap:10px; align-items:end; margin:8px 0">
      <div>
        <label>${escapeHtml(fu.label)} Due</label>
        <input type="date" id="fu_due_${idx}" value="${escapeHtml(fu.due||"")}"/>
      </div>
      <div>
        <label>${escapeHtml(fu.label)} Completed</label>
        <input type="date" id="fu_done_${idx}" value="${escapeHtml(fu.done||"")}"/>
      </div>
      <div>
        <label>${escapeHtml(fu.label)} Result</label>
        <input id="fu_res_${idx}" value="${escapeHtml(fu.result||"")}" placeholder="e.g., compliant / needs re-education"/>
      </div>
    </div>
  `).join("");
  wrap.innerHTML = rows;
  const es = document.getElementById("eff_status");
  const en = document.getElementById("eff_note");
  if(es) es.value = a.effectiveness.status || "";
  if(en) en.value = a.effectiveness.note || "";
}
function saveFollowUpsIntoAction(a){
  ensureActionExtras(a);
  a.followUps = a.followUps.map((fu, idx)=>({
    ...fu,
    due: document.getElementById(`fu_due_${idx}`)?.value || "",
    done: document.getElementById(`fu_done_${idx}`)?.value || "",
    result: (document.getElementById(`fu_res_${idx}`)?.value || "").trim()
  }));
  a.effectiveness = {
    status: document.getElementById("eff_status")?.value || "",
    note: (document.getElementById("eff_note")?.value || "").trim()
  };
}
function nextDueFollowUp(a){
  ensureActionExtras(a);
  const open = a.followUps.filter(x=>x.due && !x.done).sort((x,y)=>String(x.due).localeCompare(String(y.due)));
  return open[0]?.due || "";
}
window.actionsDueSoon = function(days=7){
  const s = Store.load();
  const list = s.qapiActions || [];
  const now = new Date(); const end = new Date(now.getTime() + Number(days)*86400000);
  const due = [];
  list.forEach(a=>{
    ensureActionExtras(a);
    a.followUps.forEach(fu=>{
      if(fu.due && !fu.done){
        const d = new Date(fu.due + "T00:00:00");
        if(d>=now && d<=end) due.push({ actionId:a.id, title:a.title, owner:a.owner||"", label:fu.label, due:fu.due });
      }
    });
  });
  return due.sort((x,y)=>String(x.due).localeCompare(String(y.due)));
};
window.printActionsFollowUpReport = function(){
  const s = Store.load();
  const facility = s.config?.facilityName || "Facility";
  const due = window.actionsDueSoon(30);
  const rows = due.map(d=>`
    <tr>
      <td>${escapeHtml(d.due)}</td>
      <td>${escapeHtml(d.label)}</td>
      <td>${escapeHtml(d.title||"")}</td>
      <td>${escapeHtml(d.owner||"")}</td>
    </tr>
  `).join("");
  auditTrail("actions_followup_report_printed", { windowDays:30, count: due.length });
  openPrintWindow(packetHtmlShell(`${facility} — Follow-up Due Report`, `
    <h1>${escapeHtml(facility)} — Follow-up Due Report</h1>
    <div class="muted">Window: next 30 days • Generated: ${escapeHtml(dayISO(new Date()))}</div>
    <table>
      <thead><tr><th>Due Date</th><th>Follow-up</th><th>Action</th><th>Owner</th></tr></thead>
      <tbody>${rows || `<tr><td colspan="4" class="muted">No follow-ups due in the next 30 days.</td></tr>`}</tbody>
    </table>
  `));
};
// =================== End Phase 5 Step 2 =============================================



// ===================== Audit Trail (Phase 4 Step 4) =====================
function auditTrail(action, meta){
  try{
    Store.patch(st=>{
      st.auditLog = Array.isArray(st.auditLog) ? st.auditLog : [];
      st.auditLog.unshift({
        ts: new Date().toISOString(),
        action: String(action||""),
        meta: meta||{}
      });
      st.auditLog = st.auditLog.slice(0, 2000);
    });
  }catch(e){}
}
// =================== End Audit Trail ====================================


// ===================== Packet Builder + QAPI Snapshot (Phase 4 Step 4) =====================
function packetApplyPreset(){
  const p = document.getElementById("pktPreset")?.value || "";
  const ids = document.getElementById("pktIds");
  if(!p) return;
  if(p==="survey_day"){
    if(ids) ids.value = "yes";
    packetExport("full"); // core = full for now (includes outbreak+precautions+signage)
  }else if(p==="outbreak_only"){
    packetExport("outbreak");
  }else if(p==="precautions_only"){
    packetExport("precautions");
  }else if(p==="full"){
    packetExport("full");
  }
}

// --- Packet Export (missing-function fix) ---
function packetGetSettings(){
  return {
    from: document.getElementById("pktFrom")?.value || "",
    to: document.getElementById("pktTo")?.value || "",
    unit: document.getElementById("pktUnit")?.value || "ALL",
    ids: document.getElementById("pktIds")?.value || "yes"
  };
}
function packetExport(kind){
  try{
    const cfg = packetGetSettings();
    // Prefer existing packet generators if present
    const unit = (cfg.unit||"ALL")==="ALL" ? "" : cfg.unit;
    const from = cfg.from || "";
    const to = cfg.to || "";
    // Toggle “include IDs” preference (best-effort: some print functions read cfg or DOM directly)
    try{ const idsEl=document.getElementById("pktIds"); if(idsEl) idsEl.value = cfg.ids; }catch(e){}
    // Dispatch
    if(kind==="outbreak"){
      if(typeof printOutbreakPacket === "function") return printOutbreakPacket("outbreak", unit, from, to);
      if(typeof window.printOutbreakLineListing === "function") return window.printOutbreakLineListing();
    }
    if(kind==="precautions"){
      if(typeof window.printUnitPrecautionListingFromSetup === "function") return window.printUnitPrecautionListingFromSetup();
      if(typeof printOutbreakPacket === "function") return printOutbreakPacket("precautions", unit, from, to);
    }
    if(kind==="signage"){
      if(typeof window.printUnitPrecautionSignageFromSetup === "function") return window.printUnitPrecautionSignageFromSetup();
      if(typeof printOutbreakPacket === "function") return printOutbreakPacket("signage", unit, from, to);
    }
    // full / fallback
    if(typeof printOutbreakPacket === "function") return printOutbreakPacket("full", unit, from, to);
    toastSafe("Packet export isn’t fully available in this build.");
  }catch(e){
    console.error(e);
    toastSafe("Packet export failed. See console.");
  }
}
// --- end Packet Export ---



function packetSaveRun(){
  const cfg = packetGetSettings();
  const run = {
    ts: new Date().toISOString(),
    from: cfg.from, to: cfg.to,
    unit: cfg.unit,
    ids: cfg.ids
  };
  Store.patch(st=>{
    st.packetRuns = Array.isArray(st.packetRuns) ? st.packetRuns : [];
    st.packetRuns.unshift(run);
    st.packetRuns = st.packetRuns.slice(0, 100);
  });
  auditTrail("packet_run_saved", run);
  toastSafe("Saved run.");
}
function packetShowSavedRuns(){
  const s = Store.load();
  const runs = s.packetRuns || [];
  const rows = runs.map((r, i)=>`
    <tr>
      <td>${escapeHtml(dayISO(new Date(r.ts)))}</td>
      <td>${escapeHtml(r.unit||"ALL")}</td>
      <td>${escapeHtml(r.from||"")}</td>
      <td>${escapeHtml(r.to||"")}</td>
      <td>${escapeHtml(r.ids||"yes")}</td>
      <td style="white-space:nowrap">
        <button class="btn" onclick="packetLoadRun(${i})">Load</button>
        <button class="btn" onclick="packetDeleteRun(${i})">Delete</button>
      </td>
    </tr>
  `).join("");
  openModal("Saved Packet Runs", `
    <div class="muted">These are local (stored in your browser only).</div>
    <div class="sep"></div>
    <table class="tbl">
      <thead><tr><th>Date</th><th>Unit</th><th>From</th><th>To</th><th>IDs</th><th></th></tr></thead>
      <tbody>${rows || `<tr><td colspan="6" class="muted">No saved runs yet.</td></tr>`}</tbody>
    </table>
    <div class="sep"></div>
    <div class="row" style="justify-content:flex-end; gap:8px">
      <button class="btn" onclick="closeModal()">Close</button>
    </div>
  `);
}
function packetLoadRun(i){
  const s = Store.load();
  const r = (s.packetRuns||[])[i];
  if(!r){ toastSafe("Run not found."); return; }
  const from = document.getElementById("pktFrom");
  const to = document.getElementById("pktTo");
  const unit = document.getElementById("pktUnit");
  const ids = document.getElementById("pktIds");
  if(from) from.value = r.from||"";
  if(to) to.value = r.to||"";
  if(unit) unit.value = r.unit||"ALL";
  if(ids) ids.value = r.ids||"yes";
  auditTrail("packet_run_loaded", r);
  toastSafe("Run loaded.");
}
function packetDeleteRun(i){
  Store.patch(st=>{
    st.packetRuns = Array.isArray(st.packetRuns) ? st.packetRuns : [];
    st.packetRuns.splice(i, 1);
  });
  auditTrail("packet_run_deleted", { index:i });
  packetShowSavedRuns();
}
function packetShowAuditLog(){
  const s = Store.load();
  const log = s.auditLog || [];
  const rows = log.slice(0, 200).map(x=>`
    <tr>
      <td class="small">${escapeHtml(x.ts||"")}</td>
      <td>${escapeHtml(x.action||"")}</td>
      <td class="small">${escapeHtml(JSON.stringify(x.meta||{}).slice(0,220))}</td>
    </tr>
  `).join("");
  openModal("Audit Log (latest 200)", `
    <div class="muted">Local audit trail (export actions, packet runs, etc.).</div>
    <div class="sep"></div>
    <table class="tbl">
      <thead><tr><th>Timestamp</th><th>Action</th><th>Details</th></tr></thead>
      <tbody>${rows || `<tr><td colspan="3" class="muted">No audit entries yet.</td></tr>`}</tbody>
    </table>
    <div class="sep"></div>
    <div class="row" style="justify-content:flex-end; gap:8px">
      <button class="btn" onclick="closeModal()">Close</button>
    </div>
  `);
}

// QAPI Snapshot: quick, printable summary + CSV
function qapiSnapshot(){
  const cfg = packetGetSettings();
  const {s, unit} = cfg;

  // patient days (facility-wide) - use stored facility patient days calc if available, else 0
  const pd = Number(s.metrics?.patientDays || s.patientDays || 0) || 0;

  // outbreak counts
  ensureOutbreakData(s);
  const cases = packetFilterByUnit(s.modules?.ip?.lineListCases || [], unit);
  const contacts = unit==="ALL" ? (s.modules?.ip?.contacts||[]) : (s.modules?.ip?.contacts||[]).filter(x=>String(x.unit||"")===String(unit));

  // precautions
  const prec = packetFilterByUnit(s.modules?.ip?.precautions || [], unit);

  const snapshot = {
    generated: new Date().toISOString(),
    unit,
    patientDays: pd,
    outbreakCases: cases.length,
    contactTracingEntries: contacts.length,
    activePrecautions: prec.length,
    rates: {
      casesPer1000PatientDays: pd>0 ? +(cases.length / pd * 1000).toFixed(2) : null
    }
  };

  auditTrail("qapi_snapshot_generated", snapshot);

  openModal("QAPI Snapshot", `
    <div class="grid cols2" style="gap:12px">
      <div class="card" style="box-shadow:none; border:1px solid rgba(0,0,0,.08)">
        <h3 style="margin:0 0 8px">Counts</h3>
        <div><b>Patient Days (facility)</b>: ${escapeHtml(String(pd))}</div>
        <div><b>Outbreak Cases</b>: ${escapeHtml(String(cases.length))}</div>
        <div><b>Contact Tracing Entries</b>: ${escapeHtml(String(contacts.length))}</div>
        <div><b>Active Precautions</b>: ${escapeHtml(String(prec.length))}</div>
      </div>
      <div class="card" style="box-shadow:none; border:1px solid rgba(0,0,0,.08)">
        <h3 style="margin:0 0 8px">Rates</h3>
        <div><b>Cases / 1000 Patient Days</b>: ${snapshot.rates.casesPer1000PatientDays===null ? "<span class='muted'>N/A</span>" : escapeHtml(String(snapshot.rates.casesPer1000PatientDays))}</div>
        <div class="muted mini">Uses current filter counts and facility patient days value.</div>
      </div>
    </div>
    <div class="sep"></div>
    <div class="row" style="justify-content:flex-end; gap:8px; flex-wrap:wrap">
      <button class="btn" onclick="qapiSnapshotPrint()">Print</button>
      <button class="btn" onclick="qapiSnapshotCSV()">Export CSV</button>
      <button class="btn primary" onclick="closeModal()">Close</button>
    </div>
  `);

  // stash latest for print/csv
  window.__lastQapiSnapshot = snapshot;
}
function qapiSnapshotPrint(){
  const snap = window.__lastQapiSnapshot;
  if(!snap){ toastSafe("No snapshot."); return; }
  const facility = Store.load().config?.facilityName || "Facility";
  auditTrail("qapi_snapshot_printed", { unit: snap.unit });
  openPrintWindow(packetHtmlShell(`${facility} — QAPI Snapshot`, `
    <h1>${escapeHtml(facility)} — QAPI Snapshot</h1>
    <div class="muted">Generated: ${escapeHtml(snap.generated)} • Unit: ${escapeHtml(snap.unit)}</div>
    <h2>Counts</h2>
    <table><tbody>
      <tr><th>Patient Days (facility)</th><td>${escapeHtml(String(snap.patientDays))}</td></tr>
      <tr><th>Outbreak Cases</th><td>${escapeHtml(String(snap.outbreakCases))}</td></tr>
      <tr><th>Contact Tracing Entries</th><td>${escapeHtml(String(snap.contactTracingEntries))}</td></tr>
      <tr><th>Active Precautions</th><td>${escapeHtml(String(snap.activePrecautions))}</td></tr>
    </tbody></table>
    <h2>Rates</h2>
    <table><tbody>
      <tr><th>Cases / 1000 Patient Days</th><td>${snap.rates.casesPer1000PatientDays===null ? "N/A" : escapeHtml(String(snap.rates.casesPer1000PatientDays))}</td></tr>
    </tbody></table>
  `));
}
function qapiSnapshotCSV(){
  const snap = window.__lastQapiSnapshot;
  if(!snap){ toastSafe("No snapshot."); return; }
  const rows = [
    ["generated","unit","patientDays","outbreakCases","contactTracingEntries","activePrecautions","casesPer1000PatientDays"],
    [snap.generated, snap.unit, snap.patientDays, snap.outbreakCases, snap.contactTracingEntries, snap.activePrecautions, snap.rates.casesPer1000PatientDays ?? ""]
  ];
  const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `QAPI_Snapshot_${dayISO(new Date())}.csv`;
  document.body.appendChild(a); a.click(); a.remove();
  auditTrail("qapi_snapshot_csv_exported", { unit: snap.unit });
  toastSafe("CSV exported.");
}
// =================== End Packet Builder + QAPI Snapshot =============================

// ===================== Step 5: Packet Backup + Checklist (Encrypted) =====================
async function deriveKeyFromPassword(password, saltB64){
  const enc = new TextEncoder();
  const salt = saltB64 ? Uint8Array.from(atob(saltB64), c=>c.charCodeAt(0)) : crypto.getRandomValues(new Uint8Array(16));
  const keyMaterial = await crypto.subtle.importKey("raw", enc.encode(password), {name:"PBKDF2"}, false, ["deriveKey"]);
  const key = await crypto.subtle.deriveKey(
    {name:"PBKDF2", salt, iterations: 120000, hash:"SHA-256"},
    keyMaterial,
    {name:"AES-GCM", length: 256},
    false,
    ["encrypt","decrypt"]
  );
  return { key, saltB64: btoa(String.fromCharCode(...salt)) };
}
function u8ToB64(u8){ return btoa(String.fromCharCode(...u8)); }
function b64ToU8(b64){ return Uint8Array.from(atob(b64), c=>c.charCodeAt(0)); }

async function encryptJson(password, obj){
  const {key, saltB64} = await deriveKeyFromPassword(password);
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const pt = new TextEncoder().encode(JSON.stringify(obj));
  const ct = new Uint8Array(await crypto.subtle.encrypt({name:"AES-GCM", iv}, key, pt));
  return { v:1, alg:"AES-GCM", kdf:"PBKDF2", saltB64, ivB64:u8ToB64(iv), ctB64:u8ToB64(ct) };
}
async function decryptJson(password, pack){
  const {key} = await deriveKeyFromPassword(password, pack.saltB64);
  const iv = b64ToU8(pack.ivB64);
  const ct = b64ToU8(pack.ctB64);
  const pt = await crypto.subtle.decrypt({name:"AES-GCM", iv}, key, ct);
  return JSON.parse(new TextDecoder().decode(pt));
}

async function packetBackupExport(){
  try{
    const pwd = prompt("Create a password for this backup (required):");
    if(!pwd) return;
    const s = Store.load();
    const payload = {
      exportedAt: new Date().toISOString(),
      facility: s.config?.facilityName || "",
      packetRuns: s.packetRuns || [],
      auditLog: s.auditLog || [],
      // keep small: do not export resident census by default
      note: "This backup contains packet runs + audit log only."
    };
    const pack = await encryptJson(pwd, payload);
    const blob = new Blob([JSON.stringify(pack, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `ICN_PacketBackup_${dayISO(new Date())}.json`;
    document.body.appendChild(a); a.click(); a.remove();
    auditTrail("packet_backup_exported", { facility: payload.facility, size: (payload.auditLog?.length||0) });
    toastSafe("Backup exported.");
  }catch(e){
    toastSafe("Backup export failed.");
  }
}
async function packetBackupImport(){
  try{
    openModal("Restore Packet Backup", `
      <div class="muted">This restores <b>Packet Runs</b> and <b>Audit Log</b> only (local browser storage).</div>
      <div class="sep"></div>
      <input id="pktImpFile" type="file" accept="application/json"/>
      <div style="height:10px"></div>
      <button class="btn primary" onclick="packetBackupImportGo()">Restore</button>
      <button class="btn" onclick="closeModal()">Cancel</button>
    `);
  }catch(e){}
}

function packetBackupImportGo(){
  try{
    const inp = document.getElementById("pktImpFile");
    const f = inp && inp.files && inp.files[0];
    if(!f){ toastSafe("Select a backup JSON file first."); return; }
    const r = new FileReader();
    r.onload = ()=>{
      try{
        const obj = JSON.parse(String(r.result||"{}"));
        Store.patch(st=>{
          st.packetRuns = Array.isArray(obj.packetRuns) ? obj.packetRuns : (st.packetRuns||[]);
          st.auditLog = Array.isArray(obj.auditLog) ? obj.auditLog : (st.auditLog||[]);
        });
        closeModal();
        toastSafe("Backup restored.");
      }catch(e){
        console.error(e);
        toastSafe("Invalid backup file.");
      }
    };
    r.readAsText(f);
  }catch(e){
    console.error(e);
    toastSafe("Restore failed.");
  }
}



window.packetBackupImportGo = async function(){
  const f = document.getElementById("pktImpFile")?.files?.[0];
  if(!f){ toastSafe("Select a backup file."); return; }
  const pwd = prompt("Enter backup password:");
  if(!pwd) return;
  try{
    const text = await f.text();
    const pack = JSON.parse(text);
    const payload = await decryptJson(pwd, pack);
    Store.patch(st=>{
      st.packetRuns = Array.isArray(payload.packetRuns) ? payload.packetRuns : [];
      st.auditLog = Array.isArray(payload.auditLog) ? payload.auditLog : [];
    });
    closeModal();
    auditTrail("packet_backup_restored", { facility: payload.facility || "" });
    toastSafe("Backup restored.");
  }catch(e){
    toastSafe("Restore failed (wrong password or corrupted file).");
  }
};

function packetChecklist(){
  const s = Store.load();
  const facility = s.config?.facilityName || "Facility";
  const unit = document.getElementById("pktUnit")?.value || "ALL";
  openPrintWindow(packetHtmlShell(`${facility} — Survey Packet Checklist`, `
    <h1>${escapeHtml(facility)} — Survey Packet Checklist</h1>
    <div class="muted">Generated: ${escapeHtml(dayISO(new Date()))} • Unit: ${escapeHtml(unit)}</div>

    <h2>Core Packet Pages</h2>
    <table><tbody>
      <tr><th>Outbreak Line Listing</th><td>Printed / Saved to PDF</td></tr>
      <tr><th>Contact Tracing Table</th><td>Printed / Saved to PDF</td></tr>
      <tr><th>Daily Active Precaution List</th><td>Printed / Saved to PDF</td></tr>
      <tr><th>Isolation Signage Set</th><td>Printed / Saved to PDF</td></tr>
    </tbody></table>

    <h2>Quality / Compliance Checks (High-yield)</h2>
    <table><tbody>
      <tr><th>Source of truth consistent</th><td>Line Listing + Contact Tracing reflect same cases</td></tr>
      <tr><th>Unit vs Facility rollups</th><td>Confirm unit filter matches survey request</td></tr>
      <tr><th>Documentation completeness</th><td>Onset dates, status, notes entered for all cases</td></tr>
      <tr><th>Precaution start/end</th><td>Start dates present; discontinue dates documented when applicable</td></tr>
      <tr><th>Audit trail present</th><td>Exports logged (for QA traceability)</td></tr>
    </tbody></table>

    <h2>QAPI Snapshot</h2>
    <div class="muted">Run QAPI Snapshot and save CSV/PDF for committee minutes as needed.</div>
  `));
  auditTrail("packet_checklist_printed", { unit });
}
// =================== End Step 5: Packet Backup + Checklist ==========================

// ===================== Step 6: Role-based Views (Admin/Staff/Surveyor) =====================
function getUiRole(){
  try{ return Store.load().ui?.role || "admin"; }catch(e){ return "admin"; }
}
function setUiRole(role){
  role = (role==="staff"||role==="surveyor") ? role : "admin";
  Store.patch(st=>{ st.ui = st.ui || {}; st.ui.role = role; });
  auditTrail("ui_role_changed", { role });
  toastSafe("Role set to: " + role);
  enforceRole();
}
function applyRoleDefaults(){
  const role = getUiRole();
  // Surveyor: de-identified packet exports by default, hide admin tools
  if(role==="surveyor"){
    const ids = document.getElementById("pktIds");
    if(ids) ids.value = "no";
  }
  // Staff: keep identifiers on for internal workflow
  if(role==="staff"){
    const ids = document.getElementById("pktIds");
    if(ids) ids.value = "yes";
  }
  auditTrail("ui_role_defaults_applied", { role });
  toastSafe("Role defaults applied.");
  enforceRole();
}
function enforceRole(){
  const role = getUiRole();
  // Update role selector if present
  const sel = document.getElementById("uiRoleSelect");
  if(sel) sel.value = role;

  // Hide tabs based on role
  const hide = (tab, yes)=>{
    const b = document.querySelector(`.tabbtn[data-tab="${tab}"]`);
    if(b) b.style.display = yes ? "none" : "";
  };
  // Surveyor: hide Admin and some edit-heavy areas (keep Dashboard, IP, Reports, Packet, About)
  if(role==="surveyor"){
    hide("admin", true);
    // If currently on admin, redirect
    if((Store.load().ui?.activeTab||"dashboard")==="admin"){ try{ setTab("dashboard"); }catch(e){} }
    // Disable editing controls
    document.querySelectorAll("input, textarea, select, button").forEach(el=>{
      if(el.closest("#tab-packet")) return; // allow packet settings
      if(el.closest("#tab-about")) return;
      if(el.closest("#tab-reports")) return;
      if(el.closest("#tab-dashboard")) return;
      // In IP views, allow navigation buttons but block destructive/submit actions
      const isNavBtn = el.classList.contains("tabbtn") || el.dataset?.subtab || el.id?.includes("Nav");
      if(el.tagName==="BUTTON" && isNavBtn) return;
      // Allow Close buttons in modal
      if(el.tagName==="BUTTON" && /close/i.test(el.textContent||"")) return;
      el.disabled = true;
    });
  }else{
    hide("admin", false);
    // Re-enable everything (except those already disabled by logic)
    document.querySelectorAll("[disabled]").forEach(el=>{
      // Don't force-enable fields that are disabled for reasons like computed or file inputs; just undo our role lock.
      // We'll enable broadly but keep readonly attributes if any.
      try{ el.disabled = false; }catch(e){}
    });
  }
}
// Hook role enforcement on boot and after tab switches
(function(){
  const _boot = window.boot || null;
  window.boot = function(){
    const r = _boot ? _boot() : undefined;
    try{ enforceRole(); }catch(e){}
    return r;
  };
  const _setTab = window.setTab;
  window.setTab = function(name){
    _setTab(name);
    try{ enforceRole(); }catch(e){}
  };
})();
// =================== End Step 6: Role-based Views =======================================

// ===================== Phase 5 Step 1: QAPI Action Engine =====================
function ensureQapiActions(s){
  s.qapiActions = Array.isArray(s.qapiActions) ? s.qapiActions : [];
}
function qapiActionId(){
  return 'qa_' + Math.random().toString(36).slice(2,10) + '_' + Date.now().toString(36);
}
function qapiPriorityScore(p){
  const m={high:3, medium:2, low:1};
  return m[String(p||'medium').toLowerCase()]||2;
}
function qapiDueInDays(days){
  const d=new Date(); d.setDate(d.getDate()+days);
  return dayISO(d);
}
function qapiUpsertAction(action){
  Store.patch(st=>{
    ensureQapiActions(st);
    const i=st.qapiActions.findIndex(x=>x.id===action.id);
    if(i>=0) st.qapiActions[i]=action;
    else st.qapiActions.unshift(action);
  });
}
function qapiAddAction(fields){
  const a={
    id:qapiActionId(),
    createdAt:new Date().toISOString(),
    updatedAt:new Date().toISOString(),
    status:'open', // open | in_progress | complete
    source: fields.source||'manual',
    category: fields.category||'infection_control',
    title: fields.title||'QAPI Action',
    problem: fields.problem||'',
    rootCause: fields.rootCause||'',
    actionPlan: fields.actionPlan||'',
    ownerRole: fields.ownerRole||'ICN',
    dueDate: fields.dueDate||qapiDueInDays(14),
    priority: fields.priority||'medium',
    educationTopic: fields.educationTopic||'',
    followUpDate: fields.followUpDate||'',
    related: fields.related||{},
    notes: fields.notes||''
  };
  qapiUpsertAction(a);
  auditTrail('qapi_action_created', {id:a.id, source:a.source, category:a.category, priority:a.priority});
  return a.id;
}
function qapiUpdateAction(id, patch){
  Store.patch(st=>{
    ensureQapiActions(st);
    const a=st.qapiActions.find(x=>x.id===id);
    if(!a) return;
    Object.assign(a, patch||{});
    a.updatedAt=new Date().toISOString();
  });
  auditTrail('qapi_action_updated', {id});
}
function qapiDeleteAction(id){
  if(!confirm('Delete this action?')) return;
  Store.patch(st=>{ ensureQapiActions(st); st.qapiActions = st.qapiActions.filter(x=>x.id!==id); });
  auditTrail('qapi_action_deleted', {id});
  qapiRenderActions();
}
function qapiMarkInProgress(id){ qapiUpdateAction(id,{status:'in_progress'}); qapiRenderActions(); }
function qapiMarkComplete(id){ qapiUpdateAction(id,{status:'complete', completedAt:new Date().toISOString()}); qapiRenderActions(); }

function qapiSuggestEducation(category){
  const map={
    infection_control:[
      'Standard + Transmission-Based Precautions',
      'Hand Hygiene / PPE Don & Doff',
      'Isolation Signage + Room Setup',
      'Outbreak response workflow (case-first)',
      'Environmental cleaning during outbreaks'
    ],
    documentation:[
      'Change of Condition documentation (SBAR)',
      'Provider notification + follow-up documentation',
      'Specimen collection + documentation standards',
      'Care plan update triggers'
    ],
    antibiotic_stewardship:[
      'Indications for antibiotics + cultures',
      'Antibiotic time-out / reassessment',
      'UTI criteria and avoiding over-treatment'
    ],
    vaccination:[
      'Vaccine consent + documentation workflow',
      'Declination tracking and counseling'
    ],
    environment:[
      'High-touch cleaning auditing',
      'Shared equipment disinfection'
    ]
  };
  return map[category] || ['General compliance refresher'];
}

function qapiNewActionModal(prefill){
  prefill=prefill||{};
  const cat=prefill.category||'infection_control';
  const topics=qapiSuggestEducation(cat);
  openModal('New QAPI Action', `
    <div class="grid cols2">
      <div>
        <label>Title</label>
        <input id="qa_title" value="${escapeHtml(prefill.title||'')}">
      </div>
      <div>
        <label>Category</label>
        <select id="qa_cat" onchange="qapiNewActionRefreshTopics()">
          ${['infection_control','documentation','antibiotic_stewardship','vaccination','environment','other'].map(v=>`<option value="${v}" ${v===cat?'selected':''}>${v.replaceAll('_',' ')}</option>`).join('')}
        </select>
      </div>
      <div>
        <label>Priority</label>
        <select id="qa_pri">
          ${['high','medium','low'].map(v=>`<option value="${v}" ${v===(prefill.priority||'medium')?'selected':''}>${v}</option>`).join('')}
        </select>
      </div>
      <div>
        <label>Due Date</label>
        <input id="qa_due" type="date" value="">
      </div>
      <div>
        <label>Owner Role</label>
        <select id="qa_owner">
          ${['ICN','DON','ADON','Unit Manager','Staff Educator','Medical Director','Other'].map(v=>`<option value="${v}" ${v===(prefill.ownerRole||'ICN')?'selected':''}>${v}</option>`).join('')}
        </select>
      </div>
      <div>
        <label>Education Topic (optional)</label>
        <select id="qa_topic">
          ${topics.map(t=>`<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('')}
        </select>
      </div>
    </div>
    <div style="margin-top:10px">
      <label>Problem Statement</label>
      <textarea id="qa_problem" rows="3">${escapeHtml(prefill.problem||'')}</textarea>
    </div>

    <div class="card" style="margin-top:12px; box-shadow:none; border:1px solid rgba(0,0,0,.08)">
      <h3 style="margin:0 0 8px">Follow-up Schedule</h3>
      <div class="muted mini">Set due dates for 7/30/90-day checks. Document results when completed.</div>
      <div id="fuWrap"></div>
      <div class="sep"></div>
      <div class="grid cols2" style="gap:10px">
        <div>
          <label>Effectiveness Status</label>
          <select id="eff_status">
            <option value="">(not assessed)</option>
            <option value="effective">Effective</option>
            <option value="partially_effective">Partially effective</option>
            <option value="not_effective">Not effective</option>
          </select>
        </div>
        <div>
          <label>Effectiveness Note</label>
          <input id="eff_note" placeholder="Short outcome note (e.g., no repeat cases in 30 days)"/>
        </div>
      </div>
    </div>
    <div style="margin-top:10px">
      <label>Corrective Action Plan</label>
      <textarea id="qa_plan" rows="3">${escapeHtml(prefill.actionPlan||'')}</textarea>
    </div>

    <div class="card" style="margin-top:12px; box-shadow:none; border:1px solid rgba(0,0,0,.08)">
      <h3 style="margin:0 0 8px">Follow-up Schedule</h3>
      <div class="muted mini">Set due dates for 7/30/90-day checks. Document results when completed.</div>
      <div id="fuWrap"></div>
      <div class="sep"></div>
      <div class="grid cols2" style="gap:10px">
        <div>
          <label>Effectiveness Status</label>
          <select id="eff_status">
            <option value="">(not assessed)</option>
            <option value="effective">Effective</option>
            <option value="partially_effective">Partially effective</option>
            <option value="not_effective">Not effective</option>
          </select>
        </div>
        <div>
          <label>Effectiveness Note</label>
          <input id="eff_note" placeholder="Short outcome note (e.g., no repeat cases in 30 days)"/>
        </div>
      </div>
    </div>
    <div class="sep"></div>
    <div class="row" style="justify-content:flex-end; gap:8px; flex-wrap:wrap">
      <button class="btn" onclick="closeModal()">Cancel</button>
      <button class="btn primary" onclick="qapiCreateFromModal()">Create Action</button>
    </div>
  `);
  
  setTimeout(()=>{
    const dueEl=document.getElementById('qaE_due'); if(dueEl){ const def = (typeof qapiDueInDays==='function') ? qapiDueInDays(14) : ''; dueEl.value = toDateInputValue(prefill?.dueDate||def||''); }
    const fuEl=document.getElementById('qaE_follow'); if(fuEl) fuEl.value = toDateInputValue(prefill?.followUpDate||'');
  },0);
// set topic default if prefill provided
  if(prefill.educationTopic){
    const sel=document.getElementById('qa_topic');
    if(sel) sel.value=prefill.educationTopic;
  }
}
function qapiNewActionRefreshTopics(){
  const cat=document.getElementById('qa_cat')?.value||'infection_control';
  const sel=document.getElementById('qa_topic');
  if(!sel) return;
  const topics=qapiSuggestEducation(cat);
  sel.innerHTML = topics.map(t=>`<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');
}
function qapiCreateFromModal(){
  const title=(document.getElementById('qa_title')?.value||'').trim();
  const category=document.getElementById('qa_cat')?.value||'infection_control';
  const priority=document.getElementById('qa_pri')?.value||'medium';
  const dueDate=document.getElementById('qa_due')?.value||qapiDueInDays(14);
  const ownerRole=document.getElementById('qa_owner')?.value||'ICN';
  const topic=document.getElementById('qa_topic')?.value||'';
  const problem=(document.getElementById('qa_problem')?.value||'').trim();
  const plan=(document.getElementById('qa_plan')?.value||'').trim();
  if(!title){ toastSafe('Title is required.'); return; }
  const id=qapiAddAction({title, category, priority, dueDate, ownerRole, educationTopic:topic, problem, actionPlan:plan});
  closeModal();
  toastSafe('Action created.');
  qapiRenderActions();
}

function qapiAutoFlags(s){
  // Legacy compatibility wrapper (old callers).
  try{
    if(typeof qapiComputeAutoFlags==="function") return qapiComputeAutoFlags();
  }catch(e){}
  return [];
}

function qapiComputeAutoFlags(){
  const s=Store.load();
  const suggestions=[];
  // outbreak case fields
  try{
    ensureOutbreakData(s);
    const cases=s.modules?.ip?.lineListCases||[];
    const missing=cases.filter(c=>!c.onsetDate || !c.status || !c.syndrome);
    if(missing.length>0){
      suggestions.push({
        source:'auto', category:'documentation', priority:'medium',
        title:`Outbreak case documentation gaps (${missing.length})`,
        problem:'One or more outbreak cases are missing onset date, status, or syndrome. This weakens surveillance and survey packet accuracy.',
        actionPlan:'Review outbreak case entries and complete missing fields. Reinforce documentation expectations with responsible staff.',
        dueDate:qapiDueInDays(7), ownerRole:'ICN',
        related:{type:'outbreak_cases_missing_fields', count:missing.length}
      });
    }
  }catch(e){}

  // prolonged precautions
  try{
    const prec=s.modules?.ip?.precautions||[];
    const now=new Date();
    const long=prec.filter(r=>{
      const sd=r.startDate? new Date(r.startDate+'T00:00:00') : null;
      if(!sd) return false;
      const days=(now.getTime()-sd.getTime())/86400000;
      return days>=14 && !r.endDate;
    });
    if(long.length>0){
      suggestions.push({
        source:'auto', category:'infection_control', priority:'medium',
        title:`Prolonged precautions without review (${long.length})`,
        problem:'Precautions > 14 days without discontinue date may indicate missing reassessment or documentation.',
        actionPlan:'Review each prolonged precaution for ongoing indication; document reassessment and discontinue when appropriate.',
        dueDate:qapiDueInDays(10), ownerRole:'ICN',
        related:{type:'precautions_prolonged', count:long.length}
      });
    }
  }catch(e){}

  // Contact tracing not generated for cases
  try{
    ensureOutbreakData(s);
    const cases=s.modules?.ip?.lineListCases||[];
    const contacts=s.modules?.ip?.contacts||[];
    const caseIds=new Set(contacts.map(c=>c.caseId));
    const noCT=cases.filter(c=>!caseIds.has(c.id));
    if(noCT.length>0){
      suggestions.push({
        source:'auto', category:'infection_control', priority:'high',
        title:`Cases missing contact tracing (${noCT.length})`,
        problem:'One or more cases do not have generated contact tracing entries.',
        actionPlan:'Generate contact tracing for each case and verify exposures; print updated survey packet pages.',
        dueDate:qapiDueInDays(2), ownerRole:'ICN',
        related:{type:'cases_missing_contact_tracing', count:noCT.length}
      });
    }
  }catch(e){}
// [removed legacy python stub]
}

function qapiRunAutoFlags(showModal){
  const sug=qapiComputeAutoFlags();
  if(sug.length===0){ toastSafe('No auto-flags found.'); qapiRenderActions(); return; }
  if(!showModal){
    // add only if not already present by related.type
    const existing=Store.load().qapiActions||[];
    const types=new Set(existing.map(a=>a.related?.type).filter(Boolean));
    let added=0;
    sug.forEach(s=>{ if(!types.has(s.related?.type)) { qapiAddAction(s); added+=1; } });
    toastSafe(`Auto-flagged: ${added} action(s) added.`);
    qapiRenderActions();
    return;
  }
  const rows=sug.map((s,i)=>`
    <div class="card" style="box-shadow:none; border:1px solid rgba(0,0,0,.08); margin:8px 0">
      <div class="row" style="justify-content:space-between; gap:10px; flex-wrap:wrap">
        <div>
          <div><b>${escapeHtml(s.title)}</b></div>
          <div class="muted mini">Category: ${escapeHtml(s.category)} • Priority: ${escapeHtml(s.priority)} • Due: ${escapeHtml(s.dueDate)}</div>
        </div>
        <div class="row" style="gap:8px; flex-wrap:wrap">
          <button class="btn" onclick="qapiNewActionModal(${escapeHtml(JSON.stringify(s)).replaceAll('&','&amp;').replaceAll('<','&lt;')})">Review/Edit</button>
          <button class="btn primary" onclick="qapiAddAutoFromModal(${i})">Add</button>
        </div>
      </div>
      <div class="muted" style="margin-top:6px">${escapeHtml(s.problem)}</div>
    </div>
  `).join('');
  window.__qapiAutoSug = sug;
  openModal('Auto-Flag Suggestions', `
    <div class="muted">Add suggested actions to your QAPI Action Center. Suggestions are deduplicated by type when possible.</div>
    <div class="sep"></div>
    ${rows}
    <div class="sep"></div>
    <div class="row" style="justify-content:flex-end; gap:8px; flex-wrap:wrap">
      <button class="btn" onclick="closeModal()">Close</button>
      <button class="btn primary" onclick="qapiAddAllAuto()">Add All</button>
    </div>
  `);
}
window.qapiAddAutoFromModal = function(i){
  const sug=window.__qapiAutoSug||[];
  const s=sug[i];
  if(!s) return;
  // dedupe
  const existing=Store.load().qapiActions||[];
  if(existing.some(a=>a.related?.type && s.related?.type && a.related.type===s.related.type)){
    toastSafe('Already exists.');
    return;
  }
  qapiAddAction(s);
  toastSafe('Added.');
  qapiRenderActions();
}
window.qapiAddAllAuto = function(){
  const sug=window.__qapiAutoSug||[];
  const existing=Store.load().qapiActions||[];
  const types=new Set(existing.map(a=>a.related?.type).filter(Boolean));
  let added=0;
  sug.forEach(s=>{ if(!types.has(s.related?.type)) { qapiAddAction(s); added+=1; } });
  closeModal();
  toastSafe(`Added ${added} action(s).`);
  qapiRenderActions();
}

function qapiRenderActions(){
  const s=Store.load(); ensureQapiActions(s);
  const nowISO=dayISO(new Date());
  const open=s.qapiActions.filter(a=>a.status!=='complete');
  open.sort((a,b)=>{
    const ps=qapiPriorityScore(b.priority)-qapiPriorityScore(a.priority);
    if(ps!=0) return ps;
    return String(a.dueDate||'').localeCompare(String(b.dueDate||''));
  });
  const closed=s.qapiActions.filter(a=>a.status==='complete').slice(0,30);

  const card = (a)=>{
    const overdue = a.dueDate && String(a.dueDate) < nowISO && a.status!=='complete';
    const topic = a.educationTopic ? `<div class="muted mini">Education: ${escapeHtml(a.educationTopic)}</div>` : '';
    return `
      <div class="card" style="box-shadow:none; border:1px solid rgba(0,0,0,.08); margin:8px 0">
        <div class="row" style="justify-content:space-between; gap:10px; flex-wrap:wrap">
          <div>
            <div><b>${escapeHtml(a.title||'')}</b> ${overdue?'<span class="pill" style="background:#ffe4e6">Overdue</span>':''}</div>
            <div class="muted mini">${escapeHtml(a.category||'')} • Priority: ${escapeHtml(a.priority||'')} • Due: ${escapeHtml(a.dueDate||'')} • Owner: ${escapeHtml(a.ownerRole||'')}</div>
            ${topic}
          </div>
          <div class="row" style="gap:8px; flex-wrap:wrap">
            <button class="btn" onclick="qapiOpenAction('${escapeHtml(a.id)}')">Open</button>
            ${a.status==='open'?`<button class="btn" onclick="qapiMarkInProgress('${escapeHtml(a.id)}')">In Progress</button>`:''}
            ${a.status!=='complete'?`<button class="btn primary" onclick="qapiMarkComplete('${escapeHtml(a.id)}')">Complete</button>`:''}
            <button class="btn danger" onclick="qapiDeleteAction('${escapeHtml(a.id)}')">Delete</button>
          </div>
        </div>
      </div>
    `;
  };

  const openEl=document.getElementById('qapiActionsOpen');
  const closedEl=document.getElementById('qapiActionsClosed');
  if(openEl) openEl.innerHTML = open.length? open.map(card).join('') : '<div class="muted">No open actions.</div>';
  if(closedEl) closedEl.innerHTML = closed.length? closed.map(card).join('') : '<div class="muted">No completed actions.</div>';

  // dashboard widget
  const openCount=open.length;
  const overdueCount=open.filter(a=>a.dueDate && String(a.dueDate)<nowISO).length;
  const c1=document.getElementById('dashQapiOpenCount');
  const c2=document.getElementById('dashQapiOverdueCount');
  if(c1) c1.textContent=String(openCount);
  if(c2) c2.textContent=String(overdueCount);
  const top=document.getElementById('dashQapiTop');
  if(top){
    top.innerHTML = open.slice(0,3).map(a=>`• <b>${escapeHtml(a.title||'')}</b> <span class="muted">(${escapeHtml(a.dueDate||'')})</span>`).join('<br>') || 'No actions yet.';
  }
}

function qapiOpenAction(id){
  const s=Store.load(); ensureQapiActions(s);
  const a=s.qapiActions.find(x=>x.id===id);
  if(!a){ toastSafe('Action not found.'); return; }
  const topics=qapiSuggestEducation(a.category);
  openModal('QAPI Action', `
    <div class="grid cols2">
      <div>
        <label>Title</label>
        <input id="qaE_title" value="${escapeHtml(a.title||'')}">
      </div>
      <div>
        <label>Status</label>
        <select id="qaE_status">
          ${['open','in_progress','complete'].map(v=>`<option value="${v}" ${v===a.status?'selected':''}>${v.replaceAll('_',' ')}</option>`).join('')}
        </select>
      </div>
      <div>
        <label>Category</label>
        <select id="qaE_cat" onchange="qapiEditRefreshTopics()">
          ${['infection_control','documentation','antibiotic_stewardship','vaccination','environment','other'].map(v=>`<option value="${v}" ${v===a.category?'selected':''}>${v.replaceAll('_',' ')}</option>`).join('')}
        </select>
      </div>
      <div>
        <label>Priority</label>
        <select id="qaE_pri">${['high','medium','low'].map(v=>`<option value="${v}" ${v===a.priority?'selected':''}>${v}</option>`).join('')}</select>
      </div>
      <div>
        <label>Due Date</label>
        <input id="qaE_due" type="date" value="">
      </div>
      <div>
        <label>Owner Role</label>
        <input id="qaE_owner" value="${escapeHtml(a.ownerRole||'')}">
      </div>
      <div>
        <label>Education Topic</label>
        <select id="qaE_topic">${topics.map(t=>`<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('')}</select>
      </div>
      <div>
        <label>Follow-up Date</label>
        <input id="qaE_follow" type="date" value="">
      </div>
    </div>
      <div class="card" style="margin-top:12px">
        <div class="row" style="justify-content:space-between; align-items:center">
          <div>
            <div style="font-weight:800">Effectiveness & Verification</div>
            <div class="muted" style="margin-top:2px">Closed-loop QAPI: action → education/intervention → follow-up verification.</div>
          </div>
        </div>
        <div class="grid" style="grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px; margin-top:10px">
          <div class="field">
            <label class="mini muted">Outcome</label>
            <select id="qaE_effectOutcome">
              <option value="">(blank)</option>
              <option value="Improved">Improved</option>
              <option value="No Change">No Change</option>
              <option value="Worse">Worse</option>
              <option value="N/A">N/A</option>
            </select>
          </div>
          <div class="field">
            <label class="mini muted">Verification Method</label>
            <select id="qaE_verificationMethod">
              <option value="">(blank)</option>
              <option value="Audit">Audit</option>
              <option value="Chart Review">Chart Review</option>
              <option value="Observation">Observation</option>
              <option value="Competency Check">Competency Check</option>
              <option value="Education Sign-off">Education Sign-off</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="field">
            <label class="mini muted">Verified By</label>
            <input id="qaE_verifiedBy" placeholder="Name / Role" />
          </div>
          <div class="field">
            <label class="mini muted">Verified Date</label>
            <input id="qaE_verifiedDate" type="date" />
          </div>
          <div class="field" style="grid-column:1 / -1">
            <label class="mini muted">Evidence / Notes</label>
            <textarea id="qaE_effectNotes" rows="3" placeholder="What changed? What evidence supports the outcome?"></textarea>
          </div>
        </div>
      </div>

    <div style="margin-top:10px">
      <label>Problem Statement</label>
      <textarea id="qaE_problem" rows="3">${escapeHtml(a.problem||'')}</textarea>
    </div>

    <div class="card" style="margin-top:12px; box-shadow:none; border:1px solid rgba(0,0,0,.08)">
      <h3 style="margin:0 0 8px">Follow-up Schedule</h3>
      <div class="muted mini">Set due dates for 7/30/90-day checks. Document results when completed.</div>
      <div id="fuWrap"></div>
      <div class="sep"></div>
      <div class="grid cols2" style="gap:10px">
        <div>
          <label>Effectiveness Status</label>
          <select id="eff_status">
            <option value="">(not assessed)</option>
            <option value="effective">Effective</option>
            <option value="partially_effective">Partially effective</option>
            <option value="not_effective">Not effective</option>
          </select>
        </div>
        <div>
          <label>Effectiveness Note</label>
          <input id="eff_note" placeholder="Short outcome note (e.g., no repeat cases in 30 days)"/>
        </div>
      </div>
    </div>
    <div style="margin-top:10px">
      <label>Corrective Action Plan</label>
      <textarea id="qaE_plan" rows="3">${escapeHtml(a.actionPlan||'')}</textarea>
    </div>

    <div class="card" style="margin-top:12px; box-shadow:none; border:1px solid rgba(0,0,0,.08)">
      <h3 style="margin:0 0 8px">Follow-up Schedule</h3>
      <div class="muted mini">Set due dates for 7/30/90-day checks. Document results when completed.</div>
      <div id="fuWrap"></div>
      <div class="sep"></div>
      <div class="grid cols2" style="gap:10px">
        <div>
          <label>Effectiveness Status</label>
          <select id="eff_status">
            <option value="">(not assessed)</option>
            <option value="effective">Effective</option>
            <option value="partially_effective">Partially effective</option>
            <option value="not_effective">Not effective</option>
          </select>
        </div>
        <div>
          <label>Effectiveness Note</label>
          <input id="eff_note" placeholder="Short outcome note (e.g., no repeat cases in 30 days)"/>
        </div>
      </div>
    </div>
    <div style="margin-top:10px">
      <label>Notes</label>
      <textarea id="qaE_notes" rows="3">${escapeHtml(a.notes||'')}</textarea>
    </div>

    <div class="card" style="margin-top:12px; box-shadow:none; border:1px solid rgba(0,0,0,.08)">
      <h3 style="margin:0 0 8px">Follow-up Schedule</h3>
      <div class="muted mini">Set due dates for 7/30/90-day checks. Document results when completed.</div>
      <div id="fuWrap"></div>
      <div class="sep"></div>
      <div class="grid cols2" style="gap:10px">
        <div>
          <label>Effectiveness Status</label>
          <select id="eff_status">
            <option value="">(not assessed)</option>
            <option value="effective">Effective</option>
            <option value="partially_effective">Partially effective</option>
            <option value="not_effective">Not effective</option>
          </select>
        </div>
        <div>
          <label>Effectiveness Note</label>
          <input id="eff_note" placeholder="Short outcome note (e.g., no repeat cases in 30 days)"/>
        </div>
      </div>
    </div>
    <div class="sep"></div>
    <div class="row" style="justify-content:space-between; gap:8px; flex-wrap:wrap">
      <div class="muted mini">Created: ${escapeHtml(a.createdAt||'')} • Updated: ${escapeHtml(a.updatedAt||'')}</div>
      <div class="row" style="gap:8px; flex-wrap:wrap">
        <button class="btn" onclick="closeModal()">Close</button>
        <button class="btn primary" onclick="qapiSaveActionEdit('${escapeHtml(a.id)}')">Save</button>
      </div>
    </div>
  `);
  
  // Normalize date inputs (HTML date requires YYYY-MM-DD)
  setTimeout(()=>{
    const dueEl=document.getElementById('qaE_due'); if(dueEl) dueEl.value = toDateInputValue(a.dueDate||'');
    const fuEl=document.getElementById('qaE_follow'); if(fuEl) fuEl.value = toDateInputValue(a.followUpDate||'');
  },0);
// set selected topic if existing
  const sel=document.getElementById('qaE_topic');
  if(sel && a.educationTopic) sel.value=a.educationTopic;
}
function qapiEditRefreshTopics(){
  const cat=document.getElementById('qaE_cat')?.value||'infection_control';
  const sel=document.getElementById('qaE_topic');
  if(!sel) return;
  const topics=qapiSuggestEducation(cat);
  sel.innerHTML = topics.map(t=>`<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');
}
function qapiSaveActionEdit(id){
  const patch={
    title:(document.getElementById('qaE_title')?.value||'').trim(),
    status:document.getElementById('qaE_status')?.value||'open',
    category:document.getElementById('qaE_cat')?.value||'infection_control',
    priority:document.getElementById('qaE_pri')?.value||'medium',
    dueDate:document.getElementById('qaE_due')?.value||'',
    ownerRole:(document.getElementById('qaE_owner')?.value||'').trim(),
    educationTopic:document.getElementById('qaE_topic')?.value||'',
    followUpDate:document.getElementById('qaE_follow')?.value||'',
    problem:(document.getElementById('qaE_problem')?.value||'').trim(),
    actionPlan:(document.getElementById('qaE_plan')?.value||'').trim(),
    notes:(document.getElementById('qaE_notes')?.value||'').trim(),
  };
  if(!patch.title){ toastSafe('Title is required.'); return; }
  qapiUpdateAction(id, patch);
  closeModal();
  toastSafe('Saved.');
  qapiRenderActions();
}

function qapiExportActionsCSV(){
  const s=Store.load(); ensureQapiActions(s);
  const rows=[['id','status','category','priority','title','dueDate','ownerRole','educationTopic','createdAt','updatedAt']];
  for(const a of s.qapiActions){
    rows.push([a.id,a.status,a.category,a.priority,a.title,a.dueDate,a.ownerRole,a.educationTopic||'',a.createdAt||'',a.updatedAt||'']);
  }
  const csv=rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`QAPI_Actions_${dayISO(new Date())}.csv`;
  document.body.appendChild(a); a.click(); a.remove();
  auditTrail('qapi_actions_csv_exported', {count:s.qapiActions.length});
  toastSafe('CSV exported.');
}
function qapiPrintActions(){
  const s=Store.load(); ensureQapiActions(s);
  const facility=s.config?.facilityName||'Facility';
  const open=s.qapiActions.filter(a=>a.status!=='complete');
  const closed=s.qapiActions.filter(a=>a.status==='complete');
  const row=(a)=>`<tr><td>${escapeHtml(a.status)}</td><td>${escapeHtml(a.priority)}</td><td>${escapeHtml(a.category)}</td><td>${escapeHtml(a.title)}</td><td>${escapeHtml(a.dueDate||'')}</td><td>${escapeHtml(a.ownerRole||'')}</td></tr>`;
  const body=`
    <h1>${escapeHtml(facility)} — QAPI Action Center</h1>
    <div class="muted">Generated: ${escapeHtml(new Date().toISOString())}</div>
    <h2>Open / In Progress</h2>
    <table><thead><tr><th>Status</th><th>Priority</th><th>Category</th><th>Title</th><th>Due</th><th>Owner</th></tr></thead><tbody>${open.map(row).join('')||'<tr><td colspan="6" class="muted">None</td></tr>'}</tbody></table>
    <h2>Completed</h2>
    <table><thead><tr><th>Status</th><th>Priority</th><th>Category</th><th>Title</th><th>Due</th><th>Owner</th></tr></thead><tbody>${closed.slice(0,30).map(row).join('')||'<tr><td colspan="6" class="muted">None</td></tr>'}</tbody></table>
  `;
  openPrintWindow(packetHtmlShell(`${facility} — QAPI Actions`, body));
  auditTrail('qapi_actions_printed', {open:open.length, closed:closed.length});
}

// Boot hook: render when actions tab opens
(function(){
  const _setTab = window.setTab;
  window.setTab = function(name){
    _setTab(name);
    if(name==='actions'){
      qapiRenderActions();
    }
    if(name==='dashboard'){
      qapiRenderActions();
    }
  };
  // initial paint
  try{ qapiRenderActions(); }catch(e){}
})();
// =================== End Phase 5 Step 1 ==============================================


// --- Global Export Patch (bind onclick handlers) ---
(function(){
  const bind = (name, ref)=>{ try{ if(typeof ref==='function' && typeof window[name]==='undefined') window[name]=ref; }catch(e){} };
  try{ bind('abtApplyParsed', abtApplyParsed); }catch(e){}
  try{ bind('abtAutoLinkFromCensus', abtAutoLinkFromCensus); }catch(e){}
  try{ bind('abtBulkApplyLL', abtBulkApplyLL); }catch(e){}
  try{ bind('abtCreateIpCaseFromCourse', abtCreateIpCaseFromCourse); }catch(e){}
  try{ bind('abtDeleteCourse', abtDeleteCourse); }catch(e){}
  try{ bind('abtDoParse', abtDoParse); }catch(e){}
  try{ bind('abtSaveCourse', abtSaveCourse); }catch(e){}
  try{ bind('abtSelectAllFiltered', abtSelectAllFiltered); }catch(e){}
  try{ bind('abtSelectNone', abtSelectNone); }catch(e){}
  try{ bind('addIpDirectoryEntry', addIpDirectoryEntry); }catch(e){}
  try{ bind('addResidentNote', addResidentNote); }catch(e){}
  try{ bind('cfgRemoveUnit', cfgRemoveUnit); }catch(e){}
  try{ bind('clearIpAlertFilter', clearIpAlertFilter); }catch(e){}
  try{ bind('closeModal', closeModal); }catch(e){}
  try{ bind('deleteAction', deleteAction); }catch(e){}
  try{ bind('deleteAudit', deleteAudit); }catch(e){}
  try{ bind('deleteCleaningEvent', deleteCleaningEvent); }catch(e){}
  try{ bind('deleteComm', deleteComm); }catch(e){}
  try{ bind('deleteContactRecord', deleteContactRecord); }catch(e){}
  try{ bind('deleteDecision', deleteDecision); }catch(e){}
  try{ bind('deleteEquipment', deleteEquipment); }catch(e){}
  try{ bind('deleteExposureEvent', deleteExposureEvent); }catch(e){}
  try{ bind('deleteIpCase', deleteIpCase); }catch(e){}
  try{ bind('deleteIpTest', deleteIpTest); }catch(e){}
  try{ bind('deleteOutbreakCase', deleteOutbreakCase); }catch(e){}
  try{ bind('deleteStaffIll', deleteStaffIll); }catch(e){}
  try{ bind('deleteStopRule', deleteStopRule); }catch(e){}
  try{ bind('deleteVaxEvent', deleteVaxEvent); }catch(e){}
  try{ bind('doRestore', doRestore); }catch(e){}
  try{ bind('exportDrilldownCSV', exportDrilldownCSV); }catch(e){}
  try{ bind('exportQapiEffectivenessCsv', exportQapiEffectivenessCsv); }catch(e){}
  try{ bind('exportUnitPrecautionListingCSVFromSetup', exportUnitPrecautionListingCSVFromSetup); }catch(e){}
  try{ bind('generateContactsForCase', generateContactsForCase); }catch(e){}
  try{ bind('generateContactsFromEvent', generateContactsFromEvent); }catch(e){}
  try{ bind('importAbtCourseToIp', importAbtCourseToIp); }catch(e){}
  try{ bind('jumpToResidentByMRN', jumpToResidentByMRN); }catch(e){}
  try{ bind('markContactCleared', markContactCleared); }catch(e){}
  try{ bind('openAbtEditModal', openAbtEditModal); }catch(e){}
  try{ bind('openAbtSuggestionModal', openAbtSuggestionModal); }catch(e){}
  try{ bind('openActionModal', openActionModal); }catch(e){}
  try{ bind('openAddOutbreakCaseModal', openAddOutbreakCaseModal); }catch(e){}
  try{ bind('openAuditModal', openAuditModal); }catch(e){}
  try{ bind('openCleaningEventModal', openCleaningEventModal); }catch(e){}
  try{ bind('openCommModal', openCommModal); }catch(e){}
  try{ bind('openContactTracingFromCase', openContactTracingFromCase); }catch(e){}
  try{ bind('openDecisionModal', openDecisionModal); }catch(e){}
  try{ bind('openEditOutbreakCaseModal', openEditOutbreakCaseModal); }catch(e){}
  try{ bind('openEquipmentModal', openEquipmentModal); }catch(e){}
  try{ bind('openExposureEventModal', openExposureEventModal); }catch(e){}
  try{ bind('openFloorRoomModal', openFloorRoomModal); }catch(e){}
  try{ bind('openIpCaseModal', openIpCaseModal); }catch(e){}
  try{ bind('openIpContactModalForCase', openIpContactModalForCase); }catch(e){}
  try{ bind('openIpContactRecordModal', openIpContactRecordModal); }catch(e){}
  try{ bind('openIpContactWorkspace', openIpContactWorkspace); }catch(e){}
  try{ bind('openIpDirectoryModal', openIpDirectoryModal); }catch(e){}
  try{ bind('openIpGIAcuteTemplatePrint', openIpGIAcuteTemplatePrint); }catch(e){}
  try{ bind('openIpILIPrintTemplate', openIpILIPrintTemplate); }catch(e){}
  try{ bind('openIpPrintLineList', openIpPrintLineList); }catch(e){}
  try{ bind('openIpTestModal', openIpTestModal); }catch(e){}
  try{ bind('openOutbreakCase', openOutbreakCase); }catch(e){}
  try{ bind('openReportWalkthroughModal', openReportWalkthroughModal); }catch(e){}
  try{ bind('openResidentDrilldown', openResidentDrilldown); }catch(e){}
  try{ bind('openResidentEditModal', openResidentEditModal); }catch(e){}
  try{ bind('openResidentProfileModal', openResidentProfileModal); }catch(e){}
  try{ bind('openStaffIllModal', openStaffIllModal); }catch(e){}
  try{ bind('openStopRuleModal', openStopRuleModal); }catch(e){}
  try{ bind('openVaxEditModal', openVaxEditModal); }catch(e){}
  try{ bind('packetBackupExport', packetBackupExport); }catch(e){}
  try{ bind('packetBackupImport', packetBackupImport); }catch(e){}
  try{ bind('packetBackupImportGo', packetBackupImportGo); }catch(e){}
  try{ bind('packetChecklist', packetChecklist); }catch(e){}
  try{ bind('packetDeleteRun', packetDeleteRun); }catch(e){}
  try{ bind('packetExport', packetExport); }catch(e){}
  try{ bind('packetLoadRun', packetLoadRun); }catch(e){}
  try{ bind('packetSaveRun', packetSaveRun); }catch(e){}
  try{ bind('packetShowAuditLog', packetShowAuditLog); }catch(e){}
  try{ bind('packetShowSavedRuns', packetShowSavedRuns); }catch(e){}
  try{ bind('printActionsFollowUpReport', printActionsFollowUpReport); }catch(e){}
  try{ bind('printCaseAppendix', printCaseAppendix); }catch(e){}
  try{ bind('printDrilldown', printDrilldown); }catch(e){}
  try{ bind('printOutbreakLineListing', printOutbreakLineListing); }catch(e){}
  try{ bind('printOutbreakPacketPage', printOutbreakPacketPage); }catch(e){}
  try{ bind('printSurveyorPacket', printSurveyorPacket); }catch(e){}
  try{ bind('printUnitPrecautionListingFromSetup', printUnitPrecautionListingFromSetup); }catch(e){}
  try{ bind('printUnitPrecautionSignageFromSetup', printUnitPrecautionSignageFromSetup); }catch(e){}
  try{ bind('profileQuickAdd', profileQuickAdd); }catch(e){}
  try{ bind('qapiAddAllAuto', qapiAddAllAuto); }catch(e){}
  try{ bind('qapiAddAutoFromModal', qapiAddAutoFromModal); }catch(e){}
  try{ bind('qapiCreateFromModal', qapiCreateFromModal); }catch(e){}
  try{ bind('qapiDeleteAction', qapiDeleteAction); }catch(e){}
  try{ bind('qapiExportActionsCSV', qapiExportActionsCSV); }catch(e){}
  try{ bind('qapiMarkComplete', qapiMarkComplete); }catch(e){}
  try{ bind('qapiMarkInProgress', qapiMarkInProgress); }catch(e){}
  try{ bind('qapiNewActionModal', qapiNewActionModal); }catch(e){}
  try{ bind('qapiOpenAction', qapiOpenAction); }catch(e){}
  try{ bind('qapiPrintActions', qapiPrintActions); }catch(e){}
  try{ bind('qapiRunAutoFlags', qapiRunAutoFlags); }catch(e){}
  try{ bind('qapiSaveActionEdit', qapiSaveActionEdit); }catch(e){}
  try{ bind('qapiSnapshot', qapiSnapshot); }catch(e){}
  try{ bind('qapiSnapshotCSV', qapiSnapshotCSV); }catch(e){}
  try{ bind('qapiSnapshotPrint', qapiSnapshotPrint); }catch(e){}
  try{ bind('removeIpDirectoryEntry', removeIpDirectoryEntry); }catch(e){}
  try{ bind('renderQapiEffectivenessReport', renderQapiEffectivenessReport); }catch(e){}
  try{ bind('runLegacyImport', runLegacyImport); }catch(e){}
  try{ bind('saveAction', saveAction); }catch(e){}
  try{ bind('saveAddVax', saveAddVax); }catch(e){}
  try{ bind('saveAudit', saveAudit); }catch(e){}
  try{ bind('saveBackupReminderSettings', saveBackupReminderSettings); }catch(e){}
  try{ bind('saveCleaningEvent', saveCleaningEvent); }catch(e){}
  try{ bind('saveComm', saveComm); }catch(e){}
  try{ bind('saveContactPlan', saveContactPlan); }catch(e){}
  try{ bind('saveContactRecord', saveContactRecord); }catch(e){}
  try{ bind('saveDecision', saveDecision); }catch(e){}
  try{ bind('saveEditedOutbreakCase', saveEditedOutbreakCase); }catch(e){}
  try{ bind('saveEquipment', saveEquipment); }catch(e){}
  try{ bind('saveExposureEvent', saveExposureEvent); }catch(e){}
  try{ bind('saveFloorMapConfig', saveFloorMapConfig); }catch(e){}
  try{ bind('saveIpCase', saveIpCase); }catch(e){}
  try{ bind('saveIpTest', saveIpTest); }catch(e){}
  try{ bind('saveOutbreakCaseFromModal', saveOutbreakCaseFromModal); }catch(e){}
  try{ bind('savePpe', savePpe); }catch(e){}
  try{ bind('savePrecautionFromModal', savePrecautionFromModal); }catch(e){}
  try{ bind('saveResidentEdits', saveResidentEdits); }catch(e){}
  try{ bind('saveResidentProfileEdits', saveResidentProfileEdits); }catch(e){}
  try{ bind('saveStaffIll', saveStaffIll); }catch(e){}
  try{ bind('saveStopRule', saveStopRule); }catch(e){}
  try{ bind('saveVaxEdit', saveVaxEdit); }catch(e){}
  try{ bind('setIpView', setIpView); }catch(e){}
  try{ bind('setTab', setTab); }catch(e){}
})();
// --- End Global Export Patch ---
</script>




<script>
// ================= Phase 6 Step 1 Patch: Template-aligned IP Case Profile + Precaution Sync =================
(function(){
  function norm(s){ return String(s||"").trim(); }
  function upper(s){ return norm(s).toUpperCase(); }
  function ppeFrom(precType, isoType){
    const p=upper(precType);
    const i=upper(isoType);
    if(p==="EBP" || p==="ENHANCED BARRIER" || p==="ENHANCED BARRIER PRECAUTIONS"){ return "Gown + Gloves for high-contact care (EBP); Hand hygiene"; }
    if(p==="CONTACT"){ return "Gown + Gloves; Hand hygiene"; }
    if(p==="DROPLET"){ return "Surgical mask; Eye protection if splash risk; Hand hygiene"; }
    if(p==="AIRBORNE"){ return "N95/respirator (fit-tested); Negative pressure if available; Hand hygiene"; }
    if(p==="ENTERIC"){ return "Gown + Gloves; Soap & water after care"; }
    if(p==="ISOLATION"){
      if(i.includes("CONTACT")) return "Gown + Gloves; Hand hygiene";
      if(i.includes("DROPLET")) return "Surgical mask; Eye protection if splash risk; Hand hygiene";
      if(i.includes("AIRBORNE")) return "N95/respirator (fit-tested); Negative pressure if available; Hand hygiene";
      return "PPE per policy; Hand hygiene";
    }
    return "PPE per policy; Hand hygiene";
  }

  function resolveResidentIdFromCase(s, c){
    try{
      const rid = norm(c && (c.residentId||c.resId||c.residentID||""));
      if(rid && s.residentsById && s.residentsById[rid]) return rid;
      const mrn = norm(c && c.mrn);
      if(mrn){
        const want = mrn.toUpperCase();
        for(const [id,r] of Object.entries(s.residentsById||{})){
          if(norm(r.mrn).toUpperCase()===want) return id;
        }
      }
    }catch(e){}
    return "";
  }

  function syncPrecautionFromCase(st, c){
    try{
      ensureIpData(st);
      const rid = resolveResidentIdFromCase(st, c) || "";
      const r = rid ? st.residentsById[rid] : null;
      const precType = norm(c.precautionType||c.precaution||"");
      const isoType = norm(c.isolationType||"");
      const source = norm(c.sourceCondition||c.infectedSource||c.infectionSource||c.source||"");
      const onset = norm(c.onsetDate||"");
      const reso = norm(c.resolutionDate||c.endDate||"");
      const statusRaw = norm(c.status||"active").toLowerCase();
      const active = !(statusRaw==="resolved" || statusRaw==="discontinued" || statusRaw==="inactive" || statusRaw==="ruledout");

      // If no precaution fields set, don't force-create a precaution row.
      if(!precType && !isoType && !source) return;

      const precArr = st.modules.ip.precautions || (st.modules.ip.precautions = []);
      const key = String(c.id||"");
      const pid = key ? ("CASE-"+key) : ("CASE-"+Date.now());
      let p = precArr.find(x=>String(x.id||"")===pid) || precArr.find(x=>String(x.caseId||"")===String(c.id||""));
      if(!p){
        p = { id: pid, caseId: String(c.id||""), createdAt: nowISO() };
        precArr.push(p);
      }

      const unit = norm(c.unit||r?.unit||"");
      const room = norm(c.room||r?.room||"").toUpperCase();

      // Map to the precaution list schema
      p.residentId = rid || p.residentId || "";
      p.residentName = norm(c.residentName||c.name||r?.name||"") || p.residentName || "";
      p.mrn = norm(c.mrn||r?.mrn||"") || p.mrn || "";
      p.unit = unit;
      p.room = room;

      // Type label (what users expect to see)
      let label = precType;
      const up = upper(precType);
      if(up==="EBP") label = "Enhanced Barrier Precautions (EBP)";
      if(up==="ISOLATION") label = isoType ? ("Isolation - "+isoType) : "Isolation - Other";
      p.type = label || p.type || "";
      p.precautionType = precType || p.precautionType || "";
      p.isolationType = isoType || p.isolationType || "";

      p.infectedSource = source || p.infectedSource || "";
      p.sourceCondition = source || p.sourceCondition || "";
      p.pathogenResistance = norm(c.pathogenResistance||c.pathogen||"") || p.pathogenResistance || "";
      p.nhsnPathogenCode = norm(c.nhsnPathogenCode||"") || p.nhsnPathogenCode || "";

      p.startDate = onset || p.startDate || "";
      p.endDate = active ? "" : (reso || p.endDate || dayISO(new Date()));
      p.status = active ? "active" : "resolved";
      p.requiredPPE = norm(c.requiredPPE||p.requiredPPE||"") || ppeFrom(precType, isoType);
      p.updatedAt = nowISO();
    }catch(e){}
  }

  // Override Edit Outbreak Case modal to match the template profile fields.
  window.openEditOutbreakCaseModal = function(caseId){
    const s = Store.load(); ensureOutbreakData(s);
    const c = (s.modules.ip.lineListCases||[]).find(x=>x.id===caseId);
    if(!c){ toastSafe("Case not found."); return; }

    // Derive resident linkage fields (best effort)
    const rid = resolveResidentIdFromCase(s, c);
    const r = rid ? s.residentsById[rid] : null;

    const pType = norm(c.precautionType||"");
    const iType = norm(c.isolationType||"");
    const reqPpe = norm(c.requiredPPE||"") || ppeFrom(pType, iType);

    openModal("Edit Case", `
      <div class="grid cols4">
        <div><label>Resident Name</label><input id="cp_name" value="${escapeHtml(c.residentName||c.name||r?.name||"")}"/></div>
        <div><label>MRN</label><input id="cp_mrn" value="${escapeHtml(c.mrn||r?.mrn||"")}"/></div>
        <div><label>DOB</label><input id="cp_dob" value="${escapeHtml(c.dob||r?.dob||"")}" placeholder="MM/DD/YYYY"/></div>
        <div><label>Room</label><input id="cp_room" value="${escapeHtml(c.room||r?.room||"")}"/></div>
      </div>

      <div class="grid cols4" style="margin-top:10px">
        <div>
          <label>Unit</label>
          <select id="cp_unit">
            <option value="">—</option>
            ${(s.config.units||[]).map(u=>`<option value="${escapeHtml(u.unitKey)}" ${(String(c.unit||r?.unit||"")===u.unitKey)?"selected":""}>${escapeHtml(u.unitName)}</option>`).join("")}
          </select>
          <div class="muted mini">Auto-detect from room starts with 2/3/4 if blank.</div>
        </div>
        <div>
          <label>Census Status</label>
          <select id="cp_census">
            <option value="Active" ${(norm(c.censusStatus||"Active")==="Active")?"selected":""}>Active</option>
            <option value="Discharged" ${(norm(c.censusStatus)==="Discharged")?"selected":""}>Discharged</option>
          </select>
        </div>
        <div>
          <label>Precaution Type</label>
          <select id="cp_prec">
            <option value="">—</option>
            ${["EBP","Isolation","Contact","Droplet","Airborne","Enteric","Other"].map(v=>`<option value="${v}" ${(upper(pType)===upper(v))?"selected":""}>${v}</option>`).join("")}
          </select>
        </div>
        <div>
          <label>Isolation Type (if Isolation)</label>
          <select id="cp_iso">
            <option value="">—</option>
            ${["Contact","Droplet","Airborne","C. diff / Enteric","Other"].map(v=>`<option value="${v}" ${(upper(iType)===upper(v))?"selected":""}>${v}</option>`).join("")}
          </select>
        </div>
      </div>

      <div class="grid cols4" style="margin-top:10px">
        <div><label>Onset Date</label><input id="cp_onset" type="date" value="${escapeHtml(c.onsetDate||"")}"/></div>
        <div><label>Resolution Date</label><input id="cp_reso" type="date" value="${escapeHtml(c.resolutionDate||"")}"/></div>
        <div>
          <label>Status</label>
          <select id="cp_status">
            ${["ACTIVE","RESOLVED","SUSPECTED","CONFIRMED","RULEDOUT"].map(v=>`<option value="${v}" ${(upper(c.status||"ACTIVE")===v)?"selected":""}>${v}</option>`).join("")}
          </select>
        </div>
        <div>
          <label>Source Condition / Reason</label>
          <input id="cp_source" value="${escapeHtml(c.sourceCondition||c.infectedSource||c.syndrome||"")}" placeholder="e.g., PICC line, UTI, C. diff, RSV..."/>
        </div>
      </div>

      <div class="grid cols3" style="margin-top:10px">
        <div><label>Pathogen / Resistance (free text)</label><input id="cp_path" value="${escapeHtml(c.pathogenResistance||"")}"/></div>
        <div><label>NHSN Pathogen Code</label><input id="cp_nhsn" value="${escapeHtml(c.nhsnPathogenCode||"")}"/></div>
        <div>
          <label>Vaccine Status</label>
          <select id="cp_vax">
            <option value="">—</option>
            ${["Up to date","Not up to date","Unknown"].map(v=>`<option value="${v}" ${(norm(c.vaccineStatus||"")===v)?"selected":""}>${v}</option>`).join("")}
          </select>
        </div>
      </div>

      <div class="card" style="margin-top:12px; box-shadow:none; border:1px solid rgba(0,0,0,.08)">
        <h3 style="margin:0 0 8px">Auto Required PPE</h3>
        <div class="grid cols2">
          <div>
            <label>Required PPE</label>
            <input id="cp_ppe" value="${escapeHtml(reqPpe)}"/>
          </div>
          <div style="display:flex; align-items:flex-end; gap:8px">
            <button class="btn" onclick="(function(){              const pt=document.getElementById('cp_prec')?.value||'';              const it=document.getElementById('cp_iso')?.value||'';              const el=document.getElementById('cp_ppe');              if(el) el.value = ppeFrom(pt,it);            })()">Apply PPE Rules</button>
          </div>
        </div>
      </div>

      <div style="margin-top:10px">
        <label>Notes</label>
        <textarea id="cp_notes" rows="3">${escapeHtml(c.notes||"")}</textarea>
      </div>

      <div class="sep"></div>
      <div class="row between" style="gap:8px; flex-wrap:wrap">
        <button class="btn danger" onclick="deleteOutbreakCase('${escapeHtml(caseId)}')">Delete Case</button>
        <div class="row" style="gap:8px">
          <button class="btn" onclick="closeModal()">Cancel</button>
          <button class="btn primary" onclick="saveEditedOutbreakCase('${escapeHtml(caseId)}')">Save Changes</button>
        </div>
      </div>
    `);
  };

  window.saveEditedOutbreakCase = function(caseId){
    const name = norm(document.getElementById('cp_name')?.value);
    const mrn = norm(document.getElementById('cp_mrn')?.value);
    const dob = norm(document.getElementById('cp_dob')?.value);
    const room = norm(document.getElementById('cp_room')?.value);
    const unit = norm(document.getElementById('cp_unit')?.value);
    const censusStatus = norm(document.getElementById('cp_census')?.value) || 'Active';
    const precautionType = norm(document.getElementById('cp_prec')?.value);
    const isolationType = norm(document.getElementById('cp_iso')?.value);
    const onsetDate = norm(document.getElementById('cp_onset')?.value);
    const resolutionDate = norm(document.getElementById('cp_reso')?.value);
    const status = norm(document.getElementById('cp_status')?.value) || 'ACTIVE';
    const sourceCondition = norm(document.getElementById('cp_source')?.value);
    const pathogenResistance = norm(document.getElementById('cp_path')?.value);
    const nhsnPathogenCode = norm(document.getElementById('cp_nhsn')?.value);
    const vaccineStatus = norm(document.getElementById('cp_vax')?.value);
    const requiredPPE = norm(document.getElementById('cp_ppe')?.value);
    const notes = norm(document.getElementById('cp_notes')?.value);

    Store.patch(st=>{
      ensureOutbreakData(st);
      const idx = (st.modules.ip.lineListCases||[]).findIndex(x=>x.id===caseId);
      if(idx<0) return;
      const c = st.modules.ip.lineListCases[idx];

      c.residentName = name || c.residentName;
      c.name = c.residentName;
      c.mrn = mrn || c.mrn || '';
      c.dob = dob || c.dob || '';
      c.room = room || c.room || '';
      c.unit = unit || c.unit || '';
      c.censusStatus = censusStatus;

      c.onsetDate = onsetDate;
      c.resolutionDate = resolutionDate;
      c.status = status;

      c.precautionType = precautionType;
      c.isolationType = isolationType;
      c.sourceCondition = sourceCondition || c.sourceCondition || '';
      c.infectedSource = c.sourceCondition;
      c.pathogenResistance = pathogenResistance;
      c.nhsnPathogenCode = nhsnPathogenCode;
      c.vaccineStatus = vaccineStatus;
      c.requiredPPE = requiredPPE || ppeFrom(precautionType, isolationType);

      c.notes = notes;
      c.updatedAt = new Date().toISOString();

      // Keep Precaution List in sync (single-source-of-truth linkage)
      try{ syncPrecautionFromCase(st, c); }catch(e){}
    });

    closeModal();
    toastSafe('Case updated.');
    try{ setIpView('outbreak'); }catch(e){}
  };
})();
</script>
</body>
</html>